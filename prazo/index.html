<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cálculo de Prazos Processuais</title>

    <!-- Fontes e Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">

    <!-- Estilos de Bibliotecas (Bootstrap, Semantic UI, IntroJS, Table) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/introjs.css">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.20.2/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui-calendar/0.0.8/calendar.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">

    <!-- Estilos Personalizados -->
    <link rel="stylesheet" href="styles.css">
</head>

<body class="hm-gradient">

    <!-- Notificação Toast -->
    <div style="z-index: 1050;" class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto text-primary"><i class="fas fa-bell"></i> Notificação</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Imagem copiada para a área de transferência. Use CTRL+V para colar.
            </div>
        </div>
    </div>

    <div class="container">

        <!-- Menu de Navegação -->
        <div class="topnav col-md-8 mx-auto" id="myTopnav">
            <a href="#" class="active">Prazo <i class="fa fa-home"></i></a>
            <a href="https://eduardocarnello.github.io/calendario">Calendário e Indisponibilidades <i
                    class="fa fa-book"></i></a>
            <a href="javascript:void(0);" class="icon" onclick="myFunction()">
                <i class="fa fa-bars"></i>
            </a>
        </div>

        <div class="col-md-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-body">

                    <!-- Cabeçalho do Card -->
                    <h2 class="heading display-5 pb-3 text-center default-text py-3 header">
                        Cálculo de Prazo
                        <span><i class="fa-solid fa-circle-question fa-xs tutorial-icon" id="tutorial-icon"
                                style="cursor: pointer;"></i></span>
                    </h2>

                    <!-- Formulário -->
                    <form id="deadlineCalc">

                        <!-- Linha 1: Configurações (Cidade, Formato, Tipo) na MESMA LINHA -->
                        <div class="row g-2 mb-3">
                            <!-- Comarca -->
                            <div class="col-md-4">
                                <div class="input-group" id="divCity">
                                    <span class="input-group-text"><i
                                            class="fa fa-solid fa-city prefix grey-text"></i></span>
                                    <div class="form-floating flex-grow-1">
                                        <select class="selectpicker form-control" id="floatingSelect"
                                            data-show-subtext="false" data-live-search="true" data-width="auto">
                                            <option data-subtext="SP">Marília</option>
                                        </select>
                                        <label for="floatingSelect">Comarca <i
                                                class="fas fa-info-circle fa-sm tooltip-helper" data-bs-toggle="tooltip"
                                                title="Selecione a comarca para considerar feriados locais."></i></label>
                                    </div>
                                </div>
                            </div>

                            <!-- Formato (Dias Úteis/Corridos) -->
                            <div class="col-md-4">
                                <div class="input-group" id="divCalcType">
                                    <span class="input-group-text"><i
                                            class="fa fa-solid fa-calculator prefix grey-text"></i></span>
                                    <div class="form-floating flex-grow-1">
                                        <select id='calcType' class="form-select">
                                            <option selected value="workingDays">Dias úteis</option>
                                            <option value="calendarDays">Dias corridos</option>
                                            <option value="months">Meses</option>
                                        </select>
                                        <label for="calcType">Formato:</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Tipo de Contagem -->
                            <div class="col-md-4">
                                <div class="form-floating form3">
                                    <select id='countType' class="selectpicker form-control">
                                        <option id="selecteditem" value=""
                                            style='display: none !important; visibility: hidden;'></option>
                                        <option value="0" title="do ato" selected>do ato</option>
                                        <option value="0" title="da juntada">da juntada</option>
                                        <option title="da disp. DJE" value="1">da disponibilização no DJE</option>
                                        <option value="2" title="da pub. DJE">da publicação no DJE</option>
                                        <option value="3" title="da Citação no Portal">da Confirmação da Citação no
                                            Portal</option>
                                    </select>
                                    <!-- Label adicionado via JS ou implícito pelo plugin selectpicker, ajuste manual se necessário -->
                                </div>
                            </div>
                        </div>

                        <!-- Linha 2: Datas e Dias -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <div class="input-group has-validation" id="divInitialDate">
                                    <span class="input-group-text">
                                        <div class="ui calendar" id="button_calendar">
                                            <div class="ui button p-0 border-0 bg-transparent">
                                                <i class="fa fa-solid fa-calendar prefix grey-text"></i>
                                            </div>
                                        </div>
                                    </span>
                                    <div class="form-floating flex-grow-1">
                                        <input type="tel" class="form-control selectonfocus" id="initialDate"
                                            autocomplete="off" onchange="initialDateFunc()" placeholder="__/__/____"
                                            required>
                                        <label id="countFormatLabel" for="initialDate">Data Inicial <i
                                                class="fas fa-info-circle fa-sm tooltip-helper" data-bs-toggle="tooltip"
                                                title="Data da juntada ou do ato."></i></label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="input-group" id="divDays">
                                    <button type="button" class="btn btn-outline-secondary btn-number" id="minus-btn"
                                        data-type="minus" data-field="quant[2]" disabled>
                                        <i class="fa-solid fa-minus"></i>
                                    </button>
                                    <div class="form-floating flex-grow-1">
                                        <input type="tel" class="form-control text-center" id="days" name="quant[1]"
                                            autocomplete="off" placeholder="Dias" min="1" max="999" required>
                                        <label for="days">Dias:</label>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-number plus"
                                        id="plus-btn" data-type="plus" data-field="quant[2]">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="row g-2">
                            <div class="col-8 col-md-10">
                                <input type="submit" id="calcBtn" value="Calcular" class="btn btn-calc btn-dark w-100">
                            </div>
                            <div class="col-4 col-md-2">
                                <input class="btn btn-reset btn-primary w-100" type="button" value="Limpar" id="reset1">
                            </div>
                        </div>
                    </form>

                    <!-- Área de Resultados -->
                    <div id="results" class="mt-4" style="display: none;">
                        <div class="card border-0">
                            <div class="card-body text-center">

                                <div id="printResults"></div>

                                <!-- Botões de Visualização -->
                                <div class="buttons text-center mt-3">
                                    <button id="reportBtn" class="btn btn-outline-primary me-2" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseReport">
                                        Exibir Relatório
                                    </button>
                                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
                                        id="inlineCalendarBtn" data-bs-parent="#collapseOptions"
                                        data-bs-target="#collapseCalendar">
                                        Ver no Calendário
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Aba Relatório -->
                        <div class="collapse mt-3" id="collapseReport" data-bs-parent="#collapseOptions">
                            <div class="card card-body">
                                <div id="listReport" class="table-responsive mb-3"></div>
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-sm btn-dark" onclick="printDivs()">Imprimir</button>
                                    <button class="btn btn-sm btn-dark" onclick="copyAll()">Copiar Tudo</button>
                                    <button class="btn btn-sm btn-dark" onclick="copyListReport()">Copiar
                                        Tabela</button>
                                </div>
                            </div>
                        </div>

                        <!-- Aba Calendário -->
                        <div class="collapse mt-3" id="collapseCalendar" data-bs-parent="#collapseOptions">
                            <div class="card card-body">
                                <div id="inlineCalendar" class="ui calendar mx-auto" readonly></div>

                                <!-- LEGENDA ATUALIZADA -->
                                <h5 class="mt-3">Legenda</h5>
                                <div class="row align-items-start w-100 small text-start">
                                    <div class="col-6 col-sm-4 mb-2">
                                        <i class="fa-solid fa-square fa-lg text-info me-1"></i> Início / Juntada
                                    </div>
                                    <div class="col-6 col-sm-4 mb-2">
                                        <i class="fa-solid fa-square fa-lg text-primary me-1"></i> Dia da Contagem
                                    </div>
                                    <div class="col-6 col-sm-4 mb-2">
                                        <i class="fa-solid fa-square fa-lg text-success me-1"></i> Prazo Final
                                    </div>
                                    <div class="col-6 col-sm-4 mb-2">
                                        <i class="fa-solid fa-square fa-lg text-warning me-1"></i> Fim de Semana
                                    </div>
                                    <div class="col-6 col-sm-4 mb-2">
                                        <i class="fa-solid fa-square fa-lg text-danger me-1"></i> Feriado
                                    </div>
                                    <div class="col-6 col-sm-4 mb-2">
                                        <i class="fa-solid fa-square fa-lg text-warning me-1"></i> Indisp./Prorrogação
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- Fim Results -->

                </div>
            </div>
        </div>
    </div>

    <!-- Bibliotecas JS (Ordem Otimizada) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.min.js"></script>

    <!-- Plugins JS -->
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/js/bootstrap-select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.2/imask.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-maskmoney/3.0.2/jquery.maskMoney.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-business-days/1.2.0/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/locale/pt-br.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/intro.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.2/dist/bootstrap-table.min.js"></script>
    <script
        src="https://unpkg.com/bootstrap-table@1.20.2/dist/extensions/mobile/bootstrap-table-mobile.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>

    <!-- Scripts da Aplicação (Ordem de Dependência) -->
    <script src="holidaysFunc.js"></script>

    <!-- Firebase Integration for Prazo -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIYB0Mpk0cXXEeui8ylsit2SZRSvtkazk",
            authDomain: "calendariojec.firebaseapp.com",
            projectId: "calendariojec",
            storageBucket: "calendariojec.firebasestorage.app",
            messagingSenderId: "389901694336",
            appId: "1:389901694336:web:4c784e106a6235b53dfd65"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Store initial state to avoid duplicates on re-render
        const initialAmendmentLength = amendment.length;
        const initialSistDownLength = sistDown.length;

        // Save original function
        window.originalHolidaysFunc = window.holidaysFunc;

        onSnapshot(collection(db, 'events'), (snapshot) => {
            const events = [];
            snapshot.forEach(doc => events.push(doc.data()));

            // Reset arrays to initial state (removing previous dynamic events)
            amendment.length = initialAmendmentLength;
            sistDown.length = initialSistDownLength;

            const suspensions = events.filter(e => ['suspensao', 'feriado', 'recesso', 'falta', 'substituicao', 'outro'].includes(e.type) && e.type !== 'moved_holiday');
            const indisponibilities = events.filter(e => ['indisponibilidade', 'severa'].includes(e.type));
            const movedHolidays = events.filter(e => e.type === 'moved_holiday');

            // Inject Suspensions
            suspensions.forEach(e => {
                amendment.push({ holidayDate: e.startDate, description: e.description });
                // Handle range if endDate exists
                if (e.endDate) {
                    // Simple range expansion logic if needed, or just rely on start/end logic in calc?
                    // calcDate.js usually expects individual dates in 'amendment' or 'holidays'.
                    // If 'amendment' supports ranges, good. If not, we might need to expand.
                    // Looking at holidaysFunc, it seems to list individual dates.
                    // I'll expand the range here to be safe.
                    let current = moment(e.startDate, 'DD/MM/YYYY');
                    const end = moment(e.endDate, 'DD/MM/YYYY');
                    while (current.isBefore(end)) {
                        current.add(1, 'days');
                        amendment.push({ holidayDate: current.format('DD/MM/YYYY'), description: e.description });
                    }
                }
            });

            // Inject Indisponibilities
            indisponibilities.forEach(e => {
                sistDown.push({ downDate: e.startDate, description: e.description });
                if (e.endDate) {
                    let current = moment(e.startDate, 'DD/MM/YYYY');
                    const end = moment(e.endDate, 'DD/MM/YYYY');
                    while (current.isBefore(end)) {
                        current.add(1, 'days');
                        sistDown.push({ downDate: current.format('DD/MM/YYYY'), description: e.description });
                    }
                }
            });

            // Inject Moved Holidays (New Dates)
            movedHolidays.forEach(m => {
                amendment.push({ holidayDate: m.newDate, description: `${m.holidayName} - ${m.provimento}` });
            });

            // Overwrite holidaysFunc to filter old dates
            window.holidaysFunc = function (startYear, endYear) {
                let data = window.originalHolidaysFunc(startYear, endYear);

                const filterFn = h => {
                    if (!h.holidayDate) return true;
                    const hYear = parseInt(h.holidayDate.split('/')[2]);
                    const isMoved = movedHolidays.some(m => m.holidayName === h.description && parseInt(m.year) === hYear);
                    return !isMoved;
                };

                if (data.nationalHolidays) data.nationalHolidays = data.nationalHolidays.filter(filterFn);
                if (data.stateHolidays) data.stateHolidays = data.stateHolidays.filter(filterFn);
                if (data.cityHolidays) data.cityHolidays = data.cityHolidays.filter(filterFn);

                return data;
            };

            console.log("Prazo: Events updated from Firebase.");
        });
    </script>

    <script src="initialDateFunc.js"></script>
    <script src="code.js"></script>
    <script src="calcDate.js"></script>

</body>

</html>