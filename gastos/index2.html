<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        input,
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Blur */
        .blur-sensitive {
            filter: blur(6px);
            user-select: none;
            transition: filter 0.2s ease;
        }

        .blur-sensitive:hover {
            filter: blur(0px);
        }

        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        #app-content {
            transition: transform 0.45s ease, filter 0.45s ease, opacity 0.45s ease;
        }

        #app-content.period-fade-active {
            opacity: 0.65;
            transform: translateY(8px) scale(0.997);
            filter: saturate(0.85);
            pointer-events: none;
        }

        .period-fade-group {
            transition: opacity 0.45s ease, transform 0.45s ease;
        }

        #app-content.period-fade-active .period-fade-group {
            opacity: 0.55;
            transform: translateY(5px);
        }

        #period-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 55;
            background: radial-gradient(circle at top, rgba(79, 70, 229, 0.12), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #period-transition-overlay::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(79, 70, 229, 0.08));
        }

        #period-transition-overlay.active {
            opacity: 1;
        }

        .period-loader {
            position: relative;
            z-index: 1;
            background: rgba(255, 255, 255, 0.88);
            border-radius: 1rem;
            padding: 1.2rem 1.8rem;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
            border: 1px solid rgba(148, 163, 184, 0.4);
            text-align: center;
            transform: translateY(12px);
            animation: loaderFloat 2s ease-in-out infinite alternate;
        }

        .period-loader h4 {
            font-size: 0.85rem;
            letter-spacing: 0.25em;
            color: #818cf8;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .period-loader p {
            font-size: 0.95rem;
            color: #1e1b4b;
            margin-top: 0.3rem;
        }

        .period-loading-dots {
            display: flex;
            justify-content: center;
            gap: 0.6rem;
        }

        .period-loading-dots span {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: #4f46e5;
            animation: dotPulse 0.9s ease-in-out infinite;
        }

        .period-loading-dots span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .period-loading-dots span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes loaderFloat {
            0% {
                transform: translateY(12px);
            }

            100% {
                transform: translateY(-6px);
            }
        }

        @keyframes dotPulse {

            0%,
            100% {
                transform: scale(0.9);
                opacity: 0.6;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.25s ease;
            pointer-events: none;
            opacity: 0;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.25s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        body.modal-active {
            overflow: hidden;
        }

        /* Color Picker */
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-dot.selected {
            border-color: #333;
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tooltip-group {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip-trigger {
            width: 20px;
            height: 20px;
            border-radius: 9999px;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #4f46e5;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        }

        .tooltip-trigger:hover,
        .tooltip-trigger:focus {
            background-color: #eef2ff;
            border-color: #c7d2fe;
            color: #312e81;
        }

        .tooltip-panel {
            position: absolute;
            top: 125%;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            background: #1f2937;
            color: #f9fafb;
            padding: 0.65rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            line-height: 1.1rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease, transform 0.15s ease;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.25);
            z-index: 20;
        }

        .tooltip-panel::after {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: transparent transparent #1f2937 transparent;
        }

        .tooltip-group:focus-within .tooltip-panel,
        .tooltip-group:hover .tooltip-panel {
            opacity: 1;
            transform: translate(-50%, 0);
            pointer-events: auto;
        }

        #sticky-period-bar {
            position: sticky;
            top: 0;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-12px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            height: 0;
            overflow: visible;
        }

        #sticky-period-bar.sticky-visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        #sticky-period-inner {
            width: 100%;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.14);
            padding: 0.75rem 0;
        }

        .sticky-inner-content {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 1rem;
        }

        .sticky-trigger-wrapper {
            position: relative;
            display: inline-block;
        }

        .sticky-trigger {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
        }

        .sticky-trigger i {
            font-size: 0.75rem;
            color: #4f46e5;
            transition: transform 0.2s ease;
        }

        .sticky-trigger.active i {
            transform: rotate(180deg);
        }

        .plan-banner {
            background: linear-gradient(115deg, rgba(15, 23, 42, 0.95), rgba(79, 70, 229, 0.92));
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.25rem;
            padding: 1.5rem;
            color: #f8fafc;
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            align-items: center;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.3);
        }

        .plan-banner h3 {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #c7d2fe;
        }

        .plan-banner p {
            color: rgba(226, 232, 240, 0.9);
        }

        .plan-banner ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .plan-banner ul li {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(129, 140, 248, 0.35);
            border-radius: 999px;
            padding: 0.35rem 0.85rem;
            font-size: 0.8rem;
        }

        .plan-banner button {
            background: #fef08a;
            color: #7c2d12;
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 999px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.25);
        }

        .premium-report-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .premium-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.9rem;
            border-radius: 999px;
            background: #eef2ff;
            color: #4338ca;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
        }

        .premium-people-list,
        .premium-suggestions,
        .premium-variation-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
        }

        .premium-suggestions,
        .premium-variation-list {
            flex-direction: column;
        }

        .premium-people-list li {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #0f172a;
        }

        .premium-suggestions li {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.85rem;
            padding: 0.85rem 1rem;
            font-size: 0.9rem;
            color: #0f172a;
            border-left: 4px solid #4f46e5;
        }

        .premium-variation-item {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.95rem;
            padding: 0.85rem 1rem;
            background: #ffffff;
        }

        .premium-variation-item strong {
            font-size: 0.95rem;
            color: #0f172a;
        }

        .variation-bar {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: #e2e8f0;
            overflow: hidden;
            margin-top: 0.4rem;
        }

        .variation-bar-fill {
            height: 100%;
            border-radius: 999px;
        }

        .variation-bar-fill.up {
            background: #f87171;
        }

        .variation-bar-fill.down {
            background: #34d399;
        }

        .premium-empty {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .plan-limit-message {
            background: rgba(248, 250, 252, 0.8);
            border: 1px dashed rgba(79, 70, 229, 0.4);
            color: #4338ca;
            font-size: 0.8rem;
            padding: 0.6rem 0.8rem;
            border-radius: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .plan-limit-message i {
            color: #7c3aed;
        }

        [data-premium-extra="true"] {
            display: none;
        }

        body.premium-extras-enabled [data-premium-extra="true"] {
            display: block;
        }

        .premium-extra-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.08);
        }

        .premium-extra-toggle h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }

        .premium-extra-toggle p {
            margin: 0.15rem 0 0;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .premium-extra-switch {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4338ca;
        }

        .premium-extra-switch input[type="checkbox"] {
            appearance: none;
            width: 46px;
            height: 24px;
            border-radius: 999px;
            background: #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .premium-extra-switch input[type="checkbox"]::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(15, 23, 42, 0.2);
            transition: transform 0.2s ease;
        }

        .premium-extra-switch input[type="checkbox"]:checked {
            background: linear-gradient(120deg, #4f46e5, #7c3aed);
        }

        .premium-extra-switch input[type="checkbox"]:checked::after {
            transform: translateX(22px);
        }

        .plan-locked-card {
            background: #ffffff;
            border: 1px dashed rgba(79, 70, 229, 0.35);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .plan-locked-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .plan-locked-card p {
            font-size: 0.95rem;
            color: #4b5563;
        }

        .plan-locked-card button {
            align-self: flex-start;
            padding: 0.6rem 1.3rem;
            border-radius: 999px;
            border: none;
            background: linear-gradient(120deg, #fef3c7, #fde68a);
            color: #92400e;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.2);
        }

        .plan-restriction-toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #0f172a;
            color: #f8fafc;
            padding: 1rem 1.1rem;
            border-radius: 0.9rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 20px 40px rgba(2, 6, 23, 0.5);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            z-index: 60;
        }

        .plan-restriction-toast button {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .plan-restriction-toast.hidden {
            display: none;
        }

        .plan-banner-cta-wrapper {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .plan-banner .plan-status-pill {
            background: rgba(248, 250, 252, 0.18);
            color: #fff;
            padding: 0.3rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            letter-spacing: 0.2em;
        }

        .plan-banner .plan-upgrade-copy {
            font-size: 0.85rem;
            color: rgba(248, 250, 252, 0.85);
        }

        body.theme-dark .plan-banner {
            background: linear-gradient(115deg, rgba(2, 6, 23, 0.95), rgba(30, 27, 75, 0.92));
            border-color: rgba(129, 140, 248, 0.2);
        }

        body.theme-dark .plan-limit-message {
            background: rgba(30, 27, 75, 0.5);
            color: #c4b5fd;
            border-color: rgba(99, 102, 241, 0.35);
        }

        body.theme-dark .plan-restriction-toast {
            background: rgba(15, 23, 42, 0.95);
        }

        body.theme-dark .plan-locked-card {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(99, 102, 241, 0.4);
            color: #e0e7ff;
        }

        body.theme-dark .plan-locked-card h3 {
            color: #e0e7ff;
        }

        body.theme-dark .plan-locked-card p {
            color: #cbd5f5;
        }

        body.theme-dark .plan-locked-card button {
            background: linear-gradient(120deg, #3b82f6, #6366f1);
            color: #fef3c7;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.35);
        }

        body.theme-dark .premium-extra-toggle {
            background: rgba(15, 23, 42, 0.7);
            border-color: #334155;
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.6);
        }

        body.theme-dark .premium-extra-toggle h4 {
            color: #e2e8f0;
        }

        body.theme-dark .premium-extra-toggle p {
            color: #cbd5f5;
        }

        body.theme-dark .premium-extra-switch {
            color: #c4b5fd;
        }

        body.theme-dark .premium-extra-switch input[type="checkbox"] {
            background: rgba(51, 65, 85, 0.9);
        }

        body.theme-dark .premium-chip {
            background: rgba(79, 70, 229, 0.2);
            color: #c4b5fd;
        }

        body.theme-dark .premium-people-list li,
        body.theme-dark .premium-suggestions li,
        body.theme-dark .premium-variation-item {
            background: rgba(15, 23, 42, 0.7);
            border-color: #334155;
            color: #e2e8f0;
        }

        body.theme-dark .variation-bar {
            background: rgba(100, 116, 139, 0.5);
        }

        body.theme-dark .premium-empty {
            color: #cbd5f5;
        }

        .theme-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.45rem 0.85rem;
            border-radius: 999px;
            border: 1px solid #e2e8f0;
            background: #ffffff;
            color: #0f172a;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .theme-toggle-btn i {
            color: #6366f1;
        }

        .theme-toggle-btn:hover {
            background: #eef2ff;
            border-color: #c7d2fe;
            color: #312e81;
            transform: translateY(-1px);
        }

        .theme-toggle-btn.theme-toggle-btn-compact {
            padding: 0.35rem 0.7rem;
            font-size: 0.7rem;
            box-shadow: none;
        }

        .theme-toggle-btn span {
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        body.theme-dark {
            background-color: #050b16;
            color: #e2e8f0;
        }

        body.theme-dark .theme-toggle-btn {
            background: rgba(15, 23, 42, 0.85);
            border-color: #334155;
            color: #e2e8f0;
        }

        body.theme-dark .theme-toggle-btn i {
            color: #fcd34d;
        }

        body.theme-dark .theme-toggle-btn:hover {
            background: #1e293b;
            color: #fef3c7;
            border-color: #475569;
        }

        body.theme-dark .bg-white,
        body.theme-dark .modal .bg-white,
        body.theme-dark .goal-card,
        body.theme-dark .budget-card,
        body.theme-dark .print-card {
            background-color: #0f172a !important;
            color: #f1f5f9;
            border-color: #1f2937 !important;
            box-shadow: 0 20px 35px rgba(2, 6, 23, 0.7);
        }

        body.theme-dark .text-gray-900,
        body.theme-dark .text-gray-800,
        body.theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        body.theme-dark .text-gray-600,
        body.theme-dark .text-gray-500,
        body.theme-dark .text-gray-400 {
            color: #cbd5f5 !important;
        }

        body.theme-dark .border-gray-200 {
            border-color: #1f2937 !important;
        }

        body.theme-dark .border-gray-300 {
            border-color: #334155 !important;
        }

        body.theme-dark select,
        body.theme-dark input,
        body.theme-dark textarea {
            background-color: #0f172a;
            color: #f8fafc;
            border-color: #334155;
        }

        body.theme-dark .budget-hero {
            background: linear-gradient(135deg, #0f172a, #312e81);
            color: #c7d2fe;
        }

        body.theme-dark .budget-metric {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(148, 163, 184, 0.2);
        }

        body.theme-dark .budget-alert-button {
            background: rgba(15, 23, 42, 0.5);
            border-color: rgba(99, 102, 241, 0.3);
        }

        body.theme-dark .budget-card {
            background: #0b1120;
        }

        body.theme-dark .budget-card-callout {
            background: #111c2d;
            border-color: #1f2a3f;
        }

        body.theme-dark .budget-card.status-warning .budget-card-callout {
            background: rgba(120, 53, 15, 0.3);
            border-color: rgba(194, 65, 12, 0.4);
        }

        body.theme-dark .budget-card.status-danger .budget-card-callout {
            background: rgba(153, 27, 27, 0.25);
            border-color: rgba(220, 38, 38, 0.4);
        }

        body.theme-dark .budget-card.status-safe .budget-card-callout {
            background: rgba(6, 95, 70, 0.25);
            border-color: rgba(16, 185, 129, 0.3);
        }

        body.theme-dark .goal-hero {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.45);
        }

        body.theme-dark #sticky-period-inner,
        body.theme-dark .sticky-picker {
            background: #0f172a;
            border-color: #1f2937;
            box-shadow: 0 15px 30px rgba(2, 6, 23, 0.65);
        }

        body.theme-dark .budget-empty {
            background: rgba(49, 46, 129, 0.3);
            border-color: rgba(79, 70, 229, 0.4);
            color: #c4b5fd;
        }

        body.theme-dark .modal-content {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        body.theme-dark .tooltip-panel {
            background: #0f172a;
        }

        body.theme-dark .tooltip-panel::after {
            border-color: transparent transparent #0f172a transparent;
        }

        body.theme-dark .transfer-text {
            color: #f8fafc;
        }

        body.theme-dark .transfer-text-positive {
            color: #bef264;
        }

        body.theme-dark .transfer-text-negative {
            color: #fecaca;
        }

        body.theme-dark .goal-metric,
        body.theme-dark .budget-metric {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(148, 163, 184, 0.2);
        }

        body.theme-dark .goal-metric span,
        body.theme-dark .budget-metric span,
        body.theme-dark .goal-card h3,
        body.theme-dark .budget-card h3,
        body.theme-dark .budget-card .callout-title,
        body.theme-dark .budget-alert-card h3 {
            color: #f8fafc;
        }

        body.theme-dark .goal-suggestion-select {
            background: rgba(15, 23, 42, 0.65);
            border-color: rgba(99, 102, 241, 0.5);
            color: #f1f5f9;
        }

        body.theme-dark .goal-suggestion-select option {
            color: #0f172a;
        }

        body.theme-dark .goal-card {
            border-color: rgba(148, 163, 184, 0.15) !important;
        }

        body.theme-dark .budget-card {
            border-color: rgba(30, 41, 59, 0.8) !important;
        }

        body.theme-dark .budget-card .text-gray-500,
        body.theme-dark .budget-card .callout-text,
        body.theme-dark .budget-alert-card p,
        body.theme-dark .goal-card p {
            color: #cbd5f5 !important;
        }

        body.theme-dark .budget-card.status-warning .budget-card-callout .callout-icon,
        body.theme-dark .budget-card.status-danger .budget-card-callout .callout-icon,
        body.theme-dark .budget-card.status-critical .budget-card-callout .callout-icon,
        body.theme-dark .budget-card.status-safe .budget-card-callout .callout-icon {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.theme-dark .budget-alert-card {
            background: #0b1120;
            border-color: #1e293b;
            box-shadow: 0 20px 45px rgba(2, 6, 23, 0.65);
        }

        body.theme-dark .budget-alert-card.status-warning {
            background: rgba(120, 53, 15, 0.45);
            border-color: rgba(251, 191, 36, 0.4);
        }

        body.theme-dark .budget-alert-card.status-warning .alert-badge {
            background: rgba(251, 191, 36, 0.35);
            color: #fff7e0;
        }

        body.theme-dark .budget-alert-card.status-danger {
            background: rgba(153, 27, 27, 0.45);
            border-color: rgba(248, 113, 113, 0.4);
        }

        body.theme-dark .budget-alert-card.status-danger .alert-badge {
            background: rgba(248, 113, 113, 0.35);
            color: #fff5f5;
        }

        body.theme-dark .budget-alert-card.status-critical {
            background: rgba(127, 29, 29, 0.55);
            border-color: rgba(239, 68, 68, 0.45);
        }

        body.theme-dark .budget-alert-card .alert-badge,
        body.theme-dark .budget-card-status {
            color: #fef9c3;
        }

        body.theme-dark .budget-card-status {
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        body.theme-dark .budget-alert-button small,
        body.theme-dark .legend-item,
        body.theme-dark .legend-item span,
        body.theme-dark .budget-label,
        body.theme-dark .goal-hero label,
        body.theme-dark .goal-hero p,
        body.theme-dark .goal-hero span {
            color: #e0e7ff !important;
        }

        body.theme-dark .legend-dot.safe {
            background: #34d399;
        }

        body.theme-dark .legend-dot.warning {
            background: #fbbf24;
        }

        body.theme-dark .legend-dot.danger {
            background: #f87171;
        }

        body.theme-dark table {
            color: #e2e8f0;
        }

        body.theme-dark thead,
        body.theme-dark .bg-gray-50 {
            background-color: #111c2d !important;
        }

        body.theme-dark thead th {
            color: #f8fafc !important;
            border-color: rgba(51, 65, 85, 0.8) !important;
        }

        body.theme-dark tbody tr,
        body.theme-dark table tr,
        body.theme-dark table td,
        body.theme-dark table th {
            border-color: rgba(51, 65, 85, 0.8) !important;
        }

        body.theme-dark tbody tr:nth-child(odd) {
            background-color: rgba(15, 23, 42, 0.65);
        }

        body.theme-dark tbody tr:nth-child(even) {
            background-color: rgba(15, 23, 42, 0.45);
        }

        body.theme-dark tbody td {
            color: #e5e7eb;
        }

        body.theme-dark #statistics-section {
            background: #0b1120 !important;
            border-color: #1e293b !important;
            box-shadow: 0 25px 50px rgba(2, 6, 23, 0.7);
        }

        body.theme-dark #expense-table-body {
            background: transparent;
        }

        body.theme-dark #expense-table-body tr:nth-child(odd) {
            background-color: rgba(15, 23, 42, 0.8) !important;
        }

        body.theme-dark #expense-table-body tr:nth-child(even) {
            background-color: rgba(15, 23, 42, 0.6) !important;
        }

        body.theme-dark #expense-table-body td {
            color: #f1f5f9 !important;
        }

        body.theme-dark #expense-table-body tr:hover {
            background-color: rgba(99, 102, 241, 0.25) !important;
        }

        body.theme-dark .bg-gray-100,
        body.theme-dark .bg-gray-200,
        body.theme-dark .bg-gray-300 {
            background-color: #111c2d !important;
        }

        body.theme-dark .text-green-600,
        body.theme-dark .text-green-500 {
            color: #6ee7b7 !important;
        }

        body.theme-dark .text-blue-600,
        body.theme-dark .text-blue-500 {
            color: #93c5fd !important;
        }

        body.theme-dark .text-indigo-600,
        body.theme-dark .text-indigo-500 {
            color: #c7d2fe !important;
        }

        body.theme-dark .text-red-600,
        body.theme-dark .text-red-500 {
            color: #fca5a5 !important;
        }

        body.theme-dark .text-yellow-600,
        body.theme-dark .text-yellow-500 {
            color: #fde68a !important;
        }

        body.theme-dark .goal-card-actions button {
            background: rgba(148, 163, 184, 0.15);
            color: #e2e8f0;
        }

        body.theme-dark .goal-card-actions button:hover {
            background: rgba(129, 140, 248, 0.35);
        }

        body.theme-dark .budget-card-actions button {
            background: rgba(148, 163, 184, 0.15);
            color: #e2e8f0;
        }

        body.theme-dark .budget-card-actions button:hover {
            background: rgba(129, 140, 248, 0.35);
            color: #fff;
        }

        body.theme-dark input[type="range"]#split-slider {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.8) 0%, rgba(129, 140, 248, 0.65) 100%);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.6);
        }

        body.theme-dark input[type="range"]#split-slider::-webkit-slider-thumb,
        body.theme-dark input[type="range"]#split-slider::-moz-range-thumb,
        body.theme-dark input[type="range"]#split-slider::-ms-thumb {
            background: #0f172a;
            border-color: #c7d2fe;
        }

        body.theme-dark .budget-remaining.ok {
            background: rgba(16, 185, 129, 0.25);
            color: #6ee7b7;
        }

        body.theme-dark .budget-remaining.over {
            background: rgba(239, 68, 68, 0.25);
            color: #fecaca;
        }

        body.theme-dark .budget-card.status-warning .budget-remaining.ok {
            background: rgba(251, 191, 36, 0.28);
            color: #fde68a;
        }

        body.theme-dark .budget-card.status-danger .budget-remaining.ok {
            background: rgba(248, 113, 113, 0.3);
            color: #fecaca;
        }

        body.theme-dark .budget-card.status-critical .budget-remaining.over {
            background: rgba(239, 68, 68, 0.35);
            color: #fee2e2;
        }

        body.theme-dark #chart-wrapper {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 1rem;
        }

        body.theme-dark #table-wrapper {
            background: rgba(2, 6, 23, 0.8);
            border-radius: 1rem;
        }

        body.theme-dark .money-display {
            color: #fef3c7;
        }

        body.theme-dark #settlement-container {
            background: #0b1120;
            border-color: #1f2937;
            color: #e2e8f0;
        }

        body.theme-dark #settlement-content p {
            color: #e5e7eb;
        }

        body.theme-dark #settlement-content .text-yellow-600,
        body.theme-dark #settlement-content .text-yellow-500,
        body.theme-dark #settlement-content .text-yellow-400 {
            color: #fde047 !important;
        }

        body.theme-dark #settlement-content .bg-yellow-100,
        body.theme-dark #settlement-content .bg-yellow-200 {
            background-color: rgba(234, 179, 8, 0.25) !important;
        }

        body.theme-dark #settlement-content .bg-indigo-50 {
            background-color: rgba(67, 56, 202, 0.25) !important;
            border-color: rgba(129, 140, 248, 0.4) !important;
        }

        body.theme-dark #settlement-content .text-indigo-700 {
            color: #c7d2fe !important;
        }

        .period-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.35rem 1rem;
            border-radius: 0.4rem;
            background-color: #eef2ff;
            color: #312e81;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid #e0e7ff;
        }

        .period-chip::before {
            content: '\f073';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.75rem;
        }

        .sticky-picker {
            position: absolute;
            left: 0;
            top: calc(100% + 0.4rem);
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
            border-radius: 0.65rem;
            padding: 0.75rem;
            min-width: 240px;
            z-index: 50;
        }

        .picker-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
        }

        .picker-select {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            font-weight: 600;
            background: #f9fafb;
            color: #111827;
        }

        .picker-select:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.25);
        }

        .period-flash {
            animation: chipPulse 0.9s ease;
        }

        .period-highlight {
            animation: subtleGlow 0.9s ease;
        }

        @keyframes chipPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.35);
            }

            100% {
                box-shadow: 0 0 0 16px rgba(79, 70, 229, 0);
            }
        }

        @keyframes subtleGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(129, 140, 248, 0.25);
            }

            100% {
                box-shadow: 0 0 0 18px rgba(129, 140, 248, 0);
            }
        }

        .goal-hero {
            background: linear-gradient(135deg, #4c1d95, #6d28d9);
            color: #fdf4ff;
            border-radius: 1.5rem;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .goal-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.35), transparent 60%);
            opacity: 0.55;
        }

        .goal-hero>* {
            position: relative;
            z-index: 1;
        }

        .goal-metrics {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .goal-metric {
            background: rgba(15, 23, 42, 0.2);
            padding: 0.85rem 1.1rem;
            border-radius: 1rem;
            min-width: 160px;
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .goal-metric span {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .goal-suggestion-select {
            background: rgba(248, 250, 252, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 999px;
            padding: 0.35rem 1rem;
            color: #f8fafc;
        }

        .goal-suggestion-select option {
            color: #111827;
        }

        .goal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
        }

        .goal-card {
            border-radius: 1.25rem;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(15, 23, 42, 0.05);
        }

        .goal-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.25));
            pointer-events: none;
        }

        .goal-card>* {
            position: relative;
            z-index: 1;
        }

        .goal-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.1rem 0.7rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: #0f172a;
        }

        .goal-progress-track {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.1);
            overflow: hidden;
            margin: 0.75rem 0;
        }

        .goal-progress-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.6s ease;
        }

        .budget-hero {
            background: linear-gradient(135deg, #1d4ed8, #7c3aed);
            border-radius: 1.5rem;
            padding: 2rem;
            color: #e0e7ff;
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.25);
        }

        .budget-hero-top {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .budget-hero-top {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .budget-label {
            text-transform: uppercase;
            letter-spacing: 0.4em;
            font-size: 0.65rem;
            color: rgba(224, 231, 255, 0.8);
            margin-bottom: 0.75rem;
        }

        .budget-hero h2 {
            font-size: clamp(1.5rem, 2vw, 2.2rem);
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.3rem;
        }

        .budget-hero p {
            font-size: 0.95rem;
            color: rgba(226, 232, 240, 0.9);
        }

        .budget-hero-actions button {
            background: #fef3c7;
            color: #b45309;
            font-weight: 600;
            border-radius: 999px;
            padding: 0.85rem 1.5rem;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .budget-hero-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.25);
        }

        .budget-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-top: 1.75rem;
        }

        .budget-metric {
            background: rgba(15, 23, 42, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 1rem;
        }

        .budget-metric p {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 0.35rem;
            color: rgba(224, 231, 255, 0.9);
        }

        .budget-metric span {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
        }

        .budget-alert-button {
            width: 100%;
            background: rgba(15, 23, 42, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            color: #fefefe;
            font-size: 1rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .budget-alert-button small {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        .budget-alert-button:not(.budget-alert-button-disabled):hover {
            background: rgba(15, 23, 42, 0.35);
            transform: translateY(-1px);
        }

        .budget-alert-button-disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .budget-legend {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            font-size: 0.8rem;
            color: rgba(224, 231, 255, 0.85);
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            display: inline-block;
        }

        .legend-dot.safe {
            background: #34d399;
        }

        .legend-dot.warning {
            background: #fbbf24;
        }

        .legend-dot.danger {
            background: #f87171;
        }

        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
        }

        .budget-card {
            background: #ffffff;
            border-radius: 1.25rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            position: relative;
        }

        .budget-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .budget-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.2rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #eef2ff;
            color: #4338ca;
        }

        .budget-card-actions {
            display: inline-flex;
            gap: 0.35rem;
        }

        .budget-card-actions button {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            color: #475569;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .budget-card-actions button:hover {
            background: #e0e7ff;
            color: #3730a3;
        }

        .budget-progress-track {
            width: 100%;
            height: 10px;
            border-radius: 999px;
            background: #e5e7eb;
            overflow: hidden;
        }

        .budget-progress-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.45s ease;
        }

        .budget-card-status {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.77rem;
            font-weight: 600;
            border-radius: 999px;
            padding: 0.2rem 0.75rem;
        }

        .budget-card.status-safe .budget-card-status {
            background: rgba(52, 211, 153, 0.15);
            color: #047857;
        }

        .budget-card.status-warning .budget-card-status {
            background: rgba(251, 191, 36, 0.2);
            color: #92400e;
        }

        .budget-card.status-danger .budget-card-status {
            background: rgba(248, 113, 113, 0.2);
            color: #991b1b;
        }

        .budget-card.status-critical .budget-card-status {
            background: rgba(239, 68, 68, 0.3);
            color: #7f1d1d;
        }

        .budget-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #475569;
        }

        .budget-empty {
            border: 2px dashed #c7d2fe;
            border-radius: 1.25rem;
            padding: 2rem;
            text-align: center;
            color: #4c1d95;
            background: #eef2ff;
        }

        .budget-card-callout {
            border-radius: 1rem;
            padding: 0.9rem 1rem;
            display: flex;
            gap: 0.8rem;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .budget-card-callout .callout-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #e0e7ff;
            color: #312e81;
            font-size: 0.9rem;
        }

        .budget-card.status-safe .budget-card-callout .callout-icon {
            background: #e0f2fe;
            color: #0369a1;
        }

        .budget-card-callout .callout-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #0f172a;
        }

        .budget-card-callout .callout-text {
            font-size: 0.8rem;
            color: #475569;
        }

        .budget-card.status-warning .budget-card-callout {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .budget-card.status-warning .budget-card-callout .callout-icon {
            background: #ffedd5;
            color: #9a3412;
        }

        .budget-card.status-danger .budget-card-callout {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .budget-card.status-danger .budget-card-callout .callout-icon {
            background: #fee2e2;
            color: #b91c1c;
        }

        .budget-card.status-critical .budget-card-callout {
            background: #fee2e2;
            border-color: #fca5a5;
        }

        .budget-card.status-critical .budget-card-callout .callout-icon {
            background: #fecaca;
            color: #7f1d1d;
        }

        .budget-remaining {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            border-radius: 999px;
            padding: 0.2rem 0.9rem;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .budget-remaining.ok {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .budget-remaining.over {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .budget-card.status-warning .budget-remaining.ok {
            background: rgba(251, 191, 36, 0.18);
            color: #92400e;
        }

        .budget-card.status-danger .budget-remaining.ok {
            background: rgba(248, 113, 113, 0.18);
            color: #b91c1c;
        }

        .budget-card.status-critical .budget-remaining.over {
            background: rgba(239, 68, 68, 0.25);
            color: #7f1d1d;
        }

        .budget-alert-card {
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.25rem;
            background: #fff;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        }

        .budget-alert-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.35rem;
        }

        .budget-alert-card p {
            font-size: 0.85rem;
            color: #475569;
            margin-bottom: 0.3rem;
        }

        .budget-alert-card .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.2rem 0.75rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .budget-alert-card.status-warning .alert-badge {
            background: #fef3c7;
            color: #7c2d12;
        }

        .budget-alert-card.status-danger .alert-badge {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .budget-alert-card.status-critical .alert-badge {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .budget-alert-card .alert-remainder.ok {
            color: #065f46;
            font-weight: 600;
        }

        .budget-alert-card .alert-remainder.over {
            color: #b91c1c;
            font-weight: 600;
        }

        .transfer-text {
            color: #0f172a;
        }

        .transfer-text-positive {
            color: #15803d;
        }

        .transfer-text-negative {
            color: #b91c1c;
        }

        .goal-card-actions button {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .goal-card-actions button:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.35);
        }

        .goal-strategy-tooltip {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.2rem;
        }

        .split-preset-btn {
            transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        }

        .split-preset-btn.active {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: #fff;
        }

        input[type="range"]#split-slider {
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: linear-gradient(90deg, #4f46e5 0%, #a5b4fc 100%);
            outline: none;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]#split-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #4f46e5;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.35);
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        input[type="range"]#split-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        input[type="range"]#split-slider::-moz-range-track {
            background: transparent;
        }

        input[type="range"]#split-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #4f46e5;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.35);
            cursor: pointer;
        }

        input[type="range"]#split-slider::-ms-track {
            background: transparent;
            border-color: transparent;
            color: transparent;
        }

        input[type="range"]#split-slider::-ms-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #4f46e5;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.35);
            cursor: pointer;
        }

        .print-card {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body[data-plan-key="premium"] [data-premium-extra="true"] {
                display: block !important;
            }

            body {
                background-color: #ffffff;
                margin: 0;
                padding: 0;
            }

            #print-area {
                display: block !important;
                width: 100% !important;
                padding: 0;
                margin: 0;
                box-shadow: none;
                border: none;
            }

            #print-title {
                display: block !important;
                text-align: center;
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 1.5rem;
            }

            #summary-cards {
                display: grid !important;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
                gap: 1rem !important;
                padding: 0 !important;
            }

            #summary-cards>* {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            #dynamic-cards-container {
                display: contents !important;
            }

            .print-card {
                box-shadow: none !important;
                border-color: #d1d5db !important;
                background-color: #fff !important;
            }

            #settlement-content {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
                gap: 1rem !important;
            }

            #statistics-section {
                page-break-before: always;
                display: block !important;
                height: auto !important;
            }

            #statistics-content {
                display: block !important;
            }

            #chart-wrapper {
                width: 100% !important;
                height: 300px !important;
                margin-bottom: 20px !important;
                page-break-inside: avoid;
            }

            #table-wrapper {
                width: 100% !important;
            }

            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-top: 1rem !important;
            }

            th,
            td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
                text-align: left !important;
                font-size: 10pt !important;
            }

            th {
                background-color: #f4f4f4 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }

            tr,
            td,
            th {
                page-break-inside: avoid !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            h2 {
                font-size: 1.25rem !important;
                font-weight: 600 !important;
                margin-top: 1.5rem !important;
                page-break-before: auto !important;
                page-break-after: avoid !important;
            }
        }

        #print-title {
            display: none;
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #f3f4f6;
            z-index: 50;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 p-4 md:p-8 pb-20">

    <!-- Login -->
    <div id="login-screen" class="flex flex-col justify-center items-center p-4 overflow-y-auto">
        <div
            class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md flex flex-col items-center border border-gray-100">
            <div class="mb-6 bg-indigo-100 p-3 rounded-full"><i class="fas fa-wallet text-3xl text-indigo-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Flux.io</h1>
            <p class="text-gray-500 mb-8 text-center">Gesto Financeira Inteligente</p>
            <div id="auth-loading" class="flex flex-col items-center">
                <div class="loader"></div>
                <p class="text-gray-500 text-sm">Conectando...</p>
            </div>
            <div id="auth-buttons" class="hidden flex flex-col items-center w-full space-y-4">
                <button id="google-login-btn"
                    class="w-full bg-white text-gray-700 font-semibold py-3 px-6 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center space-x-3 hover:bg-gray-50 transition-all">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6"
                        alt="Google Logo"><span>Entrar com Google</span>
                </button>
                <div id="login-error-container" class="hidden mt-6 w-full">
                    <p id="login-error-msg" class="text-sm text-red-600 mt-1 text-center font-bold"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="period-transition-overlay">
        <div class="period-loader">
            <h4>Atualizando</h4>
            <div class="period-loading-dots"><span></span><span></span><span></span></div>
            <p id="period-transition-label">Novo perodo</p>
        </div>
    </div>

    <!-- App Content -->
    <div id="app-content" class="max-w-7xl mx-auto hidden">
        <header class="mb-6 no-print flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-indigo-600"></i> Flux.io
                    <span id="plan-badge"
                        class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full border border-yellow-200 hidden">PREMIUM</span>
                </h1>
                <p class="text-sm text-gray-500 mt-1">Conta: <span id="user-email-display"
                        class="font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded">...</span></p>
            </div>
            <div class="flex items-center gap-3">
                <button type="button" class="theme-toggle-btn" aria-pressed="false" data-theme-toggle>
                    <i class="fas fa-moon" data-theme-icon></i>
                    <span data-theme-label>Modo escuro</span>
                </button>
                <button onclick="window.openSettingsModal()"
                    class="p-2 rounded-full bg-white border border-gray-200 text-gray-600 hover:text-indigo-600 transition-all shadow-sm"
                    title="Configuraes"><i class="fas fa-cog"></i></button>
                <button id="privacy-toggle-btn"
                    class="p-2 rounded-full bg-white border border-gray-200 text-gray-500 hover:text-indigo-600 transition-all shadow-sm"><i
                        class="fas fa-eye"></i></button>
                <button id="logout-btn"
                    class="text-sm text-gray-500 hover:text-red-600 flex items-center bg-white px-3 py-2 rounded border border-gray-200 shadow-sm transition-colors"><i
                        class="fas fa-sign-out-alt mr-2"></i> Sair</button>
            </div>
        </header>

        <div id="plan-restrictions-banner" class="plan-banner hidden no-print">
            <div>
                <h3 id="plan-restrictions-title">Plano Essencial</h3>
                <p class="plan-upgrade-copy">Voc est utilizando o plano limitado. Desbloqueie recursos avanados e
                    limites ilimitados ao migrar para o Premium.</p>
                <ul id="plan-restrictions-highlights"></ul>
            </div>
            <div class="plan-banner-cta-wrapper">
                <span class="plan-status-pill">LIMITADO</span>
                <button type="button" onclick="window.openPremiumModal()"><i class="fas fa-lock-open"></i> Seja
                    Premium</button>
            </div>
        </div>

        <div id="premium-extras-toggle" class="premium-extra-toggle no-print hidden" data-plan-section="premium">
            <div>
                <h4>Insights avanados no dashboard</h4>
                <p>Essas sees adicionais j saem no PDF. Ative se quiser v-las em tempo real na tela.</p>
            </div>
            <label class="premium-extra-switch" for="premium-extras-checkbox">
                <input type="checkbox" id="premium-extras-checkbox" role="switch" aria-checked="false"
                    aria-label="Exibir extras premium">
                Mostrar agora
            </label>
        </div>

        <!-- Filtros -->
        <div id="filter-controls" class="no-print mb-6">
            <div class="bg-white border border-gray-200 rounded-xl shadow-md p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                    <div>
                        <p class="text-[11px] font-semibold uppercase tracking-[0.4em] text-gray-400">Filtros
                            principais</p>
                        <h2 class="text-2xl font-semibold text-gray-800">Configure o perodo do relatrio</h2>
                        <p class="text-sm text-gray-500">Escolha ms, ano e controle a privacidade dos cartes de
                            renda e saldo.</p>
                    </div>
                    <button id="print-button"
                        class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center justify-center space-x-2 transition-colors"><i
                            class="fas fa-print mr-2"></i> Imprimir</button>
                </div>
                <div class="grid gap-6 md:grid-cols-3 items-end">
                    <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-medium text-gray-500">Ms</label><select id="month-select"
                                class="mt-1 block w-full pl-3 pr-8 py-2 text-base border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"></select>
                        </div>
                        <div><label class="block text-xs font-medium text-gray-500">Ano</label><select id="year-select"
                                class="mt-1 block w-full pl-3 pr-8 py-2 text-base border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"></select>
                        </div>
                    </div>
                    <div class="flex items-center md:justify-end">
                        <label for="toggle-income-checkbox"
                            class="flex items-center gap-3 text-sm text-gray-600 cursor-pointer select-none">
                            Mostrar Renda e Saldo
                            <span class="relative inline-flex items-center">
                                <input id="toggle-income-checkbox" type="checkbox" class="sr-only peer">
                                <span
                                    class="w-12 h-6 rounded-full bg-gray-200 peer-checked:bg-indigo-500 transition-colors"></span>
                                <span
                                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow peer-checked:translate-x-6 transition-transform"></span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div id="sticky-period-bar" class="no-print">
            <div id="sticky-period-inner">
                <div class="max-w-7xl mx-auto px-4 sticky-inner-content">
                    <div>
                        <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-gray-400">Perodo
                            selecionado</p>
                        <div class="sticky-trigger-wrapper">
                            <button type="button" id="sticky-period-trigger" class="sticky-trigger">
                                <span id="sticky-period-label" class="period-chip">--</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div id="sticky-period-picker" class="sticky-picker hidden">
                                <div class="picker-row">
                                    <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide">Ms
                                        <select id="sticky-month-select" class="picker-select"></select>
                                    </label>
                                    <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide">Ano
                                        <select id="sticky-year-select" class="picker-select"></select>
                                    </label>
                                </div>
                                <p class="mt-2 text-[11px] text-gray-400">Escolha o ms e ano e eles sero aplicados
                                    automaticamente.</p>
                            </div>
                        </div>
                    </div>
                    <div class="ml-auto flex items-center">
                        <button type="button" class="theme-toggle-btn theme-toggle-btn-compact" aria-pressed="false"
                            data-theme-toggle>
                            <i class="fas fa-moon" data-theme-icon></i>
                            <span data-theme-label>Modo escuro</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="print-area" class="period-fade-group">
            <h1 id="print-title">Relatrio Mensal</h1>

            <!-- Cards Resumo -->
            <div class="mb-8">
                <!-- Cards Principais -->
                <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div id="card-income" class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-sm font-medium text-green-600">Renda Total</h2>
                        <p id="total-income" class="money-display text-3xl font-semibold text-gray-900 mt-2">R$ 0,00</p>
                    </div>
                    <div
                        class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200 relative overflow-hidden">
                        <h2 class="text-sm font-medium text-red-600">Despesa Total</h2>
                        <p id="total-expense" class="money-display text-3xl font-semibold text-gray-900 mt-2">R$ 0,00
                        </p>
                        <div id="expense-comparison"
                            class="absolute bottom-2 right-4 text-xs font-medium hidden no-print"><span
                                id="comparison-icon"></span> <span id="comparison-text"></span> vs ms ant.</div>
                    </div>
                    <div id="card-balance" class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-sm font-medium text-blue-600">Saldo</h2>
                        <p id="total-balance" class="money-display text-3xl font-semibold mt-2 text-gray-900">R$ 0,00
                        </p>
                    </div>

                    <!-- Cards Dinmicos (Tipos de Gastos) -->
                    <div id="dynamic-cards-container" class="contents"></div>
                </div>

                <!-- Card Acerto de Contas (Restaurado e Aprimorado) -->
                <div id="settlement-container"
                    class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Acerto de Contas (Compartilhados)</h2>
                    <div id="settlement-content" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center md:text-left">
                        <p class="text-sm text-gray-500">Calculando...</p>
                    </div>
                </div>
            </div>

            <div id="premium-report-section" class="premium-report-section mb-10 hidden" data-plan-section="premium"
                data-premium-extra="true">
                <div class="grid gap-6 md:grid-cols-2">
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Resumo Premium</h2>
                            <span id="premium-month-label" class="premium-chip text-xs uppercase">Ms atual</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">Pessoas monitoradas</p>
                        <ul id="premium-people-list" class="premium-people-list">
                            <li class="premium-empty">Sem pessoas cadastradas.</li>
                        </ul>
                    </article>
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Sugestes</h2>
                            <span class="premium-chip text-xs uppercase">Metas & limites</span>
                        </div>
                        <ul id="premium-suggestions-list" class="premium-suggestions">
                            <li class="premium-empty">Nenhuma recomendao no momento.</li>
                        </ul>
                    </article>
                </div>

                <div class="grid gap-6 lg:grid-cols-2">
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Gastos por pessoa</h3>
                            <span class="premium-chip text-xs uppercase">Participao</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500">Pessoa</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Pagou</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Consumiu</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Diferena</th>
                                    </tr>
                                </thead>
                                <tbody id="person-breakdown-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </article>
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Distribuio visual</h3>
                            <span class="premium-chip text-xs uppercase">Por pessoa</span>
                        </div>
                        <div class="h-64">
                            <canvas id="person-spending-chart"></canvas>
                        </div>
                    </article>
                </div>

                <div class="grid gap-6 lg:grid-cols-2">
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Tipos de gasto</h3>
                            <span class="premium-chip text-xs uppercase">Top tipos</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500">Tipo</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="type-breakdown-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </article>
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Distribuio por tipo</h3>
                            <span class="premium-chip text-xs uppercase">Viso rpida</span>
                        </div>
                        <div class="h-64">
                            <canvas id="type-breakdown-chart"></canvas>
                        </div>
                    </article>
                </div>

                <div class="grid gap-6 lg:grid-cols-2">
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Variao por categoria</h3>
                            <span id="premium-comparison-label" class="premium-chip text-xs uppercase">Sem
                                histrico</span>
                        </div>
                        <ul id="category-variation-list" class="premium-variation-list">
                            <li class="premium-empty">Carregando anlise...</li>
                        </ul>
                    </article>
                    <article class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Resumo de limites</h3>
                            <span class="premium-chip text-xs uppercase">Status</span>
                        </div>
                        <div id="premium-budget-summary" class="space-y-3 text-sm text-gray-600">
                            <p class="premium-empty">Nenhum limite configurado.</p>
                        </div>
                    </article>
                </div>
            </div>

            <!-- Metas -->
            <div id="goals-section" class="mb-10 no-print space-y-6" data-plan-section="premium">
                <div class="goal-hero">
                    <div class="flex flex-col lg:flex-row justify-between gap-6">
                        <div>
                            <p class="text-xs font-semibold tracking-[0.4em] uppercase text-violet-100 mb-2">Metas &
                                Sonhos</p>
                            <h2 class="text-3xl font-semibold text-white mb-4">Planeje seus grandes momentos com
                                disciplina inteligente.</h2>
                            <div class="goal-metrics">
                                <div class="goal-metric">
                                    <p class="text-xs text-violet-100 uppercase tracking-wide">Guardado</p>
                                    <span id="goal-total-saved" class="money-display">R$ 0,00</span>
                                </div>
                                <div class="goal-metric">
                                    <p class="text-xs text-violet-100 uppercase tracking-wide">Alvo combinado</p>
                                    <span id="goal-total-target" class="money-display">R$ 0,00</span>
                                </div>
                                <div class="goal-metric">
                                    <p class="text-xs text-violet-100 uppercase tracking-wide">Progresso mdio</p>
                                    <span id="goal-total-progress">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col gap-3">
                            <label
                                class="text-xs font-semibold uppercase tracking-[0.3em] text-violet-100">Sugestes</label>
                            <select id="goal-suggestion-select" class="goal-suggestion-select text-sm"></select>
                            <p id="goal-suggestion-description" class="text-xs text-violet-100/80 italic leading-snug">
                                Escolha uma inspirao rpida para preencher a nova meta automaticamente.</p>
                            <div class="flex flex-wrap gap-3">
                                <button id="goal-suggestion-apply"
                                    class="px-4 py-2 rounded-full bg-white/20 text-white text-sm font-semibold hover:bg-white/30 transition">
                                    Vamos l!
                                </button>
                                <button onclick="window.openGoalModal()"
                                    class="px-4 py-2 rounded-full bg-white text-indigo-600 text-sm font-semibold shadow-lg flex items-center gap-2"><i
                                        class="fas fa-plus"></i> Prefiro fazer do meu jeito</button>
                            </div>
                        </div>
                    </div>
                </div>
                <p id="plan-limit-message-goals" class="plan-limit-message hidden"><i class="fas fa-lock"></i> Limite de
                    metas atingido no seu plano atual.</p>
                <div id="goals-container" class="goal-grid"></div>
            </div>

            <div class="plan-locked-card no-print mb-10" data-plan-section="essential">
                <h3><i class="fas fa-lock"></i>Metas &amp; Sonhos  exclusivo do Premium</h3>
                <p>Desbloqueie metas ilimitadas, sugestes inteligentes e acompanhamento completo para planejar os
                    grandes objetivos do casal.</p>
                <button type="button" onclick="window.openPremiumModal()"><i class="fas fa-crown"></i>Assinar
                    Premium</button>
            </div>

            <!-- Budgets -->
            <div id="budgets-section" class="mb-12 no-print space-y-6" data-plan-section="premium">
                <div class="budget-hero">
                    <div class="budget-hero-top">
                        <div>
                            <p class="budget-label">Oramento Mensal</p>
                            <h2>Controle seus limites com alertas inteligentes e visibilidade instantnea.</h2>
                            <p>Combine limites, acompanhe o ritmo de gastos e desbloqueie avisos antes de estourar o
                                ms.</p>
                        </div>
                        <div class="budget-hero-actions">
                            <button onclick="window.openBudgetModal()"><i class="fas fa-plus"></i> Novo limite</button>
                        </div>
                    </div>
                    <div class="budget-metrics">
                        <div class="budget-metric">
                            <p>Limites ativos</p>
                            <span id="budget-total-limit" class="money-display">R$ 0,00</span>
                        </div>
                        <div class="budget-metric">
                            <p>Gasto monitorado</p>
                            <span id="budget-total-spent" class="money-display">R$ 0,00</span>
                        </div>
                        <div class="budget-metric">
                            <p>Alertas</p>
                            <button id="budget-alerts-trigger" type="button" class="budget-alert-button"
                                aria-disabled="true">
                                <span id="budget-alert-count">0</span>
                                <small>Ver detalhes</small>
                            </button>
                        </div>
                    </div>
                    <div class="budget-legend">
                        <span class="legend-item"><span class="legend-dot safe"></span>Em dia (&lt; 75%)</span>
                        <span class="legend-item"><span class="legend-dot warning"></span>Alerta (75-95%)</span>
                        <span class="legend-item"><span class="legend-dot danger"></span>Crtico (&gt; 95%)</span>
                    </div>
                </div>
                <p id="plan-limit-message-budgets" class="plan-limit-message hidden"><i class="fas fa-lock"></i> Limite
                    de oramentos atingido no seu plano atual.</p>
                <div id="budgets-container" class="budget-grid"></div>
            </div>

            <div class="plan-locked-card no-print mb-12" data-plan-section="essential">
                <h3><i class="fas fa-lock"></i>Oramento Mensal liberado no Premium</h3>
                <p>Crie limites por categoria, receba alertas preventivos e veja quem est gastando mais antes de
                    estourar o ms.</p>
                <button type="button" onclick="window.openPremiumModal()"><i class="fas fa-crown"></i>Seja
                    Premium</button>
            </div>

            <!-- Grficos -->
            <div id="statistics-section" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Anlise de Gastos</h2>
                <div id="statistics-content" class="flex flex-col md:flex-row items-center justify-between gap-8">
                    <div id="chart-wrapper" class="w-full md:w-1/2 h-64 md:h-80 flex justify-center"><canvas
                            id="expenseChart"></canvas></div>
                    <div id="table-wrapper" class="w-full md:w-1/2 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Categoria</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Valor (R$)</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">%</th>
                                </tr>
                            </thead>
                            <tbody id="category-stats-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Formulrios -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-8 no-print">
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 relative">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4"><span id="expense-form-title">Adicionar
                                Despesa</span></h2>
                        <form id="expense-form" class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700">Descrio</label><input
                                    type="text" id="expense-desc" required
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Valor (R$)</label><input
                                        type="text" id="expense-amount" data-money-input="true" inputmode="numeric"
                                        autocomplete="off" placeholder="0,00" required
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 flex items-center gap-2">Data
                                        <span class="tooltip-group">
                                            <button type="button" class="tooltip-trigger"
                                                aria-describedby="expense-date-tooltip">i</button>
                                            <span id="expense-date-tooltip" role="tooltip" class="tooltip-panel">
                                                <strong id="expense-tooltip-month-label">Ms atual</strong>: os
                                                lanamentos entram no ms filtrado mesmo que a data seja anterior. Para
                                                registrar em outro ms, altere o filtro l em cima.
                                            </span>
                                        </span>
                                    </label>
                                    <input type="date" id="expense-date" required
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Categoria</label>
                                    <select id="expense-category"
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                                        <option>Moradia</option>
                                        <option>Alimentao</option>
                                        <option>Mercado</option>
                                        <option>Transporte</option>
                                        <option>Lazer</option>
                                        <option>Sade</option>
                                        <option>Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Quem Pagou?</label>
                                    <select id="expense-paid-by"
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></select>
                                </div>
                            </div>

                            <!-- Tipo Inteligente -->
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo de Gasto</label>
                                    <select id="expense-sharing-type"
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm"
                                        onchange="window.handleTypeChange()"></select>
                                </div>

                                <div id="split-container" class="hidden mt-2">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Diviso do Custo:</span>
                                        <span id="split-display" class="font-bold">50% / 50%</span>
                                    </div>
                                    <input type="range" id="split-slider" min="0" max="100" value="50"
                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                    <div class="flex items-center justify-between mt-2 text-xs text-gray-600">
                                        <div id="split-presets" class="flex gap-1">
                                            <button type="button" data-value="0"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">0%</button>
                                            <button type="button" data-value="25"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">25%</button>
                                            <button type="button" data-value="50"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">50%</button>
                                            <button type="button" data-value="75"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">75%</button>
                                            <button type="button" data-value="100"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">100%</button>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <input type="number" id="split-manual-input" min="0" max="100" value="50"
                                                class="w-16 border border-gray-200 rounded px-2 py-1 text-xs text-right">
                                            <span class="text-[11px] text-gray-500">%</span>
                                        </div>
                                    </div>
                                </div>

                                <div id="beneficiary-container" class="hidden mt-2">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Quem  a outra
                                        pessoa?</label>
                                    <select id="expense-beneficiary"
                                        class="block w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm"></select>
                                </div>
                            </div>

                            <!-- Recorrncia -->
                            <div class="p-3 bg-gray-50 rounded border border-gray-100" id="recurrence-section">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Recorrncia</label>
                                <div class="flex space-x-2">
                                    <select id="expense-recurrence-type"
                                        class="block w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm"
                                        onchange="window.toggleRecurrenceInput()">
                                        <option value="none">Apenas este ms</option>
                                        <option value="fixed">Fixo (parcelado)</option>
                                        <option value="indefinite">Indefinido (Fixo Mensal)</option>
                                    </select>
                                    <div id="recurrence-months-input" class="hidden w-1/3">
                                        <input type="number" id="expense-recurrence-months" placeholder="Meses" min="2"
                                            max="60" value="12"
                                            class="w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm">
                                    </div>
                                </div>
                            </div>

                            <div class="flex space-x-3">
                                <button type="submit" id="expense-submit-btn"
                                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition-colors">Adicionar
                                    Despesa</button>
                                <button type="button" id="expense-cancel-btn"
                                    class="hidden flex-none bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm"
                                    onclick="window.cancelEditExpense()">Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <div id="form-container-income" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4"><span id="income-form-title">Adicionar
                                Renda</span></h2>
                        <form id="income-form" class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700">Descrio</label><input
                                    type="text" id="income-desc" required
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Valor (R$)</label><input
                                        type="text" id="income-amount" data-money-input="true" inputmode="numeric"
                                        autocomplete="off" placeholder="0,00" required
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 flex items-center gap-2">Data
                                        <span class="tooltip-group">
                                            <button type="button" class="tooltip-trigger"
                                                aria-describedby="income-date-tooltip">i</button>
                                            <span id="income-date-tooltip" role="tooltip" class="tooltip-panel">
                                                <strong id="income-tooltip-month-label">Ms atual</strong>: rendas
                                                entram no ms filtrado. Para registr-las em outro ms, ajuste o filtro
                                                principal.
                                            </span>
                                        </span>
                                    </label>
                                    <input type="date" id="income-date" required
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                                </div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700">Fonte</label><select
                                    id="income-source"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></select>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" id="income-submit-btn"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition-colors">Adicionar
                                    Renda</button>
                                <button type="button" id="income-cancel-btn"
                                    class="hidden flex-none bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm"
                                    onclick="window.cancelEditIncome()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="space-y-8">
                    <section class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
                            <div>
                                <p class="text-xs font-semibold tracking-[0.4em] uppercase text-indigo-400">Lista
                                    detalhada</p>
                                <h2 class="text-2xl font-semibold text-gray-800">Despesas do Ms</h2>
                                <p class="text-sm text-gray-500">Veja cada lanamento e acompanhe totais, quantidade
                                    e picos do ms selecionado.</p>
                            </div>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-100">
                                    <p class="text-[11px] uppercase tracking-wide text-gray-500">Total listado</p>
                                    <span id="expense-insight-total" class="text-lg font-semibold text-gray-900">R$
                                        0,00</span>
                                </div>
                                <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-100">
                                    <p class="text-[11px] uppercase tracking-wide text-gray-500">Itens registrados</p>
                                    <span id="expense-insight-count"
                                        class="text-lg font-semibold text-gray-900">0</span>
                                </div>
                                <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-100">
                                    <p class="text-[11px] uppercase tracking-wide text-gray-500">Maior gasto</p>
                                    <span id="expense-insight-top" class="text-lg font-semibold text-gray-900">R$
                                        0,00</span>
                                </div>
                            </div>
                        </div>
                        <div id="expense-empty-state"
                            class="hidden mt-6 border border-dashed border-gray-300 rounded-lg p-6 text-center text-sm text-gray-500">
                            Nenhuma despesa registrada para o perodo selecionado. Lance uma nova despesa para comear
                            a acompanhar.
                        </div>
                        <div id="expense-table-container" class="mt-6">
                            <div class="overflow-x-auto border border-gray-100 rounded-xl shadow-inner">
                                <div class="max-h-[440px] overflow-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Descrio</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Valor</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Data
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Categoria
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Tipo
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Pago
                                                    por</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase no-print">
                                                    Ao</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expense-table-body" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>
                    <div id="table-container-income" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Rendas do Ms</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Descrio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Valor</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Fonte</th>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase no-print">
                                            Ao</th>
                                    </tr>
                                </thead>
                                <tbody id="income-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex flex-col items-center space-y-4 no-print">
                <button onclick="document.getElementById('import-file-input').click()"
                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2"><i
                        class="fas fa-file-import"></i> Importar Extrato (CSV)</button>
                <input type="file" id="import-file-input" class="hidden" accept=".csv"
                    onchange="window.handleImportCSV(this)">
                <button onclick="window.migrateData()"
                    class="text-xs text-gray-400 hover:text-gray-600 underline">Importar dados do perfil antigo para o
                    compartilhado</button>
            </div>
        </div>
    </div>

    <div id="plan-restriction-toast" class="plan-restriction-toast hidden">
        <span id="plan-restriction-toast-text"></span>
        <button type="button" id="plan-restriction-toast-close" aria-label="Fechar aviso"><i
                class="fas fa-times"></i></button>
    </div>

    <!-- MODAL SETTINGS -->
    <div id="modal-settings"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 m-4 modal-content max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-cogs"></i>
                Configuraes</h2>
            <div class="mb-6 border-b pb-6">
                <h3 class="text-sm font-bold text-gray-700 mb-2">Pessoas (Max 4)</h3>
                <div id="settings-people-list" class="space-y-2 mb-3"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-person-name" placeholder="Nome"
                        class="flex-1 border rounded px-2 py-1 text-sm">
                    <button onclick="window.addPerson()"
                        class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Adicionar</button>
                </div>
            </div>
            <div class="mb-6">
                <h3 class="text-sm font-bold text-gray-700 mb-2">Tipos de Gastos</h3>
                <div id="settings-types-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto pr-1"></div>
                <div class="bg-gray-50 p-3 rounded border">
                    <h4 id="type-form-title" class="text-xs font-semibold mb-2">Novo Tipo</h4>
                    <input type="text" id="new-type-label" placeholder="Nome"
                        class="w-full border rounded px-2 py-1 text-sm mb-2">
                    <div class="flex items-center gap-2 mb-2">
                        <label class="text-xs text-gray-600">Cor:</label>
                        <div class="flex gap-1" id="color-picker-container"></div>
                        <input type="hidden" id="new-type-color" value="#ffffff">
                    </div>
                    <div class="flex flex-col gap-2 mb-3">
                        <div class="flex items-center gap-2"><input type="radio" name="new-type-mode" id="nt-shared"
                                value="shared" class="text-indigo-600" checked><label for="nt-shared"
                                class="text-xs text-gray-700">Compartilhado</label></div>
                        <div class="flex items-center gap-2"><input type="radio" name="new-type-mode" id="nt-individual"
                                value="individual" class="text-indigo-600"><label for="nt-individual"
                                class="text-xs text-gray-700">Individual/Outros</label></div>
                        <div class="flex items-center gap-2"><input type="radio" name="new-type-mode"
                                id="nt-other-person" value="other" class="text-indigo-600"><label for="nt-other-person"
                                class="text-xs text-gray-700">Gasto de Outra Pessoa (100%)</label></div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="new-type-submit" onclick="window.addExpenseType()"
                            class="flex-1 bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700">Criar
                            Tipo</button>
                        <button type="button" id="cancel-type-edit-btn" onclick="window.cancelTypeEdit()"
                            class="hidden px-3 py-1.5 rounded text-sm bg-gray-200 text-gray-700 hover:bg-gray-300">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end"><button onclick="window.closeSettingsModal()"
                    class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Fechar</button></div>
        </div>
    </div>

    <!-- MODAL GOAL CONTRIBUTION -->
    <div id="modal-goal-contribution"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 modal-content">
            <h2 class="text-xl font-bold text-gray-800 mb-4" id="goal-contrib-title">Adicionar Aporte</h2>
            <form id="goal-contrib-form" class="space-y-4 mb-6">
                <input type="hidden" id="goal-contrib-goal-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs text-gray-500">Valor</label><input type="text"
                            id="goal-contrib-amount" data-money-input="true" inputmode="numeric" autocomplete="off"
                            class="w-full border rounded p-2" placeholder="0,00" required></div>
                    <div><label class="block text-xs text-gray-500">Data</label><input type="date"
                            id="goal-contrib-date" class="w-full border rounded p-2" required></div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Salvar
                    Aporte</button>
            </form>
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Histrico de Aportes</h3>
            <div id="goal-history-list" class="max-h-40 overflow-y-auto text-sm border-t pt-2 space-y-2"></div>
            <div class="flex justify-end mt-4"><button type="button" onclick="window.closeGoalContribModal()"
                    class="text-gray-500 hover:text-gray-700">Fechar</button></div>
        </div>
    </div>

    <!-- MODAL BUDGET ALERTS -->
    <div id="modal-budget-alerts"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 m-4 modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <p class="text-xs uppercase tracking-[0.4em] text-indigo-400">Monitoramento</p>
                    <h2 class="text-2xl font-bold text-gray-800">Alertas de Oramento</h2>
                </div>
                <button onclick="window.closeBudgetAlertsModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Listamos apenas categorias em estado de alerta ou crtico para voc
                agir a tempo.</p>
            <div id="budget-alerts-list" class="space-y-4"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="window.closeBudgetAlertsModal()"
                    class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODALS (Budget/Goal) -->
    <div id="modal-goal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-1" id="modal-goal-title">Nova Meta</h2>
            <form id="goal-form" class="space-y-4"><input type="hidden" id="goal-id">
                <div><label class="block text-sm font-medium text-gray-700">Nome da Meta</label><input type="text"
                        id="goal-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"
                        placeholder="Ex: Viagem Europa" required></div>
                <div><label class="block text-sm font-medium text-gray-700">Valor Alvo (R$)</label><input type="text"
                        id="goal-target" data-money-input="true" inputmode="numeric" autocomplete="off"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" placeholder="0,00"
                        required></div>
                <div><label class="block text-sm font-medium text-gray-700">Estratgia de Aporte</label><select
                        id="goal-strategy" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        <option value="manual">Manual</option>
                        <option value="fixed">Valor Fixo</option>
                        <option value="percentage">Porcentagem</option>
                    </select></div>
                <div id="goal-strategy-value-container" class="hidden"><label
                        class="block text-sm font-medium text-gray-700">Valor</label><input type="number"
                        id="goal-strategy-value"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></div>
                <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="window.closeGoalModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button><button
                        type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Salvar
                        Meta</button></div>
            </form>
        </div>
    </div>
    <div id="modal-budget"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-1" id="modal-budget-title">Novo Limite</h2>
            <form id="budget-form" class="space-y-4"><input type="hidden" id="budget-id">
                <div><label class="block text-sm font-medium text-gray-700">Categoria</label><select
                        id="budget-category"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Limite Mensal (R$)</label><input type="text"
                        id="budget-amount" data-money-input="true" inputmode="numeric" autocomplete="off"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" placeholder="0,00"
                        required></div>
                <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="window.closeBudgetModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button><button
                        type="submit" class="px-4 py-2 text-white bg-orange-600 rounded-lg hover:bg-orange-700">Salvar
                        Limite</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, deleteDoc, getDocs, onSnapshot, query, where, getDoc, orderBy, limit, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAO
        const firebaseConfig = {
            apiKey: "AIzaSyD2Mn2I9ell-bA7RZavH-JxHJid9wTDZe8",
            authDomain: "controle-gastos-c4c4d.firebaseapp.com",
            projectId: "controle-gastos-c4c4d",
            storageBucket: "controle-gastos-c4c4d.firebasestorage.app",
            messagingSenderId: "515466326654",
            appId: "1:515466326654:web:0f841817662029d12a1e2f"
        };
        const ALLOWED_EMAILS = ["eduardocarnello@gmail.com", "camilaps05@gmail.com"];
        const DB_BASE_PATH = "conta_compartilhada/dados";
        const USER_PLAN = 'premium';
        const PLAN_RULES = {
            premium: {
                key: 'premium',
                label: 'Premium',
                badgeLabel: 'PREMIUM',
                limits: { goals: Infinity, budgets: Infinity },
                features: { budgetAlerts: true },
                summary: ['Alertas inteligentes liberados', 'Metas e oramentos ilimitados', 'Experincia completa sem bloqueios']
            },
            essential: {
                key: 'essential',
                label: 'Essencial',
                badgeLabel: 'ESSENCIAL',
                limits: { goals: 2, budgets: 2 },
                features: { budgetAlerts: false },
                summary: ['At 2 metas simultneas', 'At 2 limites de oramento', 'Alertas inteligentes exclusivos do Premium']
            }
        };
        const PLAN_LIMIT_MESSAGES = {
            goals: 'Voc atingiu o limite de metas disponveis no seu plano. Faa upgrade para criar metas ilimitadas.',
            budgets: 'Voc atingiu o limite de oramentos no plano Essencial. Torne-se Premium para liberar mais categorias e alertas.'
        };
        const PREMIUM_EXTRAS_STORAGE_KEY = 'fluxPremiumExtras';

        let app, db, auth;
        let unsubscribeExpenses = () => { }, unsubscribeIncome = () => { }, unsubscribeGoals = () => { }, unsubscribeBudgets = () => { };
        let currentExpenses = [], currentIncomes = [], currentGoals = [], currentBudgets = [];
        let historicalAverageSurplus = 0;
        let expenseChartInstance = null;
        let editingExpenseId = null, editingIncomeId = null;
        const DEFAULT_TYPE_IDS = ['t1', 't2'];
        const MAX_CUSTOM_TYPES = 4;
        let editingTypeId = null;
        let editingGoalId = null;
        let editingBudgetId = null;
        let budgetAlertItems = [];
        let planToastTimeout = null;
        let premiumExtrasEnabled = localStorage.getItem(PREMIUM_EXTRAS_STORAGE_KEY) === 'true';
        let premiumCharts = { person: null, type: null };
        let previousMonthCategoryTotals = {};
        let previousMonthLabel = '';

        let appSettings = {
            people: [{ id: 'p1', name: 'Eduardo' }, { id: 'p2', name: 'Camila' }],
            expenseTypes: [
                { id: 't1', label: 'Compartilhado', color: '#ffffff', isShared: true, isThirdParty: false, defaultSplit: 50 },
                { id: 't2', label: 'No Compartilhado', color: '#f3f4f6', isShared: false, isThirdParty: false, defaultSplit: 0 },
                { id: 't3', label: 'Gasto de Outra Pessoa', color: '#fff7ed', isShared: false, isThirdParty: true, defaultSplit: 0 },
                { id: 't4', label: 'Gastos Cid', color: '#e9d5ff', isShared: false, isThirdParty: true, defaultSplit: 0 },
                { id: 't5', label: 'Gastos Praia', color: '#cffafe', isShared: false, isThirdParty: false, defaultSplit: 0 }
            ]
        };
        const availableColors = ['#ffffff', '#e9d5ff', '#cffafe', '#fecaca', '#bbf7d0', '#fef08a', '#fed7aa', '#fff7ed'];
        const GOAL_CARD_THEMES = [
            { background: 'linear-gradient(135deg, #fde68a 0%, #f59e0b 100%)', accent: '#fbbf24', chipBg: 'rgba(255,255,255,0.45)', chipText: '#7c2d12', border: 'rgba(251,191,36,0.4)', shadow: '0 20px 35px rgba(245,158,11,0.35)', textColor: '#7c2d12' },
            { background: 'linear-gradient(135deg, #ddd6fe 0%, #818cf8 100%)', accent: '#6366f1', chipBg: 'rgba(255,255,255,0.35)', chipText: '#1e1b4b', border: 'rgba(99,102,241,0.35)', shadow: '0 20px 35px rgba(99,102,241,0.35)', textColor: '#111827' },
            { background: 'linear-gradient(135deg, #99f6e4 0%, #34d399 100%)', accent: '#059669', chipBg: 'rgba(255,255,255,0.4)', chipText: '#064e3b', border: 'rgba(5,150,105,0.35)', shadow: '0 20px 35px rgba(5,150,105,0.3)', textColor: '#064e3b' },
            { background: 'linear-gradient(135deg, #fecdd3 0%, #fb7185 100%)', accent: '#f472b6', chipBg: 'rgba(255,255,255,0.45)', chipText: '#831843', border: 'rgba(244,114,182,0.35)', shadow: '0 20px 35px rgba(236,72,153,0.35)', textColor: '#831843' }
        ];
        const GOAL_SUGGESTIONS = [
            {
                id: 'dream-trip',
                label: ' Viagem dos sonhos (12 meses)',
                description: 'Reservem juntos a viagem perfeita com aportes fixos e previsveis.',
                name: 'Viagem dos Sonhos ',
                targetAmount: 15000,
                strategy: 'fixed',
                strategyValue: 1250
            },
            {
                id: 'mini-wedding',
                label: ' Mini wedding minimalista',
                description: 'Planejem um mini wedding elegante com metas claras por ms.',
                name: 'Mini Wedding ',
                targetAmount: 30000,
                strategy: 'fixed',
                strategyValue: 2500
            },
            {
                id: 'emergency',
                label: ' Fundo de emergncia 6 meses',
                description: 'Construam um colcho para viver seis meses tranquilos sem renda.',
                name: 'Fundo de Emergncia ',
                targetAmount: 36000,
                strategy: 'manual'
            },
            {
                id: 'home-refresh',
                label: ' Upgrade da casa',
                description: 'Reforme cmodos com reservas menores e constantes.',
                name: 'Upgrade da Casa ',
                targetAmount: 10000,
                strategy: 'fixed',
                strategyValue: 850
            },
            {
                id: 'education',
                label: ' Curso internacional',
                description: 'Prepare-se para estudar fora guardando parte da renda extra.',
                name: 'Curso Internacional ',
                targetAmount: 18000,
                strategy: 'percentage',
                strategyValue: 15
            },
            {
                id: 'new-car',
                label: ' Carro novo sem aperto',
                description: 'Troquem de carro com aportes constantes e previsveis.',
                name: 'Carro dos Sonhos ',
                targetAmount: 85000,
                strategy: 'fixed',
                strategyValue: 3540
            },
            {
                id: 'city-moto',
                label: ' Moto para o dia a dia',
                description: 'Garanta a moto nova guardando metas pequenas toda semana.',
                name: 'Moto Nova ',
                targetAmount: 25000,
                strategy: 'fixed',
                strategyValue: 2085
            },
            {
                id: 'baby-plans',
                label: ' Enxoval do beb preparado',
                description: 'Monte o enxoval inteiro com antecedncia e tranquilidade.',
                name: 'Enxoval do Beb ',
                targetAmount: 18000,
                strategy: 'percentage',
                strategyValue: 10
            },
            {
                id: 'creative-studio',
                label: ' Estdio/office inspirador',
                description: 'Equipe o home office criativo com gadgets e acstica top.',
                name: 'Estdio Criativo ',
                targetAmount: 12000,
                strategy: 'fixed',
                strategyValue: 1000
            },
            {
                id: 'mini-break',
                label: ' Mini frias em casal',
                description: 'Garanta uma escapada de 5 dias com tudo includo e zero culpa.',
                name: 'Mini Frias ',
                targetAmount: 8000,
                strategy: 'fixed',
                strategyValue: 665
            },
            {
                id: 'wellness-retreat',
                label: ' Retiro de bem-estar',
                description: 'Spa completo, terapias e detox digital para resetar a mente.',
                name: 'Retiro Wellness ',
                targetAmount: 12000,
                strategy: 'fixed',
                strategyValue: 1000
            },
            {
                id: 'aesthetic-glow',
                label: ' Procedimento esttico desejado',
                description: 'Reserve para um combo de harmonizao, laser e skincare top.',
                name: 'Glow Up ',
                targetAmount: 20000,
                strategy: 'fixed',
                strategyValue: 1665
            },
            {
                id: 'dream-lodge',
                label: ' Experincia premium na neve',
                description: 'Viva uma semana em resort de neve com passeios e equipamentos.',
                name: 'Semana na Neve ',
                targetAmount: 25000,
                strategy: 'fixed',
                strategyValue: 2085
            }
        ];
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Maro", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        let stickyObserver = null;
        let stickyPickerInitialized = false;
        let periodTransitionActive = false;
        let periodTransitionTimeout = null;
        let goalSuggestionInitialized = false;
        const THEME_STORAGE_KEY = 'fluxTheme';
        let currentTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
        let themeToggleInitialized = false;
        if (document.body) {
            document.body.classList.toggle('theme-dark', currentTheme === 'dark');
        }

        // HELPER FUNCTIONS (DEFINED FIRST)
        function closeSettingsModal() {
            const modal = document.getElementById('modal-settings');
            if (!modal) return;
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
            document.body.classList.remove('modal-active');
        }
        function updateSettingsUI() {
            const pList = document.getElementById('settings-people-list');
            if (pList) {
                pList.innerHTML = appSettings.people.map((p) => {
                    const safeName = (p.name || '').replace(/"/g, '&quot;');
                    const canRemove = appSettings.people.length > 1;
                    const removeClass = canRemove ? 'text-red-500 hover:text-red-600' : 'text-gray-400 opacity-40 cursor-not-allowed';
                    return `
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-200">
                            <input type="text" value="${safeName}" class="flex-1 text-sm border border-gray-200 rounded px-2 py-1 bg-white"
                                onchange="window.renamePerson('${p.id}', this.value)" placeholder="Nome" />
                            <button ${canRemove ? '' : 'disabled'}
                                onclick="window.removePerson('${p.id}')"
                                class="${removeClass} transition"><i class="fas fa-trash"></i></button>
                        </div>`;
                }).join('');
            }
            const tList = document.getElementById('settings-types-list');
            if (tList) {
                tList.innerHTML = appSettings.expenseTypes.map((t) => {
                    const isDefault = DEFAULT_TYPE_IDS.includes(t.id);
                    const modeLabel = t.isShared ? `Compartilhado  ${t.defaultSplit || 50}%`
                        : (t.isThirdParty ? 'Outro beneficirio (100%)' : 'Individual');
                    return `
                        <div class="flex justify-between items-center bg-white border p-2 rounded mb-2" style="border-left: 4px solid ${t.color}">
                            <div>
                                <p class="text-sm font-semibold text-gray-800">${t.label}</p>
                                <p class="text-xs text-gray-500">${modeLabel}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${isDefault ? '' : `<button class="text-indigo-500 hover:text-indigo-700" onclick="window.startTypeEdit('${t.id}')"><i class="fas fa-edit"></i></button>`}
                                ${isDefault ? '' : `<button class="text-gray-400 hover:text-red-500" onclick="window.removeType('${t.id}')"><i class="fas fa-trash"></i></button>`}
                            </div>
                        </div>`;
                }).join('');
                updateTypeFormState(Boolean(editingTypeId));
            }
        }
        window.addPerson = () => {
            const input = document.getElementById('new-person-name');
            const val = input.value.trim();
            if (!val) return;
            if (appSettings.people.length >= 4) { alert('Limite de 4 pessoas atingido.'); return; }
            appSettings.people.push({ id: `p${Date.now()}`, name: val });
            input.value = '';
            saveSettings();
        };
        window.renamePerson = (personId, newName) => {
            const idx = appSettings.people.findIndex(p => p.id === personId);
            if (idx === -1) return;
            const trimmed = (newName || '').trim();
            if (!trimmed) return;
            if (appSettings.people[idx].name === trimmed) return;
            appSettings.people[idx].name = trimmed;
            saveSettings();
        };
        window.removePerson = (personId) => {
            if (appSettings.people.length <= 1) { alert('Mantenha ao menos uma pessoa cadastrada.'); return; }
            if (!confirm("Remover pessoa?")) return;
            const idx = appSettings.people.findIndex(p => p.id === personId);
            if (idx === -1) return;
            appSettings.people.splice(idx, 1);
            saveSettings();
        };

        function updateTypeFormState(isEditing) {
            const title = document.getElementById('type-form-title');
            const submit = document.getElementById('new-type-submit');
            const cancel = document.getElementById('cancel-type-edit-btn');
            if (title) title.textContent = isEditing ? 'Editar Tipo' : 'Novo Tipo';
            if (submit) submit.textContent = isEditing ? 'Salvar Alteraes' : 'Criar Tipo';
            if (cancel) cancel.classList.toggle('hidden', !isEditing);
        }

        function getSelectedTypeMode() {
            const checked = document.querySelector('input[name="new-type-mode"]:checked');
            const mode = checked ? checked.value : 'shared';
            return {
                isShared: mode === 'shared',
                isThirdParty: mode === 'other',
                defaultSplit: mode === 'shared' ? 50 : 0
            };
        }

        function highlightColorDot(color) {
            document.querySelectorAll('#color-picker-container .color-dot').forEach(dot => {
                dot.classList.toggle('selected', dot.dataset.color === color);
            });
        }

        window.addExpenseType = () => {
            const labelInput = document.getElementById('new-type-label');
            const label = labelInput.value.trim();
            const color = document.getElementById('new-type-color').value;
            if (!label) return;
            const mode = getSelectedTypeMode();
            if (!editingTypeId) {
                const customCount = appSettings.expenseTypes.filter(t => !DEFAULT_TYPE_IDS.includes(t.id)).length;
                if (customCount >= MAX_CUSTOM_TYPES) { alert('Voc pode cadastrar at 4 tipos personalizados.'); return; }
                appSettings.expenseTypes.push({ id: `t${Date.now()}`, label, color, ...mode });
            } else {
                const idx = appSettings.expenseTypes.findIndex(t => t.id === editingTypeId);
                if (idx !== -1) appSettings.expenseTypes[idx] = { ...appSettings.expenseTypes[idx], label, color, ...mode };
                editingTypeId = null;
            }
            labelInput.value = '';
            document.getElementById('nt-shared').checked = true;
            document.getElementById('new-type-color').value = '#ffffff';
            highlightColorDot('#ffffff');
            updateTypeFormState(false);
            saveSettings();
        };

        window.startTypeEdit = (typeId) => {
            const type = appSettings.expenseTypes.find(t => t.id === typeId);
            if (!type || DEFAULT_TYPE_IDS.includes(type.id)) return;
            editingTypeId = typeId;
            document.getElementById('new-type-label').value = type.label;
            document.getElementById('new-type-color').value = type.color;
            highlightColorDot(type.color);
            if (type.isShared) document.getElementById('nt-shared').checked = true;
            else if (type.isThirdParty) document.getElementById('nt-other-person').checked = true;
            else document.getElementById('nt-individual').checked = true;
            updateTypeFormState(true);
        };

        window.cancelTypeEdit = () => {
            editingTypeId = null;
            document.getElementById('new-type-label').value = '';
            document.getElementById('new-type-color').value = '#ffffff';
            highlightColorDot('#ffffff');
            document.getElementById('nt-shared').checked = true;
            updateTypeFormState(false);
        };

        window.removeType = (typeId) => {
            if (DEFAULT_TYPE_IDS.includes(typeId)) { alert('Tipo padro no pode ser removido.'); return; }
            if (!confirm("Remover tipo?")) return;
            const idx = appSettings.expenseTypes.findIndex(t => t.id === typeId);
            if (idx === -1) return;
            appSettings.expenseTypes.splice(idx, 1);
            if (editingTypeId === typeId) {
                editingTypeId = null;
                updateTypeFormState(false);
            }
            saveSettings();
        };
        // No  necessrio, pois o nome  editado diretamente ao adicionar/remover
        // Color picker funcional
        function initColorPicker() {
            const c = document.getElementById('color-picker-container');
            if (!c) return;
            const availableColors = ['#ffffff', '#e9d5ff', '#cffafe', '#fecaca', '#bbf7d0', '#fef08a', '#fed7aa', '#fff7ed'];
            c.innerHTML = availableColors.map(col => `<button type="button" class="color-dot" data-color="${col}" style="background-color:${col}" onclick="window.selectColor(this,'${col}')"></button>`).join('');
            const firstDot = c.querySelector('.color-dot');
            if (firstDot) window.selectColor(firstDot, firstDot.dataset.color);
        }
        window.selectColor = (el, col) => {
            if (!el) return;
            highlightColorDot(col);
            document.getElementById('new-type-color').value = col;
        };
        function getCurrentFilterMonthYear() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            if (!monthSelect || !yearSelect) {
                return getMonthYear(new Date().toISOString().split('T')[0]);
            }
            return `${monthSelect.value}-${yearSelect.value}`;
        }

        function getCurrentFilterLabel() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const now = new Date();
            const month = monthSelect ? Number(monthSelect.value) : now.getMonth() + 1;
            const year = yearSelect ? yearSelect.value : now.getFullYear();
            const index = Math.max(1, Math.min(12, month)) - 1;
            return `${MONTH_NAMES[index]} de ${year}`;
        }

        function updateCompetencyTooltips() {
            const label = getCurrentFilterLabel();
            const expenseLabel = document.getElementById('expense-tooltip-month-label');
            if (expenseLabel) expenseLabel.textContent = label;
            const incomeLabel = document.getElementById('income-tooltip-month-label');
            if (incomeLabel) incomeLabel.textContent = label;
            const printTitle = document.getElementById('print-title');
            if (printTitle) printTitle.textContent = `Relatrio Mensal  ${label}`;
        }

        function handlePeriodChange(source = 'primary') {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            if (!monthSelect || !yearSelect) return;
            const stickyMonthSelect = document.getElementById('sticky-month-select');
            const stickyYearSelect = document.getElementById('sticky-year-select');

            if (source === 'sticky' && stickyMonthSelect && stickyYearSelect) {
                monthSelect.value = stickyMonthSelect.value;
                yearSelect.value = stickyYearSelect.value;
            } else if (source === 'primary' && stickyMonthSelect && stickyYearSelect) {
                stickyMonthSelect.value = monthSelect.value;
                stickyYearSelect.value = yearSelect.value;
            }

            beginPeriodTransition();
            updateCompetencyTooltips();
            updateStickyPeriodBar();
            triggerPeriodChangeAnimation();
            loadDataForMonth();
            if (source === 'sticky') toggleStickyPicker(false);
        }

        function triggerPeriodChangeAnimation() {
            const stickyLabel = document.getElementById('sticky-period-label');
            const stickyCard = document.getElementById('sticky-period-inner');
            const filterControls = document.getElementById('filter-controls');
            [stickyLabel, stickyCard].forEach(el => {
                if (!el) return;
                el.classList.remove('period-flash');
                void el.offsetWidth;
                el.classList.add('period-flash');
            });
            if (filterControls) {
                filterControls.classList.remove('period-highlight');
                void filterControls.offsetWidth;
                filterControls.classList.add('period-highlight');
                setTimeout(() => filterControls.classList.remove('period-highlight'), 900);
            }
        }

        function updateStickyPeriodBar() {
            const stickyLabel = document.getElementById('sticky-period-label');
            if (stickyLabel) stickyLabel.textContent = getCurrentFilterLabel();
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const stickyMonthSelect = document.getElementById('sticky-month-select');
            const stickyYearSelect = document.getElementById('sticky-year-select');
            if (monthSelect && stickyMonthSelect && stickyMonthSelect.value !== monthSelect.value) {
                stickyMonthSelect.value = monthSelect.value;
            }
            if (yearSelect && stickyYearSelect && stickyYearSelect.value !== yearSelect.value) {
                stickyYearSelect.value = yearSelect.value;
            }
        }

        function setupStickyObserver() {
            if (stickyObserver) stickyObserver.disconnect();
            const stickyBar = document.getElementById('sticky-period-bar');
            const filterControls = document.getElementById('filter-controls');
            if (!stickyBar || !filterControls) return;
            stickyObserver = new IntersectionObserver(([entry]) => {
                if (!entry) return;
                if (entry.isIntersecting) stickyBar.classList.remove('sticky-visible');
                else stickyBar.classList.add('sticky-visible');
            }, { threshold: 0.99 });
            stickyObserver.observe(filterControls);
        }

        function toggleStickyPicker(force) {
            const picker = document.getElementById('sticky-period-picker');
            const trigger = document.getElementById('sticky-period-trigger');
            if (!picker || !trigger) return;
            const shouldOpen = typeof force === 'boolean' ? force : picker.classList.contains('hidden');
            picker.classList.toggle('hidden', !shouldOpen);
            trigger.classList.toggle('active', shouldOpen);
        }

        function initializeStickyPicker() {
            if (stickyPickerInitialized) return;
            const trigger = document.getElementById('sticky-period-trigger');
            const picker = document.getElementById('sticky-period-picker');
            if (!trigger || !picker) return;
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleStickyPicker();
            });
            document.addEventListener('click', (e) => {
                if (picker.classList.contains('hidden')) return;
                if (!picker.contains(e.target) && !trigger.contains(e.target)) {
                    toggleStickyPicker(false);
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') toggleStickyPicker(false);
            });
            stickyPickerInitialized = true;
        }

        function beginPeriodTransition() {
            if (periodTransitionTimeout) {
                clearTimeout(periodTransitionTimeout);
                periodTransitionTimeout = null;
            }
            periodTransitionActive = true;
            const transitionLabel = document.getElementById('period-transition-label');
            if (transitionLabel) transitionLabel.textContent = getCurrentFilterLabel();
            const overlay = document.getElementById('period-transition-overlay');
            if (overlay) overlay.classList.add('active');
            const content = document.getElementById('app-content');
            if (content) content.classList.add('period-fade-active');
        }

        function completePeriodTransition() {
            if (!periodTransitionActive) return;
            if (periodTransitionTimeout) clearTimeout(periodTransitionTimeout);
            periodTransitionTimeout = setTimeout(() => {
                const overlay = document.getElementById('period-transition-overlay');
                if (overlay) overlay.classList.remove('active');
                const content = document.getElementById('app-content');
                if (content) content.classList.remove('period-fade-active');
                periodTransitionActive = false;
            }, 450);
        }

        function resetExpenseForm() {
            const form = document.getElementById('expense-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('expense-amount');
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('expense-date');
            if (dateInput) dateInput.value = today;
            const cancelBtn = document.getElementById('expense-cancel-btn');
            if (cancelBtn) cancelBtn.classList.add('hidden');
            const title = document.getElementById('expense-form-title');
            if (title) title.textContent = 'Adicionar Despesa';
            const submit = document.getElementById('expense-submit-btn');
            if (submit) submit.textContent = 'Adicionar Despesa';
            editingExpenseId = null;
            setSplitValue(document.getElementById('split-slider') ? document.getElementById('split-slider').value : 50);
            handleTypeChange();
            toggleRecurrenceInput();
        }

        function resetIncomeForm() {
            const form = document.getElementById('income-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('income-amount');
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('income-date');
            if (dateInput) dateInput.value = today;
            const cancelBtn = document.getElementById('income-cancel-btn');
            if (cancelBtn) cancelBtn.classList.add('hidden');
            const title = document.getElementById('income-form-title');
            if (title) title.textContent = 'Adicionar Renda';
            const submit = document.getElementById('income-submit-btn');
            if (submit) submit.textContent = 'Adicionar Renda';
            editingIncomeId = null;
        }

        async function handleExpenseSubmit(event) {
            event.preventDefault();
            const description = document.getElementById('expense-desc').value.trim();
            const amount = getMoneyInputValue('expense-amount');
            const date = document.getElementById('expense-date').value;
            if (!description || !date || isNaN(amount) || amount <= 0) { alert('Preencha descrio, data e valor vlidos.'); return; }
            const category = document.getElementById('expense-category').value;
            const paidBy = document.getElementById('expense-paid-by').value;
            const typeSelect = document.getElementById('expense-sharing-type');
            const typeId = typeSelect.value;
            const typeConfig = appSettings.expenseTypes.find(t => t.id === typeId) || {};
            const splitSlider = document.getElementById('split-slider');
            const splitPercent = typeConfig.isShared ? Number(splitSlider.value) : null;
            const beneficiarySelect = document.getElementById('expense-beneficiary');
            const beneficiary = typeConfig.isThirdParty && beneficiarySelect ? beneficiarySelect.value : null;
            const recurrenceType = document.getElementById('expense-recurrence-type').value;
            const recurrenceMonthsInput = document.getElementById('expense-recurrence-months');
            const recurrenceMonths = recurrenceType === 'fixed' ? Number(recurrenceMonthsInput.value || 0) : null;
            const monthYear = getCurrentFilterMonthYear();
            const payload = {
                description,
                amount,
                date,
                category,
                paidBy,
                typeId,
                sharingType: typeConfig.label || typeId,
                splitPercent: splitPercent !== null ? splitPercent : null,
                beneficiary: beneficiary || null,
                recurrenceType,
                recurrenceMonths,
                monthYear,
                updatedAt: new Date()
            };
            if (!editingExpenseId) payload.createdAt = new Date();
            try {
                if (editingExpenseId) {
                    await updateDoc(doc(db, `${DB_BASE_PATH}/expenses/${editingExpenseId}`), payload);
                } else {
                    await addDoc(collection(db, `${DB_BASE_PATH}/expenses`), payload);
                }
                resetExpenseForm();
            } catch (error) {
                console.error('Erro ao salvar despesa', error);
                alert('No foi possvel salvar a despesa.');
            }
        }

        async function handleIncomeSubmit(event) {
            event.preventDefault();
            const description = document.getElementById('income-desc').value.trim();
            const amount = getMoneyInputValue('income-amount');
            const date = document.getElementById('income-date').value;
            if (!description || !date || isNaN(amount) || amount <= 0) { alert('Preencha descrio, data e valor vlidos.'); return; }
            const source = document.getElementById('income-source').value;
            const monthYear = getCurrentFilterMonthYear();
            const payload = {
                description,
                amount,
                date,
                source,
                monthYear,
                updatedAt: new Date()
            };
            if (!editingIncomeId) payload.createdAt = new Date();
            try {
                if (editingIncomeId) {
                    await updateDoc(doc(db, `${DB_BASE_PATH}/income/${editingIncomeId}`), payload);
                } else {
                    await addDoc(collection(db, `${DB_BASE_PATH}/income`), payload);
                }
                resetIncomeForm();
            } catch (error) {
                console.error('Erro ao salvar renda', error);
                alert('No foi possvel salvar a renda.');
            }
        }

        function startEditExpense(id) {
            const expense = currentExpenses.find(e => e.id === id);
            if (!expense) return;
            editingExpenseId = id;
            document.getElementById('expense-form-title').textContent = 'Editar Despesa';
            document.getElementById('expense-submit-btn').textContent = 'Salvar Alteraes';
            document.getElementById('expense-cancel-btn').classList.remove('hidden');
            document.getElementById('expense-desc').value = expense.description || '';
            setMoneyInputValue('expense-amount', expense.amount);
            document.getElementById('expense-date').value = expense.date;
            document.getElementById('expense-category').value = expense.category || 'Outros';
            document.getElementById('expense-paid-by').value = expense.paidBy || appSettings.people[0]?.name;
            const typeSelect = document.getElementById('expense-sharing-type');
            if (expense.typeId && Array.from(typeSelect.options).some(o => o.value === expense.typeId)) {
                typeSelect.value = expense.typeId;
            }
            handleTypeChange();
            if (expense.splitPercent !== undefined && expense.splitPercent !== null) {
                setSplitValue(expense.splitPercent);
            }
            if (expense.beneficiary && document.getElementById('expense-beneficiary')) {
                document.getElementById('expense-beneficiary').value = expense.beneficiary;
            }
            if (expense.recurrenceType) {
                document.getElementById('expense-recurrence-type').value = expense.recurrenceType;
                document.getElementById('expense-recurrence-months').value = expense.recurrenceMonths || '';
                toggleRecurrenceInput();
            }
            document.getElementById('expense-desc').focus();
        }

        function startEditIncome(id) {
            const income = currentIncomes.find(i => i.id === id);
            if (!income) return;
            editingIncomeId = id;
            document.getElementById('income-form-title').textContent = 'Editar Renda';
            document.getElementById('income-submit-btn').textContent = 'Salvar Alteraes';
            document.getElementById('income-cancel-btn').classList.remove('hidden');
            document.getElementById('income-desc').value = income.description || '';
            setMoneyInputValue('income-amount', income.amount);
            document.getElementById('income-date').value = income.date;
            document.getElementById('income-source').value = income.source || appSettings.people[0]?.name;
            document.getElementById('income-desc').focus();
        }

        function cancelEditExpense() { resetExpenseForm(); }
        function cancelEditIncome() { resetIncomeForm(); }

        async function deleteItem(id, type) {
            if (!confirm('Remover este registro?')) return;
            const collectionName = type === 'income' ? 'income' : 'expenses';
            try {
                await deleteDoc(doc(db, `${DB_BASE_PATH}/${collectionName}/${id}`));
                if (type === 'expense' && editingExpenseId === id) resetExpenseForm();
                if (type === 'income' && editingIncomeId === id) resetIncomeForm();
            } catch (error) {
                console.error('Erro ao excluir registro', error);
                alert('No foi possvel excluir o item.');
            }
        }

        // Funo stub para corrigir erro de referncia
        function initializeToggle() {
            // Inicializa toggles, se necessrio
            // Adicione lgica real se necessrio
        }

        // Funo stub para corrigir erro de referncia
        function updateCharts() {
            // Atualiza grfico de pizza de categorias
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            const categories = {};
            currentExpenses.forEach(e => { categories[e.category] = (categories[e.category] || 0) + e.amount; });
            const labels = Object.keys(categories);
            const data = Object.values(categories);
            if (window.expenseChartInstance) window.expenseChartInstance.destroy();
            window.expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#6B7280',
                            '#F472B6', '#FBBF24', '#34D399', '#60A5FA', '#A78BFA', '#F87171', '#FDE68A', '#6EE7B7', '#C7D2FE', '#F9A8D4', '#FCD34D', '#A7F3D0', '#F3F4F6', '#FCA5A5', '#D1FAE5', '#F3E8FF', '#FDE68A', '#FECACA', '#BBF7D0', '#FED7AA', '#FFF7ED'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }
                    }
                }
            });
        }
        // Esconde o formulrio de edio de despesa, se aplicvel
        const btn = document.getElementById('expense-cancel-btn');
        if (btn) btn.classList.add('hidden');
        editingExpenseId = null;


        // Funo stub para corrigir erro de referncia
        function initializeSelectors() {
            // Inicializa selects de ms e ano, datas dos formulrios e categorias completas
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            if (!monthSelect || !yearSelect) return;
            const now = new Date();
            monthSelect.innerHTML = '';
            MONTH_NAMES.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = (i + 1).toString().padStart(2, '0');
                opt.textContent = m;
                if (i === now.getMonth()) opt.selected = true;
                monthSelect.appendChild(opt);
            });
            yearSelect.innerHTML = '';
            for (let y = now.getFullYear() - 3; y <= now.getFullYear() + 2; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === now.getFullYear()) opt.selected = true;
                yearSelect.appendChild(opt);
            }
            // Restaurar lista completa de categorias
            const expenseCategory = document.getElementById('expense-category');
            if (expenseCategory) {
                expenseCategory.innerHTML = `
                    <option>Moradia</option>
                    <option>Contas (Luz, gua, Net)</option>
                    <option>Mercado</option>
                    <option>Alimentao (iFood, etc)</option>
                    <option>Transporte/Carro</option>
                    <option>Lazer</option>
                    <option>Sade</option>
                    <option>Presentes</option>
                    <option>Outros</option>
                    <option>Educao</option>
                    <option>Vesturio</option>
                    <option>Higiene Pessoal</option>
                    <option>Limpeza</option>
                    <option>Assinaturas/Streaming</option>
                    <option>Pet</option>
                    <option>Viagem</option>
                    <option>Eletrnicos</option>
                    <option>Casa/Decorao</option>
                    <option>Beleza/Esttica</option>
                    <option>Esportes/Academia</option>
                    <option>Impostos/Taxas</option>
                    <option>Seguros</option>
                    <option>Doaes</option>
                    <option>Manuteno Carro</option>
                    <option>Manuteno Casa</option>
                    <option>Trabalho</option>
                `;
            }
            const expenseDate = document.getElementById('expense-date');
            if (expenseDate) expenseDate.value = now.toISOString().split('T')[0];
            const incomeDate = document.getElementById('income-date');
            if (incomeDate) incomeDate.value = now.toISOString().split('T')[0];
            monthSelect.addEventListener('change', () => handlePeriodChange('primary'));
            yearSelect.addEventListener('change', () => handlePeriodChange('primary'));
            const stickyMonthSelect = document.getElementById('sticky-month-select');
            const stickyYearSelect = document.getElementById('sticky-year-select');
            if (stickyMonthSelect) {
                stickyMonthSelect.innerHTML = monthSelect.innerHTML;
                stickyMonthSelect.value = monthSelect.value;
                stickyMonthSelect.addEventListener('change', () => handlePeriodChange('sticky'));
            }
            if (stickyYearSelect) {
                stickyYearSelect.innerHTML = yearSelect.innerHTML;
                stickyYearSelect.value = yearSelect.value;
                stickyYearSelect.addEventListener('change', () => handlePeriodChange('sticky'));
            }
            if (typeof populateDynamicSelects === 'function') {
                populateDynamicSelects();
            }
            updateCompetencyTooltips();
            updateStickyPeriodBar();
            setupStickyObserver();
            initializeStickyPicker();
        }
        const formatCurrencyBRL = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        const getMonthYear = (dateString) => { const parts = dateString.split('-'); return parts.length >= 2 ? `${parts[1]}-${parts[0]}` : ''; };
        const MONEY_INPUT_SELECTOR = '[data-money-input="true"]';

        function initializeMoneyInputs() {
            document.querySelectorAll(MONEY_INPUT_SELECTOR).forEach(bindMoneyMask);
        }

        function bindMoneyMask(input) {
            if (!input || input.dataset.moneyMaskBound) return;
            input.dataset.moneyMaskBound = 'true';
            input.addEventListener('input', handleMoneyMaskInput);
            input.addEventListener('blur', handleMoneyMaskBlur);
        }

        function handleMoneyMaskInput(event) {
            const input = event.target;
            const digits = (input.value || '').replace(/\D/g, '');
            if (!digits) {
                input.dataset.moneyValue = '0.00';
                input.value = '';
                return;
            }
            const numeric = parseInt(digits, 10) / 100;
            input.dataset.moneyValue = numeric.toFixed(2);
            input.value = numeric.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function handleMoneyMaskBlur(event) {
            const input = event.target;
            if (!input.value) return;
            const digits = input.value.replace(/\D/g, '');
            if (!digits) {
                input.dataset.moneyValue = '0.00';
                input.value = '';
                return;
            }
            const numeric = parseInt(digits, 10) / 100;
            input.dataset.moneyValue = numeric.toFixed(2);
            input.value = numeric.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getMoneyInputValue(target) {
            const input = typeof target === 'string' ? document.getElementById(target) : target;
            if (!input) return 0;
            if (input.dataset.moneyValue) return parseFloat(input.dataset.moneyValue);
            const digits = (input.value || '').replace(/\D/g, '');
            const numeric = digits ? parseInt(digits, 10) / 100 : 0;
            input.dataset.moneyValue = numeric.toFixed(2);
            return numeric;
        }

        function setMoneyInputValue(target, amount) {
            const input = typeof target === 'string' ? document.getElementById(target) : target;
            if (!input) return;
            const numeric = Number(amount);
            if (!isFinite(numeric) || numeric <= 0) {
                input.dataset.moneyValue = '0.00';
                input.value = '';
                return;
            }
            input.dataset.moneyValue = numeric.toFixed(2);
            input.value = numeric.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function clearMoneyInput(target) {
            const input = typeof target === 'string' ? document.getElementById(target) : target;
            if (!input) return;
            input.dataset.moneyValue = '0.00';
            input.value = '';
        }

        function setSplitValue(val, options = {}) {
            let numeric = Number(val);
            if (!Number.isFinite(numeric)) numeric = 0;
            numeric = Math.min(100, Math.max(0, numeric));
            const rounded = Math.round(numeric);
            const slider = document.getElementById('split-slider');
            if (slider && !options.skipSliderUpdate) slider.value = rounded;
            const manual = document.getElementById('split-manual-input');
            if (manual && !options.skipManualUpdate) manual.value = rounded;
            document.querySelectorAll('#split-presets button[data-value]').forEach(btn => {
                btn.classList.toggle('active', Number(btn.dataset.value) === rounded);
            });
            updateSplitDisplay(rounded);
            return rounded;
        }

        function updateSplitDisplay(val) {
            const el = document.getElementById('split-display');
            if (!el) return;
            const payerSelect = document.getElementById('expense-paid-by');
            const payerLabel = payerSelect?.value || appSettings.people[0]?.name || 'Pagador';
            const partnerLabel = appSettings.people[1]?.name || 'Parceiro';
            el.textContent = `${val}% ${payerLabel} / ${100 - val}% ${partnerLabel}`;
        }

        function handleBeneficiaryChange() {
            // Function placeholder - logic handled in handleTypeChange currently
        }

        function handleTypeChange() {
            const s = document.getElementById('expense-sharing-type');
            if (!s || s.selectedIndex < 0) return;
            const opt = s.options[s.selectedIndex];
            const isShared = opt.dataset.isShared === 'true';
            const isThirdParty = opt.dataset.isThirdParty === 'true';

            const splitDiv = document.getElementById('split-container');
            const benDiv = document.getElementById('beneficiary-container');

            if (isShared) {
                splitDiv.classList.remove('hidden');
                benDiv.classList.add('hidden');
                if (!editingExpenseId) {
                    setSplitValue(opt.dataset.split);
                }
            } else if (isThirdParty) {
                splitDiv.classList.add('hidden');
                if (appSettings.people.length > 2) benDiv.classList.remove('hidden');
                else benDiv.classList.add('hidden');
            } else {
                splitDiv.classList.add('hidden');
                benDiv.classList.add('hidden');
            }
        }

        function toggleRecurrenceInput() {
            const type = document.getElementById('expense-recurrence-type').value;
            const container = document.getElementById('recurrence-months-input');
            if (type === 'fixed') container.classList.remove('hidden');
            else container.classList.add('hidden');
        }

        function applyPrivacyMode() {
            const isPriv = localStorage.getItem('privacyMode') === 'true';
            document.querySelectorAll('.money-display').forEach(el => isPriv ? el.classList.add('blur-sensitive') : el.classList.remove('blur-sensitive'));
            const btn = document.getElementById('privacy-toggle-btn');
            if (btn) btn.innerHTML = isPriv ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        }

        function applyIncomeVisibility(shouldShow) {
            const targets = ['card-income', 'card-balance', 'form-container-income', 'table-container-income'];
            targets.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('hidden', !shouldShow);
            });
        }

        function getPlanRules() {
            return PLAN_RULES[USER_PLAN] || PLAN_RULES.premium;
        }

        function planAllows(featureKey) {
            const rules = getPlanRules();
            return !!(rules.features && rules.features[featureKey]);
        }

        function getPlanLimit(target) {
            const rules = getPlanRules();
            return rules.limits && typeof rules.limits[target] !== 'undefined' ? rules.limits[target] : Infinity;
        }

        function isPlanAtLimit(target) {
            const limit = getPlanLimit(target);
            if (!Number.isFinite(limit)) return false;
            const currentCount = target === 'goals' ? currentGoals.length : currentBudgets.length;
            return currentCount >= limit;
        }

        function showPlanRestrictionToast(message) {
            const toast = document.getElementById('plan-restriction-toast');
            const text = document.getElementById('plan-restriction-toast-text');
            if (!toast || !text) { alert(message); return; }
            text.textContent = message;
            toast.classList.remove('hidden');
            if (planToastTimeout) clearTimeout(planToastTimeout);
            planToastTimeout = setTimeout(() => hidePlanRestrictionToast(), 6000);
        }

        function hidePlanRestrictionToast() {
            const toast = document.getElementById('plan-restriction-toast');
            if (!toast) return;
            toast.classList.add('hidden');
            if (planToastTimeout) clearTimeout(planToastTimeout);
        }

        function handlePlanLimitAttempt(target) {
            const message = PLAN_LIMIT_MESSAGES[target] || 'Recurso exclusivo do plano Premium.';
            showPlanRestrictionToast(message);
        }

        function syncPlanUI() {
            const rules = getPlanRules();
            if (document.body) document.body.dataset.planKey = rules.key;
            const badge = document.getElementById('plan-badge');
            if (badge) {
                badge.textContent = rules.badgeLabel;
                badge.classList.remove('hidden');
            }
            const banner = document.getElementById('plan-restrictions-banner');
            if (banner) {
                if (rules.key === 'premium') banner.classList.add('hidden');
                else {
                    banner.classList.remove('hidden');
                    const title = document.getElementById('plan-restrictions-title');
                    if (title) title.textContent = `Plano ${rules.label}`;
                    const list = document.getElementById('plan-restrictions-highlights');
                    if (list) list.innerHTML = (rules.summary || []).map(item => `<li><i class="fas fa-lock"></i>${item}</li>`).join('');
                }
            }
            syncPlanReportSections(rules.key);
            applyPremiumExtrasVisibility();
            updatePremiumPrintReport();
        }

        function updatePlanLimitMessages() {
            const rules = getPlanRules();
            const goalMsg = document.getElementById('plan-limit-message-goals');
            if (goalMsg) {
                const locked = rules.key !== 'premium' && isPlanAtLimit('goals');
                goalMsg.classList.toggle('hidden', !locked);
                if (locked) goalMsg.innerHTML = `<i class="fas fa-lock"></i> ${PLAN_LIMIT_MESSAGES.goals}`;
            }
            const budgetMsg = document.getElementById('plan-limit-message-budgets');
            if (budgetMsg) {
                const locked = rules.key !== 'premium' && isPlanAtLimit('budgets');
                budgetMsg.classList.toggle('hidden', !locked);
                if (locked) budgetMsg.innerHTML = `<i class="fas fa-lock"></i> ${PLAN_LIMIT_MESSAGES.budgets}`;
            }
        }

        function openPremiumModal() {
            showPlanRestrictionToast('Em breve voc poder concluir a assinatura diretamente por aqui.');
        }

        function applyPremiumExtrasVisibility() {
            const isPremiumPlan = getPlanRules().key === 'premium';
            const shouldShowExtras = isPremiumPlan && premiumExtrasEnabled;
            document.body.classList.toggle('premium-extras-enabled', shouldShowExtras);
            document.querySelectorAll('[data-premium-extra="true"]').forEach(section => {
                section.classList.toggle('hidden', !shouldShowExtras);
            });
            const toggleWrapper = document.getElementById('premium-extras-toggle');
            if (toggleWrapper) toggleWrapper.classList.toggle('hidden', !isPremiumPlan);
            const checkbox = document.getElementById('premium-extras-checkbox');
            if (checkbox) {
                checkbox.checked = shouldShowExtras;
                checkbox.setAttribute('aria-checked', shouldShowExtras ? 'true' : 'false');
            }
        }

        function initializePremiumExtrasToggle() {
            const checkbox = document.getElementById('premium-extras-checkbox');
            if (!checkbox || checkbox.dataset.bound === 'true') return;
            checkbox.dataset.bound = 'true';
            checkbox.addEventListener('change', (event) => {
                premiumExtrasEnabled = event.target.checked;
                localStorage.setItem(PREMIUM_EXTRAS_STORAGE_KEY, premiumExtrasEnabled ? 'true' : 'false');
                applyPremiumExtrasVisibility();
            });
            applyPremiumExtrasVisibility();
        }

        function syncPlanReportSections(planKey) {
            document.querySelectorAll('[data-plan-section]').forEach(section => {
                section.classList.toggle('hidden', section.dataset.planSection !== planKey);
            });
        }

        function destroyPremiumCharts() {
            Object.keys(premiumCharts).forEach(key => {
                if (premiumCharts[key]) {
                    premiumCharts[key].destroy();
                    premiumCharts[key] = null;
                }
            });
        }

        function getPreviousMonthYear(monthYear) {
            if (!monthYear || !monthYear.includes('-')) return '';
            const [monthStr, yearStr] = monthYear.split('-');
            let month = Number(monthStr);
            let year = Number(yearStr);
            if (!month || !year) return '';
            month -= 1;
            if (month <= 0) {
                month = 12;
                year -= 1;
            }
            return `${month.toString().padStart(2, '0')}-${year}`;
        }

        function formatMonthYearLabel(monthYear) {
            if (!monthYear) return '';
            const [monthStr, yearStr] = monthYear.split('-');
            const index = Number(monthStr) - 1;
            if (index < 0 || index >= MONTH_NAMES.length) return monthYear;
            return `${MONTH_NAMES[index]} de ${yearStr}`;
        }

        function calculateCategoryTotals(list) {
            const totals = {};
            list.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                const category = expense.category || 'Outros';
                totals[category] = (totals[category] || 0) + amount;
            });
            return totals;
        }

        function calculatePersonBreakdown() {
            if (!Array.isArray(appSettings.people) || !appSettings.people.length) return [];
            const peopleMap = {};
            appSettings.people.forEach(person => {
                if (!person?.name) return;
                peopleMap[person.name] = { name: person.name, paid: 0, consumed: 0 };
            });
            const names = Object.keys(peopleMap);
            if (!names.length) return [];
            currentExpenses.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                if (peopleMap[expense.paidBy]) peopleMap[expense.paidBy].paid += amount;
                const typeConfig = appSettings.expenseTypes.find(t => t.id === expense.typeId) || { isShared: false, isThirdParty: false };
                if (typeConfig.isShared) {
                    if (names.length === 2) {
                        const payer = expense.paidBy;
                        const partner = names.find(n => n !== payer) || payer;
                        const splitPercent = Math.min(100, Math.max(0, Number(expense.splitPercent ?? 50)));
                        const payerShare = amount * (splitPercent / 100);
                        const partnerShare = amount - payerShare;
                        if (peopleMap[payer]) peopleMap[payer].consumed += payerShare;
                        if (peopleMap[partner]) peopleMap[partner].consumed += partnerShare;
                    } else {
                        const share = amount / names.length;
                        names.forEach(name => { if (peopleMap[name]) peopleMap[name].consumed += share; });
                    }
                    return;
                }
                if (typeConfig.isThirdParty) {
                    const beneficiary = expense.beneficiary && peopleMap[expense.beneficiary] ? expense.beneficiary : expense.paidBy;
                    if (peopleMap[beneficiary]) peopleMap[beneficiary].consumed += amount;
                    return;
                }
                if (peopleMap[expense.paidBy]) peopleMap[expense.paidBy].consumed += amount;
            });
            return Object.values(peopleMap).map(entry => ({ ...entry, delta: entry.paid - entry.consumed })).sort((a, b) => b.consumed - a.consumed);
        }

        function calculateTypeBreakdown() {
            const totals = {};
            currentExpenses.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                const typeConfig = appSettings.expenseTypes.find(t => t.id === expense.typeId);
                const label = typeConfig ? typeConfig.label : (expense.sharingType || 'Sem tipo');
                totals[label] = (totals[label] || 0) + amount;
            });
            return Object.entries(totals).sort((a, b) => b[1] - a[1]);
        }

        function buildCategoryVariationData() {
            const currentTotals = calculateCategoryTotals(currentExpenses);
            const categories = new Set([...Object.keys(currentTotals), ...Object.keys(previousMonthCategoryTotals || {})]);
            const rows = Array.from(categories).map(category => {
                const currentValue = currentTotals[category] || 0;
                const previousValue = previousMonthCategoryTotals[category] || 0;
                const diff = currentValue - previousValue;
                const pctChange = previousValue > 0 ? (diff / previousValue) * 100 : (currentValue > 0 ? 100 : 0);
                return { category, currentValue, previousValue, diff, pctChange };
            }).filter(row => row.currentValue > 0 || row.previousValue > 0)
                .sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
            return { rows, currentTotals };
        }

        function generatePremiumSuggestions(categoryRows, personBreakdown) {
            const suggestions = [];
            if (budgetAlertItems.length) {
                const critical = budgetAlertItems[0];
                suggestions.push(`O limite de ${critical.category} est ${critical.statusLabel.toLowerCase()}. ${critical.description}`);
            } else if (currentBudgets.length) {
                suggestions.push('Todos os limites esto dentro do esperado. Continue registrando para manter o controle.');
            }

            const increaseInsight = Array.isArray(categoryRows) ? categoryRows.find(row => row.diff > 0 && row.currentValue > 0) : null;
            if (increaseInsight && suggestions.length < 3) {
                const pctLabel = increaseInsight.previousValue > 0 ? `${Math.abs(increaseInsight.pctChange).toFixed(1)}%` : '100%';
                suggestions.push(`Os gastos com ${increaseInsight.category} cresceram ${pctLabel} em relao a ${previousMonthLabel || 'o ms anterior'}. Reavalie assinaturas e compras dessa categoria.`);
            }

            if (currentGoals.length && suggestions.length < 3) {
                const rankedGoals = currentGoals.map(goal => {
                    const saved = Number(goal.currentAmount) || 0;
                    const target = Number(goal.targetAmount) || 0;
                    const pct = target > 0 ? Math.min((saved / target) * 100, 100) : 0;
                    return { goal, pct };
                }).sort((a, b) => a.pct - b.pct);
                if (rankedGoals.length) {
                    const weakest = rankedGoals[0];
                    const monthlyHint = weakest.goal.strategyValue || (historicalAverageSurplus > 0 ? Math.max(historicalAverageSurplus * 0.1, 100) : 200);
                    suggestions.push(`A meta ${weakest.goal.name} est em ${Math.round(weakest.pct)}%. Reserve ${formatCurrencyBRL(monthlyHint)} por ms para acelerar o progresso.`);
                }
            }

            if (Array.isArray(personBreakdown) && personBreakdown.length && suggestions.length < 3) {
                const totalConsumed = personBreakdown.reduce((sum, entry) => sum + entry.consumed, 0);
                if (totalConsumed > 0) {
                    const leader = personBreakdown[0];
                    const share = ((leader.consumed / totalConsumed) * 100).toFixed(1);
                    suggestions.push(`${leader.name} concentrou ${share}% dos gastos do ms. Reequilibrem os lanamentos ou ajustem os splits caso necessrio.`);
                }
            }

            if (!suggestions.length) {
                suggestions.push('Continue registrando despesas para manter o histrico completo e gerar recomendaes personalizadas.');
            }

            return suggestions.slice(0, 3);
        }

        function updatePremiumPrintReport() {
            const premiumSection = document.getElementById('premium-report-section');
            if (!premiumSection || getPlanRules().key !== 'premium') {
                destroyPremiumCharts();
                return;
            }

            const monthLabel = document.getElementById('premium-month-label');
            if (monthLabel) monthLabel.textContent = getCurrentFilterLabel();
            const comparisonLabel = document.getElementById('premium-comparison-label');
            if (comparisonLabel) comparisonLabel.textContent = previousMonthLabel ? `Comparado a ${previousMonthLabel}` : 'Sem histrico';

            const peopleList = document.getElementById('premium-people-list');
            if (peopleList) {
                if (!appSettings.people.length) {
                    peopleList.innerHTML = '<li class="premium-empty">Cadastre pessoas nas configuraes para acompanhar seus relatrios individuais.</li>';
                } else {
                    peopleList.innerHTML = appSettings.people.map(person => `<li>${person.name}</li>`).join('');
                }
            }

            const personBreakdown = calculatePersonBreakdown();
            const personBody = document.getElementById('person-breakdown-body');
            if (personBody) {
                if (!personBreakdown.length) {
                    personBody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500">Sem movimentaes para este perodo.</td></tr>';
                } else {
                    personBody.innerHTML = personBreakdown.map(entry => {
                        const deltaClass = entry.delta >= 0 ? 'text-green-600' : 'text-red-600';
                        const deltaLabel = entry.delta === 0 ? 'equilbrio' : (entry.delta > 0 ? 'a receber' : 'a pagar');
                        return `<tr>
                            <td class="px-3 py-2 font-semibold text-gray-800">${entry.name}</td>
                            <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(entry.paid)}</td>
                            <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(entry.consumed)}</td>
                            <td class="px-3 py-2 text-right font-semibold ${deltaClass}"><span class="money-display">${formatCurrencyBRL(Math.abs(entry.delta))}</span><span class="block text-[11px] uppercase tracking-wide text-gray-400">${deltaLabel}</span></td>
                        </tr>`;
                    }).join('');
                }
            }

            const personChartEl = document.getElementById('person-spending-chart');
            if (personChartEl) {
                if (premiumCharts.person) premiumCharts.person.destroy();
                const chartData = personBreakdown.filter(item => item.consumed > 0);
                if (chartData.length) {
                    premiumCharts.person = new Chart(personChartEl, {
                        type: 'bar',
                        data: {
                            labels: chartData.map(item => item.name),
                            datasets: [{
                                label: 'Participao nas despesas',
                                data: chartData.map(item => Number(item.consumed.toFixed(2))),
                                backgroundColor: ['#4f46e5', '#6366f1', '#a5b4fc', '#f472b6', '#34d399', '#facc15']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                } else {
                    premiumCharts.person = null;
                    personChartEl.getContext('2d').clearRect(0, 0, personChartEl.width, personChartEl.height);
                }
            }

            const typeBreakdown = calculateTypeBreakdown();
            const typeBody = document.getElementById('type-breakdown-body');
            if (typeBody) {
                if (!typeBreakdown.length) {
                    typeBody.innerHTML = '<tr><td colspan="2" class="px-3 py-4 text-center text-sm text-gray-500">Sem dados de tipos personalizados.</td></tr>';
                } else {
                    typeBody.innerHTML = typeBreakdown.slice(0, 6).map(([label, total]) => `
                        <tr>
                            <td class="px-3 py-2 text-gray-800">${label}</td>
                            <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(total)}</td>
                        </tr>
                    `).join('');
                }
            }

            const typeChartEl = document.getElementById('type-breakdown-chart');
            if (typeChartEl) {
                if (premiumCharts.type) premiumCharts.type.destroy();
                const chartData = typeBreakdown.slice(0, 6);
                if (chartData.length) {
                    premiumCharts.type = new Chart(typeChartEl, {
                        type: 'doughnut',
                        data: {
                            labels: chartData.map(item => item[0]),
                            datasets: [{
                                data: chartData.map(item => Number(item[1].toFixed(2))),
                                backgroundColor: ['#4f46e5', '#22d3ee', '#fb7185', '#34d399', '#facc15', '#f97316']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                } else {
                    premiumCharts.type = null;
                    typeChartEl.getContext('2d').clearRect(0, 0, typeChartEl.width, typeChartEl.height);
                }
            }

            const { rows: categoryRows } = buildCategoryVariationData();
            const variationList = document.getElementById('category-variation-list');
            if (variationList) {
                if (!categoryRows.length) {
                    variationList.innerHTML = '<li class="premium-empty">Ainda no h histrico suficiente para comparar categorias.</li>';
                } else {
                    variationList.innerHTML = categoryRows.slice(0, 5).map(row => {
                        const directionUp = row.diff >= 0;
                        const arrowIcon = directionUp ? '<i class="fas fa-arrow-trend-up text-red-500"></i>' : '<i class="fas fa-arrow-trend-down text-green-600"></i>';
                        const pctLabel = row.previousValue > 0 ? `${directionUp ? '+' : '-'}${Math.abs(row.pctChange).toFixed(1)}%` : 'novo';
                        const pctWidth = Math.min(Math.abs(row.pctChange) || 0, 100);
                        return `<li class="premium-variation-item">
                            <div class="flex items-center justify-between">
                                <strong>${row.category}</strong>
                                <span class="money-display text-sm font-semibold text-gray-800">${formatCurrencyBRL(row.currentValue)}</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                                <span>${arrowIcon} ${directionUp ? 'Aumento' : 'Reduo'}</span>
                                <span>${pctLabel}</span>
                            </div>
                            <div class="variation-bar">
                                <div class="variation-bar-fill ${directionUp ? 'up' : 'down'}" style="width:${pctWidth}%"></div>
                            </div>
                        </li>`;
                    }).join('');
                }
            }

            const budgetSummary = document.getElementById('premium-budget-summary');
            if (budgetSummary) {
                if (!currentBudgets.length) {
                    budgetSummary.innerHTML = '<p class="premium-empty">Nenhum limite ativo neste perodo.</p>';
                } else {
                    const spendingMap = {};
                    currentExpenses.forEach(expense => {
                        const key = (expense.category || '').toLowerCase();
                        spendingMap[key] = (spendingMap[key] || 0) + (Number(expense.amount) || 0);
                    });
                    budgetSummary.innerHTML = currentBudgets.map(budget => {
                        const categoryLabel = budget.category || 'Sem categoria';
                        const categoryKey = categoryLabel.toLowerCase();
                        const spent = spendingMap[categoryKey] || 0;
                        const limit = Number(budget.limitAmount) || 0;
                        const pct = limit > 0 ? (spent / limit) * 100 : 0;
                        let statusClass = 'text-green-600';
                        let statusLabel = 'Em dia';
                        if (pct >= 95) { statusClass = 'text-red-600'; statusLabel = 'Crtico'; }
                        else if (pct >= 75) { statusClass = 'text-yellow-600'; statusLabel = 'Ateno'; }
                        return `<div class="flex items-center justify-between border border-gray-100 rounded-lg p-3">
                            <div>
                                <p class="font-semibold text-gray-800">${categoryLabel}</p>
                                <p class="text-xs text-gray-500"><span class="money-display">${formatCurrencyBRL(spent)}</span> de <span class="money-display">${formatCurrencyBRL(limit)}</span></p>
                            </div>
                            <span class="text-xs font-semibold ${statusClass}">${statusLabel}</span>
                        </div>`;
                    }).join('');
                }
            }

            const suggestions = generatePremiumSuggestions(categoryRows, personBreakdown);
            const suggestionsList = document.getElementById('premium-suggestions-list');
            if (suggestionsList) {
                suggestionsList.innerHTML = suggestions.map(text => `<li>${text}</li>`).join('');
            }

            applyPrivacyMode();
        }

        async function loadPreviousMonthStats(monthYear) {
            if (!db) return;
            const previousMonthYear = getPreviousMonthYear(monthYear);
            previousMonthLabel = previousMonthYear ? formatMonthYearLabel(previousMonthYear) : '';
            if (!previousMonthYear) {
                previousMonthCategoryTotals = {};
                updatePremiumPrintReport();
                return;
            }
            try {
                const comparisonQuery = query(collection(db, `${DB_BASE_PATH}/expenses`), where('monthYear', '==', previousMonthYear));
                const snapshot = await getDocs(comparisonQuery);
                const totals = {};
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const amount = Number(data.amount) || 0;
                    if (amount <= 0) return;
                    const category = data.category || 'Outros';
                    totals[category] = (totals[category] || 0) + amount;
                });
                previousMonthCategoryTotals = totals;
            } catch (error) {
                console.error('Erro ao carregar histrico para o relatrio premium', error);
                previousMonthCategoryTotals = {};
            }
            updatePremiumPrintReport();
        }

        function applyTheme(theme) {
            const normalized = theme === 'dark' ? 'dark' : 'light';
            currentTheme = normalized;
            document.body.classList.toggle('theme-dark', normalized === 'dark');
            document.querySelectorAll('[data-theme-icon]').forEach(icon => {
                icon.className = normalized === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            });
            document.querySelectorAll('[data-theme-label]').forEach(label => {
                label.textContent = normalized === 'dark' ? 'Modo claro' : 'Modo escuro';
            });
            document.querySelectorAll('[data-theme-toggle]').forEach(btn => {
                btn.setAttribute('aria-pressed', normalized === 'dark' ? 'true' : 'false');
            });
        }

        function initializeThemeToggle() {
            if (themeToggleInitialized) {
                applyTheme(currentTheme);
                return;
            }
            const buttons = document.querySelectorAll('[data-theme-toggle]');
            if (!buttons.length) return;
            themeToggleInitialized = true;
            applyTheme(currentTheme);
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    localStorage.setItem(THEME_STORAGE_KEY, nextTheme);
                    applyTheme(nextTheme);
                });
            });
        }

        function openBudgetAlertsModal() {
            if (!planAllows('budgetAlerts')) { showPlanRestrictionToast('Alertas inteligentes so exclusivos do plano Premium.'); return; }
            if (!budgetAlertItems.length) { alert('Sem alertas crticos no momento.'); return; }
            const list = document.getElementById('budget-alerts-list');
            if (list) {
                list.innerHTML = budgetAlertItems.map(item => {
                    const remainder = item.remaining;
                    const remainderLabel = remainder >= 0 ? `${formatCurrencyBRL(remainder)} disponvel` : `Excedente de ${formatCurrencyBRL(Math.abs(remainder))}`;
                    const remainderClass = remainder >= 0 ? 'ok' : 'over';
                    return `<div class="budget-alert-card status-${item.statusKey}">
                        <div class="flex justify-between items-center mb-3">
                            <span class="alert-badge">${item.statusLabel}</span>
                            <span class="text-xs text-gray-500">${item.pct}% do limite</span>
                        </div>
                        <h3>${item.category}</h3>
                        <p class="text-sm font-medium text-gray-700">${item.headline}</p>
                        <p class="text-sm text-gray-500 mb-2">${item.description}</p>
                        <p class="text-sm">Gasto <span class="money-display">${formatCurrencyBRL(item.spent)}</span> de <span class="money-display">${formatCurrencyBRL(item.limit)}</span></p>
                        <p class="alert-remainder ${remainderClass}">${remainderLabel}</p>
                    </div>`;
                }).join('');
                applyPrivacyMode();
            }
            const modal = document.getElementById('modal-budget-alerts');
            if (!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeBudgetAlertsModal() {
            const modal = document.getElementById('modal-budget-alerts');
            if (!modal) return;
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        function initializeGoalSuggestions() {
            if (goalSuggestionInitialized) return;
            const select = document.getElementById('goal-suggestion-select');
            const description = document.getElementById('goal-suggestion-description');
            const applyBtn = document.getElementById('goal-suggestion-apply');
            if (!select || !description || !applyBtn) return;

            const defaultMessage = description.textContent;
            select.innerHTML = ['<option value="" selected>Selecione uma inspirao</option>', ...GOAL_SUGGESTIONS.map(s => `<option value="${s.id}">${s.label}</option>`)].join('');

            const refreshDescription = () => {
                const suggestion = GOAL_SUGGESTIONS.find(s => s.id === select.value);
                description.textContent = suggestion ? suggestion.description : defaultMessage;
                applyBtn.disabled = !suggestion;
                applyBtn.classList.toggle('opacity-50', !suggestion);
                applyBtn.classList.toggle('cursor-not-allowed', !suggestion);
            };

            applyBtn.addEventListener('click', () => {
                const suggestion = GOAL_SUGGESTIONS.find(s => s.id === select.value);
                if (!suggestion) return;
                openGoalModal();
                document.getElementById('goal-name').value = suggestion.name;
                setMoneyInputValue('goal-target', suggestion.targetAmount);
                document.getElementById('goal-strategy').value = suggestion.strategy;
                handleGoalStrategyChange();
                const valueInput = document.getElementById('goal-strategy-value');
                if (suggestion.strategy !== 'manual') valueInput.value = suggestion.strategyValue || '';
                else valueInput.value = '';
                document.getElementById('goal-name').focus();
            });

            select.addEventListener('change', refreshDescription);
            refreshDescription();
            goalSuggestionInitialized = true;
        }

        function getGoalStrategyDisplay(goal) {
            const value = Number(goal.strategyValue) || 0;
            if (goal.strategy === 'fixed' && value > 0) return { label: 'Aporte mensal', detail: `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, icon: 'fa-repeat' };
            if (goal.strategy === 'percentage' && value > 0) return { label: 'Percentual', detail: `${value}% da renda`, icon: 'fa-percent' };
            return { label: 'Manual', detail: 'Aportes sob demanda', icon: 'fa-pen' };
        }

        function describeGoalStrategy(goal) {
            const value = Number(goal.strategyValue) || 0;
            if (goal.strategy === 'fixed' && value > 0) return `Guardando ${formatCurrencyBRL(value)} todo ms.`;
            if (goal.strategy === 'percentage' && value > 0) return `Reservando ${value}% do excedente mensal.`;
            return 'Lanando aportes conforme disponibilidade.';
        }

        function getGoalProjection(goal) {
            const current = Number(goal.currentAmount) || 0;
            const target = Number(goal.targetAmount) || 0;
            const remaining = Math.max(target - current, 0);
            if (remaining <= 0) return 'Meta concluda';
            const value = Number(goal.strategyValue) || 0;
            if (goal.strategy === 'fixed' && value > 0) {
                const months = Math.max(1, Math.ceil(remaining / value));
                return `${months} ${months === 1 ? 'ms' : 'meses'} restantes`;
            }
            return 'Defina um aporte fixo para prever o fim';
        }

        function buildGoalCard(goal, index) {
            const theme = GOAL_CARD_THEMES[index % GOAL_CARD_THEMES.length];
            const current = Number(goal.currentAmount) || 0;
            const target = Number(goal.targetAmount) || 0;
            const pctRaw = target > 0 ? (current / target) * 100 : 0;
            const pct = Math.min(Math.max(pctRaw, 0), 100);
            const goalName = goal.name || 'Meta sem nome';
            const { icon, label } = getGoalStrategyDisplay(goal);
            const historyCount = Array.isArray(goal.history) ? goal.history.length : 0;
            const lastEntry = historyCount ? goal.history[historyCount - 1] : null;
            const lastContribution = lastEntry && lastEntry.date ? new Date(lastEntry.date).toLocaleDateString('pt-BR') : 'Sem aportes';
            const statusLabel = pct >= 100 ? 'Concluda' : (pct >= 70 ? 'No ritmo' : 'Em construo');
            const statusIcon = pct >= 100 ? 'fa-trophy' : (pct >= 40 ? 'fa-bullseye' : 'fa-seedling');
            return `
                <article class="goal-card" style="background:${theme.background};color:${theme.textColor};border-color:${theme.border};box-shadow:${theme.shadow}">
                    <div class="flex justify-between gap-3">
                        <div>
                            <span class="goal-chip" style="background:${theme.chipBg};color:${theme.chipText};">
                                <i class="fas ${icon}"></i> ${label}
                            </span>
                            <h3 class="text-xl font-semibold mt-3 leading-snug">${goalName}</h3>
                            <p class="text-sm opacity-80">${describeGoalStrategy(goal)}</p>
                        </div>
                        <div class="goal-card-actions flex flex-col gap-2">
                            <button onclick="window.editGoal('${goal.id}')" title="Editar meta"><i class="fas fa-pen"></i></button>
                            <button onclick="window.deleteGoal('${goal.id}')" title="Excluir meta"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="goal-progress-track mt-4">
                        <div class="goal-progress-fill" style="width:${pct}%;background:${theme.accent};"></div>
                    </div>
                    <div class="flex justify-between text-xs font-semibold uppercase tracking-wide opacity-80 mt-2">
                        <span class="money-display">${formatCurrencyBRL(current)}</span>
                        <span>${isFinite(pct) ? pct.toFixed(0) : 0}%</span>
                        <span class="money-display">${formatCurrencyBRL(target)}</span>
                    </div>
                    <div class="flex flex-wrap gap-3 text-xs mt-4 opacity-90">
                        <span class="flex items-center gap-1"><i class="fas ${statusIcon} text-[0.7rem]"></i>${statusLabel}</span>
                        <span class="flex items-center gap-1"><i class="fas fa-clock text-[0.7rem]"></i>${getGoalProjection(goal)}</span>
                        <span class="flex items-center gap-1"><i class="fas fa-calendar-day text-[0.7rem]"></i>${lastContribution}</span>
                        <span class="flex items-center gap-1"><i class="fas fa-donate text-[0.7rem]"></i>${historyCount} aporte${historyCount === 1 ? '' : 's'}</span>
                    </div>
                    <button onclick="window.openGoalContribModal('${goal.id}')" class="mt-5 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/85 text-sm font-semibold text-slate-900 shadow-sm hover:-translate-y-0.5 transition">
                        <i class="fas fa-plus text-xs"></i> Registrar aporte
                    </button>
                </article>`;
        }

        function updateGoalHeroStats() {
            const savedEl = document.getElementById('goal-total-saved');
            const targetEl = document.getElementById('goal-total-target');
            const progressEl = document.getElementById('goal-total-progress');
            if (!savedEl || !targetEl || !progressEl) return;
            let totalSaved = 0;
            let totalTarget = 0;
            let progressAccumulator = 0;
            currentGoals.forEach(goal => {
                const saved = Number(goal.currentAmount) || 0;
                const target = Number(goal.targetAmount) || 0;
                totalSaved += saved;
                totalTarget += target;
                if (target > 0) progressAccumulator += Math.min((saved / target) * 100, 100);
            });
            savedEl.textContent = formatCurrencyBRL(totalSaved);
            targetEl.textContent = formatCurrencyBRL(totalTarget);
            const progress = currentGoals.length ? Math.round(progressAccumulator / currentGoals.length) : 0;
            progressEl.textContent = `${isNaN(progress) ? 0 : progress}%`;
            applyPrivacyMode();
        }

        function initializeIncomeVisibilityToggle() {
            const checkbox = document.getElementById('toggle-income-checkbox');
            if (!checkbox) return;
            const saved = localStorage.getItem('showIncomeSections');
            const shouldShow = saved === null ? true : saved === 'true';
            checkbox.checked = shouldShow;
            applyIncomeVisibility(shouldShow);
            checkbox.addEventListener('change', () => {
                const show = checkbox.checked;
                localStorage.setItem('showIncomeSections', show);
                applyIncomeVisibility(show);
            });
        }

        function attachFormHandlers() {
            const expenseForm = document.getElementById('expense-form');
            if (expenseForm && !expenseForm.dataset.bound) {
                expenseForm.addEventListener('submit', handleExpenseSubmit);
                expenseForm.dataset.bound = 'true';
            }
            const incomeForm = document.getElementById('income-form');
            if (incomeForm && !incomeForm.dataset.bound) {
                incomeForm.addEventListener('submit', handleIncomeSubmit);
                incomeForm.dataset.bound = 'true';
            }
            const goalForm = document.getElementById('goal-form');
            if (goalForm && !goalForm.dataset.bound) {
                goalForm.addEventListener('submit', handleGoalSubmit);
                goalForm.dataset.bound = 'true';
            }
            const goalStrategy = document.getElementById('goal-strategy');
            if (goalStrategy && !goalStrategy.dataset.bound) {
                goalStrategy.addEventListener('change', handleGoalStrategyChange);
                goalStrategy.dataset.bound = 'true';
            }
            const budgetForm = document.getElementById('budget-form');
            if (budgetForm && !budgetForm.dataset.bound) {
                budgetForm.addEventListener('submit', handleBudgetSubmit);
                budgetForm.dataset.bound = 'true';
            }
            handleGoalStrategyChange();
        }

        function populateDynamicSelects() {
            const paidSelect = document.getElementById('expense-paid-by');
            const sourceSelect = document.getElementById('income-source');
            const benSelect = document.getElementById('expense-beneficiary');

            if (paidSelect) {
                const currentVal = paidSelect.value;
                paidSelect.innerHTML = '';
                appSettings.people.forEach(p => paidSelect.add(new Option(p.name, p.name)));
                if (currentVal && Array.from(paidSelect.options).some(o => o.value === currentVal)) paidSelect.value = currentVal;
            }
            if (sourceSelect) {
                const currentVal = sourceSelect.value;
                sourceSelect.innerHTML = '';
                appSettings.people.forEach(p => sourceSelect.add(new Option(p.name, p.name)));
                sourceSelect.add(new Option('Outros', 'Outros'));
                if (currentVal && Array.from(sourceSelect.options).some(o => o.value === currentVal)) sourceSelect.value = currentVal;
            }
            if (benSelect) {
                benSelect.innerHTML = '';
                appSettings.people.forEach(p => benSelect.add(new Option(p.name, p.name)));
            }
            const typeSelect = document.getElementById('expense-sharing-type');
            if (typeSelect) {
                const currentVal = typeSelect.value;
                typeSelect.innerHTML = '';
                appSettings.expenseTypes.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.text = t.label;
                    opt.dataset.isShared = t.isShared;
                    opt.dataset.isThirdParty = t.isThirdParty;
                    opt.dataset.split = t.defaultSplit || 50;
                    typeSelect.add(opt);
                });
                if (currentVal && Array.from(typeSelect.options).some(o => o.value === currentVal)) typeSelect.value = currentVal;
                handleTypeChange();
            }
        }

        async function loadSettings() {
            try {
                const docRef = doc(db, DB_BASE_PATH, 'config', 'settings');
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.people) appSettings.people = d.people;
                    if (d.expenseTypes) appSettings.expenseTypes = d.expenseTypes;
                } else { await setDoc(docRef, appSettings); }
                populateDynamicSelects();
            } catch (e) { console.error(e); }
        }

        async function saveSettings() {
            try {
                const docRef = doc(db, DB_BASE_PATH, 'config', 'settings');
                await setDoc(docRef, appSettings, { merge: true });
                populateDynamicSelects();
                updateSettingsUI();
            } catch (e) { console.error('Erro ao salvar configuraes', e); }
        }

        function renderTables() {
            const expBody = document.getElementById('expense-table-body');
            expBody.innerHTML = currentExpenses.map(item => {
                let typeConfig = appSettings.expenseTypes.find(t => t.id === item.typeId);
                if (!typeConfig) typeConfig = appSettings.expenseTypes.find(t => t.id === item.sharingType) || { label: item.sharingType, color: '#ffffff' };
                return `
                <tr style="background-color: ${typeConfig.color}" class="hover:opacity-90 transition border-b border-gray-100">
                    <td class="px-4 py-3 text-sm text-gray-900">${item.description}</td>
                    <td class="px-4 py-3 text-sm font-medium text-red-600 money-display">${formatCurrencyBRL(item.amount)}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${new Date(item.date + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.category}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${typeConfig.label}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.paidBy}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium no-print">
                        <button onclick="window.startEditExpense('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteItem('${item.id}', 'expense')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                `;
            }).join('');

            const incBody = document.getElementById('income-table-body');
            incBody.innerHTML = currentIncomes.map(item => `
                <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                    <td class="px-4 py-3 text-sm text-gray-900">${item.description}</td>
                    <td class="px-4 py-3 text-sm font-medium text-green-600 money-display">${formatCurrencyBRL(item.amount)}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${new Date(item.date + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.source}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium no-print">
                        <button onclick="window.startEditIncome('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteItem('${item.id}', 'income')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </td></tr>
            `).join('');

            const categories = {};
            let total = 0;
            let highestExpense = 0;
            currentExpenses.forEach(e => {
                categories[e.category] = (categories[e.category] || 0) + e.amount;
                total += e.amount;
                if (e.amount > highestExpense) highestExpense = e.amount;
            });
            document.getElementById('category-stats-body').innerHTML = Object.entries(categories).sort((a, b) => b[1] - a[1]).map(([cat, val]) => `
                <tr><td class="px-3 py-2 text-xs text-gray-700">${cat}</td><td class="px-3 py-2 text-right text-xs font-medium text-gray-900 money-display">${formatCurrencyBRL(val)}</td><td class="px-3 py-2 text-right text-xs text-gray-500">${total > 0 ? ((val / total) * 100).toFixed(1) : 0}%</td></tr>`).join('');

            const expenseTotalEl = document.getElementById('expense-insight-total');
            if (expenseTotalEl) expenseTotalEl.textContent = formatCurrencyBRL(total);
            const expenseCountEl = document.getElementById('expense-insight-count');
            if (expenseCountEl) expenseCountEl.textContent = currentExpenses.length;
            const expenseTopEl = document.getElementById('expense-insight-top');
            if (expenseTopEl) expenseTopEl.textContent = currentExpenses.length ? formatCurrencyBRL(highestExpense) : 'R$ 0,00';

            const emptyState = document.getElementById('expense-empty-state');
            const tableContainer = document.getElementById('expense-table-container');
            if (emptyState && tableContainer) {
                if (currentExpenses.length === 0) {
                    emptyState.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                }
            }

            applyPrivacyMode();
        }

        function updateSummary() {
            const inc = currentIncomes.reduce((s, i) => s + i.amount, 0);
            const exp = currentExpenses.reduce((s, i) => s + i.amount, 0);
            document.getElementById('total-income').textContent = formatCurrencyBRL(inc);
            document.getElementById('total-expense').textContent = formatCurrencyBRL(exp);

            const bal = inc - exp;
            const balEl = document.getElementById('total-balance');
            balEl.textContent = formatCurrencyBRL(bal);
            balEl.className = `money-display text-3xl font-semibold mt-2 ${bal >= 0 ? 'text-green-600' : 'text-red-600'}`;

            const dynamicContainer = document.getElementById('dynamic-cards-container');
            dynamicContainer.innerHTML = '';

            const typeTotals = {};
            currentExpenses.forEach(e => {
                let tid = e.typeId;
                if (!tid) {
                    const match = appSettings.expenseTypes.find(t => t.label === e.sharingType);
                    if (match) tid = match.id;
                }
                if (tid) typeTotals[tid] = (typeTotals[tid] || 0) + e.amount;
            });

            appSettings.expenseTypes.forEach(t => {
                const total = typeTotals[t.id] || 0;
                if (total > 0 && !['t1', 't2'].includes(t.id)) {
                    dynamicContainer.innerHTML += `<div class="print-card p-6 rounded-lg shadow-md border border-gray-200" style="background-color: ${t.color}">
                            <h2 class="text-sm font-medium text-gray-700">${t.label}</h2>
                            <p class="money-display text-3xl font-semibold text-gray-900 mt-2">${formatCurrencyBRL(total)}</p>
                        </div>`;
                }
            });

            // SETTLEMENT
            const content = document.getElementById('settlement-content');
            content.innerHTML = '';

            if (appSettings.people.length === 2) {
                const p1 = appSettings.people[0].name;
                const p2 = appSettings.people[1].name;
                let p1_for_p2 = 0, p2_for_p1 = 0;

                currentExpenses.forEach(e => {
                    const amount = e.amount;
                    const payer = e.paidBy;
                    let typeConfig = appSettings.expenseTypes.find(t => t.id === e.typeId) || { isShared: false, isThirdParty: false };

                    if (typeConfig.isShared) {
                        const split = (e.splitPercent !== undefined) ? e.splitPercent : 50;
                        if (payer === p1) p1_for_p2 += amount * ((100 - split) / 100);
                        else if (payer === p2) p2_for_p1 += amount * (split / 100);
                    } else if (typeConfig.isThirdParty) {
                        if (payer === p1) { if (!e.beneficiary || e.beneficiary === p2) p1_for_p2 += amount; }
                        else if (payer === p2) { if (!e.beneficiary || e.beneficiary === p1) p2_for_p1 += amount; }
                    }
                });

                const net = p1_for_p2 - p2_for_p1;
                let transferText = "";
                let transferClass = "transfer-text";

                if (Math.abs(net) < 0.01) transferText = `Contas zeradas <span class="font-bold block">(R$ 0,00)</span>`;
                else if (net > 0) {
                    transferText = `${p2} deve a ${p1}: <span class="font-bold block">${formatCurrencyBRL(net)}</span>`;
                    transferClass = "transfer-text transfer-text-positive";
                } else {
                    transferText = `${p1} deve a ${p2}: <span class="font-bold block">${formatCurrencyBRL(Math.abs(net))}</span>`;
                    transferClass = "transfer-text transfer-text-negative";
                }

                content.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-600">${p1} pagou por ${p2}</h3><p class="money-display text-2xl font-semibold text-gray-900 mt-1">${formatCurrencyBRL(p1_for_p2)}</p></div>
                    <div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-600">${p2} pagou por ${p1}</h3><p class="money-display text-2xl font-semibold text-gray-900 mt-1">${formatCurrencyBRL(p2_for_p1)}</p></div>
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 md:col-span-1"><h3 class="text-sm font-medium text-indigo-700">Transferncia Necessria</h3><p class="money-display text-xl md:text-2xl font-semibold mt-1 ${transferClass}">${transferText}</p></div>`;
            } else {
                const balances = {};
                appSettings.people.forEach(p => balances[p.name] = { paid: 0, consumed: 0 });
                currentExpenses.forEach(e => {
                    const payer = e.paidBy;
                    if (balances[payer]) balances[payer].paid += e.amount;
                    let typeConfig = appSettings.expenseTypes.find(t => t.id === e.typeId) || { isShared: false };
                    if (typeConfig.isShared) {
                        const share = e.amount / appSettings.people.length;
                        appSettings.people.forEach(p => balances[p.name].consumed += share);
                    } else if (typeConfig.isThirdParty && e.beneficiary && balances[e.beneficiary]) {
                        balances[e.beneficiary].consumed += e.amount;
                    } else {
                        balances[payer].consumed += e.amount;
                    }
                });
                let html = '<div class="col-span-3 grid grid-cols-1 gap-2">';
                appSettings.people.forEach(p => {
                    const net = balances[p.name].paid - balances[p.name].consumed;
                    if (Math.abs(net) > 0.01) {
                        const color = net >= 0 ? 'text-green-600' : 'text-red-600';
                        const label = net >= 0 ? 'a receber' : 'a pagar';
                        html += `<div class="flex justify-between border-b py-2"><span>${p.name}</span><span class="${color} font-bold">${formatCurrencyBRL(Math.abs(net))} (${label})</span></div>`;
                    }
                });
                html += '</div>';
                content.innerHTML = html;
            }
            applyPrivacyMode();
            updatePremiumPrintReport();
        }

        function loadDataForMonth() {
            const m = document.getElementById('month-select').value;
            const y = document.getElementById('year-select').value;
            const monthYear = `${m}-${y}`;
            loadPreviousMonthStats(monthYear);

            const qExp = query(collection(db, `${DB_BASE_PATH}/expenses`), where("monthYear", "==", monthYear));
            unsubscribeExpenses();
            unsubscribeExpenses = onSnapshot(qExp, (snap) => {
                currentExpenses = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                renderTables();
                updateSummary();
                updateCharts();
                updateBudgetProgress();
                completePeriodTransition();
            });

            const qInc = query(collection(db, `${DB_BASE_PATH}/income`), where("monthYear", "==", monthYear));
            unsubscribeIncome();
            unsubscribeIncome = onSnapshot(qInc, (snap) => {
                currentIncomes = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                renderTables();
                updateSummary();
                completePeriodTransition();
            });
        }

        async function calculateHistoricalStats() {
            try {
                const qInc = query(collection(db, `${DB_BASE_PATH}/income`), orderBy('date', 'desc'), limit(50));
                const qExp = query(collection(db, `${DB_BASE_PATH}/expenses`), orderBy('date', 'desc'), limit(100));
                const [incSnap, expSnap] = await Promise.all([getDocs(qInc), getDocs(qExp)]);
                const monthlyData = {};
                incSnap.forEach(d => { const m = d.data().monthYear; if (!monthlyData[m]) monthlyData[m] = { inc: 0, exp: 0 }; monthlyData[m].inc += d.data().amount; });
                expSnap.forEach(d => { const m = d.data().monthYear; if (!monthlyData[m]) monthlyData[m] = { inc: 0, exp: 0 }; monthlyData[m].exp += d.data().amount; });
                let totalSurplus = 0, monthsCount = 0;
                Object.values(monthlyData).forEach(v => { totalSurplus += (v.inc - v.exp); monthsCount++; });
                if (monthsCount > 0) historicalAverageSurplus = totalSurplus / monthsCount;
                renderGoals();
            } catch (e) { console.error(e); }
        }

        // GOALS FUNCTIONS
        function loadGoals() {
            unsubscribeGoals();
            unsubscribeGoals = onSnapshot(collection(db, `${DB_BASE_PATH}/goals`), (snap) => {
                currentGoals = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGoals();
            });
        }

        function openSettingsModal() {
            const modal = document.getElementById('modal-settings');
            if (!modal) return;
            updateSettingsUI();
            initColorPicker();
            modal.classList.remove('hidden');
            document.body.classList.add('modal-active');
            requestAnimationFrame(() => modal.classList.add('active'));
        }
        function renderGoals() {
            const container = document.getElementById('goals-container');
            if (!container) return;
            if (currentGoals.length === 0) {
                container.innerHTML = `<div class="goal-card bg-white border-2 border-dashed border-indigo-200 text-center flex flex-col items-center justify-center" style="min-height:220px;">
                        <p class="text-indigo-700 font-semibold">Nenhuma meta cadastrada. Adicione a sua primeira acima.</p>
                    </div>`;
                updateGoalHeroStats();
                updatePlanLimitMessages();
                updatePremiumPrintReport();
                return;
            }
            container.innerHTML = currentGoals.map((goal, index) => buildGoalCard(goal, index)).join('');
            updateGoalHeroStats();
            updatePlanLimitMessages();
            updatePremiumPrintReport();
        }

        function handleGoalStrategyChange() {
            const strategy = document.getElementById('goal-strategy');
            const container = document.getElementById('goal-strategy-value-container');
            const input = document.getElementById('goal-strategy-value');
            if (!strategy || !container || !input) return;
            if (strategy.value === 'manual') {
                container.classList.add('hidden');
                input.required = false;
                input.value = '';
            } else {
                container.classList.remove('hidden');
                input.required = true;
            }
        }

        function resetGoalForm() {
            const form = document.getElementById('goal-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('goal-target');
            editingGoalId = null;
            const title = document.getElementById('modal-goal-title');
            if (title) title.textContent = 'Nova Meta';
            const submit = document.querySelector('#goal-form button[type="submit"]');
            if (submit) submit.textContent = 'Salvar Meta';
            document.getElementById('goal-id').value = '';
            handleGoalStrategyChange();
        }

        async function handleGoalSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('goal-name').value.trim();
            const targetAmount = getMoneyInputValue('goal-target');
            const strategy = document.getElementById('goal-strategy').value;
            const valueInput = document.getElementById('goal-strategy-value');
            const strategyValue = strategy === 'manual' ? null : parseFloat(valueInput.value || '0');
            if (!name || isNaN(targetAmount) || targetAmount <= 0) { alert('Preencha um nome e valor alvo vlidos.'); return; }
            if (strategy !== 'manual' && (isNaN(strategyValue) || strategyValue <= 0)) { alert('Informe um valor vlido para a estratgia.'); return; }
            const payload = {
                name,
                targetAmount,
                strategy,
                strategyValue: strategy === 'manual' ? null : strategyValue,
                updatedAt: new Date()
            };
            try {
                if (editingGoalId) {
                    await updateDoc(doc(db, `${DB_BASE_PATH}/goals/${editingGoalId}`), payload);
                } else {
                    payload.currentAmount = 0;
                    payload.history = [];
                    payload.createdAt = new Date();
                    await addDoc(collection(db, `${DB_BASE_PATH}/goals`), payload);
                }
                closeGoalModal();
                resetGoalForm();
            } catch (error) {
                console.error('Erro ao salvar meta', error);
                alert('No foi possvel salvar a meta.');
            }
        }

        function openGoalModal(goalId = null) {
            if (!goalId && getPlanRules().key !== 'premium' && isPlanAtLimit('goals')) {
                handlePlanLimitAttempt('goals');
                return;
            }
            resetGoalForm();
            if (goalId) {
                const goal = currentGoals.find(g => g.id === goalId);
                if (goal) {
                    editingGoalId = goalId;
                    document.getElementById('goal-name').value = goal.name;
                    setMoneyInputValue('goal-target', goal.targetAmount);
                    document.getElementById('goal-strategy').value = goal.strategy || 'manual';
                    if (goal.strategy && goal.strategy !== 'manual') {
                        document.getElementById('goal-strategy-value').value = goal.strategyValue || '';
                    }
                    document.getElementById('goal-id').value = goalId;
                    handleGoalStrategyChange();
                    const title = document.getElementById('modal-goal-title');
                    if (title) title.textContent = 'Editar Meta';
                    const submit = document.querySelector('#goal-form button[type="submit"]');
                    if (submit) submit.textContent = 'Atualizar Meta';
                }
            }
            const modal = document.getElementById('modal-goal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }
        function closeGoalModal() {
            const modal = document.getElementById('modal-goal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                resetGoalForm();
            }, 250);
        }

        async function deleteGoal(goalId) {
            if (!confirm('Remover meta?')) return;
            try {
                await deleteDoc(doc(db, `${DB_BASE_PATH}/goals/${goalId}`));
                if (editingGoalId === goalId) resetGoalForm();
            } catch (error) {
                console.error('Erro ao remover meta', error);
                alert('No foi possvel remover a meta.');
            }
        }

        // BUDGETS
        function loadBudgets() {
            unsubscribeBudgets();
            unsubscribeBudgets = onSnapshot(collection(db, `${DB_BASE_PATH}/budgets`), (snap) => { currentBudgets = snap.docs.map(d => ({ id: d.id, ...d.data() })); updateBudgetProgress(); });
        }
        function updateBudgetProgress() {
            const container = document.getElementById('budgets-container');
            if (!container) return;
            const spending = {};
            currentExpenses.forEach(e => { const c = (e.category || '').toLowerCase(); spending[c] = (spending[c] || 0) + e.amount; });
            const totalLimitEl = document.getElementById('budget-total-limit');
            const totalSpentEl = document.getElementById('budget-total-spent');
            const alertCountEl = document.getElementById('budget-alert-count');
            const alertTrigger = document.getElementById('budget-alerts-trigger');
            const alertTriggerLabel = alertTrigger ? alertTrigger.querySelector('small') : null;
            const planAllowsAlerts = planAllows('budgetAlerts');

            const statusConfig = {
                safe: { label: 'Em dia', headline: 'Fluxo equilibrado', description: 'Os gastos desta categoria esto dentro da meta.', color: '#34d399', icon: 'fa-face-smile-beam' },
                warning: { label: 'Ateno', headline: 'Hora de desacelerar', description: 'Voc est chegando perto do limite mensal. Reduza um pouco.', color: '#fbbf24', icon: 'fa-triangle-exclamation' },
                danger: { label: 'Crtico', headline: 'Limite estourando!', description: 'Tome cuidado, voc est muito perto do limite. Segure novos gastos agora.', color: '#f87171', icon: 'fa-circle-exclamation' },
                critical: { label: 'Estourou', headline: 'Categoria estourou', description: 'Voc ultrapassou o limite desta categoria. Reequilibre o plano imediatamente.', color: '#dc2626', icon: 'fa-fire' }
            };

            if (currentBudgets.length === 0) {
                container.innerHTML = `<div class="budget-empty">
                        <p class="font-semibold mb-1">Nenhum limite configurado ainda.</p>
                        <p class="text-sm text-purple-900/80">Crie limites por categoria para receber alertas visuais aqui.</p>
                    </div>`;
                if (totalLimitEl) totalLimitEl.textContent = formatCurrencyBRL(0);
                if (totalSpentEl) totalSpentEl.textContent = formatCurrencyBRL(0);
                if (alertCountEl) alertCountEl.textContent = '0';
                budgetAlertItems = [];
                if (alertTrigger) {
                    alertTrigger.disabled = true;
                    alertTrigger.classList.add('budget-alert-button-disabled');
                    alertTrigger.setAttribute('aria-disabled', 'true');
                }
                applyPrivacyMode();
                updatePlanLimitMessages();
                updatePremiumPrintReport();
                return;
            }

            let totalLimit = 0;
            let totalSpent = 0;
            const alertItems = [];

            container.innerHTML = currentBudgets.map(b => {
                const categoryLabel = b.category || 'Sem categoria';
                const key = categoryLabel.toLowerCase();
                const spent = spending[key] || 0;
                const limit = Number(b.limitAmount) || 0;
                totalLimit += limit;
                totalSpent += spent;
                const pctRaw = limit > 0 ? (spent / limit) * 100 : 0;
                const pct = Math.min(Math.max(pctRaw, 0), 120);
                let statusKey = 'safe';
                if (pctRaw >= 75) statusKey = 'warning';
                if (pctRaw >= 95) statusKey = 'danger';
                if (pctRaw > 100) statusKey = 'critical';
                const status = statusConfig[statusKey];
                const remaining = limit - spent;
                const spentLabel = formatCurrencyBRL(spent);
                const limitLabel = formatCurrencyBRL(limit);
                const remainderLabel = remaining >= 0 ? `<span class="money-display">${formatCurrencyBRL(remaining)}</span> disponvel` : `Excedente de <span class="money-display">${formatCurrencyBRL(Math.abs(remaining))}</span>`;
                if (statusKey !== 'safe') {
                    alertItems.push({ category: categoryLabel, statusKey, statusLabel: status.label, headline: status.headline, description: status.description, spent, limit, pct: limit > 0 ? pctRaw.toFixed(0) : '0', remaining });
                }
                return `<article class="budget-card status-${statusKey}">
                    <div class="budget-card-header">
                        <div>
                            <span class="budget-chip"><i class="fas fa-wallet"></i> ${categoryLabel}</span>
                            <p class="text-sm text-gray-500 mt-1">Limite <span class="money-display">${limitLabel}</span></p>
                        </div>
                        <div class="budget-card-actions">
                            <button onclick="window.editBudget('${b.id}')" title="Editar limite"><i class="fas fa-pen"></i></button>
                            <button onclick="window.deleteBudget('${b.id}')" title="Remover limite"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl font-semibold text-slate-900 money-display">${spentLabel}</span>
                        <span class="text-xs text-gray-500">gasto</span>
                    </div>
                    <div class="budget-progress-track">
                        <div class="budget-progress-fill" style="width:${Math.min(pct, 105)}%;background:${status.color};"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span><span class="money-display">${spentLabel}</span> / <span class="money-display">${limitLabel}</span></span>
                        <span>${limit > 0 ? pctRaw.toFixed(0) : 0}%</span>
                    </div>
                    <div class="budget-card-status"><i class="fas fa-bell"></i>${status.label}</div>
                    <div class="budget-card-callout">
                        <span class="callout-icon"><i class="fas ${status.icon}"></i></span>
                        <div>
                            <p class="callout-title">${status.headline}</p>
                            <p class="callout-text">${status.description}</p>
                        </div>
                    </div>
                    <div class="budget-card-footer">
                        <span class="budget-remaining ${remaining >= 0 ? 'ok' : 'over'}">${remainderLabel}</span>
                    </div>
                </article>`;
            }).join('');

            budgetAlertItems = alertItems;
            if (totalLimitEl) totalLimitEl.textContent = formatCurrencyBRL(totalLimit);
            if (totalSpentEl) totalSpentEl.textContent = formatCurrencyBRL(totalSpent);
            if (!planAllowsAlerts) {
                if (alertCountEl) alertCountEl.textContent = '';
                if (alertTrigger) {
                    alertTrigger.disabled = true;
                    alertTrigger.classList.add('budget-alert-button-disabled');
                    alertTrigger.setAttribute('aria-disabled', 'true');
                    if (alertTriggerLabel) alertTriggerLabel.textContent = 'Exclusivo Premium';
                }
            } else {
                if (alertCountEl) alertCountEl.textContent = alertItems.length.toString();
                if (alertTrigger) {
                    const disabled = alertItems.length === 0;
                    alertTrigger.disabled = disabled;
                    alertTrigger.classList.toggle('budget-alert-button-disabled', disabled);
                    alertTrigger.setAttribute('aria-disabled', disabled ? 'true' : 'false');
                    if (alertTriggerLabel) alertTriggerLabel.textContent = disabled ? 'Sem alertas' : 'Ver detalhes';
                }
            }
            applyPrivacyMode();
            updatePlanLimitMessages();
            updatePremiumPrintReport();
        }

        function resetBudgetForm() {
            const form = document.getElementById('budget-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('budget-amount');
            editingBudgetId = null;
            const title = document.getElementById('modal-budget-title');
            if (title) title.textContent = 'Novo Limite';
            const submit = document.querySelector('#budget-form button[type="submit"]');
            if (submit) submit.textContent = 'Salvar Limite';
            document.getElementById('budget-id').value = '';
        }

        function openBudgetModal(budgetId = null) {
            if (!budgetId && getPlanRules().key !== 'premium' && isPlanAtLimit('budgets')) {
                handlePlanLimitAttempt('budgets');
                return;
            }
            const select = document.getElementById('budget-category');
            if (select) {
                select.innerHTML = '';
                const cats = document.getElementById('expense-category').options;
                for (let i = 0; i < cats.length; i++) select.add(new Option(cats[i].text, cats[i].value));
            }
            resetBudgetForm();
            if (budgetId) {
                const budget = currentBudgets.find(b => b.id === budgetId);
                if (budget) {
                    editingBudgetId = budgetId;
                    if (!Array.from(document.getElementById('budget-category').options).some(opt => opt.value === budget.category)) {
                        document.getElementById('budget-category').add(new Option(budget.category, budget.category));
                    }
                    document.getElementById('budget-category').value = budget.category;
                    setMoneyInputValue('budget-amount', budget.limitAmount);
                    document.getElementById('budget-id').value = budgetId;
                    const title = document.getElementById('modal-budget-title');
                    if (title) title.textContent = 'Editar Limite';
                    const submit = document.querySelector('#budget-form button[type="submit"]');
                    if (submit) submit.textContent = 'Atualizar Limite';
                }
            }
            const modal = document.getElementById('modal-budget');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }
        function closeBudgetModal() {
            const modal = document.getElementById('modal-budget');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                resetBudgetForm();
            }, 250);
        }

        async function handleBudgetSubmit(event) {
            event.preventDefault();
            const category = document.getElementById('budget-category').value;
            const amount = getMoneyInputValue('budget-amount');
            if (!category || isNaN(amount) || amount <= 0) { alert('Informe categoria e limite vlidos.'); return; }
            const payload = { category, limitAmount: amount, updatedAt: new Date() };
            try {
                if (editingBudgetId) {
                    await updateDoc(doc(db, `${DB_BASE_PATH}/budgets/${editingBudgetId}`), payload);
                } else {
                    payload.createdAt = new Date();
                    await addDoc(collection(db, `${DB_BASE_PATH}/budgets`), payload);
                }
                closeBudgetModal();
                resetBudgetForm();
            } catch (error) {
                console.error('Erro ao salvar limite', error);
                alert('No foi possvel salvar o limite.');
            }
        }

        async function deleteBudget(budgetId) {
            if (!confirm('Remover limite?')) return;
            try {
                await deleteDoc(doc(db, `${DB_BASE_PATH}/budgets/${budgetId}`));
                if (editingBudgetId === budgetId) resetBudgetForm();
            } catch (error) {
                console.error('Erro ao remover limite', error);
                alert('No foi possvel remover o limite.');
            }
        }

        // INIT
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            const provider = new GoogleAuthProvider();
            setPersistence(auth, browserLocalPersistence).catch(() => setPersistence(auth, inMemoryPersistence)).then(() => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (!ALLOWED_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase())) { signOut(auth); alert("Sem permisso."); return; }
                        document.getElementById('user-email-display').textContent = user.email;
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('app-content').classList.remove('hidden');
                        syncPlanUI();

                        await loadSettings();
                        initializeSelectors();
                        initializeIncomeVisibilityToggle();
                        attachFormHandlers();
                        initializeMoneyInputs();
                        resetExpenseForm();
                        resetIncomeForm();
                        loadDataForMonth();
                        loadGoals();
                        loadBudgets();
                        calculateHistoricalStats();
                        initializeToggle();
                        initializeThemeToggle();
                        initializeGoalSuggestions();
                        initializePremiumExtrasToggle();
                    } else {
                        document.getElementById('login-screen').classList.remove('hidden');
                        document.getElementById('app-content').classList.add('hidden');
                        document.getElementById('auth-loading').classList.add('hidden');
                        document.getElementById('auth-buttons').classList.remove('hidden');
                    }
                });
            });
            document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).then(() => window.location.reload()));
            document.getElementById('privacy-toggle-btn').addEventListener('click', () => { localStorage.setItem('privacyMode', localStorage.getItem('privacyMode') !== 'true'); applyPrivacyMode(); });
            const slider = document.getElementById('split-slider');
            if (slider) {
                slider.addEventListener('input', (e) => setSplitValue(e.target.value, { skipSliderUpdate: true }));
            }
            const splitManual = document.getElementById('split-manual-input');
            if (splitManual) {
                splitManual.addEventListener('input', (e) => {
                    if (e.target.value === '') return;
                    setSplitValue(e.target.value, { skipManualUpdate: true });
                });
                splitManual.addEventListener('blur', (e) => setSplitValue(e.target.value));
            }
            const presets = document.getElementById('split-presets');
            if (presets) presets.addEventListener('click', (ev) => {
                const btn = ev.target.closest('button[data-value]');
                if (!btn) return;
                setSplitValue(btn.dataset.value);
            });
            if (slider) setSplitValue(slider.value);
            // Listener do boto de imprimir
            const printBtn = document.getElementById('print-button');
            if (printBtn) printBtn.addEventListener('click', () => window.print());
            const planToastClose = document.getElementById('plan-restriction-toast-close');
            if (planToastClose) planToastClose.addEventListener('click', hidePlanRestrictionToast);

            const budgetAlertsBtn = document.getElementById('budget-alerts-trigger');
            if (budgetAlertsBtn) {
                budgetAlertsBtn.addEventListener('click', () => {
                    if (budgetAlertsBtn.disabled || budgetAlertsBtn.getAttribute('aria-disabled') === 'true') return;
                    openBudgetAlertsModal();
                });
            }
        } catch (e) { console.error(e); }

        // WINDOW EXPORTS
        window.cancelEditExpense = cancelEditExpense;
        window.cancelEditIncome = cancelEditIncome;
        window.startEditExpense = startEditExpense;
        window.startEditIncome = startEditIncome;
        window.deleteItem = deleteItem;
        window.deleteGoal = deleteGoal;
        window.editGoal = (id) => openGoalModal(id);
        window.deleteBudget = deleteBudget;
        window.editBudget = (id) => openBudgetModal(id);
        window.openGoalModal = openGoalModal;
        window.closeGoalModal = closeGoalModal;
        window.openBudgetModal = openBudgetModal;
        window.closeBudgetModal = closeBudgetModal;
        window.openBudgetAlertsModal = openBudgetAlertsModal;
        window.closeBudgetAlertsModal = closeBudgetAlertsModal;
        window.openPremiumModal = openPremiumModal;
        window.handleTypeChange = handleTypeChange;
        window.handleBeneficiaryChange = handleBeneficiaryChange;
        window.toggleRecurrenceInput = toggleRecurrenceInput;
        window.updateSplitDisplay = updateSplitDisplay;
        window.openSettingsModal = openSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.addPerson = addPerson;
        window.removePerson = removePerson;
        window.addExpenseType = addExpenseType;
        window.removeType = removeType;
        window.selectColor = selectColor;

        let currentGoalId = null;
        window.openGoalContribModal = (goalId) => {
            currentGoalId = goalId;
            document.getElementById('goal-contrib-goal-id').value = goalId;
            document.getElementById('goal-contrib-date').value = new Date().toISOString().split('T')[0];
            clearMoneyInput('goal-contrib-amount');

            const g = currentGoals.find(x => x.id === goalId);
            const list = document.getElementById('goal-history-list');
            list.innerHTML = '';
            if (g && g.history && g.history.length > 0) {
                g.history.forEach((h, idx) => {
                    list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded"><span>${new Date(h.date).toLocaleDateString('pt-BR')}</span><span class="font-bold text-green-600">${formatCurrencyBRL(h.amount)}</span><button onclick="window.deleteGoalContrib('${goalId}', ${idx})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
                });
            } else { list.innerHTML = '<p class="text-gray-400 text-xs italic text-center">Nenhum aporte registrado.</p>'; }

            document.getElementById('modal-goal-contribution').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-goal-contribution').classList.add('active'), 10);
        };
        window.closeGoalContribModal = () => { document.getElementById('modal-goal-contribution').classList.remove('active'); setTimeout(() => document.getElementById('modal-goal-contribution').classList.add('hidden'), 250); };
        window.deleteGoalContrib = async (goalId, idx) => {
            if (!confirm("Remover?")) return;
            const g = currentGoals.find(x => x.id === goalId);
            const newHistory = [...g.history];
            newHistory.splice(idx, 1);
            const newTotal = newHistory.reduce((sum, h) => sum + h.amount, 0);
            await updateDoc(doc(db, `${DB_BASE_PATH}/goals/${goalId}`), { currentAmount: newTotal, history: newHistory });
            window.openGoalContribModal(goalId);
        };
        document.getElementById('goal-contrib-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amt = getMoneyInputValue('goal-contrib-amount');
            const date = document.getElementById('goal-contrib-date').value;
            const g = currentGoals.find(x => x.id === currentGoalId);
            if (!g) return;
            const newHistory = g.history ? [...g.history] : [];
            newHistory.push({ date, amount: amt, id: Date.now() });
            const newTotal = newHistory.reduce((sum, h) => sum + h.amount, 0);
            await updateDoc(doc(db, `${DB_BASE_PATH}/goals/${currentGoalId}`), { currentAmount: newTotal, history: newHistory });
            window.openGoalContribModal(currentGoalId);
        });

        window.handleImportCSV = (input) => {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async function (e) {
                const lines = e.target.result.split('\n');
                if (!confirm(`Importar ${lines.length} linhas?`)) return;
                for (let line of lines) {
                    const parts = line.split(',');
                    if (parts.length >= 3) {
                        const amt = parseFloat(parts[parts.length - 1].replace('R$', '').replace(',', '.'));
                        if (!isNaN(amt) && amt < 0) {
                            await addDoc(collection(db, `${DB_BASE_PATH}/expenses`), {
                                description: parts[1] || "Importado", amount: Math.abs(amt), date: parts[0], category: 'Outros', paidBy: 'Eduardo', typeId: 't1', sharingType: 'shared_50_50', monthYear: getMonthYear(parts[0]), createdAt: new Date()
                            });
                        }
                    }
                }
                alert(`Importado!`);
                input.value = '';
            };
            reader.readAsText(input.files[0]);
        };
        window.migrateData = async () => { if (confirm("Migrar?")) { const uid = auth.currentUser.uid; const oE = await getDocs(collection(db, `users/${uid}/expenses`)); oE.forEach(d => addDoc(collection(db, `${DB_BASE_PATH}/expenses`), d.data())); alert("Feito."); } };

    </script>
</body>

</html>