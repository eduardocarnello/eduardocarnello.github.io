<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        input,
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        div#table-container-income {
            margin-top: 2rem;
        }

        /* Blur */
        .blur-sensitive {
            filter: blur(6px);
            user-select: none;
            transition: filter 0.2s ease;
        }

        .blur-sensitive:hover {
            filter: blur(0px);
        }

        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .recurring-row {
            box-shadow: inset 4px 0 0 rgba(99, 102, 241, 0.9);
        }

        .recurring-row.inactive-recurring-row {
            box-shadow: inset 4px 0 0 rgba(148, 163, 184, 0.9);
            opacity: 0.9;
        }

        .recurrence-pill {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.1rem 0.55rem;
            background: rgba(199, 210, 254, 0.85);
            color: #312e81;
            border: 1px solid rgba(99, 102, 241, 0.25);
        }

        .recurrence-subtext {
            font-size: 0.72rem;
            color: #4b5563;
        }

        #app-content {
            transition: transform 0.45s ease, filter 0.45s ease, opacity 0.45s ease;
        }

        .period-fade-group {
            transition: opacity 0.45s ease, transform 0.45s ease, filter 0.45s ease;
        }

        .period-fade-active .period-fade-group {
            opacity: 0.35;
            filter: blur(2px);
            transform: scale(0.995);
            pointer-events: none;
        }

        #period-transition-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
        }

        #period-transition-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .period-loader {
            background: #0f172a;
            color: #f8fafc;
            padding: 1.75rem 2.25rem;
            border-radius: 1.25rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            text-align: center;
            min-width: 260px;
            box-shadow: 0 25px 60px rgba(2, 6, 23, 0.6);
        }

        .period-loader h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .period-loading-dots {
            display: inline-flex;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .period-loading-dots span {
            width: 0.55rem;
            height: 0.55rem;
            border-radius: 999px;
            background: #818cf8;
            animation: periodPulse 0.9s infinite ease-in-out;
        }

        .period-loading-dots span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .period-loading-dots span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes periodPulse {

            0%,
            80%,
            100% {
                opacity: 0.35;
                transform: translateY(0);
            }

            40% {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        #sticky-period-bar {
            position: sticky;
            top: 0;
            z-index: 35;
            margin-bottom: 1.5rem;
            height: 0;
            overflow: visible;
        }

        #sticky-period-inner {
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
        }

        #sticky-period-bar.sticky-visible #sticky-period-inner {
            pointer-events: auto;
            opacity: 1;
            transform: translateY(0);
        }

        .sticky-inner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            padding: 0.85rem 1.25rem;
        }

        .sticky-privacy-btn {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            border: 1px solid #e2e8f0;
            background: #ffffff;
            color: #475569;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
            transition: transform 0.2s ease, color 0.2s ease, border-color 0.2s ease, background 0.2s ease;
        }

        .sticky-privacy-btn:hover {
            transform: translateY(-1px);
            border-color: #c7d2fe;
            color: #312e81;
        }

        .sticky-add-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: 1px solid #fecaca;
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            font-size: 0.78rem;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(248, 113, 113, 0.35);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .sticky-add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(248, 113, 113, 0.4);
        }

        .sticky-add-btn i {
            font-size: 0.65rem;
        }

        .sticky-trigger-wrapper {
            position: relative;
            display: inline-block;
        }

        .sticky-trigger {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            border: 1px solid #e0e7ff;
            background: #eef2ff;
            font-weight: 600;
            color: #312e81;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .sticky-trigger:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.35);
        }

        .sticky-trigger i {
            font-size: 0.75rem;
            color: #4f46e5;
            transition: transform 0.2s ease;
        }

        .sticky-trigger.active i {
            transform: rotate(180deg);
        }

        .tooltip-group {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip-trigger {
            width: 1.35rem;
            height: 1.35rem;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .tooltip-trigger:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.45);
        }

        .tooltip-panel {
            position: absolute;
            bottom: calc(100% + 0.5rem);
            left: 50%;
            transform: translate(-50%, 6px);
            background: #111827;
            color: #f8fafc;
            padding: 0.65rem 0.85rem;
            border-radius: 0.6rem;
            font-size: 0.75rem;
            line-height: 1.2;
            width: 220px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 30;
        }

        .tooltip-panel::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #111827;
        }

        .tooltip-group:hover .tooltip-panel,
        .tooltip-group:focus-within .tooltip-panel {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, 0);
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem !important;
            }

            .sticky-inner-content {
                flex-direction: column;
                align-items: flex-start;
                border-radius: 1.25rem;
            }

            .sticky-inner-content .theme-toggle-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 0.75rem !important;
            }

            #forms-section,
            #summary-cards,
            #premium-report-section .grid,
            .goal-grid,
            .budget-grid {
                gap: 1.25rem;
            }

            #sticky-period-bar {
                top: 0;
            }

            .sticky-inner-content {
                gap: 0.75rem;
                padding: 0.9rem 1rem;
            }

            .period-select-wrapper:not(.compact) {
                flex-direction: column;
                align-items: stretch;
            }

            .period-select-wrapper:not(.compact) .period-nav-btn {
                width: 100%;
            }

            .period-select-wrapper:not(.compact) .period-select-columns {
                width: 100%;
                grid-template-columns: 1fr;
            }

            #expense-table-container table,
            #table-container-income table {
                min-width: 700px;
            }
        }

        .plan-banner {
            background: linear-gradient(115deg, rgba(15, 23, 42, 0.95), rgba(79, 70, 229, 0.92));
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.25rem;
            padding: 1.5rem;
            color: #f8fafc;
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            align-items: center;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.3);
        }

        .plan-banner h3 {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #c7d2fe;
        }

        .plan-banner p {
            color: rgba(226, 232, 240, 0.9);
        }

        .plan-banner ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .plan-banner ul li {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(129, 140, 248, 0.35);
            border-radius: 999px;
            padding: 0.35rem 0.85rem;
            font-size: 0.8rem;
        }

        .plan-banner button {
            background: #fef08a;
            color: #7c2d12;
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 999px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.25);
        }

        .premium-report-section {
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
            padding-top: 1rem;
        }

        .premium-report-section>div,
        .premium-report-section>article,
        .premium-report-section>.premium-advanced-grid,
        .premium-report-section>.premium-advanced-single,
        .premium-report-section>#premium-print-hero {
            margin-bottom: 0.5rem;
        }

        .premium-report-section>div:last-child,
        .premium-report-section>article:last-child,
        .premium-report-section>.premium-advanced-grid:last-child,
        .premium-report-section>.premium-advanced-single:last-child,
        .premium-report-section>#premium-print-hero:last-child {
            margin-bottom: 0;
        }

        .premium-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.9rem;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(79, 70, 229, 0.3));
            color: #312e81;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
            border: 1px solid rgba(79, 70, 229, 0.25);
            box-shadow: inset 0 0 15px rgba(79, 70, 229, 0.2);
        }

        .print-only {
            display: none !important;
        }

        .print-canvas {
            display: none;
            width: 100%;
            height: auto;
            background: #ffffff;
            border: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 0.85rem;
            margin-top: 0.75rem;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
            object-fit: contain;
        }

        .print-hidden-canvas {
            border: none !important;
        }

        .premium-print-header {
            position: relative;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 1.5rem;
            padding: 1.85rem 2.25rem;
            border-radius: 1.5rem;
            background: linear-gradient(135deg, #030712, #090f25 55%, #1c2760);
            color: #f8fafc;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 45px 90px rgba(5, 7, 20, 0.65);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .premium-print-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 110% 10%, rgba(236, 72, 153, 0.4), transparent 55%);
            pointer-events: none;
        }

        .premium-print-header h1 {
            font-size: 2rem;
            margin-bottom: 0.35rem;
            color: #f8fafc;
        }

        .premium-print-header>div,
        .premium-print-header .header-meta {
            position: relative;
            z-index: 1;
        }

        .premium-print-header p {
            color: rgba(248, 250, 252, 0.85);
            margin: 0.2rem 0 0;
        }

        .premium-print-header .header-meta {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.9rem;
            flex: 1;
            min-width: 280px;
        }

        .premium-print-header .header-meta span {
            display: block;
        }

        .premium-print-header .label {
            font-size: 0.7rem;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            color: rgba(248, 250, 252, 0.7);
            margin-bottom: 0.15rem;
        }

        .premium-print-header .value {
            font-size: 1rem;
            font-weight: 600;
            color: #f8fafc;
            overflow-wrap: anywhere;
        }

        .print-section-heading {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            border-radius: 1.25rem;
            background: linear-gradient(120deg, #eef2ff, #e0e7ff 45%, #c7d2fe);
            border: 1px solid rgba(79, 70, 229, 0.25);
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .print-section-heading .eyebrow {
            font-size: 0.68rem;
            letter-spacing: 0.5em;
            text-transform: uppercase;
            color: #4338ca;
            font-weight: 600;
        }

        .print-section-heading h2 {
            font-size: 1.9rem;
            font-weight: 700;
            color: #1e1b4b;
            margin-bottom: 0.25rem;
        }

        .print-section-heading p {
            font-size: 0.95rem;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: rgba(15, 23, 42, 0.75);
            margin: 0;
            margin-bottom: 0.25rem;
        }

        .eyebrow {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.35em;
            color: #94a3b8;
        }

        .print-section-heading.premium {
            background: linear-gradient(135deg, #1e1b4b, #312e81 55%, #4c1d95);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 65px rgba(15, 23, 42, 0.35);
            color: #f8fafc;
        }

        .print-section-heading.premium .eyebrow {
            color: #c7d2fe;
        }

        .print-section-heading.premium h2 {
            color: #eef2ff;
        }

        .print-section-heading.premium p {
            color: rgba(248, 250, 252, 0.85);
        }

        .premium-people-list,
        .premium-suggestions,
        .premium-variation-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
        }

        .premium-suggestions,
        .premium-variation-list {
            flex-direction: column;
        }

        .premium-people-list li {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #0f172a;
        }

        .premium-suggestions li {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.85rem;
            padding: 0.85rem 1rem;
            font-size: 0.9rem;
            color: #0f172a;
            border-left: 4px solid #4f46e5;
        }

        .premium-variation-item {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.95rem;
            padding: 0.85rem 1rem;
            background: #ffffff;
        }

        .premium-variation-item strong {
            font-size: 0.95rem;
            color: #0f172a;
        }

        .variation-bar {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: #e2e8f0;
            overflow: hidden;
            margin-top: 0.4rem;
        }

        .variation-bar-fill {
            height: 100%;
            border-radius: 999px;
        }

        .variation-bar-fill.up {
            background: #f87171;
        }

        .variation-bar-fill.down {
            background: #34d399;
        }

        .premium-empty {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .premium-advanced-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .premium-palette-card,
        .premium-advanced-card {
            border: 1px solid rgba(99, 102, 241, 0.25);
            background: linear-gradient(145deg, #ffffff, #f4f5ff 45%, #eef2ff);
            box-shadow: 0 25px 55px rgba(15, 23, 42, 0.12);
            position: relative;
            overflow: hidden;
            border-radius: 1.35rem;
            padding: 1.75rem;
        }

        .premium-advanced-card,
        .premium-advanced-card p,
        .premium-advanced-card li,
        .premium-advanced-card span,
        .premium-advanced-card strong,
        .premium-advanced-card em {
            color: #0f172a;
        }

        .premium-advanced-card strong {
            font-weight: 700;
        }

        .premium-palette-card::after,
        .premium-advanced-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(79, 70, 229, 0.16), transparent 55%);
            pointer-events: none;
        }

        .premium-palette-card>*,
        .premium-advanced-card>* {
            position: relative;
            z-index: 1;
        }

        .premium-palette-card>div:first-child,
        .premium-advanced-card>div:first-child,
        .premium-palette-card>header,
        .premium-advanced-card>header {
            margin-top: 0;
        }

        .premium-palette-card>*+*,
        .premium-advanced-card>*+* {
            margin-top: 1rem;
        }

        .premium-stat-grid {
            background: #eef2ff;
            border: 1px solid rgba(99, 102, 241, 0.25);
            border-radius: 1rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 0.9rem;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .premium-mini-card {
            background: #fff;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-left: 4px solid rgba(79, 70, 229, 0.6);
            border-radius: 0.85rem;
            padding: 0.85rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.05);
            min-height: 100px;
        }

        .premium-mini-card .icon-badge {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: rgba(79, 70, 229, 0.08);
            color: #4f46e5;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .category-icon-chip {
            background-color: #f8fafc !important;
            color: #475569 !important;
            border: 1px solid rgba(148, 163, 184, 0.7);
        }

        .premium-mini-card .label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: #94a3b8;
        }

        .premium-mini-card .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
        }

        .premium-mini-card .detail {
            font-size: 0.8rem;
            color: #475569;
        }

        .premium-mini-card.accent-amber {
            border-left-color: rgba(245, 158, 11, 0.7);
        }

        .premium-mini-card.accent-rose {
            border-left-color: rgba(244, 114, 182, 0.7);
        }

        .premium-mini-card.accent-emerald {
            border-left-color: rgba(16, 185, 129, 0.7);
        }

        .premium-mini-card.accent-slate {
            border-left-color: rgba(30, 64, 175, 0.6);
        }

        .premium-mini-card.wide {
            grid-column: span 2;
        }

        @media (max-width: 640px) {
            .premium-mini-card.wide {
                grid-column: span 1;
            }
        }

        .premium-mini-card ul {
            list-style: none;
            margin: 0.25rem 0 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .premium-mini-card ul li {
            font-size: 0.8rem;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .premium-mini-card ul li span {
            color: #64748b;
            font-size: 0.78rem;
        }

        .premium-mini-card.list-card {
            min-height: auto;
        }

        .premium-mini-list-group {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.9rem;
        }

        @media (max-width: 900px) {
            .premium-mini-list-group {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        .premium-mini-card .trend-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.8rem;
        }

        .trend-up {
            color: #dc2626;
        }

        .trend-down {
            color: #16a34a;
        }

        .food-insights-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .food-insights-list li {
            background: #f8fafc;
            border: 1px dashed rgba(79, 70, 229, 0.2);
            border-radius: 0.85rem;
            padding: 0.75rem;
            font-size: 0.85rem;
        }

        .premium-chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.85rem;
            padding-top: 0.6rem;
            border-top: 1px dashed rgba(148, 163, 184, 0.5);
        }

        .premium-chart-legend span {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
            color: #475569;
        }

        .premium-chart-legend i {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            display: inline-block;
        }

        .type-chart-wrapper {
            min-height: 20rem;
        }

        .plan-limit-message {
            background: rgba(248, 250, 252, 0.8);
            border: 1px dashed rgba(79, 70, 229, 0.4);
            color: #4338ca;
            font-size: 0.8rem;
            padding: 0.6rem 0.8rem;
            border-radius: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .plan-limit-message i {
            color: #7c3aed;
        }

        [data-premium-extra="true"] {
            display: none;
        }

        body.premium-extras-enabled [data-premium-extra="true"] {
            display: block;
        }

        .premium-extra-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1.15rem;
            padding: 1.5rem 1.75rem;
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
            margin: 0 auto;
            max-width: 960px;
            width: 100%;
            position: relative;
        }

        .premium-extra-toggle>div {
            flex: 1;
            min-width: 240px;
        }

        .premium-extra-toggle::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            box-shadow: inset 0 0 0 1px rgba(79, 70, 229, 0.08);
        }

        .premium-extra-toggle h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }

        .premium-extra-toggle p {
            margin: 0.15rem 0 0;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .premium-extra-toggle label {
            margin-left: auto;
        }

        .period-select-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }

        .period-select-columns {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .period-select-columns label {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .period-nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: 1px solid #c7d2fe;
            background: #eef2ff;
            color: #312e81;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
        }

        .period-nav-btn:hover,
        .period-nav-btn:focus-visible {
            background: #e0e7ff;
            color: #1e1b4b;
            outline: none;
            transform: translateY(-1px);
        }

        .period-nav-btn:active {
            transform: translateY(0);
        }

        .period-select-wrapper.compact {
            align-items: center;
            gap: 0.5rem;
        }

        .period-select-wrapper.compact .period-nav-btn {
            width: 36px;
            height: 36px;
        }

        .period-select-wrapper.compact .period-select-columns {
            gap: 0.4rem;
        }

        .period-select-wrapper.compact label {
            font-size: 0.65rem;
        }

        .premium-extra-switch.compact {
            font-size: 0.75rem;
            gap: 0.35rem;
        }

        .premium-extra-switch.compact input[type="checkbox"] {
            width: 38px;
            height: 20px;
        }

        .premium-extra-switch.compact input[type="checkbox"]::after {
            width: 14px;
            height: 14px;
        }

        .premium-extra-switch.compact input[type="checkbox"]:checked::after {
            transform: translateX(18px);
        }

        .sticky-extra-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.35rem 0.85rem 0.35rem 1rem;
            border-radius: 999px;
            border: 1px solid rgba(199, 210, 254, 0.8);
            background: rgba(255, 255, 255, 0.88);
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.15);
        }

        .sticky-extra-toggle span {
            font-size: 0.6rem;
            letter-spacing: 0.32em;
            font-weight: 700;
            color: #3730a3;
        }

        .premium-extra-switch {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4338ca;
        }

        .premium-extra-switch input[type="checkbox"] {
            appearance: none;
            width: 46px;
            height: 24px;
            border-radius: 999px;
            background: #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .premium-extra-switch input[type="checkbox"]::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(15, 23, 42, 0.2);
            transition: transform 0.2s ease;
        }

        .premium-extra-switch input[type="checkbox"]:checked {
            background: linear-gradient(120deg, #4f46e5, #7c3aed);
        }

        .premium-extra-switch input[type="checkbox"]:checked::after {
            transform: translateX(22px);
        }

        .plan-locked-card {
            background: #ffffff;
            border: 1px dashed rgba(79, 70, 229, 0.35);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .plan-locked-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .plan-locked-card p {
            font-size: 0.95rem;
            color: #4b5563;
        }

        .plan-locked-card button {
            align-self: flex-start;
            padding: 0.6rem 1.3rem;
            border-radius: 999px;
            border: none;
            background: linear-gradient(120deg, #fef3c7, #fde68a);
            color: #92400e;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.2);
        }

        .plan-restriction-toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #0f172a;
            color: #f8fafc;
            padding: 1rem 1.1rem;
            border-radius: 0.9rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 20px 40px rgba(2, 6, 23, 0.5);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            z-index: 60;
        }

        .plan-restriction-toast button {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .plan-restriction-toast.hidden {
            display: none;
        }

        .plan-banner-cta-wrapper {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .plan-banner .plan-status-pill {
            background: rgba(248, 250, 252, 0.18);
            color: #fff;
            padding: 0.3rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            letter-spacing: 0.2em;
        }

        .plan-banner .plan-upgrade-copy {
            font-size: 0.85rem;
            color: rgba(248, 250, 252, 0.85);
        }

        body.theme-dark .plan-banner {
            background: linear-gradient(115deg, rgba(2, 6, 23, 0.95), rgba(30, 27, 75, 0.92));
            border-color: rgba(129, 140, 248, 0.2);
        }

        body.theme-dark .plan-limit-message {
            background: rgba(30, 27, 75, 0.5);
            color: #c4b5fd;
            border-color: rgba(99, 102, 241, 0.35);
        }

        body.theme-dark .plan-restriction-toast {
            background: rgba(15, 23, 42, 0.95);
        }

        body.theme-dark .plan-locked-card {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(99, 102, 241, 0.4);
            color: #e0e7ff;
        }

        body.theme-dark .plan-locked-card h3 {
            color: #e0e7ff;
        }

        body.theme-dark .plan-locked-card p {
            color: #cbd5f5;
        }

        body.theme-dark .plan-locked-card button {
            background: linear-gradient(120deg, #3b82f6, #6366f1);
            color: #fef3c7;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.35);
        }

        body.theme-dark .premium-extra-toggle {
            background: rgba(15, 23, 42, 0.7);
            border-color: #334155;
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.6);
        }

        body.theme-dark .premium-extra-toggle h4 {
            color: #e2e8f0;
        }

        body.theme-dark .premium-extra-toggle p {
            color: #cbd5f5;
        }

        body.theme-dark .premium-extra-switch {
            color: #c4b5fd;
        }

        body.theme-dark .premium-extra-switch input[type="checkbox"] {
            background: rgba(51, 65, 85, 0.9);
        }

        body.theme-dark .premium-extra-switch.compact {
            color: #c7d2fe;
        }

        body.theme-dark .period-nav-btn {
            border-color: rgba(99, 102, 241, 0.45);
            background: rgba(49, 46, 129, 0.4);
            color: #c7d2fe;
        }

        body.theme-dark .period-nav-btn:hover,
        body.theme-dark .period-nav-btn:focus-visible {
            background: rgba(79, 70, 229, 0.5);
            color: #ffffff;
        }

        body.theme-dark .sticky-extra-toggle {
            background: rgba(15, 23, 42, 0.92);
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 15px 30px rgba(2, 6, 23, 0.7);
        }

        body.theme-dark .sticky-extra-toggle span {
            color: #c7d2fe;
        }

        body.theme-dark .premium-chip {
            background: rgba(79, 70, 229, 0.2);
            color: #c4b5fd;
        }

        body.theme-dark .premium-people-list li,
        body.theme-dark .premium-suggestions li,
        body.theme-dark .premium-variation-item {
            background: rgba(15, 23, 42, 0.7);
            border-color: #334155;
            color: #e2e8f0;
        }

        body.theme-dark .variation-bar {
            background: rgba(100, 116, 139, 0.5);
        }

        body.theme-dark .premium-empty {
            color: #cbd5f5;
        }

        .theme-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.45rem 0.85rem;
            border-radius: 999px;
            border: 1px solid #e2e8f0;
            background: #ffffff;
            color: #0f172a;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .theme-toggle-btn i {
            color: #6366f1;
        }

        .theme-toggle-btn:hover {
            background: #eef2ff;
            border-color: #c7d2fe;
            color: #312e81;
            transform: translateY(-1px);
        }

        .theme-toggle-btn.theme-toggle-btn-compact {
            padding: 0.35rem 0.7rem;
            font-size: 0.7rem;
            box-shadow: none;
        }

        .theme-toggle-btn span {
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        body.theme-dark {
            background-color: #050b16;
            color: #e2e8f0;
        }

        body.theme-dark .theme-toggle-btn {
            background: rgba(15, 23, 42, 0.85);
            border-color: #334155;
            color: #e2e8f0;
        }

        body.theme-dark .theme-toggle-btn i {
            color: #fcd34d;
        }

        body.theme-dark .theme-toggle-btn:hover {
            background: #1e293b;
            color: #fef3c7;
            border-color: #475569;
        }

        body.theme-dark .sticky-privacy-btn {
            background: rgba(15, 23, 42, 0.85);
            border-color: #334155;
            color: #e2e8f0;
        }

        body.theme-dark .sticky-privacy-btn:hover {
            color: #c7d2fe;
            border-color: #6366f1;
        }

        body.theme-dark .bg-white,
        body.theme-dark .modal .bg-white,
        body.theme-dark .goal-card,
        body.theme-dark .budget-card,
        body.theme-dark .print-card {
            background-color: #0f172a !important;
            color: #f1f5f9;
            border-color: rgba(148, 163, 184, 0.35) !important;
            box-shadow: 0 20px 35px rgba(2, 6, 23, 0.7);
        }

        body.theme-dark #user-email-display {
            color: #1434b3;
            background: rgba(20, 52, 179, 0.18);
            border: 1px solid rgba(79, 70, 229, 0.4);
        }

        body.theme-dark .print-section-heading {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
            border-color: rgba(148, 163, 184, 0.45);
            box-shadow: 0 25px 60px rgba(2, 6, 23, 0.65);
        }

        body.theme-dark .print-section-heading .eyebrow {
            color: #a5b4fc;
        }

        body.theme-dark .print-section-heading h2 {
            color: #f8fafc;
        }

        body.theme-dark .print-section-heading p {
            color: #cbd5f5;
        }

        body.theme-dark .print-section-heading.premium {
            background: linear-gradient(140deg, #0f172a, #1e1b4b 55%, #5b21b6);
            border-color: rgba(167, 139, 250, 0.45);
            box-shadow: 0 30px 70px rgba(2, 6, 23, 0.75);
        }

        body.theme-dark .print-section-heading.premium .eyebrow {
            color: #fbcfe8;
        }

        body.theme-dark .print-section-heading.premium p {
            color: rgba(248, 250, 252, 0.9);
        }

        body.theme-dark .premium-palette-card,
        body.theme-dark .premium-advanced-card {
            background: linear-gradient(150deg, rgba(15, 23, 42, 0.95), rgba(30, 27, 75, 0.9));
            border-color: rgba(129, 140, 248, 0.45);
            box-shadow: 0 30px 65px rgba(2, 6, 23, 0.75);
        }

        body.theme-dark .premium-palette-card::after,
        body.theme-dark .premium-advanced-card::after {
            background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.35), transparent 55%);
        }

        body.theme-dark .premium-advanced-card,
        body.theme-dark .premium-advanced-card p,
        body.theme-dark .premium-advanced-card li,
        body.theme-dark .premium-advanced-card span,
        body.theme-dark .premium-advanced-card strong,
        body.theme-dark .premium-advanced-card em {
            color: #f1f5f9;
        }

        body.theme-dark .category-icon-chip {
            background-color: rgba(15, 23, 42, 0.8) !important;
            color: #e0e7ff !important;
            border-color: rgba(148, 163, 184, 0.5);
        }

        body.theme-dark .food-insights-list li {
            background: rgba(15, 23, 42, 0.85);
            border-color: rgba(129, 140, 248, 0.35);
            color: #e2e8f0;
        }

        body.theme-dark .premium-stat-grid {
            background: rgba(15, 23, 42, 0.75);
            border-color: rgba(129, 140, 248, 0.35);
        }

        body.theme-dark .premium-mini-card {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(148, 163, 184, 0.4);
        }

        body.theme-dark .text-gray-900,
        body.theme-dark .text-gray-800,
        body.theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        body.theme-dark .text-gray-600,
        body.theme-dark .text-gray-500,
        body.theme-dark .text-gray-400 {
            color: #cbd5f5 !important;
        }

        body.theme-dark .border-gray-200 {
            border-color: #1f2937 !important;
        }

        body.theme-dark .border-gray-300 {
            border-color: #334155 !important;
        }

        body.theme-dark select,
        body.theme-dark input,
        body.theme-dark textarea {
            background-color: #0f172a;
            color: #f8fafc;
            border-color: #334155;
        }

        body.theme-dark .budget-hero {
            background: linear-gradient(135deg, #0f172a, #312e81);
            color: #c7d2fe;
        }

        body.theme-dark .budget-metric {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(148, 163, 184, 0.2);
        }

        body.theme-dark .budget-alert-button {
            background: rgba(15, 23, 42, 0.5);
            border-color: rgba(99, 102, 241, 0.3);
        }

        body.theme-dark .budget-card {
            background: #0b1120;
        }

        body.theme-dark .budget-card-callout {
            background: #111c2d;
            border-color: #1f2a3f;
        }

        body.theme-dark .budget-card.status-warning .budget-card-callout {
            background: rgba(120, 53, 15, 0.3);
            border-color: rgba(194, 65, 12, 0.4);
        }

        body.theme-dark .budget-card.status-danger .budget-card-callout {
            background: rgba(153, 27, 27, 0.25);
            border-color: rgba(220, 38, 38, 0.4);
        }

        body.theme-dark .budget-card.status-safe .budget-card-callout {
            background: rgba(6, 95, 70, 0.25);
            border-color: rgba(16, 185, 129, 0.3);
        }

        body.theme-dark .goal-hero {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.45);
        }

        body.theme-dark #sticky-period-inner,
        body.theme-dark .sticky-picker {
            background: #0f172a;
            border-color: #1f2937;
            box-shadow: 0 15px 30px rgba(2, 6, 23, 0.65);
        }

        body.theme-dark .budget-empty {
            background: rgba(49, 46, 129, 0.3);
            border-color: rgba(79, 70, 229, 0.4);
            color: #c4b5fd;
        }

        body.theme-dark .modal-content {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        body.theme-dark .tooltip-panel {
            background: #0f172a;
        }

        body.theme-dark .tooltip-panel::after {
            border-color: transparent transparent #0f172a transparent;
        }

        body.theme-dark .transfer-text {
            color: #f8fafc;
        }

        body.theme-dark .transfer-text-positive {
            color: #bef264;
        }

        body.theme-dark .transfer-text-negative {
            color: #fecaca;
        }

        body.theme-dark .goal-metric,
        body.theme-dark .budget-metric {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(148, 163, 184, 0.2);
        }

        body.theme-dark .goal-metric span,
        body.theme-dark .budget-metric span,
        body.theme-dark .goal-card h3,
        body.theme-dark .budget-card h3,
        body.theme-dark .budget-card .callout-title,
        body.theme-dark .budget-alert-card h3 {
            color: #f8fafc;
        }

        body.theme-dark .goal-suggestion-select {
            background: rgba(15, 23, 42, 0.65);
            border-color: rgba(99, 102, 241, 0.5);
            color: #f1f5f9;
        }

        body.theme-dark .goal-suggestion-select option {
            color: #0f172a;
        }

        body.theme-dark .goal-card {
            border-color: rgba(148, 163, 184, 0.15) !important;
        }

        body.theme-dark .budget-card {
            border-color: rgba(30, 41, 59, 0.8) !important;
        }

        body.theme-dark .budget-card .text-gray-500,
        body.theme-dark .budget-card .callout-text,
        body.theme-dark .budget-alert-card p,
        body.theme-dark .goal-card p {
            color: #cbd5f5 !important;
        }

        body.theme-dark .budget-card.status-warning .budget-card-callout .callout-icon,
        body.theme-dark .budget-card.status-danger .budget-card-callout .callout-icon,
        body.theme-dark .budget-card.status-critical .budget-card-callout .callout-icon,
        body.theme-dark .budget-card.status-safe .budget-card-callout .callout-icon {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.theme-dark .budget-alert-card {
            background: #0b1120;
            border-color: #1e293b;
            box-shadow: 0 20px 45px rgba(2, 6, 23, 0.65);
        }

        body.theme-dark .budget-alert-card.status-warning {
            background: rgba(120, 53, 15, 0.45);
            border-color: rgba(251, 191, 36, 0.4);
        }

        body.theme-dark .budget-alert-card.status-warning .alert-badge {
            background: rgba(251, 191, 36, 0.35);
            color: #fff7e0;
        }

        body.theme-dark .budget-alert-card.status-danger {
            background: rgba(153, 27, 27, 0.45);
            border-color: rgba(248, 113, 113, 0.4);
        }

        body.theme-dark .budget-alert-card.status-danger .alert-badge {
            background: rgba(248, 113, 113, 0.35);
            color: #fff5f5;
        }

        body.theme-dark .budget-alert-card.status-critical {
            background: rgba(127, 29, 29, 0.55);
            border-color: rgba(239, 68, 68, 0.45);
        }

        body.theme-dark .budget-alert-card .alert-badge,
        body.theme-dark .budget-card-status {
            color: #fef9c3;
        }

        body.theme-dark .budget-card-status {
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        body.theme-dark .budget-alert-button small,
        body.theme-dark .legend-item,
        body.theme-dark .legend-item span,
        body.theme-dark .budget-label,
        body.theme-dark .goal-hero label,
        body.theme-dark .goal-hero p,
        body.theme-dark .goal-hero span {
            color: #e0e7ff !important;
        }

        body.theme-dark .legend-dot.safe {
            background: #34d399;
        }

        body.theme-dark .legend-dot.warning {
            background: #fbbf24;
        }

        body.theme-dark .legend-dot.danger {
            background: #f87171;
        }

        body.theme-dark table {
            color: #e2e8f0;
        }

        body.theme-dark thead,
        body.theme-dark .bg-gray-50 {
            background-color: #111c2d !important;
        }

        body.theme-dark thead th {
            color: #f8fafc !important;
            border-color: rgba(51, 65, 85, 0.8) !important;
        }

        body.theme-dark tbody tr,
        body.theme-dark table tr,
        body.theme-dark table td,
        body.theme-dark table th {
            border-color: rgba(51, 65, 85, 0.8) !important;
        }

        body.theme-dark tbody tr:nth-child(odd) {
            background-color: rgba(15, 23, 42, 0.65);
        }

        body.theme-dark tbody tr:nth-child(even) {
            background-color: rgba(15, 23, 42, 0.45);
        }

        body.theme-dark tbody td {
            color: #e5e7eb;
        }

        body.theme-dark #statistics-section {
            background: #0b1120 !important;
            border-color: #1e293b !important;
            box-shadow: 0 25px 50px rgba(2, 6, 23, 0.7);
        }

        body.theme-dark #expense-table-body {
            background: transparent;
        }

        body.theme-dark #expense-table-body tr:nth-child(odd) {
            background-color: rgba(15, 23, 42, 0.8) !important;
        }

        body.theme-dark #expense-table-body tr:nth-child(even) {
            background-color: rgba(15, 23, 42, 0.6) !important;
        }

        body.theme-dark #expense-table-body td {
            color: #f1f5f9 !important;
        }

        body.theme-dark #expense-table-body tr:hover {
            background-color: rgba(99, 102, 241, 0.25) !important;
        }

        body.theme-dark .bg-gray-100,
        body.theme-dark .bg-gray-200,
        body.theme-dark .bg-gray-300 {
            background-color: #111c2d !important;
        }

        body.theme-dark .text-green-600,
        body.theme-dark .text-green-500 {
            color: #6ee7b7 !important;
        }

        body.theme-dark .text-blue-600,
        body.theme-dark .text-blue-500 {
            color: #93c5fd !important;
        }

        body.theme-dark .text-indigo-600,
        body.theme-dark .text-indigo-500 {
            color: #c7d2fe !important;
        }

        body.theme-dark .text-red-600,
        body.theme-dark .text-red-500 {
            color: #fca5a5 !important;
        }

        body.theme-dark .text-yellow-600,
        body.theme-dark .text-yellow-500 {
            color: #fde68a !important;
        }

        body.theme-dark .goal-card-actions button {
            background: rgba(148, 163, 184, 0.15);
            color: #e2e8f0;
        }

        body.theme-dark .goal-card-actions button:hover {
            background: rgba(129, 140, 248, 0.35);
        }

        body.theme-dark .budget-card-actions button {
            background: rgba(148, 163, 184, 0.15);
            color: #e2e8f0;
        }

        body.theme-dark .budget-card-actions button:hover {
            background: rgba(129, 140, 248, 0.35);
            color: #fff;
        }

        body.theme-dark input[type="range"]#split-slider {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.8) 0%, rgba(129, 140, 248, 0.65) 100%);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.6);
        }

        body.theme-dark input[type="range"]#split-slider::-webkit-slider-thumb,
        body.theme-dark input[type="range"]#split-slider::-moz-range-thumb,
        body.theme-dark input[type="range"]#split-slider::-ms-thumb {
            background: #0f172a;
            border-color: #c7d2fe;
        }

        body.theme-dark .budget-remaining.ok {
            background: rgba(16, 185, 129, 0.25);
            color: #6ee7b7;
        }

        body.theme-dark .budget-remaining.over {
            background: rgba(239, 68, 68, 0.25);
            color: #fecaca;
        }

        body.theme-dark .budget-card.status-warning .budget-remaining.ok {
            background: rgba(251, 191, 36, 0.28);
            color: #fde68a;
        }

        body.theme-dark .budget-card.status-danger .budget-remaining.ok {
            background: rgba(248, 113, 113, 0.3);
            color: #fecaca;
        }

        body.theme-dark .budget-card.status-critical .budget-remaining.over {
            background: rgba(239, 68, 68, 0.35);
            color: #fee2e2;
        }

        body.theme-dark #chart-wrapper {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 1rem;
        }

        body.theme-dark #table-wrapper {
            background: rgba(2, 6, 23, 0.8);
            border-radius: 1rem;
        }

        body.theme-dark .money-display {
            color: #fef3c7;
        }

        body.theme-dark #settlement-container {
            background: #0b1120;
            border-color: #1f2937;
            color: #e2e8f0;
        }

        body.theme-dark #settlement-content p {
            color: #e5e7eb;
        }

        body.theme-dark #settlement-content .text-yellow-600,
        body.theme-dark #settlement-content .text-yellow-500,
        body.theme-dark #settlement-content .text-yellow-400 {
            color: #fde047 !important;
        }

        body.theme-dark #settlement-content .bg-yellow-100,
        body.theme-dark #settlement-content .bg-yellow-200 {
            background-color: rgba(234, 179, 8, 0.25) !important;
        }

        body.theme-dark #settlement-content .bg-indigo-50 {
            background-color: rgba(67, 56, 202, 0.25) !important;
            border-color: rgba(129, 140, 248, 0.4) !important;
        }

        body.theme-dark #settlement-content .text-indigo-700 {
            color: #c7d2fe !important;
        }

        .period-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.35rem 1rem;
            border-radius: 0.4rem;
            background-color: #eef2ff;
            color: #312e81;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid #e0e7ff;
        }

        .period-chip::before {
            content: '\f073';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.75rem;
        }

        .sticky-picker {
            position: absolute;
            left: 0;
            top: calc(100% + 0.4rem);
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
            border-radius: 0.65rem;
            padding: 0.75rem;
            min-width: 240px;
            z-index: 50;
        }

        .picker-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
        }

        .picker-select {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            font-weight: 600;
            background: #f9fafb;
            color: #111827;
        }

        .picker-select:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.25);
        }

        .period-flash {
            animation: chipPulse 0.9s ease;
        }

        .period-highlight {
            animation: subtleGlow 0.9s ease;
        }

        @keyframes chipPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.35);
            }

            100% {
                box-shadow: 0 0 0 16px rgba(79, 70, 229, 0);
            }
        }

        @keyframes subtleGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(129, 140, 248, 0.25);
            }

            100% {
                box-shadow: 0 0 0 18px rgba(129, 140, 248, 0);
            }
        }

        .goal-hero {
            background: linear-gradient(135deg, #4c1d95, #6d28d9);
            color: #fdf4ff;
            border-radius: 1.5rem;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .goal-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.35), transparent 60%);
            opacity: 0.55;
        }

        .goal-hero>* {
            position: relative;
            z-index: 1;
        }

        .goal-metrics {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .goal-metric {
            background: rgba(15, 23, 42, 0.2);
            padding: 0.85rem 1.1rem;
            border-radius: 1rem;
            min-width: 160px;
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .goal-metric span {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .goal-suggestion-select {
            background: rgba(248, 250, 252, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 999px;
            padding: 0.35rem 1rem;
            color: #f8fafc;
        }

        .goal-suggestion-select option {
            color: #111827;
        }

        .goal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
        }

        .goal-card {
            border-radius: 1.25rem;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(15, 23, 42, 0.05);
        }

        .goal-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.25));
            pointer-events: none;
        }

        .goal-card>* {
            position: relative;
            z-index: 1;
        }

        .goal-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.1rem 0.7rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: #0f172a;
        }

        .goal-progress-track {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.1);
            overflow: hidden;
            margin: 0.75rem 0;
        }

        .goal-progress-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.6s ease;
        }

        .budget-hero {
            background: linear-gradient(135deg, #1d4ed8, #7c3aed);
            border-radius: 1.5rem;
            padding: 2rem;
            color: #e0e7ff;
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.25);
        }

        .budget-hero-top {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .budget-hero-top {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .budget-label {
            text-transform: uppercase;
            letter-spacing: 0.4em;
            font-size: 0.65rem;
            color: rgba(224, 231, 255, 0.8);
            margin-bottom: 0.75rem;
        }

        .budget-hero h2 {
            font-size: clamp(1.5rem, 2vw, 2.2rem);
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.3rem;
        }

        .budget-hero p {
            font-size: 0.95rem;
            color: rgba(226, 232, 240, 0.9);
        }

        .budget-hero-actions button {
            background: #fef3c7;
            color: #b45309;
            font-weight: 600;
            border-radius: 999px;
            padding: 0.85rem 1.5rem;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .budget-hero-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.25);
        }

        .budget-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-top: 1.75rem;
        }

        .budget-metric {
            background: rgba(15, 23, 42, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 1rem;
        }

        .budget-metric p {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 0.35rem;
            color: rgba(224, 231, 255, 0.9);
        }

        .budget-metric span {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
        }

        .budget-alert-button {
            width: 100%;
            background: rgba(15, 23, 42, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            color: #fefefe;
            font-size: 1rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .budget-alert-button small {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        .budget-alert-button:not(.budget-alert-button-disabled):hover {
            background: rgba(15, 23, 42, 0.35);
            transform: translateY(-1px);
        }

        .budget-alert-button-disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .budget-legend {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            font-size: 0.8rem;
            color: rgba(224, 231, 255, 0.85);
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            display: inline-block;
        }

        .legend-dot.safe {
            background: #34d399;
        }

        .legend-dot.warning {
            background: #fbbf24;
        }

        .legend-dot.danger {
            background: #f87171;
        }

        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
        }

        .budget-card {
            background: #ffffff;
            border-radius: 1.25rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            position: relative;
        }

        .budget-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .budget-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.2rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #eef2ff;
            color: #4338ca;
        }

        .budget-card-actions {
            display: inline-flex;
            gap: 0.35rem;
        }

        .budget-card-actions button {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            color: #475569;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .budget-card-actions button:hover {
            background: #e0e7ff;
            color: #3730a3;
        }

        .budget-progress-track {
            width: 100%;
            height: 10px;
            border-radius: 999px;
            background: #e5e7eb;
            overflow: hidden;
        }

        .budget-progress-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.45s ease;
        }

        .budget-card-status {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.77rem;
            font-weight: 600;
            border-radius: 999px;
            padding: 0.2rem 0.75rem;
        }

        .budget-card.status-safe .budget-card-status {
            background: rgba(52, 211, 153, 0.15);
            color: #047857;
        }

        .budget-card.status-warning .budget-card-status {
            background: rgba(251, 191, 36, 0.2);
            color: #92400e;
        }

        .budget-card.status-danger .budget-card-status {
            background: rgba(248, 113, 113, 0.2);
            color: #991b1b;
        }

        .budget-card.status-critical .budget-card-status {
            background: rgba(239, 68, 68, 0.3);
            color: #7f1d1d;
        }

        .budget-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #475569;
        }

        .budget-empty {
            border: 2px dashed #c7d2fe;
            border-radius: 1.25rem;
            padding: 2rem;
            text-align: center;
            color: #4c1d95;
            background: #eef2ff;
        }

        .budget-card-callout {
            border-radius: 1rem;
            padding: 0.9rem 1rem;
            display: flex;
            gap: 0.8rem;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .budget-card-callout .callout-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #e0e7ff;
            color: #312e81;
            font-size: 0.9rem;
        }

        .budget-card.status-safe .budget-card-callout .callout-icon {
            background: #e0f2fe;
            color: #0369a1;
        }

        .budget-card-callout .callout-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #0f172a;
        }

        .budget-card-callout .callout-text {
            font-size: 0.8rem;
            color: #475569;
        }

        .budget-card.status-warning .budget-card-callout {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .budget-card.status-warning .budget-card-callout .callout-icon {
            background: #ffedd5;
            color: #9a3412;
        }

        .budget-card.status-danger .budget-card-callout {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .budget-card.status-danger .budget-card-callout .callout-icon {
            background: #fee2e2;
            color: #b91c1c;
        }

        .budget-card.status-critical .budget-card-callout {
            background: #fee2e2;
            border-color: #fca5a5;
        }

        .budget-card.status-critical .budget-card-callout .callout-icon {
            background: #fecaca;
            color: #7f1d1d;
        }

        .budget-remaining {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            border-radius: 999px;
            padding: 0.2rem 0.9rem;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .budget-remaining.ok {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .budget-remaining.over {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .budget-card.status-warning .budget-remaining.ok {
            background: rgba(251, 191, 36, 0.18);
            color: #92400e;
        }

        .budget-card.status-danger .budget-remaining.ok {
            background: rgba(248, 113, 113, 0.18);
            color: #b91c1c;
        }

        .budget-card.status-critical .budget-remaining.over {
            background: rgba(239, 68, 68, 0.25);
            color: #7f1d1d;
        }

        .budget-alert-card {
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.25rem;
            background: #fff;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        }

        .budget-alert-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.35rem;
        }

        .budget-alert-card p {
            font-size: 0.85rem;
            color: #475569;
            margin-bottom: 0.3rem;
        }

        .budget-alert-card .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.2rem 0.75rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .budget-alert-card.status-warning .alert-badge {
            background: #fef3c7;
            color: #7c2d12;
        }

        .budget-alert-card.status-danger .alert-badge {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .budget-alert-card.status-critical .alert-badge {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .budget-alert-card .alert-remainder.ok {
            color: #065f46;
            font-weight: 600;
        }

        .budget-alert-card .alert-remainder.over {
            color: #b91c1c;
            font-weight: 600;
        }

        .transfer-text {
            color: #0f172a;
        }

        .transfer-text-positive {
            color: #15803d;
        }

        .transfer-text-negative {
            color: #b91c1c;
        }

        .goal-card-actions button {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .goal-card-actions button:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.35);
        }

        .goal-strategy-tooltip {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.2rem;
        }

        .split-preset-btn {
            transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        }

        .split-preset-btn.active {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: #fff;
        }

        input[type="range"]#split-slider {
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: linear-gradient(90deg, #4f46e5 0%, #a5b4fc 100%);
            outline: none;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]#split-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #4f46e5;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.35);
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        input[type="range"]#split-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        input[type="range"]#split-slider::-moz-range-track {
            background: transparent;
        }

        input[type="range"]#split-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #4f46e5;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.35);
            cursor: pointer;
        }

        input[type="range"]#split-slider::-ms-track {
            background: transparent;
            border-color: transparent;
            color: transparent;
        }

        input[type="range"]#split-slider::-ms-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #4f46e5;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.35);
            cursor: pointer;
        }

        .print-card {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        body.plan-premium #print-area {
            background: radial-gradient(circle at top, rgba(99, 102, 241, 0.08), transparent 40%);
            padding: 1rem 1.5rem;
            border-radius: 1.5rem;
        }

        body.plan-premium #print-title {
            font-size: 2rem;
            letter-spacing: 0.08em;
            color: #312e81;
        }

        body.plan-premium .print-card {
            border-color: rgba(79, 70, 229, 0.15);
            box-shadow: 0 12px 35px rgba(15, 23, 42, 0.08);
        }

        .premium-advanced-single {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 1.5rem;
        }

        .premium-table-full {
            width: 100%;
            border-collapse: collapse;
        }

        .premium-table-full th,
        .premium-table-full td {
            padding: 0.6rem 0.75rem;
        }

        .premium-category-table {
            margin-top: 1.25rem;
            border-radius: 1.25rem;
            border: 1px solid rgba(99, 102, 241, 0.18);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .premium-category-table table {
            width: 100%;
        }

        .premium-report-section thead {
            background: linear-gradient(90deg, rgba(49, 46, 129, 0.18), rgba(99, 102, 241, 0.22), rgba(167, 139, 250, 0.18)) !important;
            border-bottom: 1px solid rgba(49, 46, 129, 0.18);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .premium-report-section thead th {
            color: #0f172a !important;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.75rem;
            font-weight: 600;
        }

        body.theme-dark .premium-report-section thead {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.35), rgba(167, 139, 250, 0.35), rgba(248, 250, 252, 0.05)) !important;
            border-bottom-color: rgba(129, 140, 248, 0.5);
        }

        body.theme-dark .premium-report-section thead th {
            color: #f8fafc !important;
        }

        .premium-advanced-card table,
        .premium-palette-card table {
            margin-top: 1rem;
        }

        .premium-print-hero {
            background: radial-gradient(circle at top left, rgba(250, 250, 255, 0.15), transparent 45%), linear-gradient(130deg, #0f172a, #1e1b4b 45%, #312e81);
            color: #f8fafc;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 40px 90px rgba(15, 23, 42, 0.55);
            position: relative;
            overflow: hidden;
            padding: 2rem;
            border-radius: 1.5rem;
            gap: 1.5rem;
            display: flex;
            flex-direction: column;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .premium-print-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 120% 20%, rgba(236, 72, 153, 0.35), transparent 55%);
            pointer-events: none;
        }

        .premium-print-hero h2 {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
        }

        .premium-print-hero>div {
            position: relative;
            z-index: 1;
        }

        .premium-print-hero .premium-print-pill {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(255, 255, 255, 0.35);
        }

        .premium-print-hero p,
        .premium-print-hero span {
            color: rgba(248, 250, 252, 0.9);
        }

        .premium-print-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.9rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .premium-print-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .premium-print-metrics div {
            background: rgba(15, 23, 42, 0.45);
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid rgba(248, 250, 252, 0.3);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(4px);
        }

        .premium-print-metrics span {
            display: block;
        }

        .premium-print-metrics .label {
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            opacity: 0.85;
        }

        .premium-print-metrics .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffffff;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .print-canvas {
                display: block !important;
            }

            canvas.print-hidden-canvas {
                display: none !important;
            }

            #premium-print-header {
                margin-bottom: 2rem !important;
                box-shadow: none !important;
                border-color: #d4dcfb !important;
            }

            body[data-plan-key="premium"] [data-premium-extra="true"] {
                display: block !important;
            }

            .type-chart-wrapper {
                min-height: 26rem !important;
            }

            body {
                background-color: #ffffff;
                margin: 0;
                padding: 0;
            }

            #print-area {
                display: block !important;
                width: 100% !important;
                padding: 0;
                margin: 0;
                box-shadow: none;
                border: none;
            }

            #print-title {
                display: block !important;
                text-align: left;
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            #summary-cards {
                display: grid !important;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
                gap: 1rem !important;
                padding: 0 !important;
            }

            #summary-cards>* {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            #dynamic-cards-container {
                display: contents !important;
            }

            .print-card {
                box-shadow: none !important;
                border-color: #d1d5db !important;
                background-color: #fff !important;
            }

            #settlement-content {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
                gap: 1rem !important;
            }

            #statistics-section {
                page-break-before: always;
                display: block !important;
                height: auto !important;
            }

            #statistics-content {
                display: block !important;
            }

            #chart-wrapper {
                width: 100% !important;
                height: 300px !important;
                margin-bottom: 20px !important;
                page-break-inside: avoid;
            }

            #table-wrapper {
                width: 100% !important;
            }

            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-top: 1rem !important;
            }

            th,
            td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
                text-align: left !important;
                font-size: 10pt !important;
            }


            #expense-table-container {
                page-break-inside: avoid;
            }

            #expense-table-container>div {
                border-left: 1px solid #cbd5f5 !important;
                border-right: 1px solid #cbd5f5 !important;
                box-sizing: border-box;
            }

            body[data-plan-key="premium"] .premium-print-header,
            body[data-plan-key="premium"] .premium-print-hero {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #premium-print-hero {
                background: linear-gradient(135deg, #f8fafc, #eef2ff 45%, #e0e7ff) !important;
                border: 1px solid #cbd5f5 !important;
                color: #0f172a !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #premium-print-hero h2 {
                color: #0f172a !important;
            }

            #premium-print-hero .premium-print-pill,
            #premium-print-hero .label,
            #premium-print-hero .value,
            #premium-print-hero p,
            #premium-print-hero span {
                color: #0f172a !important;
            }

            #premium-print-hero .premium-print-metrics {
                margin-top: 1rem;
            }

            #premium-print-hero .premium-print-metrics div {
                background: #ffffff !important;
                border-color: #d4dcfb !important;
                box-shadow: none !important;
            }

            body[data-plan-key="premium"] .premium-palette-card,
            body[data-plan-key="premium"] .premium-advanced-card {
                overflow: visible !important;
            }

            body[data-plan-key="premium"] .premium-palette-card,
            body[data-plan-key="premium"] .premium-advanced-card {
                page-break-inside: avoid;
            }

            body[data-plan-key="premium"] #premium-report-section canvas,
            body[data-plan-key="premium"] canvas[id$="-chart"] {
                max-width: 100% !important;
                min-height: 260px !important;
                height: 260px !important;
            }

            body[data-plan-key="premium"] .chart-guard,
            body[data-plan-key="premium"] .chart-container {
                page-break-inside: avoid;
            }

            body[data-plan-key="premium"] .premium-advanced-card .h-56,
            body[data-plan-key="premium"] .premium-palette-card .h-56 {
                height: auto !important;
                min-height: 280px !important;
                margin-bottom: 1rem !important;
            }

            body[data-plan-key="premium"] .premium-chart-legend {
                page-break-inside: avoid !important;
            }

            body[data-print-mode="basic"] #premium-print-header,
            body[data-print-mode="basic"] .print-section-heading.premium,
            body[data-print-mode="basic"] #premium-report-section,
            body[data-print-mode="basic"] #premium-print-hero,
            body[data-print-mode="basic"] [data-premium-extra="true"] {
                display: none !important;
            }

            body[data-print-mode="basic"] #print-area {
                background: #ffffff !important;
                border: none !important;
                padding: 0 !important;
            }

            th {
                background-color: #f4f4f4 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }

            tr,
            td,
            th {
                page-break-inside: avoid !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            h2 {
                font-size: 1.25rem !important;
                font-weight: 600 !important;
                margin-top: 1.5rem !important;
                page-break-before: auto !important;
                page-break-after: avoid !important;
            }

            body[data-plan-key="premium"] #print-area {
                background: linear-gradient(120deg, #f8fafc, #eef2ff 45%, #e0e7ff) !important;
                border-radius: 1.5rem !important;
                padding: 1.5rem 2rem !important;
                border: 1px solid #c7d2fe !important;
                box-shadow: inset 0 0 0 1px rgba(79, 70, 229, 0.08);
            }

            body[data-plan-key="premium"] .print-section-heading,
            body[data-plan-key="premium"] .premium-print-hero {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                border-radius: 1.5rem !important;
                border: 1px solid rgba(79, 70, 229, 0.35) !important;
            }

            body[data-plan-key="premium"] .premium-print-hero {
                background: linear-gradient(135deg, #0f172a, #1e1b4b 45%, #312e81) !important;
                color: #eef2ff !important;
                border-color: rgba(255, 255, 255, 0.2) !important;
            }

            body[data-plan-key="premium"] .premium-print-hero::before {
                content: none !important;
            }

            body[data-plan-key="premium"] .premium-print-hero h2,
            body[data-plan-key="premium"] .premium-print-hero p,
            body[data-plan-key="premium"] .premium-print-hero span,
            body[data-plan-key="premium"] .premium-print-hero .value,
            body[data-plan-key="premium"] .premium-print-hero .label {
                color: #f8fafc !important;
            }

            body[data-plan-key="premium"] .premium-print-hero .premium-print-metrics div {
                background: rgba(15, 23, 42, 0.35) !important;
                border-color: rgba(248, 250, 252, 0.35) !important;
            }

            body[data-plan-key="premium"] .print-card {
                position: relative !important;
                border-radius: 1.35rem !important;
                border: 1px solid rgba(99, 102, 241, 0.25) !important;
                background: linear-gradient(180deg, rgba(255, 255, 255, 0.92), #f4f5ff) !important;
                box-shadow: 0 12px 45px rgba(15, 23, 42, 0.12) !important;
                overflow: hidden !important;
                padding: 1.5rem !important;
            }

            body[data-plan-key="premium"] .print-card::before {
                content: '';
                position: absolute;
                inset: 0;
                background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.18), transparent 55%);
                opacity: 0.8;
                pointer-events: none;
            }

            body[data-plan-key="premium"] .print-card>* {
                position: relative;
                z-index: 1;
            }

            body[data-plan-key="premium"] .premium-chip {
                background: rgba(99, 102, 241, 0.1) !important;
                border-color: rgba(99, 102, 241, 0.25) !important;
                color: #312e81 !important;
            }

            body[data-plan-key="premium"] table thead {
                background: rgba(79, 70, 229, 0.08) !important;
                color: #312e81 !important;
            }

            body[data-plan-key="premium"] table tbody tr:nth-child(odd) {
                background: rgba(99, 102, 241, 0.02) !important;
            }

            body[data-plan-key="premium"] table td,
            body[data-plan-key="premium"] table th {
                border-color: rgba(99, 102, 241, 0.2) !important;
            }

            body[data-plan-key="premium"] #premium-report-section .print-card {
                border-color: rgba(99, 102, 241, 0.35) !important;
                background: linear-gradient(180deg, rgba(248, 250, 252, 0.98), rgba(224, 231, 255, 0.65)) !important;
            }

            body[data-plan-key="premium"] #premium-report-section article h2,
            body[data-plan-key="premium"] #premium-report-section article h3 {
                color: #1e1b4b !important;
            }

            body[data-plan-key="premium"] .premium-category-table {
                border-color: rgba(79, 70, 229, 0.25) !important;
                background: rgba(255, 255, 255, 0.92) !important;
            }

            body[data-plan-key="premium"] .premium-stat-grid {
                background: rgba(79, 70, 229, 0.05) !important;
                border-color: rgba(79, 70, 229, 0.25) !important;
            }

            body[data-plan-key="premium"] #premium-report-section {
                gap: 2.25rem !important;
            }
        }


        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #f3f4f6;
            z-index: 50;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 p-4 md:p-8 pb-20">

    <!-- Login -->
    <div id="login-screen" class="flex flex-col justify-center items-center p-4 overflow-y-auto">
        <div
            class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md flex flex-col items-center border border-gray-100">
            <div class="mb-6 bg-indigo-100 p-3 rounded-full"><i class="fas fa-wallet text-3xl text-indigo-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Flux.io</h1>
            <p class="text-gray-500 mb-8 text-center">Gesto Financeira Inteligente</p>
            <div id="auth-loading" class="flex flex-col items-center">
                <div class="loader"></div>
                <p class="text-gray-500 text-sm">Conectando...</p>
            </div>
            <div id="auth-buttons" class="hidden flex flex-col items-center w-full space-y-4">
                <button id="google-login-btn"
                    class="w-full bg-white text-gray-700 font-semibold py-3 px-6 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center space-x-3 hover:bg-gray-50 transition-all">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6"
                        alt="Google Logo"><span>Entrar com Google</span>
                </button>
                <div id="login-error-container" class="hidden mt-6 w-full">
                    <p id="login-error-msg" class="text-sm text-red-600 mt-1 text-center font-bold"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="period-transition-overlay">
        <div class="period-loader">
            <h4>Atualizando</h4>
            <div class="period-loading-dots"><span></span><span></span><span></span></div>
            <p id="period-transition-label">Novo perodo</p>
        </div>
    </div>

    <!-- App Content -->
    <div id="app-content" class="max-w-7xl mx-auto hidden">
        <header class="mb-6 no-print flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-indigo-600"></i> Flux.io
                    <span id="plan-badge"
                        class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full border border-yellow-200 hidden">PREMIUM</span>
                </h1>
                <p class="text-sm text-gray-500 mt-1">Conta: <span id="user-email-display"
                        class="font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded">...</span></p>
            </div>
            <div class="flex items-center gap-3">
                <button type="button" class="theme-toggle-btn" aria-pressed="false" data-theme-toggle>
                    <i class="fas fa-moon" data-theme-icon></i>
                    <span data-theme-label>Modo escuro</span>
                </button>
                <button onclick="window.openSettingsModal()"
                    class="p-2 rounded-full bg-white border border-gray-200 text-gray-600 hover:text-indigo-600 transition-all shadow-sm"
                    title="Configuraes"><i class="fas fa-cog"></i></button>
                <button id="privacy-toggle-btn" type="button" data-privacy-toggle
                    class="p-2 rounded-full bg-white border border-gray-200 text-gray-500 hover:text-indigo-600 transition-all shadow-sm"><i
                        class="fas fa-eye"></i></button>
                <button id="logout-btn"
                    class="text-sm text-gray-500 hover:text-red-600 flex items-center bg-white px-3 py-2 rounded border border-gray-200 shadow-sm transition-colors"><i
                        class="fas fa-sign-out-alt mr-2"></i> Sair</button>
            </div>
        </header>

        <div id="plan-restrictions-banner" class="plan-banner hidden no-print">
            <div>
                <h3 id="plan-restrictions-title">Plano Essencial</h3>
                <p class="plan-upgrade-copy">Voc est utilizando o plano limitado. Desbloqueie recursos avanados e
                    limites ilimitados ao migrar para o Premium.</p>
                <ul id="plan-restrictions-highlights"></ul>
            </div>
            <div class="plan-banner-cta-wrapper">
                <span class="plan-status-pill">LIMITADO</span>
                <button type="button" onclick="window.openPremiumModal()"><i class="fas fa-lock-open"></i> Seja
                    Premium</button>
            </div>
        </div>

        <!-- Filtros -->
        <div id="filter-controls" class="no-print mb-6">
            <div class="bg-white border border-gray-200 rounded-xl shadow-md p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                    <div>
                        <p class="text-[11px] font-semibold uppercase tracking-[0.4em] text-gray-400">Filtros
                            principais</p>
                        <h2 class="text-2xl font-semibold text-gray-800">Configure o perodo do relatrio</h2>
                        <p class="text-sm text-gray-500">Escolha ms, ano e controle a privacidade dos cartes de
                            renda e saldo.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:flex-wrap gap-3 w-full md:w-auto">
                        <button id="print-button"
                            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center justify-center space-x-2 transition-colors"><i
                                class="fas fa-print mr-2"></i> Imprimir completo</button>
                        <button id="print-basic-button" data-plan-section="premium"
                            class="flex-1 hidden border border-indigo-200 text-indigo-700 hover:bg-indigo-50 font-medium py-2 px-4 rounded-md shadow flex items-center justify-center space-x-2 transition-colors"><i
                                class="fas fa-file-lines mr-2"></i> PDF simplificado</button>
                        <button id="export-csv-button"
                            class="flex-1 border border-gray-200 text-gray-700 hover:bg-gray-50 font-medium py-2 px-4 rounded-md shadow flex items-center justify-center space-x-2 transition-colors"><i
                                class="fas fa-download mr-2"></i> Exportar ms (CSV)</button>
                        <button id="annual-report-button"
                            class="flex-1 border border-indigo-200 text-indigo-700 hover:bg-indigo-50 font-medium py-2 px-4 rounded-md shadow flex items-center justify-center space-x-2 transition-colors"><i
                                class="fas fa-chart-line mr-2"></i> Relatrio anual</button>
                    </div>
                </div>
                <div class="grid gap-6 md:grid-cols-3 items-end">
                    <div class="md:col-span-2">
                        <div class="period-select-wrapper">
                            <button type="button" class="period-nav-btn" data-period-nav="primary" data-direction="-1"
                                aria-label="Ms anterior">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="period-select-columns">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Ms</label>
                                    <select id="month-select"
                                        class="mt-1 block w-full pl-3 pr-8 py-2 text-base border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Ano</label>
                                    <select id="year-select"
                                        class="mt-1 block w-full pl-3 pr-8 py-2 text-base border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"></select>
                                </div>
                            </div>
                            <button type="button" class="period-nav-btn" data-period-nav="primary" data-direction="1"
                                aria-label="Prximo ms">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center md:justify-end">
                        <label for="toggle-income-checkbox"
                            class="flex items-center gap-3 text-sm text-gray-600 cursor-pointer select-none">
                            Mostrar Renda e Saldo
                            <span class="relative inline-flex items-center">
                                <input id="toggle-income-checkbox" type="checkbox" class="sr-only peer">
                                <span
                                    class="w-12 h-6 rounded-full bg-gray-200 peer-checked:bg-indigo-500 transition-colors"></span>
                                <span
                                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow peer-checked:translate-x-6 transition-transform"></span>
                            </span>
                        </label>
                    </div>
                </div>
                <div id="premium-extras-toggle" class="premium-extra-toggle no-print hidden mt-6"
                    data-plan-section="premium" data-premium-extras-wrapper="true">
                    <div>
                        <h4>Insights avanados no dashboard</h4>
                        <p>Essas sees adicionais j saem no PDF. Ative se quiser v-las em tempo real na tela.</p>
                    </div>
                    <label class="premium-extra-switch" for="premium-extras-checkbox">
                        <input type="checkbox" id="premium-extras-checkbox" role="switch" aria-checked="false"
                            aria-label="Exibir extras premium" data-premium-extras-checkbox>
                        Mostrar agora
                    </label>
                </div>
            </div>
        </div>

        <div id="sticky-period-bar" class="no-print">
            <div id="sticky-period-inner">
                <div class="max-w-7xl mx-auto px-4 sticky-inner-content">
                    <div>
                        <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-gray-400">Perodo
                            selecionado</p>
                        <div class="sticky-trigger-wrapper">
                            <button type="button" id="sticky-period-trigger" class="sticky-trigger">
                                <span id="sticky-period-label" class="period-chip">--</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div id="sticky-period-picker" class="sticky-picker hidden">
                                <div class="period-select-wrapper compact">
                                    <button type="button" class="period-nav-btn" data-period-nav="sticky"
                                        data-direction="-1" aria-label="Ms anterior">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="period-select-columns">
                                        <label
                                            class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide">Ms
                                            <select id="sticky-month-select" class="picker-select"></select>
                                        </label>
                                        <label
                                            class="text-[11px] font-semibold text-gray-500 uppercase tracking-wide">Ano
                                            <select id="sticky-year-select" class="picker-select"></select>
                                        </label>
                                    </div>
                                    <button type="button" class="period-nav-btn" data-period-nav="sticky"
                                        data-direction="1" aria-label="Prximo ms">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <p class="mt-2 text-[11px] text-gray-400">Escolha o ms e ano e eles sero aplicados
                                    automaticamente.</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 flex-wrap justify-end">
                        <div class="sticky-extra-toggle hidden no-print" data-plan-section="premium"
                            data-premium-extras-wrapper="true">
                            <span
                                class="text-[10px] font-semibold uppercase tracking-[0.35em] text-indigo-900">Extras</span>
                            <label class="premium-extra-switch compact" for="premium-extras-checkbox-sticky">
                                <input type="checkbox" id="premium-extras-checkbox-sticky" role="switch"
                                    aria-checked="false" aria-label="Exibir extras premium no sticky"
                                    data-premium-extras-checkbox>
                                Ver agora
                            </label>
                        </div>
                        <button type="button" class="theme-toggle-btn theme-toggle-btn-compact" aria-pressed="false"
                            data-theme-toggle>
                            <i class="fas fa-moon" data-theme-icon></i>
                            <span data-theme-label>Modo escuro</span>
                        </button>
                        <button type="button" id="sticky-privacy-toggle-btn" class="sticky-privacy-btn"
                            data-privacy-toggle aria-label="Alternar privacidade" title="Alternar privacidade">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" id="sticky-add-expense-btn" class="sticky-add-btn">
                            <i class="fas fa-plus"></i>
                            <span>Nova despesa</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="print-area" class="period-fade-group">
            <div id="premium-print-header" class="premium-print-header print-only">
                <div>
                    <p class="eyebrow text-white/70">Flux.io Premium</p>
                    <h1>Relatrio Executivo</h1>
                    <p>Planejamento financeiro inteligente e personalizado para o casal.</p>
                </div>
                <div class="header-meta">
                    <div>
                        <span class="label">Conta</span>
                        <span id="print-header-email" class="value"></span>
                    </div>
                    <div>
                        <span class="label">Emitido em</span>
                        <span id="print-header-date" class="value"></span>
                    </div>
                    <div>
                        <span class="label">Perodo</span>
                        <span id="print-header-period" class="value"></span>
                    </div>
                </div>
            </div>

            <div class="print-section-heading mb-8">
                <div>
                    <p class="eyebrow">Resumo mensal</p>
                    <h2 id="print-title">Relatrio Mensal</h2>
                    <p>Dados consolidados do perodo selecionado, prontos para envio e impresso.</p>
                </div>
                <div class="text-right">
                    <p class="text-xs uppercase tracking-[0.3em] text-gray-400">Preparado via</p>
                    <p class="text-lg font-semibold text-indigo-700">Flux Premium</p>
                </div>
            </div>

            <!-- Cards Resumo -->
            <div class="mb-8">
                <!-- Cards Principais -->
                <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div id="card-income" class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-sm font-medium text-green-600">Renda Total</h2>
                        <p id="total-income" class="money-display text-3xl font-semibold text-gray-900 mt-2">R$ 0,00</p>
                    </div>
                    <div
                        class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200 relative overflow-hidden">
                        <h2 class="text-sm font-medium text-red-600">Despesa Total</h2>
                        <p id="total-expense" class="money-display text-3xl font-semibold text-gray-900 mt-2">R$ 0,00
                        </p>
                        <div id="expense-comparison"
                            class="absolute bottom-2 right-4 text-xs font-medium hidden no-print"><span
                                id="comparison-icon"></span> <span id="comparison-text"></span> vs ms ant.</div>
                    </div>
                    <div id="card-balance" class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-sm font-medium text-blue-600">Saldo</h2>
                        <p id="total-balance" class="money-display text-3xl font-semibold mt-2 text-gray-900">R$ 0,00
                        </p>
                    </div>

                    <!-- Cards Dinmicos (Tipos de Gastos) -->
                    <div id="dynamic-cards-container" class="contents"></div>
                </div>

                <!-- Card Acerto de Contas (Restaurado e Aprimorado) -->
                <div id="settlement-container"
                    class="print-card bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Acerto de Contas (Compartilhados)</h2>
                    <div id="settlement-content" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center md:text-left">
                        <p class="text-sm text-gray-500">Calculando...</p>
                    </div>
                </div>
            </div>

            <div class="print-section-heading premium mb-8" data-plan-section="premium" data-premium-extra="true">
                <div>
                    <p class="eyebrow">Flux Premium</p>
                    <h2 class="text-2xl font-semibold">Inteligncia avanada</h2>
                    <p>Camada estratgica com previses, alertas e benchmarks para o PDF premium.</p>
                </div>
                <div class="text-right">
                    <p class="text-xs uppercase tracking-[0.3em] text-white/70">Cobertura</p>
                    <p class="text-base font-semibold">Casal completo</p>
                </div>
            </div>

            <div id="premium-report-section" class="premium-report-section mb-10 hidden" data-plan-section="premium"
                data-premium-extra="true">
                <div class="grid gap-6 md:grid-cols-2">
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Resumo Premium</h2>
                            <span id="premium-month-label" class="premium-chip text-xs uppercase">Ms atual</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">Pessoas monitoradas</p>
                        <ul id="premium-people-list" class="premium-people-list">
                            <li class="premium-empty">Sem pessoas cadastradas.</li>
                        </ul>
                    </article>
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Sugestes</h2>
                            <span class="premium-chip text-xs uppercase">Metas & limites</span>
                        </div>
                        <ul id="premium-suggestions-list" class="premium-suggestions">
                            <li class="premium-empty">Nenhuma recomendao no momento.</li>
                        </ul>
                    </article>
                </div>

                <div class="grid gap-6 lg:grid-cols-2">
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Gastos por pessoa</h3>
                            <span class="premium-chip text-xs uppercase">Participao</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500">Pessoa</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Pagou</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Consumiu</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Diferena</th>
                                    </tr>
                                </thead>
                                <tbody id="person-breakdown-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </article>
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Distribuio visual</h3>
                            <span class="premium-chip text-xs uppercase">Por pessoa</span>
                        </div>
                        <div class="h-64">
                            <canvas id="person-spending-chart"></canvas>
                        </div>
                    </article>
                </div>

                <div class="grid gap-6 lg:grid-cols-2">
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Tipos de gasto</h3>
                            <span class="premium-chip text-xs uppercase">Top tipos</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500">Tipo</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="type-breakdown-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </article>
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Distribuio por tipo</h3>
                            <span class="premium-chip text-xs uppercase">Viso rpida</span>
                        </div>
                        <div class="type-chart-wrapper">
                            <canvas id="type-breakdown-chart"></canvas>
                        </div>
                    </article>
                </div>

                <div class="grid gap-6 lg:grid-cols-2">
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Variao por categoria</h3>
                            <span id="premium-comparison-label" class="premium-chip text-xs uppercase">Sem
                                histrico</span>
                        </div>
                        <ul id="category-variation-list" class="premium-variation-list">
                            <li class="premium-empty">Carregando anlise...</li>
                        </ul>
                    </article>
                    <article class="print-card premium-palette-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Resumo de limites</h3>
                            <span class="premium-chip text-xs uppercase">Status</span>
                        </div>
                        <div id="premium-budget-summary" class="space-y-3 text-sm text-gray-600">
                            <p class="premium-empty">Nenhum limite configurado.</p>
                        </div>
                    </article>
                </div>

                <div id="premium-print-hero" class="print-card premium-print-hero hidden" data-plan-section="premium"
                    data-premium-extra="true">
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <span class="premium-print-pill"><i class="fas fa-crown"></i> Flux Premium</span>
                                <h2 class="mt-2">Insights avanados do ms</h2>
                                <p class="text-sm text-white/80">Resumo dedicado com projees, ticket mdio e
                                    compromisso de recorrncias.</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs uppercase tracking-[0.3em] text-white/70">Perodo</span>
                                <p id="premium-print-hero-period" class="text-2xl font-semibold"></p>
                            </div>
                        </div>
                        <div class="premium-print-metrics">
                            <div>
                                <span class="label">Ticket mdio por despesa</span>
                                <span id="premium-print-ticket" class="value money-display">R$ 0,00</span>
                            </div>
                            <div>
                                <span class="label">Alimentao por dia</span>
                                <span id="premium-print-food" class="value money-display">R$ 0,00</span>
                            </div>
                            <div>
                                <span class="label">Recorrncias comprometidas</span>
                                <span id="premium-print-forecast" class="value money-display">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="premium-advanced-single">
                    <article class="print-card premium-advanced-card bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Inteligncia por categoria</h3>
                                <p class="text-sm text-gray-500">Panorama de volume, categorias ativas e lderes do ms.
                                </p>
                            </div>
                            <span class="premium-chip text-xs uppercase">Atual</span>
                        </div>
                        <div id="category-analytics-summary" class="premium-stat-grid"></div>
                        <div class="premium-category-table">
                            <table class="premium-table-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500">Categoria</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Lanamentos</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Total</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Mdia por lanamento
                                        </th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">% do ms</th>
                                    </tr>
                                </thead>
                                <tbody id="category-analytics-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </article>
                </div>

                <div class="premium-advanced-grid">
                    <article class="print-card premium-advanced-card bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Frequncia de alimentao</h3>
                                <p class="text-sm text-gray-500">Monitoramento dirio de refeies, delivery e mercado.
                                </p>
                            </div>
                            <span class="premium-chip text-xs uppercase">Dirio</span>
                        </div>
                        <div class="h-56">
                            <canvas id="food-daily-chart"></canvas>
                        </div>
                        <ul id="food-daily-stats" class="food-insights-list">
                            <li>Coletando histrico...</li>
                        </ul>
                    </article>
                    <article class="print-card premium-advanced-card bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex flex-col gap-3 mb-4">
                            <div class="flex items-center justify-between gap-3">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Comparativo com ltimos meses</h3>
                                    <p class="text-sm text-gray-500">Veja quais categorias esto acima da mdia.</p>
                                </div>
                                <label class="text-xs font-semibold text-gray-500 flex flex-col text-right">
                                    Janela (meses)
                                    <select id="premium-trend-window"
                                        class="mt-1 border border-gray-200 rounded-lg px-2 py-1 text-sm">
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6" selected>6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500">Comparao usa a mdia do perodo selecionado (excluindo o
                                ms atual).</p>
                        </div>
                        <div class="h-56">
                            <canvas id="category-trend-chart"></canvas>
                        </div>
                        <div id="category-trend-summary" class="premium-chart-legend"></div>
                    </article>
                </div>

                <div class="premium-advanced-grid">
                    <article class="print-card premium-advanced-card bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Compromissos recorrentes</h3>
                                <p class="text-sm text-gray-500">Evoluo dos gastos fixos e indefinidos para os
                                    prximos meses.</p>
                            </div>
                            <span class="premium-chip text-xs uppercase">At 24 meses</span>
                        </div>
                        <div class="h-56">
                            <canvas id="recurring-forecast-chart"></canvas>
                        </div>
                        <div id="recurring-forecast-summary" class="premium-chart-legend"></div>
                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500">Competncia</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Comprometido</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Indefinido</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500">Ocorrncias</th>
                                    </tr>
                                </thead>
                                <tbody id="recurring-forecast-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </article>
                </div>
            </div>

            <!-- Metas -->
            <div id="goals-section" class="mb-10 no-print space-y-6" data-plan-section="premium">
                <div class="goal-hero">
                    <div class="flex flex-col lg:flex-row justify-between gap-6">
                        <div>
                            <p class="text-xs font-semibold tracking-[0.4em] uppercase text-violet-100 mb-2">Metas &
                                Sonhos</p>
                            <h2 class="text-3xl font-semibold text-white mb-4">Planeje seus grandes momentos com
                                disciplina inteligente.</h2>
                            <div class="goal-metrics">
                                <div class="goal-metric">
                                    <p class="text-xs text-violet-100 uppercase tracking-wide">Guardado</p>
                                    <span id="goal-total-saved" class="money-display">R$ 0,00</span>
                                </div>
                                <div class="goal-metric">
                                    <p class="text-xs text-violet-100 uppercase tracking-wide">Alvo combinado</p>
                                    <span id="goal-total-target" class="money-display">R$ 0,00</span>
                                </div>
                                <div class="goal-metric">
                                    <p class="text-xs text-violet-100 uppercase tracking-wide">Progresso mdio</p>
                                    <span id="goal-total-progress">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col gap-3">
                            <label
                                class="text-xs font-semibold uppercase tracking-[0.3em] text-violet-100">Sugestes</label>
                            <select id="goal-suggestion-select" class="goal-suggestion-select text-sm"></select>
                            <p id="goal-suggestion-description" class="text-xs text-violet-100/80 italic leading-snug">
                                Escolha uma inspirao rpida para preencher a nova meta automaticamente.</p>
                            <div class="flex flex-wrap gap-3">
                                <button id="goal-suggestion-apply"
                                    class="px-4 py-2 rounded-full bg-white/20 text-white text-sm font-semibold hover:bg-white/30 transition">
                                    Vamos l!
                                </button>
                                <button onclick="window.openGoalModal()"
                                    class="px-4 py-2 rounded-full bg-white text-indigo-600 text-sm font-semibold shadow-lg flex items-center gap-2"><i
                                        class="fas fa-plus"></i> Prefiro fazer do meu jeito</button>
                            </div>
                        </div>
                    </div>
                </div>
                <p id="plan-limit-message-goals" class="plan-limit-message hidden"><i class="fas fa-lock"></i> Limite de
                    metas atingido no seu plano atual.</p>
                <div id="goals-container" class="goal-grid"></div>
            </div>

            <div class="plan-locked-card no-print mb-10" data-plan-section="essential">
                <h3><i class="fas fa-lock"></i>Metas &amp; Sonhos  exclusivo do Premium</h3>
                <p>Desbloqueie metas ilimitadas, sugestes inteligentes e acompanhamento completo para planejar os
                    grandes objetivos do casal.</p>
                <button type="button" onclick="window.openPremiumModal()"><i class="fas fa-crown"></i>Assinar
                    Premium</button>
            </div>

            <!-- Budgets -->
            <div id="budgets-section" class="mb-12 no-print space-y-6" data-plan-section="premium">
                <div class="budget-hero">
                    <div class="budget-hero-top">
                        <div>
                            <p class="budget-label">Oramento Mensal</p>
                            <h2>Controle seus limites com alertas inteligentes e visibilidade instantnea.</h2>
                            <p>Combine limites, acompanhe o ritmo de gastos e desbloqueie avisos antes de estourar o
                                ms.</p>
                        </div>
                        <div class="budget-hero-actions">
                            <button onclick="window.openBudgetModal()"><i class="fas fa-plus"></i> Novo limite</button>
                        </div>
                    </div>
                    <div class="budget-metrics">
                        <div class="budget-metric">
                            <p>Limites ativos</p>
                            <span id="budget-total-limit" class="money-display">R$ 0,00</span>
                        </div>
                        <div class="budget-metric">
                            <p>Gasto monitorado</p>
                            <span id="budget-total-spent" class="money-display">R$ 0,00</span>
                        </div>
                        <div class="budget-metric">
                            <p>Alertas</p>
                            <button id="budget-alerts-trigger" type="button" class="budget-alert-button"
                                aria-disabled="true">
                                <span id="budget-alert-count">0</span>
                                <small>Ver detalhes</small>
                            </button>
                        </div>
                    </div>
                    <div class="budget-legend">
                        <span class="legend-item"><span class="legend-dot safe"></span>Em dia (&lt; 75%)</span>
                        <span class="legend-item"><span class="legend-dot warning"></span>Alerta (75-95%)</span>
                        <span class="legend-item"><span class="legend-dot danger"></span>Crtico (&gt; 95%)</span>
                    </div>
                </div>
                <p id="plan-limit-message-budgets" class="plan-limit-message hidden"><i class="fas fa-lock"></i> Limite
                    de oramentos atingido no seu plano atual.</p>
                <div id="budgets-container" class="budget-grid"></div>
            </div>

            <div class="plan-locked-card no-print mb-12" data-plan-section="essential">
                <h3><i class="fas fa-lock"></i>Oramento Mensal liberado no Premium</h3>
                <p>Crie limites por categoria, receba alertas preventivos e veja quem est gastando mais antes de
                    estourar o ms.</p>
                <button type="button" onclick="window.openPremiumModal()"><i class="fas fa-crown"></i>Seja
                    Premium</button>
            </div>

            <!-- Grficos -->
            <div id="statistics-section" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Anlise de Gastos</h2>
                <div id="statistics-content" class="flex flex-col md:flex-row items-center justify-between gap-8">
                    <div id="chart-wrapper" class="w-full md:w-1/2 h-64 md:h-80 flex justify-center"><canvas
                            id="expenseChart"></canvas></div>
                    <div id="table-wrapper" class="w-full md:w-1/2 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Categoria</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Valor (R$)</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">%</th>
                                </tr>
                            </thead>
                            <tbody id="category-stats-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Formulrios -->
            <div id="forms-section" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div id="expense-form-inline-mount" class="no-print h-full">
                    <div id="expense-form-card"
                        class="bg-white p-6 rounded-lg shadow-md border border-gray-200 relative h-full flex flex-col">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4"><span id="expense-form-title">Adicionar
                                Despesa</span></h2>
                        <form id="expense-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Descrio</label>
                                <input type="text" id="expense-desc" required
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                    <input type="text" id="expense-amount" data-money-input="true" inputmode="numeric"
                                        autocomplete="off" placeholder="0,00" required
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 flex items-center gap-2">Data
                                        <span class="tooltip-group">
                                            <button type="button" class="tooltip-trigger"
                                                aria-describedby="expense-date-tooltip">i</button>
                                            <span id="expense-date-tooltip" role="tooltip" class="tooltip-panel">
                                                <strong id="expense-tooltip-month-label">Ms atual</strong>: os
                                                lanamentos entram no ms filtrado mesmo que a data seja anterior.
                                                Para
                                                registrar em outro ms, altere o filtro l em cima.
                                            </span>
                                        </span>
                                    </label>
                                    <input type="date" id="expense-date" required
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Categoria</label>
                                    <select id="expense-category"
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                                        <option>Moradia</option>
                                        <option>Alimentao</option>
                                        <option>Mercado</option>
                                        <option>Transporte</option>
                                        <option>Lazer</option>
                                        <option>Sade</option>
                                        <option>Investimentos</option>
                                        <option>Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Quem Pagou?</label>
                                    <select id="expense-paid-by"
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></select>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo de Gasto</label>
                                    <select id="expense-sharing-type"
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm"
                                        onchange="window.handleTypeChange()"></select>
                                </div>
                                <div id="split-container" class="hidden mt-2">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Diviso do Custo:</span>
                                        <span id="split-display" class="font-bold">50% / 50%</span>
                                    </div>
                                    <input type="range" id="split-slider" min="0" max="100" value="50"
                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                    <div class="flex items-center justify-between mt-2 text-xs text-gray-600">
                                        <div id="split-presets" class="flex gap-1">
                                            <button type="button" data-value="0"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">0%</button>
                                            <button type="button" data-value="25"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">25%</button>
                                            <button type="button" data-value="50"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">50%</button>
                                            <button type="button" data-value="75"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">75%</button>
                                            <button type="button" data-value="100"
                                                class="split-preset-btn px-2 py-0.5 border border-gray-200 rounded-full hover:border-indigo-400">100%</button>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <input type="number" id="split-manual-input" min="0" max="100" value="50"
                                                class="w-16 border border-gray-200 rounded px-2 py-1 text-xs text-right">
                                            <span class="text-[11px] text-gray-500">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="beneficiary-container" class="hidden mt-2">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">De quem  o
                                        gasto?</label>
                                    <select id="expense-beneficiary"
                                        class="block w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm"></select>
                                </div>
                            </div>

                            <div class="p-3 bg-gray-50 rounded border border-gray-100 relative" id="recurrence-section">
                                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    Recorrncia
                                    <span
                                        class="text-[10px] font-semibold text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded-full"
                                        id="recurrence-premium-chip">Premium</span>
                                </label>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <select id="expense-recurrence-type"
                                        class="block w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm"
                                        onchange="window.toggleRecurrenceInput()">
                                        <option value="none">Apenas este ms</option>
                                        <option value="fixed">Fixo (parcelado)</option>
                                        <option value="indefinite">Indefinido (Fixo Mensal)</option>
                                    </select>
                                    <div id="recurrence-months-input" class="hidden w-1/3">
                                        <input type="number" id="expense-recurrence-months" placeholder="Meses" min="2"
                                            max="60" value="12"
                                            class="w-full border-gray-300 rounded-md shadow-sm p-2 border text-sm">
                                    </div>
                                </div>
                                <div id="recurrence-premium-mask"
                                    class="hidden absolute inset-0 rounded border border-dashed border-indigo-200 bg-white/90 backdrop-blur-[2px] flex flex-col items-center justify-center text-center px-4">
                                    <p class="text-xs font-semibold text-gray-600 mb-2">Recorrncias fazem parte do
                                        Flux
                                        Premium.</p>
                                    <button type="button" onclick="window.openPremiumModal()"
                                        class="text-xs font-semibold text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded-full flex items-center gap-2">
                                        <i class="fas fa-crown text-amber-300"></i> Conhecer Premium
                                    </button>
                                </div>
                            </div>

                            <div class="flex flex-col sm:flex-row gap-3">
                                <button type="submit" id="expense-submit-btn"
                                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition-colors">Adicionar
                                    Despesa</button>
                                <button type="button" id="expense-cancel-btn"
                                    class="hidden flex-none bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm"
                                    onclick="window.cancelEditExpense()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="form-container-income"
                    class="bg-white p-6 rounded-lg shadow-md border border-gray-200 no-print h-full flex flex-col">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4"><span id="income-form-title">Adicionar
                            Renda</span></h2>
                    <form id="income-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Descrio</label>
                            <input type="text" id="income-desc" required
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <input type="text" id="income-amount" data-money-input="true" inputmode="numeric"
                                    autocomplete="off" placeholder="0,00" required
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 flex items-center gap-2">Data
                                    <span class="tooltip-group">
                                        <button type="button" class="tooltip-trigger"
                                            aria-describedby="income-date-tooltip">i</button>
                                        <span id="income-date-tooltip" role="tooltip" class="tooltip-panel">
                                            <strong id="income-tooltip-month-label">Ms atual</strong>: rendas
                                            entram no ms filtrado. Para registr-las em outro ms, ajuste o filtro
                                            principal.
                                        </span>
                                    </span>
                                </label>
                                <input type="date" id="income-date" required
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fonte</label>
                            <select id="income-source"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></select>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button type="submit" id="income-submit-btn"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition-colors">Adicionar
                                Renda</button>
                            <button type="button" id="income-cancel-btn"
                                class="hidden flex-none bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm"
                                onclick="window.cancelEditIncome()">Cancelar</button>
                        </div>
                    </form>
                </div>

            </div>



            <div id="table-container-income"
                class="bg-white p-6 rounded-lg shadow-md border border-gray-200 self-start md:col-span-2">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Rendas do Ms</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Descrio</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Valor</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Fonte</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase no-print">
                                    Ao</th>
                            </tr>
                        </thead>
                        <tbody id="income-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <section class="mt-8 bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
                <div>
                    <p class="text-xs font-semibold tracking-[0.4em] uppercase text-indigo-400">Lista
                        detalhada</p>
                    <h2 class="text-2xl font-semibold text-gray-800">Despesas do Ms</h2>
                    <p class="text-sm text-gray-500">Veja cada lanamento e acompanhe totais, quantidade
                        e picos do ms selecionado.</p>
                </div>
                <div class="flex flex-wrap gap-3 text-sm">
                    <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-[11px] uppercase tracking-wide text-gray-500">Total listado</p>
                        <span id="expense-insight-total" class="text-lg font-semibold text-gray-900">R$
                            0,00</span>
                    </div>
                    <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-[11px] uppercase tracking-wide text-gray-500">Itens registrados</p>
                        <span id="expense-insight-count" class="text-lg font-semibold text-gray-900">0</span>
                    </div>
                    <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-[11px] uppercase tracking-wide text-gray-500">Maior gasto</p>
                        <span id="expense-insight-top" class="text-lg font-semibold text-gray-900">R$
                            0,00</span>
                    </div>
                </div>
            </div>
            <div id="expense-empty-state"
                class="hidden mt-6 border border-dashed border-gray-300 rounded-lg p-6 text-center text-sm text-gray-500">
                Nenhuma despesa registrada para o perodo selecionado. Lance uma nova despesa para comear
                a acompanhar.
            </div>
            <div id="expense-table-container" class="mt-6">
                <div class="overflow-x-auto border border-gray-100 rounded-xl shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Descrio</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Valor</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Data</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Categoria</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Tipo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    Pago por</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase no-print">
                                    Ao</th>
                            </tr>
                        </thead>
                        <tbody id="expense-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <div class="mt-8 flex flex-col items-center space-y-4 no-print">
            <button onclick="document.getElementById('import-file-input').click()"
                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2"><i
                    class="fas fa-file-import"></i> Importar Extrato (CSV)</button>
            <input type="file" id="import-file-input" class="hidden" accept=".csv"
                onchange="window.handleImportCSV(this)">
            <button onclick="window.migrateData()" class="text-xs text-gray-400 hover:text-gray-600 underline">Importar
                dados do perfil antigo para o
                compartilhado</button>
        </div>
    </div>
    </div>

    <div id="plan-restriction-toast" class="plan-restriction-toast hidden">
        <span id="plan-restriction-toast-text"></span>
        <button type="button" id="plan-restriction-toast-close" aria-label="Fechar aviso"><i
                class="fas fa-times"></i></button>
    </div>

    <!-- MODAL PREMIUM -->
    <div id="modal-premium" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="w-full h-full flex items-start justify-center overflow-y-auto p-4 sm:p-6">
            <div
                class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl modal-content border border-gray-100 flex flex-col">
                <div class="overflow-hidden rounded-3xl flex flex-col max-h-[95vh]">
                    <div
                        class="relative bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 text-white p-5 sm:p-8">
                        <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-white/70">Flux Premium
                                </p>
                                <h2 class="text-2xl sm:text-3xl font-extrabold leading-tight mt-2">Controle completo
                                    para o casal organizar tudo em um s lugar</h2>
                                <p class="text-sm text-white/85 mt-2 max-w-xl">Desbloqueie alertas inteligentes,
                                    metas ilimitadas, relatrios exclusivos e modo premium com um toque.</p>
                            </div>
                            <div class="text-left sm:text-right">
                                <p class="text-xs uppercase tracking-wide text-white/70">Lanamento</p>
                                <div class="flex items-baseline gap-1 justify-start sm:justify-end">
                                    <span class="text-4xl font-black leading-none">R$ 24</span>
                                    <span class="text-base font-semibold">/ms</span>
                                </div>
                                <p class="text-xs text-white/80">Ativao manual enquanto o checkout no chega</p>
                            </div>
                        </div>
                        <button type="button" class="absolute top-3 right-3 text-white/80 hover:text-white"
                            onclick="window.closePremiumModal()" aria-label="Fechar modal Premium">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto min-h-0 p-5 sm:p-8 space-y-6 bg-white">
                        <section class="bg-gray-50 border border-gray-100 rounded-2xl p-4 sm:p-5">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Por que migrar
                                    agora?</h3>
                                <span
                                    class="inline-flex items-center gap-2 text-xs font-semibold text-indigo-700 bg-white px-3 py-1 rounded-full border border-indigo-100">
                                    <i class="fas fa-crown text-amber-500"></i> Exclusivo Premium
                                </span>
                            </div>
                            <ul id="premium-feature-list" class="mt-4 space-y-3"></ul>
                        </section>
                        <section class="bg-indigo-50 border border-indigo-100 rounded-2xl p-5 sm:p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div>
                                    <p class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">Comparativo
                                        dos planos</p>
                                    <p class="text-sm text-indigo-900/80">Veja tudo que o Premium libera no lugar do
                                        Essencial.</p>
                                </div>
                                <div class="flex items-center gap-3 text-sm font-semibold">
                                    <span class="flex items-center gap-2 text-indigo-700"><i
                                            class="fas fa-circle text-indigo-500 text-[6px]"></i> Essencial</span>
                                    <span
                                        class="flex items-center gap-2 bg-white/80 text-indigo-900 px-3 py-1 rounded-xl shadow-sm"><i
                                            class="fas fa-star text-amber-400"></i> Premium</span>
                                </div>
                            </div>
                            <div id="premium-plan-comparison" class="mt-5"></div>
                        </section>
                        <section class="bg-gray-50 border border-gray-100 rounded-2xl p-4 sm:p-5 space-y-3">
                            <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Como funciona?</h4>
                            <p class="text-sm text-gray-600">Voc confirma o interesse, nosso time libera o upgrade no
                                mesmo dia til e tudo aparece sincronizado para o casal.</p>
                            <ul class="text-sm text-gray-600 space-y-2">
                                <li class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"><i
                                            class="fas fa-check-circle"></i></span>Confirmamos o pedido por e-mail ou
                                    WhatsApp.</li>
                                <li class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"><i
                                            class="fas fa-check-circle"></i></span>O Premium  liberado manualmente em
                                    poucas horas.</li>
                                <li class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"><i
                                            class="fas fa-check-circle"></i></span>Voc recebe um resumo com tudo que
                                    foi habilitado.</li>
                            </ul>
                        </section>
                        <div class="flex flex-col md:flex-row gap-3">
                            <button type="button"
                                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl text-base font-semibold shadow"
                                onclick="window.requestPremiumInvite('upgrade')">
                                Entrar na lista de espera
                            </button>
                            <button type="button"
                                class="flex-1 border border-gray-200 hover:border-gray-300 text-gray-800 py-3 rounded-xl text-base font-semibold"
                                onclick="window.requestPremiumInvite('talk')">
                                Falar com o time
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 text-center">Respondemos no mesmo dia til com os prximos
                            passos.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL RECURRENCE SCOPE -->
    <div id="modal-recurrence-scope"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4 modal-content">
            <div class="flex items-center gap-3 mb-4">
                <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900" id="recurrence-modal-title">Atualizar recorrncia
                    </h2>
                    <p class="text-sm text-gray-500" id="recurrence-modal-description">Escolha como deseja aplicar as
                        alteraes.</p>
                </div>
            </div>
            <div class="space-y-3 mb-4">
                <button type="button" onclick="window.handleRecurrenceScopeChoice('single')"
                    class="w-full border border-gray-200 rounded-xl px-4 py-3 text-left hover:border-indigo-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-200">
                    <p class="text-sm font-semibold text-gray-900">Apenas esta despesa</p>
                    <p class="text-xs text-gray-500">Mantm a srie original e cria uma exceo para este ms.</p>
                </button>
                <button type="button" onclick="window.handleRecurrenceScopeChoice('future')"
                    class="w-full border border-indigo-200 bg-indigo-50 rounded-xl px-4 py-3 text-left text-indigo-900 hover:border-indigo-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-200">
                    <p class="text-sm font-semibold">Esta e as prximas</p>
                    <p class="text-xs text-indigo-700">Aplica o novo valor/data para todas as ocorrncias futuras.</p>
                </button>
            </div>
            <div class="flex justify-end">
                <button type="button" onclick="window.closeRecurrenceScopeModal()"
                    class="text-sm text-gray-500 hover:text-gray-700">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EXPENSE EDIT -->
    <div id="modal-expense-edit"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div
            class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-4 sm:p-6 m-4 modal-content max-h-[95vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Editar despesa</h2>
                    <p class="text-sm text-gray-500">Faa os ajustes necessrios e salve para atualizar o lanamento.
                    </p>
                </div>
                <button type="button" class="text-gray-500 hover:text-gray-700" onclick="window.cancelEditExpense()">
                    <span class="sr-only">Fechar</span>
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="expense-form-modal-mount"></div>
        </div>
    </div>

    <!-- MODAL SETTINGS -->
    <div id="modal-settings"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 m-4 modal-content max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-cogs"></i>
                Configuraes</h2>
            <div class="mb-6 border-b pb-6">
                <h3 class="text-sm font-bold text-gray-700 mb-2">Pessoas (Max 4)</h3>
                <div id="settings-people-list" class="space-y-2 mb-3"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-person-name" placeholder="Nome"
                        class="flex-1 border rounded px-2 py-1 text-sm">
                    <button onclick="window.addPerson()"
                        class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Adicionar</button>
                </div>
            </div>
            <div class="mb-6">
                <h3 class="text-sm font-bold text-gray-700 mb-2">Tipos de Gastos</h3>
                <div id="settings-types-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto pr-1"></div>
                <div class="bg-gray-50 p-3 rounded border">
                    <h4 id="type-form-title" class="text-xs font-semibold mb-2">Novo Tipo</h4>
                    <input type="text" id="new-type-label" placeholder="Nome"
                        class="w-full border rounded px-2 py-1 text-sm mb-2">
                    <div class="flex items-center gap-2 mb-2">
                        <label class="text-xs text-gray-600">Cor:</label>
                        <div class="flex gap-1" id="color-picker-container"></div>
                        <input type="color" id="new-type-color-picker" class="w-10 h-7 border border-gray-200 rounded"
                            value="#ffffff" title="Escolha uma cor personalizada">
                        <input type="hidden" id="new-type-color" value="#ffffff">
                    </div>
                    <div class="grid gap-2 mb-3" id="type-mode-selector">
                        <button type="button" data-type-mode-btn data-mode="shared"
                            class="type-mode-btn text-left border border-gray-200 rounded-lg p-3 bg-white text-xs text-gray-700 hover:border-indigo-300 transition">
                            <span class="block text-sm font-semibold text-gray-800">Compartilhado</span>
                            <span class="block text-[11px] text-gray-500">Exibe o slider de diviso e entra no acerto
                                entre as pessoas.</span>
                        </button>
                        <button type="button" data-type-mode-btn data-mode="individual"
                            class="type-mode-btn text-left border border-gray-200 rounded-lg p-3 bg-white text-xs text-gray-700 hover:border-indigo-300 transition">
                            <span class="block text-sm font-semibold text-gray-800">Autnomo</span>
                            <span class="block text-[11px] text-gray-500">No mostra o slider e fica fora da diviso
                                (gasto pessoal).</span>
                        </button>
                    </div>
                    <input type="hidden" id="new-type-mode" value="shared">
                    <div class="flex gap-2">
                        <button type="button" id="new-type-submit" onclick="window.addExpenseType()"
                            class="flex-1 bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700">Criar
                            Tipo</button>
                        <button type="button" id="cancel-type-edit-btn" onclick="window.cancelTypeEdit()"
                            class="hidden px-3 py-1.5 rounded text-sm bg-gray-200 text-gray-700 hover:bg-gray-300">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end"><button onclick="window.closeSettingsModal()"
                    class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Fechar</button></div>
        </div>
    </div>

    <!-- MODAL GOAL CONTRIBUTION -->
    <div id="modal-goal-contribution"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 modal-content">
            <h2 class="text-xl font-bold text-gray-800 mb-4" id="goal-contrib-title">Adicionar Aporte</h2>
            <form id="goal-contrib-form" class="space-y-4 mb-6">
                <input type="hidden" id="goal-contrib-goal-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-gray-500">Valor</label><input type="text"
                            id="goal-contrib-amount" data-money-input="true" inputmode="numeric" autocomplete="off"
                            class="w-full border rounded p-2" placeholder="0,00" required></div>
                    <div><label class="block text-xs text-gray-500">Data</label><input type="date"
                            id="goal-contrib-date" class="w-full border rounded p-2" required></div>
                    <div class="col-span-2"><label class="block text-xs text-gray-500">Quem aportou?</label><select
                            id="goal-contrib-paid-by" class="w-full border rounded p-2"></select></div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Salvar
                    Aporte</button>
            </form>
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Histrico de Aportes</h3>
            <div id="goal-history-list" class="max-h-40 overflow-y-auto text-sm border-t pt-2 space-y-2"></div>
            <div class="flex justify-end mt-4"><button type="button" onclick="window.closeGoalContribModal()"
                    class="text-gray-500 hover:text-gray-700">Fechar</button></div>
        </div>
    </div>

    <!-- MODAL BUDGET ALERTS -->
    <div id="modal-budget-alerts"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 m-4 modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <p class="text-xs uppercase tracking-[0.4em] text-indigo-400">Monitoramento</p>
                    <h2 class="text-2xl font-bold text-gray-800">Alertas de Oramento</h2>
                </div>
                <button onclick="window.closeBudgetAlertsModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Listamos apenas categorias em estado de alerta ou crtico para voc
                agir a tempo.</p>
            <div id="budget-alerts-list" class="space-y-4"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="window.closeBudgetAlertsModal()"
                    class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ANNUAL REPORT -->
    <div id="modal-annual-report"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 m-4 modal-content max-h-[92vh] overflow-y-auto">
            <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between mb-4">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.4em] text-indigo-400">Relatrios</p>
                    <h2 class="text-2xl font-bold text-gray-800">Resumo anual <span
                            id="annual-report-year-label"></span></h2>
                    <p class="text-sm text-gray-500">Consolide gastos e rendas do ano selecionado em um nico
                        lugar.</p>
                </div>
                <button type="button" onclick="window.closeAnnualReportModal()"
                    class="self-start text-gray-400 hover:text-gray-600 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="annual-report-loading"
                class="py-12 flex flex-col items-center justify-center gap-2 text-sm text-gray-500">
                <i class="fas fa-circle-notch fa-spin text-indigo-500 text-xl"></i>
                <span>Carregando dados do ano...</span>
            </div>
            <div id="annual-report-content" class="hidden space-y-6">
                <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    <div class="rounded-xl border border-gray-100 p-4 bg-gray-50">
                        <p class="text-xs font-semibold text-gray-500 uppercase">Total gasto</p>
                        <p id="annual-report-total-expense" class="text-2xl font-bold text-red-600">R$ 0,00</p>
                    </div>
                    <div class="rounded-xl border border-gray-100 p-4 bg-gray-50">
                        <p class="text-xs font-semibold text-gray-500 uppercase">Total recebido</p>
                        <p id="annual-report-total-income" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="rounded-xl border border-gray-100 p-4 bg-gray-50">
                        <p class="text-xs font-semibold text-gray-500 uppercase">Saldo do ano</p>
                        <p id="annual-report-total-balance" class="text-2xl font-bold text-gray-800">R$ 0,00</p>
                    </div>
                </div>
                <div class="grid gap-6 lg:grid-cols-2">
                    <div class="rounded-xl border border-gray-100 p-4 bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-800">Totais mensais</h3>
                            <span class="text-xs font-semibold text-gray-400 uppercase">Gasto x renda</span>
                        </div>
                        <div id="annual-report-monthly-body" class="divide-y divide-gray-100 text-sm"></div>
                    </div>
                    <div class="rounded-xl border border-gray-100 p-4 bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-800">Top categorias</h3>
                            <span class="text-xs font-semibold text-gray-400 uppercase">Participao</span>
                        </div>
                        <div id="annual-report-category-body" class="space-y-2 text-sm"></div>
                    </div>
                </div>
                <div class="rounded-xl border border-dashed border-gray-200 p-4 bg-gray-50 text-sm text-gray-600">
                    <p>Os valores so consolidados diretamente da base do ano selecionado. Para anlises adicionais,
                        exporte os dados brutos em CSV.</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="button" id="annual-report-export-button"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2">
                        <i class="fas fa-file-export"></i> Exportar CSV do ano</button>
                    <button type="button"
                        class="flex-1 border border-gray-200 text-gray-700 hover:bg-white bg-gray-50 font-semibold py-2 px-4 rounded-lg shadow-sm"
                        onclick="window.closeAnnualReportModal()">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS (Budget/Goal) -->
    <div id="modal-goal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-1" id="modal-goal-title">Nova Meta</h2>
            <form id="goal-form" class="space-y-4"><input type="hidden" id="goal-id">
                <div><label class="block text-sm font-medium text-gray-700">Nome da Meta</label><input type="text"
                        id="goal-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"
                        placeholder="Ex: Viagem Europa" required></div>
                <div><label class="block text-sm font-medium text-gray-700">Valor Alvo (R$)</label><input type="text"
                        id="goal-target" data-money-input="true" inputmode="numeric" autocomplete="off"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" placeholder="0,00"
                        required></div>
                <div><label class="block text-sm font-medium text-gray-700 flex items-center justify-between">Estratgia
                        de Aporte
                        <span class="tooltip-group">
                            <button type="button" class="tooltip-trigger"
                                aria-describedby="goal-strategy-tooltip">i</button>
                            <span id="goal-strategy-tooltip" role="tooltip" class="tooltip-panel">
                                <strong>Manual:</strong> registre aportes quando quiser.<br>
                                <strong>Valor fixo:</strong> define um valor mensal para prever o prazo.<br>
                                <strong>Porcentagem:</strong> reserva um percentual da renda automaticamente.
                            </span>
                        </span>
                    </label><select id="goal-strategy"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        <option value="manual">Manual</option>
                        <option value="fixed">Valor Fixo</option>
                        <option value="percentage">Porcentagem</option>
                    </select></div>
                <div id="goal-strategy-value-container" class="hidden"><label
                        class="block text-sm font-medium text-gray-700"
                        id="goal-strategy-value-label">Valor</label><input type="text" id="goal-strategy-value"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" autocomplete="off"
                        inputmode="decimal" placeholder="0,00">
                    <p id="goal-strategy-value-hint" class="goal-strategy-tooltip hidden"></p>
                </div>
                <div class="flex flex-col sm:flex-row sm:justify-end gap-3 mt-6"><button type="button"
                        onclick="window.closeGoalModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button><button
                        type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Salvar
                        Meta</button></div>
            </form>
        </div>
    </div>
    <div id="modal-budget"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm modal">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4 modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-1" id="modal-budget-title">Novo Limite</h2>
            <form id="budget-form" class="space-y-4"><input type="hidden" id="budget-id">
                <div><label class="block text-sm font-medium text-gray-700">Categoria</label><select
                        id="budget-category"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Limite Mensal (R$)</label><input type="text"
                        id="budget-amount" data-money-input="true" inputmode="numeric" autocomplete="off"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" placeholder="0,00"
                        required></div>
                <div class="flex flex-col sm:flex-row sm:justify-end gap-3 mt-6"><button type="button"
                        onclick="window.closeBudgetModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button><button
                        type="submit" class="px-4 py-2 text-white bg-orange-600 rounded-lg hover:bg-orange-700">Salvar
                        Limite</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, deleteDoc, getDocs, onSnapshot, query, where, getDoc, orderBy, limit, setDoc, writeBatch, startAt, endAt } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAO
        const firebaseConfig = {
            apiKey: "AIzaSyD2Mn2I9ell-bA7RZavH-JxHJid9wTDZe8",
            authDomain: "controle-gastos-c4c4d.firebaseapp.com",
            projectId: "controle-gastos-c4c4d",
            storageBucket: "controle-gastos-c4c4d.firebasestorage.app",
            messagingSenderId: "515466326654",
            appId: "1:515466326654:web:0f841817662029d12a1e2f"
        };
        const ALLOWED_EMAILS = ["eduardocarnello@gmail.com", "camilaps05@gmail.com"];
        const DB_BASE_PATH = "conta_compartilhada/dados";
        const USER_PLAN = 'premium';
        const PLAN_RULES = {
            premium: {
                key: 'premium',
                label: 'Premium',
                badgeLabel: 'PREMIUM',
                limits: { goals: Infinity, budgets: Infinity },
                features: { budgetAlerts: true },
                summary: ['Alertas inteligentes liberados', 'Metas e oramentos ilimitados', 'Experincia completa sem bloqueios']
            },
            essential: {
                key: 'essential',
                label: 'Essencial',
                badgeLabel: 'ESSENCIAL',
                limits: { goals: 2, budgets: 2 },
                features: { budgetAlerts: false },
                summary: ['At 2 metas simultneas', 'At 2 limites de oramento', 'Alertas inteligentes exclusivos do Premium']
            }
        };
        const PREMIUM_HIGHLIGHTS = [
            {
                icon: 'fa-bolt',
                title: 'Alertas inteligentes',
                description: 'Receba avisos automticos quando um gasto extrapolar o limite previsto ou quando um oramento estiver perto do estouro.'
            },
            {
                icon: 'fa-layer-group',
                title: 'Metas ilimitadas do casal',
                description: 'Crie metas simultneas, acompanhe aportes individuais e projete quanto tempo falta para realizar cada plano.'
            },
            {
                icon: 'fa-chart-pie',
                title: 'Relatrios premium',
                description: 'Relatrios anuais, comparativos por categoria e indicadores extras exclusivos para quem imprime ou exporta os dados.'
            },
            {
                icon: 'fa-shield-heart',
                title: 'Modo Premium Extra',
                description: 'Ative grficos especiais, indicadores de sade financeira do casal e camadas extras de privacidade quando quiser.'
            }
        ];
        const PLAN_COMPARISON_DETAILS = [
            {
                label: 'Metas compartilhadas',
                essential: { text: 'No disponvel no Essencial', status: 'unavailable' },
                premium: { text: 'Ilimitadas com aportes por pessoa', status: 'available' }
            },
            {
                label: 'Oramentos por categoria',
                essential: { text: 'No disponvel no Essencial', status: 'unavailable' },
                premium: { text: 'Limites inteligentes + alertas instantneos', status: 'available' }
            },
            {
                label: 'Alertas inteligentes',
                essential: { text: 'No disponvel', status: 'unavailable' },
                premium: { text: 'Avisos por e-mail/WhatsApp do casal', status: 'available' }
            },
            {
                label: 'Relatrios mensais',
                essential: { text: 'Resumo bsico manual', status: 'partial' },
                premium: { text: 'Relatrios premium com variao ms a ms', status: 'available' }
            },
            {
                label: 'Modo premium extra',
                essential: { text: 'No disponvel', status: 'unavailable' },
                premium: { text: 'Grficos exclusivos e comparativos histricos', status: 'available' }
            },
            {
                label: 'Suporte',
                essential: { text: 'Atendimento padro por e-mail', status: 'partial' },
                premium: { text: 'Suporte prioritrio no mesmo dia til', status: 'available' }
            }
        ];
        const PLAN_LIMIT_MESSAGES = {
            goals: 'Voc atingiu o limite de metas disponveis no seu plano. Faa upgrade para criar metas ilimitadas.',
            budgets: 'Voc atingiu o limite de oramentos no plano Essencial. Torne-se Premium para liberar mais categorias e alertas.'
        };
        const PREMIUM_EXTRAS_STORAGE_KEY = 'fluxPremiumExtras';
        const MIN_FIXED_RECURRENCE_MONTHS = 2;
        const MAX_FIXED_RECURRENCE_MONTHS = 60;
        const MAX_INDEFINITE_MONTHS_AHEAD = 24;
        const PRINT_CHART_IDS = ['person-spending-chart', 'type-breakdown-chart', 'food-daily-chart', 'category-trend-chart', 'recurring-forecast-chart'];
        let isPrintInProgress = false;
        const CATEGORY_ICON_MAP = {
            'moradia': 'fa-house-chimney',
            'contas (luz, agua, net)': 'fa-plug',
            'contas (luz, gua, net)': 'fa-plug',
            'mercado': 'fa-basket-shopping',
            'alimentacao': 'fa-utensils',
            'alimentao': 'fa-utensils',
            'restaurante': 'fa-burger',
            'delivery': 'fa-motorcycle',
            'transporte': 'fa-car-side',
            'carro': 'fa-car',
            'combustivel': 'fa-gas-pump',
            'combustvel': 'fa-gas-pump',
            'uber': 'fa-taxi',
            'taxi': 'fa-taxi',
            'lazer': 'fa-champagne-glasses',
            'saude': 'fa-heart-pulse',
            'sade': 'fa-heart-pulse',
            'farmacia': 'fa-prescription-bottle-medical',
            'farmcia': 'fa-prescription-bottle-medical',
            'presentes': 'fa-gift',
            'educacao': 'fa-graduation-cap',
            'educao': 'fa-graduation-cap',
            'assinaturas/streaming': 'fa-tv',
            'assinaturas': 'fa-tv',
            'telefonia': 'fa-phone',
            'internet': 'fa-wifi',
            'energia': 'fa-bolt',
            'gua': 'fa-droplet',
            'agua': 'fa-droplet',
            'gs': 'fa-fire',
            'gas': 'fa-fire',
            'pet': 'fa-paw',
            'beleza/estetica': 'fa-wand-magic-sparkles',
            'beleza/esttica': 'fa-wand-magic-sparkles',
            'viagem': 'fa-plane-up',
            'higiene pessoal': 'fa-soap',
            'limpeza': 'fa-broom',
            'academia': 'fa-dumbbell',
            'impostos': 'fa-scale-balanced',
            'taxas': 'fa-scale-balanced',
            'investimentos': 'fa-chart-line',
            'investimento': 'fa-chart-line',
            'seguro': 'fa-shield-heart',
            'compras': 'fa-bag-shopping',
            'outros': 'fa-wallet'
        };
        const FOOD_CATEGORY_KEYS = ['alimentacao', 'alimentao', 'mercado', 'restaurante', 'delivery', 'comida', 'bebida', 'padaria', 'cafeteria', 'lanche', 'lanchonete', 'ifood', 'supermercado'];

        let app, db, auth;
        let unsubscribeExpenses = () => { }, unsubscribeIncome = () => { }, unsubscribeGoals = () => { }, unsubscribeBudgets = () => { };
        let currentExpenses = [], currentIncomes = [], currentGoals = [], currentBudgets = [];
        let historicalAverageSurplus = 0;
        let expenseChartInstance = null;
        let editingExpenseId = null, editingIncomeId = null;
        let editingExpenseSeriesMeta = null;
        let recurrenceActionContext = null;
        let premiumRecentExpenses = [];
        let premiumCategoryHistory = {};
        let premiumTrendWindow = 6;
        let recurringForecastData = [];
        let recurringForecastMeta = { generatedAt: 0 };
        let premiumAnalyticsRequestId = 0;
        let expenseFormInlineMount = null;
        let expenseFormModalMount = null;
        let expenseFormCard = null;
        const DEFAULT_EXPENSE_TYPES = [
            { id: 't1', label: 'Compartilhado', color: '#ffffff', isShared: true, isThirdParty: false, defaultSplit: 50 },
            { id: 't2', label: 'Gasto Pessoal', color: '#f3f4f6', isShared: false, isThirdParty: false, defaultSplit: 0 },
            { id: 't3', label: 'Gastos da Outra Pessoa', color: '#fff7ed', isShared: false, isThirdParty: true, defaultSplit: 0 }
        ];
        const DEFAULT_TYPE_IDS = DEFAULT_EXPENSE_TYPES.map(t => t.id);
        const MAX_CUSTOM_TYPES = 4;
        let editingTypeId = null;
        let editingGoalId = null;
        let editingBudgetId = null;
        let budgetAlertItems = [];
        let planToastTimeout = null;
        let premiumExtrasEnabled = localStorage.getItem(PREMIUM_EXTRAS_STORAGE_KEY) === 'true';
        let premiumExtrasAutoEnabledForPrint = false;
        let premiumCharts = { person: null, type: null, food: null, categoryTrend: null, recurring: null };
        let previousMonthCategoryTotals = {};
        let previousMonthLabel = '';
        let latestAnnualReportData = null;

        let appSettings = {
            people: [{ id: 'p1', name: 'Eduardo' }, { id: 'p2', name: 'Camila' }],
            expenseTypes: [
                ...DEFAULT_EXPENSE_TYPES.map(t => ({ ...t })),
                { id: 't4', label: 'Gastos Cid', color: '#e9d5ff', isShared: false, isThirdParty: true, defaultSplit: 0 },
                { id: 't5', label: 'Gastos Praia', color: '#cffafe', isShared: false, isThirdParty: false, defaultSplit: 0 }
            ]
        };
        ensureDefaultTypes();
        const availableColors = ['#ffffff', '#e9d5ff', '#cffafe', '#fecaca', '#bbf7d0', '#fef08a', '#fed7aa', '#fff7ed'];
        const GOAL_CARD_THEMES = [
            { background: 'linear-gradient(135deg, #fde68a 0%, #f59e0b 100%)', accent: '#fbbf24', chipBg: 'rgba(255,255,255,0.45)', chipText: '#7c2d12', border: 'rgba(251,191,36,0.4)', shadow: '0 20px 35px rgba(245,158,11,0.35)', textColor: '#7c2d12' },
            { background: 'linear-gradient(135deg, #ddd6fe 0%, #818cf8 100%)', accent: '#6366f1', chipBg: 'rgba(255,255,255,0.35)', chipText: '#1e1b4b', border: 'rgba(99,102,241,0.35)', shadow: '0 20px 35px rgba(99,102,241,0.35)', textColor: '#111827' },
            { background: 'linear-gradient(135deg, #99f6e4 0%, #34d399 100%)', accent: '#059669', chipBg: 'rgba(255,255,255,0.4)', chipText: '#064e3b', border: 'rgba(5,150,105,0.35)', shadow: '0 20px 35px rgba(5,150,105,0.3)', textColor: '#064e3b' },
            { background: 'linear-gradient(135deg, #fecdd3 0%, #fb7185 100%)', accent: '#f472b6', chipBg: 'rgba(255,255,255,0.45)', chipText: '#831843', border: 'rgba(244,114,182,0.35)', shadow: '0 20px 35px rgba(236,72,153,0.35)', textColor: '#831843' }
        ];
        const GOAL_SUGGESTIONS = [
            {
                id: 'dream-trip',
                label: ' Viagem dos sonhos (12 meses)',
                description: 'Reservem juntos a viagem perfeita com aportes fixos e previsveis.',
                name: 'Viagem dos Sonhos ',
                targetAmount: 15000,
                strategy: 'fixed',
                strategyValue: 1250
            },
            {
                id: 'mini-wedding',
                label: ' Mini wedding minimalista',
                description: 'Planejem um mini wedding elegante com metas claras por ms.',
                name: 'Mini Wedding ',
                targetAmount: 30000,
                strategy: 'fixed',
                strategyValue: 2500
            },
            {
                id: 'emergency',
                label: ' Fundo de emergncia 6 meses',
                description: 'Construam um colcho para viver seis meses tranquilos sem renda.',
                name: 'Fundo de Emergncia ',
                targetAmount: 36000,
                strategy: 'manual'
            },
            {
                id: 'home-refresh',
                label: ' Upgrade da casa',
                description: 'Reforme cmodos com reservas menores e constantes.',
                name: 'Upgrade da Casa ',
                targetAmount: 10000,
                strategy: 'fixed',
                strategyValue: 850
            },
            {
                id: 'education',
                label: ' Curso internacional',
                description: 'Prepare-se para estudar fora guardando parte da renda extra.',
                name: 'Curso Internacional ',
                targetAmount: 18000,
                strategy: 'percentage',
                strategyValue: 15
            },
            {
                id: 'new-car',
                label: ' Carro novo sem aperto',
                description: 'Troquem de carro com aportes constantes e previsveis.',
                name: 'Carro dos Sonhos ',
                targetAmount: 85000,
                strategy: 'fixed',
                strategyValue: 3540
            },
            {
                id: 'city-moto',
                label: ' Moto para o dia a dia',
                description: 'Garanta a moto nova guardando metas pequenas toda semana.',
                name: 'Moto Nova ',
                targetAmount: 25000,
                strategy: 'fixed',
                strategyValue: 2085
            },
            {
                id: 'baby-plans',
                label: ' Enxoval do beb preparado',
                description: 'Monte o enxoval inteiro com antecedncia e tranquilidade.',
                name: 'Enxoval do Beb ',
                targetAmount: 18000,
                strategy: 'percentage',
                strategyValue: 10
            },
            {
                id: 'creative-studio',
                label: ' Estdio/office inspirador',
                description: 'Equipe o home office criativo com gadgets e acstica top.',
                name: 'Estdio Criativo ',
                targetAmount: 12000,
                strategy: 'fixed',
                strategyValue: 1000
            },
            {
                id: 'mini-break',
                label: ' Mini frias em casal',
                description: 'Garanta uma escapada de 5 dias com tudo includo e zero culpa.',
                name: 'Mini Frias ',
                targetAmount: 8000,
                strategy: 'fixed',
                strategyValue: 665
            },
            {
                id: 'wellness-retreat',
                label: ' Retiro de bem-estar',
                description: 'Spa completo, terapias e detox digital para resetar a mente.',
                name: 'Retiro Wellness ',
                targetAmount: 12000,
                strategy: 'fixed',
                strategyValue: 1000
            },
            {
                id: 'aesthetic-glow',
                label: ' Procedimento esttico desejado',
                description: 'Reserve para um combo de harmonizao, laser e skincare top.',
                name: 'Glow Up ',
                targetAmount: 20000,
                strategy: 'fixed',
                strategyValue: 1665
            },
            {
                id: 'dream-lodge',
                label: ' Experincia premium na neve',
                description: 'Viva uma semana em resort de neve com passeios e equipamentos.',
                name: 'Semana na Neve ',
                targetAmount: 25000,
                strategy: 'fixed',
                strategyValue: 2085
            }
        ];
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Maro", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        let stickyObserver = null;
        let stickyPickerInitialized = false;
        let periodTransitionActive = false;
        let periodTransitionTimeout = null;
        let goalSuggestionInitialized = false;
        const THEME_STORAGE_KEY = 'fluxTheme';
        let currentTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
        let themeToggleInitialized = false;
        if (document.body) {
            document.body.classList.toggle('theme-dark', currentTheme === 'dark');
        }

        // HELPER FUNCTIONS (DEFINED FIRST)
        function closeSettingsModal() {
            const modal = document.getElementById('modal-settings');
            if (!modal) return;
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
            document.body.classList.remove('modal-active');
        }
        function updateSettingsUI() {
            const pList = document.getElementById('settings-people-list');
            if (pList) {
                pList.innerHTML = appSettings.people.map((p, index) => {
                    const safeName = (p.name || '').replace(/"/g, '&quot;');
                    const canRemove = appSettings.people.length > 1 && index > 0;
                    const removeClass = canRemove ? 'text-red-500 hover:text-red-600' : 'text-gray-400 opacity-40 cursor-not-allowed';
                    return `
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-200">
                            <input type="text" value="${safeName}" class="flex-1 text-sm border border-gray-200 rounded px-2 py-1 bg-white"
                                onchange="window.renamePerson('${p.id}', this.value)" placeholder="Nome" />
                            <button ${canRemove ? '' : 'disabled'}
                                onclick="window.removePerson('${p.id}')"
                                class="${removeClass} transition"><i class="fas fa-trash"></i></button>
                        </div>`;
                }).join('');
            }
            const tList = document.getElementById('settings-types-list');
            if (tList) {
                tList.innerHTML = appSettings.expenseTypes.map((t) => {
                    const isDefault = DEFAULT_TYPE_IDS.includes(t.id);
                    const modeLabel = t.isShared ? `Compartilhado  ${t.defaultSplit || 50}%`
                        : (t.isThirdParty ? 'Direcionado 100% a outra pessoa' : 'Autnomo (fora do acerto)');
                    return `
                        <div class="flex justify-between items-center bg-white border p-2 rounded mb-2" style="border-left: 4px solid ${t.color}">
                            <div>
                                <p class="text-sm font-semibold text-gray-800">${t.label}</p>
                                <p class="text-xs text-gray-500">${modeLabel}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${isDefault ? '' : `<button class="text-indigo-500 hover:text-indigo-700" onclick="window.startTypeEdit('${t.id}')"><i class="fas fa-edit"></i></button>`}
                                ${isDefault ? '' : `<button class="text-gray-400 hover:text-red-500" onclick="window.removeType('${t.id}')"><i class="fas fa-trash"></i></button>`}
                            </div>
                        </div>`;
                }).join('');
                updateTypeFormState(Boolean(editingTypeId));
            }
        }
        window.addPerson = () => {
            const input = document.getElementById('new-person-name');
            const val = input.value.trim();
            if (!val) return;
            if (appSettings.people.length >= 4) { alert('Limite de 4 pessoas atingido.'); return; }
            appSettings.people.push({ id: `p${Date.now()}`, name: val });
            input.value = '';
            saveSettings();
        };
        window.renamePerson = (personId, newName) => {
            const idx = appSettings.people.findIndex(p => p.id === personId);
            if (idx === -1) return;
            const trimmed = (newName || '').trim();
            if (!trimmed) return;
            if (appSettings.people[idx].name === trimmed) return;
            appSettings.people[idx].name = trimmed;
            saveSettings();
        };
        window.removePerson = (personId) => {
            const firstPerson = appSettings.people[0];
            if (firstPerson && firstPerson.id === personId) {
                alert('A primeira pessoa da lista  o titular e no pode ser removida.');
                return;
            }
            if (appSettings.people.length <= 1) { alert('Mantenha ao menos uma pessoa cadastrada.'); return; }
            if (!confirm("Remover pessoa?")) return;
            const idx = appSettings.people.findIndex(p => p.id === personId);
            if (idx === -1) return;
            appSettings.people.splice(idx, 1);
            saveSettings();
        };

        function updateTypeFormState(isEditing) {
            const title = document.getElementById('type-form-title');
            const submit = document.getElementById('new-type-submit');
            const cancel = document.getElementById('cancel-type-edit-btn');
            if (title) title.textContent = isEditing ? 'Editar Tipo' : 'Novo Tipo';
            if (submit) submit.textContent = isEditing ? 'Salvar Alteraes' : 'Criar Tipo';
            if (cancel) cancel.classList.toggle('hidden', !isEditing);
        }

        function getSelectedTypeMode() {
            const hidden = document.getElementById('new-type-mode');
            const mode = hidden ? hidden.value : 'shared';
            if (mode === 'shared') {
                return { isShared: true, isThirdParty: false, defaultSplit: 50 };
            }
            return { isShared: false, isThirdParty: false, defaultSplit: 0 };
        }

        function highlightColorDot(color) {
            document.querySelectorAll('#color-picker-container .color-dot').forEach(dot => {
                dot.classList.toggle('selected', dot.dataset.color === color);
            });
        }

        function setTypeModeValue(mode) {
            const normalized = mode === 'individual' ? 'individual' : 'shared';
            const hidden = document.getElementById('new-type-mode');
            if (hidden) hidden.value = normalized;
            document.querySelectorAll('[data-type-mode-btn]').forEach(btn => {
                const isActive = btn.dataset.mode === normalized;
                btn.classList.toggle('border-indigo-400', isActive);
                btn.classList.toggle('bg-indigo-50', isActive);
                btn.classList.toggle('ring-2', isActive);
                btn.classList.toggle('ring-indigo-200', isActive);
                btn.classList.toggle('text-indigo-900', isActive);
                btn.classList.toggle('border-gray-200', !isActive);
                btn.classList.toggle('text-gray-700', !isActive);
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
        }

        function initTypeModeButtons() {
            const buttons = document.querySelectorAll('[data-type-mode-btn]');
            if (!buttons.length) return;
            buttons.forEach(btn => {
                if (btn.dataset.bound === 'true') return;
                btn.dataset.bound = 'true';
                btn.addEventListener('click', () => setTypeModeValue(btn.dataset.mode));
            });
            const current = document.getElementById('new-type-mode')?.value || 'shared';
            setTypeModeValue(current);
        }

        window.addExpenseType = () => {
            const labelInput = document.getElementById('new-type-label');
            const label = labelInput.value.trim();
            const color = document.getElementById('new-type-color').value;
            if (!label) return;
            const mode = getSelectedTypeMode();
            if (!editingTypeId) {
                const customCount = appSettings.expenseTypes.filter(t => !DEFAULT_TYPE_IDS.includes(t.id)).length;
                if (customCount >= MAX_CUSTOM_TYPES) { alert('Voc pode cadastrar at 4 tipos personalizados.'); return; }
                appSettings.expenseTypes.push({ id: `t${Date.now()}`, label, color, ...mode });
            } else {
                const idx = appSettings.expenseTypes.findIndex(t => t.id === editingTypeId);
                if (idx !== -1) appSettings.expenseTypes[idx] = { ...appSettings.expenseTypes[idx], label, color, ...mode };
                editingTypeId = null;
            }
            labelInput.value = '';
            setTypeModeValue('shared');
            setTypeColorValue('#ffffff');
            highlightColorDot('#ffffff');
            updateTypeFormState(false);
            saveSettings();
        };

        window.startTypeEdit = (typeId) => {
            const type = appSettings.expenseTypes.find(t => t.id === typeId);
            if (!type || DEFAULT_TYPE_IDS.includes(type.id)) return;
            editingTypeId = typeId;
            document.getElementById('new-type-label').value = type.label;
            setTypeColorValue(type.color || '#ffffff');
            highlightColorDot(type.color || '#ffffff');
            setTypeModeValue(type.isShared ? 'shared' : 'individual');
            updateTypeFormState(true);
        };

        window.cancelTypeEdit = () => {
            editingTypeId = null;
            document.getElementById('new-type-label').value = '';
            setTypeColorValue('#ffffff');
            highlightColorDot('#ffffff');
            setTypeModeValue('shared');
            updateTypeFormState(false);
        };

        window.removeType = (typeId) => {
            if (DEFAULT_TYPE_IDS.includes(typeId)) { alert('Tipo padro no pode ser removido.'); return; }
            if (!confirm("Remover tipo?")) return;
            const idx = appSettings.expenseTypes.findIndex(t => t.id === typeId);
            if (idx === -1) return;
            appSettings.expenseTypes.splice(idx, 1);
            if (editingTypeId === typeId) {
                editingTypeId = null;
                updateTypeFormState(false);
            }
            saveSettings();
        };
        // No  necessrio, pois o nome  editado diretamente ao adicionar/remover
        // Color picker funcional
        function setTypeColorValue(color) {
            const hidden = document.getElementById('new-type-color');
            if (hidden) hidden.value = color;
            const picker = document.getElementById('new-type-color-picker');
            if (picker && picker.value !== color) picker.value = color;
        }

        function initColorPicker() {
            const c = document.getElementById('color-picker-container');
            if (!c) return;
            const availableColors = ['#ffffff', '#e9d5ff', '#cffafe', '#fecaca', '#bbf7d0', '#fef08a', '#fed7aa', '#fff7ed'];
            c.innerHTML = availableColors.map(col => `<button type="button" class="color-dot" data-color="${col}" style="background-color:${col}" onclick="window.selectColor(this,'${col}')"></button>`).join('');
            const nativePicker = document.getElementById('new-type-color-picker');
            if (nativePicker && nativePicker.dataset.bound !== 'true') {
                nativePicker.dataset.bound = 'true';
                nativePicker.addEventListener('input', (event) => {
                    const nextColor = event.target.value || '#ffffff';
                    highlightColorDot(nextColor);
                    setTypeColorValue(nextColor);
                });
            }
            const initialColor = document.getElementById('new-type-color')?.value || availableColors[0];
            highlightColorDot(initialColor);
            setTypeColorValue(initialColor);
        }
        window.selectColor = (el, col) => {
            if (el) highlightColorDot(col);
            setTypeColorValue(col);
        };

        function getSelectedFilterYear() {
            const yearSelect = document.getElementById('year-select');
            const fallback = new Date().getFullYear();
            if (!yearSelect) return fallback;
            const numeric = Number(yearSelect.value);
            return Number.isFinite(numeric) ? numeric : fallback;
        }

        function resolveExpenseTypeLabel(expense) {
            if (!expense) return 'N/D';
            const match = appSettings.expenseTypes?.find(t => t.id === expense.typeId);
            return match?.label || expense.sharingType || 'N/D';
        }

        function formatNumberForCSV(value) {
            const amount = Number(value) || 0;
            return amount.toFixed(2).replace('.', ',');
        }

        function sanitizeCSVValue(value) {
            return `"${String(value ?? '').replace(/"/g, '""')}"`;
        }

        function buildFinanceCSVRows(expenses = [], incomes = []) {
            const rows = [[
                'Tipo',
                'Descrio',
                'Valor (R$)',
                'Data',
                'Categoria/Fonte',
                'Responsvel',
                'Modo/Tipo',
                'Beneficirio'
            ]];

            expenses.forEach(expense => {
                const amount = formatNumberForCSV(expense.amount);
                const typeConfig = appSettings.expenseTypes?.find(t => t.id === expense.typeId);
                const beneficiary = expense.beneficiary || (typeConfig?.isThirdParty ? 'Outro participante' : '');
                rows.push([
                    'Despesa',
                    expense.description || 'Sem descrio',
                    amount,
                    expense.date || '',
                    expense.category || 'Outros',
                    expense.paidBy || 'N/D',
                    resolveExpenseTypeLabel(expense),
                    beneficiary
                ]);
            });

            incomes.forEach(income => {
                const amount = formatNumberForCSV(income.amount);
                rows.push([
                    'Renda',
                    income.description || 'Sem descrio',
                    amount,
                    income.date || '',
                    income.source || 'Outros',
                    '-',
                    'Renda',
                    '-'
                ]);
            });

            return rows;
        }

        function convertRowsToCSV(rows) {
            if (!rows?.length) return '';
            return rows.map(row => row.map(sanitizeCSVValue).join(';')).join('\n');
        }

        function downloadCSV(rows, filename) {
            if (!rows || rows.length <= 1) {
                alert('No h dados suficientes para exportar.');
                return;
            }
            const csvContent = convertRowsToCSV(rows);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportCurrentDataToCSV() {
            const rows = buildFinanceCSVRows(currentExpenses, currentIncomes);
            const monthYear = getCurrentFilterMonthYear().replace('-', '_');
            downloadCSV(rows, `flux-${monthYear}-mensal.csv`);
        }

        async function openAnnualReportModal() {
            const modal = document.getElementById('modal-annual-report');
            if (!modal) return;
            modal.classList.remove('hidden');
            requestAnimationFrame(() => modal.classList.add('active'));
            const year = getSelectedFilterYear();
            const loading = document.getElementById('annual-report-loading');
            const content = document.getElementById('annual-report-content');
            if (loading) {
                loading.innerHTML = '<i class="fas fa-circle-notch fa-spin text-indigo-500 text-xl"></i><span>Carregando dados do ano...</span>';
                loading.classList.remove('hidden');
            }
            if (content) content.classList.add('hidden');
            const labelEl = document.getElementById('annual-report-year-label');
            if (labelEl) labelEl.textContent = year;
            try {
                const data = await fetchAnnualReportData(year);
                latestAnnualReportData = data;
                renderAnnualReport(data);
            } catch (error) {
                console.error('Erro ao carregar relatrio anual', error);
                if (loading) {
                    loading.innerHTML = '<p class="text-sm text-red-600">No foi possvel carregar os dados.</p>';
                }
            }
        }

        function closeAnnualReportModal() {
            const modal = document.getElementById('modal-annual-report');
            if (!modal) return;
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        async function fetchAnnualReportData(year) {
            const months = Array.from({ length: 12 }, (_, idx) => `${String(idx + 1).padStart(2, '0')}-${year}`);
            const expenses = [];
            const incomes = [];
            for (const monthKey of months) {
                const [expSnap, incSnap] = await Promise.all([
                    getDocs(query(collection(db, `${DB_BASE_PATH}/expenses`), where('monthYear', '==', monthKey))),
                    getDocs(query(collection(db, `${DB_BASE_PATH}/income`), where('monthYear', '==', monthKey)))
                ]);
                expSnap.forEach(docSnap => expenses.push({ id: docSnap.id, ...docSnap.data() }));
                incSnap.forEach(docSnap => incomes.push({ id: docSnap.id, ...docSnap.data() }));
            }
            return { year, months, expenses, incomes };
        }

        function renderAnnualReport(data) {
            if (!data) return;
            const loading = document.getElementById('annual-report-loading');
            const content = document.getElementById('annual-report-content');
            if (loading) loading.classList.add('hidden');
            if (content) content.classList.remove('hidden');

            const totalExpense = data.expenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
            const totalIncome = data.incomes.reduce((sum, inc) => sum + (Number(inc.amount) || 0), 0);
            const balance = totalIncome - totalExpense;

            const totalExpenseEl = document.getElementById('annual-report-total-expense');
            const totalIncomeEl = document.getElementById('annual-report-total-income');
            const totalBalanceEl = document.getElementById('annual-report-total-balance');
            if (totalExpenseEl) totalExpenseEl.textContent = formatCurrencyBRL(totalExpense);
            if (totalIncomeEl) totalIncomeEl.textContent = formatCurrencyBRL(totalIncome);
            if (totalBalanceEl) {
                totalBalanceEl.textContent = formatCurrencyBRL(balance);
                totalBalanceEl.classList.toggle('text-green-600', balance >= 0);
                totalBalanceEl.classList.toggle('text-red-600', balance < 0);
            }

            const monthMap = {};
            data.months.forEach(month => { monthMap[month] = { expenses: 0, incomes: 0 }; });
            data.expenses.forEach(expense => {
                const key = expense.monthYear || getMonthYear(expense.date);
                if (!monthMap[key]) monthMap[key] = { expenses: 0, incomes: 0 };
                monthMap[key].expenses += Number(expense.amount) || 0;
            });
            data.incomes.forEach(income => {
                const key = income.monthYear || getMonthYear(income.date);
                if (!monthMap[key]) monthMap[key] = { expenses: 0, incomes: 0 };
                monthMap[key].incomes += Number(income.amount) || 0;
            });

            const monthlyBody = document.getElementById('annual-report-monthly-body');
            if (monthlyBody) {
                monthlyBody.innerHTML = data.months.map(monthKey => {
                    const metrics = monthMap[monthKey] || { expenses: 0, incomes: 0 };
                    const label = formatMonthYearLabel(monthKey);
                    return `
                        <div class="py-2 flex items-start justify-between gap-3">
                            <div>
                                <p class="font-semibold text-gray-800">${label}</p>
                                <p class="text-[11px] text-gray-500">Saldo ${formatCurrencyBRL(metrics.incomes - metrics.expenses)}</p>
                            </div>
                            <div class="text-right text-xs">
                                <p class="text-red-600 font-semibold">${formatCurrencyBRL(metrics.expenses)}</p>
                                <p class="text-green-600 font-semibold">${formatCurrencyBRL(metrics.incomes)}</p>
                            </div>
                        </div>`;
                }).join('');
            }

            const categoryTotals = calculateCategoryTotals(data.expenses);
            const categoryBody = document.getElementById('annual-report-category-body');
            if (categoryBody) {
                const entries = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).slice(0, 6);
                if (!entries.length) {
                    categoryBody.innerHTML = '<p class="text-xs text-gray-400 italic">Sem despesas registradas no ano.</p>';
                } else {
                    const total = Object.values(categoryTotals).reduce((sum, value) => sum + value, 0) || 1;
                    categoryBody.innerHTML = entries.map(([label, value]) => {
                        const percent = ((value / total) * 100).toFixed(1);
                        return `
                            <div>
                                <div class="flex items-center justify-between text-sm font-semibold text-gray-800">
                                    <span>${label}</span>
                                    <span>${percent}%</span>
                                </div>
                                <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                    <div class="h-full rounded-full bg-indigo-500" style="width:${percent}%;"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${formatCurrencyBRL(value)}</p>
                            </div>`;
                    }).join('');
                }
            }
        }

        function exportAnnualReportCSV() {
            if (!latestAnnualReportData) {
                alert('Abra o relatrio anual antes de exportar.');
                return;
            }
            const rows = buildFinanceCSVRows(latestAnnualReportData.expenses, latestAnnualReportData.incomes);
            downloadCSV(rows, `flux-${latestAnnualReportData.year}-anual.csv`);
        }
        function getCurrentFilterMonthYear() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            if (!monthSelect || !yearSelect) {
                return getMonthYear(new Date().toISOString().split('T')[0]);
            }
            return `${monthSelect.value}-${yearSelect.value}`;
        }

        function getCurrentFilterLabel() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const now = new Date();
            const month = monthSelect ? Number(monthSelect.value) : now.getMonth() + 1;
            const year = yearSelect ? yearSelect.value : now.getFullYear();
            const index = Math.max(1, Math.min(12, month)) - 1;
            return `${MONTH_NAMES[index]} de ${year}`;
        }

        function updateCompetencyTooltips() {
            const label = getCurrentFilterLabel();
            const expenseLabel = document.getElementById('expense-tooltip-month-label');
            if (expenseLabel) expenseLabel.textContent = label;
            const incomeLabel = document.getElementById('income-tooltip-month-label');
            if (incomeLabel) incomeLabel.textContent = label;
            const printTitle = document.getElementById('print-title');
            if (printTitle) printTitle.textContent = `Relatrio Mensal  ${label}`;
        }

        function ensureYearOption(year) {
            const numericYear = Number(year);
            if (!Number.isFinite(numericYear)) return;
            const yearSelect = document.getElementById('year-select');
            if (!yearSelect) return;
            const stickyYearSelect = document.getElementById('sticky-year-select');
            const existingYears = Array.from(yearSelect.options).map(opt => Number(opt.value));
            if (!existingYears.includes(numericYear)) {
                existingYears.push(numericYear);
                existingYears.sort((a, b) => a - b);
                const optionsMarkup = existingYears.map(y => `<option value="${y}">${y}</option>`).join('');
                const syncSelect = (select) => {
                    if (!select) return;
                    const previous = Number(select.value);
                    select.innerHTML = optionsMarkup;
                    const target = existingYears.includes(previous) ? previous : numericYear;
                    select.value = target.toString();
                };
                syncSelect(yearSelect);
                syncSelect(stickyYearSelect);
            } else if (stickyYearSelect && stickyYearSelect.options.length !== yearSelect.options.length) {
                stickyYearSelect.innerHTML = yearSelect.innerHTML;
                stickyYearSelect.value = yearSelect.value;
            }
        }

        function changePeriodByOffset(offset = 0, source = 'primary') {
            const step = Number(offset);
            if (!step) return;
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            if (!monthSelect || !yearSelect) return;
            const stickyMonthSelect = document.getElementById('sticky-month-select');
            const stickyYearSelect = document.getElementById('sticky-year-select');
            const referenceMonth = source === 'sticky' && stickyMonthSelect ? stickyMonthSelect.value : monthSelect.value;
            const referenceYear = source === 'sticky' && stickyYearSelect ? Number(stickyYearSelect.value) : Number(yearSelect.value);
            let month = Number(referenceMonth);
            let year = Number(referenceYear);
            if (!month || !year) return;
            month += step;
            while (month > 12) {
                month -= 12;
                year += 1;
            }
            while (month < 1) {
                month += 12;
                year -= 1;
            }
            ensureYearOption(year);
            const monthValue = month.toString().padStart(2, '0');
            const yearValue = year.toString();
            monthSelect.value = monthValue;
            yearSelect.value = yearValue;
            if (stickyMonthSelect) stickyMonthSelect.value = monthValue;
            if (stickyYearSelect) stickyYearSelect.value = yearValue;
            handlePeriodChange(source);
        }

        function handlePeriodChange(source = 'primary') {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            if (!monthSelect || !yearSelect) return;
            const stickyMonthSelect = document.getElementById('sticky-month-select');
            const stickyYearSelect = document.getElementById('sticky-year-select');

            if (source === 'sticky' && stickyMonthSelect && stickyYearSelect) {
                monthSelect.value = stickyMonthSelect.value;
                yearSelect.value = stickyYearSelect.value;
            } else if (source === 'primary' && stickyMonthSelect && stickyYearSelect) {
                stickyMonthSelect.value = monthSelect.value;
                stickyYearSelect.value = yearSelect.value;
            }

            beginPeriodTransition();
            updateCompetencyTooltips();
            updateStickyPeriodBar();
            triggerPeriodChangeAnimation();
            loadDataForMonth();
            if (source === 'sticky') toggleStickyPicker(false);
        }

        function triggerPeriodChangeAnimation() {
            const stickyLabel = document.getElementById('sticky-period-label');
            const stickyCard = document.getElementById('sticky-period-inner');
            const filterControls = document.getElementById('filter-controls');
            [stickyLabel, stickyCard].forEach(el => {
                if (!el) return;
                el.classList.remove('period-flash');
                void el.offsetWidth;
                el.classList.add('period-flash');
            });
            if (filterControls) {
                filterControls.classList.remove('period-highlight');
                void filterControls.offsetWidth;
                filterControls.classList.add('period-highlight');
                setTimeout(() => filterControls.classList.remove('period-highlight'), 900);
            }
        }

        function updateStickyPeriodBar() {
            const stickyLabel = document.getElementById('sticky-period-label');
            if (stickyLabel) stickyLabel.textContent = getCurrentFilterLabel();
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const stickyMonthSelect = document.getElementById('sticky-month-select');
            const stickyYearSelect = document.getElementById('sticky-year-select');
            if (monthSelect && stickyMonthSelect && stickyMonthSelect.value !== monthSelect.value) {
                stickyMonthSelect.value = monthSelect.value;
            }
            if (yearSelect && stickyYearSelect && stickyYearSelect.value !== yearSelect.value) {
                stickyYearSelect.value = yearSelect.value;
            }
        }

        function setupStickyObserver() {
            if (stickyObserver) stickyObserver.disconnect();
            const stickyBar = document.getElementById('sticky-period-bar');
            const filterControls = document.getElementById('filter-controls');
            if (!stickyBar || !filterControls) return;
            stickyObserver = new IntersectionObserver(([entry]) => {
                if (!entry) return;
                const stillVisible = entry.isIntersecting && entry.intersectionRatio > 0;
                stickyBar.classList.toggle('sticky-visible', !stillVisible);
            }, { threshold: [0, 1] });
            stickyObserver.observe(filterControls);
        }

        function toggleStickyPicker(force) {
            const picker = document.getElementById('sticky-period-picker');
            const trigger = document.getElementById('sticky-period-trigger');
            if (!picker || !trigger) return;
            const shouldOpen = typeof force === 'boolean' ? force : picker.classList.contains('hidden');
            picker.classList.toggle('hidden', !shouldOpen);
            trigger.classList.toggle('active', shouldOpen);
        }

        function initializeStickyPicker() {
            if (stickyPickerInitialized) return;
            const trigger = document.getElementById('sticky-period-trigger');
            const picker = document.getElementById('sticky-period-picker');
            if (!trigger || !picker) return;
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleStickyPicker();
            });
            document.addEventListener('click', (e) => {
                if (picker.classList.contains('hidden')) return;
                if (!picker.contains(e.target) && !trigger.contains(e.target)) {
                    toggleStickyPicker(false);
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') toggleStickyPicker(false);
            });
            stickyPickerInitialized = true;
        }

        function beginPeriodTransition() {
            if (periodTransitionTimeout) {
                clearTimeout(periodTransitionTimeout);
                periodTransitionTimeout = null;
            }
            periodTransitionActive = true;
            const transitionLabel = document.getElementById('period-transition-label');
            if (transitionLabel) transitionLabel.textContent = getCurrentFilterLabel();
            const overlay = document.getElementById('period-transition-overlay');
            if (overlay) overlay.classList.add('active');
            const content = document.getElementById('app-content');
            if (content) content.classList.add('period-fade-active');
        }

        function completePeriodTransition() {
            if (!periodTransitionActive) return;
            if (periodTransitionTimeout) clearTimeout(periodTransitionTimeout);
            periodTransitionTimeout = setTimeout(() => {
                const overlay = document.getElementById('period-transition-overlay');
                if (overlay) overlay.classList.remove('active');
                const content = document.getElementById('app-content');
                if (content) content.classList.remove('period-fade-active');
                periodTransitionActive = false;
            }, 450);
        }

        function refreshBodyModalState() {
            const hasActiveModal = document.querySelector('.modal.active');
            if (hasActiveModal) document.body.classList.add('modal-active');
            else document.body.classList.remove('modal-active');
        }

        function ensureExpenseFormElements() {
            if (!expenseFormInlineMount) expenseFormInlineMount = document.getElementById('expense-form-inline-mount');
            if (!expenseFormModalMount) expenseFormModalMount = document.getElementById('expense-form-modal-mount');
            if (!expenseFormCard) expenseFormCard = document.getElementById('expense-form-card');
        }

        function scrollToExpenseForm() {
            ensureExpenseFormElements();
            if (!expenseFormCard) expenseFormCard = document.getElementById('expense-form-card');
            if (!expenseFormCard) return;
            expenseFormCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function mountExpenseFormInline() {
            ensureExpenseFormElements();
            if (expenseFormInlineMount && expenseFormCard && !expenseFormInlineMount.contains(expenseFormCard)) {
                expenseFormInlineMount.appendChild(expenseFormCard);
            }
        }

        function mountExpenseFormInModal() {
            ensureExpenseFormElements();
            if (expenseFormModalMount && expenseFormCard && !expenseFormModalMount.contains(expenseFormCard)) {
                expenseFormModalMount.appendChild(expenseFormCard);
            }
        }

        function openExpenseEditModal() {
            mountExpenseFormInModal();
            const modal = document.getElementById('modal-expense-edit');
            if (!modal) return;
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.add('active');
                document.body.classList.add('modal-active');
            });
        }

        function closeExpenseEditModal() {
            const modal = document.getElementById('modal-expense-edit');
            if (!modal) {
                mountExpenseFormInline();
                return;
            }
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                mountExpenseFormInline();
                refreshBodyModalState();
            }, 200);
        }

        function resetExpenseForm() {
            const form = document.getElementById('expense-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('expense-amount');
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('expense-date');
            if (dateInput) dateInput.value = today;
            const cancelBtn = document.getElementById('expense-cancel-btn');
            if (cancelBtn) cancelBtn.classList.add('hidden');
            const title = document.getElementById('expense-form-title');
            if (title) title.textContent = 'Adicionar Despesa';
            const submit = document.getElementById('expense-submit-btn');
            if (submit) submit.textContent = 'Adicionar Despesa';
            editingExpenseId = null;
            editingExpenseSeriesMeta = null;
            setSplitValue(document.getElementById('split-slider') ? document.getElementById('split-slider').value : 50);
            handleTypeChange();
            toggleRecurrenceInput();
            lockRecurrenceControlsForSeries(false);
            const editModal = document.getElementById('modal-expense-edit');
            if (editModal && !editModal.classList.contains('hidden')) closeExpenseEditModal();
            else mountExpenseFormInline();
        }

        function resetIncomeForm() {
            const form = document.getElementById('income-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('income-amount');
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('income-date');
            if (dateInput) dateInput.value = today;
            const cancelBtn = document.getElementById('income-cancel-btn');
            if (cancelBtn) cancelBtn.classList.add('hidden');
            const title = document.getElementById('income-form-title');
            if (title) title.textContent = 'Adicionar Renda';
            const submit = document.getElementById('income-submit-btn');
            if (submit) submit.textContent = 'Adicionar Renda';
            editingIncomeId = null;
        }

        async function handleExpenseSubmit(event) {
            event.preventDefault();
            const description = document.getElementById('expense-desc').value.trim();
            const amount = getMoneyInputValue('expense-amount');
            const date = document.getElementById('expense-date').value;
            if (!description || !date || isNaN(amount) || amount <= 0) { alert('Preencha descrio, data e valor vlidos.'); return; }
            const category = document.getElementById('expense-category').value;
            const paidBy = document.getElementById('expense-paid-by').value;
            const typeSelect = document.getElementById('expense-sharing-type');
            const typeId = typeSelect.value;
            const typeConfig = appSettings.expenseTypes.find(t => t.id === typeId) || {};
            const splitSlider = document.getElementById('split-slider');
            const splitPercent = typeConfig.isShared ? Number(splitSlider.value) : null;
            const beneficiarySelect = document.getElementById('expense-beneficiary');
            const beneficiary = typeConfig.isThirdParty && beneficiarySelect ? beneficiarySelect.value : null;
            const recurrenceSelect = document.getElementById('expense-recurrence-type');
            const recurrenceMonthsInput = document.getElementById('expense-recurrence-months');
            const existingExpense = editingExpenseId ? currentExpenses.find(e => e.id === editingExpenseId) : null;
            let recurrenceType = recurrenceSelect.value;
            if (editingExpenseSeriesMeta?.recurrenceSeriesId) recurrenceType = editingExpenseSeriesMeta.recurrenceType || 'none';
            let recurrenceMonths = recurrenceType === 'fixed' ? Number(recurrenceMonthsInput.value || 0) : null;
            if (recurrenceType === 'fixed') recurrenceMonths = clampFixedRecurrenceMonths(recurrenceMonths);
            if (!planAllowsRecurrence() && recurrenceType !== 'none') {
                openPremiumModal();
                return;
            }
            const monthYear = getMonthYear(date);
            const payload = {
                description,
                amount,
                date,
                category,
                paidBy,
                typeId,
                sharingType: typeConfig.label || typeId,
                splitPercent: splitPercent !== null ? splitPercent : null,
                beneficiary: beneficiary || null,
                recurrenceType,
                recurrenceMonths: recurrenceType === 'fixed' ? recurrenceMonths : null,
                recurrenceSeriesId: editingExpenseSeriesMeta?.recurrenceSeriesId || null,
                recurrenceIndex: editingExpenseSeriesMeta?.recurrenceIndex || null,
                recurrenceTotal: editingExpenseSeriesMeta?.recurrenceSeriesId ? (editingExpenseSeriesMeta.recurrenceTotal || null) : (recurrenceType === 'fixed' ? recurrenceMonths : null),
                recurrenceSeriesActive: editingExpenseSeriesMeta?.recurrenceSeriesActive ?? (recurrenceType === 'none' ? null : true),
                recurrenceIsCustom: existingExpense?.recurrenceIsCustom || false,
                monthYear,
                updatedAt: new Date()
            };
            if (!editingExpenseId) payload.createdAt = new Date();
            else if (existingExpense?.createdAt) payload.createdAt = existingExpense.createdAt;

            try {
                if (!editingExpenseId) {
                    if (recurrenceType === 'none') {
                        await addDoc(collection(db, `${DB_BASE_PATH}/expenses`), payload);
                    } else {
                        await createRecurringSeriesFromPayload(payload, recurrenceType, recurrenceMonths);
                    }
                    resetExpenseForm();
                    return;
                }

                if (!editingExpenseSeriesMeta?.recurrenceSeriesId) {
                    if (recurrenceType === 'none') {
                        await updateDoc(doc(db, `${DB_BASE_PATH}/expenses/${editingExpenseId}`), sanitizeSingleExpensePayload(payload));
                    } else {
                        await convertExpenseToRecurringSeries(editingExpenseId, payload, recurrenceType, recurrenceMonths);
                    }
                    resetExpenseForm();
                    return;
                }

                queueRecurrenceScopeAction({
                    action: 'edit',
                    payload,
                    meta: { ...editingExpenseSeriesMeta },
                    docId: editingExpenseId
                });
            } catch (error) {
                console.error('Erro ao salvar despesa', error);
                alert('No foi possvel salvar a despesa.');
            }
        }

        async function handleIncomeSubmit(event) {
            event.preventDefault();
            const description = document.getElementById('income-desc').value.trim();
            const amount = getMoneyInputValue('income-amount');
            const date = document.getElementById('income-date').value;
            if (!description || !date || isNaN(amount) || amount <= 0) { alert('Preencha descrio, data e valor vlidos.'); return; }
            const source = document.getElementById('income-source').value;
            const monthYear = getCurrentFilterMonthYear();
            const payload = {
                description,
                amount,
                date,
                source,
                monthYear,
                updatedAt: new Date()
            };
            if (!editingIncomeId) payload.createdAt = new Date();
            try {
                if (editingIncomeId) {
                    await updateDoc(doc(db, `${DB_BASE_PATH}/income/${editingIncomeId}`), payload);
                } else {
                    await addDoc(collection(db, `${DB_BASE_PATH}/income`), payload);
                }
                resetIncomeForm();
            } catch (error) {
                console.error('Erro ao salvar renda', error);
                alert('No foi possvel salvar a renda.');
            }
        }

        function startEditExpense(id) {
            const expense = currentExpenses.find(e => e.id === id);
            if (!expense) return;
            editingExpenseId = id;
            editingExpenseSeriesMeta = expense.recurrenceSeriesId ? {
                recurrenceSeriesId: expense.recurrenceSeriesId,
                recurrenceIndex: expense.recurrenceIndex || 1,
                recurrenceType: expense.recurrenceType || 'none',
                recurrenceTotal: expense.recurrenceTotal || expense.recurrenceMonths || null,
                recurrenceSeriesActive: expense.recurrenceSeriesActive !== false
            } : null;
            lockRecurrenceControlsForSeries(Boolean(editingExpenseSeriesMeta));
            document.getElementById('expense-form-title').textContent = 'Editar Despesa';
            document.getElementById('expense-submit-btn').textContent = 'Salvar Alteraes';
            document.getElementById('expense-cancel-btn').classList.remove('hidden');
            document.getElementById('expense-desc').value = expense.description || '';
            setMoneyInputValue('expense-amount', expense.amount);
            document.getElementById('expense-date').value = expense.date;
            document.getElementById('expense-category').value = expense.category || 'Outros';
            document.getElementById('expense-paid-by').value = expense.paidBy || appSettings.people[0]?.name;
            const typeSelect = document.getElementById('expense-sharing-type');
            if (expense.typeId && Array.from(typeSelect.options).some(o => o.value === expense.typeId)) {
                typeSelect.value = expense.typeId;
            }
            handleTypeChange();
            if (expense.splitPercent !== undefined && expense.splitPercent !== null) {
                setSplitValue(expense.splitPercent);
            }
            if (expense.beneficiary && document.getElementById('expense-beneficiary')) {
                document.getElementById('expense-beneficiary').value = expense.beneficiary;
            }
            const recurrenceSelect = document.getElementById('expense-recurrence-type');
            const recurrenceMonthsInput = document.getElementById('expense-recurrence-months');
            if (recurrenceSelect) recurrenceSelect.value = expense.recurrenceType || 'none';
            if (recurrenceMonthsInput) recurrenceMonthsInput.value = expense.recurrenceTotal || expense.recurrenceMonths || '';
            toggleRecurrenceInput();
            openExpenseEditModal();
            document.getElementById('expense-desc').focus();
        }

        function startEditIncome(id) {
            const income = currentIncomes.find(i => i.id === id);
            if (!income) return;
            editingIncomeId = id;
            document.getElementById('income-form-title').textContent = 'Editar Renda';
            document.getElementById('income-submit-btn').textContent = 'Salvar Alteraes';
            document.getElementById('income-cancel-btn').classList.remove('hidden');
            document.getElementById('income-desc').value = income.description || '';
            setMoneyInputValue('income-amount', income.amount);
            document.getElementById('income-date').value = income.date;
            document.getElementById('income-source').value = income.source || appSettings.people[0]?.name;
            document.getElementById('income-desc').focus();
        }

        function cancelEditExpense() { resetExpenseForm(); }
        function cancelEditIncome() { resetIncomeForm(); }

        async function deleteItem(id, type) {
            if (!confirm('Remover este registro?')) return;
            if (type === 'expense') {
                const expense = currentExpenses.find(e => e.id === id);
                if (expense?.recurrenceSeriesId) {
                    queueRecurrenceScopeAction({
                        action: 'delete',
                        docId: id,
                        meta: {
                            recurrenceSeriesId: expense.recurrenceSeriesId,
                            recurrenceIndex: expense.recurrenceIndex || 1,
                            recurrenceType: expense.recurrenceType || 'none',
                            recurrenceTotal: expense.recurrenceTotal || expense.recurrenceMonths || null,
                            recurrenceSeriesActive: expense.recurrenceSeriesActive !== false
                        }
                    });
                    return;
                }
            }
            const collectionName = type === 'income' ? 'income' : 'expenses';
            try {
                await deleteDoc(doc(db, `${DB_BASE_PATH}/${collectionName}/${id}`));
                if (type === 'expense' && editingExpenseId === id) resetExpenseForm();
                if (type === 'income' && editingIncomeId === id) resetIncomeForm();
            } catch (error) {
                console.error('Erro ao excluir registro', error);
                alert('No foi possvel excluir o item.');
            }
        }

        // Funo stub para corrigir erro de referncia
        function initializeToggle() {
            // Inicializa toggles, se necessrio
            // Adicione lgica real se necessrio
        }

        // Funo stub para corrigir erro de referncia
        function updateCharts() {
            // Atualiza grfico de pizza de categorias
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            const categories = {};
            currentExpenses.forEach(e => { categories[e.category] = (categories[e.category] || 0) + e.amount; });
            const labels = Object.keys(categories);
            const data = Object.values(categories);
            if (window.expenseChartInstance) window.expenseChartInstance.destroy();
            window.expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#6B7280',
                            '#F472B6', '#FBBF24', '#34D399', '#60A5FA', '#A78BFA', '#F87171', '#FDE68A', '#6EE7B7', '#C7D2FE', '#F9A8D4', '#FCD34D', '#A7F3D0', '#F3F4F6', '#FCA5A5', '#D1FAE5', '#F3E8FF', '#FDE68A', '#FECACA', '#BBF7D0', '#FED7AA', '#FFF7ED'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }
                    }
                }
            });
        }
        // Esconde o formulrio de edio de despesa, se aplicvel
        const btn = document.getElementById('expense-cancel-btn');
        if (btn) btn.classList.add('hidden');
        editingExpenseId = null;


        function initializePeriodNavButtons() {
            const buttons = document.querySelectorAll('[data-period-nav]');
            if (!buttons.length) return;
            buttons.forEach(button => {
                if (button.dataset.bound === 'true') return;
                button.dataset.bound = 'true';
                button.addEventListener('click', () => {
                    const direction = Number(button.dataset.direction);
                    if (!direction) return;
                    const scope = button.dataset.periodNav === 'sticky' ? 'sticky' : 'primary';
                    changePeriodByOffset(direction, scope);
                });
            });
        }

        // Funo stub para corrigir erro de referncia
        function initializeSelectors() {
            // Inicializa selects de ms e ano, datas dos formulrios e categorias completas
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            if (!monthSelect || !yearSelect) return;
            const now = new Date();
            monthSelect.innerHTML = '';
            MONTH_NAMES.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = (i + 1).toString().padStart(2, '0');
                opt.textContent = m;
                if (i === now.getMonth()) opt.selected = true;
                monthSelect.appendChild(opt);
            });
            yearSelect.innerHTML = '';
            for (let y = now.getFullYear() - 3; y <= now.getFullYear() + 2; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === now.getFullYear()) opt.selected = true;
                yearSelect.appendChild(opt);
            }
            // Restaurar lista completa de categorias
            const expenseCategory = document.getElementById('expense-category');
            if (expenseCategory) {
                expenseCategory.innerHTML = `
                    <option>Moradia</option>
                    <option>Contas (Luz, gua, Net)</option>
                    <option>Mercado</option>
                    <option>Alimentao (iFood, etc)</option>
                    <option>Transporte/Carro</option>
                    <option>Lazer</option>
                    <option>Sade</option>
                    <option>Presentes</option>
                    <option>Outros</option>
                    <option>Educao</option>
                    <option>Vesturio</option>
                    <option>Higiene Pessoal</option>
                    <option>Limpeza</option>
                    <option>Assinaturas/Streaming</option>
                    <option>Pet</option>
                    <option>Viagem</option>
                    <option>Eletrnicos</option>
                    <option>Casa/Decorao</option>
                    <option>Beleza/Esttica</option>
                    <option>Esportes/Academia</option>
                    <option>Impostos/Taxas</option>
                    <option>Seguros</option>
                    <option>Doaes</option>
                    <option>Investimentos</option>
                    <option>Manuteno Carro</option>
                    <option>Manuteno Casa</option>
                    <option>Trabalho</option>
                `;
            }
            const expenseDate = document.getElementById('expense-date');
            if (expenseDate) expenseDate.value = now.toISOString().split('T')[0];
            const incomeDate = document.getElementById('income-date');
            if (incomeDate) incomeDate.value = now.toISOString().split('T')[0];
            monthSelect.addEventListener('change', () => handlePeriodChange('primary'));
            yearSelect.addEventListener('change', () => handlePeriodChange('primary'));
            const stickyMonthSelect = document.getElementById('sticky-month-select');
            const stickyYearSelect = document.getElementById('sticky-year-select');
            if (stickyMonthSelect) {
                stickyMonthSelect.innerHTML = monthSelect.innerHTML;
                stickyMonthSelect.value = monthSelect.value;
                stickyMonthSelect.addEventListener('change', () => handlePeriodChange('sticky'));
            }
            if (stickyYearSelect) {
                stickyYearSelect.innerHTML = yearSelect.innerHTML;
                stickyYearSelect.value = yearSelect.value;
                stickyYearSelect.addEventListener('change', () => handlePeriodChange('sticky'));
            }
            if (typeof populateDynamicSelects === 'function') {
                populateDynamicSelects();
            }
            updateCompetencyTooltips();
            updateStickyPeriodBar();
            setupStickyObserver();
            initializeStickyPicker();
            initializePeriodNavButtons();
        }
        const formatCurrencyBRL = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        const getMonthYear = (dateString) => { const parts = dateString.split('-'); return parts.length >= 2 ? `${parts[1]}-${parts[0]}` : ''; };
        const MONEY_INPUT_SELECTOR = '[data-money-input="true"]';

        function initializeMoneyInputs() {
            document.querySelectorAll(MONEY_INPUT_SELECTOR).forEach(bindMoneyMask);
        }

        function bindMoneyMask(input) {
            if (!input || input.dataset.moneyMaskBound) return;
            input.dataset.moneyMaskBound = 'true';
            input.addEventListener('input', handleMoneyMaskInput);
            input.addEventListener('blur', handleMoneyMaskBlur);
        }

        function unbindMoneyMask(input) {
            if (!input || input.dataset.moneyMaskBound !== 'true') return;
            input.removeEventListener('input', handleMoneyMaskInput);
            input.removeEventListener('blur', handleMoneyMaskBlur);
            delete input.dataset.moneyMaskBound;
            delete input.dataset.moneyValue;
        }

        function handleMoneyMaskInput(event) {
            const input = event.target;
            const digits = (input.value || '').replace(/\D/g, '');
            if (!digits) {
                input.dataset.moneyValue = '0.00';
                input.value = '';
                return;
            }
            const numeric = parseInt(digits, 10) / 100;
            input.dataset.moneyValue = numeric.toFixed(2);
            input.value = numeric.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function handleMoneyMaskBlur(event) {
            const input = event.target;
            if (!input.value) return;
            const digits = input.value.replace(/\D/g, '');
            if (!digits) {
                input.dataset.moneyValue = '0.00';
                input.value = '';
                return;
            }
            const numeric = parseInt(digits, 10) / 100;
            input.dataset.moneyValue = numeric.toFixed(2);
            input.value = numeric.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getMoneyInputValue(target) {
            const input = typeof target === 'string' ? document.getElementById(target) : target;
            if (!input) return 0;
            const digits = (input.value || '').replace(/\D/g, '');
            if (!digits) {
                input.dataset.moneyValue = '0.00';
                return 0;
            }
            const numeric = parseInt(digits, 10) / 100;
            input.dataset.moneyValue = numeric.toFixed(2);
            return numeric;
        }

        function setMoneyInputValue(target, amount) {
            const input = typeof target === 'string' ? document.getElementById(target) : target;
            if (!input) return;
            const numeric = Number(amount);
            if (!isFinite(numeric) || numeric <= 0) {
                input.dataset.moneyValue = '0.00';
                input.value = '';
                return;
            }
            input.dataset.moneyValue = numeric.toFixed(2);
            input.value = numeric.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function clearMoneyInput(target) {
            const input = typeof target === 'string' ? document.getElementById(target) : target;
            if (!input) return;
            input.dataset.moneyValue = '0.00';
            input.value = '';
        }

        function setSplitValue(val, options = {}) {
            let numeric = Number(val);
            if (!Number.isFinite(numeric)) numeric = 0;
            numeric = Math.min(100, Math.max(0, numeric));
            const rounded = Math.round(numeric);
            const slider = document.getElementById('split-slider');
            if (slider && !options.skipSliderUpdate) slider.value = rounded;
            const manual = document.getElementById('split-manual-input');
            if (manual && !options.skipManualUpdate) manual.value = rounded;
            document.querySelectorAll('#split-presets button[data-value]').forEach(btn => {
                btn.classList.toggle('active', Number(btn.dataset.value) === rounded);
            });
            updateSplitDisplay(rounded);
            return rounded;
        }

        function updateSplitDisplay(val) {
            const el = document.getElementById('split-display');
            if (!el) return;
            const payerSelect = document.getElementById('expense-paid-by');
            const payerLabel = payerSelect?.value || appSettings.people[0]?.name || 'Pagador';
            const partnerLabel = appSettings.people[1]?.name || 'Parceiro';
            el.textContent = `${val}% ${payerLabel} / ${100 - val}% ${partnerLabel}`;
        }

        function handleBeneficiaryChange() {
            // Function placeholder - logic handled in handleTypeChange currently
        }

        function handleTypeChange() {
            const s = document.getElementById('expense-sharing-type');
            if (!s || s.selectedIndex < 0) return;
            const opt = s.options[s.selectedIndex];
            const isShared = opt.dataset.isShared === 'true';
            const isThirdParty = opt.dataset.isThirdParty === 'true';

            const splitDiv = document.getElementById('split-container');
            const benDiv = document.getElementById('beneficiary-container');

            if (isShared) {
                splitDiv.classList.remove('hidden');
                benDiv.classList.add('hidden');
                if (!editingExpenseId) {
                    setSplitValue(opt.dataset.split);
                }
            } else if (isThirdParty) {
                splitDiv.classList.add('hidden');
                if (appSettings.people.length > 2) benDiv.classList.remove('hidden');
                else benDiv.classList.add('hidden');
            } else {
                splitDiv.classList.add('hidden');
                benDiv.classList.add('hidden');
            }
        }

        function toggleRecurrenceInput() {
            const type = document.getElementById('expense-recurrence-type').value;
            const container = document.getElementById('recurrence-months-input');
            if (type === 'fixed') container.classList.remove('hidden');
            else container.classList.add('hidden');
        }

        function lockRecurrenceControlsForSeries(shouldLock) {
            const select = document.getElementById('expense-recurrence-type');
            const monthsInput = document.getElementById('expense-recurrence-months');
            if (!select) return;
            if (shouldLock) {
                select.dataset.locked = 'true';
                select.setAttribute('disabled', 'true');
                if (monthsInput) monthsInput.setAttribute('disabled', 'true');
            } else {
                select.dataset.locked = 'false';
                if (planAllowsRecurrence()) select.removeAttribute('disabled');
                if (monthsInput) monthsInput.removeAttribute('disabled');
                syncRecurrenceSection();
            }
        }

        function clampFixedRecurrenceMonths(value) {
            const numeric = Number(value) || MIN_FIXED_RECURRENCE_MONTHS;
            return Math.max(MIN_FIXED_RECURRENCE_MONTHS, Math.min(MAX_FIXED_RECURRENCE_MONTHS, numeric));
        }

        function addMonthsToISO(dateString, monthsToAdd) {
            if (!dateString) return dateString;
            const [year, month, day] = dateString.split('-').map(Number);
            if (!year || !month || !day) return dateString;
            const baseDate = new Date(year, month - 1, day);
            baseDate.setMonth(baseDate.getMonth() + monthsToAdd);
            const maxDay = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0).getDate();
            const targetDay = Math.min(day, maxDay);
            baseDate.setDate(targetDay);
            return baseDate.toISOString().split('T')[0];
        }

        function buildRecurringOccurrencePayload(basePayload, recurrenceType, seriesId, occurrenceIndex, totalOccurrences, options = {}) {
            const occurrenceDate = addMonthsToISO(basePayload.date, occurrenceIndex - 1);
            return {
                ...basePayload,
                date: occurrenceDate,
                monthYear: getMonthYear(occurrenceDate),
                recurrenceType,
                recurrenceMonths: recurrenceType === 'fixed' ? totalOccurrences : null,
                recurrenceSeriesId: seriesId,
                recurrenceIndex: occurrenceIndex,
                recurrenceTotal: recurrenceType === 'fixed' ? totalOccurrences : null,
                recurrenceSeriesActive: options.seriesActive ?? true,
                recurrenceIsCustom: options.isCustom ?? false,
                updatedAt: new Date(),
                createdAt: options.useExistingCreatedAt && basePayload.createdAt ? basePayload.createdAt : new Date()
            };
        }

        async function appendRecurringOccurrences(basePayload, recurrenceType, seriesId, totalOccurrences, startIndex = 2) {
            if (!db || startIndex > totalOccurrences) return;
            const batch = writeBatch(db);
            const colRef = collection(db, `${DB_BASE_PATH}/expenses`);
            for (let occurrenceIndex = startIndex; occurrenceIndex <= totalOccurrences; occurrenceIndex++) {
                const payload = buildRecurringOccurrencePayload(basePayload, recurrenceType, seriesId, occurrenceIndex, totalOccurrences);
                const docRef = doc(colRef);
                batch.set(docRef, payload);
            }
            await batch.commit();
        }

        async function createRecurringSeriesFromPayload(basePayload, recurrenceType, recurrenceMonths) {
            const seriesId = `rec_${Date.now()}`;
            const totalOccurrences = recurrenceType === 'fixed'
                ? clampFixedRecurrenceMonths(recurrenceMonths || MIN_FIXED_RECURRENCE_MONTHS)
                : MAX_INDEFINITE_MONTHS_AHEAD;
            const firstPayload = buildRecurringOccurrencePayload(basePayload, recurrenceType, seriesId, 1, totalOccurrences);
            await addDoc(collection(db, `${DB_BASE_PATH}/expenses`), firstPayload);
            if (totalOccurrences > 1) {
                await appendRecurringOccurrences(basePayload, recurrenceType, seriesId, totalOccurrences, 2);
            }
        }

        async function convertExpenseToRecurringSeries(expenseId, basePayload, recurrenceType, recurrenceMonths) {
            const seriesId = `rec_${Date.now()}`;
            const totalOccurrences = recurrenceType === 'fixed'
                ? clampFixedRecurrenceMonths(recurrenceMonths || MIN_FIXED_RECURRENCE_MONTHS)
                : MAX_INDEFINITE_MONTHS_AHEAD;
            const firstPayload = buildRecurringOccurrencePayload(basePayload, recurrenceType, seriesId, 1, totalOccurrences, { useExistingCreatedAt: !!basePayload.createdAt });
            await updateDoc(doc(db, `${DB_BASE_PATH}/expenses/${expenseId}`), firstPayload);
            if (totalOccurrences > 1) {
                await appendRecurringOccurrences(basePayload, recurrenceType, seriesId, totalOccurrences, 2);
            }
        }

        async function updateSingleRecurringExpense(docId, payload) {
            const updateData = stripCreateOnlyFields({ ...payload, recurrenceIsCustom: true, updatedAt: new Date() });
            await updateDoc(doc(db, `${DB_BASE_PATH}/expenses/${docId}`), updateData);
        }

        async function updateFutureRecurringExpenses(meta, payload) {
            if (!meta?.recurrenceSeriesId) return;
            const q = query(collection(db, `${DB_BASE_PATH}/expenses`), where('recurrenceSeriesId', '==', meta.recurrenceSeriesId));
            const snap = await getDocs(q);
            if (snap.empty) return;
            const baseIndex = meta.recurrenceIndex || 1;
            const docsToUpdate = snap.docs
                .map(docSnap => ({ ref: docSnap.ref, data: docSnap.data() }))
                .filter(item => (item.data.recurrenceIndex || 0) >= baseIndex)
                .sort((a, b) => (a.data.recurrenceIndex || 0) - (b.data.recurrenceIndex || 0));
            if (!docsToUpdate.length) return;
            const batch = writeBatch(db);
            docsToUpdate.forEach(item => {
                const offset = (item.data.recurrenceIndex || baseIndex) - baseIndex;
                const occurrenceDate = addMonthsToISO(payload.date, offset);
                const updateData = stripCreateOnlyFields({ ...payload });
                updateData.date = occurrenceDate;
                updateData.monthYear = getMonthYear(occurrenceDate);
                updateData.recurrenceIndex = item.data.recurrenceIndex;
                updateData.recurrenceIsCustom = false;
                updateData.updatedAt = new Date();
                batch.update(item.ref, updateData);
            });
            await batch.commit();
        }

        async function deleteFutureRecurringExpenses(meta) {
            if (!meta?.recurrenceSeriesId) return;
            const q = query(collection(db, `${DB_BASE_PATH}/expenses`), where('recurrenceSeriesId', '==', meta.recurrenceSeriesId));
            const snap = await getDocs(q);
            if (snap.empty) return;
            const baseIndex = meta.recurrenceIndex || 1;
            const docsToDelete = snap.docs.filter(docSnap => (docSnap.data().recurrenceIndex || 0) >= baseIndex);
            if (!docsToDelete.length) return;
            let batch = writeBatch(db);
            let ops = 0;
            const commitBatch = async () => {
                if (ops > 0) {
                    await batch.commit();
                    batch = writeBatch(db);
                    ops = 0;
                }
            };
            for (const docSnap of docsToDelete) {
                batch.delete(docSnap.ref);
                ops++;
                if (ops >= 400) await commitBatch();
            }
            await commitBatch();
            await markSeriesActive(meta.recurrenceSeriesId, false);
        }

        async function markSeriesActive(seriesId, isActive) {
            const q = query(collection(db, `${DB_BASE_PATH}/expenses`), where('recurrenceSeriesId', '==', seriesId));
            const snap = await getDocs(q);
            if (snap.empty) return;
            let batch = writeBatch(db);
            let ops = 0;
            const commitBatch = async () => {
                if (ops > 0) {
                    await batch.commit();
                    batch = writeBatch(db);
                    ops = 0;
                }
            };
            for (const docSnap of snap.docs) {
                batch.update(docSnap.ref, { recurrenceSeriesActive: isActive });
                ops++;
                if (ops >= 400) await commitBatch();
            }
            await commitBatch();
        }

        function queueRecurrenceScopeAction(context) {
            recurrenceActionContext = context;
            const modal = document.getElementById('modal-recurrence-scope');
            if (!modal) return;
            const title = document.getElementById('recurrence-modal-title');
            const description = document.getElementById('recurrence-modal-description');
            if (title) title.textContent = context.action === 'delete' ? 'Remover lanamentos' : 'Atualizar recorrncia';
            if (description) description.textContent = context.action === 'delete'
                ? 'Escolha se deseja remover somente este lanamento ou tambm os prximos.'
                : 'Escolha como aplicar as alteraes desta despesa recorrente.';
            modal.classList.remove('hidden');
            document.body.classList.add('modal-active');
            requestAnimationFrame(() => modal.classList.add('active'));
        }

        function closeRecurrenceScopeModal() {
            const modal = document.getElementById('modal-recurrence-scope');
            if (!modal) return;
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                refreshBodyModalState();
            }, 200);
        }

        async function handleRecurrenceScopeChoice(scope) {
            if (!recurrenceActionContext) return;
            const ctx = { ...recurrenceActionContext };
            recurrenceActionContext = null;
            closeRecurrenceScopeModal();
            try {
                if (ctx.action === 'edit') {
                    if (scope === 'single') await updateSingleRecurringExpense(ctx.docId, ctx.payload);
                    else await updateFutureRecurringExpenses(ctx.meta, ctx.payload);
                    resetExpenseForm();
                } else if (ctx.action === 'delete') {
                    if (scope === 'single') await deleteDoc(doc(db, `${DB_BASE_PATH}/expenses/${ctx.docId}`));
                    else await deleteFutureRecurringExpenses(ctx.meta);
                }
            } catch (error) {
                console.error('Erro ao aplicar ao de recorrncia', error);
                alert('No foi possvel concluir a ao na recorrncia.');
            }
        }

        function sanitizeSingleExpensePayload(basePayload) {
            const clone = { ...basePayload };
            clone.recurrenceType = 'none';
            clone.recurrenceMonths = null;
            clone.recurrenceSeriesId = null;
            clone.recurrenceIndex = null;
            clone.recurrenceTotal = null;
            clone.recurrenceSeriesActive = null;
            clone.recurrenceIsCustom = false;
            return stripCreateOnlyFields(clone);
        }

        function stripCreateOnlyFields(payload) {
            const clone = { ...payload };
            delete clone.createdAt;
            return clone;
        }

        function applyPrivacyMode() {
            const isPriv = localStorage.getItem('privacyMode') === 'true';
            document.querySelectorAll('.money-display').forEach(el => isPriv ? el.classList.add('blur-sensitive') : el.classList.remove('blur-sensitive'));
            document.querySelectorAll('[data-privacy-toggle]').forEach(btn => {
                btn.setAttribute('aria-pressed', String(isPriv));
                btn.innerHTML = isPriv ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
            });
        }

        function togglePrivacyMode() {
            const isPriv = localStorage.getItem('privacyMode') === 'true';
            localStorage.setItem('privacyMode', isPriv ? 'false' : 'true');
            applyPrivacyMode();
        }

        function applyIncomeVisibility(shouldShow) {
            const targets = ['card-income', 'card-balance', 'form-container-income', 'table-container-income'];
            targets.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('hidden', !shouldShow);
            });
        }

        function getPlanRules() {
            return PLAN_RULES[USER_PLAN] || PLAN_RULES.premium;
        }

        function planAllows(featureKey) {
            const rules = getPlanRules();
            return !!(rules.features && rules.features[featureKey]);
        }

        function planAllowsRecurrence() {
            return getPlanRules().key === 'premium';
        }

        function getPlanLimit(target) {
            const rules = getPlanRules();
            return rules.limits && typeof rules.limits[target] !== 'undefined' ? rules.limits[target] : Infinity;
        }

        function isPlanAtLimit(target) {
            const limit = getPlanLimit(target);
            if (!Number.isFinite(limit)) return false;
            const currentCount = target === 'goals' ? currentGoals.length : currentBudgets.length;
            return currentCount >= limit;
        }

        function showPlanRestrictionToast(message) {
            const toast = document.getElementById('plan-restriction-toast');
            const text = document.getElementById('plan-restriction-toast-text');
            if (!toast || !text) { alert(message); return; }
            text.textContent = message;
            toast.classList.remove('hidden');
            if (planToastTimeout) clearTimeout(planToastTimeout);
            planToastTimeout = setTimeout(() => hidePlanRestrictionToast(), 6000);
        }

        function hidePlanRestrictionToast() {
            const toast = document.getElementById('plan-restriction-toast');
            if (!toast) return;
            toast.classList.add('hidden');
            if (planToastTimeout) clearTimeout(planToastTimeout);
        }

        function handlePlanLimitAttempt(target) {
            const message = PLAN_LIMIT_MESSAGES[target] || 'Recurso exclusivo do plano Premium.';
            showPlanRestrictionToast(message);
        }

        function buildPlanComparisonCell(cellConfig, highlight = false) {
            const normalized = typeof cellConfig === 'string' ? { text: cellConfig, status: 'available' } : (cellConfig || {});
            const status = normalized.status || 'available';
            const iconByStatus = {
                available: 'fa-check-circle text-emerald-500',
                partial: 'fa-info-circle text-amber-500',
                unavailable: 'fa-minus-circle text-gray-300'
            };
            const iconClass = iconByStatus[status] || iconByStatus.available;
            const textClass = status === 'unavailable' ? 'text-gray-400' : 'text-indigo-950';
            const wrapperClass = highlight ? 'bg-white shadow-sm rounded-2xl px-3 py-2 border border-indigo-100' : 'rounded-xl px-2 py-1';
            return `
                <div class="flex items-start gap-2 ${wrapperClass}">
                    <span class="mt-0.5"><i class="fas ${iconClass}"></i></span>
                    <span class="text-sm ${textClass}">${normalized.text || ''}</span>
                </div>
            `;
        }

        function renderPremiumModalContent() {
            const featureList = document.getElementById('premium-feature-list');
            if (featureList) {
                featureList.innerHTML = PREMIUM_HIGHLIGHTS.map(({ icon, title, description }) => `
                    <li class="flex items-start gap-4 bg-white rounded-2xl border border-gray-100 p-4">
                        <span class="h-12 w-12 rounded-2xl bg-indigo-100 text-indigo-700 flex items-center justify-center text-lg">
                            <i class="fas ${icon}"></i>
                        </span>
                        <div>
                            <p class="text-sm font-semibold text-gray-900">${title}</p>
                            <p class="text-sm text-gray-600">${description}</p>
                        </div>
                    </li>
                `).join('');
            }

            const comparisonWrapper = document.getElementById('premium-plan-comparison');
            if (comparisonWrapper) {
                comparisonWrapper.innerHTML = `
                    <div class="grid grid-cols-[1.4fr,1fr,1fr] gap-3 text-[11px] font-semibold uppercase tracking-[0.2em] text-indigo-700">
                        <span class="tracking-[0.2em] text-left">Recursos</span>
                        <span class="text-center">Essencial</span>
                        <span class="text-center">Premium</span>
                    </div>
                    <div class="mt-3 space-y-3">
                        ${PLAN_COMPARISON_DETAILS.map(({ label, essential, premium }) => `
                            <div class="grid grid-cols-[1.4fr,1fr,1fr] gap-3 items-center bg-white rounded-2xl p-3 shadow-sm border border-indigo-100">
                                <div class="text-sm font-semibold text-indigo-900">${label}</div>
                                <div>${buildPlanComparisonCell(essential)}</div>
                                <div>${buildPlanComparisonCell(premium, true)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function syncPlanUI() {
            const rules = getPlanRules();
            if (document.body) document.body.dataset.planKey = rules.key;
            const badge = document.getElementById('plan-badge');
            if (badge) {
                badge.textContent = rules.badgeLabel;
                badge.classList.remove('hidden');
            }
            const banner = document.getElementById('plan-restrictions-banner');
            if (banner) {
                if (rules.key === 'premium') banner.classList.add('hidden');
                else {
                    banner.classList.remove('hidden');
                    const title = document.getElementById('plan-restrictions-title');
                    if (title) title.textContent = `Plano ${rules.label}`;
                    const list = document.getElementById('plan-restrictions-highlights');
                    if (list) list.innerHTML = (rules.summary || []).map(item => `<li><i class="fas fa-lock"></i>${item}</li>`).join('');
                }
            }
            syncPlanReportSections(rules.key);
            applyPremiumExtrasVisibility();
            updatePremiumPrintReport();
            syncRecurrenceSection();
        }

        function updatePlanLimitMessages() {
            const rules = getPlanRules();
            const goalMsg = document.getElementById('plan-limit-message-goals');
            if (goalMsg) {
                const locked = rules.key !== 'premium' && isPlanAtLimit('goals');
                goalMsg.classList.toggle('hidden', !locked);
                if (locked) goalMsg.innerHTML = `<i class="fas fa-lock"></i> ${PLAN_LIMIT_MESSAGES.goals}`;
            }
            const budgetMsg = document.getElementById('plan-limit-message-budgets');
            if (budgetMsg) {
                const locked = rules.key !== 'premium' && isPlanAtLimit('budgets');
                budgetMsg.classList.toggle('hidden', !locked);
                if (locked) budgetMsg.innerHTML = `<i class="fas fa-lock"></i> ${PLAN_LIMIT_MESSAGES.budgets}`;
            }
        }

        function syncRecurrenceSection() {
            const section = document.getElementById('recurrence-section');
            const select = document.getElementById('expense-recurrence-type');
            const monthsWrapper = document.getElementById('recurrence-months-input');
            const mask = document.getElementById('recurrence-premium-mask');
            const chip = document.getElementById('recurrence-premium-chip');
            const isPremium = planAllowsRecurrence();
            if (!section || !select) return;
            const isLocked = select.dataset.locked === 'true';
            if (!isPremium) {
                select.value = 'none';
                select.setAttribute('disabled', 'true');
                if (monthsWrapper) monthsWrapper.classList.add('hidden');
                if (mask) mask.classList.remove('hidden');
                if (chip) chip.classList.remove('hidden');
            } else {
                if (!isLocked) select.removeAttribute('disabled');
                if (mask) mask.classList.add('hidden');
                if (chip) chip.classList.add('hidden');
                if (isLocked) select.setAttribute('disabled', 'true');
            }
        }

        function openPremiumModal() {
            const modal = document.getElementById('modal-premium');
            if (!modal) {
                showPlanRestrictionToast('Em breve voc poder concluir a assinatura diretamente por aqui.');
                return;
            }
            renderPremiumModalContent();
            modal.classList.remove('hidden');
            document.body.classList.add('modal-active');
            requestAnimationFrame(() => modal.classList.add('active'));
        }

        function closePremiumModal() {
            const modal = document.getElementById('modal-premium');
            if (!modal) return;
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
            document.body.classList.remove('modal-active');
        }

        function requestPremiumInvite(action = 'upgrade') {
            const messages = {
                upgrade: 'Anotamos seu interesse. Vamos liberar o Premium manualmente nas prximas horas.',
                talk: 'Nosso time vai te chamar pelos canais habituais para finalizar o upgrade.'
            };
            const fallback = 'Estamos finalizando o checkout. Voc ser avisado assim que liberar.';
            showPlanRestrictionToast(messages[action] || fallback);
        }

        function applyPremiumExtrasVisibility() {
            const isPremiumPlan = getPlanRules().key === 'premium';
            const shouldShowExtras = isPremiumPlan && premiumExtrasEnabled;
            document.body.classList.toggle('premium-extras-enabled', shouldShowExtras);
            document.querySelectorAll('[data-premium-extra="true"]').forEach(section => {
                section.classList.toggle('hidden', !shouldShowExtras);
            });
            document.querySelectorAll('[data-premium-extras-wrapper="true"]').forEach(wrapper => {
                wrapper.classList.toggle('hidden', !isPremiumPlan);
            });
            document.querySelectorAll('[data-premium-extras-checkbox]').forEach(checkbox => {
                checkbox.checked = shouldShowExtras;
                checkbox.setAttribute('aria-checked', shouldShowExtras ? 'true' : 'false');
            });
        }

        function initializePremiumExtrasToggle() {
            const checkboxes = document.querySelectorAll('[data-premium-extras-checkbox]');
            if (!checkboxes.length) return;
            checkboxes.forEach(checkbox => {
                if (checkbox.dataset.bound === 'true') return;
                checkbox.dataset.bound = 'true';
                checkbox.addEventListener('change', (event) => {
                    premiumExtrasEnabled = event.target.checked;
                    localStorage.setItem(PREMIUM_EXTRAS_STORAGE_KEY, premiumExtrasEnabled ? 'true' : 'false');
                    applyPremiumExtrasVisibility();
                });
            });
            applyPremiumExtrasVisibility();
        }

        function ensurePremiumExtrasForPrint() {
            const planRules = getPlanRules();
            if (!planRules || planRules.key !== 'premium') return false;
            if (premiumExtrasEnabled) return premiumExtrasAutoEnabledForPrint;
            premiumExtrasAutoEnabledForPrint = true;
            premiumExtrasEnabled = true;
            applyPremiumExtrasVisibility();
            return true;
        }

        function restorePremiumExtrasAfterPrint() {
            if (!premiumExtrasAutoEnabledForPrint) return;
            premiumExtrasAutoEnabledForPrint = false;
            premiumExtrasEnabled = false;
            applyPremiumExtrasVisibility();
        }

        function syncPlanReportSections(planKey) {
            document.querySelectorAll('[data-plan-section]').forEach(section => {
                section.classList.toggle('hidden', section.dataset.planSection !== planKey);
            });
        }

        function destroyPremiumCharts() {
            Object.keys(premiumCharts).forEach(key => {
                if (premiumCharts[key]) {
                    premiumCharts[key].destroy();
                    premiumCharts[key] = null;
                }
            });
        }

        function getPreviousMonthYear(monthYear) {
            if (!monthYear || !monthYear.includes('-')) return '';
            const [monthStr, yearStr] = monthYear.split('-');
            let month = Number(monthStr);
            let year = Number(yearStr);
            if (!month || !year) return '';
            month -= 1;
            if (month <= 0) {
                month = 12;
                year -= 1;
            }
            return `${month.toString().padStart(2, '0')}-${year}`;
        }

        function formatMonthYearLabel(monthYear) {
            if (!monthYear) return '';
            const [monthStr, yearStr] = monthYear.split('-');
            const index = Number(monthStr) - 1;
            if (index < 0 || index >= MONTH_NAMES.length) return monthYear;
            return `${MONTH_NAMES[index]} de ${yearStr}`;
        }

        function calculateCategoryTotals(list) {
            const totals = {};
            list.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                const category = expense.category || 'Outros';
                totals[category] = (totals[category] || 0) + amount;
            });
            return totals;
        }

        function calculatePersonBreakdown() {
            if (!Array.isArray(appSettings.people) || !appSettings.people.length) return [];
            const peopleMap = {};
            appSettings.people.forEach(person => {
                if (!person?.name) return;
                peopleMap[person.name] = { name: person.name, paid: 0, consumed: 0 };
            });
            const names = Object.keys(peopleMap);
            if (!names.length) return [];
            currentExpenses.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                if (peopleMap[expense.paidBy]) peopleMap[expense.paidBy].paid += amount;
                const typeConfig = appSettings.expenseTypes.find(t => t.id === expense.typeId) || { isShared: false, isThirdParty: false };
                if (typeConfig.isShared) {
                    if (names.length === 2) {
                        const payer = expense.paidBy;
                        const partner = names.find(n => n !== payer) || payer;
                        const splitPercent = Math.min(100, Math.max(0, Number(expense.splitPercent ?? 50)));
                        const payerShare = amount * (splitPercent / 100);
                        const partnerShare = amount - payerShare;
                        if (peopleMap[payer]) peopleMap[payer].consumed += payerShare;
                        if (peopleMap[partner]) peopleMap[partner].consumed += partnerShare;
                    } else {
                        const share = amount / names.length;
                        names.forEach(name => { if (peopleMap[name]) peopleMap[name].consumed += share; });
                    }
                    return;
                }
                if (typeConfig.isThirdParty) {
                    const beneficiary = expense.beneficiary && peopleMap[expense.beneficiary] ? expense.beneficiary : expense.paidBy;
                    if (peopleMap[beneficiary]) peopleMap[beneficiary].consumed += amount;
                    return;
                }
                if (peopleMap[expense.paidBy]) peopleMap[expense.paidBy].consumed += amount;
            });
            return Object.values(peopleMap).map(entry => ({ ...entry, delta: entry.paid - entry.consumed })).sort((a, b) => b.consumed - a.consumed);
        }

        function normalizeCategoryKey(label) {
            return (label || 'Outros')
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .trim();
        }

        function getCategoryIcon(label) {
            const key = normalizeCategoryKey(label);
            return CATEGORY_ICON_MAP[key] || 'fa-wallet';
        }

        function clampPremiumTrendWindow(value) {
            const numeric = Number(value) || 6;
            return Math.max(2, Math.min(12, numeric));
        }

        function getMonthSequence(count, options = {}) {
            const includeCurrent = options.includeCurrent ?? false;
            const reference = options.startMonthYear || getCurrentFilterMonthYear();
            if (!reference || !reference.includes('-')) return [];
            const [monthStr, yearStr] = reference.split('-');
            let cursor = new Date(Number(yearStr), Number(monthStr) - 1, 1);
            if (!includeCurrent) cursor.setMonth(cursor.getMonth() - 1);
            const sequence = [];
            for (let i = 0; i < count; i++) {
                const month = (cursor.getMonth() + 1).toString().padStart(2, '0');
                sequence.push(`${month}-${cursor.getFullYear()}`);
                cursor.setMonth(cursor.getMonth() - 1);
            }
            return sequence.reverse();
        }

        function monthYearToDateValue(monthYear) {
            if (!monthYear || !monthYear.includes('-')) return 0;
            const [monthStr, yearStr] = monthYear.split('-');
            const year = Number(yearStr);
            const month = Number(monthStr) - 1;
            return new Date(year, month, 1).getTime();
        }

        function shiftMonthYear(monthYear, offset = 0) {
            if (!monthYear || !monthYear.includes('-')) return '';
            const [monthStr, yearStr] = monthYear.split('-');
            const baseDate = new Date(Number(yearStr), Number(monthStr) - 1, 1);
            baseDate.setMonth(baseDate.getMonth() + Number(offset || 0));
            const month = (baseDate.getMonth() + 1).toString().padStart(2, '0');
            return `${month}-${baseDate.getFullYear()}`;
        }

        function getMonthStartISO(monthYear) {
            if (!monthYear || !monthYear.includes('-')) return '';
            const [monthStr, yearStr] = monthYear.split('-');
            const month = monthStr.padStart(2, '0');
            return `${yearStr}-${month}-01`;
        }

        function getMonthEndISO(monthYear) {
            if (!monthYear || !monthYear.includes('-')) return '';
            const [monthStr, yearStr] = monthYear.split('-');
            const month = Number(monthStr);
            const year = Number(yearStr);
            if (!month || !year) return '';
            const lastDay = new Date(year, month, 0).getDate();
            return `${year}-${monthStr.padStart(2, '0')}-${lastDay.toString().padStart(2, '0')}`;
        }

        function getDaysInMonthYear(monthYear) {
            if (!monthYear || !monthYear.includes('-')) return 30;
            const [monthStr, yearStr] = monthYear.split('-');
            const month = Number(monthStr);
            const year = Number(yearStr);
            if (!month || !year) return 30;
            return new Date(year, month, 0).getDate();
        }

        function isFoodCategory(label) {
            const normalized = normalizeCategoryKey(label);
            if (!normalized) return false;
            return FOOD_CATEGORY_KEYS.some(keyword => normalized.includes(keyword));
        }

        function calculateTypeBreakdown() {
            const totals = {};
            currentExpenses.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                const typeConfig = appSettings.expenseTypes.find(t => t.id === expense.typeId);
                const label = typeConfig ? typeConfig.label : (expense.sharingType || 'Sem tipo');
                totals[label] = (totals[label] || 0) + amount;
            });
            return Object.entries(totals).sort((a, b) => b[1] - a[1]);
        }

        function buildCategoryVariationData() {
            const currentTotals = calculateCategoryTotals(currentExpenses);
            const categories = new Set([...Object.keys(currentTotals), ...Object.keys(previousMonthCategoryTotals || {})]);
            const rows = Array.from(categories).map(category => {
                const currentValue = currentTotals[category] || 0;
                const previousValue = previousMonthCategoryTotals[category] || 0;
                const diff = currentValue - previousValue;
                const pctChange = previousValue > 0 ? (diff / previousValue) * 100 : (currentValue > 0 ? 100 : 0);
                return { category, currentValue, previousValue, diff, pctChange };
            }).filter(row => row.currentValue > 0 || row.previousValue > 0)
                .sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
            return { rows, currentTotals };
        }

        function generatePremiumSuggestions(categoryRows, personBreakdown) {
            const suggestions = [];
            if (budgetAlertItems.length) {
                const critical = budgetAlertItems[0];
                suggestions.push(`O limite de ${critical.category} est ${critical.statusLabel.toLowerCase()}. ${critical.description}`);
            } else if (currentBudgets.length) {
                suggestions.push('Todos os limites esto dentro do esperado. Continue registrando para manter o controle.');
            }

            const increaseInsight = Array.isArray(categoryRows) ? categoryRows.find(row => row.diff > 0 && row.currentValue > 0) : null;
            if (increaseInsight && suggestions.length < 3) {
                const pctLabel = increaseInsight.previousValue > 0 ? `${Math.abs(increaseInsight.pctChange).toFixed(1)}%` : '100%';
                suggestions.push(`Os gastos com ${increaseInsight.category} cresceram ${pctLabel} em relao a ${previousMonthLabel || 'o ms anterior'}. Reavalie assinaturas e compras dessa categoria.`);
            }

            if (currentGoals.length && suggestions.length < 3) {
                const rankedGoals = currentGoals.map(goal => {
                    const saved = Number(goal.currentAmount) || 0;
                    const target = Number(goal.targetAmount) || 0;
                    const pct = target > 0 ? Math.min((saved / target) * 100, 100) : 0;
                    return { goal, pct };
                }).sort((a, b) => a.pct - b.pct);
                if (rankedGoals.length) {
                    const weakest = rankedGoals[0];
                    const monthlyHint = weakest.goal.strategyValue || (historicalAverageSurplus > 0 ? Math.max(historicalAverageSurplus * 0.1, 100) : 200);
                    suggestions.push(`A meta ${weakest.goal.name} est em ${Math.round(weakest.pct)}%. Reserve ${formatCurrencyBRL(monthlyHint)} por ms para acelerar o progresso.`);
                }
            }

            if (Array.isArray(personBreakdown) && personBreakdown.length && suggestions.length < 3) {
                const totalConsumed = personBreakdown.reduce((sum, entry) => sum + entry.consumed, 0);
                if (totalConsumed > 0) {
                    const leader = personBreakdown[0];
                    const share = ((leader.consumed / totalConsumed) * 100).toFixed(1);
                    suggestions.push(`${leader.name} concentrou ${share}% dos gastos do ms. Reequilibrem os lanamentos ou ajustem os splits caso necessrio.`);
                }
            }

            if (!suggestions.length) {
                suggestions.push('Continue registrando despesas para manter o histrico completo e gerar recomendaes personalizadas.');
            }

            return suggestions.slice(0, 3);
        }

        function buildPremiumCategoryHistory(expenses, orderedMonths = []) {
            const monthOrder = [];
            const seen = new Set();
            orderedMonths.forEach(month => {
                if (!month || seen.has(month)) return;
                seen.add(month);
                monthOrder.push(month);
            });
            const byMonth = {};
            monthOrder.forEach(month => { byMonth[month] = { total: 0, count: 0, categories: {} }; });
            expenses.forEach(expense => {
                const monthYear = expense.monthYear || getMonthYear(expense.date || '');
                if (!monthYear) return;
                if (!seen.has(monthYear)) {
                    seen.add(monthYear);
                    monthOrder.push(monthYear);
                    byMonth[monthYear] = { total: 0, count: 0, categories: {} };
                } else if (!byMonth[monthYear]) {
                    byMonth[monthYear] = { total: 0, count: 0, categories: {} };
                }
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                const category = expense.category || 'Outros';
                byMonth[monthYear].total += amount;
                byMonth[monthYear].count += 1;
                byMonth[monthYear].categories[category] = (byMonth[monthYear].categories[category] || 0) + amount;
            });
            monthOrder.sort((a, b) => monthYearToDateValue(a) - monthYearToDateValue(b));
            return { monthOrder, byMonth };
        }

        function buildCategoryAnalyticsData(expenses) {
            const totals = {};
            const counts = {};
            let total = 0;
            let expenseCount = 0;
            let foodTotal = 0;
            expenses.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                const category = expense.category || 'Outros';
                totals[category] = (totals[category] || 0) + amount;
                counts[category] = (counts[category] || 0) + 1;
                total += amount;
                expenseCount += 1;
                if (isFoodCategory(category)) foodTotal += amount;
            });
            const rows = Object.keys(totals).map(category => ({
                category,
                total: totals[category],
                count: counts[category],
                ticket: totals[category] / counts[category],
                share: total > 0 ? (totals[category] / total) * 100 : 0
            })).sort((a, b) => b.total - a.total);
            const categoryCount = rows.length;
            const leaderGap = (rows[0] && rows[1]) ? rows[0].share - rows[1].share : (rows[0]?.share || 0);
            const heavyShare = rows.filter(row => row.share >= 10).reduce((sum, row) => sum + row.share, 0);
            const topThreeShare = rows.slice(0, 3).reduce((sum, row) => sum + row.share, 0);
            return {
                rows,
                total,
                expenseCount,
                categoryCount,
                topCategory: rows[0] || null,
                leaderGap,
                foodShare: total > 0 ? (foodTotal / total) * 100 : 0,
                heavyShare,
                topThreeShare
            };
        }

        function renderPremiumCategoryAnalytics() {
            const summaryEl = document.getElementById('category-analytics-summary');
            const bodyEl = document.getElementById('category-analytics-body');
            if (!summaryEl || !bodyEl) return null;
            if (!currentExpenses.length) {
                summaryEl.innerHTML = '<div class="premium-empty">Cadastre despesas para destravar esta viso.</div>';
                bodyEl.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-sm text-gray-500">Sem registros neste perodo.</td></tr>';
                return null;
            }
            const analytics = buildCategoryAnalyticsData(currentExpenses);
            const avgPerCategory = analytics.categoryCount ? analytics.total / analytics.categoryCount : 0;
            const leaderLabel = analytics.topCategory ? `${analytics.topCategory.share.toFixed(1)}%  ${formatCurrencyBRL(analytics.topCategory.total)}` : '';
            const buildMiniCard = (label, value, detail, icon, extra = '') => {
                const detailLine = detail ? `<span class="detail">${detail}</span>` : '';
                return `
                <div class="premium-mini-card ${extra}">
                    <span class="icon-badge"><i class="fas ${icon}"></i></span>
                    <span class="label">${label}</span>
                    <span class="value">${value}</span>
                    ${detailLine}
                </div>`;
            };
            const buildListCard = (label, value, detail, icon, itemsHTML, extra = '') => `
                <div class="premium-mini-card list-card ${extra}">
                    <span class="icon-badge"><i class="fas ${icon}"></i></span>
                    <span class="label">${label}</span>
                    <span class="value">${value}</span>
                    <span class="detail">${detail}</span>
                    <ul>${itemsHTML}</ul>
                </div>`;
            const topList = analytics.rows.slice(0, 3);
            const topListContent = topList.length ? topList.map((row, index) => `
                <li>
                    <strong>${index + 1}. ${row.category}</strong>
                    <span>${formatCurrencyBRL(row.total)}  ${row.share.toFixed(1)}%</span>
                </li>`).join('') : '<li><strong>Sem categorias</strong><span>Cadastre despesas</span></li>';
            const variation = buildCategoryVariationData() || { rows: [] };
            const increaseRows = variation.rows.filter(row => row.diff > 0).sort((a, b) => b.diff - a.diff).slice(0, 3);
            const decreaseRows = variation.rows.filter(row => row.diff < 0).sort((a, b) => a.diff - b.diff).slice(0, 3);
            const formatTrendItems = (items, trend) => {
                if (!items.length) return '<li><strong>Sem dados</strong><span>Precisa de histrico</span></li>';
                return items.map(row => {
                    const arrowIcon = trend === 'down'
                        ? '<i class="fas fa-arrow-down trend-down"></i>'
                        : '<i class="fas fa-arrow-up trend-up"></i>';
                    const pct = isFinite(row.pctChange) ? `${Math.abs(row.pctChange).toFixed(1)}%` : '';
                    return `<li>
                        <span>${arrowIcon} ${row.category}</span>
                        <span>${formatCurrencyBRL(Math.abs(row.diff))}  ${pct}</span>
                    </li>`;
                }).join('');
            };
            const increaseTotal = increaseRows.reduce((sum, row) => sum + row.diff, 0);
            const decreaseTotal = decreaseRows.reduce((sum, row) => sum + Math.abs(row.diff), 0);
            const cards = [
                buildMiniCard('Gasto monitorado', formatCurrencyBRL(analytics.total), `${analytics.expenseCount} lanamentos`, 'fa-wallet'),
                buildMiniCard('Categorias ativas', analytics.categoryCount, '', 'fa-layer-group', 'accent-amber'),
                buildMiniCard('Top 3 concentram', `${analytics.topThreeShare.toFixed(1)}%`, 'do total do ms', 'fa-chart-pie', 'accent-rose'),
                buildMiniCard('Gap do lder', `${analytics.leaderGap.toFixed(1)}%`, 'vs 2 categoria', 'fa-arrows-up-down', 'accent-emerald'),
                buildMiniCard('Categoria lder', analytics.topCategory?.category || '', leaderLabel, 'fa-crown', 'accent-slate'),
                buildMiniCard('Alimentao', `${analytics.foodShare.toFixed(1)}%`, 'do total mensal', 'fa-utensils', 'accent-amber')
            ];
            const listCards = `
                <div class="premium-mini-list-group">
                    ${buildListCard('Top 3 categorias', topList.length ? 'Mais relevantes' : 'Sem dados', topList.length ? 'Participao atual' : 'Cadastre despesas', 'fa-list', topListContent, 'accent-slate')}
                    ${buildListCard('Maiores aumentos', increaseRows.length ? `+${formatCurrencyBRL(increaseTotal)}` : 'Sem variao', 'vs ms anterior', 'fa-arrow-trend-up', formatTrendItems(increaseRows, 'up'), 'accent-rose')}
                    ${buildListCard('Maiores quedas', decreaseRows.length ? `-${formatCurrencyBRL(decreaseTotal)}` : 'Sem variao', 'vs ms anterior', 'fa-arrow-trend-down', formatTrendItems(decreaseRows, 'down'), 'accent-emerald')}
                </div>`;
            summaryEl.innerHTML = cards.join('') + listCards;
            bodyEl.innerHTML = analytics.rows.map(row => `
                <tr>
                    <td class="px-3 py-2 text-gray-800">
                        <span class="inline-flex items-center gap-2">
                            <span class="category-icon-chip inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-100 text-slate-600 text-xs"><i class="fas ${getCategoryIcon(row.category)}"></i></span>
                            ${row.category}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-right text-gray-600">${row.count}</td>
                    <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(row.total)}</td>
                    <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(row.ticket)}</td>
                    <td class="px-3 py-2 text-right text-gray-700">${row.share.toFixed(1)}%</td>
                </tr>
            `).join('');
            return analytics;
        }

        function renderFoodDailyInsights() {
            const chartEl = document.getElementById('food-daily-chart');
            const statsEl = document.getElementById('food-daily-stats');
            if (!chartEl || !statsEl) return;
            const monthYear = getCurrentFilterMonthYear();
            if (!monthYear || !monthYear.includes('-')) return;
            const [monthStr, yearStr] = monthYear.split('-');
            const daysInMonth = getDaysInMonthYear(monthYear);
            const foodExpenses = currentExpenses.filter(expense => isFoodCategory(expense.category));
            const dailyTotals = {};
            foodExpenses.forEach(expense => {
                const amount = Number(expense.amount) || 0;
                if (amount <= 0) return;
                const dateKey = expense.date || '';
                dailyTotals[dateKey] = (dailyTotals[dateKey] || 0) + amount;
            });
            const labels = [];
            const values = [];
            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = day.toString().padStart(2, '0');
                const isoDate = `${yearStr}-${monthStr}-${dayStr}`;
                labels.push(`${dayStr}/${monthStr}`);
                values.push(Number((dailyTotals[isoDate] || 0).toFixed(2)));
            }
            if (premiumCharts.food) {
                premiumCharts.food.destroy();
                premiumCharts.food = null;
            }
            if (!foodExpenses.length) {
                chartEl.getContext('2d').clearRect(0, 0, chartEl.width, chartEl.height);
                statsEl.innerHTML = '<li class="premium-empty">Nenhum gasto com alimentao registrado neste perodo.</li>';
                return;
            }
            premiumCharts.food = new Chart(chartEl, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Alimentao por dia',
                        data: values,
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.15)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            const totalFood = foodExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
            const avgDaily = daysInMonth ? totalFood / daysInMonth : 0;
            const activeDays = Object.values(dailyTotals).filter(value => value > 0).length;
            const peakEntry = Object.entries(dailyTotals).sort((a, b) => b[1] - a[1])[0];
            const peakLabel = peakEntry ? peakEntry[0].split('-').reverse().slice(0, 2).join('/') : '';
            statsEl.innerHTML = `
                <li>Mdia diria: <strong class="money-display">${formatCurrencyBRL(avgDaily)}</strong></li>
                <li>Dia mais intenso: <strong>${peakLabel}</strong> (${formatCurrencyBRL(peakEntry ? peakEntry[1] : 0)})</li>
                <li>Dias com consumo: <strong>${activeDays}</strong> de ${daysInMonth}</li>`;
        }

        function renderPremiumTrendInsights() {
            const chartEl = document.getElementById('category-trend-chart');
            const summaryEl = document.getElementById('category-trend-summary');
            if (!chartEl || !summaryEl) return;
            const history = premiumCategoryHistory?.byMonth || {};
            const monthOrder = premiumCategoryHistory?.monthOrder || [];
            const currentMonth = getCurrentFilterMonthYear();
            const currentIndex = monthOrder.indexOf(currentMonth);
            const baselineMonths = currentIndex > 0 ? monthOrder.slice(Math.max(0, currentIndex - premiumTrendWindow), currentIndex) : [];
            if (premiumCharts.categoryTrend) {
                premiumCharts.categoryTrend.destroy();
                premiumCharts.categoryTrend = null;
            }
            if (!baselineMonths.length || !history[currentMonth]) {
                chartEl.getContext('2d').clearRect(0, 0, chartEl.width, chartEl.height);
                summaryEl.innerHTML = '<span class="premium-empty">Histrico insuficiente para comparar.</span>';
                return;
            }
            const baselineTotals = {};
            baselineMonths.forEach(month => {
                const categories = history[month]?.categories || {};
                Object.entries(categories).forEach(([category, amount]) => {
                    if (!baselineTotals[category]) baselineTotals[category] = { total: 0, months: 0 };
                    baselineTotals[category].total += amount;
                    baselineTotals[category].months += 1;
                });
            });
            const baselineAvg = {};
            Object.entries(baselineTotals).forEach(([category, meta]) => {
                if (meta.months > 0) baselineAvg[category] = meta.total / meta.months;
            });
            const currentCategories = history[currentMonth]?.categories || {};
            const categories = Array.from(new Set([...Object.keys(currentCategories), ...Object.keys(baselineAvg)]));
            const rows = categories.map(category => {
                const currentValue = currentCategories[category] || 0;
                const avgValue = baselineAvg[category] || 0;
                const delta = currentValue - avgValue;
                const pct = avgValue > 0 ? (delta / avgValue) * 100 : (currentValue > 0 ? 100 : 0);
                return { category, currentValue, avgValue, delta, pct };
            }).filter(row => row.currentValue > 0 || row.avgValue > 0)
                .sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta))
                .slice(0, 6);
            if (!rows.length) {
                chartEl.getContext('2d').clearRect(0, 0, chartEl.width, chartEl.height);
                summaryEl.innerHTML = '<span class="premium-empty">Nenhuma categoria relevante para exibir.</span>';
                return;
            }
            premiumCharts.categoryTrend = new Chart(chartEl, {
                type: 'bar',
                data: {
                    labels: rows.map(row => row.category),
                    datasets: [
                        { label: 'Ms atual', data: rows.map(row => Number(row.currentValue.toFixed(2))), backgroundColor: '#4f46e5' },
                        { label: 'Mdia janela', data: rows.map(row => Number(row.avgValue.toFixed(2))), backgroundColor: '#c4b5fd' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
            summaryEl.innerHTML = rows.slice(0, 3).map(row => {
                const isUp = row.delta >= 0;
                const icon = isUp ? 'fa-arrow-up' : 'fa-arrow-down';
                const color = isUp ? 'text-red-500' : 'text-green-600';
                return `<span><i class="fas ${icon} ${color}"></i> ${row.category}: ${row.pct.toFixed(1)}%</span>`;
            }).join('');
        }

        function renderRecurringForecastInsights() {
            const chartEl = document.getElementById('recurring-forecast-chart');
            const summaryEl = document.getElementById('recurring-forecast-summary');
            const bodyEl = document.getElementById('recurring-forecast-body');
            if (!chartEl || !summaryEl || !bodyEl) return;
            if (premiumCharts.recurring) {
                premiumCharts.recurring.destroy();
                premiumCharts.recurring = null;
            }
            if (!recurringForecastData.length) {
                chartEl.getContext('2d').clearRect(0, 0, chartEl.width, chartEl.height);
                summaryEl.innerHTML = '<span class="premium-empty">Cadastre despesas recorrentes para prever os prximos meses.</span>';
                bodyEl.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500">Sem projees disponveis.</td></tr>';
                return;
            }
            const labels = recurringForecastData.map(item => formatMonthYearLabel(item.month));
            const committed = recurringForecastData.map(item => Number(item.committed.toFixed(2)));
            const indefinite = recurringForecastData.map(item => Number(item.indefinite.toFixed(2)));
            premiumCharts.recurring = new Chart(chartEl, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Comprometido', data: committed, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', tension: 0.35, fill: false },
                        { label: 'Indefinido', data: indefinite, borderColor: '#f97316', backgroundColor: 'rgba(249,115,22,0.1)', tension: 0.35, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            summaryEl.innerHTML = recurringForecastData.slice(0, 3).map(item => {
                const total = item.committed + item.indefinite;
                return `<span>${formatMonthYearLabel(item.month)}  <strong class="money-display">${formatCurrencyBRL(total)}</strong></span>`;
            }).join('');
            bodyEl.innerHTML = recurringForecastData.map(item => `
                <tr>
                    <td class="px-3 py-2 text-gray-800">${formatMonthYearLabel(item.month)}</td>
                    <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(item.committed)}</td>
                    <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(item.indefinite)}</td>
                    <td class="px-3 py-2 text-right text-gray-700">${item.occurrences}</td>
                </tr>
            `).join('');
        }

        function updatePremiumPrintHeroMetrics() {
            const heroCard = document.getElementById('premium-print-hero');
            if (!heroCard) return;
            const hasExpenses = currentExpenses.length > 0;
            heroCard.classList.toggle('hidden', !hasExpenses);
            if (!hasExpenses) return;
            const monthLabel = document.getElementById('premium-print-hero-period');
            if (monthLabel) monthLabel.textContent = getCurrentFilterLabel();
            const headerPeriod = document.getElementById('print-header-period');
            if (headerPeriod) headerPeriod.textContent = getCurrentFilterLabel();
            const total = currentExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
            const ticket = currentExpenses.length ? total / currentExpenses.length : 0;
            const ticketEl = document.getElementById('premium-print-ticket');
            if (ticketEl) ticketEl.textContent = formatCurrencyBRL(ticket);
            const monthYear = getCurrentFilterMonthYear();
            const foodTotal = currentExpenses.filter(expense => isFoodCategory(expense.category)).reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
            const daysInPeriod = getDaysInMonthYear(monthYear);
            const foodEl = document.getElementById('premium-print-food');
            if (foodEl) foodEl.textContent = formatCurrencyBRL(daysInPeriod ? foodTotal / daysInPeriod : 0);
            const forecastValue = recurringForecastData.slice(0, 3).reduce((sum, item) => sum + item.committed, 0);
            const forecastEl = document.getElementById('premium-print-forecast');
            if (forecastEl) forecastEl.textContent = formatCurrencyBRL(forecastValue);
        }

        function updatePremiumPrintHeaderMetadata() {
            const emailEl = document.getElementById('print-header-email');
            const screenEmail = document.getElementById('user-email-display')?.textContent?.trim();
            if (emailEl) emailEl.textContent = screenEmail || 'Conta compartilhada';
            const dateEl = document.getElementById('print-header-date');
            if (dateEl) {
                const now = new Date();
                const formatted = now.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                dateEl.textContent = formatted;
            }
            const periodEl = document.getElementById('print-header-period');
            if (periodEl) periodEl.textContent = getCurrentFilterLabel();
        }

        function waitForImageReady(image) {
            if (!image) return Promise.resolve();
            if (image.complete && image.naturalWidth > 0) return Promise.resolve();
            if (typeof image.decode === 'function') {
                return image.decode().catch(() => { });
            }
            return new Promise((resolve) => {
                const finalize = () => {
                    image.removeEventListener('load', finalize);
                    image.removeEventListener('error', finalize);
                    resolve();
                };
                image.addEventListener('load', finalize, { once: true });
                image.addEventListener('error', finalize, { once: true });
            });
        }

        async function generatePrintChartSnapshots({ force = false } = {}) {
            if (!force && document.body.dataset.printPrepared === 'true') return;
            const decodePromises = [];
            await nextFrame();
            PRINT_CHART_IDS.forEach((chartId) => {
                const canvas = document.getElementById(chartId);
                if (!canvas || typeof canvas.toDataURL !== 'function') return;
                const parent = canvas.parentElement;
                if (!parent) return;
                const imageId = `${chartId}-print-snapshot`;
                let image = document.getElementById(imageId);
                if (!image) {
                    image = document.createElement('img');
                    image.id = imageId;
                    image.className = 'print-canvas';
                    image.alt = 'Prvia do grfico para impresso';
                    image.loading = 'eager';
                    image.decoding = 'sync';
                    parent.appendChild(image);
                }
                let dataUrl = '';
                try {
                    dataUrl = canvas.toDataURL('image/png');
                } catch (error) {
                    console.warn('Falha ao capturar grfico para impresso', chartId, error);
                }
                if (dataUrl && dataUrl.startsWith('data:image')) {
                    image.src = dataUrl;
                    canvas.classList.add('print-hidden-canvas');
                    decodePromises.push(waitForImageReady(image));
                } else {
                    if (image) image.remove();
                    canvas.classList.remove('print-hidden-canvas');
                }
            });
            await Promise.all(decodePromises);
            document.body.dataset.printPrepared = 'true';
        }

        function cleanupPrintChartSnapshots() {
            document.querySelectorAll('.print-hidden-canvas').forEach((canvas) => canvas.classList.remove('print-hidden-canvas'));
            PRINT_CHART_IDS.forEach((chartId) => {
                const image = document.getElementById(`${chartId}-print-snapshot`);
                if (image) image.remove();
            });
            delete document.body.dataset.printPrepared;
        }

        function nextFrame() {
            return new Promise((resolve) => requestAnimationFrame(resolve));
        }

        async function preparePrintVisuals(forceSnapshots = false) {
            updatePremiumPrintHeaderMetadata();
            await nextFrame();
            if (premiumCharts && typeof premiumCharts === 'object') {
                Object.values(premiumCharts).forEach(chart => {
                    if (!chart) return;
                    if (typeof chart.resize === 'function') chart.resize();
                    if (typeof chart.update === 'function') chart.update('none');
                });
            }
            await nextFrame();
            await generatePrintChartSnapshots({ force: forceSnapshots });
            await nextFrame();
        }

        async function triggerPrint(isSimplified = false) {
            if (isPrintInProgress) return;
            isPrintInProgress = true;
            const autoEnabledExtras = ensurePremiumExtrasForPrint();
            try {
                if (isSimplified) {
                    document.body.dataset.printMode = 'basic';
                } else {
                    delete document.body.dataset.printMode;
                }
                await preparePrintVisuals(true);
                await nextFrame();
                await nextFrame();
                window.print();
            } catch (error) {
                if (autoEnabledExtras) restorePremiumExtrasAfterPrint();
                console.error(error);
            } finally {
                isPrintInProgress = false;
            }
        }

        function updatePremiumPrintReport() {
            const premiumSection = document.getElementById('premium-report-section');
            if (!premiumSection || getPlanRules().key !== 'premium') {
                destroyPremiumCharts();
                const heroCard = document.getElementById('premium-print-hero');
                if (heroCard) heroCard.classList.add('hidden');
                return;
            }

            if (!premiumCategoryHistory || !premiumCategoryHistory.byMonth) {
                premiumCategoryHistory = { monthOrder: [], byMonth: {} };
            }

            const currentMonthYear = getCurrentFilterMonthYear();
            const analytics = renderPremiumCategoryAnalytics();
            if (analytics) {
                premiumCategoryHistory.byMonth[currentMonthYear] = {
                    total: analytics.total,
                    count: analytics.expenseCount,
                    categories: analytics.rows.reduce((acc, row) => {
                        acc[row.category] = row.total;
                        return acc;
                    }, {})
                };
                if (!premiumCategoryHistory.monthOrder.includes(currentMonthYear)) {
                    premiumCategoryHistory.monthOrder.push(currentMonthYear);
                    premiumCategoryHistory.monthOrder.sort((a, b) => monthYearToDateValue(a) - monthYearToDateValue(b));
                }
            }

            updatePremiumPrintHeroMetrics();
            updatePremiumPrintHeaderMetadata();

            const monthLabel = document.getElementById('premium-month-label');
            if (monthLabel) monthLabel.textContent = getCurrentFilterLabel();
            const comparisonLabel = document.getElementById('premium-comparison-label');
            if (comparisonLabel) comparisonLabel.textContent = previousMonthLabel ? `Comparado a ${previousMonthLabel}` : 'Sem histrico';

            const peopleList = document.getElementById('premium-people-list');
            if (peopleList) {
                if (!appSettings.people.length) {
                    peopleList.innerHTML = '<li class="premium-empty">Cadastre pessoas nas configuraes para acompanhar seus relatrios individuais.</li>';
                } else {
                    peopleList.innerHTML = appSettings.people.map(person => `<li>${person.name}</li>`).join('');
                }
            }

            const personBreakdown = calculatePersonBreakdown();
            const personBody = document.getElementById('person-breakdown-body');
            if (personBody) {
                if (!personBreakdown.length) {
                    personBody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500">Sem movimentaes para este perodo.</td></tr>';
                } else {
                    personBody.innerHTML = personBreakdown.map(entry => {
                        const deltaClass = entry.delta >= 0 ? 'text-green-600' : 'text-red-600';
                        const deltaLabel = entry.delta === 0 ? 'equilbrio' : (entry.delta > 0 ? 'a receber' : 'a pagar');
                        return `<tr>
                            <td class="px-3 py-2 font-semibold text-gray-800">${entry.name}</td>
                            <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(entry.paid)}</td>
                            <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(entry.consumed)}</td>
                            <td class="px-3 py-2 text-right font-semibold ${deltaClass}"><span class="money-display">${formatCurrencyBRL(Math.abs(entry.delta))}</span><span class="block text-[11px] uppercase tracking-wide text-gray-400">${deltaLabel}</span></td>
                        </tr>`;
                    }).join('');
                }
            }

            const personChartEl = document.getElementById('person-spending-chart');
            if (personChartEl) {
                if (premiumCharts.person) premiumCharts.person.destroy();
                const chartData = personBreakdown.filter(item => item.consumed > 0);
                if (chartData.length) {
                    premiumCharts.person = new Chart(personChartEl, {
                        type: 'bar',
                        data: {
                            labels: chartData.map(item => item.name),
                            datasets: [{
                                label: 'Participao nas despesas',
                                data: chartData.map(item => Number(item.consumed.toFixed(2))),
                                backgroundColor: ['#4f46e5', '#6366f1', '#a5b4fc', '#f472b6', '#34d399', '#facc15']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                } else {
                    premiumCharts.person = null;
                    personChartEl.getContext('2d').clearRect(0, 0, personChartEl.width, personChartEl.height);
                }
            }

            const typeBreakdown = calculateTypeBreakdown();
            const typeBody = document.getElementById('type-breakdown-body');
            if (typeBody) {
                if (!typeBreakdown.length) {
                    typeBody.innerHTML = '<tr><td colspan="2" class="px-3 py-4 text-center text-sm text-gray-500">Sem dados de tipos personalizados.</td></tr>';
                } else {
                    typeBody.innerHTML = typeBreakdown.slice(0, 6).map(([label, total]) => `
                        <tr>
                            <td class="px-3 py-2 text-gray-800">${label}</td>
                            <td class="px-3 py-2 text-right money-display text-gray-700">${formatCurrencyBRL(total)}</td>
                        </tr>
                    `).join('');
                }
            }

            const typeChartEl = document.getElementById('type-breakdown-chart');
            if (typeChartEl) {
                if (premiumCharts.type) premiumCharts.type.destroy();
                const chartData = typeBreakdown.slice(0, 6);
                if (chartData.length) {
                    premiumCharts.type = new Chart(typeChartEl, {
                        type: 'doughnut',
                        data: {
                            labels: chartData.map(item => item[0]),
                            datasets: [{
                                data: chartData.map(item => Number(item[1].toFixed(2))),
                                backgroundColor: ['#4f46e5', '#22d3ee', '#fb7185', '#34d399', '#facc15', '#f97316']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                } else {
                    premiumCharts.type = null;
                    typeChartEl.getContext('2d').clearRect(0, 0, typeChartEl.width, typeChartEl.height);
                }
            }

            const { rows: categoryRows } = buildCategoryVariationData();
            const variationList = document.getElementById('category-variation-list');
            if (variationList) {
                if (!categoryRows.length) {
                    variationList.innerHTML = '<li class="premium-empty">Ainda no h histrico suficiente para comparar categorias.</li>';
                } else {
                    variationList.innerHTML = categoryRows.slice(0, 5).map(row => {
                        const directionUp = row.diff >= 0;
                        const arrowIcon = directionUp ? '<i class="fas fa-arrow-trend-up text-red-500"></i>' : '<i class="fas fa-arrow-trend-down text-green-600"></i>';
                        const pctLabel = row.previousValue > 0 ? `${directionUp ? '+' : '-'}${Math.abs(row.pctChange).toFixed(1)}%` : 'novo';
                        const pctWidth = Math.min(Math.abs(row.pctChange) || 0, 100);
                        return `<li class="premium-variation-item">
                            <div class="flex items-center justify-between">
                                <strong>${row.category}</strong>
                                <span class="money-display text-sm font-semibold text-gray-800">${formatCurrencyBRL(row.currentValue)}</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                                <span>${arrowIcon} ${directionUp ? 'Aumento' : 'Reduo'}</span>
                                <span>${pctLabel}</span>
                            </div>
                            <div class="variation-bar">
                                <div class="variation-bar-fill ${directionUp ? 'up' : 'down'}" style="width:${pctWidth}%"></div>
                            </div>
                        </li>`;
                    }).join('');
                }
            }

            const budgetSummary = document.getElementById('premium-budget-summary');
            if (budgetSummary) {
                if (!currentBudgets.length) {
                    budgetSummary.innerHTML = '<p class="premium-empty">Nenhum limite ativo neste perodo.</p>';
                } else {
                    const spendingMap = {};
                    currentExpenses.forEach(expense => {
                        const key = (expense.category || '').toLowerCase();
                        spendingMap[key] = (spendingMap[key] || 0) + (Number(expense.amount) || 0);
                    });
                    budgetSummary.innerHTML = currentBudgets.map(budget => {
                        const categoryLabel = budget.category || 'Sem categoria';
                        const categoryKey = categoryLabel.toLowerCase();
                        const spent = spendingMap[categoryKey] || 0;
                        const limit = Number(budget.limitAmount) || 0;
                        const pct = limit > 0 ? (spent / limit) * 100 : 0;
                        let statusClass = 'text-green-600';
                        let statusLabel = 'Em dia';
                        if (pct >= 95) { statusClass = 'text-red-600'; statusLabel = 'Crtico'; }
                        else if (pct >= 75) { statusClass = 'text-yellow-600'; statusLabel = 'Ateno'; }
                        return `<div class="flex items-center justify-between border border-gray-100 rounded-lg p-3">
                            <div>
                                <p class="font-semibold text-gray-800">${categoryLabel}</p>
                                <p class="text-xs text-gray-500"><span class="money-display">${formatCurrencyBRL(spent)}</span> de <span class="money-display">${formatCurrencyBRL(limit)}</span></p>
                            </div>
                            <span class="text-xs font-semibold ${statusClass}">${statusLabel}</span>
                        </div>`;
                    }).join('');
                }
            }

            const suggestions = generatePremiumSuggestions(categoryRows, personBreakdown);
            const suggestionsList = document.getElementById('premium-suggestions-list');
            if (suggestionsList) {
                suggestionsList.innerHTML = suggestions.map(text => `<li>${text}</li>`).join('');
            }

            renderFoodDailyInsights();
            renderPremiumTrendInsights();
            renderRecurringForecastInsights();

            applyPrivacyMode();
        }

        async function loadPreviousMonthStats(monthYear) {
            if (!db) return;
            const previousMonthYear = getPreviousMonthYear(monthYear);
            previousMonthLabel = previousMonthYear ? formatMonthYearLabel(previousMonthYear) : '';
            if (!previousMonthYear) {
                previousMonthCategoryTotals = {};
                updatePremiumPrintReport();
                return;
            }
            try {
                const comparisonQuery = query(collection(db, `${DB_BASE_PATH}/expenses`), where('monthYear', '==', previousMonthYear));
                const snapshot = await getDocs(comparisonQuery);
                const totals = {};
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const amount = Number(data.amount) || 0;
                    if (amount <= 0) return;
                    const category = data.category || 'Outros';
                    totals[category] = (totals[category] || 0) + amount;
                });
                previousMonthCategoryTotals = totals;
            } catch (error) {
                console.error('Erro ao carregar histrico para o relatrio premium', error);
                previousMonthCategoryTotals = {};
            }
            updatePremiumPrintReport();
        }

        async function loadPremiumAnalyticsData(monthYear) {
            if (!db || !monthYear) return;
            premiumAnalyticsRequestId += 1;
            const requestId = premiumAnalyticsRequestId;
            const orderedMonths = getMonthSequence(12, { includeCurrent: true, startMonthYear: monthYear });
            if (!orderedMonths.length) {
                premiumRecentExpenses = [];
                premiumCategoryHistory = { monthOrder: [], byMonth: {} };
                recurringForecastData = [];
                updatePremiumPrintReport();
                return;
            }
            try {
                const startISO = getMonthStartISO(orderedMonths[0]);
                const endISO = getMonthEndISO(orderedMonths[orderedMonths.length - 1]);
                const historyQuery = query(collection(db, `${DB_BASE_PATH}/expenses`), orderBy('date'), startAt(startISO), endAt(endISO));
                const [historySnapshot, forecastRows] = await Promise.all([
                    getDocs(historyQuery),
                    fetchRecurringForecastRange(monthYear)
                ]);
                if (requestId !== premiumAnalyticsRequestId) return;
                premiumRecentExpenses = historySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                premiumCategoryHistory = buildPremiumCategoryHistory(premiumRecentExpenses, orderedMonths);
                recurringForecastData = forecastRows;
                recurringForecastMeta.generatedAt = Date.now();
            } catch (error) {
                console.error('Erro ao carregar anlises premium', error);
                if (requestId !== premiumAnalyticsRequestId) return;
                premiumRecentExpenses = [];
                premiumCategoryHistory = { monthOrder: [], byMonth: {} };
                recurringForecastData = [];
            }
            updatePremiumPrintReport();
        }

        async function fetchRecurringForecastRange(monthYear) {
            if (!db) return [];
            const startMonth = shiftMonthYear(monthYear, 1);
            if (!startMonth) return [];
            const months = [];
            for (let i = 0; i < MAX_INDEFINITE_MONTHS_AHEAD; i++) {
                const target = shiftMonthYear(startMonth, i);
                if (target) months.push(target);
            }
            if (!months.length) return [];
            const startISO = getMonthStartISO(months[0]);
            const endISO = getMonthEndISO(months[months.length - 1]);
            try {
                const forecastQuery = query(collection(db, `${DB_BASE_PATH}/expenses`), orderBy('date'), startAt(startISO), endAt(endISO));
                const snapshot = await getDocs(forecastQuery);
                const aggregation = {};
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!data?.recurrenceSeriesId || data.recurrenceSeriesActive === false) return;
                    const amount = Number(data.amount) || 0;
                    if (amount <= 0) return;
                    const month = data.monthYear || getMonthYear(data.date || '');
                    if (!month || !months.includes(month)) return;
                    if (!aggregation[month]) aggregation[month] = { committed: 0, indefinite: 0, occurrences: 0 };
                    if (data.recurrenceType === 'fixed') aggregation[month].committed += amount;
                    else aggregation[month].indefinite += amount;
                    aggregation[month].occurrences += 1;
                });
                return months.map(month => ({
                    month,
                    committed: aggregation[month]?.committed || 0,
                    indefinite: aggregation[month]?.indefinite || 0,
                    occurrences: aggregation[month]?.occurrences || 0
                })).filter(entry => entry.committed > 0 || entry.indefinite > 0);
            } catch (error) {
                console.error('Erro ao gerar previso de recorrncias', error);
                return [];
            }
        }

        function initializePremiumTrendWindowControl() {
            const select = document.getElementById('premium-trend-window');
            if (!select || select.dataset.bound === 'true') return;
            select.dataset.bound = 'true';
            select.value = premiumTrendWindow.toString();
            select.addEventListener('change', () => {
                premiumTrendWindow = clampPremiumTrendWindow(select.value);
                renderPremiumTrendInsights();
            });
        }

        function syncPremiumTrendWindowControl() {
            const select = document.getElementById('premium-trend-window');
            if (select) select.value = premiumTrendWindow.toString();
        }

        function applyTheme(theme) {
            const normalized = theme === 'dark' ? 'dark' : 'light';
            currentTheme = normalized;
            document.body.classList.toggle('theme-dark', normalized === 'dark');
            document.querySelectorAll('[data-theme-icon]').forEach(icon => {
                icon.className = normalized === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            });
            document.querySelectorAll('[data-theme-label]').forEach(label => {
                label.textContent = normalized === 'dark' ? 'Modo claro' : 'Modo escuro';
            });
            document.querySelectorAll('[data-theme-toggle]').forEach(btn => {
                btn.setAttribute('aria-pressed', normalized === 'dark' ? 'true' : 'false');
            });
        }

        function initializeThemeToggle() {
            if (themeToggleInitialized) {
                applyTheme(currentTheme);
                return;
            }
            const buttons = document.querySelectorAll('[data-theme-toggle]');
            if (!buttons.length) return;
            themeToggleInitialized = true;
            applyTheme(currentTheme);
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    localStorage.setItem(THEME_STORAGE_KEY, nextTheme);
                    applyTheme(nextTheme);
                });
            });
        }

        function openBudgetAlertsModal() {
            if (!planAllows('budgetAlerts')) { showPlanRestrictionToast('Alertas inteligentes so exclusivos do plano Premium.'); return; }
            if (!budgetAlertItems.length) { alert('Sem alertas crticos no momento.'); return; }
            const list = document.getElementById('budget-alerts-list');
            if (list) {
                list.innerHTML = budgetAlertItems.map(item => {
                    const remainder = item.remaining;
                    const remainderLabel = remainder >= 0 ? `${formatCurrencyBRL(remainder)} disponvel` : `Excedente de ${formatCurrencyBRL(Math.abs(remainder))}`;
                    const remainderClass = remainder >= 0 ? 'ok' : 'over';
                    return `<div class="budget-alert-card status-${item.statusKey}">
                        <div class="flex justify-between items-center mb-3">
                            <span class="alert-badge">${item.statusLabel}</span>
                            <span class="text-xs text-gray-500">${item.pct}% do limite</span>
                        </div>
                        <h3>${item.category}</h3>
                        <p class="text-sm font-medium text-gray-700">${item.headline}</p>
                        <p class="text-sm text-gray-500 mb-2">${item.description}</p>
                        <p class="text-sm">Gasto <span class="money-display">${formatCurrencyBRL(item.spent)}</span> de <span class="money-display">${formatCurrencyBRL(item.limit)}</span></p>
                        <p class="alert-remainder ${remainderClass}">${remainderLabel}</p>
                    </div>`;
                }).join('');
                applyPrivacyMode();
            }
            const modal = document.getElementById('modal-budget-alerts');
            if (!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeBudgetAlertsModal() {
            const modal = document.getElementById('modal-budget-alerts');
            if (!modal) return;
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        function initializeGoalSuggestions() {
            if (goalSuggestionInitialized) return;
            const select = document.getElementById('goal-suggestion-select');
            const description = document.getElementById('goal-suggestion-description');
            const applyBtn = document.getElementById('goal-suggestion-apply');
            if (!select || !description || !applyBtn) return;

            const defaultMessage = description.textContent;
            select.innerHTML = ['<option value="" selected>Selecione uma inspirao</option>', ...GOAL_SUGGESTIONS.map(s => `<option value="${s.id}">${s.label}</option>`)].join('');

            const refreshDescription = () => {
                const suggestion = GOAL_SUGGESTIONS.find(s => s.id === select.value);
                description.textContent = suggestion ? suggestion.description : defaultMessage;
                applyBtn.disabled = !suggestion;
                applyBtn.classList.toggle('opacity-50', !suggestion);
                applyBtn.classList.toggle('cursor-not-allowed', !suggestion);
            };

            applyBtn.addEventListener('click', () => {
                const suggestion = GOAL_SUGGESTIONS.find(s => s.id === select.value);
                if (!suggestion) return;
                openGoalModal();
                document.getElementById('goal-name').value = suggestion.name;
                setMoneyInputValue('goal-target', suggestion.targetAmount);
                document.getElementById('goal-strategy').value = suggestion.strategy;
                handleGoalStrategyChange();
                const valueInput = document.getElementById('goal-strategy-value');
                if (suggestion.strategy === 'fixed') setMoneyInputValue(valueInput, suggestion.strategyValue || 0);
                else if (suggestion.strategy !== 'manual') valueInput.value = suggestion.strategyValue || '';
                else valueInput.value = '';
                updateGoalStrategyHint();
                document.getElementById('goal-name').focus();
            });

            select.addEventListener('change', refreshDescription);
            refreshDescription();
            goalSuggestionInitialized = true;
        }

        function getGoalStrategyDisplay(goal) {
            const value = Number(goal.strategyValue) || 0;
            if (goal.strategy === 'fixed' && value > 0) return { label: 'Aporte mensal', detail: `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, icon: 'fa-repeat' };
            if (goal.strategy === 'percentage' && value > 0) return { label: 'Percentual', detail: `${value}% da renda`, icon: 'fa-percent' };
            return { label: 'Manual', detail: 'Aportes sob demanda', icon: 'fa-pen' };
        }

        function describeGoalStrategy(goal) {
            const value = Number(goal.strategyValue) || 0;
            if (goal.strategy === 'fixed' && value > 0) return `Guardando ${formatCurrencyBRL(value)} todo ms.`;
            if (goal.strategy === 'percentage' && value > 0) return `Reservando ${value}% do excedente mensal.`;
            return 'Lanando aportes conforme disponibilidade.';
        }

        function getGoalProjection(goal) {
            const current = Number(goal.currentAmount) || 0;
            const target = Number(goal.targetAmount) || 0;
            const remaining = Math.max(target - current, 0);
            if (remaining <= 0) return 'Meta concluda';
            const value = Number(goal.strategyValue) || 0;
            if (goal.strategy === 'fixed' && value > 0) {
                const months = Math.max(1, Math.ceil(remaining / value));
                return `${months} ${months === 1 ? 'ms' : 'meses'} restantes`;
            }
            return 'Defina um aporte fixo para prever o fim';
        }

        function buildGoalCard(goal, index) {
            const theme = GOAL_CARD_THEMES[index % GOAL_CARD_THEMES.length];
            const current = Number(goal.currentAmount) || 0;
            const target = Number(goal.targetAmount) || 0;
            const pctRaw = target > 0 ? (current / target) * 100 : 0;
            const pct = Math.min(Math.max(pctRaw, 0), 100);
            const goalName = goal.name || 'Meta sem nome';
            const { icon, label } = getGoalStrategyDisplay(goal);
            const historyCount = Array.isArray(goal.history) ? goal.history.length : 0;
            const lastEntry = historyCount ? goal.history[historyCount - 1] : null;
            const lastContribution = lastEntry && lastEntry.date ? new Date(lastEntry.date).toLocaleDateString('pt-BR') : 'Sem aportes';
            const statusLabel = pct >= 100 ? 'Concluda' : (pct >= 70 ? 'No ritmo' : 'Em construo');
            const statusIcon = pct >= 100 ? 'fa-trophy' : (pct >= 40 ? 'fa-bullseye' : 'fa-seedling');
            return `
                <article class="goal-card" style="background:${theme.background};color:${theme.textColor};border-color:${theme.border};box-shadow:${theme.shadow}">
                    <div class="flex justify-between gap-3">
                        <div>
                            <span class="goal-chip" style="background:${theme.chipBg};color:${theme.chipText};">
                                <i class="fas ${icon}"></i> ${label}
                            </span>
                            <h3 class="text-xl font-semibold mt-3 leading-snug">${goalName}</h3>
                            <p class="text-sm opacity-80">${describeGoalStrategy(goal)}</p>
                        </div>
                        <div class="goal-card-actions flex flex-col gap-2">
                            <button onclick="window.editGoal('${goal.id}')" title="Editar meta"><i class="fas fa-pen"></i></button>
                            <button onclick="window.deleteGoal('${goal.id}')" title="Excluir meta"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="goal-progress-track mt-4">
                        <div class="goal-progress-fill" style="width:${pct}%;background:${theme.accent};"></div>
                    </div>
                    <div class="flex justify-between text-xs font-semibold uppercase tracking-wide opacity-80 mt-2">
                        <span class="money-display">${formatCurrencyBRL(current)}</span>
                        <span>${isFinite(pct) ? pct.toFixed(0) : 0}%</span>
                        <span class="money-display">${formatCurrencyBRL(target)}</span>
                    </div>
                    <div class="flex flex-wrap gap-3 text-xs mt-4 opacity-90">
                        <span class="flex items-center gap-1"><i class="fas ${statusIcon} text-[0.7rem]"></i>${statusLabel}</span>
                        <span class="flex items-center gap-1"><i class="fas fa-clock text-[0.7rem]"></i>${getGoalProjection(goal)}</span>
                        <span class="flex items-center gap-1"><i class="fas fa-calendar-day text-[0.7rem]"></i>${lastContribution}</span>
                        <span class="flex items-center gap-1"><i class="fas fa-donate text-[0.7rem]"></i>${historyCount} aporte${historyCount === 1 ? '' : 's'}</span>
                    </div>
                    <button onclick="window.openGoalContribModal('${goal.id}')" class="mt-5 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/85 text-sm font-semibold text-slate-900 shadow-sm hover:-translate-y-0.5 transition">
                        <i class="fas fa-plus text-xs"></i> Registrar aporte
                    </button>
                </article>`;
        }

        function updateGoalHeroStats() {
            const savedEl = document.getElementById('goal-total-saved');
            const targetEl = document.getElementById('goal-total-target');
            const progressEl = document.getElementById('goal-total-progress');
            if (!savedEl || !targetEl || !progressEl) return;
            let totalSaved = 0;
            let totalTarget = 0;
            let progressAccumulator = 0;
            currentGoals.forEach(goal => {
                const saved = Number(goal.currentAmount) || 0;
                const target = Number(goal.targetAmount) || 0;
                totalSaved += saved;
                totalTarget += target;
                if (target > 0) progressAccumulator += Math.min((saved / target) * 100, 100);
            });
            savedEl.textContent = formatCurrencyBRL(totalSaved);
            targetEl.textContent = formatCurrencyBRL(totalTarget);
            const progress = currentGoals.length ? Math.round(progressAccumulator / currentGoals.length) : 0;
            progressEl.textContent = `${isNaN(progress) ? 0 : progress}%`;
            applyPrivacyMode();
        }

        function initializeIncomeVisibilityToggle() {
            const checkbox = document.getElementById('toggle-income-checkbox');
            if (!checkbox) return;
            const saved = localStorage.getItem('showIncomeSections');
            const shouldShow = saved === null ? true : saved === 'true';
            checkbox.checked = shouldShow;
            applyIncomeVisibility(shouldShow);
            checkbox.addEventListener('change', () => {
                const show = checkbox.checked;
                localStorage.setItem('showIncomeSections', show);
                applyIncomeVisibility(show);
            });
        }

        function attachFormHandlers() {
            const expenseForm = document.getElementById('expense-form');
            if (expenseForm && !expenseForm.dataset.bound) {
                expenseForm.addEventListener('submit', handleExpenseSubmit);
                expenseForm.dataset.bound = 'true';
            }
            const incomeForm = document.getElementById('income-form');
            if (incomeForm && !incomeForm.dataset.bound) {
                incomeForm.addEventListener('submit', handleIncomeSubmit);
                incomeForm.dataset.bound = 'true';
            }
            const goalForm = document.getElementById('goal-form');
            if (goalForm && !goalForm.dataset.bound) {
                goalForm.addEventListener('submit', handleGoalSubmit);
                goalForm.dataset.bound = 'true';
            }
            const goalStrategy = document.getElementById('goal-strategy');
            if (goalStrategy && !goalStrategy.dataset.bound) {
                goalStrategy.addEventListener('change', handleGoalStrategyChange);
                goalStrategy.dataset.bound = 'true';
            }
            const goalTarget = document.getElementById('goal-target');
            if (goalTarget && !goalTarget.dataset.hintBound) {
                goalTarget.addEventListener('input', updateGoalStrategyHint);
                goalTarget.dataset.hintBound = 'true';
            }
            const goalStrategyValue = document.getElementById('goal-strategy-value');
            if (goalStrategyValue && !goalStrategyValue.dataset.hintBound) {
                goalStrategyValue.addEventListener('input', updateGoalStrategyHint);
                goalStrategyValue.dataset.hintBound = 'true';
            }
            const budgetForm = document.getElementById('budget-form');
            if (budgetForm && !budgetForm.dataset.bound) {
                budgetForm.addEventListener('submit', handleBudgetSubmit);
                budgetForm.dataset.bound = 'true';
            }
            handleGoalStrategyChange();
        }

        function populateDynamicSelects() {
            const paidSelect = document.getElementById('expense-paid-by');
            const sourceSelect = document.getElementById('income-source');
            const benSelect = document.getElementById('expense-beneficiary');
            const goalContributionPaidBy = document.getElementById('goal-contrib-paid-by');

            if (paidSelect) {
                const currentVal = paidSelect.value;
                paidSelect.innerHTML = '';
                appSettings.people.forEach(p => paidSelect.add(new Option(p.name, p.name)));
                if (currentVal && Array.from(paidSelect.options).some(o => o.value === currentVal)) paidSelect.value = currentVal;
            }
            if (sourceSelect) {
                const currentVal = sourceSelect.value;
                sourceSelect.innerHTML = '';
                appSettings.people.forEach(p => sourceSelect.add(new Option(p.name, p.name)));
                sourceSelect.add(new Option('Outros', 'Outros'));
                if (currentVal && Array.from(sourceSelect.options).some(o => o.value === currentVal)) sourceSelect.value = currentVal;
            }
            if (benSelect) {
                benSelect.innerHTML = '';
                appSettings.people.forEach(p => benSelect.add(new Option(p.name, p.name)));
            }
            if (goalContributionPaidBy) {
                const currentVal = goalContributionPaidBy.value;
                goalContributionPaidBy.innerHTML = '';
                if (appSettings.people.length) {
                    appSettings.people.forEach(p => goalContributionPaidBy.add(new Option(p.name, p.name)));
                } else {
                    goalContributionPaidBy.add(new Option('Investimentos', 'Investimentos'));
                }
                if (currentVal && Array.from(goalContributionPaidBy.options).some(o => o.value === currentVal)) {
                    goalContributionPaidBy.value = currentVal;
                }
            }
            const typeSelect = document.getElementById('expense-sharing-type');
            if (typeSelect) {
                const currentVal = typeSelect.value;
                typeSelect.innerHTML = '';
                appSettings.expenseTypes.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.text = t.label;
                    opt.dataset.isShared = t.isShared;
                    opt.dataset.isThirdParty = t.isThirdParty;
                    opt.dataset.split = t.defaultSplit || 50;
                    typeSelect.add(opt);
                });
                if (currentVal && Array.from(typeSelect.options).some(o => o.value === currentVal)) typeSelect.value = currentVal;
                handleTypeChange();
            }
        }

        async function loadSettings() {
            try {
                const docRef = doc(db, DB_BASE_PATH, 'config', 'settings');
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.people) appSettings.people = d.people;
                    if (d.expenseTypes) appSettings.expenseTypes = d.expenseTypes;
                    const updated = ensureDefaultTypes();
                    if (updated) {
                        await setDoc(docRef, { expenseTypes: appSettings.expenseTypes }, { merge: true });
                    }
                } else {
                    ensureDefaultTypes();
                    await setDoc(docRef, appSettings);
                }
                populateDynamicSelects();
            } catch (e) { console.error(e); }
        }

        async function saveSettings() {
            try {
                const docRef = doc(db, DB_BASE_PATH, 'config', 'settings');
                ensureDefaultTypes();
                await setDoc(docRef, appSettings, { merge: true });
                populateDynamicSelects();
                updateSettingsUI();
            } catch (e) { console.error('Erro ao salvar configuraes', e); }
        }

        function ensureDefaultTypes() {
            const workingTypes = [...appSettings.expenseTypes];
            let hasChanges = false;
            DEFAULT_EXPENSE_TYPES.forEach((defaultType) => {
                const idx = workingTypes.findIndex(t => t.id === defaultType.id);
                if (idx === -1) {
                    workingTypes.unshift({ ...defaultType });
                    hasChanges = true;
                } else {
                    const existing = workingTypes[idx];
                    const merged = { ...existing, ...defaultType };
                    if (['label', 'color', 'isShared', 'isThirdParty', 'defaultSplit'].some(key => existing[key] !== merged[key])) {
                        hasChanges = true;
                    }
                    workingTypes[idx] = merged;
                }
            });
            const orderedDefaults = DEFAULT_EXPENSE_TYPES.map(def => workingTypes.find(t => t.id === def.id)).filter(Boolean).map(t => ({ ...t }));
            const customTypes = workingTypes.filter(t => !DEFAULT_TYPE_IDS.includes(t.id));
            appSettings.expenseTypes = [...orderedDefaults, ...customTypes];
            return hasChanges;
        }

        function getExpenseRecurrenceDisplay(expense) {
            const isRecurring = expense?.recurrenceSeriesId && expense.recurrenceType && expense.recurrenceType !== 'none';
            if (!isRecurring) return { badgeHTML: '', subtextHTML: '', rowClass: '' };
            const index = expense.recurrenceIndex || 1;
            const isFixed = expense.recurrenceType === 'fixed';
            const total = expense.recurrenceTotal || expense.recurrenceMonths || null;
            const badgeText = isFixed ? `Parcela ${index}/${total || '?'}` : 'Fixo mensal';
            const subtextParts = [];
            if (!isFixed) subtextParts.push(`Ocorrncia ${index}`);
            if (expense.recurrenceSeriesActive === false) subtextParts.push('Srie pausada');
            const subtextHTML = subtextParts.length ? `<p class="recurrence-subtext">${subtextParts.join('  ')}</p>` : '';
            const rowClass = `recurring-row${expense.recurrenceSeriesActive === false ? ' inactive-recurring-row' : ''}`;
            return { badgeHTML: `<span class="recurrence-pill">${badgeText}</span>`, subtextHTML, rowClass };
        }

        function renderTables() {
            const expBody = document.getElementById('expense-table-body');
            expBody.innerHTML = currentExpenses.map(item => {
                let typeConfig = appSettings.expenseTypes.find(t => t.id === item.typeId);
                if (!typeConfig) typeConfig = appSettings.expenseTypes.find(t => t.id === item.sharingType) || { label: item.sharingType, color: '#ffffff' };
                const recurrenceDisplay = getExpenseRecurrenceDisplay(item);
                const rowClasses = ['hover:opacity-90 transition border-b border-gray-100'];
                if (recurrenceDisplay.rowClass) rowClasses.push(recurrenceDisplay.rowClass);
                const descriptionCell = recurrenceDisplay.badgeHTML
                    ? `<div class="flex flex-col gap-1">
                            <div class="flex flex-wrap items-center gap-2">
                                <span class="font-medium text-gray-900">${item.description}</span>
                                ${recurrenceDisplay.badgeHTML}
                            </div>
                            ${recurrenceDisplay.subtextHTML || ''}
                       </div>`
                    : item.description;
                return `
                <tr style="background-color: ${typeConfig.color}" class="${rowClasses.join(' ')}">
                    <td class="px-4 py-3 text-sm text-gray-900">${descriptionCell}</td>
                    <td class="px-4 py-3 text-sm font-medium text-red-600 money-display">${formatCurrencyBRL(item.amount)}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${new Date(item.date + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.category}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${typeConfig.label}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.paidBy}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium no-print">
                        <button onclick="window.startEditExpense('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteItem('${item.id}', 'expense')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                `;
            }).join('');

            const incBody = document.getElementById('income-table-body');
            incBody.innerHTML = currentIncomes.map(item => `
                <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                    <td class="px-4 py-3 text-sm text-gray-900">${item.description}</td>
                    <td class="px-4 py-3 text-sm font-medium text-green-600 money-display">${formatCurrencyBRL(item.amount)}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${new Date(item.date + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.source}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium no-print">
                        <button onclick="window.startEditIncome('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteItem('${item.id}', 'income')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </td></tr>
            `).join('');

            const categories = {};
            let total = 0;
            let highestExpense = 0;
            currentExpenses.forEach(e => {
                categories[e.category] = (categories[e.category] || 0) + e.amount;
                total += e.amount;
                if (e.amount > highestExpense) highestExpense = e.amount;
            });
            document.getElementById('category-stats-body').innerHTML = Object.entries(categories).sort((a, b) => b[1] - a[1]).map(([cat, val]) => `
                <tr><td class="px-3 py-2 text-xs text-gray-700">${cat}</td><td class="px-3 py-2 text-right text-xs font-medium text-gray-900 money-display">${formatCurrencyBRL(val)}</td><td class="px-3 py-2 text-right text-xs text-gray-500">${total > 0 ? ((val / total) * 100).toFixed(1) : 0}%</td></tr>`).join('');

            const expenseTotalEl = document.getElementById('expense-insight-total');
            if (expenseTotalEl) expenseTotalEl.textContent = formatCurrencyBRL(total);
            const expenseCountEl = document.getElementById('expense-insight-count');
            if (expenseCountEl) expenseCountEl.textContent = currentExpenses.length;
            const expenseTopEl = document.getElementById('expense-insight-top');
            if (expenseTopEl) expenseTopEl.textContent = currentExpenses.length ? formatCurrencyBRL(highestExpense) : 'R$ 0,00';

            const emptyState = document.getElementById('expense-empty-state');
            const tableContainer = document.getElementById('expense-table-container');
            if (emptyState && tableContainer) {
                if (currentExpenses.length === 0) {
                    emptyState.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                }
            }

            applyPrivacyMode();
        }

        function updateSummary() {
            const inc = currentIncomes.reduce((s, i) => s + i.amount, 0);
            const exp = currentExpenses.reduce((s, i) => s + i.amount, 0);
            document.getElementById('total-income').textContent = formatCurrencyBRL(inc);
            document.getElementById('total-expense').textContent = formatCurrencyBRL(exp);

            const bal = inc - exp;
            const balEl = document.getElementById('total-balance');
            balEl.textContent = formatCurrencyBRL(bal);
            balEl.className = `money-display text-3xl font-semibold mt-2 ${bal >= 0 ? 'text-green-600' : 'text-red-600'}`;

            const dynamicContainer = document.getElementById('dynamic-cards-container');
            dynamicContainer.innerHTML = '';

            const typeTotals = {};
            currentExpenses.forEach(e => {
                let tid = e.typeId;
                if (!tid) {
                    const match = appSettings.expenseTypes.find(t => t.label === e.sharingType);
                    if (match) tid = match.id;
                }
                if (tid) typeTotals[tid] = (typeTotals[tid] || 0) + e.amount;
            });

            appSettings.expenseTypes.forEach(t => {
                const total = typeTotals[t.id] || 0;
                if (total > 0 && !DEFAULT_TYPE_IDS.includes(t.id)) {
                    dynamicContainer.innerHTML += `<div class="print-card p-6 rounded-lg shadow-md border border-gray-200" style="background-color: ${t.color}">
                            <h2 class="text-sm font-medium text-gray-700">${t.label}</h2>
                            <p class="money-display text-3xl font-semibold text-gray-900 mt-2">${formatCurrencyBRL(total)}</p>
                        </div>`;
                }
            });

            // SETTLEMENT
            const content = document.getElementById('settlement-content');
            content.innerHTML = '';

            if (appSettings.people.length === 2) {
                const p1 = appSettings.people[0].name;
                const p2 = appSettings.people[1].name;
                let p1_for_p2 = 0, p2_for_p1 = 0;

                currentExpenses.forEach(e => {
                    const amount = e.amount;
                    const payer = e.paidBy;
                    let typeConfig = appSettings.expenseTypes.find(t => t.id === e.typeId) || { isShared: false, isThirdParty: false };

                    if (typeConfig.isShared) {
                        const split = (e.splitPercent !== undefined) ? e.splitPercent : 50;
                        if (payer === p1) p1_for_p2 += amount * ((100 - split) / 100);
                        else if (payer === p2) p2_for_p1 += amount * (split / 100);
                    } else if (typeConfig.isThirdParty) {
                        if (payer === p1) { if (!e.beneficiary || e.beneficiary === p2) p1_for_p2 += amount; }
                        else if (payer === p2) { if (!e.beneficiary || e.beneficiary === p1) p2_for_p1 += amount; }
                    }
                });

                const net = p1_for_p2 - p2_for_p1;
                let transferText = "";
                let transferClass = "transfer-text";

                if (Math.abs(net) < 0.01) transferText = `Contas zeradas <span class="font-bold block">(R$ 0,00)</span>`;
                else if (net > 0) {
                    transferText = `${p2} deve a ${p1}: <span class="font-bold block">${formatCurrencyBRL(net)}</span>`;
                    transferClass = "transfer-text transfer-text-positive";
                } else {
                    transferText = `${p1} deve a ${p2}: <span class="font-bold block">${formatCurrencyBRL(Math.abs(net))}</span>`;
                    transferClass = "transfer-text transfer-text-negative";
                }

                content.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-600">${p1} pagou por ${p2}</h3><p class="money-display text-2xl font-semibold text-gray-900 mt-1">${formatCurrencyBRL(p1_for_p2)}</p></div>
                    <div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-600">${p2} pagou por ${p1}</h3><p class="money-display text-2xl font-semibold text-gray-900 mt-1">${formatCurrencyBRL(p2_for_p1)}</p></div>
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 md:col-span-1"><h3 class="text-sm font-medium text-indigo-700">Transferncia Necessria</h3><p class="money-display text-xl md:text-2xl font-semibold mt-1 ${transferClass}">${transferText}</p></div>`;
            } else {
                const balances = {};
                appSettings.people.forEach(p => balances[p.name] = { paid: 0, consumed: 0 });
                currentExpenses.forEach(e => {
                    const payer = e.paidBy;
                    if (balances[payer]) balances[payer].paid += e.amount;
                    let typeConfig = appSettings.expenseTypes.find(t => t.id === e.typeId) || { isShared: false };
                    if (typeConfig.isShared) {
                        const share = e.amount / appSettings.people.length;
                        appSettings.people.forEach(p => balances[p.name].consumed += share);
                    } else if (typeConfig.isThirdParty && e.beneficiary && balances[e.beneficiary]) {
                        balances[e.beneficiary].consumed += e.amount;
                    } else {
                        balances[payer].consumed += e.amount;
                    }
                });
                let html = '<div class="col-span-3 grid grid-cols-1 gap-2">';
                appSettings.people.forEach(p => {
                    const net = balances[p.name].paid - balances[p.name].consumed;
                    if (Math.abs(net) > 0.01) {
                        const color = net >= 0 ? 'text-green-600' : 'text-red-600';
                        const label = net >= 0 ? 'a receber' : 'a pagar';
                        html += `<div class="flex justify-between border-b py-2"><span>${p.name}</span><span class="${color} font-bold">${formatCurrencyBRL(Math.abs(net))} (${label})</span></div>`;
                    }
                });
                html += '</div>';
                content.innerHTML = html;
            }
            applyPrivacyMode();
            updatePremiumPrintReport();
        }

        function loadDataForMonth() {
            const m = document.getElementById('month-select').value;
            const y = document.getElementById('year-select').value;
            const monthYear = `${m}-${y}`;
            syncPremiumTrendWindowControl();
            loadPreviousMonthStats(monthYear);
            if (getPlanRules().key === 'premium') {
                loadPremiumAnalyticsData(monthYear);
            } else {
                premiumAnalyticsRequestId += 1;
                premiumRecentExpenses = [];
                premiumCategoryHistory = { monthOrder: [], byMonth: {} };
                recurringForecastData = [];
                updatePremiumPrintReport();
            }

            const qExp = query(collection(db, `${DB_BASE_PATH}/expenses`), where("monthYear", "==", monthYear));
            unsubscribeExpenses();
            unsubscribeExpenses = onSnapshot(qExp, (snap) => {
                currentExpenses = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                renderTables();
                updateSummary();
                updateCharts();
                updateBudgetProgress();
                completePeriodTransition();
            });

            const qInc = query(collection(db, `${DB_BASE_PATH}/income`), where("monthYear", "==", monthYear));
            unsubscribeIncome();
            unsubscribeIncome = onSnapshot(qInc, (snap) => {
                currentIncomes = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(a.date) - new Date(b.date));
                renderTables();
                updateSummary();
                completePeriodTransition();
            });
        }

        async function calculateHistoricalStats() {
            try {
                const qInc = query(collection(db, `${DB_BASE_PATH}/income`), orderBy('date', 'desc'), limit(50));
                const qExp = query(collection(db, `${DB_BASE_PATH}/expenses`), orderBy('date', 'desc'), limit(100));
                const [incSnap, expSnap] = await Promise.all([getDocs(qInc), getDocs(qExp)]);
                const monthlyData = {};
                incSnap.forEach(d => { const m = d.data().monthYear; if (!monthlyData[m]) monthlyData[m] = { inc: 0, exp: 0 }; monthlyData[m].inc += d.data().amount; });
                expSnap.forEach(d => { const m = d.data().monthYear; if (!monthlyData[m]) monthlyData[m] = { inc: 0, exp: 0 }; monthlyData[m].exp += d.data().amount; });
                let totalSurplus = 0, monthsCount = 0;
                Object.values(monthlyData).forEach(v => { totalSurplus += (v.inc - v.exp); monthsCount++; });
                if (monthsCount > 0) historicalAverageSurplus = totalSurplus / monthsCount;
                renderGoals();
            } catch (e) { console.error(e); }
        }

        // GOALS FUNCTIONS
        function loadGoals() {
            unsubscribeGoals();
            unsubscribeGoals = onSnapshot(collection(db, `${DB_BASE_PATH}/goals`), (snap) => {
                currentGoals = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGoals();
            });
        }

        function openSettingsModal() {
            const modal = document.getElementById('modal-settings');
            if (!modal) return;
            updateSettingsUI();
            initColorPicker();
            initTypeModeButtons();
            modal.classList.remove('hidden');
            document.body.classList.add('modal-active');
            requestAnimationFrame(() => modal.classList.add('active'));
        }
        function renderGoals() {
            const container = document.getElementById('goals-container');
            if (!container) return;
            if (currentGoals.length === 0) {
                container.innerHTML = `<div class="goal-card bg-white border-2 border-dashed border-indigo-200 text-center flex flex-col items-center justify-center" style="min-height:220px;">
                        <p class="text-indigo-700 font-semibold">Nenhuma meta cadastrada. Adicione a sua primeira acima.</p>
                    </div>`;
                updateGoalHeroStats();
                updatePlanLimitMessages();
                updatePremiumPrintReport();
                return;
            }
            container.innerHTML = currentGoals.map((goal, index) => buildGoalCard(goal, index)).join('');
            updateGoalHeroStats();
            updatePlanLimitMessages();
            updatePremiumPrintReport();
        }

        function handleGoalStrategyChange() {
            const strategy = document.getElementById('goal-strategy');
            const container = document.getElementById('goal-strategy-value-container');
            const input = document.getElementById('goal-strategy-value');
            const hint = document.getElementById('goal-strategy-value-hint');
            const label = document.getElementById('goal-strategy-value-label');
            if (!strategy || !container || !input || !hint || !label) return;
            if (strategy.value === 'manual') {
                container.classList.add('hidden');
                input.required = false;
                clearMoneyInput(input);
                unbindMoneyMask(input);
                hint.classList.add('hidden');
                hint.textContent = '';
            } else {
                container.classList.remove('hidden');
                input.required = true;
                if (strategy.value === 'fixed') {
                    label.textContent = 'Valor mensal sugerido';
                    input.placeholder = '0,00';
                    bindMoneyMask(input);
                    hint.classList.remove('hidden');
                    updateGoalStrategyHint();
                } else {
                    label.textContent = 'Percentual da renda (%)';
                    input.placeholder = 'Ex: 15 (representa 15%)';
                    unbindMoneyMask(input);
                    hint.classList.add('hidden');
                    hint.textContent = '';
                }
            }
        }

        function getEditingGoalSavedAmount() {
            if (!editingGoalId) return 0;
            const goal = currentGoals.find(g => g.id === editingGoalId);
            return goal ? Number(goal.currentAmount) || 0 : 0;
        }

        function addMonthsToDate(date, monthsAhead) {
            const reference = new Date(date);
            return new Date(reference.getFullYear(), reference.getMonth() + monthsAhead, 1);
        }

        function updateGoalStrategyHint() {
            const strategy = document.getElementById('goal-strategy');
            const hint = document.getElementById('goal-strategy-value-hint');
            if (!strategy || !hint) return;
            if (strategy.value !== 'fixed') {
                hint.classList.add('hidden');
                hint.textContent = '';
                return;
            }
            const monthlyAmount = getMoneyInputValue('goal-strategy-value');
            const targetAmount = getMoneyInputValue('goal-target');
            const alreadySaved = getEditingGoalSavedAmount();
            if (!targetAmount) {
                hint.textContent = 'Defina o valor da meta para estimar o prazo.';
                hint.classList.remove('hidden');
                return;
            }
            if (!monthlyAmount) {
                hint.textContent = 'Informe um valor mensal para ver em quantos meses voc chega l.';
                hint.classList.remove('hidden');
                return;
            }
            const remaining = Math.max(targetAmount - alreadySaved, 0);
            if (remaining <= 0) {
                hint.textContent = 'Meta concluda! Ajuste o valor apenas se quiser manter o hbito.';
                hint.classList.remove('hidden');
                return;
            }
            const months = Math.max(1, Math.ceil(remaining / monthlyAmount));
            const projectedDate = addMonthsToDate(new Date(), months);
            const formattedDate = projectedDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
            hint.textContent = `Guardando ${formatCurrencyBRL(monthlyAmount)} por ms voc alcana a meta em ${months} ${months === 1 ? 'ms' : 'meses'} (aprox. ${formattedDate}).`;
            hint.classList.remove('hidden');
        }

        function resetGoalForm() {
            const form = document.getElementById('goal-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('goal-target');
            editingGoalId = null;
            const title = document.getElementById('modal-goal-title');
            if (title) title.textContent = 'Nova Meta';
            const submit = document.querySelector('#goal-form button[type="submit"]');
            if (submit) submit.textContent = 'Salvar Meta';
            document.getElementById('goal-id').value = '';
            handleGoalStrategyChange();
        }

        async function handleGoalSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('goal-name').value.trim();
            const targetAmount = getMoneyInputValue('goal-target');
            const strategy = document.getElementById('goal-strategy').value;
            const valueInput = document.getElementById('goal-strategy-value');
            let strategyValue = null;
            if (strategy === 'fixed') strategyValue = getMoneyInputValue('goal-strategy-value');
            else if (strategy === 'percentage') strategyValue = parseFloat((valueInput.value || '').replace(',', '.'));
            if (!name || isNaN(targetAmount) || targetAmount <= 0) { alert('Preencha um nome e valor alvo vlidos.'); return; }
            if (strategy !== 'manual' && (isNaN(strategyValue) || strategyValue <= 0)) { alert('Informe um valor vlido para a estratgia.'); return; }
            const payload = {
                name,
                targetAmount,
                strategy,
                strategyValue: strategy === 'manual' ? null : strategyValue,
                updatedAt: new Date()
            };
            try {
                if (editingGoalId) {
                    await updateDoc(doc(db, `${DB_BASE_PATH}/goals/${editingGoalId}`), payload);
                } else {
                    payload.currentAmount = 0;
                    payload.history = [];
                    payload.createdAt = new Date();
                    await addDoc(collection(db, `${DB_BASE_PATH}/goals`), payload);
                }
                closeGoalModal();
                resetGoalForm();
            } catch (error) {
                console.error('Erro ao salvar meta', error);
                alert('No foi possvel salvar a meta.');
            }
        }

        function openGoalModal(goalId = null) {
            if (!goalId && getPlanRules().key !== 'premium' && isPlanAtLimit('goals')) {
                handlePlanLimitAttempt('goals');
                return;
            }
            resetGoalForm();
            if (goalId) {
                const goal = currentGoals.find(g => g.id === goalId);
                if (goal) {
                    editingGoalId = goalId;
                    document.getElementById('goal-name').value = goal.name;
                    setMoneyInputValue('goal-target', goal.targetAmount);
                    document.getElementById('goal-strategy').value = goal.strategy || 'manual';
                    handleGoalStrategyChange();
                    if (goal.strategy === 'fixed') {
                        setMoneyInputValue('goal-strategy-value', goal.strategyValue || 0);
                    } else if (goal.strategy && goal.strategy !== 'manual') {
                        document.getElementById('goal-strategy-value').value = goal.strategyValue || '';
                    }
                    document.getElementById('goal-id').value = goalId;
                    updateGoalStrategyHint();
                    const title = document.getElementById('modal-goal-title');
                    if (title) title.textContent = 'Editar Meta';
                    const submit = document.querySelector('#goal-form button[type="submit"]');
                    if (submit) submit.textContent = 'Atualizar Meta';
                }
            }
            const modal = document.getElementById('modal-goal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }
        function closeGoalModal() {
            const modal = document.getElementById('modal-goal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                resetGoalForm();
            }, 250);
        }

        async function deleteGoal(goalId) {
            if (!confirm('Remover meta?')) return;
            try {
                await deleteDoc(doc(db, `${DB_BASE_PATH}/goals/${goalId}`));
                if (editingGoalId === goalId) resetGoalForm();
            } catch (error) {
                console.error('Erro ao remover meta', error);
                alert('No foi possvel remover a meta.');
            }
        }

        // BUDGETS
        function loadBudgets() {
            unsubscribeBudgets();
            unsubscribeBudgets = onSnapshot(collection(db, `${DB_BASE_PATH}/budgets`), (snap) => { currentBudgets = snap.docs.map(d => ({ id: d.id, ...d.data() })); updateBudgetProgress(); });
        }
        function updateBudgetProgress() {
            const container = document.getElementById('budgets-container');
            if (!container) return;
            const spending = {};
            currentExpenses.forEach(e => { const c = (e.category || '').toLowerCase(); spending[c] = (spending[c] || 0) + e.amount; });
            const totalLimitEl = document.getElementById('budget-total-limit');
            const totalSpentEl = document.getElementById('budget-total-spent');
            const alertCountEl = document.getElementById('budget-alert-count');
            const alertTrigger = document.getElementById('budget-alerts-trigger');
            const alertTriggerLabel = alertTrigger ? alertTrigger.querySelector('small') : null;
            const planAllowsAlerts = planAllows('budgetAlerts');

            const statusConfig = {
                safe: { label: 'Em dia', headline: 'Fluxo equilibrado', description: 'Os gastos desta categoria esto dentro da meta.', color: '#34d399', icon: 'fa-face-smile-beam' },
                warning: { label: 'Ateno', headline: 'Hora de desacelerar', description: 'Voc est chegando perto do limite mensal. Reduza um pouco.', color: '#fbbf24', icon: 'fa-triangle-exclamation' },
                danger: { label: 'Crtico', headline: 'Limite estourando!', description: 'Tome cuidado, voc est muito perto do limite. Segure novos gastos agora.', color: '#f87171', icon: 'fa-circle-exclamation' },
                critical: { label: 'Estourou', headline: 'Categoria estourou', description: 'Voc ultrapassou o limite desta categoria. Reequilibre o plano imediatamente.', color: '#dc2626', icon: 'fa-fire' }
            };

            if (currentBudgets.length === 0) {
                container.innerHTML = `<div class="budget-empty">
                        <p class="font-semibold mb-1">Nenhum limite configurado ainda.</p>
                        <p class="text-sm text-purple-900/80">Crie limites por categoria para receber alertas visuais aqui.</p>
                    </div>`;
                if (totalLimitEl) totalLimitEl.textContent = formatCurrencyBRL(0);
                if (totalSpentEl) totalSpentEl.textContent = formatCurrencyBRL(0);
                if (alertCountEl) alertCountEl.textContent = '0';
                budgetAlertItems = [];
                if (alertTrigger) {
                    alertTrigger.disabled = true;
                    alertTrigger.classList.add('budget-alert-button-disabled');
                    alertTrigger.setAttribute('aria-disabled', 'true');
                }
                applyPrivacyMode();
                updatePlanLimitMessages();
                updatePremiumPrintReport();
                return;
            }

            let totalLimit = 0;
            let totalSpent = 0;
            const alertItems = [];

            container.innerHTML = currentBudgets.map(b => {
                const categoryLabel = b.category || 'Sem categoria';
                const categoryIcon = getCategoryIcon(categoryLabel);
                const key = categoryLabel.toLowerCase();
                const spent = spending[key] || 0;
                const limit = Number(b.limitAmount) || 0;
                totalLimit += limit;
                totalSpent += spent;
                const pctRaw = limit > 0 ? (spent / limit) * 100 : 0;
                const pct = Math.min(Math.max(pctRaw, 0), 120);
                let statusKey = 'safe';
                if (pctRaw >= 75) statusKey = 'warning';
                if (pctRaw >= 95) statusKey = 'danger';
                if (pctRaw > 100) statusKey = 'critical';
                const status = statusConfig[statusKey];
                const remaining = limit - spent;
                const spentLabel = formatCurrencyBRL(spent);
                const limitLabel = formatCurrencyBRL(limit);
                const remainderLabel = remaining >= 0 ? `<span class="money-display">${formatCurrencyBRL(remaining)}</span> disponvel` : `Excedente de <span class="money-display">${formatCurrencyBRL(Math.abs(remaining))}</span>`;
                if (statusKey !== 'safe') {
                    alertItems.push({ category: categoryLabel, statusKey, statusLabel: status.label, headline: status.headline, description: status.description, spent, limit, pct: limit > 0 ? pctRaw.toFixed(0) : '0', remaining });
                }
                return `<article class="budget-card status-${statusKey}">
                    <div class="budget-card-header">
                        <div>
                            <span class="budget-chip"><i class="fas ${categoryIcon}"></i> ${categoryLabel}</span>
                            <p class="text-sm text-gray-500 mt-1">Limite <span class="money-display">${limitLabel}</span></p>
                        </div>
                        <div class="budget-card-actions">
                            <button onclick="window.editBudget('${b.id}')" title="Editar limite"><i class="fas fa-pen"></i></button>
                            <button onclick="window.deleteBudget('${b.id}')" title="Remover limite"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl font-semibold text-slate-900 money-display">${spentLabel}</span>
                        <span class="text-xs text-gray-500">gasto</span>
                    </div>
                    <div class="budget-progress-track">
                        <div class="budget-progress-fill" style="width:${Math.min(pct, 105)}%;background:${status.color};"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span><span class="money-display">${spentLabel}</span> / <span class="money-display">${limitLabel}</span></span>
                        <span>${limit > 0 ? pctRaw.toFixed(0) : 0}%</span>
                    </div>
                    <div class="budget-card-status"><i class="fas fa-bell"></i>${status.label}</div>
                    <div class="budget-card-callout">
                        <span class="callout-icon"><i class="fas ${status.icon}"></i></span>
                        <div>
                            <p class="callout-title">${status.headline}</p>
                            <p class="callout-text">${status.description}</p>
                        </div>
                    </div>
                    <div class="budget-card-footer">
                        <span class="budget-remaining ${remaining >= 0 ? 'ok' : 'over'}">${remainderLabel}</span>
                    </div>
                </article>`;
            }).join('');

            budgetAlertItems = alertItems;
            if (totalLimitEl) totalLimitEl.textContent = formatCurrencyBRL(totalLimit);
            if (totalSpentEl) totalSpentEl.textContent = formatCurrencyBRL(totalSpent);
            if (!planAllowsAlerts) {
                if (alertCountEl) alertCountEl.textContent = '';
                if (alertTrigger) {
                    alertTrigger.disabled = true;
                    alertTrigger.classList.add('budget-alert-button-disabled');
                    alertTrigger.setAttribute('aria-disabled', 'true');
                    if (alertTriggerLabel) alertTriggerLabel.textContent = 'Exclusivo Premium';
                }
            } else {
                if (alertCountEl) alertCountEl.textContent = alertItems.length.toString();
                if (alertTrigger) {
                    const disabled = alertItems.length === 0;
                    alertTrigger.disabled = disabled;
                    alertTrigger.classList.toggle('budget-alert-button-disabled', disabled);
                    alertTrigger.setAttribute('aria-disabled', disabled ? 'true' : 'false');
                    if (alertTriggerLabel) alertTriggerLabel.textContent = disabled ? 'Sem alertas' : 'Ver detalhes';
                }
            }
            applyPrivacyMode();
            updatePlanLimitMessages();
            updatePremiumPrintReport();
        }

        function resetBudgetForm() {
            const form = document.getElementById('budget-form');
            if (!form) return;
            form.reset();
            clearMoneyInput('budget-amount');
            editingBudgetId = null;
            const title = document.getElementById('modal-budget-title');
            if (title) title.textContent = 'Novo Limite';
            const submit = document.querySelector('#budget-form button[type="submit"]');
            if (submit) submit.textContent = 'Salvar Limite';
            document.getElementById('budget-id').value = '';
        }

        function openBudgetModal(budgetId = null) {
            if (!budgetId && getPlanRules().key !== 'premium' && isPlanAtLimit('budgets')) {
                handlePlanLimitAttempt('budgets');
                return;
            }
            const select = document.getElementById('budget-category');
            if (select) {
                select.innerHTML = '';
                const cats = document.getElementById('expense-category').options;
                for (let i = 0; i < cats.length; i++) select.add(new Option(cats[i].text, cats[i].value));
            }
            resetBudgetForm();
            if (budgetId) {
                const budget = currentBudgets.find(b => b.id === budgetId);
                if (budget) {
                    editingBudgetId = budgetId;
                    if (!Array.from(document.getElementById('budget-category').options).some(opt => opt.value === budget.category)) {
                        document.getElementById('budget-category').add(new Option(budget.category, budget.category));
                    }
                    document.getElementById('budget-category').value = budget.category;
                    setMoneyInputValue('budget-amount', budget.limitAmount);
                    document.getElementById('budget-id').value = budgetId;
                    const title = document.getElementById('modal-budget-title');
                    if (title) title.textContent = 'Editar Limite';
                    const submit = document.querySelector('#budget-form button[type="submit"]');
                    if (submit) submit.textContent = 'Atualizar Limite';
                }
            }
            const modal = document.getElementById('modal-budget');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }
        function closeBudgetModal() {
            const modal = document.getElementById('modal-budget');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                resetBudgetForm();
            }, 250);
        }

        async function handleBudgetSubmit(event) {
            event.preventDefault();
            const category = document.getElementById('budget-category').value;
            const amount = getMoneyInputValue('budget-amount');
            if (!category || isNaN(amount) || amount <= 0) { alert('Informe categoria e limite vlidos.'); return; }
            const payload = { category, limitAmount: amount, updatedAt: new Date() };
            try {
                if (editingBudgetId) {
                    await updateDoc(doc(db, `${DB_BASE_PATH}/budgets/${editingBudgetId}`), payload);
                } else {
                    payload.createdAt = new Date();
                    await addDoc(collection(db, `${DB_BASE_PATH}/budgets`), payload);
                }
                closeBudgetModal();
                resetBudgetForm();
            } catch (error) {
                console.error('Erro ao salvar limite', error);
                alert('No foi possvel salvar o limite.');
            }
        }

        async function deleteBudget(budgetId) {
            if (!confirm('Remover limite?')) return;
            try {
                await deleteDoc(doc(db, `${DB_BASE_PATH}/budgets/${budgetId}`));
                if (editingBudgetId === budgetId) resetBudgetForm();
            } catch (error) {
                console.error('Erro ao remover limite', error);
                alert('No foi possvel remover o limite.');
            }
        }

        // INIT
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            const provider = new GoogleAuthProvider();
            setPersistence(auth, browserLocalPersistence).catch(() => setPersistence(auth, inMemoryPersistence)).then(() => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (!ALLOWED_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase())) { signOut(auth); alert("Sem permisso."); return; }
                        document.getElementById('user-email-display').textContent = user.email;
                        const printEmail = document.getElementById('print-header-email');
                        if (printEmail) printEmail.textContent = user.email;
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('app-content').classList.remove('hidden');
                        syncPlanUI();

                        await loadSettings();
                        initializeSelectors();
                        initializeIncomeVisibilityToggle();
                        attachFormHandlers();
                        initializeMoneyInputs();
                        resetExpenseForm();
                        resetIncomeForm();
                        loadDataForMonth();
                        loadGoals();
                        loadBudgets();
                        calculateHistoricalStats();
                        initializeToggle();
                        initializeThemeToggle();
                        initializeGoalSuggestions();
                        initializePremiumExtrasToggle();
                        initializePremiumTrendWindowControl();
                    } else {
                        document.getElementById('login-screen').classList.remove('hidden');
                        document.getElementById('app-content').classList.add('hidden');
                        document.getElementById('auth-loading').classList.add('hidden');
                        document.getElementById('auth-buttons').classList.remove('hidden');
                    }
                });
            });
            document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).then(() => window.location.reload()));
            document.querySelectorAll('[data-privacy-toggle]').forEach(btn => btn.addEventListener('click', togglePrivacyMode));
            const slider = document.getElementById('split-slider');
            if (slider) {
                slider.addEventListener('input', (e) => setSplitValue(e.target.value, { skipSliderUpdate: true }));
            }
            const splitManual = document.getElementById('split-manual-input');
            if (splitManual) {
                splitManual.addEventListener('input', (e) => {
                    if (e.target.value === '') return;
                    setSplitValue(e.target.value, { skipManualUpdate: true });
                });
                splitManual.addEventListener('blur', (e) => setSplitValue(e.target.value));
            }
            const presets = document.getElementById('split-presets');
            if (presets) presets.addEventListener('click', (ev) => {
                const btn = ev.target.closest('button[data-value]');
                if (!btn) return;
                setSplitValue(btn.dataset.value);
            });
            if (slider) setSplitValue(slider.value);
            // Listener do boto de imprimir
            const printBtn = document.getElementById('print-button');
            if (printBtn) printBtn.addEventListener('click', () => triggerPrint(false));
            const printBasicBtn = document.getElementById('print-basic-button');
            if (printBasicBtn) printBasicBtn.addEventListener('click', () => triggerPrint(true));
            const exportCsvBtn = document.getElementById('export-csv-button');
            if (exportCsvBtn) exportCsvBtn.addEventListener('click', exportCurrentDataToCSV);
            const annualReportBtn = document.getElementById('annual-report-button');
            if (annualReportBtn) annualReportBtn.addEventListener('click', () => openAnnualReportModal());
            const annualExportBtn = document.getElementById('annual-report-export-button');
            if (annualExportBtn) annualExportBtn.addEventListener('click', exportAnnualReportCSV);
            const stickyAddExpenseBtn = document.getElementById('sticky-add-expense-btn');
            if (stickyAddExpenseBtn) stickyAddExpenseBtn.addEventListener('click', scrollToExpenseForm);
            const planToastClose = document.getElementById('plan-restriction-toast-close');
            if (planToastClose) planToastClose.addEventListener('click', hidePlanRestrictionToast);

            const budgetAlertsBtn = document.getElementById('budget-alerts-trigger');
            if (budgetAlertsBtn) {
                budgetAlertsBtn.addEventListener('click', () => {
                    if (budgetAlertsBtn.disabled || budgetAlertsBtn.getAttribute('aria-disabled') === 'true') return;
                    openBudgetAlertsModal();
                });
            }
        } catch (e) { console.error(e); }

        // WINDOW EXPORTS
        window.cancelEditExpense = cancelEditExpense;
        window.cancelEditIncome = cancelEditIncome;
        window.startEditExpense = startEditExpense;
        window.startEditIncome = startEditIncome;
        window.deleteItem = deleteItem;
        window.deleteGoal = deleteGoal;
        window.editGoal = (id) => openGoalModal(id);
        window.deleteBudget = deleteBudget;
        window.editBudget = (id) => openBudgetModal(id);
        window.openGoalModal = openGoalModal;
        window.closeGoalModal = closeGoalModal;
        window.openBudgetModal = openBudgetModal;
        window.closeBudgetModal = closeBudgetModal;
        window.openBudgetAlertsModal = openBudgetAlertsModal;
        window.closeBudgetAlertsModal = closeBudgetAlertsModal;
        window.openAnnualReportModal = openAnnualReportModal;
        window.closeAnnualReportModal = closeAnnualReportModal;
        window.openPremiumModal = openPremiumModal;
        window.closePremiumModal = closePremiumModal;
        window.requestPremiumInvite = requestPremiumInvite;
        window.handleTypeChange = handleTypeChange;
        window.handleBeneficiaryChange = handleBeneficiaryChange;
        window.toggleRecurrenceInput = toggleRecurrenceInput;
        window.updateSplitDisplay = updateSplitDisplay;
        window.openSettingsModal = openSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.addPerson = addPerson;

        window.addEventListener('beforeprint', () => {
            ensurePremiumExtrasForPrint();
            preparePrintVisuals(true).catch(console.error);
        });

        window.addEventListener('afterprint', () => {
            delete document.body.dataset.printMode;
            cleanupPrintChartSnapshots();
            restorePremiumExtrasAfterPrint();
        });
        window.removePerson = removePerson;
        window.addExpenseType = addExpenseType;
        window.removeType = removeType;
        window.selectColor = selectColor;
        window.handleRecurrenceScopeChoice = handleRecurrenceScopeChoice;
        window.closeRecurrenceScopeModal = closeRecurrenceScopeModal;

        function resolveContributionPayer(preferred) {
            if (preferred) return preferred;
            const firstPerson = appSettings.people?.find(person => person?.name);
            return firstPerson?.name || 'Investimentos';
        }

        async function recordGoalContributionExpense(goal, amount, date, paidBy, contributionId) {
            if (!amount || amount <= 0) return;
            const safeGoal = goal || {};
            const safeDate = date || new Date().toISOString().split('T')[0];
            const monthYear = getMonthYear(safeDate);
            const sharedType = appSettings.expenseTypes?.find(t => t.isShared) || appSettings.expenseTypes?.[0] || { id: 't1', label: 'Compartilhado', isShared: true, defaultSplit: 50 };
            const payload = {
                description: `Aporte meta: ${safeGoal.name || 'Meta'}`,
                amount,
                date: safeDate,
                category: 'Investimentos',
                paidBy,
                typeId: sharedType.id,
                sharingType: sharedType.label,
                splitPercent: sharedType.isShared ? (sharedType.defaultSplit ?? 50) : null,
                beneficiary: null,
                recurrenceType: 'none',
                recurrenceMonths: null,
                recurrenceSeriesId: null,
                recurrenceIndex: null,
                recurrenceTotal: null,
                recurrenceSeriesActive: null,
                recurrenceIsCustom: false,
                goalId: safeGoal.id || null,
                goalContributionId: contributionId,
                monthYear,
                createdAt: new Date(),
                updatedAt: new Date()
            };
            try {
                await addDoc(collection(db, `${DB_BASE_PATH}/expenses`), payload);
            } catch (error) {
                console.error('Erro ao lanar aporte como despesa', error);
            }
        }

        async function removeGoalContributionExpense(contributionId) {
            if (!contributionId) return;
            try {
                const q = query(collection(db, `${DB_BASE_PATH}/expenses`), where('goalContributionId', '==', contributionId));
                const snap = await getDocs(q);
                if (snap.empty) return;
                const batch = writeBatch(db);
                snap.forEach(docSnap => batch.delete(docSnap.ref));
                await batch.commit();
            } catch (error) {
                console.error('Erro ao remover despesa vinculada ao aporte', error);
            }
        }

        let currentGoalId = null;
        window.openGoalContribModal = (goalId) => {
            currentGoalId = goalId;
            document.getElementById('goal-contrib-goal-id').value = goalId;
            document.getElementById('goal-contrib-date').value = new Date().toISOString().split('T')[0];
            clearMoneyInput('goal-contrib-amount');
            const paidBySelect = document.getElementById('goal-contrib-paid-by');
            if (paidBySelect && paidBySelect.options.length) {
                paidBySelect.value = paidBySelect.options[0].value;
            }

            const g = currentGoals.find(x => x.id === goalId);
            const list = document.getElementById('goal-history-list');
            list.innerHTML = '';
            if (g && g.history && g.history.length > 0) {
                g.history.forEach((h, idx) => {
                    const contributor = h.paidBy ? `<span class="text-xs text-gray-500">${h.paidBy}</span>` : '';
                    list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                        <div class="flex flex-col">
                            <span>${new Date(h.date).toLocaleDateString('pt-BR')}</span>
                            ${contributor}
                        </div>
                        <span class="font-bold text-green-600">${formatCurrencyBRL(h.amount)}</span>
                        <button onclick="window.deleteGoalContrib('${goalId}', ${idx})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
            } else { list.innerHTML = '<p class="text-gray-400 text-xs italic text-center">Nenhum aporte registrado.</p>'; }

            document.getElementById('modal-goal-contribution').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-goal-contribution').classList.add('active'), 10);
        };
        window.closeGoalContribModal = () => { document.getElementById('modal-goal-contribution').classList.remove('active'); setTimeout(() => document.getElementById('modal-goal-contribution').classList.add('hidden'), 250); };
        window.deleteGoalContrib = async (goalId, idx) => {
            if (!confirm("Remover?")) return;
            const g = currentGoals.find(x => x.id === goalId);
            const newHistory = [...g.history];
            const removed = newHistory.splice(idx, 1)[0];
            const newTotal = newHistory.reduce((sum, h) => sum + h.amount, 0);
            await updateDoc(doc(db, `${DB_BASE_PATH}/goals/${goalId}`), { currentAmount: newTotal, history: newHistory });
            await removeGoalContributionExpense(removed?.id);
            window.openGoalContribModal(goalId);
        };
        document.getElementById('goal-contrib-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amt = getMoneyInputValue('goal-contrib-amount');
            const date = document.getElementById('goal-contrib-date').value;
            if (!amt || amt <= 0 || !date) { alert('Informe um valor e uma data vlidos.'); return; }
            const paidBySelect = document.getElementById('goal-contrib-paid-by');
            const paidBy = resolveContributionPayer(paidBySelect ? paidBySelect.value : null);
            const g = currentGoals.find(x => x.id === currentGoalId);
            if (!g) return;
            const newHistory = g.history ? [...g.history] : [];
            const contributionId = Date.now();
            newHistory.push({ date, amount: amt, id: contributionId, paidBy });
            const newTotal = newHistory.reduce((sum, h) => sum + h.amount, 0);
            await updateDoc(doc(db, `${DB_BASE_PATH}/goals/${currentGoalId}`), { currentAmount: newTotal, history: newHistory });
            await recordGoalContributionExpense(g, amt, date, paidBy, contributionId);
            window.openGoalContribModal(currentGoalId);
        });

        window.handleImportCSV = (input) => {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async function (e) {
                const lines = e.target.result.split('\n');
                if (!confirm(`Importar ${lines.length} linhas?`)) return;
                for (let line of lines) {
                    const parts = line.split(',');
                    if (parts.length >= 3) {
                        const amt = parseFloat(parts[parts.length - 1].replace('R$', '').replace(',', '.'));
                        if (!isNaN(amt) && amt < 0) {
                            await addDoc(collection(db, `${DB_BASE_PATH}/expenses`), {
                                description: parts[1] || "Importado", amount: Math.abs(amt), date: parts[0], category: 'Outros', paidBy: 'Eduardo', typeId: 't1', sharingType: 'shared_50_50', monthYear: getMonthYear(parts[0]), createdAt: new Date()
                            });
                        }
                    }
                }
                alert(`Importado!`);
                input.value = '';
            };
            reader.readAsText(input.files[0]);
        };
        window.migrateData = async () => { if (confirm("Migrar?")) { const uid = auth.currentUser.uid; const oE = await getDocs(collection(db, `users/${uid}/expenses`)); oE.forEach(d => addDoc(collection(db, `${DB_BASE_PATH}/expenses`), d.data())); alert("Feito."); } };

    </script>
</body>

</html>