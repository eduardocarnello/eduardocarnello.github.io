<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Judicial TJSP (Lei 14.905/24)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        /* --- ESTILOS DE TELA (UI) --- */
        .tjsp-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .btn-primary {
            background-color: #1d4ed8;
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: #1e40af;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: white;
            border: 1px solid #cbd5e1;
            color: #475569;
        }

        .btn-secondary:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
        }

        .input-field {
            border: 1px solid #cbd5e1;
            padding: 0.6rem;
            border-radius: 0.5rem;
            width: 100%;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 3px solid #bfdbfe;
        }

        /* --- ESTILOS DE IMPRESSÃO (PDF) - PIXEL PERFECT --- */
        @media print {
            @page {
                margin: 1.5cm;
                size: A4;
            }

            td.text-center.data {
                font-size: 10px;
            }

            body {
                background-color: white;
                font-family: 'Inter', sans-serif;
                color: #111827;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 10pt;
            }

            /* Ocultar UI */
            .no-print,
            header,
            footer,
            #addItemBtn,
            .remove-btn,
            #calcActions,
            #apiStatusCard,
            .btn-add-row,
            .juros-check,
            .input-field,
            label {
                display: none !important;
            }

            /* Reset de Layout */
            .card {
                box-shadow: none;
                border: none;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0;
            }

            main {
                padding: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
            }

            #resultsArea {
                display: block !important;
                margin-top: 0 !important;
            }

            .print-only {
                display: block !important;
            }

            /* --- CABEÇALHO DO RELATÓRIO --- */
            #printHeader {
                border-bottom: 2px solid #1e3a8a;
                padding-bottom: 20px;
                margin-bottom: 30px;
                text-align: center;
            }

            #printHeader h1 {
                font-size: 16pt;
                font-weight: 800;
                margin: 0;
                color: #1e3a8a;
                text-transform: uppercase;
                font-family: 'Merriweather', serif;
                letter-spacing: 0.5px;
            }

            #printHeader p {
                font-size: 10pt;
                margin: 6px 0 0 0;
                color: #4b5563;
            }

            /* --- TABELA DE DADOS --- */
            .overflow-x-auto {
                overflow: visible !important;
                display: block;
                width: 100%;
            }

            table {
                width: 100% !important;
                border-collapse: collapse;
                margin-top: 10px;
                table-layout: fixed;
            }

            /* Bordas Suaves */
            th,
            td {
                border-bottom: 1px solid #e2e8f0 !important;
                border-right: 1px solid #e2e8f0 !important;
                border-left: 1px solid #e2e8f0 !important;
                padding: 8px 6px !important;
                vertical-align: middle;
            }

            /* Cabeçalho da Tabela */
            th {
                background-color: #f1f5f9 !important;
                color: #1e293b !important;
                font-weight: 700;
                text-transform: uppercase;
                text-align: center;
                font-size: 8pt;
                border-top: 2px solid #1e293b !important;
                border-bottom: 2px solid #cbd5e1 !important;
                letter-spacing: 0.5px;
            }

            /* --- LARGURAS E ALINHAMENTOS --- */
            td:nth-child(1) {
                width: 30%;
                text-align: left;
                font-weight: 600;
                color: #0f172a;
            }

            td:nth-child(2) {
                width: 18%;
                text-align: center;
                white-space: nowrap;
                font-size: 8.5pt;
                font-family: 'Inter', sans-serif;
            }

            td:nth-child(3) {
                width: 12%;
                text-align: right;
                white-space: nowrap;
                font-size: 9pt;
            }

            td:nth-child(4) {
                width: 12%;
                text-align: right;
                white-space: nowrap;
                font-weight: 600;
                color: #1e40af;
                font-size: 9pt;
            }

            td:nth-child(5) {
                width: 6%;
                text-align: center;
                font-size: 8.5pt;
            }

            td:nth-child(6) {
                width: 10%;
                text-align: right;
                white-space: nowrap;
                color: #b91c1c !important;
                font-size: 9pt;
            }

            td:nth-child(7) {
                width: 12%;
                text-align: right;
                white-space: nowrap;
                font-weight: 700;
                background-color: #f8fafc !important;
                color: #0f172a !important;
                font-size: 9pt;
            }

            /* Linha Principal */
            tr.main-row td {
                border-bottom: none !important;
                padding-bottom: 2px !important;
                height: 30px;
            }

            /* Linha de Detalhe (Índices) - Visual Diferenciado na Impressão */
            tr.detail-row td {
                border-top: none !important;
                padding-top: 2px !important;
                padding-bottom: 8px !important;
                background-color: #f8fafc !important;
                /* Fundo leve para diferenciar */
                color: #64748b !important;
                font-size: 6pt !important;
                /* Pequeno para ser técnico */
                line-height: 1.2;
                border-bottom: 1px solid #cbd5e1 !important;
                /* Borda inferior mais forte para separar items */
            }

            /* Rodapé de Totais - ALINHAMENTO CORRIGIDO */
            tfoot {
                border-top: 2px solid #1e293b !important;
                margin-top: 2px;
            }

            tfoot td {
                font-weight: 800;
                background-color: #e2e8f0 !important;
                color: #0f172a !important;
                font-size: 11pt;
                padding: 12px 6px !important;
                white-space: nowrap;
                text-align: right !important;
            }

            /* Disclaimer Técnico */
            #technicalFooter {
                font-size: 8pt !important;
                text-align: justify;
                margin-top: 30px;
                border-top: 1px solid #e2e8f0;
                padding-top: 10px;
                color: #64748b;
                line-height: 1.4;
            }

            .signature-line {
                display: none !important;
            }
        }

        .print-only {
            display: none;
        }
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <script src="../tjsp-indices.js"></script>

    <!-- Header (Tela) -->
    <header class="tjsp-header text-white p-6 shadow-md no-print">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-4xl opacity-90"><i class="fas fa-gavel"></i></div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Calculadora Judicial TJSP</h1>
                    <p class="text-blue-200 text-xs mt-1 font-mono">
                        <i class="fas fa-cloud-download-alt mr-1"></i>Integração API BCB (Séries 7478 & 4390)
                    </p>
                </div>
            </div>
            <div id="apiStatus" class="text-xs bg-blue-900/50 px-3 py-1 rounded-full flex items-center gap-2">
                <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse" id="statusDot"></div>
                <span id="statusText">Sincronizando...</span>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="flex-grow p-4 md:p-8 max-w-6xl mx-auto w-full">

        <!-- Área de Inputs -->
        <div class="space-y-6 no-print">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-slate-700">Itens do Cálculo</h2>
                <button onclick="adicionarItem()"
                    class="btn-secondary px-4 py-2 rounded text-sm font-semibold flex items-center gap-2 btn-add-row">
                    <i class="fas fa-plus text-blue-600"></i> Adicionar Verba
                </button>
            </div>

            <div id="itemsContainer" class="space-y-4"></div>

            <div id="calcActions" class="flex flex-col md:flex-row gap-4 pt-4 border-t border-slate-200">
                <button onclick="calcularTudo()"
                    class="btn-primary flex-1 py-3 rounded-lg font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                    <i class="fas fa-calculator"></i> Calcular Atualização & Juros
                </button>
                <button onclick="imprimirRelatorio()"
                    class="btn-secondary flex-none md:w-48 py-3 rounded-lg font-semibold shadow flex justify-center items-center gap-2">
                    <i class="fas fa-print"></i> Imprimir PDF
                </button>
            </div>
        </div>

        <!-- Área de Resultados -->
        <div id="resultsArea" class="hidden mt-8">
            <!-- Cabeçalho Impressão -->
            <div id="printHeader" class="print-only">
                <h1>Memória de Cálculo Judicial</h1>
                <p>Atualização Monetária (Tabela Prática TJSP) e Juros Moratórios</p>
                <p style="font-size: 9pt; margin-top: 2px;">Data base: <span id="printDate"></span></p>
            </div>

            <div class="card p-6 overflow-hidden">
                <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2 no-print">Resumo do Cálculo</h3>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead>
                            <tr>
                                <th class="p-3">Descrição</th>
                                <th class="p-3 text-center">Período</th>
                                <th class="p-3 text-right">Valor Orig.</th>
                                <th class="p-3 text-right">Valor Corr.</th>
                                <th class="p-3 text-center">Juros %</th>
                                <th class="p-3 text-right">Valor Juros</th>
                                <th class="p-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Linhas via JS -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-right text-slate-600 uppercase"
                                    style="font-size: 9pt; font-weight: 600;">TOTAIS GERAIS:</td>
                                <td class="text-right text-blue-900" id="totalCorrigido">R$ 0,00</td>
                                <td></td>
                                <td class="text-right text-red-800" id="totalJuros">R$ 0,00</td>
                                <td class="text-right text-lg text-blue-900" id="totalGeral">R$ 0,00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Rodapé Técnico -->
                <div id="technicalFooter" class="mt-6 text-slate-500 space-y-1 pt-4 leading-relaxed">
                    <p style="font-weight: 700; color: #334155; margin-bottom: 4px;">Critérios Legais Utilizados:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Correção Monetária:</strong> Tabela Prática do TJSP (INPC até 08/2024, IPCA-15 a
                            partir de 09/2024). Fator acumulado "chumbado" (não pro rata) aplicado sobre o valor
                            original.</li>
                        <li><strong>Juros de Mora (Fase 1 - até 28/08/2024):</strong> 1% ao mês simples (Art. 406 CC/02
                            c/c Art. 161 CTN), contabilizando meses inteiros proporcionais (dias/30).</li>
                        <li><strong>Juros de Mora (Fase 2 - a partir de 29/08/2024):</strong> Taxa Legal (Lei
                            14.905/2024), calculada pela diferença positiva entre a meta SELIC anualizada mensal e o
                            índice de correção monetária do período.</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- Template de Linha -->
    <template id="itemTemplate">
        <div class="card p-4 relative item-row transition-all hover:shadow-md bg-white border-l-4 border-l-blue-500">
            <button onclick="removerItem(this)"
                class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition remove-btn"
                title="Remover item">
                <i class="fas fa-times"></i>
            </button>
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Descrição</label>
                    <input type="text" class="input-field desc-input" placeholder="Ex: Condenação">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Valor (R$)</label>
                    <input type="number" step="0.01" class="input-field valor-input" placeholder="0,00">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Início Correção</label>
                    <input type="month" class="input-field data-ini-input text-xs tracking-tighter">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Termo Final</label>
                    <input type="month" class="input-field data-fim-input text-xs tracking-tighter">
                </div>
                <div class="md:col-span-3 border-l pl-4 border-slate-100">
                    <label class="flex items-center gap-2 cursor-pointer mb-2 select-none">
                        <input type="checkbox" class="juros-check w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                            onchange="toggleJurosFields(this)">
                        <span class="text-xs font-bold text-slate-700">Aplicar Juros?</span>
                    </label>
                    <div class="juros-fields grid grid-cols-2 gap-2 opacity-50 pointer-events-none transition-opacity">
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1">Início</label>
                            <input type="date" class="input-field py-1 text-xs juros-ini-input">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1">Fim</label>
                            <input type="date" class="input-field py-1 text-xs juros-fim-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- 1. DADOS E CONFIGURAÇÃO ---
        let tabelaTJSP = { ...TJSPIndices.baseTabela };

        let selicMensal = {};
        const DATA_CORTE_LEI = new Date('2024-08-28');

        // --- 2. INICIALIZAÇÃO ---
        async function init() {
            adicionarItem();
            await carregarIndicesBCB();
        }

        async function carregarIndicesBCB() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            try {
                const anoAtual = new Date().getFullYear();
                const proxyBase = 'https://falling-morning-2baa.eduardocarnello.workers.dev';
                const respIPCA = await fetch(`${proxyBase}/?serie=7478&de=01/01/${anoAtual}&ate=31/12/${anoAtual}`);
                if (respIPCA.ok) {
                    const dadosIPCA = await respIPCA.json();
                    processarIPCA15(dadosIPCA);
                }
                const respSELIC = await fetch(`${proxyBase}/?serie=4390&de=01/01/2024&ate=31/12/2030`);
                if (respSELIC.ok) {
                    const dadosSELIC = await respSELIC.json();
                    dadosSELIC.forEach(d => {
                        const [dia, mes, ano] = d.data.split('/');
                        selicMensal[`${ano}-${mes}`] = parseFloat(d.valor);
                    });
                }
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-green-500');
                statusText.innerText = "Sincronizado";
            } catch (e) {
                statusDot.classList.replace('bg-yellow-400', 'bg-red-500');
                statusText.innerText = "Offline";
            }
        }

        function processarIPCA15(dados) {
            dados.forEach(item => {
                const [d, m, y] = item.data.split('/');
                let mesTabela = parseInt(m) + 1;
                let anoTabela = parseInt(y);
                if (mesTabela > 12) { mesTabela = 1; anoTabela++; }
                const chave = `${anoTabela}-${String(mesTabela).padStart(2, '0')}`;
                if (!tabelaTJSP[chave]) {
                    let mA = mesTabela - 1; let aA = anoTabela;
                    if (mA === 0) { mA = 12; aA--; }
                    const chaveAnt = `${aA}-${String(mA).padStart(2, '0')}`;
                    if (tabelaTJSP[chaveAnt]) {
                        const novoFator = tabelaTJSP[chaveAnt] * (1 + (parseFloat(item.valor) / 100));
                        tabelaTJSP[chave] = TJSPIndices.trunc6(novoFator);
                    }
                }
            });
        }

        // --- 3. UI ---
        function adicionarItem() {
            const container = document.getElementById('itemsContainer');
            const template = document.getElementById('itemTemplate');
            const clone = template.content.cloneNode(true);
            const hoje = new Date();
            clone.querySelector('.data-fim-input').value = hoje.toISOString().slice(0, 7);
            clone.querySelector('.juros-fim-input').value = hoje.toISOString().split('T')[0];
            container.appendChild(clone);
        }

        function removerItem(btn) {
            const container = document.getElementById('itemsContainer');
            if (container.children.length > 1) {
                btn.closest('.item-row').remove();
            } else {
                const row = btn.closest('.item-row');
                row.querySelectorAll('input').forEach(i => i.value = '');
                row.querySelector('.juros-check').checked = false;
                toggleJurosFields(row.querySelector('.juros-check'));
            }
        }

        function toggleJurosFields(checkbox) {
            const fields = checkbox.closest('.md\\:col-span-3').querySelector('.juros-fields');
            checkbox.checked ? fields.classList.remove('opacity-50', 'pointer-events-none') : fields.classList.add('opacity-50', 'pointer-events-none');

            if (checkbox.checked) {
                const row = checkbox.closest('.item-row');
                const ini = row.querySelector('.data-ini-input').value;
                if (ini && !row.querySelector('.juros-ini-input').value) {
                    row.querySelector('.juros-ini-input').value = `${ini}-01`;
                }
            }
        }

        // --- 4. CÁLCULO ---
        function calcularTudo() {
            const rows = document.querySelectorAll('.item-row');
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            let totalCorrigidoGeral = 0;
            let totalJurosGeral = 0;

            rows.forEach((row) => {
                const desc = row.querySelector('.desc-input').value || `Item`;
                const valorOrig = parseFloat(row.querySelector('.valor-input').value);
                const dataIni = row.querySelector('.data-ini-input').value;
                const dataFim = row.querySelector('.data-fim-input').value;
                const aplicaJuros = row.querySelector('.juros-check').checked;

                if (!valorOrig || !dataIni || !dataFim) return;

                if (!tabelaTJSP[dataIni] && dataIni < '1995-01') {
                    alert(`Data ${dataIni} muito antiga.`); return;
                }

                const ultimasChaves = Object.keys(tabelaTJSP).sort();
                const ultimaDisponivel = ultimasChaves[ultimasChaves.length - 1];
                const chaveFimEfetiva = tabelaTJSP[dataFim] ? dataFim : ultimaDisponivel;

                const fatorIni = tabelaTJSP[dataIni] || 1;
                const fatorFim = tabelaTJSP[chaveFimEfetiva];
                const valorCorrigido = valorOrig * (fatorFim / fatorIni);

                let valorJuros = 0;
                let taxaJurosTotal = 0;
                let jurosPeriodoStr = '';

                if (aplicaJuros) {
                    const dataJurosIni = new Date(row.querySelector('.juros-ini-input').value);
                    const dataJurosFim = new Date(row.querySelector('.juros-fim-input').value);

                    if (!isNaN(dataJurosIni) && !isNaN(dataJurosFim)) {
                        jurosPeriodoStr = ` | Juros: ${formatDataDia(row.querySelector('.juros-ini-input').value)} a ${formatDataDia(row.querySelector('.juros-fim-input').value)}`;

                        let dataMarco = new Date(DATA_CORTE_LEI);
                        let fimFase1 = (dataJurosFim < dataMarco) ? dataJurosFim : dataMarco;

                        if (dataJurosIni < fimFase1) {
                            const diffTime = Math.abs(fimFase1 - dataJurosIni);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            const mesesFase1 = diffDays / 30;
                            taxaJurosTotal += (mesesFase1 * 1.0);
                        }

                        if (dataJurosFim > dataMarco) {
                            let inicioFase2 = (dataJurosIni > dataMarco) ? dataJurosIni : new Date(dataMarco.getTime() + 86400000);
                            let current = new Date(inicioFase2);
                            while (current < dataJurosFim) {
                                const m = String(current.getMonth() + 1).padStart(2, '0');
                                const y = current.getFullYear();
                                const key = `${y}-${m}`;

                                let fatorMes = tabelaTJSP[key];
                                let mA = parseInt(m) - 1; let aA = parseInt(y);
                                if (mA === 0) { mA = 12; aA--; }
                                let keyAnt = `${aA}-${String(mA).padStart(2, '0')}`;
                                let fatorAnt = tabelaTJSP[keyAnt];

                                let ipcaMensal = 0;
                                if (fatorMes && fatorAnt) {
                                    ipcaMensal = ((fatorMes / fatorAnt) - 1) * 100;
                                }

                                let selic = selicMensal[key] || 0.85;
                                let spread = selic - ipcaMensal;
                                if (spread < 0) spread = 0;

                                taxaJurosTotal += spread;
                                current.setMonth(current.getMonth() + 1);
                            }
                        }
                    }
                    valorJuros = valorCorrigido * (taxaJurosTotal / 100);
                }

                const totalLinha = valorCorrigido + valorJuros;
                totalCorrigidoGeral += valorCorrigido;
                totalJurosGeral += valorJuros;

                // Renderiza Linha Principal
                const trMain = document.createElement('tr');
                trMain.className = 'main-row';
                trMain.innerHTML = `
                    <td>${desc}</td>
                    <td class="text-center data" style=>${formatData(dataIni)} a ${formatData(chaveFimEfetiva)}</td>
                    <td class="text-right">${formatMoeda(valorOrig)}</td>
                    <td class="text-right font-bold text-blue-800">${formatMoeda(valorCorrigido)}</td>
                <td class="text-center text-xs">${aplicaJuros ? taxaJurosTotal.toFixed(4).replace('.', ',') + '%' : '-'}</td>
                    <td class="text-right text-red-700">${aplicaJuros ? formatMoeda(valorJuros) : '-'}</td>
                    <td class="text-right font-bold bg-blue-50">${formatMoeda(totalLinha)}</td>
                `;


                tbody.appendChild(trMain);

                // Renderiza Detalhe (Coeficientes + Data Juros)
                const trDetail = document.createElement('tr');
                trDetail.className = 'detail-row';
                trDetail.innerHTML = `
                    <td colspan="7" class="bg-slate-50 text-[10px] text-slate-400 border-t-0 p-2">
                        &rdsh; Índice Inicial: ${fatorIni.toFixed(6)} | Índice Final: ${fatorFim.toFixed(6)} ${jurosPeriodoStr}
                    </td>
                `;//Coef: ${(fatorFim / fatorIni).toFixed(8)}
                tbody.appendChild(trDetail);
            });

            document.getElementById('totalCorrigido').innerText = formatMoeda(totalCorrigidoGeral);
            document.getElementById('totalJuros').innerText = formatMoeda(totalJurosGeral);
            document.getElementById('totalGeral').innerText = formatMoeda(totalCorrigidoGeral + totalJurosGeral);
            document.getElementById('resultsArea').classList.remove('hidden');
        }

        function formatMoeda(val) { return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function formatData(isoStr) { const [ano, mes] = isoStr.split('-'); return `${mes}/${ano}`; }

        function formatDataDia(isoDateStr) {
            if (!isoDateStr) return "";
            const [y, m, d] = isoDateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function imprimirRelatorio() {
            document.getElementById('printDate').innerText = new Date().toLocaleDateString('pt-BR');
            window.print();
        }

        init();
    </script>
</body>

</html>