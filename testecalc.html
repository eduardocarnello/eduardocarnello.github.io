<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Atualização de Débito Judicial</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts para uma melhor tipografia -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para a área de impressão, para garantir boa aparência no PDF */
        #printable-area,
        #petition-area {
            font-family: 'Inter', sans-serif;
            color: #111827;
            /* Cor do texto (gray-900) */
        }

        p.border-t.border-gray-800.w-3\/4.mx-auto {
            padding-top: 0;
            margin-top: 0;
            line-height: normal;
        }

        #petition-area {
            line-height: 2;
            text-align: justify;
            font-size: 12pt;
        }

        /* Estilo para o spinner de carregamento */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Calculadora de Atualização de Débito Judicial</h1>
            <p class="text-gray-500 mt-2">Insira os valores da condenação para calcular a atualização monetária e juros.
            </p>
        </header>

        <main>
            <!-- Seção para o número do processo -->
            <div class="mb-6">
                <label for="process-number" class="block text-sm font-medium text-gray-700 mb-2">Número do Processo
                    (Padrão CNJ)</label>
                <input type="text" id="process-number" name="process-number"
                    class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Apenas números" maxlength="25">
            </div>

            <!-- Container para as linhas de cálculo -->
            <div id="calculation-rows" class="space-y-4">
                <!-- Linha de exemplo, será clonada -->
                <div
                    class="calculation-row grid grid-cols-1 md:grid-cols-12 gap-4 items-end p-4 border border-gray-200 rounded-lg">
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Descrição</label>
                        <select class="description-select w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                            <option value="Dano Material">Dano Material</option>
                            <option value="Dano Moral">Dano Moral</option>
                            <option value="Restituição">Restituição</option>
                            <option value="Multa">Multa</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                        <input type="number" step="0.01"
                            class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                            placeholder="1000,00">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Data Inicial (Correção)</label>
                        <input type="text"
                            class="date-input correction-date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                            placeholder="DD/MM/AAAA">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Data Inicial (Juros)</label>
                        <input type="text"
                            class="date-input interest-date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                            placeholder="DD/MM/AAAA">
                    </div>
                    <div class="md:col-span-1">
                        <button
                            class="remove-row-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-colors duration-200"
                            title="Remover Linha">&times;</button>
                    </div>
                </div>
            </div>

            <!-- Botão para adicionar mais linhas -->
            <div class="mt-6 flex justify-start">
                <button id="add-row-btn"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">+
                    Adicionar Linha</button>
            </div>

            <hr class="my-8 border-gray-200">

            <!-- Opções Finais -->
            <div class="space-y-4">
                <!-- Checkbox para multa do Art. 523 -->
                <div class="flex items-center justify-end">
                    <label for="add-fine-checkbox"
                        class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-100">
                        <input type="checkbox" id="add-fine-checkbox"
                            class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="ml-3 text-base font-medium text-gray-800">Inserir multa do art. 523 (10%)?</span>
                    </label>
                </div>
                <!-- Checkbox para Cumprimento de Sentença -->
                <div class="flex items-center justify-end">
                    <label for="compliance-request-checkbox"
                        class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-100">
                        <input type="checkbox" id="compliance-request-checkbox"
                            class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="ml-3 text-base font-medium text-gray-800">Incluir Petição de Cumprimento de
                            Sentença</span>
                    </label>
                </div>
            </div>

            <!-- Seção de Exequentes e Penhora (oculta por padrão) -->
            <div id="petition-options-container" class="hidden mt-6 p-4 border-t border-dashed space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados do(s) Exequente(s)</h3>
                    <div id="exequentes-list" class="space-y-3">
                        <div class="exequente-item flex items-center gap-3">
                            <input type="text"
                                class="exequente-name-input flex-grow p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Nome completo do Exequente" required>
                        </div>
                    </div>
                    <button id="add-exequente-btn"
                        class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg">+
                        Adicionar outro exequente</button>
                </div>
                <div id="penhora-container">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Pedidos de Penhora (Opcional)</h3>
                    <div class="space-y-3 text-sm text-gray-700">
                        <div>
                            <label><input type="checkbox" id="penhora-contas"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded" checked> Penhora de Valores
                                em Contas</label>
                        </div>
                        <div>
                            <label><input type="checkbox" id="penhora-veiculos"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded" checked> Pesquisa, Bloqueio
                                e Penhora de Veículos</label>
                        </div>
                        <div>
                            <label><input type="checkbox" id="penhora-mandado"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded" checked> Expedição de
                                Mandado de Penhora e Avaliação</label>
                        </div>
                        <div>
                            <label><input type="checkbox" id="penhora-outros-check"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded"> Outro(s) Pedido(s)</label>
                        </div>
                        <textarea id="penhora-outros-text"
                            class="hidden w-full mt-2 p-2 border border-gray-300 rounded-lg" rows="3"
                            placeholder="Especifique outros pedidos aqui..."></textarea>
                    </div>
                </div>
            </div>


            <!-- Botões de Ação -->
            <div class="flex flex-col md:flex-row gap-4 justify-end mt-8">
                <button id="calculate-btn" disabled
                    class="bg-indigo-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center">
                    <span class="loader"></span> Carregando dados...
                </button>
                <button id="preview-btn" disabled
                    class="bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg">Prévia do
                    PDF</button>
                <button id="print-btn" disabled
                    class="bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg">Gerar
                    PDF</button>
            </div>

            <!-- Seção de Resultados -->
            <div id="results-container" class="mt-10 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <!-- Esta parte será usada para gerar o PDF -->
            </div>

        </main>
    </div>

    <!-- Modal de Pré-visualização -->
    <div id="preview-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-200 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 relative">
            <button id="close-preview-btn"
                class="absolute top-3 right-3 text-3xl font-bold text-gray-500 hover:text-gray-800 leading-none">&times;</button>
            <div id="preview-content" class="space-y-8">
                <!-- Conteúdo da prévia será injetado aqui -->
            </div>
        </div>
    </div>

    <!-- Divs ocultas para formatar a impressão -->
    <div style="position: absolute; left: -9999px; width: 210mm;">
        <div id="petition-area" class="w-full p-8 bg-white"></div>
        <div id="printable-area" class="w-full p-8 bg-white">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800">Demonstrativo de Cálculo de Débito Judicial</h2>
                <p class="text-gray-600 mt-1">Cálculo realizado em: <span id="print-date"></span></p>
            </div>
            <p class="mb-4"><strong>Processo nº:</strong> <span id="print-process-number"></span></p>
            <hr class="my-4">
            <div id="print-results-content"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addRowBtn = document.getElementById('add-row-btn');
            const calculateBtn = document.getElementById('calculate-btn');
            const printBtn = document.getElementById('print-btn');
            const previewBtn = document.getElementById('preview-btn');
            const rowsContainer = document.getElementById('calculation-rows');
            const resultsContainer = document.getElementById('results-container');
            const processNumberInput = document.getElementById('process-number');
            const addFineCheckbox = document.getElementById('add-fine-checkbox');
            const complianceRequestCheckbox = document.getElementById('compliance-request-checkbox');
            const petitionOptionsContainer = document.getElementById('petition-options-container');
            const exequentesList = document.getElementById('exequentes-list');
            const addExequenteBtn = document.getElementById('add-exequente-btn');
            const penhoraOutrosCheck = document.getElementById('penhora-outros-check');
            const penhoraOutrosText = document.getElementById('penhora-outros-text');
            const previewModal = document.getElementById('preview-modal');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const previewContent = document.getElementById('preview-content');

            let ipcaData = {};
            let ipca15Data = {};
            let monthlySelicData = {};

            const fetchEconomicData = async () => {
                const today = new Date();
                const fiveYearsAgo = new Date(today.getFullYear() - 5, today.getMonth(), today.getDate());
                const formatDateForApi = (date) => `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                const startDate = formatDateForApi(fiveYearsAgo);
                const endDate = formatDateForApi(today);
                const IPCA_CODE = 433, IPCA15_CODE = 7478, SELIC_DAILY_CODE = 11;
                const ipcaUrl = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${IPCA_CODE}/dados?formato=json&dataInicial=${startDate}&dataFinal=${endDate}`;
                const ipca15Url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${IPCA15_CODE}/dados?formato=json&dataInicial=${startDate}&dataFinal=${endDate}`;
                const selicUrl = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${SELIC_DAILY_CODE}/dados?formato=json&dataInicial=${startDate}&dataFinal=${endDate}`;
                try {
                    const [ipcaResponse, ipca15Response, selicResponse] = await Promise.all([fetch(ipcaUrl), fetch(ipca15Url), fetch(selicUrl)]);
                    if (!ipcaResponse.ok || !ipca15Response.ok || !selicResponse.ok) throw new Error('Falha ao buscar dados do Banco Central.');
                    const [ipcaJson, ipca15Json, selicJson] = await Promise.all([ipcaResponse.json(), ipca15Response.json(), selicResponse.json()]);
                    const processMonthlyData = (jsonData) => jsonData.reduce((acc, item) => {
                        const [day, month, year] = item.data.split('/');
                        acc[`${year}-${month}`] = parseFloat(item.valor);
                        return acc;
                    }, {});
                    const processDailySelic = (dailyData) => {
                        const monthlyFactors = dailyData.reduce((acc, item) => {
                            const [day, month, year] = item.data.split('/');
                            const key = `${year}-${month}`;
                            acc[key] = (acc[key] || 1) * (1 + parseFloat(item.valor) / 100);
                            return acc;
                        }, {});
                        return Object.entries(monthlyFactors).reduce((acc, [key, factor]) => {
                            acc[key] = (factor - 1) * 100;
                            return acc;
                        }, {});
                    };
                    ipcaData = processMonthlyData(ipcaJson);
                    ipca15Data = processMonthlyData(ipca15Json);
                    monthlySelicData = processDailySelic(selicJson);
                    calculateBtn.disabled = false;
                    calculateBtn.innerHTML = 'Calcular Valor Atualizado';
                    calculateBtn.className = calculateBtn.className.replace('bg-indigo-400 cursor-not-allowed', 'bg-indigo-600 hover:bg-indigo-700');
                } catch (error) {
                    console.error('Erro ao buscar dados econômicos:', error);
                    calculateBtn.innerHTML = 'Erro ao carregar dados';
                    calculateBtn.className = calculateBtn.className.replace('bg-indigo-400', 'bg-red-600');
                    alert('Não foi possível carregar os índices econômicos. Por favor, tente recarregar a página.');
                }
            };

            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const addRow = () => {
                const newRow = rowsContainer.querySelector('.calculation-row').cloneNode(true);
                newRow.querySelectorAll('input').forEach(input => input.value = '');
                rowsContainer.appendChild(newRow);
                addDateMasking(newRow);
            };

            const removeRow = (e) => {
                if (e.target.classList.contains('remove-row-btn') && rowsContainer.children.length > 1) {
                    e.target.closest('.calculation-row').remove();
                } else if (e.target.classList.contains('remove-row-btn')) {
                    alert('Pelo menos uma linha de cálculo é necessária.');
                }
            };

            const formatCNJOnInput = (e) => {
                const input = e.target;
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/(\d{7})(\d)/, "$1-$2");
                v = v.replace(/(\d{7}-\d{2})(\d)/, "$1.$2");
                v = v.replace(/(\d{7}-\d{2}\.\d{4})(\d)/, "$1.$2");
                v = v.replace(/(\d{7}-\d{2}\.\d{4}\.\d{1})(\d)/, "$1.$2");
                v = v.replace(/(\d{7}-\d{2}\.\d{4}\.\d{1}\.\d{2})(\d)/, "$1.$2");
                input.value = v;
            };

            const formatDateOnInput = (e) => {
                const input = e.target;
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/(\d{2})(\d)/, "$1/$2");
                v = v.replace(/(\d{2})\/(\d{2})(\d)/, "$1/$2/$3");
                input.value = v.slice(0, 10);
            };

            const autocompleteDateOnBlur = (e) => {
                let value = e.target.value;
                if (!value) return;
                const parts = value.split('/');
                const today = new Date();
                const day = parts[0]?.padStart(2, '0') || '';
                let month = parts[1] || '';
                let year = parts[2] || '';

                if (day && !month) {
                    month = String(today.getMonth() + 1).padStart(2, '0');
                    year = today.getFullYear();
                } else if (day && month && !year) {
                    year = today.getFullYear();
                }

                if (day && month && year && year.length < 4) {
                    year = String(parseInt(year, 10) + 2000);
                }

                if (day && month && year) {
                    e.target.value = `${day}/${month}/${year}`;
                }
            };

            const addDateMasking = (container) => {
                container.querySelectorAll('.date-input').forEach(input => {
                    input.addEventListener('input', formatDateOnInput);
                    input.addEventListener('blur', autocompleteDateOnBlur);
                });
            };

            let lastCalculatedTotal = 0;
            const calculate = () => {
                let totalUpdatedValue = 0;
                let resultsHTML = '<h3 class="text-xl font-bold text-gray-800 mb-4">Resumo do Cálculo</h3><div class="space-y-6">';
                const rows = rowsContainer.querySelectorAll('.calculation-row');
                const finalCalcDate = new Date();

                rows.forEach((row, index) => {
                    const description = row.querySelector('.description-select').value;
                    const originalValue = parseFloat(row.querySelector('.value-input').value) || 0;
                    const parseDate = (dateStr) => {
                        if (!dateStr || dateStr.length < 10) return NaN;
                        const [day, month, year] = dateStr.split('/');
                        return new Date(`${year}-${month}-${day}T12:00:00Z`);
                    };
                    const correctionDate = parseDate(row.querySelector('.correction-date-input').value);
                    const interestDate = parseDate(row.querySelector('.interest-date-input').value);
                    if (originalValue === 0 || isNaN(correctionDate.getTime()) || isNaN(interestDate.getTime())) return;

                    const finalFullMonthDate = new Date(finalCalcDate.getFullYear(), finalCalcDate.getMonth(), 1);
                    let correctedValue = originalValue;
                    for (let d = new Date(correctionDate); d < finalFullMonthDate; d.setMonth(d.getMonth() + 1)) {
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        correctedValue *= (1 + (ipcaData[key] || 0) / 100);
                    }
                    const totalCorrection = correctedValue - originalValue;
                    const correctionFactorPercent = originalValue > 0 ? (totalCorrection / originalValue) * 100 : 0;

                    let baseForInterest = originalValue;
                    for (let d = new Date(correctionDate); d < interestDate && d < finalFullMonthDate; d.setMonth(d.getMonth() + 1)) {
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        baseForInterest *= (1 + (ipcaData[key] || 0) / 100);
                    }

                    let sumOfLegalRates = 0;
                    for (let d = new Date(interestDate); d < finalCalcDate; d.setMonth(d.getMonth() + 1)) {
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        let legalRate = (monthlySelicData[key] || 0) - (ipca15Data[key] || 0);
                        legalRate = Math.max(0, legalRate);
                        if (d.getFullYear() === finalCalcDate.getFullYear() && d.getMonth() === finalCalcDate.getMonth()) {
                            legalRate *= finalCalcDate.getDate() / new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                        }
                        sumOfLegalRates += legalRate;
                    }

                    const totalInterest = baseForInterest * (sumOfLegalRates / 100);
                    const finalValueForRow = originalValue + totalCorrection + totalInterest;
                    totalUpdatedValue += finalValueForRow;

                    resultsHTML += `<div class="p-4 border rounded-lg bg-white"><p class="font-semibold text-lg text-indigo-700">${index + 1}. ${description}</p><div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 mt-2 text-sm"><div><span class="font-medium text-gray-600">Valor Original:</span><br>${formatCurrency(originalValue)}</div><div><span class="font-medium text-gray-600">Correção (IPCA):</span><br>${formatCurrency(totalCorrection)}</div><div><span class="font-medium text-gray-600">Juros de Mora (Taxa Legal):</span><br>${formatCurrency(totalInterest)}</div><div class="font-bold"><span class="font-medium text-gray-600">Subtotal:</span><br>${formatCurrency(finalValueForRow)}</div></div><div class="col-span-full border-t pt-2 mt-2 grid grid-cols-2 md:grid-cols-3 gap-x-4 text-sm"><div><span class="font-medium text-gray-500">Fator da atualização (%):</span><br>${correctionFactorPercent.toFixed(6).replace('.', ',')}%</div><div><span class="font-medium text-gray-500">Taxa Legal Acumulada (%):</span><br>${sumOfLegalRates.toFixed(6).replace('.', ',')}%</div></div></div>`;
                });

                resultsHTML += `</div>`;
                lastCalculatedTotal = totalUpdatedValue;
                let fineRowHtml = '';
                let finalGrandTotal = totalUpdatedValue;
                if (addFineCheckbox.checked && totalUpdatedValue > 0) {
                    const fineValue = totalUpdatedValue * 0.10;
                    finalGrandTotal += fineValue;
                    fineRowHtml = `<div class="flex justify-between items-center mt-2"><p class="text-lg font-semibold text-gray-700">Multa do art. 523 (10%):</p><p class="text-xl font-semibold text-red-600">${formatCurrency(fineValue)}</p></div>`;
                }
                resultsHTML += `<div class="mt-8 pt-4 border-t-2 border-indigo-500 text-right space-y-2"><div class="flex justify-between items-center"><p class="text-lg text-gray-600">Subtotal da Condenação Atualizada:</p><p class="text-2xl font-bold text-indigo-700">${formatCurrency(totalUpdatedValue)}</p></div>${fineRowHtml}<div class="flex justify-between items-center pt-4 border-t mt-2"><p class="text-lg font-bold text-gray-800">Valor Total do Débito:</p><p class="text-3xl font-bold text-indigo-700">${formatCurrency(finalGrandTotal)}</p></div></div>`;
                resultsContainer.innerHTML = resultsHTML;
                resultsContainer.classList.remove('hidden');

                const hasResults = totalUpdatedValue > 0;
                printBtn.disabled = !hasResults;
                previewBtn.disabled = !hasResults;
                printBtn.className = printBtn.className.replace('bg-gray-400 cursor-not-allowed', 'bg-green-600 hover:bg-green-700');
                previewBtn.className = previewBtn.className.replace('bg-gray-400 cursor-not-allowed', 'bg-blue-600 hover:bg-blue-700');
            };

            const generatePetitionHTML = () => {
                const processNumber = processNumberInput.value || 'Não informado';
                const printDate = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                const exequenteInputs = exequentesList.querySelectorAll('.exequente-name-input');
                const allExequentes = Array.from(exequenteInputs).map(input => input.value.trim()).filter(Boolean);

                if (complianceRequestCheckbox.checked && allExequentes.length === 0) {
                    alert('Por favor, informe o nome de pelo menos um exequente.');
                    exequenteInputs[0].focus();
                    return null;
                }

                let exequentesText = '';
                if (allExequentes.length === 1) {
                    exequentesText = `<strong>${allExequentes[0].toUpperCase()}</strong>, já qualificado(a) nos autos`;
                } else if (allExequentes.length > 1) {
                    const last = allExequentes[allExequentes.length - 1];
                    const firsts = allExequentes.slice(0, -1);
                    exequentesText = firsts.map(name => `<strong>${name.toUpperCase()}</strong>`).join(', ') + ` e <strong>${last.toUpperCase()}</strong>, já qualificados nos autos`;
                }

                let totalDebit = lastCalculatedTotal;
                if (addFineCheckbox.checked) {
                    totalDebit *= 1.10;
                }
                const penaltyTotal = totalDebit * 1.10;

                let penhoraRequestsHTML = '';
                const requests = [];
                if (document.getElementById('penhora-contas').checked) requests.push('a pesquisa e bloqueio de valores em contas bancárias via SISBAJUD;');
                if (document.getElementById('penhora-veiculos').checked) requests.push('a pesquisa, bloqueio e penhora de veículos via RENAJUD;');
                if (document.getElementById('penhora-mandado').checked) requests.push('a expedição de mandado de penhora e avaliação de bens;');
                const outrosTextValue = penhoraOutrosText.value.trim();
                if (penhoraOutrosCheck.checked && outrosTextValue) requests.push(outrosTextValue);
                if (requests.length > 0) {
                    penhoraRequestsHTML = `<p>Caso não haja o pagamento voluntário, requer o prosseguimento da execução com as seguintes medidas:</p><div class="pl-8 space-y-1">${requests.map((req, index) => `<p>${index + 1}. ${req}</p>`).join('')}</div>`;
                }

                const signaturesHTML = allExequentes.map(name => `<div class="text-center"><p class="border-t border-gray-800 w-3/4 mx-auto ">${name.toUpperCase()}</p></div>`).join('');

                return `<div class="p-4 space-y-6"><p class="text-center font-bold">EXCELENTÍSSIMO(A) SENHOR(A) DOUTOR(A) JUIZ(A) DE DIREITO DO JUIZADO ESPECIAL CÍVEL DA COMARCA DE MARÍLIA - SP</p><p class="mt-8"><strong>Processo nº: ${processNumber}</strong></p><p class="mt-8">${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong> em face do(a)(s) executado(a)(s), também já qualificado(a)(s), tendo em vista o trânsito em julgado da r. sentença.</p><p>Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo legal, efetue o pagamento devido, no importe de <strong>${formatCurrency(totalDebit)}</strong>, conforme cálculo anexo. Não ocorrendo o pagamento, requer que o débito seja acrescido da multa de 10% prevista no art. 523, §1º do CPC, totalizando a quantia de <strong>${formatCurrency(penaltyTotal)}</strong>.</p>${penhoraRequestsHTML}<p class="mt-12">Nestes termos, pede deferimento.</p><p class="mt-16 text-right">Marília, ${printDate}.</p><div class="mt-32 space-y-16"><p>  </p>${signaturesHTML}</div></div>`;
            };

            const showPreview = () => {
                let finalHTML = '';
                if (complianceRequestCheckbox.checked) {
                    const petitionHTML = generatePetitionHTML();
                    if (!petitionHTML) return; // Aborta se não houver exequentes
                    finalHTML += `<h2 class="text-xl font-bold text-center mb-4">Página 1: Petição</h2><div class="p-8 border shadow-lg bg-white mx-auto" style="width: 210mm;">${petitionHTML}</div>`;
                }

                const calculationHTML = document.getElementById('printable-area').cloneNode(true);
                calculationHTML.querySelector('#print-date').innerText = new Date().toLocaleDateString('pt-BR');
                calculationHTML.querySelector('#print-process-number').innerText = processNumberInput.value || 'Não informado';
                calculationHTML.querySelector('#print-results-content').innerHTML = resultsContainer.innerHTML;

                finalHTML += `<h2 class="text-xl font-bold text-center mt-8 mb-4">Página 2: Demonstrativo de Cálculo</h2><div class="mx-auto" style="width: 210mm;">${calculationHTML.innerHTML}</div>`;

                previewContent.innerHTML = finalHTML;
                previewModal.classList.remove('hidden');
            };

            const printPDF = async () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const processNumber = processNumberInput.value || 'Não informado';

                if (complianceRequestCheckbox.checked) {
                    const petitionHTML = generatePetitionHTML();
                    if (!petitionHTML) return;

                    const petitionArea = document.getElementById('petition-area');
                    petitionArea.innerHTML = petitionHTML;
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvasP1 = await html2canvas(petitionArea, { scale: 2.5 });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasHeightInPdf = (canvasP1.height * pdfWidth) / canvasP1.width;
                    let heightLeft = canvasHeightInPdf;
                    let position = 0;
                    pdf.addImage(canvasP1, 'PNG', 0, position, pdfWidth, canvasHeightInPdf);
                    heightLeft -= pdfHeight;
                    while (heightLeft > 0) {
                        position -= pdfHeight;
                        pdf.addPage();
                        pdf.addImage(canvasP1, 'PNG', 0, position, pdfWidth, canvasHeightInPdf);
                        heightLeft -= pdfHeight;
                    }
                    pdf.addPage();
                }

                document.getElementById('print-date').innerText = new Date().toLocaleDateString('pt-BR');
                document.getElementById('print-process-number').innerText = processNumber;
                document.getElementById('print-results-content').innerHTML = resultsContainer.innerHTML;
                const printableArea = document.getElementById('printable-area');
                await new Promise(resolve => setTimeout(resolve, 100));

                const canvasP2 = await html2canvas(printableArea, { scale: 2 });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeightP2 = (canvasP2.height * pdfWidth) / canvasP2.width;
                pdf.addImage(canvasP2.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, pdfHeightP2);
                pdf.save(`Calculo_Processo_${processNumber.replace(/\D/g, '')}.pdf`);
            };

            complianceRequestCheckbox.addEventListener('change', () => petitionOptionsContainer.classList.toggle('hidden'));
            addExequenteBtn.addEventListener('click', () => {
                const newItem = document.createElement('div');
                newItem.className = 'exequente-item flex items-center gap-3';
                newItem.innerHTML = `<input type="text" class="exequente-name-input flex-grow p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Nome completo do Exequente"><button class="remove-exequente-btn bg-red-500 hover:bg-red-600 text-white font-bold px-3 py-1 rounded-lg">&times;</button>`;
                exequentesList.appendChild(newItem);
            });
            exequentesList.addEventListener('click', (e) => { if (e.target.classList.contains('remove-exequente-btn')) e.target.parentElement.remove() });
            penhoraOutrosCheck.addEventListener('change', () => penhoraOutrosText.classList.toggle('hidden'));
            addRowBtn.addEventListener('click', addRow);
            rowsContainer.addEventListener('click', removeRow);
            calculateBtn.addEventListener('click', calculate);
            printBtn.addEventListener('click', printPDF);
            previewBtn.addEventListener('click', showPreview);
            closePreviewBtn.addEventListener('click', () => previewModal.classList.add('hidden'));
            previewModal.addEventListener('click', (e) => { if (e.target === previewModal) previewModal.classList.add('hidden'); });
            addFineCheckbox.addEventListener('change', calculate);
            processNumberInput.addEventListener('input', formatCNJOnInput);
            addDateMasking(document.body);
            fetchEconomicData();
        });
    </script>
</body>

</html>