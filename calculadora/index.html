<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Atualização de Débito Judicial</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Google Fonts para uma melhor tipografia -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para a área de impressão, para garantir boa aparência no PDF */
        #printable-area,
        #petition-area {
            font-family: 'Times New Roman', Times, serif;
            /* Fonte padrão para documentos legais */
            color: #111827;
        }

        p.border-t.border-gray-800.w-3\/4.mx-auto {
            padding-top: 0;
            margin-top: 0;
            line-height: normal;
        }

        #petition-area {
            line-height: 2;
            text-align: justify;
            font-size: 12pt;
        }

        /* Estilo para o spinner de carregamento */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Calculadora de Atualização de Débito Judicial</h1>
            <p class="text-gray-500 mt-2">Selecione o tipo de cálculo e insira os dados para a atualização monetária.
            </p>
        </header>

        <main>
            <!-- Seção de parâmetros gerais do cálculo -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="process-number" class="block text-sm font-medium text-gray-700 mb-2">Número do Processo
                        (Padrão CNJ)</label>
                    <input type="text" id="process-number" name="process-number"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="Apenas números" maxlength="25">
                </div>
                <div>
                    <label for="calculation-type" class="block text-sm font-medium text-gray-700 mb-2">Tipo de
                        Cálculo</label>
                    <select id="calculation-type"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="condemnation">Atualização da Condenação</option>
                        <option value="agreement">Atualização por Descumprimento de Acordo</option>
                    </select>
                </div>
                <div>
                    <label for="final-date" class="block text-sm font-medium text-gray-700 mb-2">Data Final
                        (Opcional)</label>
                    <input type="text" id="final-date"
                        class="date-input w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="Padrão: Hoje">
                </div>
            </div>


            <!-- Container para Atualização da Condenação -->
            <div id="condemnation-container">
                <!-- Container para as linhas de cálculo -->
                <div id="calculation-rows" class="space-y-4">
                    <!-- Linha de exemplo, será clonada -->
                    <div
                        class="calculation-row grid grid-cols-1 md:grid-cols-12 gap-4 items-end p-4 border border-gray-200 rounded-lg">
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Descrição</label>
                            <select
                                class="description-select w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                                <option value="Dano Material">Dano Material</option>
                                <option value="Dano Moral">Dano Moral</option>
                                <option value="Restituição">Restituição</option>
                                <option value="Multa">Multa</option>
                                <option value="Multa (%)">Multa (%)</option>
                                <option value="Última Atualização">Última Atualização</option>
                                <option value="Dedução/Pagamento Parcial">Dedução/Pagamento Parcial</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <input type="text"
                                class="other-description-input w-full mt-2 p-2 border border-gray-300 rounded-lg shadow-sm hidden"
                                placeholder="Digite a descrição">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                            <input type="text"
                                class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="1.000,00">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Data Inicial (Correção)</label>
                            <input type="text"
                                class="date-input correction-date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Data Inicial (Juros)</label>
                            <input type="text"
                                class="date-input interest-date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                        <div class="md:col-span-1">
                            <button
                                class="remove-row-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-colors duration-200"
                                title="Remover Linha">&times;</button>
                        </div>
                    </div>
                </div>

                <!-- Botão para adicionar mais linhas -->
                <div class="mt-6 flex justify-start">
                    <button id="add-row-btn"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">+
                        Adicionar Linha</button>
                </div>

            </div>

            <!-- Container para Descumprimento de Acordo -->
            <div id="agreement-container" class="hidden">
                <div class="p-4 border border-gray-200 rounded-lg space-y-4">
                    <div>
                        <label for="agreement-type" class="block text-sm font-medium text-gray-700">Tipo de
                            Descumprimento</label>
                        <select id="agreement-type" required
                            class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <option value="conhecimento">Acordo Descumprido em Processo de Conhecimento</option>
                            <option value="execucao">Acordo Descumprido em Execução/Cumprimento de Sentença</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nº de Parcelas Totais</label>
                            <input id="agreement-total-installments" type="number"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nº de Parcelas Pagas</label>
                            <input id="agreement-paid-installments" type="number"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Ex: 3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor da Parcela (R$)</label>
                            <input id="agreement-installment-value" type="text"
                                class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="500,00">

                            <div class="mt-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="agreement-last-different-check"
                                        class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <span class="text-xs text-indigo-700 font-semibold">Última parcela diferente?</span>
                                </label>
                            </div>
                            <div id="agreement-last-value-container" class="hidden mt-1">
                                <label class="block text-xs font-medium text-gray-700">Valor da Última (R$)</label>
                                <input id="agreement-last-installment-value" type="text"
                                    class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-yellow-50"
                                    placeholder="Ex: 50,00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data Início do Acordo</label>
                            <input id="agreement-start-date" type="text"
                                class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Multa pelo Descumprimento</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                            <select id="agreement-penalty"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                                <!-- Opções serão preenchidas via JavaScript para cobrir de 0 a 100% -->
                            </select>
                            <div class="mt-1 space-y-1">
                                <label class="flex items-center text-sm">
                                    <input type="radio" name="penalty-base" value="remaining"
                                        class="h-4 w-4 text-indigo-600 border-gray-300" checked>
                                    <span class="ml-2 text-gray-700">Aplicar sobre saldo remanescente atualizado</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="radio" name="penalty-base" value="total"
                                        class="h-4 w-4 text-indigo-600 border-gray-300">
                                    <span class="ml-2 text-gray-700">Aplicar sobre o valor original do acordo</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="border-t pt-4 mt-4">
                        <label class="block text-sm font-medium text-gray-700">Dedução/Pagamento Parcial (Opcional - Use
                            SOMENTE para outros pagamentos que NÃO sejam as parcelas adimplidas)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end mt-1">
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Valor a Deduzir (R$)</label>
                                <input id="agreement-deduction-value" type="text"
                                    class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="Ex: 200,00">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Data do Pagamento</label>
                                <input id="agreement-deduction-date" type="text"
                                    class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="DD/MM/AAAA">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-8 border-gray-200">

            <!-- Opções Finais e Petição -->
            <div id="final-options-container">
                <!-- Opções para ATUALIZAÇÃO DA CONDENAÇÃO -->
                <div id="condemnation-options" class="space-y-4">
                    <div class="flex items-center justify-end">
                        <label for="add-fine-checkbox"
                            class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-100">
                            <input type="checkbox" id="add-fine-checkbox"
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-3 text-base font-medium text-gray-800">Inserir multa do art. 523
                                (10%)?</span>
                        </label>
                    </div>
                    <div class="flex items-center justify-end">
                        <label for="compliance-request-checkbox"
                            class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-100">
                            <input type="checkbox" id="compliance-request-checkbox"
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-3 text-base font-medium text-gray-800">Incluir Petição de Cumprimento de
                                Sentença</span>
                        </label>
                    </div>
                </div>

                <!-- Opções para DESCUMPRIMENTO DE ACORDO (a petição é obrigatória) -->
                <div id="agreement-petition-option" class="hidden flex items-center justify-end">
                    <label class="flex items-center p-2 rounded-lg bg-gray-100">
                        <input type="checkbox" id="agreement-petition-checkbox" checked disabled
                            class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="ml-3 text-base font-medium text-gray-800">Incluir Petição por Descumprimento de
                            Acordo</span>
                    </label>
                </div>
            </div>

            <!-- Seção de Exequentes e Penhora (oculta por padrão) -->
            <div id="petition-options-container" class="hidden mt-6 p-4 border-t border-dashed space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados do(s) Exequente(s)</h3>
                    <div id="exequentes-list" class="space-y-3">
                        <div class="exequente-item flex items-center gap-3">
                            <input type="text"
                                class="exequente-name-input flex-grow p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Nome completo do Exequente" required>
                        </div>
                    </div>
                    <button id="add-exequente-btn"
                        class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg">+
                        Adicionar outro exequente</button>
                </div>

                <!-- Pedido de Intimação (Apenas para Acordo) -->
                <div id="intimation-request-container" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Pedido de Intimação</h3>
                    <div class="flex items-center gap-4 p-2 bg-gray-50 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="include-intimation-checkbox"
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded">
                            <span class="ml-3 font-medium text-gray-800">Incluir pedido de intimação para
                                pagamento?</span>
                        </label>
                        <div id="intimation-deadline-wrapper" class="hidden">
                            <label for="intimation-deadline" class="sr-only">Prazo:</label>
                            <select id="intimation-deadline"
                                class="p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                                <option value="5">5 dias</option>
                                <option value="10">10 dias</option>
                                <option value="15" selected>15 dias</option>
                                <option value="20">20 dias</option>
                                <option value="30">30 dias</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="penhora-container">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Pedidos de Penhora</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="penhora-contas"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                                <span class="ml-3 font-medium text-gray-800">Penhora de Valores em Contas</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="penhora-veiculos"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                                <span class="ml-3 font-medium text-gray-800">Pesquisa, Bloqueio e Penhora de
                                    Veículos</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="penhora-mandado"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                                <span class="ml-3 font-medium text-gray-800">Expedição de Mandado de Penhora e
                                    Avaliação</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="penhora-outros-check"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded">
                                <span class="ml-3 font-medium text-gray-800">Outro(s) Pedido(s)</span>
                            </label>
                        </div>
                        <textarea id="penhora-outros-text"
                            class="hidden w-full mt-2 p-2 border border-gray-300 rounded-lg font-normal" rows="3"
                            placeholder="Especifique outros pedidos aqui..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="flex flex-col md:flex-row gap-4 justify-end mt-8">
                <button id="calculate-btn" disabled
                    class="bg-indigo-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center">
                    <span class="loader"></span> Carregando dados...
                </button>
                <button id="preview-btn" disabled
                    class="bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg">Prévia do
                    PDF</button>

                <!-- Container para os botões de PDF -->
                <div id="pdf-buttons-container" class="flex flex-col md:flex-row gap-4">
                    <button id="print-btn"
                        class="bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                        disabled>Gerar PDF</button>
                    <button id="print-combined-btn"
                        class="hidden bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                        disabled>PDF Completo</button>
                    <button id="print-petition-btn"
                        class="hidden bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                        disabled>PDF Petição</button>
                    <button id="print-calc-btn"
                        class="hidden bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                        disabled>PDF Cálculo</button>
                </div>

            </div>

            <!-- Seção de Resultados -->
            <div id="results-container" class="mt-10 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <!-- Resultados do cálculo serão injetados aqui -->
            </div>
        </main>
    </div>

    <!-- Modal de Pré-visualização -->
    <div id="preview-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-200 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 relative">
            <button id="close-preview-btn"
                class="absolute top-3 right-3 text-3xl font-bold text-gray-500 hover:text-gray-800 leading-none">&times;</button>
            <div id="preview-content" class="space-y-8">
                <!-- Conteúdo da prévia será injetado aqui -->
            </div>
        </div>
    </div>

    <!-- Div oculta para renderizar a petição para o PDF -->
    <div style="position: absolute; left: -9999px; width: 210mm;">
        <div id="petition-area" class="w-full p-8 bg-white"></div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- REFERÊNCIAS AOS ELEMENTOS DO DOM ---
            const addRowBtn = document.getElementById('add-row-btn');
            const calculateBtn = document.getElementById('calculate-btn');
            const printBtn = document.getElementById('print-btn');
            const printCombinedBtn = document.getElementById('print-combined-btn');
            const printPetitionBtn = document.getElementById('print-petition-btn');
            const printCalcBtn = document.getElementById('print-calc-btn');
            const previewBtn = document.getElementById('preview-btn');
            const rowsContainer = document.getElementById('calculation-rows');
            const resultsContainer = document.getElementById('results-container');
            const processNumberInput = document.getElementById('process-number');
            const addFineCheckbox = document.getElementById('add-fine-checkbox');
            const complianceRequestCheckbox = document.getElementById('compliance-request-checkbox');
            const petitionOptionsContainer = document.getElementById('petition-options-container');
            const exequentesList = document.getElementById('exequentes-list');
            const addExequenteBtn = document.getElementById('add-exequente-btn');
            const penhoraOutrosCheck = document.getElementById('penhora-outros-check');
            const penhoraOutrosText = document.getElementById('penhora-outros-text');
            const previewModal = document.getElementById('preview-modal');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const previewContent = document.getElementById('preview-content');
            const calculationTypeSelect = document.getElementById('calculation-type');
            const condemnationContainer = document.getElementById('condemnation-container');
            const agreementContainer = document.getElementById('agreement-container');
            const condemnationOptions = document.getElementById('condemnation-options');
            const agreementPetitionOption = document.getElementById('agreement-petition-option');
            const intimationRequestContainer = document.getElementById('intimation-request-container');
            const includeIntimationCheckbox = document.getElementById('include-intimation-checkbox');
            const intimationDeadlineWrapper = document.getElementById('intimation-deadline-wrapper');
            const agreementLastDifferentCheck = document.getElementById('agreement-last-different-check');
            const agreementLastValueContainer = document.getElementById('agreement-last-value-container');
            const agreementPenaltySelect = document.getElementById('agreement-penalty');

            // --- DADOS ECONÔMICOS ---
            let tabelaTJSP = {

                // 2003
                '2003-01': 28.131595, '2003-02': 28.826445, '2003-03': 29.247311, '2003-04': 29.647999,
                '2003-05': 30.057141, '2003-06': 30.354706, '2003-07': 30.336493, '2003-08': 30.348627,
                '2003-09': 30.403254, '2003-10': 30.652560, '2003-11': 30.772104, '2003-12': 30.885960,

                // 2004
                '2004-01': 31.052744, '2004-02': 31.310481, '2004-03': 31.432591, '2004-04': 31.611756,
                '2004-05': 31.741364, '2004-06': 31.868329, '2004-07': 32.027670, '2004-08': 32.261471,
                '2004-09': 32.422778, '2004-10': 32.477896, '2004-11': 32.533108, '2004-12': 32.676253,

                // 2005
                '2005-01': 32.957268, '2005-02': 33.145124, '2005-03': 33.290962, '2005-04': 33.533986,
                '2005-05': 33.839145, '2005-06': 34.076019, '2005-07': 34.038535, '2005-08': 34.048746,
                '2005-09': 34.048746, '2005-10': 34.099819, '2005-11': 34.297597, '2005-12': 34.482804,

                // 2006
                '2006-01': 34.620735, '2006-02': 34.752293, '2006-03': 34.832223, '2006-04': 34.926270,
                '2006-05': 34.968181, '2006-06': 35.013639, '2006-07': 34.989129, '2006-08': 35.027617,
                '2006-09': 35.020611, '2006-10': 35.076643, '2006-11': 35.227472, '2006-12': 35.375427,

                // 2007
                '2007-01': 35.594754, '2007-02': 35.769168, '2007-03': 35.919398, '2007-04': 36.077443,
                '2007-05': 36.171244, '2007-06': 36.265289, '2007-07': 36.377711, '2007-08': 36.494119,
                '2007-09': 36.709434, '2007-10': 36.801207, '2007-11': 36.911610, '2007-12': 37.070329,

                // 2008
                '2008-01': 37.429911, '2008-02': 37.688177, '2008-03': 37.869080, '2008-04': 38.062212,
                '2008-05': 38.305810, '2008-06': 38.673545, '2008-07': 39.025474, '2008-08': 39.251821,
                '2008-09': 39.334249, '2008-10': 39.393250, '2008-11': 39.590216, '2008-12': 39.740658,

                // 2009
                '2009-01': 39.855905, '2009-02': 40.110982, '2009-03': 40.235326, '2009-04': 40.315796,
                '2009-05': 40.537532, '2009-06': 40.780757, '2009-07': 40.952036, '2009-08': 41.046225,
                '2009-09': 41.079061, '2009-10': 41.144787, '2009-11': 41.243534, '2009-12': 41.396135,

                // 2010
                '2010-01': 41.495485, '2010-02': 41.860645, '2010-03': 42.153669, '2010-04': 42.452960,
                '2010-05': 42.762866, '2010-06': 42.946746, '2010-07': 42.899504, '2010-08': 42.869474,
                '2010-09': 42.839465, '2010-10': 43.070798, '2010-11': 43.467049, '2010-12': 43.914759,

                // 2011
                '2011-01': 44.178247, '2011-02': 44.593522, '2011-03': 44.834327, '2011-04': 45.130233,
                '2011-05': 45.455170, '2011-06': 45.714264, '2011-07': 45.814835, '2011-08': 45.814835,
                '2011-09': 46.007257, '2011-10': 46.214289, '2011-11': 46.362174, '2011-12': 46.626438,

                // 2012
                '2012-01': 46.864232, '2012-02': 47.103239, '2012-03': 47.286941, '2012-04': 47.372057,
                '2012-05': 47.675238, '2012-06': 47.937451, '2012-07': 48.062088, '2012-08': 48.268754,
                '2012-09': 48.485963, '2012-10': 48.791424, '2012-11': 49.137843, '2012-12': 49.403187,

                // 2013
                '2013-01': 49.768770, '2013-02': 50.226642, '2013-03': 50.487820, '2013-04': 50.790746,
                '2013-05': 51.090411, '2013-06': 51.269227, '2013-07': 51.412780, '2013-08': 51.345943,
                '2013-09': 51.428096, '2013-10': 51.566951, '2013-11': 51.881509, '2013-12': 52.161669,

                // 2014
                '2014-01': 52.537233, '2014-02': 52.868217, '2014-03': 53.206573, '2014-04': 53.642866,
                '2014-05': 54.061280, '2014-06': 54.385647, '2014-07': 54.527049, '2014-08': 54.597934,
                '2014-09': 54.696210, '2014-10': 54.964221, '2014-11': 55.173085, '2014-12': 55.465502,

                // 2015
                '2015-01': 55.809388, '2015-02': 56.635366, '2015-03': 57.292336, '2015-04': 58.157450,
                '2015-05': 58.570367, '2015-06': 59.150213, '2015-07': 59.605669, '2015-08': 59.951381,
                '2015-09': 60.101259, '2015-10': 60.407775, '2015-11': 60.872914, '2015-12': 61.548603,

                // 2016
                '2016-01': 62.102540, '2016-02': 63.040288, '2016-03': 63.639170, '2016-04': 63.919182,
                '2016-05': 64.328264, '2016-06': 64.958680, '2016-07': 65.263985, '2016-08': 65.681674,
                '2016-09': 65.885287, '2016-10': 65.937995, '2016-11': 66.050089, '2016-12': 66.096324,

                // 2017
                '2017-01': 66.188858, '2017-02': 66.466851, '2017-03': 66.626371, '2017-04': 66.839575,
                '2017-05': 66.893046, '2017-06': 67.133860, '2017-07': 66.932458, '2017-08': 67.046243,
                '2017-09': 67.026129, '2017-10': 67.012723, '2017-11': 67.260670, '2017-12': 67.381739,

                // 2018
                '2018-01': 67.556931, '2018-02': 67.712311, '2018-03': 67.834193, '2018-04': 67.881676,
                '2018-05': 68.024227, '2018-06': 68.316731, '2018-07': 69.293660, '2018-08': 69.466894,
                '2018-09': 69.466894, '2018-10': 69.675294, '2018-11': 69.953995, '2018-12': 69.779110,

                // 2019
                '2019-01': 69.876800, '2019-02': 70.128356, '2019-03': 70.507049, '2019-04': 71.049953,
                '2019-05': 71.476252, '2019-06': 71.583466, '2019-07': 71.590624, '2019-08': 71.662214,
                '2019-09': 71.748208, '2019-10': 71.712333, '2019-11': 71.741017, '2019-12': 72.128418,

                // 2020
                '2020-01': 73.008384, '2020-02': 73.147099, '2020-03': 73.271449, '2020-04': 73.403337,
                '2020-05': 73.234509, '2020-06': 73.051422, '2020-07': 73.270576, '2020-08': 73.592966,
                '2020-09': 73.857900, '2020-10': 74.500463, '2020-11': 75.163517, '2020-12': 75.877570,

                // 2021
                '2021-01': 76.985382, '2021-02': 77.193242, '2021-03': 77.826226, '2021-04': 78.495531,
                '2021-05': 78.793814, '2021-06': 79.550234, '2021-07': 80.027535, '2021-08': 80.843815,
                '2021-09': 81.555240, '2021-10': 82.533902, '2021-11': 83.491295, '2021-12': 84.192621,

                // 2022
                '2022-01': 84.807227, '2022-02': 85.375435, '2022-03': 86.229189, '2022-04': 87.703708,
                '2022-05': 88.615826, '2022-06': 89.014597, '2022-07': 89.566487, '2022-08': 89.029088,
                '2022-09': 88.753097, '2022-10': 88.469087, '2022-11': 88.884891, '2022-12': 89.222653,

                // 2023
                '2023-01': 89.838289, '2023-02': 90.251545, '2023-03': 90.946481, '2023-04': 91.528538,
                '2023-05': 92.013639, '2023-06': 92.344888, '2023-07': 92.252543, '2023-08': 92.169515,
                '2023-09': 92.353854, '2023-10': 92.455443, '2023-11': 92.566389, '2023-12': 92.658955,

                // 2024
                '2024-01': 93.168579, '2024-02': 93.699639, '2024-03': 94.458606, '2024-04': 94.638077,
                '2024-05': 94.988237, '2024-06': 95.425182, '2024-07': 95.663744, '2024-08': 95.912469,
                '2024-09': 96.094702, '2024-10': 96.219625, '2024-11': 96.739210, '2024-12': 97.338993,

                // 2025
                '2025-01': 97.669945, '2025-02': 97.777381, '2025-03': 98.980042, '2025-04': 99.613514,
                '2025-05': 100.041852, '2025-06': 100.402002, '2025-07': 100.663047, '2025-08': 100.995235,
                '2025-09': 100.853841, '2025-10': 101.337939, '2025-11': 101.520347
            };

            const truncarSeisCasas = (valor) => Math.floor(valor * 1_000_000) / 1_000_000;

            const processarIPCA15 = (dados) => {
                dados.forEach(item => {
                    const [d, m, y] = item.data.split('/');
                    let mesTabela = parseInt(m, 10) + 1;
                    let anoTabela = parseInt(y, 10);
                    if (mesTabela > 12) { mesTabela = 1; anoTabela++; }
                    const chave = `${anoTabela}-${String(mesTabela).padStart(2, '0')}`;
                    if (!tabelaTJSP[chave]) {
                        let mA = mesTabela - 1; let aA = anoTabela;
                        if (mA === 0) { mA = 12; aA--; }
                        const chaveAnt = `${aA}-${String(mA).padStart(2, '0')}`;
                        if (tabelaTJSP[chaveAnt]) {
                            const fatorCalculado = tabelaTJSP[chaveAnt] * (1 + (parseFloat(item.valor) / 100));
                            tabelaTJSP[chave] = truncarSeisCasas(fatorCalculado);
                        }
                    }
                });
            };

            const recomputarIpcaDeTabela = () => {
                const chaves = Object.keys(tabelaTJSP).sort();
                const calculado = {};
                for (let i = 1; i < chaves.length; i++) {
                    const atual = tabelaTJSP[chaves[i]];
                    const anterior = tabelaTJSP[chaves[i - 1]];
                    calculado[chaves[i]] = ((atual / anterior) - 1) * 100;
                }
                ipcaData = { ...calculado };
                ipca15Data = { ...calculado };
            };

            const chavePorData = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

            const fatorPorData = (date) => {
                const chave = chavePorData(date);
                if (tabelaTJSP[chave]) return tabelaTJSP[chave];
                const chaves = Object.keys(tabelaTJSP).sort();
                let chaveAnterior = chaves[0];
                for (const c of chaves) {
                    if (c <= chave) {
                        chaveAnterior = c;
                    } else {
                        break;
                    }
                }
                return tabelaTJSP[chaveAnterior];
            };

            let ipcaData = {};
            let ipca15Data = {};
            let monthlySelicData = {};
            let lastCalculationData = null;

            // --- FUNÇÕES DE SETUP E UI ---

            const populateAgreementPenaltyOptions = () => {
                let optionsHTML = '<option value="0">Sem multa</option>';
                for (let i = 5; i <= 100; i += 5) {
                    optionsHTML += `<option value="${i}">${i}%</option>`;
                }
                agreementPenaltySelect.innerHTML = optionsHTML;
                agreementPenaltySelect.value = "20"; // Valor padrão mantido
            };

            const fetchEconomicData = async () => {
                const ipca15Url = './data/ipca15.json';
                const selicUrl = './data/selic.json';

                try {
                    const [ipca15Response, selicResponse] = await Promise.all([fetch(ipca15Url), fetch(selicUrl)]);
                    if (!ipca15Response.ok || !selicResponse.ok) throw new Error('Falha ao baixar arquivos de índices.');

                    const [ipca15Json, selicJson] = await Promise.all([ipca15Response.json(), selicResponse.json()]);

                    if (!Array.isArray(ipca15Json) || ipca15Json.length === 0) throw new Error('IPCA-15 vazio ou inválido.');
                    if (!Array.isArray(selicJson) || selicJson.length === 0) throw new Error('SELIC vazia ou inválida.');

                    processarIPCA15(ipca15Json);
                    recomputarIpcaDeTabela();
                    monthlySelicData = selicJson.reduce((acc, item) => {
                        if (!item.data || !item.valor) return acc;
                        const [day, month, year] = item.data.split('/');
                        acc[`${year}-${month}`] = parseFloat(item.valor);
                        return acc;
                    }, {});

                    calculateBtn.disabled = false;
                    calculateBtn.innerHTML = 'Calcular Valor Atualizado';
                    calculateBtn.className = calculateBtn.className.replace('bg-indigo-400 cursor-not-allowed', 'bg-indigo-600 hover:bg-indigo-700');
                } catch (error) {
                    console.error('Erro ao buscar dados econômicos:', error);
                    calculateBtn.innerHTML = 'Erro ao carregar dados';
                    calculateBtn.className = calculateBtn.className.replace('bg-indigo-400', 'bg-red-600');
                    alert('Não foi possível carregar os índices econômicos. Por favor, tente recarregar a página.');
                }
            };

            const toggleCalculationView = () => {
                const type = calculationTypeSelect.value;
                if (type === 'condemnation') {
                    condemnationContainer.classList.remove('hidden');
                    agreementContainer.classList.add('hidden');
                    condemnationOptions.classList.remove('hidden');
                    agreementPetitionOption.classList.add('hidden');
                    intimationRequestContainer.classList.add('hidden');
                    petitionOptionsContainer.classList.toggle('hidden', !complianceRequestCheckbox.checked);
                } else { // agreement
                    condemnationContainer.classList.add('hidden');
                    agreementContainer.classList.remove('hidden');
                    condemnationOptions.classList.add('hidden');
                    agreementPetitionOption.classList.remove('hidden');
                    intimationRequestContainer.classList.remove('hidden');
                    petitionOptionsContainer.classList.remove('hidden'); // Petição é obrigatória aqui
                }
                resultsContainer.classList.add('hidden');
            };

            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const addRow = () => {
                const newRow = rowsContainer.querySelector('.calculation-row').cloneNode(true);
                newRow.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
                const select = newRow.querySelector('.description-select');
                select.selectedIndex = 0;
                newRow.querySelector('.other-description-input').classList.add('hidden');

                // Resetar estado visual da linha e rótulo
                const interestDateInput = newRow.querySelector('.interest-date-input');
                const correctionDateInput = newRow.querySelector('.correction-date-input');
                const valueInput = newRow.querySelector('.value-input');
                const valueLabel = newRow.querySelectorAll('label')[1];

                valueLabel.textContent = 'Valor (R$)';
                interestDateInput.disabled = false;
                interestDateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                interestDateInput.placeholder = 'DD/MM/AAAA';

                correctionDateInput.disabled = false;
                correctionDateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                correctionDateInput.placeholder = 'DD/MM/AAAA';

                valueInput.placeholder = '1.000,00';

                rowsContainer.appendChild(newRow);
                addInputBehaviors(newRow);
            };

            const removeRow = (e) => {
                if (e.target.classList.contains('remove-row-btn')) {
                    if (rowsContainer.children.length > 1) {
                        e.target.closest('.calculation-row').remove();
                    } else {
                        alert('Pelo menos uma linha de cálculo é necessária.');
                    }
                }
            };

            const formatCNJOnInput = (e) => {
                let v = e.target.value.replace(/\D/g, "");
                v = v.replace(/(\d{7})(\d)/, "$1-$2").replace(/(\d{7}-\d{2})(\d)/, "$1.$2")
                    .replace(/(\d{7}-\d{2}\.\d{4})(\d)/, "$1.$2").replace(/(\d{7}-\d{2}\.\d{4}\.\d{1})(\d)/, "$1.$2")
                    .replace(/(\d{7}-\d{2}\.\d{4}\.\d{1}\.\d{2})(\d)/, "$1.$2");
                e.target.value = v;
            };

            const formatDateOnInput = (e) => {
                let v = e.target.value.replace(/\D/g, "").slice(0, 8);
                v = v.replace(/(\d{2})(\d)/, "$1/$2").replace(/(\d{2})\/(\d{2})(\d)/, "$1/$2/$3");
                e.target.value = v;
            };

            const autocompleteDateOnBlur = (e) => {
                let value = e.target.value;
                if (!value) return;
                const parts = value.split('/');
                if (parts.length === 3 && parts[2].length === 4) return;
                const today = new Date();
                const day = parts[0] || '';
                let month = parts[1] || '';
                let year = parts[2] || '';
                if (day && !month) {
                    month = String(today.getMonth() + 1).padStart(2, '0');
                    year = today.getFullYear();
                } else if (day && month && !year) {
                    year = today.getFullYear();
                }
                if (year.length > 0 && year.length < 4) {
                    year = parseInt(year, 10) < 50 ? '20' + year.padStart(2, '0') : '19' + year.padStart(2, '0');
                }
                e.target.value = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
            };

            const formatValueOnBlur = (e) => {
                const input = e.target;
                let value = input.value;
                if (!value) return;

                value = value.replace(/[^\d,]/g, '').replace(',', '.');

                const number = parseFloat(value);

                if (!isNaN(number)) {
                    input.value = number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                } else {
                    input.value = '';
                }
            };

            const addInputBehaviors = (container) => {
                container.querySelectorAll('.date-input').forEach(input => {
                    input.removeEventListener('input', formatDateOnInput);
                    input.removeEventListener('blur', autocompleteDateOnBlur);
                    input.addEventListener('input', formatDateOnInput);
                    input.addEventListener('blur', autocompleteDateOnBlur);
                });
                container.querySelectorAll('.value-input').forEach(input => {
                    input.removeEventListener('blur', formatValueOnBlur);
                    input.addEventListener('blur', formatValueOnBlur);
                });
            };

            // --- LÓGICA DE CÁLCULO ---

            const parseDate = (dateStr) => {
                if (!dateStr || dateStr.length < 10) return null;
                const [day, month, year] = dateStr.split('/');
                return new Date(`${year}-${month}-${day}T12:00:00Z`);
            };

            const getFinalCalcDate = () => {
                const finalDateStr = document.getElementById('final-date').value;
                const parsedFinalDate = parseDate(finalDateStr);
                return parsedFinalDate instanceof Date && !isNaN(parsedFinalDate) ? parsedFinalDate : new Date();
            };

            const performCondemnationCalculation = () => {
                const finalCalcDate = getFinalCalcDate();
                const calculationResult = {
                    type: 'condemnation',
                    processNumber: processNumberInput.value || 'Não informado',
                    rows: [],
                    summary: {},
                    finalCalcDate: finalCalcDate
                };

                let positiveRows = [];
                let deductionRows = [];
                let percentageFineRows = [];

                // Primeira passada: Calcular linhas padrão e deduções
                document.querySelectorAll('.calculation-row').forEach(row => {
                    const descriptionSelect = row.querySelector('.description-select');
                    let description = descriptionSelect.value;
                    const rawValue = row.querySelector('.value-input').value;
                    const originalValue = parseFloat(rawValue.replace(/\./g, '').replace(',', '.')) || 0;

                    if (description === 'Multa (%)') {
                        // Guardar para segunda passada
                        if (originalValue > 0) {
                            percentageFineRows.push({ description: `Multa (${originalValue}%)`, percentage: originalValue });
                        }
                        return;
                    }

                    if (description === 'Outro') {
                        description = row.querySelector('.other-description-input').value.trim() || 'Outro (não especificado)';
                    }

                    const correctionDate = parseDate(row.querySelector('.correction-date-input').value);
                    const interestDate = parseDate(row.querySelector('.interest-date-input').value);

                    if (originalValue === 0 || !correctionDate) return;

                    const fatorInicio = fatorPorData(correctionDate);
                    const fatorFim = fatorPorData(finalCalcDate);
                    const correctedValue = originalValue * (fatorFim / fatorInicio);
                    const totalCorrection = correctedValue - originalValue;

                    let totalInterest = 0;
                    if (descriptionSelect.value !== 'Dedução/Pagamento Parcial' && interestDate) {
                        let baseForInterest = originalValue * (fatorPorData(interestDate) / fatorInicio);

                        for (let d = new Date(interestDate); d < finalCalcDate; d.setMonth(d.getMonth() + 1)) {
                            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            let monthlyRate = (monthlySelicData[key] || 0) - (ipca15Data[key] || 0);
                            monthlyRate = Math.max(0, monthlyRate) / 100;
                            if (d.getFullYear() === finalCalcDate.getFullYear() && d.getMonth() === finalCalcDate.getMonth()) {
                                monthlyRate *= finalCalcDate.getDate() / new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                            }
                            totalInterest += baseForInterest * monthlyRate;
                        }
                    }

                    const finalValueForRow = originalValue + totalCorrection + totalInterest;
                    const rowData = {
                        description,
                        originalValue,
                        totalCorrection,
                        totalInterest,
                        finalValueForRow,
                        indiceInicial: fatorInicio,
                        indiceFinal: fatorFim
                    };

                    if (descriptionSelect.value === 'Dedução/Pagamento Parcial') {
                        deductionRows.push(rowData);
                    } else {
                        positiveRows.push(rowData);
                    }
                });

                // Calcular Subtotal Atual
                const currentPosSubtotal = positiveRows.reduce((acc, row) => acc + row.finalValueForRow, 0);
                const currentDedTotal = deductionRows.reduce((acc, row) => acc + row.finalValueForRow, 0);
                const baseForFines = currentPosSubtotal - currentDedTotal;

                // Segunda passada: Calcular Multas Porcentuais
                percentageFineRows.forEach(fine => {
                    const fineAmount = baseForFines * (fine.percentage / 100);
                    // Adiciona como uma linha positiva, mas sem correção/juros explícitos (já inclusos no cálculo da base)
                    // Marcamos explicitamente com originalValue = 0 para identificar na renderização
                    const rowData = {
                        description: fine.description,
                        originalValue: 0,
                        totalCorrection: 0,
                        totalInterest: 0,
                        finalValueForRow: fineAmount
                    };
                    positiveRows.push(rowData);
                });

                calculationResult.rows = [...positiveRows, ...deductionRows];

                const finalPositiveSubtotal = positiveRows.reduce((acc, row) => acc + row.finalValueForRow, 0);
                // Total Deductions já calculado

                const subtotal = finalPositiveSubtotal - currentDedTotal;
                const addFine = addFineCheckbox.checked;
                const fineValue = addFine ? subtotal * 0.10 : 0;
                const grandTotal = subtotal + fineValue;

                calculationResult.summary = {
                    subtotal,
                    addFine,
                    fineValue,
                    grandTotal,
                    totalDeductions: currentDedTotal,
                    positiveSubtotal: finalPositiveSubtotal
                };

                return (calculationResult.rows.length === 0) ? null : calculationResult;
            };

            const performAgreementCalculation = () => {
                const totalInstallments = parseInt(document.getElementById('agreement-total-installments').value) || 0;
                const paidInstallments = parseInt(document.getElementById('agreement-paid-installments').value) || 0;

                // Lógica de valores de parcela
                const rawInstallmentValue = document.getElementById('agreement-installment-value').value;
                const standardInstallmentValue = parseFloat(rawInstallmentValue.replace(/\./g, '').replace(',', '.')) || 0;

                // Lógica da última parcela diferente
                const hasDifferentLastInstallment = document.getElementById('agreement-last-different-check').checked;
                const rawLastInstallmentValue = document.getElementById('agreement-last-installment-value').value;
                let lastInstallmentValue = 0;

                if (hasDifferentLastInstallment) {
                    lastInstallmentValue = parseFloat(rawLastInstallmentValue.replace(/\./g, '').replace(',', '.')) || 0;
                }

                const startDate = parseDate(document.getElementById('agreement-start-date').value);
                const penaltyPercent = parseFloat(document.getElementById('agreement-penalty').value) || 0;
                const penaltyBaseType = document.querySelector('input[name="penalty-base"]:checked').value;


                if (totalInstallments <= 0 || standardInstallmentValue <= 0 || !startDate) {
                    alert('Preencha todos os campos do acordo: parcelas totais, valor da parcela e data de início.');
                    return null;
                }

                const finalCalcDate = getFinalCalcDate();
                const installmentsDetails = [];

                const updateValue = (value, dateFrom, dateTo) => {
                    const fatorInicio = fatorPorData(dateFrom);
                    const fatorFim = fatorPorData(dateTo);
                    return { valor: value * (fatorFim / fatorInicio), fatorInicio, fatorFim };
                };

                let totalOriginalDebt = 0;

                for (let i = 0; i < totalInstallments; i++) {
                    const installmentDate = new Date(startDate);
                    installmentDate.setMonth(startDate.getMonth() + i);

                    // Determina o valor da parcela atual
                    let currentInstallmentValue = standardInstallmentValue;

                    // Se for a última parcela e a checkbox estiver marcada, usa o valor diferenciado
                    if (hasDifferentLastInstallment && i === (totalInstallments - 1)) {
                        currentInstallmentValue = lastInstallmentValue;
                    }

                    totalOriginalDebt += currentInstallmentValue;

                    const atualizado = updateValue(currentInstallmentValue, installmentDate, finalCalcDate);

                    installmentsDetails.push({
                        number: i + 1,
                        originalDate: installmentDate,
                        originalValue: currentInstallmentValue,
                        updatedValue: atualizado.valor,
                        indiceInicial: atualizado.fatorInicio,
                        indiceFinal: atualizado.fatorFim,
                        status: i < paidInstallments ? 'Paga' : 'Não Paga'
                    });
                }

                const totalUpdatedValue = installmentsDetails.reduce((sum, inst) => sum + inst.updatedValue, 0);
                const paidUpdatedValue = installmentsDetails.filter(inst => inst.status === 'Paga').reduce((sum, inst) => sum + inst.updatedValue, 0);
                const paidOriginalValue = installmentsDetails.filter(inst => inst.status === 'Paga').reduce((sum, inst) => sum + inst.originalValue, 0);

                const updatedDebt = totalUpdatedValue - paidUpdatedValue;

                let penaltyBaseValue = 0;
                if (penaltyBaseType === 'remaining') {
                    penaltyBaseValue = updatedDebt;
                } else { // 'total'
                    penaltyBaseValue = totalOriginalDebt;
                }
                const penaltyValue = penaltyBaseValue * (penaltyPercent / 100);

                const rawDeductionValue = document.getElementById('agreement-deduction-value').value;
                const deductionValue = parseFloat(rawDeductionValue.replace(/\./g, '').replace(',', '.')) || 0;
                const deductionDate = parseDate(document.getElementById('agreement-deduction-date').value);
                let updatedDeductionValue = 0;
                if (deductionValue > 0 && deductionDate) {
                    const dedAtualizado = updateValue(deductionValue, deductionDate, finalCalcDate);
                    updatedDeductionValue = dedAtualizado.valor;
                }

                const grandTotal = updatedDebt + penaltyValue - updatedDeductionValue;

                return {
                    type: 'agreement',
                    processNumber: processNumberInput.value || 'Não informado',
                    finalCalcDate: finalCalcDate,
                    installments: installmentsDetails,
                    summary: {
                        totalOriginal: totalOriginalDebt,
                        paidOriginal: paidOriginalValue,
                        remainingOriginal: totalOriginalDebt - paidOriginalValue,
                        totalUpdated: totalUpdatedValue,
                        paidUpdated: paidUpdatedValue,
                        updatedDebt: updatedDebt,
                        penaltyValue: penaltyValue,
                        grandTotal: grandTotal,
                        penaltyPercent: penaltyPercent,
                        paidInstallments: paidInstallments,
                        penaltyBaseType: penaltyBaseType,
                        penaltyBaseValue: penaltyBaseValue,
                        updatedDeductionValue: updatedDeductionValue,
                        deductionValue: deductionValue
                    }
                };
            };

            const handleCalculateClick = () => {
                const type = calculationTypeSelect.value;
                let data = null;
                if (type === 'condemnation') {
                    data = performCondemnationCalculation();
                } else { // agreement
                    data = performAgreementCalculation();
                }

                if (data) {
                    lastCalculationData = data;
                    displayResults(data);
                }
            };

            // --- FUNÇÕES DE EXIBIÇÃO ---

            const displayResults = (data) => {
                let resultsHTML = '';
                if (data.type === 'condemnation') {
                    resultsHTML = getCondemnationResultsHTML(data);
                } else {
                    resultsHTML = getAgreementResultsHTML(data);
                }

                resultsContainer.innerHTML = resultsHTML;
                resultsContainer.classList.remove('hidden');

                const hasResults = data.summary.grandTotal > 0;

                const styleButton = (btn, enabled, colorClass = 'bg-green-600 hover:bg-green-700') => {
                    btn.disabled = !enabled;
                    if (enabled) {
                        btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        btn.classList.add(...colorClass.split(' '));
                    } else {
                        btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        btn.classList.remove(...colorClass.split(' '));
                    }
                };

                styleButton(previewBtn, hasResults, 'bg-blue-600 hover:bg-blue-700');

                const isPetitionIncluded = (data.type === 'condemnation' && complianceRequestCheckbox.checked) || data.type === 'agreement';

                printBtn.classList.add('hidden');
                printCombinedBtn.classList.add('hidden');
                printPetitionBtn.classList.add('hidden');
                printCalcBtn.classList.add('hidden');

                if (isPetitionIncluded) {
                    printCombinedBtn.classList.remove('hidden');
                    printPetitionBtn.classList.remove('hidden');
                    printCalcBtn.classList.remove('hidden');
                    styleButton(printCombinedBtn, hasResults);
                    styleButton(printPetitionBtn, hasResults);
                    styleButton(printCalcBtn, hasResults);
                } else {
                    printBtn.classList.remove('hidden');
                    styleButton(printBtn, hasResults);
                }
            };


            const getCondemnationResultsHTML = (data) => {
                let html = '<h3 class="text-xl font-bold text-gray-800 mb-4">Resumo do Cálculo de Condenação</h3><div class="space-y-6">';
                data.rows.forEach((row, index) => {
                    const isDeduction = data.summary.totalDeductions > 0 && row.description.includes('Dedução');

                    // Renderização especial para "Multa (%)"
                    if (row.description.startsWith('Multa (') && row.originalValue === 0) {
                        html += `<div class="p-4 border rounded-lg bg-white border-l-4 border-yellow-500">
                            <p class="font-semibold text-lg text-gray-800">${index + 1}. ${row.description}</p>
                            <div class="mt-2 text-right">
                                <span class="font-medium text-gray-600 mr-2">Valor da Multa:</span>
                                <span class="text-xl font-bold text-gray-800">${formatCurrency(row.finalValueForRow)}</span>
                            </div>
                        </div>`;
                    } else {
                        const indicesHtml = (row.indiceInicial && row.indiceFinal)
                            ? `<div class="text-xs text-gray-500 mt-2">Índice inicial: ${row.indiceInicial.toFixed(6)} | Índice final: ${row.indiceFinal.toFixed(6)}</div>`
                            : '';

                        html += `<div class="p-4 border rounded-lg bg-white"><p class="font-semibold text-lg ${isDeduction ? 'text-red-600' : 'text-indigo-700'}">${index + 1}. ${row.description}</p><div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 mt-2 text-sm"><div><span class="font-medium text-gray-600">Valor Original:</span><br>${formatCurrency(row.originalValue)}</div><div><span class="font-medium text-gray-600">Correção (Tabela TJSP):</span><br>${formatCurrency(row.totalCorrection)}</div><div><span class="font-medium text-gray-600">Juros de Mora:</span><br>${formatCurrency(row.totalInterest)}</div><div class="font-bold"><span class="font-medium text-gray-600">Subtotal:</span><br>${formatCurrency(row.finalValueForRow)}</div></div>${indicesHtml}</div>`;
                    }
                });
                html += `</div>`;

                const fineRowHtml = data.summary.addFine ? `<div class="flex justify-between items-center mt-2"><p class="text-lg font-semibold text-gray-700">Multa do art. 523 (10%):</p><p class="text-xl font-semibold text-red-600">${formatCurrency(data.summary.fineValue)}</p></div>` : '';
                const deductionRowHtml = data.summary.totalDeductions > 0 ? `<div class="flex justify-between items-center"><p class="text-lg text-gray-600">(-) Total Deduzido:</p><p class="text-xl font-bold text-green-600">${formatCurrency(data.summary.totalDeductions)}</p></div>` : '';

                html += `<div class="mt-8 pt-4 border-t-2 border-indigo-500 text-right space-y-2">
                    <div class="flex justify-between items-center"><p class="text-lg text-gray-600">Subtotal da Condenação:</p><p class="text-2xl font-bold text-indigo-700">${formatCurrency(data.summary.positiveSubtotal)}</p></div>
                    ${deductionRowHtml}
                    ${fineRowHtml}
                    <div class="flex justify-between items-center pt-4 border-t mt-2"><p class="text-lg font-bold text-gray-800">Valor Total do Débito:</p><p class="text-3xl font-bold text-indigo-700">${formatCurrency(data.summary.grandTotal)}</p></div>
                </div>`;
                return html;
            }

            const getAgreementResultsHTML = (data) => {
                const s = data.summary;
                const installments = data.installments;
                let penaltyHelperText = '';
                if (s.penaltyBaseType === 'remaining') {
                    penaltyHelperText = `(Multa sobre o saldo devedor atualizado de ${formatCurrency(s.penaltyBaseValue)})`;
                } else { // 'total'
                    penaltyHelperText = `(Multa sobre o valor original do acordo de ${formatCurrency(s.penaltyBaseValue)})`;
                }

                const createTableHTML = (title, items, colorClass, headColorClass) => {
                    if (items.length === 0) return '';
                    let tableHTML = `<h4 class="text-lg font-semibold text-gray-700 mt-4">${title}</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="${headColorClass} text-white">
                                <tr>
                                    <td class="py-2 px-4 border-b text-right">${formatCurrency(item.updatedValue)}
                                        <div class="text-xs text-gray-500 mt-1">Índice inicial: ${item.indiceInicial ? item.indiceInicial.toFixed(6) : '-'} | Índice final: ${item.indiceFinal ? item.indiceFinal.toFixed(6) : '-'}</div>
                                    </td>
                                    <th class="py-2 px-4 border-b text-left font-semibold">Vencimento</th>
                                    <th class="py-2 px-4 border-b text-right font-semibold">Valor Original</th>
                                    <th class="py-2 px-4 border-b text-right font-semibold">Valor Atualizado</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    items.forEach(item => {
                        tableHTML += `<tr>
                            <td class="py-2 px-4 border-b">${item.number}</td>
                            <td class="py-2 px-4 border-b">${item.originalDate.toLocaleDateString('pt-BR')}</td>
                            <td class="py-2 px-4 border-b text-right">${formatCurrency(item.originalValue)}</td>
                            <td class="py-2 px-4 border-b text-right ${colorClass}">${formatCurrency(item.updatedValue)}
                                <div class="text-xs text-gray-500 mt-1">Índice inicial: ${item.indiceInicial ? item.indiceInicial.toFixed(6) : '-'} | Índice final: ${item.indiceFinal ? item.indiceFinal.toFixed(6) : '-'}</div>
                            </td>
                        </tr>`;
                    });
                    tableHTML += `</tbody></table></div>`;
                    return tableHTML;
                };

                const deductionRowHtml = s.updatedDeductionValue > 0 ? `<div class="flex justify-between p-2 rounded-lg"><span class="font-medium text-gray-600">(-) Dedução Adicional (Atualizada):</span><span class="text-green-600">${formatCurrency(s.updatedDeductionValue)}</span></div>` : '';


                const paidInstallments = installments.filter(i => i.status === 'Paga');
                const unpaidInstallments = installments.filter(i => i.status !== 'Paga');

                return `
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Resumo do Descumprimento de Acordo</h3>
                    
                    ${createTableHTML('Detalhamento das Parcelas Pagas', paidInstallments, 'text-green-600', 'bg-green-700')}
                    ${createTableHTML('Detalhamento das Parcelas Vencidas e Não Pagas', unpaidInstallments, 'text-red-600', 'bg-red-700')}

                    <div class="mt-8 pt-4 border-t-2 border-gray-300 space-y-4 text-base">
                        <div class="p-2 rounded-lg bg-gray-50">
                            <div class="flex justify-between">
                                <span class="font-medium text-gray-600">Valor Total do Acordo (Atualizado):</span>
                                <span>${formatCurrency(s.totalUpdated)}</span>
                            </div>
                        </div>

                        <div class="p-2 rounded-lg">
                            <div class="flex justify-between">
                                <span class="font-medium text-gray-600">(-) Valor Pago (${s.paidInstallments} parcelas) (Atualizado):</span>
                                <span class="text-green-600">${formatCurrency(s.paidUpdated)}</span>
                            </div>
                        </div>

                        <hr class="my-2"/>

                        <div class="flex justify-between p-2 rounded-lg">
                            <span class="font-medium text-gray-800">(=) Saldo Devedor (Atualizado):</span>
                            <span class="font-bold">${formatCurrency(s.updatedDebt)}</span>
                        </div>
                        
                        ${deductionRowHtml}

                        <div class="flex justify-between p-2 rounded-lg">
                            <span class="font-medium text-gray-600">(+) Multa por Descumprimento (${s.penaltyPercent}%):</span>
                            <span class="text-red-600">${formatCurrency(s.penaltyValue)}</span>
                        </div>
                        <div class="text-right text-sm text-gray-500 -mt-3">
                            <span>${penaltyHelperText}</span>
                        </div>


                        <div class="flex justify-between p-3 rounded-lg bg-indigo-100 mt-4 border-t-2 border-indigo-500">
                            <span class="text-lg font-bold text-gray-800">Valor Total do Débito:</span>
                            <span class="text-2xl font-bold text-indigo-700">${formatCurrency(s.grandTotal)}</span>
                        </div>
                    </div>
                `;
            }

            // --- GERAÇÃO DE PDF E PETIÇÃO ---

            const generatePetitionHTML = (data) => {
                const isPetitionIncluded = (data.type === 'condemnation' && complianceRequestCheckbox.checked) || data.type === 'agreement';
                if (!isPetitionIncluded) {
                    return null;
                }

                const exequenteInputs = exequentesList.querySelectorAll('.exequente-name-input');
                const allExequentes = Array.from(exequenteInputs).map(input => input.value.trim().toUpperCase()).filter(Boolean);

                if (allExequentes.length === 0) {
                    alert('Por favor, informe o nome de pelo menos um exequente para gerar a petição.');
                    exequenteInputs[0].focus();
                    return null;
                }

                let exequentesText = allExequentes.length === 1 ? `<strong>${allExequentes[0]}</strong>, já qualificado(a) nos autos`
                    : allExequentes.join(', ').replace(/,([^,]*)$/, ' e$1') + ', já qualificados nos autos';

                let mainParagraphs = '';
                if (data.type === 'condemnation') {
                    mainParagraphs = `
                        <p style="text-indent: 4em;">${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong> em face do(a)(s) executado(a)(s), também já qualificado(a)(s), tendo em vista o trânsito em julgado da r. sentença.</p>
                        <p style="text-indent: 4em;">Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo legal, efetue o pagamento devido, no importe de <strong>${formatCurrency(data.summary.subtotal)}</strong>, conforme cálculo anexo. Não ocorrendo o pagamento, requer que o débito seja acrescido da multa de 10%, prevista no art. 523, §1º do CPC, totalizando a quantia de <strong>${formatCurrency(data.summary.subtotal * 1.10)}</strong>.</p>
                    `;
                } else { // agreement
                    const agreementType = document.getElementById('agreement-type').value;
                    const actionText = agreementType === 'conhecimento' ? 'requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong>' : 'informar o descumprimento do acordo e requerer o <strong>PROSSEGUIMENTO DA EXECUÇÃO</strong>';
                    const multaText = data.summary.penaltyPercent > 0 ? 'já com o acréscimo da multa' : '';
                    let intimationText = '';
                    if (includeIntimationCheckbox.checked) {
                        const deadline = document.getElementById('intimation-deadline').value;
                        intimationText = `Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo de <strong>${deadline}</strong> dias, efetue o pagamento do valor remanescente, sob pena de reinício da execução e penhora de bens.`;
                    }

                    mainParagraphs = `
                        <p style="text-indent: 4em;">${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, informar o descumprimento do acordo homologado nos autos e, ato contínuo, ${actionText}.</p>
                        <p style="text-indent: 4em;">Conforme se demonstra pelo cálculo anexo, o débito atualizado remanescente, ${multaText}, perfaz o montante de <strong>${formatCurrency(data.summary.grandTotal)}</strong>. ${intimationText}</p>
                    `;
                }

                const requests = [];
                if (document.getElementById('penhora-contas').checked) requests.push('a pesquisa e bloqueio de valores em contas bancárias via SISBAJUD;');
                if (document.getElementById('penhora-veiculos').checked) requests.push('a pesquisa, bloqueio e penhora de veículos via RENAJUD;');
                if (document.getElementById('penhora-mandado').checked) requests.push('a expedição de mandado de penhora e avaliação de bens;');
                const outrosTextValue = penhoraOutrosText.value.trim();
                if (penhoraOutrosCheck.checked && outrosTextValue) requests.push(outrosTextValue);

                let penhoraRequestsHTML = '';
                if (requests.length > 0) {
                    let penhoraHeader = 'Caso não haja o pagamento voluntário, requer o prosseguimento da execução com as seguintes medidas:';
                    if (data.type === 'agreement' && !document.getElementById('include-intimation-checkbox').checked) {
                        penhoraHeader = 'Requer a realização das seguintes medidas para constrição e penhora:';
                    }
                    penhoraRequestsHTML = `
                        <p style="text-indent: 4em;">${penhoraHeader}</p>
                        <div style="padding-left: 80px; text-indent: 4.5em;">
                            ${requests.map((req, index) => `<p>${toRoman(index + 1)}. ${req}</p>`).join('')}
                        </div>
                    `;
                }

                const printDate = data.finalCalcDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                const signaturesHTML = allExequentes.map(name => `<div style="text-align: center; margin-top: 40px;"><p style="border-top: 1px solid black; width: 75%; margin: 0 auto; padding-top: 5px;">${name}</p></div>`).join('');

                return `
                    <div style="font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 2; text-align: justify;">
                        <p style="text-align: center; font-weight: bold;">EXCELENTÍSSIMO(A) SENHOR(A) DOUTOR(A) JUIZ(A) DE DIREITO DO JUIZADO ESPECIAL CÍVEL DA COMARCA DE MARÍLIA - SP</p>
                        <p style="margin-top: 2cm;"><strong>Processo nº: ${data.processNumber}</strong></p>
                        <div style="margin-top: 1cm;">
                            ${mainParagraphs}
                        </div>
                        ${penhoraRequestsHTML}
                        <p style="margin-top: 2cm;">Nestes termos, pede deferimento.</p>
                        <p style="margin-top: 2cm; text-align: right;">Marília, ${printDate}.</p>
                        <div style="margin-top: 4cm;">${signaturesHTML}</div>
                    </div>
                `;
            };

            const showPreview = () => {
                if (!lastCalculationData) {
                    alert('Calcule os valores primeiro.');
                    return;
                }
                let finalHTML = '';
                const petitionHTML = generatePetitionHTML(lastCalculationData);
                if (petitionHTML) {
                    finalHTML += `<h2 class="text-xl font-bold text-center mb-4">Página 1: Petição</h2><div class="p-8 border shadow-lg bg-white mx-auto" style="width: 210mm;">${petitionHTML}</div>`;
                }

                const calculationHTML = resultsContainer.innerHTML;
                finalHTML += `<h2 class="text-xl font-bold text-center mt-8 mb-4">Página 2: Demonstrativo de Cálculo</h2><div class="p-8 border shadow-lg bg-white mx-auto" style="width: 210mm;"><h2 class="text-2xl font-bold text-gray-800 text-center">Demonstrativo de Cálculo de Débito Judicial</h2><p class="text-center text-gray-600 mt-1">Cálculo realizado em: ${lastCalculationData.finalCalcDate.toLocaleDateString('pt-BR')}</p><p class="my-4"><strong>Processo nº:</strong> ${lastCalculationData.processNumber}</p><hr class="my-4"/>${calculationHTML}</div>`;

                previewContent.innerHTML = finalHTML;
                previewModal.classList.remove('hidden');
            };

            const prePrintValidation = () => {
                if (!lastCalculationData) {
                    alert('Por favor, calcule os valores antes de gerar o PDF.');
                    return false;
                }
                const isPetitionIncluded = (lastCalculationData.type === 'condemnation' && complianceRequestCheckbox.checked) || lastCalculationData.type === 'agreement';
                if (isPetitionIncluded) {
                    const exequenteInputs = exequentesList.querySelectorAll('.exequente-name-input');
                    const allExequentes = Array.from(exequenteInputs).map(input => input.value.trim()).filter(Boolean);
                    if (allExequentes.length === 0) {
                        alert('Por favor, informe o nome de pelo menos um exequente para gerar a petição.');
                        exequenteInputs[0].focus();
                        return false;
                    }
                    const penhoraChecks = [
                        document.getElementById('penhora-contas').checked,
                        document.getElementById('penhora-veiculos').checked,
                        document.getElementById('penhora-mandado').checked,
                        document.getElementById('penhora-outros-check').checked,
                    ];
                    if (!penhoraChecks.some(c => c)) {
                        alert('Selecione pelo menos um pedido de penhora ao incluir uma petição.');
                        return false;
                    }
                }
                return true;
            };

            const generateCalculationOnlyPDF = async () => {
                if (!prePrintValidation()) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                if (lastCalculationData.type === 'condemnation') {
                    generateCondemnationCalcPage(pdf, lastCalculationData);
                } else {
                    generateAgreementCalcPage(pdf, lastCalculationData);
                }
                pdf.save(`Calculo_${lastCalculationData.processNumber.replace(/\D/g, '')}.pdf`);
            };

            const generatePetitionOnlyPDF = async () => {
                if (!prePrintValidation()) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                addPetitionToPdf(pdf, lastCalculationData);
                pdf.save(`Peticao_${lastCalculationData.processNumber.replace(/\D/g, '')}.pdf`);
            };

            const generateCombinedPDF = async () => {
                if (!prePrintValidation()) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                addPetitionToPdf(pdf, lastCalculationData);
                pdf.addPage();
                if (lastCalculationData.type === 'condemnation') {
                    generateCondemnationCalcPage(pdf, lastCalculationData);
                } else {
                    generateAgreementCalcPage(pdf, lastCalculationData);
                }
                pdf.save(`Completo_${lastCalculationData.processNumber.replace(/\D/g, '')}.pdf`);
            };

            const generateCondemnationCalcPage = (pdf, data) => {
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Demonstrativo de Cálculo de Débito Judicial', pdf.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Cálculo realizado em: ${data.finalCalcDate.toLocaleDateString('pt-BR')}`, pdf.internal.pageSize.getWidth() / 2, 27, { align: 'center' });
                pdf.text(`Processo nº: ${data.processNumber}`, 15, 40);

                const head = [['Descrição', 'Valor Original', 'Correção (Tabela TJSP)', 'Juros de Mora', 'Subtotal']];
                const body = data.rows.map(row => {
                    const idxLine = (row.indiceInicial && row.indiceFinal)
                        ? `\nÍndices: ${row.indiceInicial.toFixed(6)} -> ${row.indiceFinal.toFixed(6)}`
                        : '';

                    if (row.description.startsWith('Multa (') && row.originalValue === 0) {
                        return [
                            row.description,
                            { content: '-', styles: { halign: 'center' } },
                            { content: '-', styles: { halign: 'center' } },
                            { content: '-', styles: { halign: 'center' } },
                            { content: formatCurrency(row.finalValueForRow), styles: { halign: 'right' } }
                        ];
                    }

                    return [
                        row.description,
                        { content: formatCurrency(row.originalValue), styles: { halign: 'right' } },
                        { content: `${formatCurrency(row.totalCorrection)}${idxLine}`, styles: { halign: 'right', fontSize: 9, textColor: [75, 85, 99] } },
                        { content: formatCurrency(row.totalInterest), styles: { halign: 'right' } },
                        { content: formatCurrency(row.finalValueForRow), styles: { halign: 'right' } }
                    ];
                });

                pdf.autoTable({
                    startY: 50,
                    head: head,
                    body: body,
                    headStyles: { fillColor: [75, 85, 99] },
                    columnStyles: { 0: { cellWidth: 50 } },
                    bodyStyles: { minCellHeight: 14 },
                });

                const finalY = pdf.lastAutoTable.finalY;
                let summaryY = finalY + 15;
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Subtotal da Condenação:', 15, summaryY);
                pdf.text(formatCurrency(data.summary.positiveSubtotal), 195, summaryY, { align: 'right' });

                if (data.summary.totalDeductions > 0) {
                    summaryY += 7;
                    pdf.text('(-) Total Deduzido:', 15, summaryY);
                    pdf.text(formatCurrency(data.summary.totalDeductions), 195, summaryY, { align: 'right' });
                }

                if (data.summary.addFine) {
                    summaryY += 7;
                    pdf.text('Multa do art. 523 (10%):', 15, summaryY);
                    pdf.text(formatCurrency(data.summary.fineValue), 195, summaryY, { align: 'right' });
                }

                summaryY += 7;
                pdf.setDrawColor(0);
                pdf.line(15, summaryY, 195, summaryY);
                summaryY += 5;

                pdf.setFont('helvetica', 'bold');
                pdf.text('Valor Total do Débito:', 15, summaryY);
                pdf.text(formatCurrency(data.summary.grandTotal), 195, summaryY, { align: 'right' });
            };

            const generateAgreementCalcPage = (pdf, data) => {
                const s = data.summary;
                const installments = data.installments;
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Demonstrativo de Descumprimento de Acordo', pdf.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Cálculo realizado em: ${data.finalCalcDate.toLocaleDateString('pt-BR')}`, pdf.internal.pageSize.getWidth() / 2, 27, { align: 'center' });
                pdf.text(`Processo nº: ${data.processNumber}`, 15, 40);

                let startY = 50;

                const paidInstallments = installments.filter(i => i.status === 'Paga');
                if (paidInstallments.length > 0) {
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Detalhamento das Parcelas Pagas', 15, startY);
                    startY += 7;
                    pdf.autoTable({
                        startY: startY,
                        head: [['Parcela', 'Vencimento', 'Valor Original', 'Valor Atualizado']],
                        body: paidInstallments.map(i => {
                            const idxText = (i.indiceInicial && i.indiceFinal)
                                ? `Índices: ${i.indiceInicial.toFixed(6)} -> ${i.indiceFinal.toFixed(6)}`
                                : '';
                            return [
                                i.number,
                                i.originalDate.toLocaleDateString('pt-BR'),
                                { content: formatCurrency(i.originalValue), styles: { halign: 'right' } },
                                { content: `${formatCurrency(i.updatedValue)}${idxText ? `\n${idxText}` : ''}`, styles: { halign: 'right', fontSize: 9, textColor: [75, 85, 99] } }
                            ];
                        }),
                        theme: 'grid',
                        headStyles: { fillColor: [22, 163, 74], textColor: [255, 255, 255] },
                        bodyStyles: { minCellHeight: 14 },
                    });
                    startY = pdf.lastAutoTable.finalY + 10;
                }

                const unpaidInstallments = installments.filter(i => i.status !== 'Paga');
                if (unpaidInstallments.length > 0) {
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Detalhamento das Parcelas Vencidas e Não Pagas', 15, startY);
                    startY += 7;
                    pdf.autoTable({
                        startY: startY,
                        head: [['Parcela', 'Vencimento', 'Valor Original', 'Valor Atualizado']],
                        body: unpaidInstallments.map(i => {
                            const idxText = (i.indiceInicial && i.indiceFinal)
                                ? `Índices: ${i.indiceInicial.toFixed(6)} -> ${i.indiceFinal.toFixed(6)}`
                                : '';
                            return [
                                i.number,
                                i.originalDate.toLocaleDateString('pt-BR'),
                                { content: formatCurrency(i.originalValue), styles: { halign: 'right' } },
                                { content: `${formatCurrency(i.updatedValue)}${idxText ? `\n${idxText}` : ''}`, styles: { halign: 'right', fontSize: 9, textColor: [75, 85, 99] } }
                            ];
                        }),
                        theme: 'grid',
                        headStyles: { fillColor: [220, 38, 38], textColor: [255, 255, 255] },
                        bodyStyles: { minCellHeight: 14 },
                    });
                    startY = pdf.lastAutoTable.finalY + 10;
                }

                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Resumo Final', 15, startY);
                startY += 7;

                const summaryBody = [
                    ['Valor Total do Acordo (Atualizado)', { content: formatCurrency(s.totalUpdated), styles: { halign: 'right' } }],
                    [`(-) Valor Pago (${s.paidInstallments} parcelas) (Atualizado)`, { content: formatCurrency(s.paidUpdated), styles: { halign: 'right' } }],
                    ['(=) Saldo Devedor (Atualizado)', { content: formatCurrency(s.updatedDebt), styles: { halign: 'right', fontStyle: 'bold' } }]
                ];

                if (s.updatedDeductionValue > 0) {
                    summaryBody.push([`(-) Dedução Adicional (Atualizada)`, { content: formatCurrency(s.updatedDeductionValue), styles: { halign: 'right' } }]);
                }

                summaryBody.push([`(+) Multa por Descumprimento (${s.penaltyPercent}%)`, { content: formatCurrency(s.penaltyValue), styles: { halign: 'right', textColor: [220, 53, 69] } }]);

                pdf.autoTable({
                    startY: startY,
                    head: [['Descrição', 'Valor']],
                    body: summaryBody,
                    theme: 'striped'
                });

                let finalY = pdf.lastAutoTable.finalY;

                let penaltyHelperText = '';
                if (s.penaltyBaseType === 'remaining') {
                    penaltyHelperText = `* Multa calculada sobre o saldo devedor atualizado de ${formatCurrency(s.penaltyBaseValue)}`;
                } else { // 'total'
                    penaltyHelperText = `* Multa calculada sobre o valor original do acordo de ${formatCurrency(s.penaltyBaseValue)}`;
                }
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'italic');
                pdf.text(penaltyHelperText, 15, finalY + 5);

                finalY += 12;
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Valor Total do Débito:', 15, finalY);
                pdf.text(formatCurrency(s.grandTotal), 195, finalY, { align: 'right' });
            };

            const toRoman = (num) => {
                const map = { 1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI', 7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X' };
                return map[num] || num;
            };

            const addPetitionToPdf = (pdf, data) => {
                const margin = 20;
                const maxWidth = pdf.internal.pageSize.getWidth() - margin * 2;
                let currentY = margin;
                const lineSpacing = 8;
                const paraSpacing = 5;
                const baseFontSize = 12;

                pdf.setFont('times', 'normal');
                pdf.setFontSize(baseFontSize);

                const checkPageBreak = (neededHeight) => {
                    if (currentY + neededHeight > pdf.internal.pageSize.getHeight() - margin) {
                        pdf.addPage();
                        currentY = margin;
                    }
                };

                const renderParagraph = (html, { indent = false } = {}) => {
                    checkPageBreak(lineSpacing * 2);

                    const words = [];
                    html.split(/<strong>(.*?)<\/strong>/g).forEach((part, i) => {
                        if (part) {
                            const isBold = i % 2 === 1;
                            part.trim().split(/\s+/).filter(Boolean).forEach(word => words.push({ text: word, isBold }));
                        }
                    });

                    const processedWords = [];
                    for (let i = 0; i < words.length; i++) {
                        const currentWord = words[i];
                        if (i + 1 < words.length && /^[.,;:]/.test(words[i + 1].text)) {
                            currentWord.text += words[i + 1].text;
                            i++;
                        }
                        processedWords.push(currentWord);
                    }

                    const lines = [];
                    let currentLine = [];
                    let currentLineWidth = 0;
                    const spaceWidth = pdf.getStringUnitWidth(' ') * baseFontSize / pdf.internal.scaleFactor;
                    const indentWidth = pdf.getStringUnitWidth(' '.repeat(15)) * baseFontSize / pdf.internal.scaleFactor;

                    for (const word of processedWords) {
                        pdf.setFont('times', word.isBold ? 'bold' : 'normal');
                        const wordWidth = pdf.getStringUnitWidth(word.text) * baseFontSize / pdf.internal.scaleFactor;

                        let effectiveMaxWidth = maxWidth;
                        if (lines.length === 0 && indent) {
                            effectiveMaxWidth -= indentWidth;
                        }

                        if (currentLineWidth + (currentLine.length > 0 ? spaceWidth : 0) + wordWidth > effectiveMaxWidth) {
                            lines.push(currentLine);
                            currentLine = [word];
                            currentLineWidth = wordWidth;
                        } else {
                            currentLine.push(word);
                            currentLineWidth += (currentLine.length > 0 ? spaceWidth : 0) + wordWidth;
                        }
                    }
                    if (currentLine.length > 0) lines.push(currentLine);

                    lines.forEach((line, lineIndex) => {
                        checkPageBreak(lineSpacing);
                        const isLastLineOfPara = lineIndex === lines.length - 1;

                        let wordsWidth = 0;
                        line.forEach(word => {
                            pdf.setFont('times', word.isBold ? 'bold' : 'normal');
                            wordsWidth += pdf.getStringUnitWidth(word.text) * baseFontSize / pdf.internal.scaleFactor;
                        });

                        let currentX = margin;
                        let spacing = spaceWidth;

                        if (!isLastLineOfPara && line.length > 1) {
                            let availableWidth = maxWidth;
                            if (lineIndex === 0 && indent) {
                                availableWidth -= indentWidth;
                            }
                            spacing = (availableWidth - wordsWidth) / (line.length - 1);
                        }

                        if (lineIndex === 0 && indent) {
                            currentX += indentWidth;
                        }

                        line.forEach(word => {
                            pdf.setFont('times', word.isBold ? 'bold' : 'normal');
                            pdf.text(word.text, currentX, currentY);
                            currentX += pdf.getStringUnitWidth(word.text) * baseFontSize / pdf.internal.scaleFactor + spacing;
                        });

                        currentY += lineSpacing;
                    });

                    currentY += paraSpacing;
                };

                const exequenteInputs = exequentesList.querySelectorAll('.exequente-name-input');
                const allExequentes = Array.from(exequenteInputs).map(input => input.value.trim().toUpperCase()).filter(Boolean);
                let exequentesText = allExequentes.length === 1 ? `<strong>${allExequentes[0]}</strong>, já qualificado(a) nos autos`
                    : allExequentes.join(', ').replace(/,([^,]*)$/, ' e$1') + ', já qualificados nos autos';

                const renderIndiceResumo = (titulo, linhas) => {
                    if (!linhas.length) return;
                    checkPageBreak(lineSpacing * 2 + linhas.length * lineSpacing);
                    const prevFont = pdf.getFont().fontName;
                    const prevStyle = pdf.getFont().fontStyle;
                    const prevSize = pdf.getFontSize();
                    pdf.setFont('times', 'bold');
                    pdf.setFontSize(10);
                    pdf.text(titulo, margin, currentY);
                    currentY += lineSpacing;
                    pdf.setFont('times', 'normal');
                    linhas.forEach(texto => {
                        const wrapped = pdf.splitTextToSize(texto, maxWidth);
                        wrapped.forEach(line => {
                            checkPageBreak(lineSpacing);
                            pdf.text(line, margin, currentY);
                            currentY += lineSpacing;
                        });
                    });
                    currentY += paraSpacing;
                    pdf.setFont(prevFont, prevStyle);
                    pdf.setFontSize(prevSize);
                };

                // --- Início da Renderização ---

                pdf.setFont('times', 'bold');
                const header = "EXCELENTÍSSIMO(A) SENHOR(A) DOUTOR(A) JUIZ(A) DE DIREITO DO JUIZADO ESPECIAL CÍVEL DA COMARCA DE MARÍLIA - SP";
                const headerLines = pdf.splitTextToSize(header, maxWidth);
                checkPageBreak(headerLines.length * lineSpacing);
                pdf.text(headerLines, pdf.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
                currentY += headerLines.length * lineSpacing + paraSpacing * 4;

                pdf.setFont('times', 'normal');
                checkPageBreak(lineSpacing);
                renderParagraph(`<strong>Processo nº: ${data.processNumber}</strong>`);
                currentY += paraSpacing;

                // --- Conteúdo Dinâmico da Petição ---
                if (data.type === 'condemnation') {
                    const para1HTML = `${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong> em face do(a)(s) executado(a)(s), também já qualificado(a)(s), tendo em vista o trânsito em julgado da r. sentença.`;
                    renderParagraph(para1HTML, { indent: true });

                    const para2HTML = `Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo legal, efetue o pagamento devido, no importe de <strong>${formatCurrency(data.summary.subtotal)}</strong>, conforme cálculo anexo. Não ocorrendo o pagamento, requer que o débito seja acrescido da multa de 10%, prevista no art. 523, §1º do CPC, totalizando a quantia de <strong>${formatCurrency(data.summary.subtotal * 1.10)}</strong>.`;
                    renderParagraph(para2HTML, { indent: true });

                    const linhasIndice = data.rows
                        .filter(r => r.indiceInicial && r.indiceFinal)
                        .map((r, idx) => `${idx + 1}. ${r.description}: ${r.indiceInicial.toFixed(6)} → ${r.indiceFinal.toFixed(6)} (Tabela TJSP)`);
                    renderIndiceResumo('Índices aplicados (Tabela TJSP):', linhasIndice);
                } else { // agreement
                    const agreementType = document.getElementById('agreement-type').value;
                    const actionText = agreementType === 'conhecimento' ? 'requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong>' : 'informar o descumprimento do acordo e requerer o <strong>PROSSEGUIMENTO DA EXECUÇÃO</strong>';
                    const multaText = data.summary.penaltyPercent > 0 ? 'já com o acréscimo da multa' : '';
                    let intimationText = '';
                    if (includeIntimationCheckbox.checked) {
                        const deadline = document.getElementById('intimation-deadline').value;
                        intimationText = `Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo de <strong>${deadline}</strong> dias, efetue o pagamento do valor remanescente, sob pena de reinício da execução e penhora de bens.`;
                    }

                    renderParagraph(`${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, informar o descumprimento do acordo homologado nos autos e, ato contínuo, ${actionText}.`, { indent: true });
                    renderParagraph(`Conforme se demonstra pelo cálculo anexo, o débito atualizado remanescente, ${multaText}, perfaz o montante de <strong>${formatCurrency(data.summary.grandTotal)}</strong>. ${intimationText}`, { indent: true });

                    const linhasIndice = data.installments
                        .filter(i => i.indiceInicial && i.indiceFinal)
                        .map(i => `Parcela ${i.number}: ${i.indiceInicial.toFixed(6)} → ${i.indiceFinal.toFixed(6)} (Tabela TJSP)`);
                    renderIndiceResumo('Índices aplicados por parcela (Tabela TJSP):', linhasIndice);
                }

                // --- Pedidos de Penhora (Comum a todas as petições) ---
                const requests = [];
                if (document.getElementById('penhora-contas').checked) requests.push('a pesquisa e bloqueio de valores em contas bancárias via SISBAJUD;');
                if (document.getElementById('penhora-veiculos').checked) requests.push('a pesquisa, bloqueio e penhora de veículos via RENAJUD;');
                if (document.getElementById('penhora-mandado').checked) requests.push('a expedição de mandado de penhora e avaliação de bens;');
                const outrosTextValue = penhoraOutrosText.value.trim();
                if (penhoraOutrosCheck.checked && outrosTextValue) requests.push(outrosTextValue);

                if (requests.length > 0) {
                    let penhoraHeader = 'Caso não haja o pagamento voluntário, requer o prosseguimento da execução com as seguintes medidas:';
                    if (data.type === 'agreement' && !document.getElementById('include-intimation-checkbox').checked) {
                        penhoraHeader = 'Requer a realização das seguintes medidas para constrição e penhora:';
                    }
                    renderParagraph(penhoraHeader, { indent: true });

                    requests.forEach((req, index) => {
                        const itemText = `${toRoman(index + 1)}. ${req}`;
                        checkPageBreak(lineSpacing);
                        pdf.text(itemText, margin + 10, currentY);
                        currentY += lineSpacing;
                    });
                    currentY += paraSpacing;
                }

                // --- Final da Petição (Comum a todas) ---
                currentY += paraSpacing;
                checkPageBreak(paraSpacing);
                renderParagraph("Nestes termos, pede deferimento.");

                currentY += paraSpacing * 2;
                const printDate = data.finalCalcDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                checkPageBreak(lineSpacing);
                pdf.text(`Marília, ${printDate}.`, pdf.internal.pageSize.getWidth() - margin, currentY, { align: 'right' });
                currentY += paraSpacing * 4;

                allExequentes.forEach(name => {
                    checkPageBreak(paraSpacing * 2);
                    const signatureX = pdf.internal.pageSize.getWidth() / 2;
                    pdf.line(signatureX - 40, currentY, signatureX + 40, currentY);
                    currentY += 5;
                    pdf.text(name, signatureX, currentY, { align: 'center' });
                    currentY += paraSpacing * 2;
                });
            };

            // --- EVENT LISTENERS ---
            calculationTypeSelect.addEventListener('change', toggleCalculationView);
            complianceRequestCheckbox.addEventListener('change', () => petitionOptionsContainer.classList.toggle('hidden', !complianceRequestCheckbox.checked));

            includeIntimationCheckbox.addEventListener('change', () => {
                intimationDeadlineWrapper.classList.toggle('hidden', !includeIntimationCheckbox.checked);
            });

            // Listener novo para mostrar/esconder o campo da última parcela
            agreementLastDifferentCheck.addEventListener('change', () => {
                agreementLastValueContainer.classList.toggle('hidden', !agreementLastDifferentCheck.checked);
            });


            condemnationContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('description-select')) {
                    const row = e.target.closest('.calculation-row');
                    const otherInput = row.querySelector('.other-description-input');
                    const interestDateInput = row.querySelector('.interest-date-input');
                    const correctionDateInput = row.querySelector('.correction-date-input');
                    const valueInput = row.querySelector('.value-input');
                    const valueLabel = row.querySelectorAll('label')[1]; // Label do valor

                    const isDeduction = e.target.value === 'Dedução/Pagamento Parcial';
                    const isMultaPercent = e.target.value === 'Multa (%)';

                    otherInput.classList.toggle('hidden', e.target.value !== 'Outro');

                    if (isMultaPercent) {
                        valueLabel.textContent = 'Porcentagem (%)';
                        interestDateInput.disabled = true;
                        interestDateInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                        interestDateInput.placeholder = '';
                        interestDateInput.value = '';

                        correctionDateInput.disabled = true;
                        correctionDateInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                        correctionDateInput.placeholder = '';
                        correctionDateInput.value = '';

                        valueInput.placeholder = 'Ex: 10';
                    } else {
                        valueLabel.textContent = 'Valor (R$)';
                        if (isDeduction) {
                            interestDateInput.disabled = true;
                            interestDateInput.placeholder = 'N/A';
                            interestDateInput.value = '';
                            interestDateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');

                            correctionDateInput.disabled = false;
                            correctionDateInput.placeholder = 'DD/MM/AAAA';
                            correctionDateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');

                            valueInput.placeholder = '1.000,00';
                        } else {
                            interestDateInput.disabled = false;
                            interestDateInput.placeholder = 'DD/MM/AAAA';
                            interestDateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');

                            correctionDateInput.disabled = false;
                            correctionDateInput.placeholder = 'DD/MM/AAAA';
                            correctionDateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');

                            valueInput.placeholder = '1.000,00';
                        }
                    }
                }
            });

            addExequenteBtn.addEventListener('click', () => {
                const newItem = document.createElement('div');
                newItem.className = 'exequente-item flex items-center gap-3';
                newItem.innerHTML = `<input type="text" class="exequente-name-input flex-grow p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Nome completo do Exequente"><button class="remove-exequente-btn bg-red-500 hover:bg-red-600 text-white font-bold px-3 py-1 rounded-lg">&times;</button>`;
                exequentesList.appendChild(newItem);
            });
            exequentesList.addEventListener('click', (e) => { if (e.target.classList.contains('remove-exequente-btn')) e.target.parentElement.remove() });
            penhoraOutrosCheck.addEventListener('change', () => penhoraOutrosText.classList.toggle('hidden'));
            addRowBtn.addEventListener('click', addRow);
            rowsContainer.addEventListener('click', removeRow);
            calculateBtn.addEventListener('click', handleCalculateClick);
            addFineCheckbox.addEventListener('change', () => { if (lastCalculationData && lastCalculationData.type === 'condemnation') handleCalculateClick(); });

            // Recalcula se a base da multa do acordo mudar
            agreementContainer.addEventListener('change', (e) => {
                if (e.target.name === 'penalty-base' && lastCalculationData && lastCalculationData.type === 'agreement') {
                    handleCalculateClick();
                }
            });

            printBtn.addEventListener('click', generateCalculationOnlyPDF);
            printCombinedBtn.addEventListener('click', generateCombinedPDF);
            printPetitionBtn.addEventListener('click', generatePetitionOnlyPDF);
            printCalcBtn.addEventListener('click', generateCalculationOnlyPDF);
            previewBtn.addEventListener('click', showPreview);
            closePreviewBtn.addEventListener('click', () => previewModal.classList.add('hidden'));
            previewModal.addEventListener('click', (e) => { if (e.target === previewModal) previewModal.classList.add('hidden'); });
            processNumberInput.addEventListener('input', formatCNJOnInput);

            // --- INICIALIZAÇÃO ---
            addInputBehaviors(document.body);
            fetchEconomicData();
            toggleCalculationView();
            populateAgreementPenaltyOptions(); // Preencher dropdown de multa

            // Preenche a data final com a data de hoje por padrão
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Janeiro é 0
            const year = today.getFullYear();
            document.getElementById('final-date').value = `${day}/${month}/${year}`;
        });
    </script>
</body>

</html>