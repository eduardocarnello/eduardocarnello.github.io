<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Parcelamento</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        /* Estilos gerais */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .header {
            text-align: center;
            font-weight: bold;
            font-size: 1.8em;
            margin-bottom: 2rem;
            color: #343a40;
        }

        /* Seções e Campos */
        .inline-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1.25rem;
            gap: 10px;
        }

        .inline-section label {
            font-weight: 600;
            flex-basis: 200px;
            color: #495057;
        }

        .inline-section input,
        .inline-section select,
        .inline-section textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1em;
            min-width: 150px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .inline-section input:focus,
        .inline-section select:focus,
        .inline-section textarea:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
            outline: none;
        }

        /* Botões */
        .btn {
            display: block;
            width: auto;
            max-width: 280px;
            margin: 25px auto;
            padding: 12px 20px;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Executados */
        .executado-section {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            padding: 1rem;
            border-radius: 5px;
            background-color: #fdfdfd;
        }

        .executado-header {
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #007bff;
        }

        .remove-executado {
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }

        /* Feedback ao Usuário */
        #feedback-bar {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: 500;
            transition: opacity 0.5s;
            opacity: 1;
        }

        .feedback-success {
            background-color: #d4edda;
            color: #155724;
        }

        .feedback-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .feedback-info {
            background-color: #cce5ff;
            color: #004085;
        }

        /* Outros */
        .hidden {
            display: none;
        }

        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .ui-dialog {
            z-index: 1000 !important;
        }

        .small-inputs {
            font-size: 8px !important;
            margin-top: -12px;
        }

        .small-inputs input {
            height: 1px;
            padding: 5px;
            border-radius: 0px !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="feedback-bar">Aguardando conexão...</div>
        <div class="header">
            Pedido de Parcelamento (art. 916, do CPC)
        </div>

        <div class="inline-section">
            <label>Nº do Processo:</label>
            <input type="text" id="numero_processo">
        </div>
        <div id="executados-container">
            <!-- Seções de executados serão inseridas aqui -->
        </div>
        <button id="add-executado-button" class="btn btn-secondary">Adicionar Executado</button>
        <div class="inline-section">
            <label>Valor da Dívida (R$):</label>
            <input type="text" id="valor_original">
        </div>
        <div class="inline-section">
            <label for="data-atualizacao">Data p/ Atualização:</label>
            <input type="text" id="data-atualizacao">
        </div>
        <div id="indicesdiv" class="inline-section small-inputs">
            <label></label>
            <input type="text" id="indice-inicial" placeholder="Índice Inicial" readonly>
            <input type="text" id="indice-final" placeholder="Índice Final" readonly>
        </div>
        <div class="inline-section">
            <label></label>
            <label for="valor-correcao">Valor da Correção:</label>
            <input type="text" id="valor-correcao" name="valor-correcao" readonly>
            <label for="juros">Juros:</label>
            <input type="text" id="juros" name="juros" readonly>
        </div>
        <div class="inline-section">
            <label>Valor Atualizado (R$):</label>
            <input type="text" id="valor_divida" readonly>
        </div>
        <div class="inline-section">
            <label for="valorEntrada">Entrada (<span id="percentualEntrada">30%</span>)</label>
            <input type="text" id="valor_entrada" readonly>
            <button type="button" id="btnValorMaior">Mais que 30%?</button>
            <input type="number" id="novoValorEntrada" class="hidden" placeholder="Insira o valor">
        </div>
        <div class="inline-section">
            <label>Restante (R$):</label>
            <input type="text" id="valor_restante" readonly>
        </div>
        <div class="inline-section">
            <label>Parcelas:</label>
            <select id="parcelas">
                <option value="" disabled selected>Selecione</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
            </select>
        </div>
        <div class="inline-section">
            <label>Valor da Parcela:</label>
            <input type="text" id="valor_parcela" readonly>
        </div>
        <div class="inline-section">
            <label>Data de Início:</label>
            <input type="text" id="data_primeira_parcela">
        </div>
        <div class="inline-section">
            <label>Outros Pedidos:</label>
            <textarea id="outros_pedidos" rows="4"></textarea>
        </div>
        <div class="section hidden" id="datas_parcelas_section">
            <label style="font-weight: bold; margin-bottom: 10px; display: block;">Datas das Parcelas:</label>
            <div id="datas_parcelas"></div>
        </div>
        <button class="btn btn-primary" id="gerar-pdf-button">Gerar Petição em PDF</button>
    </div>

    <!-- Modal para inserção de índice -->
    <div id="modal-indice" title="Índice Não Encontrado" class="hidden">
        <p>O índice de <b id="mes-ano-faltante"></b> não foi encontrado.</p>
        <p>Por favor, consulte a Tabela Prática do TJSP e insira o valor para salvá-lo para todos os usuários:</p>
        <input type="text" id="novo-indice-valor" placeholder="Ex: 102.345678">
        <p style="font-size: 0.8em; margin-top: 8px;">
            Acesse a página da
            <a href="https://www.tjsp.jus.br/PrimeiraInstancia/CalculosJudiciais/Comunicado?codigoComunicado=2524&pagina=1"
                target="_blank" rel="noopener noreferrer">Tabela Prática</a>
            e clique em "Tabela Prática - Lei nº 14.905/2024 - Cálculos cíveis em geral".
        </p>
        <div id="indice-error" class="hidden" style="color: red; font-size: 0.9em;">Por favor, insira um número válido
            (use ponto ou vírgula como decimal).</div>
    </div>

    <!-- SDKs de Bibliotecas Externas -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <script>
        // ***************************************************************
        // COLE A CONFIGURAÇÃO DO SEU FIREBASE AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyCt_nhxZ6QviuIDCOBymHOVj9WSQAH66aE",
            authDomain: "indices-tjsp-app.firebaseapp.com",
            projectId: "indices-tjsp-app",
            storageBucket: "indices-tjsp-app.firebasestorage.app",
            messagingSenderId: "365047837931",
            appId: "1:365047837931:web:4ad35364e4473e241f7aae"
        };
        // ***************************************************************

        // --- Variáveis Globais ---
        let indices = {};
        let db;
        let executadoCount = 0;
        const maxExecutados = 4;
        const INDICES_DOC_REF = 'tabelaPrincipal';
        const INDICES_COLLECTION = 'indicesTJSP';

        document.addEventListener('DOMContentLoaded', () => {
            // --- Cache de Seletores do DOM ---
            const dom = {
                feedbackBar: document.getElementById('feedback-bar'),
                valorOriginal: document.getElementById('valor_original'),
                dataAtualizacao: document.getElementById('data-atualizacao'),
                indiceInicial: document.getElementById('indice-inicial'),
                indiceFinal: document.getElementById('indice-final'),
                valorCorrecao: document.getElementById('valor-correcao'),
                juros: document.getElementById('juros'),
                valorDivida: document.getElementById('valor_divida'),
                valorEntrada: document.getElementById('valor_entrada'),
                novoValorEntrada: document.getElementById('novoValorEntrada'),
                percentualEntrada: document.getElementById('percentualEntrada'),
                valorRestante: document.getElementById('valor_restante'),
                parcelasSelect: document.getElementById('parcelas'),
                valorParcela: document.getElementById('valor_parcela'),
                dataPrimeiraParcela: document.getElementById('data_primeira_parcela'),
                datasParcelasSection: document.getElementById('datas_parcelas_section'),
                datasParcelasContainer: document.getElementById('datas_parcelas'),
                executadosContainer: document.getElementById('executados-container'),
                addExecutadoButton: document.getElementById('add-executado-button'),
                btnValorMaior: document.getElementById('btnValorMaior'),
                gerarPdfButton: document.getElementById('gerar-pdf-button'),
                numeroProcesso: document.getElementById('numero_processo'),
                outrosPedidos: document.getElementById('outros_pedidos'),
            };

            // --- FUNÇÕES DE UI ---
            const ui = {
                updateFeedback: (message, type = 'info') => {
                    dom.feedbackBar.textContent = message;
                    dom.feedbackBar.className = `feedback-${type}`;
                },
                showMissingIndexModal: (ano, mes) => {
                    return new Promise((resolve) => {
                        $("#mes-ano-faltante").text(`${mes}/${ano}`);
                        $("#novo-indice-valor").val('');
                        $("#indice-error").addClass('hidden');
                        $("#modal-indice").dialog({
                            modal: true, width: 450,
                            buttons: {
                                "Salvar e Continuar": async function () {
                                    const dialogInstance = $(this);
                                    const novoValorStr = $("#novo-indice-valor").val().replace(',', '.');
                                    const novoValor = parseFloat(novoValorStr);
                                    if (isNaN(novoValor) || novoValor <= 0) {
                                        $("#indice-error").removeClass('hidden'); return;
                                    }

                                    const success = await data.saveIndex(ano, mes, novoValor);

                                    if (success) {
                                        resolve(novoValor);
                                    } else {
                                        resolve(null);
                                    }

                                    dialogInstance.dialog("close");
                                }
                            }
                        });
                    });
                },
                createExecutadoSection: (index) => {
                    const section = document.createElement('div');
                    section.classList.add('executado-section');
                    section.id = `executado-${index}`;
                    section.innerHTML = `
                        ${index > 1 ? `<div class="executado-header">Executado ${index} <span class="remove-executado" data-index="${index}">Remover</span></div>` : ''}
                        <div class="inline-section"><label>Nome do Executado:</label><input type="text" class="nome-executado" data-index="${index}"><input type="hidden" class="genero-executado" data-index="${index}" value=""></div>
                        <div class="inline-section"><label class="cpf-cnpj-label" data-index="${index}">CPF/CNPJ:</label><input type="text" class="cpf-cnpj" data-index="${index}"><input type="hidden" class="cpf-cnpj-type" data-index="${index}" value=""></div>
                        <div class="inline-section" style="justify-content: flex-start;"><label>Atualizar Endereço?</label><input type="checkbox" class="atualizar-endereco" data-index="${index}"></div>
                        <div class="inline-section hidden endereco-section" data-index="${index}"><label>CEP:</label><input type="text" class="cep" data-index="${index}" maxlength="9" placeholder="#####-###"></div>
                        <div class="inline-section hidden endereco-completo-section" data-index="${index}"><label>Rua:</label><input type="text" class="rua" data-index="${index}" readonly><label>Nº:</label><input type="text" class="numero" data-index="${index}" maxlength="6"></div>
                        <div class="inline-section hidden complemento-bairro-section" data-index="${index}"><label>Complemento:</label><input type="text" class="complemento" data-index="${index}"><label>Bairro:</label><input type="text" class="bairro" data-index="${index}" readonly></div>
                        <div class="inline-section hidden cidade-estado-section" data-index="${index}"><label>Cidade:</label><input type="text" class="cidade" data-index="${index}" readonly><label>Estado:</label><input type="text" class="estado" data-index="${index}" readonly></div>
                    `;
                    dom.executadosContainer.appendChild(section);
                    setup.addEventListenersToExecutado(index);
                }
            };

            // --- LÓGICA DE DADOS (FIREBASE) ---
            const data = {
                initializeAndSync: () => {
                    const indicesBase = { "1964": { "10": 10000, "11": 10000, "12": 10000 }, "1965": { "10": 15900, "11": 16050, "12": 16300, "01": 11300, "02": 11300, "03": 11300, "04": 13400, "05": 13400, "06": 13400, "07": 15200, "08": 15200, "09": 15700 }, "1966": { "10": 21610, "11": 22180, "12": 22690, "01": 16600, "02": 17050, "03": 17300, "04": 17600, "05": 18280, "06": 19090, "07": 19870, "08": 20430, "09": 21010 }, "1967": { "10": 1545, "11": 1545, "12": 1545, "01": 120, "02": 1545, "03": 1545, "04": 1545, "05": 1545, "06": 1545, "07": 1545, "08": 1545, "09": 1545 }, "1968": { "10": 33.88, "11": 34.39, "12": 34.35, "01": 28.48, "02": 28.98, "03": 29.4, "04": 29.83, "05": 30.39, "06": 31.2, "07": 32.09, "08": 32.81, "09": 33.41 }, "1969": { "10": 39.92, "11": 40.57, "12": 41.42, "01": 35.62, "02": 36.27, "03": 36.91, "04": 37.43, "05": 38.01, "06": 38.48, "07": 39, "08": 39.27, "09": 39.56 }, "1970": { "10": 47.61, "11": 48.51, "12": 49.54, "01": 42.35, "02": 43.3, "03": 44.17, "04": 44.67, "05": 45.08, "06": 45.5, "07": 46.2, "08": 46.61, "09": 47.05 }, "1971": { "10": 58.61, "11": 59.79, "12": 60.77, "01": 50.51, "02": 51.44, "03": 52.12, "04": 52.64, "05": 53.25, "06": 54.01, "07": 55.08, "08": 56.18, "09": 57.36 }, "1972": { "10": 68.95, "11": 69.61, "12": 70.07, "01": 61.52, "02": 62.26, "03": 63.09, "04": 63.81, "05": 64.66, "06": 65.75, "07": 66.93, "08": 67.89, "09": 68.46 }, "1973": { "10": 77.87, "11": 78.4, "12": 79.07, "01": 70.87, "02": 71.57, "03": 72.32, "04": 73.19, "05": 74.03, "06": 74.97, "07": 75.8, "08": 76.48, "09": 77.12 }, "1974": { "10": 101.9, "11": 104.1, "12": 105.41, "01": 80.62, "02": 81.47, "03": 82.69, "04": 83.73, "05": 85.1, "06": 86.91, "07": 89.8, "08": 93.75, "09": 98.22 }, "1975": { "10": 125.7, "11": 128.43, "12": 130.93, "01": 106.76, "02": 108.38, "03": 110.18, "04": 112.25, "05": 114.49, "06": 117.13, "07": 119.27, "08": 121.31, "09": 123.2 }, "1976": { "10": 168.33, "11": 174.4, "12": 179.68, "01": 133.34, "02": 135.9, "03": 138.94, "04": 142.24, "05": 145.83, "06": 150.17, "07": 154.6, "08": 158.55, "09": 162.97 }, "1977": { "10": 227.15, "11": 230.3, "12": 233.74, "01": 183.65, "02": 186.83, "03": 190.51, "04": 194.83, "05": 200.45, "06": 206.9, "07": 213.8, "08": 219.51, "09": 224.01 }, "1978": { "10": 303.29, "11": 310.49, "12": 318.44, "01": 238.32, "02": 243.35, "03": 248.99, "04": 255.41, "05": 262.87, "06": 270.88, "07": 279.04, "08": 287.58, "09": 295.57 }, "1979": { "10": 428.8, "11": 448.47, "12": 468.71, "01": 326.82, "02": 334.2, "03": 341.97, "04": 350.51, "05": 363.64, "06": 377.54, "07": 390.1, "08": 400.71, "09": 412.24 }, "1980": { "10": 663.56, "11": 684.79, "12": 706.7, "01": 487.83, "02": 508.33, "03": 527.14, "04": 546.64, "05": 566.86, "06": 586.13, "07": 604.89, "08": 624.25, "09": 644.23 }, "1981": { "10": 1239.39, "11": 1310.04, "12": 1382.09, "01": 738.5, "02": 775.43, "03": 825.83, "04": 877.86, "05": 930.53, "06": 986.36, "07": 1045.54, "08": 1108.27, "09": 1172.55 }, "1982": { "10": 2398.55, "11": 2566.45, "12": 2733.27, "01": 1453.96, "02": 1526.66, "03": 1602.99, "04": 1683.14, "05": 1775.71, "06": 1873.37, "07": 1976.41, "08": 2094.99, "09": 2241.64 }, "1983": { "10": 5897.49, "11": 6469.55, "12": 7012.99, "01": 2910.93, "02": 3085.59, "03": 3292.32, "04": 3588.63, "05": 3911.61, "06": 4224.54, "07": 4554.05, "08": 4963.91, "09": 5385.84 }, "1984": { "10": 17867.42, "11": 20118.71, "12": 22110.46, "01": 7545.98, "02": 8285.49, "03": 9304.61, "04": 10235.07, "05": 11145.99, "06": 12137.98, "07": 13254.67, "08": 14619.9, "09": 16169.61 }, "1985": { "10": 58300.2, "11": 63547.22, "12": 70613.67, "01": 24432.06, "02": 27510.5, "03": 30316.57, "04": 34166.77, "05": 38208.46, "06": 42031.56, "07": 45901.91, "08": 49396.88, "09": 53437.4 }, "1986": { "10": 115.13, "11": 117.32, "12": 121.17, "01": 80047.66, "02": 93039.4, "03": 106.4, "04": 106.28, "05": 107.12, "06": 108.61, "07": 109.99, "08": 111.31, "09": 113.18 }, "1987": { "10": 424.51, "11": 463.48, "12": 522.99, "01": 129.98, "02": 151.85, "03": 181.61, "04": 207.97, "05": 251.56, "06": 310.53, "07": 366.49, "08": 377.67, "09": 401.69 }, "1988": { "10": 2966.39, "11": 3774.73, "12": 4790.89, "01": 596.94, "02": 695.5, "03": 820.42, "04": 951.77, "05": 1135.27, "06": 1337.12, "07": 1598.26, "08": 1982.48, "09": 2392.06 }, "1989": { "10": 34.308154, "11": 47.214881, "12": 66.771284, "01": 6.17, "02": 8.805824, "03": 9.698734, "04": 10.289386, "05": 11.04154, "06": 12.139069, "07": 15.153199, "08": 19.511259, "09": 25.235862 }, "1990": { "10": 1244.165321, "11": 1420.836796, "12": 1642.203168, "01": 102.527306, "02": 160.055377, "03": 276.54368, "04": 509.72531, "05": 738.082248, "06": 796.16932, "07": 872.20349, "08": 984.89218, "09": 1103.374709 }, "1991": { "10": 5906.963405, "11": 7152.15129, "12": 9046.040951, "01": 1942.726347, "02": 2329.523162, "03": 2838.989877, "04": 3173.706783, "05": 3332.709492, "06": 3555.334486, "07": 3940.37721, "08": 4418.739003, "09": 5108.946035 }, "1992": { "10": 72100.436048, "11": 90897.019725, "12": 111703.34754, "01": 1123.65984, "02": 14141.64687, "03": 17603.522023, "04": 21409.403484, "05": 25871.12317, "06": 32209.548346, "07": 38925.239176, "08": 47519.931986, "09": 58154.892764 }, "1993": { "10": 1445.693932, "11": 1938.964701, "12": 2636.991993, "01": 140277.06384, "02": 180634.775106, "03": 225414.135854, "04": 287583.354522, "05": 369170.752199, "06": 468034.679637, "07": 610176.811842, "08": 799.392641, "09": 1065.910147 }, "1994": { "10": 12.885497, "11": 13.125167, "12": 13.554359, "01": 3631.929071, "02": 5132.642163, "03": 7214.955088, "04": 10323.157739, "05": 14747.663145, "06": 21049.339606, "07": 11.346741, "08": 12.036622, "09": 12.693821 }, "1995": { "10": 16.07554, "11": 16.300597, "12": 16.546736, "01": 13.851199, "02": 14.082514, "03": 14.22193, "04": 14.422459, "05": 14.69937, "06": 15.077143, "07": 15.351547, "08": 15.729195, "09": 15.889632 }, "1996": { "10": 18.16185, "11": 18.230865, "12": 18.292849, "01": 16.819757, "02": 17.065325, "03": 17.186488, "04": 17.236328, "05": 17.396625, "06": 17.619301, "07": 17.853637, "08": 18.06788, "09": 18.158219 }, "1997": { "10": 18.957734, "11": 19.012711, "12": 19.04123, "01": 18.353215, "02": 18.501876, "03": 18.585134, "04": 18.711512, "05": 18.823781, "06": 18.844487, "07": 18.910442, "08": 18.94448, "09": 18.938796 }, "1998": { "10": 19.557718, "11": 19.579231, "12": 19.543988, "01": 19.149765, "02": 19.312538, "03": 19.416825, "04": 19.511967, "05": 19.59977, "06": 19.740888, "07": 19.770499, "08": 19.715141, "09": 19.618536 }, "1999": { "10": 20.728563, "11": 20.927557, "12": 21.124276, "01": 19.626072, "02": 19.753641, "03": 20.008462, "04": 20.26457, "05": 20.359813, "06": 20.369992, "07": 20.38425, "08": 20.535093, "09": 20.648036 }, "2000": { "10": 22.180052, "11": 22.21554, "12": 22.279965, "01": 21.280595, "02": 21.410406, "03": 21.421111, "04": 21.448958, "05": 21.468262, "06": 21.457527, "07": 21.521899, "08": 21.821053, "09": 22.085087 }, "2001": { "10": 23.80388, "11": 24.027636, "12": 24.337592, "01": 22.402504, "02": 22.575003, "03": 22.68562, "04": 22.79451, "05": 22.985983, "06": 23.117003, "07": 23.255705, "08": 23.513843, "09": 23.699602 }, "2002": { "10": 26.084345, "11": 26.493869, "12": 27.392011, "01": 24.51769, "02": 24.780029, "03": 24.856847, "04": 25.010959, "05": 25.181033, "06": 25.203695, "07": 25.357437, "08": 25.649047, "09": 25.869628 }, "2003": { "10": 30.65256, "11": 30.772104, "12": 30.88596, "01": 28.131595, "02": 28.826445, "03": 29.247311, "04": 29.647999, "05": 30.057141, "06": 30.354706, "07": 30.336493, "08": 30.348627, "09": 30.403254 }, "2004": { "10": 32.477896, "11": 32.533108, "12": 32.676253, "01": 31.052744, "02": 31.310481, "03": 31.432591, "04": 31.611756, "05": 31.741364, "06": 31.868329, "07": 32.02767, "08": 32.261471, "09": 32.422778 }, "2005": { "10": 34.099819, "11": 34.297597, "12": 34.482804, "01": 32.957268, "02": 33.145124, "03": 33.290962, "04": 33.533986, "05": 33.839145, "06": 34.076019, "07": 34.038535, "08": 34.048746, "09": 34.048746 }, "2006": { "10": 35.076643, "11": 35.227472, "12": 35.375427, "01": 34.620735, "02": 34.752293, "03": 34.832223, "04": 34.92627, "05": 34.968181, "06": 35.013639, "07": 34.989129, "08": 35.027617, "09": 35.020611 }, "2007": { "10": 36.801207, "11": 36.91161, "12": 37.070329, "01": 35.594754, "02": 35.769168, "03": 35.919398, "04": 36.077443, "05": 36.171244, "06": 36.265289, "07": 36.377711, "08": 36.494119, "09": 36.709434 }, "2008": { "10": 39.39325, "11": 39.590216, "12": 39.740658, "01": 37.429911, "02": 37.688177, "03": 37.86908, "04": 38.062212, "05": 38.30581, "06": 38.673545, "07": 39.025474, "08": 39.251821, "09": 39.334249 }, "2009": { "10": 41.144787, "11": 41.243534, "12": 41.396135, "01": 39.855905, "02": 40.110982, "03": 40.235326, "04": 40.315796, "05": 40.537532, "06": 40.780757, "07": 40.952036, "08": 41.046225, "09": 41.079061 }, "2010": { "10": 43.070798, "11": 43.467049, "12": 43.914759, "01": 41.495485, "02": 41.860645, "03": 42.153669, "04": 42.45296, "05": 42.762866, "06": 42.946746, "07": 42.899504, "08": 42.869474, "09": 42.839465 }, "2011": { "10": 46.214289, "11": 46.362174, "12": 46.626438, "01": 44.178247, "02": 44.593522, "03": 44.834327, "04": 45.130233, "05": 45.45517, "06": 45.714264, "07": 45.814835, "08": 45.814835, "09": 46.007257 }, "2012": { "10": 48.791424, "11": 49.137843, "12": 49.403187, "01": 46.864232, "02": 47.103239, "03": 47.286941, "04": 47.372057, "05": 47.675238, "06": 47.937451, "07": 48.062088, "08": 48.268754, "09": 48.485963 }, "2013": { "10": 51.566951, "11": 51.881509, "12": 52.161669, "01": 49.76877, "02": 50.226642, "03": 50.48782, "04": 50.790746, "05": 51.090411, "06": 51.269227, "07": 51.41278, "08": 51.345943, "09": 51.428096 }, "2014": { "10": 54.964221, "11": 55.173085, "12": 55.465502, "01": 52.537233, "02": 52.868217, "03": 53.206573, "04": 53.642866, "05": 54.06128, "06": 54.385647, "07": 54.527049, "08": 54.597934, "09": 54.69621 }, "2015": { "10": 60.407775, "11": 60.872914, "12": 61.548603, "01": 55.809388, "02": 56.635366, "03": 57.292336, "04": 58.15745, "05": 58.570367, "06": 59.150213, "07": 59.605669, "08": 59.951381, "09": 60.101259 }, "2016": { "10": 65.937995, "11": 66.050089, "12": 66.096324, "01": 62.10254, "02": 63.040288, "03": 63.63917, "04": 63.919182, "05": 64.328264, "06": 64.95868, "07": 65.263985, "08": 65.681674, "09": 65.885287 }, "2017": { "10": 67.012723, "11": 67.26067, "12": 67.381739, "01": 66.188858, "02": 66.466851, "03": 66.626371, "04": 66.839575, "05": 66.893046, "06": 67.13386, "07": 66.932458, "08": 67.046243, "09": 67.026129 }, "2018": { "10": 69.675294, "11": 69.953995, "12": 69.77911, "01": 67.556931, "02": 67.712311, "03": 67.834193, "04": 67.881676, "05": 68.024227, "06": 68.316731, "07": 69.29366, "08": 69.466894, "09": 69.466894 }, "2019": { "10": 71.712333, "11": 71.741017, "12": 72.128418, "01": 69.8768, "02": 70.128356, "03": 70.507049, "04": 71.049953, "05": 71.476252, "06": 71.583466, "07": 71.590624, "08": 71.662214, "09": 71.748208 }, "2020": { "10": 74.500463, "11": 75.163517, "12": 75.87757, "01": 73.008384, "02": 73.147099, "03": 73.271449, "04": 73.403337, "05": 73.234509, "06": 73.051422, "07": 73.270576, "08": 73.592966, "09": 73.8579 }, "2021": { "10": 82.533902, "11": 83.491295, "12": 84.192621, "01": 76.985382, "02": 77.193242, "03": 77.826226, "04": 78.495531, "05": 78.793814, "06": 79.550234, "07": 80.027535, "08": 80.843815, "09": 81.55524 }, "2022": { "10": 88.469087, "11": 88.884891, "12": 89.222653, "01": 84.807227, "02": 85.375435, "03": 86.229189, "04": 87.703708, "05": 88.615826, "06": 89.014597, "07": 89.566487, "08": 89.029088, "09": 88.753097 }, "2023": { "01": 89.838289, "02": 90.251545, "03": 90.946481, "04": 91.528538, "05": 92.013639, "06": 92.344888, "07": 92.252543, "08": 92.169515, "09": 92.353854, "10": 92.455443, "11": 92.566389, "12": 92.6589553 }, "2024": { "01": 93.168579, "02": 93.699639, "03": 94.458606, "04": 94.638077, "05": 94.988237, "06": 95.425182, "07": 95.663744, "08": 95.912469, "09": 96.094702, "10": 96.219625, "11": 96.739210, "12": 97.338993 }, "2025": { "01": 97.669945, "02": 97.777381, "03": 98.980042, "04": 99.613514, "05": 100.041852, "06": 100.402002, "07": 100.619530, "08": 100.995235, "09": null, "10": null, "11": null, "12": null } };

                    indices = indicesBase;

                    try {
                        console.log("Tentando inicializar o Firebase...");
                        if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "SUA_API_KEY") {
                            throw new Error("firebaseConfig não foi preenchido. Insira suas chaves de API.");
                        }
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        db = firebase.firestore();
                        // AJUSTE PARA TENTAR CONTORNAR FIREWALL
                        db.settings({
                            experimentalForceLongPolling: true,
                            merge: true
                        });

                        console.log("Firebase inicializado. Tentando login anônimo...");

                        firebase.auth().signInAnonymously()
                            .then(() => {
                                console.log("Login anônimo bem-sucedido. Sincronizando dados...");
                                // Inicia o listener em tempo real
                                const docRef = db.collection(INDICES_COLLECTION).doc(INDICES_DOC_REF);
                                docRef.onSnapshot((doc) => {
                                    ui.updateFeedback('Conectado e dados sincronizados!', 'success');
                                    if (doc.exists && doc.data().indices) {
                                        const remoteIndices = doc.data().indices;
                                        // Une os dados base com os do Firebase, com prioridade para os do Firebase
                                        Object.keys(remoteIndices).forEach(ano => {
                                            if (!indices[ano]) indices[ano] = {};
                                            Object.assign(indices[ano], remoteIndices[ano]);
                                        });
                                        console.log("Índices atualizados do Firestore.");
                                    } else {
                                        console.log("Documento não encontrado. Tentando criar com dados base...");
                                        // Se o documento não existe na nuvem, salva o base lá
                                        docRef.set({ indices: indicesBase }).catch(e => console.error("Falha ao criar documento inicial:", e));
                                    }
                                }, (error) => {
                                    console.error("ERRO NO LISTENER DO FIRESTORE:", error);
                                    ui.updateFeedback("Erro de permissão ou configuração. Verifique as REGRAS e a CHAVE DE API.", 'error');
                                });
                            })
                            .catch(authError => {
                                console.error("ERRO DE AUTENTICAÇÃO ANÔNIMA:", authError);
                                ui.updateFeedback("Falha na autenticação. Verifique se o login anônimo está ativo.", 'error');
                                db = null;
                            });

                    } catch (e) {
                        console.error("ERRO CRÍTICO AO INICIALIZAR O FIREBASE:", e.message);
                        ui.updateFeedback('Erro de conexão. A aplicação está em modo offline.', 'error');
                        db = null; // Garante que db é nulo se a inicialização falhar
                    }
                },
                saveIndex: async (ano, mes, valor) => {
                    // Atualiza o índice localmente primeiro (atualização otimista)
                    if (!indices[ano]) indices[ano] = {};
                    indices[ano][mes] = valor;

                    if (!db) {
                        ui.updateFeedback("Modo Offline. O novo índice foi salvo apenas para esta sessão.", 'error');
                        return true; // Retorna sucesso para a sessão atual
                    }

                    try {
                        // Usa notação de ponto para atualizar apenas o campo necessário
                        const fieldPath = `indices.${ano}.${mes}`;
                        const docRef = db.collection(INDICES_COLLECTION).doc(INDICES_DOC_REF);
                        await docRef.set({ indices: { [ano]: { [mes]: valor } } }, { merge: true });

                        ui.updateFeedback(`Índice para ${mes}/${ano} salvo com sucesso!`, 'success');
                        return true;
                    } catch (error) {
                        console.error("Erro ao salvar índice no Firebase:", error);
                        ui.updateFeedback("Erro ao salvar. Verifique as REGRAS DE SEGURANÇA do Firestore.", 'error');
                        return false;
                    }
                }
            };

            // --- LÓGICA DE CÁLCULO E HELPERS ---
            const logic = {
                obterValorNumerico: (valor) => {
                    if (typeof valor !== 'string' || valor.trim() === '') return 0;
                    return parseFloat(valor.replace(/[^\d,-]/g, '').replace(',', '.'));
                },
                formatCurrency: (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                formatDate: (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                },
                parseDate: (input) => {
                    if (!input || !/^\d{2}\/\d{2}\/\d{4}$/.test(input)) return new Date(NaN);
                    const parts = input.split('/');
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                },
                getIndex: async (ano, mes) => {
                    const index = indices[ano]?.[mes];
                    if (index) return index;
                    return await ui.showMissingIndexModal(ano, mes);
                },
                handleCalculationTrigger: async () => {
                    const valorOriginalNum = logic.obterValorNumerico(dom.valorOriginal.value);
                    if (valorOriginalNum > 0 && dom.dataAtualizacao.value.length >= 10) {
                        await logic.updateDebt();
                    }
                },
                updateDebt: async () => {
                    ui.updateFeedback('Calculando...', 'info');
                    const [day, mes, ano] = dom.dataAtualizacao.value.split('/');
                    const dataAtual = new Date();
                    const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
                    const anoAtual = String(dataAtual.getFullYear());

                    const indiceInicial = await logic.getIndex(ano, mes);
                    if (!indiceInicial) {
                        ui.updateFeedback("Cálculo cancelado. Índice inicial não fornecido.", 'error');
                        return;
                    }

                    const indiceFinal = await logic.getIndex(anoAtual, mesAtual);
                    if (!indiceFinal) {
                        ui.updateFeedback("Cálculo cancelado. Índice final não fornecido.", 'error');
                        return;
                    }

                    const valorOriginal = logic.obterValorNumerico(dom.valorOriginal.value);
                    const valorAtualizado = (valorOriginal * indiceFinal / indiceInicial);
                    dom.valorCorrecao.value = logic.formatCurrency(valorAtualizado - valorOriginal);

                    const dataAtualizacaoDate = logic.parseDate(dom.dataAtualizacao.value);
                    const diffTime = Math.abs(dataAtual - dataAtualizacaoDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const taxaDiaria = Math.pow(1.01, 1 / 30) - 1;
                    const juros = valorAtualizado * (Math.pow(1 + taxaDiaria, diffDays) - 1);
                    const valorCorrigido = valorAtualizado + juros;
                    const porcentagemJuros = ((Math.pow(1 + taxaDiaria, diffDays) - 1) * 100).toFixed(2);

                    dom.valorDivida.value = logic.formatCurrency(valorCorrigido);
                    dom.juros.value = `${logic.formatCurrency(juros)} (${porcentagemJuros.replace('.', ',')}%)`;
                    dom.indiceInicial.value = `Índice inicial: ${indiceInicial} (${mes}/${ano})`;
                    dom.indiceFinal.value = `Índice final: ${indiceFinal} (${mesAtual}/${anoAtual})`;

                    const valorEntrada = valorCorrigido * 0.3;
                    dom.valorEntrada.value = logic.formatCurrency(valorEntrada);
                    dom.datasParcelasSection.classList.remove('hidden');
                    logic.updateInstallments();
                    ui.updateFeedback('Cálculo concluído.', 'success');
                },
                updateInstallments: () => {
                    const valorDivida = logic.obterValorNumerico(dom.valorDivida.value);
                    if (isNaN(valorDivida) || valorDivida <= 0) return;

                    let valorEntrada = logic.obterValorNumerico(dom.valorEntrada.value);
                    if (dom.novoValorEntrada.value) {
                        const novoValor = parseFloat(dom.novoValorEntrada.value);
                        if (!isNaN(novoValor) && novoValor >= (valorDivida * 0.3)) {
                            valorEntrada = novoValor;
                        }
                    }

                    const valorRestante = valorDivida - valorEntrada;
                    dom.valorRestante.value = logic.formatCurrency(valorRestante);

                    const parcelas = parseInt(dom.parcelasSelect.value);
                    if (isNaN(parcelas) || parcelas < 1) {
                        dom.valorParcela.value = '';
                        dom.datasParcelasContainer.innerHTML = '';
                        return;
                    }

                    const valorParcela = valorRestante / parcelas;
                    dom.valorParcela.value = logic.formatCurrency(valorParcela);

                    const dataPrimeiraParcela = logic.parseDate(dom.dataPrimeiraParcela.value);
                    if (isNaN(dataPrimeiraParcela.getTime())) return;

                    dom.datasParcelasContainer.innerHTML = '';
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.textAlign = 'center';
                    table.innerHTML = `<thead><tr><th>#</th><th>Data</th><th>Valor (c/ juros)</th></tr></thead>`;
                    const tbody = document.createElement('tbody');

                    for (let i = 0; i < parcelas; i++) {
                        let dataParcela = new Date(dataPrimeiraParcela);
                        dataParcela.setMonth(dataPrimeiraParcela.getMonth() + i);
                        while (dataParcela.getDay() === 0 || dataParcela.getDay() === 6) {
                            dataParcela.setDate(dataParcela.getDate() + 1);
                        }
                        const valorParcelaComJuros = (valorRestante / parcelas) * Math.pow(1.01, i + 1);
                        tbody.innerHTML += `<tr><td>${i + 1}</td><td>${logic.formatDate(dataParcela)}</td><td>${logic.formatCurrency(valorParcelaComJuros)}</td></tr>`;
                    }
                    table.appendChild(tbody);
                    dom.datasParcelasContainer.appendChild(table);
                },
                isValidCPF: (cpf) => {
                    cpf = cpf.replace(/[^\d]+/g, '');
                    if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
                    let soma = 0;
                    let resto;
                    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
                    resto = (soma * 10) % 11;
                    if ((resto === 10) || (resto === 11)) resto = 0;
                    if (resto !== parseInt(cpf.substring(9, 10))) return false;
                    soma = 0;
                    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
                    resto = (soma * 10) % 11;
                    if ((resto === 10) || (resto === 11)) resto = 0;
                    if (resto !== parseInt(cpf.substring(10, 11))) return false;
                    return true;
                },
                isValidCNPJ: (cnpj) => {
                    cnpj = cnpj.replace(/[^\d]+/g, '');
                    if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
                    let tamanho = cnpj.length - 2;
                    let numeros = cnpj.substring(0, tamanho);
                    let digitos = cnpj.substring(tamanho);
                    let soma = 0;
                    let pos = tamanho - 7;
                    for (let i = tamanho; i >= 1; i--) {
                        soma += numeros.charAt(tamanho - i) * pos--;
                        if (pos < 2) pos = 9;
                    }
                    let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
                    if (resultado != digitos.charAt(0)) return false;
                    tamanho = tamanho + 1;
                    numeros = cnpj.substring(0, tamanho);
                    soma = 0;
                    pos = tamanho - 7;
                    for (let i = tamanho; i >= 1; i--) {
                        soma += numeros.charAt(tamanho - i) * pos--;
                        if (pos < 2) pos = 9;
                    }
                    resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
                    if (resultado != digitos.charAt(1)) return false;
                    return true;
                },
                generatePDF: () => {
                    const numeroProcesso = dom.numeroProcesso.value;
                    const valorDivida = dom.valorDivida.value;
                    const valorEntrada = dom.valorEntrada.value;
                    const valorRestanteNum = logic.obterValorNumerico(dom.valorRestante.value);
                    const valorRestante = dom.valorRestante.value;
                    const parcelas = parseInt(dom.parcelasSelect.value);
                    const outrosPedidos = dom.outrosPedidos.value;
                    const dataPrimeiraParcela = logic.parseDate(dom.dataPrimeiraParcela.value);

                    let executadosText = '';
                    const executadoElements = document.querySelectorAll('.executado-section');
                    executadoElements.forEach((executado, index) => {
                        const nome = executado.querySelector('.nome-executado').value;
                        const cpfCnpj = executado.querySelector('.cpf-cnpj').value;
                        executadosText += `<b>Executado ${index + 1}:</b> ${nome}, inscrito no CPF/CNPJ sob o nº ${cpfCnpj}.<br>`;
                    });

                    // --- Início da Lógica da Tabela de Parcelas para o PDF ---
                    let parcelasTableHtml = '';
                    if (!isNaN(dataPrimeiraParcela.getTime()) && parcelas > 0) {
                        parcelasTableHtml = `
                            <p>O restante, no valor de <b>${valorRestante}</b>, será pago em <b>${parcelas}</b> parcelas mensais, conforme tabela abaixo, todas acrescidas de correção monetária e de juros de 1% (um por cento) ao mês:</p>
                            <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 11pt; margin-top: 15px; margin-bottom: 15px;">
                                <thead style="background-color: #f2f2f2;">
                                    <tr>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Parcela</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Data de Vencimento</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Valor (com juros de 1% a.m.)</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        for (let i = 0; i < parcelas; i++) {
                            let dataParcela = new Date(dataPrimeiraParcela);
                            dataParcela.setMonth(dataPrimeiraParcela.getMonth() + i);
                            // Ajusta para o próximo dia útil se cair no fim de semana
                            while (dataParcela.getDay() === 0 || dataParcela.getDay() === 6) {
                                dataParcela.setDate(dataParcela.getDate() + 1);
                            }
                            const valorParcelaComJuros = (valorRestanteNum / parcelas) * Math.pow(1.01, i + 1);
                            parcelasTableHtml += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${i + 1}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${logic.formatDate(dataParcela)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${logic.formatCurrency(valorParcelaComJuros)}</td>
                                </tr>
                            `;
                        }

                        parcelasTableHtml += `
                                </tbody>
                            </table>
                        `;
                    }
                    // --- Fim da Lógica da Tabela ---

                    const content = `
                        <div style="font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5; text-align: justify;">
                            <p style="text-align: justify;"><b>AO JUIZADO ESPECIAL CÍVEL DE MARÍLIA/SP</b></p>
                            <br><br>
                            <p><b>Processo nº ${numeroProcesso}</b></p>
                            <br><br>
                            <p>${executadosText}</p>
                            <p>Vem, respeitosamente, à presença de Vossa Excelência, nos autos da Ação de Execução de Título Extrajudicial em epígrafe, requerer o parcelamento do débito, nos termos do artigo 916 do Código de Processo Civil.</p>
                            <p>O valor atualizado do débito é de <b>${valorDivida}</b>.</p>
                            <p>O executado reconhece o crédito do exequente e comprova o depósito de <b>${valorEntrada}</b>, correspondente a 30% (trinta por cento) do valor da execução, acrescido de custas e de honorários de advogado.</p>
                            ${parcelasTableHtml}
                            <p>${outrosPedidos}</p>
                            <br>
                            <p>Termos em que,<br>Pede deferimento.</p>
                            <br>
                            <p style="text-align: center;">Marília, ${new Date().toLocaleDateString('pt-BR')}.</p>
                        </div>
                    `;

                    const options = {
                        margin: [30, 20, 30, 20],
                        filename: `peticao_${numeroProcesso.replace(/\D/g, '')}.pdf`,
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    html2pdf().from(content).set(options).save();
                }
            };

            // --- INICIALIZAÇÃO E EVENT LISTENERS ---
            const setup = {
                iMasks: () => {
                    IMask(dom.numeroProcesso, { mask: '0000000-00.0000.0.00.0000' });
                    IMask(dom.valorOriginal, { mask: Number, scale: 2, thousandsSeparator: '.', padFractionalZeros: true, normalizeZeros: true, radix: ',' });
                },
                datepickers: () => {
                    $.datepicker.setDefaults($.datepicker.regional['pt-BR'] = {
                        closeText: 'Fechar', prevText: '&#x3C;Anterior', nextText: 'Próximo&#x3E;', currentText: 'Hoje', monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'], monthNamesShort: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'], dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'], dayNamesMin: ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'], dateFormat: 'dd/mm/yy', firstDay: 0
                    });

                    const hoje = new Date();
                    $(dom.dataPrimeiraParcela).datepicker({ dateFormat: "dd/mm/yy", minDate: 0, beforeShowDay: $.datepicker.noWeekends });
                    const dataDefault = new Date();
                    dataDefault.setMonth(hoje.getMonth() + 1);
                    dom.dataPrimeiraParcela.value = logic.formatDate(dataDefault);

                    $(dom.dataAtualizacao).datepicker({ dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true, showOn: "button", buttonImage: "https://jqueryui.com/resources/demos/datepicker/images/calendar.gif", buttonImageOnly: true });
                },
                eventListeners: () => {
                    dom.valorOriginal.addEventListener('change', logic.handleCalculationTrigger);
                    dom.dataAtualizacao.addEventListener('change', logic.handleCalculationTrigger);
                    dom.parcelasSelect.addEventListener('change', logic.updateInstallments);
                    dom.dataPrimeiraParcela.addEventListener('change', logic.updateInstallments);

                    // Lógica de formatação e autocomplete da data
                    dom.dataAtualizacao.addEventListener('input', (e) => {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 2) value = value.slice(0, 2) + '/' + value.slice(2);
                        if (value.length > 5) value = value.slice(0, 5) + '/' + value.slice(5, 9);
                        e.target.value = value;
                    });
                    dom.dataAtualizacao.addEventListener('blur', (e) => {
                        let value = e.target.value;
                        if (value.length >= 10 || value.length === 0) return;

                        const parts = value.split('/').filter(p => p.length > 0);
                        const hoje = new Date();
                        const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
                        const anoAtual = hoje.getFullYear();

                        let finalDate = '';
                        if (parts.length === 1) { // Apenas dia
                            finalDate = `${parts[0].padStart(2, '0')}/${mesAtual}/${anoAtual}`;
                        } else if (parts.length === 2) { // Dia e mês
                            finalDate = `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${anoAtual}`;
                        }

                        if (finalDate) {
                            e.target.value = finalDate;
                            dom.dataAtualizacao.dispatchEvent(new Event('change')); // Dispara o cálculo
                        }
                    });

                    dom.btnValorMaior.addEventListener('click', () => {
                        dom.novoValorEntrada.classList.remove('hidden');
                        dom.novoValorEntrada.focus();
                    });

                    dom.novoValorEntrada.addEventListener('change', function () {
                        const valorDivida = logic.obterValorNumerico(dom.valorDivida.value);
                        if (valorDivida === 0) return;
                        const novoValor = parseFloat(this.value);
                        if (isNaN(novoValor) || novoValor < (valorDivida * 0.3)) {
                            ui.updateFeedback(`Valor de entrada deve ser no mínimo ${logic.formatCurrency(valorDivida * 0.3)}`, 'error');
                            this.value = '';
                            return;
                        }
                        dom.valorEntrada.value = logic.formatCurrency(novoValor);
                        dom.percentualEntrada.textContent = `${((novoValor / valorDivida) * 100).toFixed(2).replace('.', ',')}%`;
                        logic.updateInstallments();
                    });

                    dom.addExecutadoButton.addEventListener('click', () => {
                        if (executadoCount < maxExecutados) {
                            executadoCount++;
                            ui.createExecutadoSection(executadoCount);
                            if (executadoCount === maxExecutados) {
                                dom.addExecutadoButton.style.display = 'none';
                            }
                        }
                    });

                    dom.gerarPdfButton.addEventListener('click', () => {
                        const numeroProcessoElement = document.getElementById('numero_processo');
                        const numeroProcesso = numeroProcessoElement.value.trim();
                        const maskPlaceholder = '_______-__.20__.8.26.0344';

                        if (numeroProcesso === '' || numeroProcesso === maskPlaceholder || numeroProcesso.includes('_')) {
                            alert('Por favor, preencha o campo "Nº do Processo" corretamente.');
                            numeroProcessoElement.focus();
                            return;

                        }

                        const valorDividaElement = document.getElementById('valor_divida');
                        const valorDivida = logic.obterValorNumerico(valorDividaElement.value);
                        if (isNaN(valorDivida) || valorDivida <= 0) {
                            alert('Por favor, preencha o campo "Valor da Dívida" corretamente.');
                            valorDividaElement.focus();
                            return;
                        }

                        const parcelasElement = document.getElementById('parcelas');
                        const parcelas = parseInt(parcelasElement.value);
                        if (isNaN(parcelas) || parcelas < 1) {
                            alert('Por favor, selecione o número de parcelas.');
                            parcelasElement.focus();
                            return;
                        }

                        const nomeExecutadoElements = document.querySelectorAll('.nome-executado');
                        for (let i = 0; i < nomeExecutadoElements.length; i++) {
                            const nomeExecutado = nomeExecutadoElements[i].value.trim();
                            if (nomeExecutado === '' || nomeExecutado.length < 10) {
                                alert('Por favor, preencha o campo "Nome do Executado" corretamente.');
                                nomeExecutadoElements[i].focus();
                                return;
                            }
                        }

                        const cpfCnpjElements = document.querySelectorAll('.cpf-cnpj');
                        for (let i = 0; i < cpfCnpjElements.length; i++) {
                            const cpfCnpj = cpfCnpjElements[i].value.trim();
                            const cpfCnpjType = document.querySelector(`.cpf-cnpj-type[data-index="${i + 1}"]`).value;
                            if (cpfCnpj === '' || cpfCnpj.length < 14 || cpfCnpj.includes('_') ||
                                (cpfCnpjType === 'CPF' && !logic.isValidCPF(cpfCnpj)) ||
                                (cpfCnpjType === 'CNPJ' && !logic.isValidCNPJ(cpfCnpj))) {
                                alert('Por favor, preencha o campo "CPF/CNPJ" corretamente.');
                                cpfCnpjElements[i].focus();
                                return;
                            }
                        }

                        const atualizarEnderecoElements = document.querySelectorAll('.atualizar-endereco');
                        for (let i = 0; i < atualizarEnderecoElements.length; i++) {
                            if (atualizarEnderecoElements[i].checked) {
                                const index = atualizarEnderecoElements[i].dataset.index;
                                const cep = document.querySelector(`.cep[data-index="${index}"]`).value.trim();
                                const rua = document.querySelector(`.rua[data-index="${index}"]`).value.trim();
                                const numero = document.querySelector(`.numero[data-index="${index}"]`).value.trim();
                                const bairro = document.querySelector(`.bairro[data-index="${index}"]`).value.trim();
                                const cidade = document.querySelector(`.cidade[data-index="${index}"]`).value.trim();
                                const estado = document.querySelector(`.estado[data-index="${index}"]`).value.trim();

                                if (cep === '' || cep.length < 9 || cep.includes('_')) {
                                    alert('Por favor, preencha o campo "CEP" corretamente.');
                                    document.querySelector(`.cep[data-index="${index}"]`).focus();
                                    return;
                                }
                                if (rua === '') {
                                    alert('Por favor, preencha o campo "Rua" corretamente.');
                                    document.querySelector(`.rua[data-index="${index}"]`).focus();
                                    return;
                                }
                                if (numero === '') {
                                    alert('Por favor, preencha o campo "Nº" corretamente.');
                                    document.querySelector(`.numero[data-index="${index}"]`).focus();
                                    return;
                                }
                                if (bairro === '') {
                                    alert('Por favor, preencha o campo "Bairro" corretamente.');
                                    document.querySelector(`.bairro[data-index="${index}"]`).focus();
                                    return;
                                }
                                if (cidade === '') {
                                    alert('Por favor, preencha o campo "Cidade" corretamente.');
                                    document.querySelector(`.cidade[data-index="${index}"]`).focus();
                                    return;
                                }
                                if (estado === '') {
                                    alert('Por favor, preencha o campo "Estado" corretamente.');
                                    document.querySelector(`.estado[data-index="${index}"]`).focus();
                                    return;
                                }
                            }
                        }

                        logic.generatePDF();
                        ui.updateFeedback("Gerando PDF... (Lógica a ser implementada)", "info");
                    });
                },
                addEventListenersToExecutado: (index) => {
                    const section = document.getElementById(`executado-${index}`);
                    if (!section) return;

                    const removeButton = section.querySelector(`.remove-executado`);
                    if (removeButton) {
                        removeButton.addEventListener('click', function () {
                            section.remove();
                            executadoCount--;
                            dom.addExecutadoButton.style.display = 'block';
                        });
                    }

                    section.querySelector(`.atualizar-endereco`).addEventListener('change', function () {
                        const sectionsToToggle = [`.endereco-section`, `.endereco-completo-section`, `.complemento-bairro-section`, `.cidade-estado-section`];
                        sectionsToToggle.forEach(selector => {
                            section.querySelector(selector).classList.toggle('hidden', !this.checked);
                        });
                    });

                    section.querySelector('.nome-executado').addEventListener('blur', function () {
                        const nomeExecutado = this.value.split(' ')[0];
                        if (!nomeExecutado) return;
                        fetch(`https://api.genderize.io?name=${nomeExecutado}&country_id=BR`)
                            .then(response => response.json())
                            .then(gData => { section.querySelector(`.genero-executado`).value = (gData.gender && gData.probability >= 0.8) ? gData.gender : 'unknown'; })
                            .catch(error => console.error('Erro no Genderize:', error));
                    });

                    const cepInput = section.querySelector(`.cep`);
                    cepInput.addEventListener('input', function () {
                        this.value = this.value.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2');
                        if (this.value.length === 9) {
                            fetch(`https://viacep.com.br/ws/${this.value.replace('-', '')}/json/`)
                                .then(response => response.json())
                                .then(cepData => {
                                    if (!cepData.erro) {
                                        section.querySelector(`.rua`).value = cepData.logouro;
                                        section.querySelector(`.bairro`).value = cepData.bairro;
                                        section.querySelector(`.cidade`).value = cepData.localidade;
                                        section.querySelector(`.estado`).value = cepData.uf;
                                        section.querySelector(`.numero`).focus();
                                    } else { ui.updateFeedback('CEP não encontrado.', 'error'); }
                                }).catch(error => console.error('Erro no ViaCEP:', error));
                        }
                    });

                    const cpfCnpjInput = section.querySelector(`.cpf-cnpj`);
                    IMask(cpfCnpjInput, { mask: [{ mask: '000.000.000-00' }, { mask: '00.000.000/0000-00' }] })
                        .on('accept', () => {
                            const cleanValue = cpfCnpjInput.value.replace(/\D/g, '');
                            section.querySelector('.cpf-cnpj-label').textContent = cleanValue.length <= 11 ? 'CPF:' : 'CNPJ:';
                            section.querySelector('.cpf-cnpj-type').value = cleanValue.length <= 11 ? 'CPF' : 'CNPJ';
                        });
                }
            };

            // --- INICIALIZAÇÃO GERAL ---
            const init = () => {
                setup.iMasks();
                setup.datepickers();
                setup.eventListeners();

                executadoCount++;
                ui.createExecutadoSection(executadoCount);

                // A inicialização agora carrega os dados locais e tenta sincronizar com o Firebase
                data.initializeAndSync();
            };

            init();
        });
    </script>
</body>

</html>


</body>

</html>