<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Parcelamento (com Firebase)</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        /* Estilos gerais */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .header {
            text-align: center;
            font-weight: bold;
            font-size: 1.8em;
            margin-bottom: 2rem;
            color: #343a40;
        }

        /* Seções e Campos */
        .inline-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1.25rem;
            gap: 10px;
        }

        .inline-section label {
            font-weight: 600;
            flex-basis: 200px;
            color: #495057;
        }

        .inline-section input,
        .inline-section select,
        .inline-section textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1em;
            min-width: 150px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .inline-section input:focus,
        .inline-section select:focus,
        .inline-section textarea:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
            outline: none;
        }

        /* Botões */
        .btn {
            display: block;
            width: auto;
            max-width: 280px;
            margin: 25px auto;
            padding: 12px 20px;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Executados */
        .executado-section {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            padding: 1rem;
            border-radius: 5px;
            background-color: #fdfdfd;
        }

        .executado-header {
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #007bff;
        }

        .remove-executado {
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }

        /* Feedback ao Usuário */
        #feedback-bar {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: 500;
            transition: opacity 0.5s;
            opacity: 1;
        }

        .feedback-success {
            background-color: #d4edda;
            color: #155724;
        }

        .feedback-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .feedback-info {
            background-color: #cce5ff;
            color: #004085;
        }

        /* Outros */
        .hidden {
            display: none;
        }

        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .ui-dialog {
            z-index: 1000 !important;
        }

        .small-inputs {
            font-size: 8px !important;
            margin-top: -12px;
        }

        .small-inputs input {
            height: 1px;
            padding: 5px;
            border-radius: 0px !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="feedback-bar">Aguardando conexão...</div>
        <div class="header">
            Pedido de Parcelamento (art. 916, do CPC)
        </div>

        <div class="inline-section">
            <label>Nº do Processo:</label>
            <input type="text" id="numero_processo">
        </div>
        <div id="executados-container">
            <!-- Seções de executados serão inseridas aqui -->
        </div>
        <button id="add-executado-button" class="btn btn-secondary">Adicionar Executado</button>
        <div class="inline-section">
            <label>Valor da Dívida (R$):</label>
            <input type="text" id="valor_original">
        </div>
        <div class="inline-section">
            <label for="data-atualizacao">Data p/ Atualização:</label>
            <input type="text" id="data-atualizacao">
        </div>
        <div id="indicesdiv" class="inline-section small-inputs">
            <label></label>
            <input type="text" id="indice-inicial" placeholder="Índice Inicial" readonly>
            <input type="text" id="indice-final" placeholder="Índice Final" readonly>
        </div>
        <div class="inline-section">
            <label></label>
            <label for="valor-correcao">Valor da Correção:</label>
            <input type="text" id="valor-correcao" name="valor-correcao" readonly>
            <label for="juros">Juros:</label>
            <input type="text" id="juros" name="juros" readonly>
        </div>
        <div class="inline-section">
            <label>Valor Atualizado (R$):</label>
            <input type="text" id="valor_divida" readonly>
        </div>
        <div class="inline-section">
            <label for="valorEntrada">Entrada (<span id="percentualEntrada">30%</span>)</label>
            <input type="text" id="valor_entrada" readonly>
            <button type="button" id="btnValorMaior">Mais que 30%?</button>
            <input type="number" id="novoValorEntrada" class="hidden" placeholder="Insira o valor">
        </div>
        <div class="inline-section">
            <label>Restante (R$):</label>
            <input type="text" id="valor_restante" readonly>
        </div>
        <div class="inline-section">
            <label>Parcelas:</label>
            <select id="parcelas">
                <option value="" disabled selected>Selecione</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
            </select>
        </div>
        <div class="inline-section">
            <label>Valor da Parcela:</label>
            <input type="text" id="valor_parcela" readonly>
        </div>
        <div class="inline-section">
            <label>Data de Início:</label>
            <input type="text" id="data_primeira_parcela">
        </div>
        <div class="inline-section">
            <label>Outros Pedidos:</label>
            <textarea id="outros_pedidos" rows="4"></textarea>
        </div>
        <div class="section hidden" id="datas_parcelas_section">
            <label style="font-weight: bold; margin-bottom: 10px; display: block;">Datas das Parcelas:</label>
            <div id="datas_parcelas"></div>
        </div>
        <button class="btn btn-primary" id="gerar-pdf-button">Gerar Petição em PDF</button>
    </div>

    <!-- Modal para inserção de índice -->
    <div id="modal-indice" title="Índice Não Encontrado" class="hidden">
        <p>O índice de <b id="mes-ano-faltante"></b> não foi encontrado.</p>
        <p>Por favor, consulte a Tabela Prática do TJSP e insira o valor para salvá-lo para todos os usuários:</p>
        <input type="text" id="novo-indice-valor" placeholder="Ex: 102.345678">
        <div id="indice-error" class="hidden" style="color: red; font-size: 0.9em;">Por favor, insira um número válido
            (use ponto ou vírgula como decimal).</div>
    </div>

    <!-- SDKs de Bibliotecas Externas -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <script>
        // ***************************************************************
        // COLE A CONFIGURAÇÃO DO SEU FIREBASE AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyCt_nhxZ6QviuIDCOBymHOVj9WSQAH66aE",
            authDomain: "indices-tjsp-app.firebaseapp.com",
            projectId: "indices-tjsp-app",
            storageBucket: "indices-tjsp-app.firebasestorage.app",
            messagingSenderId: "365047837931",
            appId: "1:365047837931:web:4ad35364e4473e241f7aae"
        };
        // ***************************************************************

        // --- Variáveis Globais ---
        let indices = {};
        let db;
        let executadoCount = 0;
        const maxExecutados = 4;
        const INDICES_DOC_REF = 'tabelaPrincipal';
        const INDICES_COLLECTION = 'indicesTJSP';

        document.addEventListener('DOMContentLoaded', () => {
            // --- Cache de Seletores do DOM ---
            const dom = {
                feedbackBar: document.getElementById('feedback-bar'),
                valorOriginal: document.getElementById('valor_original'),
                dataAtualizacao: document.getElementById('data-atualizacao'),
                indiceInicial: document.getElementById('indice-inicial'),
                indiceFinal: document.getElementById('indice-final'),
                valorCorrecao: document.getElementById('valor-correcao'),
                juros: document.getElementById('juros'),
                valorDivida: document.getElementById('valor_divida'),
                valorEntrada: document.getElementById('valor_entrada'),
                novoValorEntrada: document.getElementById('novoValorEntrada'),
                percentualEntrada: document.getElementById('percentualEntrada'),
                valorRestante: document.getElementById('valor_restante'),
                parcelasSelect: document.getElementById('parcelas'),
                valorParcela: document.getElementById('valor_parcela'),
                dataPrimeiraParcela: document.getElementById('data_primeira_parcela'),
                datasParcelasSection: document.getElementById('datas_parcelas_section'),
                datasParcelasContainer: document.getElementById('datas_parcelas'),
                executadosContainer: document.getElementById('executados-container'),
                addExecutadoButton: document.getElementById('add-executado-button'),
                btnValorMaior: document.getElementById('btnValorMaior'),
                gerarPdfButton: document.getElementById('gerar-pdf-button'),
                numeroProcesso: document.getElementById('numero_processo'),
                outrosPedidos: document.getElementById('outros_pedidos'),
            };

            // --- FUNÇÕES DE UI ---
            const ui = {
                updateFeedback: (message, type = 'info') => {
                    dom.feedbackBar.textContent = message;
                    dom.feedbackBar.className = `feedback-${type}`;
                    if (type !== 'error') {
                        setTimeout(() => {
                            if (dom.feedbackBar.textContent === message) {
                                dom.feedbackBar.textContent = 'Aplicação pronta para uso.';
                                dom.feedbackBar.className = 'feedback-info';
                            }
                        }, 5000);
                    }
                },
                showMissingIndexModal: (ano, mes) => {
                    return new Promise((resolve) => {
                        $("#mes-ano-faltante").text(`${mes}/${ano}`);
                        $("#novo-indice-valor").val('');
                        $("#indice-error").addClass('hidden');
                        $("#modal-indice").dialog({
                            modal: true, width: 450,
                            buttons: {
                                "Salvar e Continuar": async function () {
                                    const dialogInstance = $(this);
                                    const novoValorStr = $("#novo-indice-valor").val().replace(',', '.');
                                    const novoValor = parseFloat(novoValorStr);
                                    if (isNaN(novoValor) || novoValor <= 0) {
                                        $("#indice-error").removeClass('hidden'); return;
                                    }

                                    const success = await data.saveIndex(ano, mes, novoValor);

                                    // Resolve a Promise primeiro para garantir que o fluxo do cálculo continue ou pare
                                    if (success) {
                                        resolve(novoValor);
                                    } else {
                                        resolve(null);
                                    }

                                    // SEMPRE fecha o pop-up depois de resolver a promise, destravando a tela
                                    dialogInstance.dialog("close");
                                }
                            }
                        });
                    });
                },
                createExecutadoSection: (index) => {
                    const section = document.createElement('div');
                    section.classList.add('executado-section');
                    section.id = `executado-${index}`;
                    section.innerHTML = `
                        ${index > 1 ? `<div class="executado-header">Executado ${index} <span class="remove-executado" data-index="${index}">Remover</span></div>` : ''}
                        <div class="inline-section"><label>Nome do Executado:</label><input type="text" class="nome-executado" data-index="${index}"><input type="hidden" class="genero-executado" data-index="${index}" value=""></div>
                        <div class="inline-section"><label class="cpf-cnpj-label" data-index="${index}">CPF/CNPJ:</label><input type="text" class="cpf-cnpj" data-index="${index}"><input type="hidden" class="cpf-cnpj-type" data-index="${index}" value=""></div>
                        <div class="inline-section" style="justify-content: flex-start;"><label>Atualizar Endereço?</label><input type="checkbox" class="atualizar-endereco" data-index="${index}"></div>
                        <div class="inline-section hidden endereco-section" data-index="${index}"><label>CEP:</label><input type="text" class="cep" data-index="${index}" maxlength="9" placeholder="#####-###"></div>
                        <div class="inline-section hidden endereco-completo-section" data-index="${index}"><label>Rua:</label><input type="text" class="rua" data-index="${index}" readonly><label>Nº:</label><input type="text" class="numero" data-index="${index}" maxlength="6"></div>
                        <div class="inline-section hidden complemento-bairro-section" data-index="${index}"><label>Complemento:</label><input type="text" class="complemento" data-index="${index}"><label>Bairro:</label><input type="text" class="bairro" data-index="${index}" readonly></div>
                        <div class="inline-section hidden cidade-estado-section" data-index="${index}"><label>Cidade:</label><input type="text" class="cidade" data-index="${index}" readonly><label>Estado:</label><input type="text" class="estado" data-index="${index}" readonly></div>
                    `;
                    dom.executadosContainer.appendChild(section);
                    setup.addEventListenersToExecutado(index);
                }
            };

            // --- LÓGICA DE DADOS (FIREBASE) ---
            const data = {
                initializeFirebase: () => {
                    try {
                        if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "SUA_API_KEY") throw new Error("firebaseConfig não foi preenchido.");
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        db = firebase.firestore();
                        firebase.auth().signInAnonymously();
                        ui.updateFeedback('Conectado ao Banco de Dados.', 'success');
                        return true;
                    } catch (e) {
                        console.error("Erro ao inicializar o Firebase:", e.message);
                        ui.updateFeedback('Erro de conexão. A aplicação funcionará em modo offline.', 'error');
                        return false;
                    }
                },
                loadIndexes: async () => {
                    const indicesBase = {
                        "2024": { "01": 100.1, "02": 100.2, "03": 100.3, "04": 100.4, "05": 100.5, "06": 100.6, "07": 100.7 },
                        "2023": { "01": 95.1, "02": 95.2, "03": 95.3, "04": 95.4, "05": 95.5, "06": 95.6, "07": 95.7, "08": 95.8, "09": 95.9, "10": 96.0, "11": 96.1, "12": 96.2 }
                    };

                    if (!db) {
                        console.log("Firebase não conectado. Carregando índices de fallback.");
                        indices = indicesBase;
                        return;
                    }
                    try {
                        const docRef = db.collection(INDICES_COLLECTION).doc(INDICES_DOC_REF);
                        const doc = await docRef.get();
                        if (doc.exists && doc.data().indices) {
                            // Une os dados base com os do Firebase, com prioridade para os do Firebase
                            Object.keys(doc.data().indices).forEach(ano => {
                                if (!indicesBase[ano]) indicesBase[ano] = {};
                                Object.assign(indicesBase[ano], doc.data().indices[ano]);
                            });
                            indices = indicesBase;
                            console.log("Índices carregados do Firestore e unidos com o fallback local.");
                        } else {
                            indices = indicesBase;
                            console.log("Documento não encontrado no Firestore. Usando fallback local.");
                        }
                    } catch (error) {
                        console.error("Erro ao carregar índices do Firestore:", error);
                        ui.updateFeedback("Modo Offline. Usando índices de fallback locais. Índices novos não serão salvos.", 'error');
                        indices = indicesBase; // Carrega o fallback em caso de erro de conexão
                    }
                },
                saveIndex: async (ano, mes, valor) => {
                    if (!db) {
                        ui.updateFeedback("Modo Offline. O novo índice não pôde ser salvo na nuvem.", 'error');
                        // Salva apenas na memória local para a sessão atual
                        if (!indices[ano]) indices[ano] = {};
                        indices[ano][mes] = valor;
                        return true; // Retorna sucesso para a sessão atual
                    }

                    if (!indices[ano]) {
                        indices[ano] = {};
                    }
                    indices[ano][mes] = valor;

                    try {
                        const docRef = db.collection(INDICES_COLLECTION).doc(INDICES_DOC_REF);
                        await docRef.set({ indices: indices }, { merge: true });
                        ui.updateFeedback(`Índice para ${mes}/${ano} salvo com sucesso!`, 'success');
                        return true;
                    } catch (error) {
                        console.error("Erro ao salvar índice no Firebase:", error);
                        ui.updateFeedback("Erro ao salvar na nuvem. Verifique as REGRAS DE SEGURANÇA do Firestore.", 'error');
                        return false;
                    }
                }
            };

            // --- LÓGICA DE CÁLCULO E HELPERS ---
            const logic = {
                obterValorNumerico: (valor) => {
                    if (typeof valor !== 'string' || valor.trim() === '') return 0;
                    return parseFloat(valor.replace(/[^\d,-]/g, '').replace(',', '.'));
                },
                formatCurrency: (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                formatDate: (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                },
                parseDate: (input) => {
                    if (!input || !/^\d{2}\/\d{2}\/\d{4}$/.test(input)) return new Date(NaN);
                    const parts = input.split('/');
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                },
                getIndex: async (ano, mes) => {
                    const index = indices[ano]?.[mes];
                    if (index) return index;
                    const newIndex = await ui.showMissingIndexModal(ano, mes);
                    return newIndex;
                },
                handleCalculationTrigger: async () => {
                    const valorOriginalNum = logic.obterValorNumerico(dom.valorOriginal.value);
                    if (valorOriginalNum > 0 && dom.dataAtualizacao.value.length >= 10) {
                        await logic.updateDebt();
                    }
                },
                updateDebt: async () => {
                    ui.updateFeedback('Calculando...', 'info');
                    const [day, mes, ano] = dom.dataAtualizacao.value.split('/');
                    const dataAtual = new Date();
                    const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
                    const anoAtual = String(dataAtual.getFullYear());

                    const indiceInicial = await logic.getIndex(ano, mes);
                    if (!indiceInicial) {
                        ui.updateFeedback("Cálculo cancelado. Índice inicial não fornecido.", 'error');
                        return;
                    }

                    const indiceFinal = await logic.getIndex(anoAtual, mesAtual);
                    if (!indiceFinal) {
                        ui.updateFeedback("Cálculo cancelado. Índice final não fornecido.", 'error');
                        return;
                    }

                    const valorOriginal = logic.obterValorNumerico(dom.valorOriginal.value);
                    const valorAtualizado = (valorOriginal * indiceFinal / indiceInicial);
                    dom.valorCorrecao.value = logic.formatCurrency(valorAtualizado - valorOriginal);

                    const dataAtualizacaoDate = logic.parseDate(dom.dataAtualizacao.value);
                    const diffTime = Math.abs(dataAtual - dataAtualizacaoDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const taxaDiaria = Math.pow(1.01, 1 / 30) - 1;
                    const juros = valorAtualizado * (Math.pow(1 + taxaDiaria, diffDays) - 1);
                    const valorCorrigido = valorAtualizado + juros;
                    const porcentagemJuros = ((Math.pow(1 + taxaDiaria, diffDays) - 1) * 100).toFixed(2);

                    dom.valorDivida.value = logic.formatCurrency(valorCorrigido);
                    dom.juros.value = `${logic.formatCurrency(juros)} (${porcentagemJuros.replace('.', ',')}%)`;
                    dom.indiceInicial.value = `Índice inicial: ${indiceInicial} (${mes}/${ano})`;
                    dom.indiceFinal.value = `Índice final: ${indiceFinal} (${mesAtual}/${anoAtual})`;

                    const valorEntrada = valorCorrigido * 0.3;
                    dom.valorEntrada.value = logic.formatCurrency(valorEntrada);
                    dom.datasParcelasSection.classList.remove('hidden');
                    logic.updateInstallments();
                    ui.updateFeedback('Cálculo concluído.', 'success');
                },
                updateInstallments: () => {
                    const valorDivida = logic.obterValorNumerico(dom.valorDivida.value);
                    if (isNaN(valorDivida) || valorDivida <= 0) return;

                    let valorEntrada = logic.obterValorNumerico(dom.valorEntrada.value);
                    if (dom.novoValorEntrada.value) {
                        const novoValor = parseFloat(dom.novoValorEntrada.value);
                        if (!isNaN(novoValor) && novoValor >= (valorDivida * 0.3)) {
                            valorEntrada = novoValor;
                        }
                    }

                    const valorRestante = valorDivida - valorEntrada;
                    dom.valorRestante.value = logic.formatCurrency(valorRestante);

                    const parcelas = parseInt(dom.parcelasSelect.value);
                    if (isNaN(parcelas) || parcelas < 1) {
                        dom.valorParcela.value = '';
                        dom.datasParcelasContainer.innerHTML = '';
                        return;
                    }

                    const valorParcela = valorRestante / parcelas;
                    dom.valorParcela.value = logic.formatCurrency(valorParcela);

                    const dataPrimeiraParcela = logic.parseDate(dom.dataPrimeiraParcela.value);
                    if (isNaN(dataPrimeiraParcela.getTime())) return;

                    dom.datasParcelasContainer.innerHTML = '';
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.textAlign = 'center';
                    table.innerHTML = `<thead><tr><th>#</th><th>Data</th><th>Valor (c/ juros)</th></tr></thead>`;
                    const tbody = document.createElement('tbody');

                    for (let i = 0; i < parcelas; i++) {
                        let dataParcela = new Date(dataPrimeiraParcela);
                        dataParcela.setMonth(dataPrimeiraParcela.getMonth() + i);
                        while (dataParcela.getDay() === 0 || dataParcela.getDay() === 6) {
                            dataParcela.setDate(dataParcela.getDate() + 1);
                        }
                        const valorParcelaComJuros = (valorRestante / parcelas) * Math.pow(1.01, i + 1);
                        tbody.innerHTML += `<tr><td>${i + 1}</td><td>${logic.formatDate(dataParcela)}</td><td>${logic.formatCurrency(valorParcelaComJuros)}</td></tr>`;
                    }
                    table.appendChild(tbody);
                    dom.datasParcelasContainer.appendChild(table);
                },
                // Sua lógica de validação de formulário e generatePDF aqui
            };

            // --- INICIALIZAÇÃO E EVENT LISTENERS ---
            const setup = {
                iMasks: () => {
                    IMask(dom.numeroProcesso, { mask: '0000000-00.0000.0.00.0000' });
                    IMask(dom.valorOriginal, { mask: Number, scale: 2, thousandsSeparator: '.', padFractionalZeros: true, normalizeZeros: true, radix: ',' });
                },
                datepickers: () => {
                    $.datepicker.setDefaults($.datepicker.regional['pt-BR'] = {
                        closeText: 'Fechar', prevText: '&#x3C;Anterior', nextText: 'Próximo&#x3E;', currentText: 'Hoje', monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'], monthNamesShort: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'], dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'], dayNamesMin: ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'], dateFormat: 'dd/mm/yy', firstDay: 0
                    });

                    const hoje = new Date();
                    $(dom.dataPrimeiraParcela).datepicker({ dateFormat: "dd/mm/yy", minDate: 0, beforeShowDay: $.datepicker.noWeekends });
                    const dataDefault = new Date();
                    dataDefault.setMonth(hoje.getMonth() + 1);
                    dom.dataPrimeiraParcela.value = logic.formatDate(dataDefault);

                    $(dom.dataAtualizacao).datepicker({ dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true, showOn: "button", buttonImage: "https://jqueryui.com/resources/demos/datepicker/images/calendar.gif", buttonImageOnly: true });
                },
                eventListeners: () => {
                    dom.valorOriginal.addEventListener('change', logic.handleCalculationTrigger);
                    dom.dataAtualizacao.addEventListener('change', logic.handleCalculationTrigger);
                    dom.parcelasSelect.addEventListener('change', logic.updateInstallments);
                    dom.dataPrimeiraParcela.addEventListener('change', logic.updateInstallments);

                    // Lógica de formatação e autocomplete da data
                    dom.dataAtualizacao.addEventListener('input', (e) => {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 2) value = value.slice(0, 2) + '/' + value.slice(2);
                        if (value.length > 5) value = value.slice(0, 5) + '/' + value.slice(5, 9);
                        e.target.value = value;
                    });
                    dom.dataAtualizacao.addEventListener('blur', (e) => {
                        let value = e.target.value;
                        if (value.length >= 10 || value.length === 0) return;

                        const parts = value.split('/').filter(p => p.length > 0);
                        const hoje = new Date();
                        const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
                        const anoAtual = hoje.getFullYear();

                        let finalDate = '';
                        if (parts.length === 1) { // Apenas dia
                            finalDate = `${parts[0].padStart(2, '0')}/${mesAtual}/${anoAtual}`;
                        } else if (parts.length === 2) { // Dia e mês
                            finalDate = `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${anoAtual}`;
                        }

                        if (finalDate) {
                            e.target.value = finalDate;
                            dom.dataAtualizacao.dispatchEvent(new Event('change')); // Dispara o cálculo
                        }
                    });

                    dom.btnValorMaior.addEventListener('click', () => {
                        dom.novoValorEntrada.classList.remove('hidden');
                        dom.novoValorEntrada.focus();
                    });

                    dom.novoValorEntrada.addEventListener('change', function () {
                        const valorDivida = logic.obterValorNumerico(dom.valorDivida.value);
                        if (valorDivida === 0) return;
                        const novoValor = parseFloat(this.value);
                        if (isNaN(novoValor) || novoValor < (valorDivida * 0.3)) {
                            ui.updateFeedback(`Valor de entrada deve ser no mínimo ${logic.formatCurrency(valorDivida * 0.3)}`, 'error');
                            this.value = '';
                            return;
                        }
                        dom.valorEntrada.value = logic.formatCurrency(novoValor);
                        dom.percentualEntrada.textContent = `${((novoValor / valorDivida) * 100).toFixed(2).replace('.', ',')}%`;
                        logic.updateInstallments();
                    });

                    dom.addExecutadoButton.addEventListener('click', () => {
                        if (executadoCount < maxExecutados) {
                            executadoCount++;
                            ui.createExecutadoSection(executadoCount);
                            if (executadoCount === maxExecutados) {
                                dom.addExecutadoButton.style.display = 'none';
                            }
                        }
                    });

                    dom.gerarPdfButton.addEventListener('click', () => {
                        // Sua lógica de validação aqui antes de chamar generatePDF
                        // if(logic.validateForm()) { logic.generatePDF(); }
                        ui.updateFeedback("Gerando PDF... (Lógica a ser implementada)", "info");
                    });
                },
                addEventListenersToExecutado: (index) => {
                    const section = document.getElementById(`executado-${index}`);
                    if (!section) return;

                    const removeButton = section.querySelector(`.remove-executado`);
                    if (removeButton) {
                        removeButton.addEventListener('click', function () {
                            section.remove();
                            executadoCount--;
                            dom.addExecutadoButton.style.display = 'block';
                        });
                    }

                    section.querySelector(`.atualizar-endereco`).addEventListener('change', function () {
                        const sectionsToToggle = [`.endereco-section`, `.endereco-completo-section`, `.complemento-bairro-section`, `.cidade-estado-section`];
                        sectionsToToggle.forEach(selector => {
                            section.querySelector(selector).classList.toggle('hidden', !this.checked);
                        });
                    });

                    section.querySelector('.nome-executado').addEventListener('blur', function () {
                        const nomeExecutado = this.value.split(' ')[0];
                        if (!nomeExecutado) return;
                        fetch(`https://api.genderize.io?name=${nomeExecutado}&country_id=BR`)
                            .then(response => response.json())
                            .then(gData => { section.querySelector(`.genero-executado`).value = (gData.gender && gData.probability >= 0.8) ? gData.gender : 'unknown'; })
                            .catch(error => console.error('Erro no Genderize:', error));
                    });

                    const cepInput = section.querySelector(`.cep`);
                    cepInput.addEventListener('input', function () {
                        this.value = this.value.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2');
                        if (this.value.length === 9) {
                            fetch(`https://viacep.com.br/ws/${this.value.replace('-', '')}/json/`)
                                .then(response => response.json())
                                .then(cepData => {
                                    if (!cepData.erro) {
                                        section.querySelector(`.rua`).value = cepData.logouro;
                                        section.querySelector(`.bairro`).value = cepData.bairro;
                                        section.querySelector(`.cidade`).value = cepData.localidade;
                                        section.querySelector(`.estado`).value = cepData.uf;
                                        section.querySelector(`.numero`).focus();
                                    } else { ui.updateFeedback('CEP não encontrado.', 'error'); }
                                }).catch(error => console.error('Erro no ViaCEP:', error));
                        }
                    });

                    const cpfCnpjInput = section.querySelector(`.cpf-cnpj`);
                    IMask(cpfCnpjInput, { mask: [{ mask: '000.000.000-00' }, { mask: '00.000.000/0000-00' }] })
                        .on('accept', () => {
                            const cleanValue = cpfCnpjInput.value.replace(/\D/g, '');
                            section.querySelector('.cpf-cnpj-label').textContent = cleanValue.length <= 11 ? 'CPF:' : 'CNPJ:';
                            section.querySelector('.cpf-cnpj-type').value = cleanValue.length <= 11 ? 'CPF' : 'CNPJ';
                        });
                }
            };

            // --- INICIALIZAÇÃO GERAL ---
            const init = async () => {
                setup.iMasks();
                setup.datepickers();
                setup.eventListeners();

                executadoCount++;
                ui.createExecutadoSection(executadoCount);

                if (data.initializeFirebase()) {
                    await data.loadIndexes();
                } else {
                    // Se o firebase não inicializar, carrega o fallback mesmo assim
                    await data.loadIndexes();
                }
                ui.updateFeedback('Aplicação pronta para uso.', 'info');
            };

            init();
        });
    </script>
</body>

</html>