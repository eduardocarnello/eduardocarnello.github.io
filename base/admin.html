<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Ajusta a altura do editor Quill */
        #editor-container {
            height: 350px;
        }

        .ql-toolbar {
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }

        .ql-container {
            border-radius: 0 0 0.5rem 0.5rem !important;
        }

        /* Foco personalizado para acessibilidade */
        .focus-ring-visible:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }
    </style>
</head>

<body class="bg-slate-100">

    <!-- Seção de Login (Visível por padrão) -->
    <section id="login-section"
        class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-xl">
            <div>
                <svg class="mx-auto h-12 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18c-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                </svg>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Acessar Painel Admin
                </h2>
            </div>

            <!-- Mensagem de Erro/Status -->
            <div id="login-status" class="text-center text-red-500 font-medium"></div>

            <!-- Formulário de Login -->
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="login-email" class="sr-only">Email</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required
                            class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Endereço de e-mail">
                    </div>
                    <div>
                        <label for="login-password" class="sr-only">Senha</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password"
                            required
                            class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Senha">
                    </div>
                </div>

                <div>
                    <button type="submit"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Entrar
                    </button>
                </div>
            </form>

            <!-- Divisor "OU" -->
            <div class="relative flex py-3 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-500">OU</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <!-- Botão Login Google -->
            <div>
                <button id="google-login-btn"
                    class="group relative w-full flex justify-center py-3 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    <img class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg"
                        alt="Google icon">
                    Entrar com Google
                </button>
            </div>

            <!-- Link para o Site -->
            <div class="text-center mt-6">
                <a href="index.html"
                    class="text-sm font-medium text-blue-600 hover:text-blue-500 transition-colors focus-ring-visible rounded-md">
                    &larr; Voltar para o Site
                </a>
            </div>

        </div>
    </section>

    <!-- Seção de Administração (Oculta por padrão) -->
    <section id="admin-dashboard" class="hidden">

        <!-- Header do Admin -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18c-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                        </svg>
                        <span class="ml-3 text-2xl font-bold text-slate-800">Painel Admin</span>
                    </div>
                    <!-- Info Usuário e Botões -->
                    <div class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-slate-600 hidden sm:block"></span>
                        <a href="index.html" target="_blank"
                            class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors focus-ring-visible rounded-md p-1">
                            Ver Site
                        </a>
                        <button id="logout-btn"
                            class="text-sm font-medium text-red-600 hover:text-red-800 transition-colors focus-ring-visible rounded-md p-1">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal do Admin -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- Mensagem de Status (Salvo, Erro, etc) -->
            <div id="admin-status"
                class="hidden fixed top-20 right-8 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50">
                Mensagem de sucesso!
            </div>

            <!-- Grid Principal -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Coluna Principal (Formulário de Artigo e Lista) -->
                <div class="lg:col-span-2 space-y-8">

                    <!-- Formulário de Artigo -->
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                        <h2 id="article-form-title" class="text-2xl font-bold text-slate-800 mb-6">Adicionar Novo Artigo
                        </h2>
                        <form id="article-form" class="space-y-6">

                            <!-- Título -->
                            <div>
                                <label for="article-title"
                                    class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                                <input type="text" id="article-title" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Categoria -->
                            <div>
                                <label for="article-category"
                                    class="block text-sm font-medium text-slate-700 mb-1">Categoria</label>
                                <select id="article-category" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="">Carregando categorias...</option>
                                    <!-- Categorias preenchidas pelo JS -->
                                </select>
                            </div>

                            <!-- Resumo -->
                            <div>
                                <label for="article-summary"
                                    class="block text-sm font-medium text-slate-700 mb-1">Resumo (Max 250
                                    caracteres)</label>
                                <textarea id="article-summary" rows="3" maxlength="250" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>

                            <!-- Link -->
                            <div>
                                <label for="article-link" class="block text-sm font-medium text-slate-700 mb-1">Link de
                                    Referência (Opcional)</label>
                                <input type="url" id="article-link" placeholder="https://exemplo.com/referencia"
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Data de Publicação -->
                            <div>
                                <label for="article-published-at"
                                    class="block text-sm font-medium text-slate-700 mb-1">Data de Publicação
                                    (Opcional)</label>
                                <input type="date" id="article-published-at"
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-slate-500 mt-1">Se vazio, usa a data atual na criação. Se
                                    editando, mantém a data original.</p>
                            </div>

                            <!-- Tags -->
                            <div>
                                <label for="article-tags" class="block text-sm font-medium text-slate-700 mb-1">Tags
                                    (Separadas por vírgula)</label>
                                <input type="text" id="article-tags" placeholder="ex: provimento, prazo, novo sistema"
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Editor de Conteúdo -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Conteúdo Completo</label>
                                <div id="editor-container"></div> <!-- Container do Quill -->
                                <!-- Ajuda para Imagens -->
                                <p class="text-xs text-slate-500 mt-2">
                                    <b>Para adicionar imagens:</b> Publique a imagem em um site (como
                                    <a href="https://imgur.com/upload" target="_blank"
                                        class="text-blue-600 hover:underline">Imgur</a> ou
                                    <a href="https://postimages.org/" target="_blank"
                                        class="text-blue-600 hover:underline">Postimages</a>),
                                    copie o link direto da imagem (ex: .jpg, .png) e cole-o usando o ícone de imagem
                                    <svg class="w-4 h-4 inline -mt-1" xmlns="http://www.w3.org/2000/svg" fill="none"
                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                    </svg>
                                    na barra de ferramentas.
                                </p>
                            </div>

                            <!-- ID Oculto (para edição) -->
                            <input type="hidden" id="article-id">
                            <!-- Data Original Oculta (para edição) -->
                            <input type="hidden" id="article-original-published-at">

                            <!-- Botões -->
                            <div class="flex gap-4">
                                <button type="submit"
                                    class="flex-1 py-3 px-6 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    Salvar Artigo
                                </button>
                                <button type="button" id="cancel-edit-btn"
                                    class="hidden flex-1 py-3 px-6 border border-slate-300 text-base font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition-colors">
                                    Cancelar Edição
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Artigos -->
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Artigos Publicados</h2>
                        <div id="articles-list-admin" class="space-y-4">
                            <p id="articles-loading-msg" class="text-slate-500">
                                <svg class="inline w-5 h-5 animate-spin mr-2" xmlns="http://www.w3.org/2000/svg"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                Carregando artigos...
                            </p>
                            <!-- Lista preenchida pelo JS -->
                        </div>
                    </div>
                </div>

                <!-- Coluna Lateral (Gerenciar Categorias) -->
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg sticky top-24">
                        <h2 id="category-form-title" class="text-2xl font-bold text-slate-800 mb-6">Gerenciar Categorias
                        </h2>

                        <!-- Formulário de Categoria -->
                        <form id="category-form" class="space-y-4 mb-8">
                            <div>
                                <label for="category-name" class="block text-sm font-medium text-slate-700 mb-1">Nome da
                                    Categoria</label>
                                <input type="text" id="category-name" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Cor -->
                                <div>
                                    <label for="category-color"
                                        class="block text-sm font-medium text-slate-700 mb-1">Cor</label>
                                    <select id="category-color"
                                        class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <option value="slate">Cinza (Slate)</option>
                                        <option value="red">Vermelho (Red)</option>
                                        <option value="orange">Laranja (Orange)</option>
                                        <option value="yellow">Amarelo (Yellow)</option>
                                        <option value="green">Verde (Green)</option>
                                        <option value="blue">Azul (Blue)</option>
                                        <option value="indigo">Índigo (Indigo)</option>
                                        <option value="purple">Roxo (Purple)</option>
                                        <option value="pink">Rosa (Pink)</option>
                                    </select>
                                </div>
                                <!-- Ícone -->
                                <div>
                                    <label for="category-icon"
                                        class="block text-sm font-medium text-slate-700 mb-1">Ícone</label>
                                    <select id="category-icon"
                                        class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <option value="book">Livro (book)</option>
                                        <option value="bolt">Raio (bolt)</option>
                                        <option value="gavel">Conformidade (gavel)</option>
                                        <option value="alert">Alerta (alert)</option>
                                        <option value="info">Info (info)</option>
                                        <option value="users">Usuários (users)</option>
                                        <option value="list">Lista (list)</option>
                                        <option value="file">Arquivo (file)</option>
                                        <option value="chart-bar">Gráfico (chart-bar)</option>
                                        <option value="chat-alt">Chat (chat-alt)</option>
                                        <option value="cog">Engrenagem (cog)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- ID Oculto (para edição) -->
                            <input type="hidden" id="category-id">

                            <!-- Botões -->
                            <div class="flex gap-4">
                                <button type="submit"
                                    class="flex-1 py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    Salvar Categoria
                                </button>
                                <button type="button" id="cancel-category-edit-btn"
                                    class="hidden flex-1 py-2 px-4 border border-slate-300 text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </form>

                        <!-- Lista de Categorias -->
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Categorias Atuais</h3>
                        <div id="category-list-admin" class="space-y-3">
                            <p id="categories-loading-msg" class="text-slate-500">
                                <svg class="inline w-5 h-5 animate-spin mr-2" xmlns="http://www.w3.org/2000/svg"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                Carregando categorias...
                            </p>
                            <!-- Lista preenchida pelo JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase (APENAS AUTH)
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            getIdToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ** Firestore NÃO é mais importado aqui **

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChhpPXpLTFGQfvJH55D_uQ2FG5PdKykcQ",
            authDomain: "minha-base-conhecimento.firebaseapp.com",
            projectId: "minha-base-conhecimento",
            storageBucket: "minha-base-conhecimento.firebasestorage.app",
            messagingSenderId: "586899421039",
            appId: "1:586899421039:web:99be661136602118175a9a"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        setLogLevel('Debug'); // Habilita logs detalhados no console

        // E-mails Admin (para proteção de rota)
        const adminEmails = ['eduardocarnello@gmail.com', 'mariliajec@tjsp.jus.br'];

        // --- REFERÊNCIAS DO DOM ---
        const loginSection = document.getElementById('login-section');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginStatus = document.getElementById('login-status');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const adminStatus = document.getElementById('admin-status');

        // Formulário de Artigo
        const articleForm = document.getElementById('article-form');
        const articleFormTitle = document.getElementById('article-form-title');
        const articleTitle = document.getElementById('article-title');
        const articleCategory = document.getElementById('article-category');
        const articleSummary = document.getElementById('article-summary');
        const articleLink = document.getElementById('article-link');
        const articlePublishedAt = document.getElementById('article-published-at');
        const articleOriginalPublishedAt = document.getElementById('article-original-published-at');
        const articleTags = document.getElementById('article-tags');
        const articleIdInput = document.getElementById('article-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const articlesListAdmin = document.getElementById('articles-list-admin');
        const articlesLoadingMsg = document.getElementById('articles-loading-msg');

        // Formulário de Categoria
        const categoryForm = document.getElementById('category-form');
        const categoryFormTitle = document.getElementById('category-form-title');
        const categoryName = document.getElementById('category-name');
        const categoryColor = document.getElementById('category-color');
        const categoryIcon = document.getElementById('category-icon');
        const categoryIdInput = document.getElementById('category-id');
        const cancelCategoryEditBtn = document.getElementById('cancel-category-edit-btn');
        const categoryListAdmin = document.getElementById('category-list-admin');
        const categoriesLoadingMsg = document.getElementById('categories-loading-msg');

        // Editor Quill
        let quill;
        let currentUser = null; // Armazena o usuário logado

        function initializeQuill() {
            if (!quill) {
                const toolbarOptions = [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'blockquote', 'code-block'],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ];
                quill = new Quill('#editor-container', {
                    modules: {
                        toolbar: toolbarOptions
                    },
                    theme: 'snow'
                });
            }
        }

        // --- NOVA FUNÇÃO: fetchWithToken ---
        async function fetchWithToken(url, options = {}) {
            if (!currentUser) {
                throw new Error("Usuário não autenticado.");
            }

            const token = await getIdToken(currentUser);
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            const response = await fetch(url, { ...options, headers });

            if (!response.ok) {
                const errorData = await response.json();
                console.error(`Erro na API (${response.status}):`, errorData.error);
                if (response.status === 401) {
                    alert('Sua sessão expirou ou você não é um administrador. Por favor, faça login novamente.');
                    await signOut(auth);
                }
                throw new Error(errorData.error || 'Erro na requisição');
            }
            return response.json();
        }


        // --- AUTENTICAÇÃO (COM PROTEÇÃO DE ROTA) ---

        onAuthStateChanged(auth, (user) => {
            currentUser = user; // Armazena o usuário globalmente
            if (user) {
                // Checagem de permissão de Admin
                if (adminEmails.includes(user.email)) {
                    // É Admin: Mostra o painel
                    loginSection.classList.add('hidden');
                    adminDashboard.classList.remove('hidden');
                    userEmailSpan.textContent = user.email;
                    initializeQuill(); // Inicializa o editor SÓ quando logado

                    // Carrega os dados (categorias e artigos)
                    loadCategories();
                    loadArticles();
                } else {
                    // Não é Admin: Redireciona para o index
                    alert('Acesso negado. Você não tem permissão para acessar esta página.');
                    window.location.href = 'index.html';
                }
            } else {
                // Usuário está deslogado
                loginSection.classList.remove('hidden');
                adminDashboard.classList.add('hidden');
                userEmailSpan.textContent = '';
                if (quill) {
                    quill.root.innerHTML = ''; // Limpa o editor
                }
            }
        });

        // Login com E-mail/Senha
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loginStatus.textContent = 'Entrando...';
            signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value)
                .then(() => {
                    loginStatus.textContent = '';
                    loginForm.reset();
                })
                .catch((error) => {
                    console.error("Erro de login:", error.code, error.message);
                    if (error.code === 'auth/invalid-credential') {
                        loginStatus.textContent = 'E-mail ou senha inválidos.';
                    } else {
                        loginStatus.textContent = 'Erro ao tentar fazer login.';
                    }
                });
        });

        // Login com Google
        googleLoginBtn.addEventListener('click', () => {
            loginStatus.textContent = 'Abrindo popup do Google...';
            signInWithPopup(auth, googleProvider)
                .catch((error) => {
                    console.error("Erro ao logar com Google:", error);
                    loginStatus.textContent = 'Erro ao logar com Google.';
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja sair?')) {
                signOut(auth).catch((error) => {
                    console.error("Erro ao sair:", error);
                    showStatusMessage('Erro ao tentar sair.', true);
                });
            }
        });


        // --- GERENCIAMENTO DE CATEGORIAS (CRUD via API) ---

        let allCategoriesMap = new Map();

        // Salvar/Atualizar Categoria
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const categoryData = {
                name: categoryName.value,
                color: categoryColor.value,
                icon: categoryIcon.value,
                slug: slugify(categoryName.value)
            };

            if (id) {
                categoryData.id = id; // Inclui o ID para atualização
            }

            try {
                await fetchWithToken('/api/admin/salvarCategoria', {
                    method: 'POST',
                    body: JSON.stringify(categoryData)
                });
                showStatusMessage(id ? 'Categoria atualizada com sucesso!' : 'Categoria salva com sucesso!');
                resetCategoryForm();
                await loadCategories(); // Recarrega as categorias
            } catch (error) {
                console.error("Erro ao salvar categoria: ", error);
                showStatusMessage(`Erro ao salvar categoria: ${error.message}`, true);
            }
        });

        // Carregar Categorias
        async function loadCategories() {
            categoriesLoadingMsg.classList.remove('hidden');
            try {
                const categories = await fetchWithToken('/api/getCategorias');

                categoriesLoadingMsg.classList.add('hidden');
                categoryListAdmin.innerHTML = '';
                articleCategory.innerHTML = '<option value="">-- Selecione uma categoria --</option>';
                allCategoriesMap.clear();

                categories.forEach(category => {
                    allCategoriesMap.set(category.id, category);

                    // Popula a lista do admin
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-3 bg-slate-50 rounded-lg';
                    el.innerHTML = `
                        <span class="font-medium text-slate-700">${category.name}</span>
                        <div class="flex gap-2">
                            <button data-id="${category.id}" class="edit-category-btn text-blue-600 hover:text-blue-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button data-id="${category.id}" class="delete-category-btn text-red-600 hover:text-red-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    categoryListAdmin.appendChild(el);

                    // Popula o dropdown do formulário de artigo
                    const opt = document.createElement('option');
                    opt.value = category.id;
                    opt.textContent = category.name;
                    articleCategory.appendChild(opt);
                });

                if (categories.length === 0) {
                    categoriesLoadingMsg.textContent = 'Nenhuma categoria encontrada.';
                    categoriesLoadingMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao carregar categorias:", error);
                categoriesLoadingMsg.textContent = `Erro ao carregar categorias: ${error.message}`;
            }
        }

        // Delegação de Eventos para botões de Categoria
        categoryListAdmin.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-category-btn');
            const deleteBtn = e.target.closest('.delete-category-btn');

            if (editBtn) {
                const id = editBtn.dataset.id;
                populateCategoryForm(id);
            }
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                deleteCategory(id);
            }
        });

        // Preencher formulário de Categoria para edição
        function populateCategoryForm(id) {
            const category = allCategoriesMap.get(id);
            if (category) {
                categoryFormTitle.textContent = 'Editar Categoria';
                categoryIdInput.value = id;
                categoryName.value = category.name;
                categoryColor.value = category.color;
                categoryIcon.value = category.icon;
                cancelCategoryEditBtn.classList.remove('hidden');
                window.scrollTo({ top: categoryForm.offsetTop, behavior: 'smooth' });
            }
        }

        // Deletar Categoria
        async function deleteCategory(id) {
            const category = allCategoriesMap.get(id);
            if (confirm(`Tem certeza que quer deletar a categoria "${category.name}"?\nATENÇÃO: Artigos nesta categoria ficarão órfãos.`)) {
                try {
                    await fetchWithToken('/api/admin/deletarCategoria', {
                        method: 'POST',
                        body: JSON.stringify({ id })
                    });
                    showStatusMessage('Categoria deletada.');
                    resetCategoryForm(); // Caso estivesse editando
                    await loadCategories(); // Recarrega
                } catch (error) {
                    console.error("Erro ao deletar categoria: ", error);
                    showStatusMessage(`Erro ao deletar categoria: ${error.message}`, true);
                }
            }
        }

        // Limpar formulário de Categoria
        function resetCategoryForm() {
            categoryForm.reset();
            categoryIdInput.value = '';
            categoryFormTitle.textContent = 'Gerenciar Categorias';
            cancelCategoryEditBtn.classList.add('hidden');
        }
        cancelCategoryEditBtn.addEventListener('click', resetCategoryForm);


        // --- GERENCIAMENTO DE ARTIGOS (CRUD via API) ---

        // Salvar/Atualizar Artigo
        articleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = articleIdInput.value;
            const publishedDate = articlePublishedAt.value;
            const originalPublishedDate = articleOriginalPublishedAt.value; // Pega a data original (se houver)

            // Processa as tags: string -> array
            const tagsArray = articleTags.value
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);

            const articleData = {
                title: articleTitle.value,
                categoryId: articleCategory.value,
                summary: articleSummary.value,
                link: articleLink.value || '',
                tags: tagsArray,
                content: quill.root.innerHTML, // Pega o HTML do Quill
                slug: slugify(articleTitle.value),
            };

            // Lógica da Data de Publicação
            if (publishedDate) {
                // Se uma data foi explicitamente setada, usa ela (com ajuste de fuso)
                articleData.publishedAt = new Date(publishedDate + 'T12:00:00').toISOString();
            } else if (id && originalPublishedDate) {
                // Se é uma EDIÇÃO e a data foi APAGADA, mantém a data original
                articleData.publishedAt = originalPublishedDate;
            } else if (!id) {
                // Se é uma CRIAÇÃO e a data está VAZIA, o servidor usará a data atual
                // Não enviamos 'publishedAt', a API vai tratar
            }

            if (id) {
                articleData.id = id; // Inclui o ID para atualização
            }

            try {
                await fetchWithToken('/api/admin/salvarArtigo', {
                    method: 'POST',
                    body: JSON.stringify(articleData)
                });
                showStatusMessage(id ? 'Artigo atualizado com sucesso!' : 'Artigo salvo com sucesso!');
                resetArticleForm();
                await loadArticles(); // Recarrega os artigos
            } catch (error) {
                console.error("Erro ao salvar artigo: ", error);
                showStatusMessage(`Erro ao salvar artigo: ${error.message}`, true);
            }
        });

        // Carregar Artigos (para o Admin)
        async function loadArticles() {
            articlesLoadingMsg.classList.remove('hidden');
            try {
                // Admin pode carregar todos os artigos de uma vez para gerenciar
                const articles = await fetchWithToken('/api/getArtigos?limit=1000');

                articlesLoadingMsg.classList.add('hidden');
                articlesListAdmin.innerHTML = '';

                articles.forEach(article => {
                    const category = allCategoriesMap.get(article.categoryId);
                    const categoryName = category ? category.name : 'Sem Categoria';

                    const date = article.publishedAt
                        ? new Date(article.publishedAt.seconds * 1000).toLocaleDateString('pt-BR')
                        : 'Salvando...';

                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-4 bg-slate-50 rounded-lg';
                    el.innerHTML = `
                        <div>
                            <strong class="text-slate-800">${article.title}</strong>
                            <span class="block text-sm text-slate-500">${categoryName} - ${date}</span>
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            <button data-id="${article.id}" class="edit-article-btn text-blue-600 hover:text-blue-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button data-id="${article.id}" data-title="${article.title}" class="delete-article-btn text-red-600 hover:text-red-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    articlesListAdmin.appendChild(el);
                });

                if (articles.length === 0) {
                    articlesLoadingMsg.textContent = 'Nenhum artigo encontrado.';
                    articlesLoadingMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao carregar artigos:", error);
                articlesLoadingMsg.textContent = `Erro ao carregar artigos: ${error.message}`;
            }
        }

        // Delegação de Eventos para botões de Artigo
        articlesListAdmin.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-article-btn');
            const deleteBtn = e.target.closest('.delete-article-btn');

            if (editBtn) {
                const id = editBtn.dataset.id;
                populateArticleForm(id);
            }
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const title = deleteBtn.dataset.title;
                deleteArticle(id, title);
            }
        });

        // Preencher formulário de Artigo para edição
        async function populateArticleForm(id) {
            try {
                // A lista de artigos (loadArticles) não tem o 'content'.
                // Precisamos buscar o artigo completo na API de detalhes.
                const article = await fetchWithToken(`/api/getArtigoDetalhe?id=${id}`);

                articleFormTitle.textContent = 'Editar Artigo';
                articleIdInput.value = id;
                articleTitle.value = article.title;
                articleCategory.value = article.categoryId;
                articleSummary.value = article.summary;
                articleLink.value = article.link || '';
                articleTags.value = (article.tags || []).join(', ');

                if (article.publishedAt) {
                    // Converte o timestamp (segundos) para o formato YYYY-MM-DD
                    const date = new Date(article.publishedAt.seconds * 1000);
                    const dateString = date.toISOString().split('T')[0];
                    articlePublishedAt.value = dateString;
                    // Armazena a data original (em formato ISO)
                    articleOriginalPublishedAt.value = date.toISOString();
                } else {
                    articlePublishedAt.value = '';
                    articleOriginalPublishedAt.value = '';
                }

                quill.root.innerHTML = article.content; // Carrega o conteúdo no Quill
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: articleForm.offsetTop, behavior: 'smooth' });

            } catch (error) {
                console.error("Erro ao buscar artigo para edição:", error);
                showStatusMessage(`Erro ao carregar artigo: ${error.message}`, true);
            }
        }

        // Deletar Artigo
        async function deleteArticle(id, title) {
            if (confirm(`Tem certeza que quer deletar o artigo "${title}"?`)) {
                try {
                    await fetchWithToken('/api/admin/deletarArtigo', {
                        method: 'POST',
                        body: JSON.stringify({ id })
                    });
                    showStatusMessage('Artigo deletado.');
                    resetArticleForm(); // Caso estivesse editando
                    await loadArticles(); // Recarrega
                } catch (error) {
                    console.error("Erro ao deletar artigo: ", error);
                    showStatusMessage(`Erro ao deletar artigo: ${error.message}`, true);
                }
            }
        }

        // Limpar formulário de Artigo
        function resetArticleForm() {
            articleForm.reset(); // Isso limpa todos os inputs, incluindo a data
            articleIdInput.value = '';
            articleOriginalPublishedAt.value = '';
            quill.root.innerHTML = ''; // Limpa o editor
            articleFormTitle.textContent = 'Adicionar Novo Artigo';
            cancelEditBtn.classList.add('hidden');
        }
        cancelEditBtn.addEventListener('click', resetArticleForm);


        // --- FUNÇÕES UTILITÁRIAS ---

        // Mostrar mensagem de status (toast)
        function showStatusMessage(message, isError = false) {
            adminStatus.textContent = message;
            adminStatus.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            adminStatus.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            setTimeout(() => {
                adminStatus.classList.add('hidden');
            }, 3000);
        }

        // Criar slug (para URLs amigáveis, se necessário no futuro)
        function slugify(text) {
            if (!text) return '';
            return text.toString().toLowerCase().trim()
                .normalize('NFD') // remove acentos
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, '-') // substitui espaços por -
                .replace(/[^\w-]+/g, '') // remove caracteres não-alfanuméricos
                .replace(/--+/g, '-'); // remove hífens duplicados
        }

    </script>


</body>

</html>