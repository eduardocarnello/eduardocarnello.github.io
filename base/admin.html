<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Ajusta a altura do editor Quill */
        #editor-container {
            height: 350px;
        }

        .ql-toolbar {
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }

        .ql-container {
            border-radius: 0 0 0.5rem 0.5rem !important;
        }

        /* Foco personalizado para acessibilidade */
        .focus-ring-visible:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* CORREÇÃO PISCADA (FOUC): Esconde o conteúdo até o JS decidir o que mostrar */
        .fouc-hidden {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-100">

    <!-- Seção de Login (Começa oculta para evitar "piscada") -->
    <section id="login-section"
        class="fouc-hidden min-h-screen items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-xl">
            <div>
                <svg class="mx-auto h-12 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18c-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                </svg>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Acessar Painel Admin
                </h2>
            </div>

            <!-- Mensagem de Erro/Status -->
            <div id="login-status" class="text-center text-red-500 font-medium"></div>

            <!-- Formulário de Login -->
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="login-email" class="sr-only">Email</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required
                            class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Endereço de e-mail">
                    </div>
                    <div>
                        <label for="login-password" class="sr-only">Senha</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password"
                            required
                            class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Senha">
                    </div>
                </div>

                <div>
                    <button type="submit"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Entrar
                    </button>
                </div>
            </form>

            <!-- Divisor "OU" -->
            <div class="relative flex py-3 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-500">OU</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <!-- Botão Login Google -->
            <div>
                <button id="google-login-btn"
                    class="group relative w-full flex justify-center py-3 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    <img class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg"
                        alt="Google icon">
                    Entrar com Google
                </button>
            </div>

            <!-- Link para o Site -->
            <div class="text-center mt-6">
                <a href="index.html"
                    class="text-sm font-medium text-blue-600 hover:text-blue-500 transition-colors focus-ring-visible rounded-md">
                    &larr; Voltar para o Site
                </a>
            </div>

        </div>
    </section>

    <!-- Seção de Administração (Começa oculta para evitar "piscada") -->
    <section id="admin-dashboard" class="fouc-hidden">

        <!-- Header do Admin -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18c-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                        </svg>
                        <span class="ml-3 text-2xl font-bold text-slate-800">Painel Admin</span>
                    </div>
                    <!-- Info Usuário e Botões -->
                    <div class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-slate-600 hidden sm:block"></span>
                        <a href="index.html" target="_blank"
                            class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors focus-ring-visible rounded-md p-1">
                            Ver Site
                        </a>
                        <button id="logout-btn"
                            class="text-sm font-medium text-red-600 hover:text-red-800 transition-colors focus-ring-visible rounded-md p-1">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal do Admin -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- Mensagem de Status (Salvo, Erro, etc) -->
            <div id="admin-status"
                class="hidden fixed top-20 right-8 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50">
                Mensagem de sucesso!
            </div>

            <!-- Grid Principal -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Coluna Principal (Formulário de Artigo e Lista) -->
                <div class="lg:col-span-2 space-y-8">

                    <!-- Formulário de Artigo -->
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                        <h2 id="article-form-title" class="text-2xl font-bold text-slate-800 mb-6">Adicionar Novo Artigo
                        </h2>
                        <form id="article-form" class="space-y-6">

                            <!-- Título -->
                            <div>
                                <label for="article-title"
                                    class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                                <input type="text" id="article-title" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Categoria -->
                            <div>
                                <label for="article-category"
                                    class="block text-sm font-medium text-slate-700 mb-1">Categoria</label>
                                <select id="article-category" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="">Carregando categorias...</option>
                                    <!-- Categorias preenchidas pelo JS -->
                                </select>
                            </div>

                            <!-- Resumo -->
                            <div>
                                <label for="article-summary"
                                    class="block text-sm font-medium text-slate-700 mb-1">Resumo (Max 250
                                    caracteres)</label>
                                <textarea id="article-summary" rows="3" maxlength="250" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>

                            <!-- Links Múltiplos -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Links de Referência (Max
                                    5)</label>
                                <div id="links-container" class="space-y-2">
                                    <!-- Inputs de link serão adicionados aqui pelo JS -->
                                </div>
                                <button type="button" id="add-link-btn"
                                    class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors focus-ring-visible rounded-md p-1">
                                    + Adicionar outro link
                                </button>
                            </div>

                            <!-- Data de Publicação -->
                            <div>
                                <label for="article-published-at"
                                    class="block text-sm font-medium text-slate-700 mb-1">Data de Publicação
                                    (Opcional)</label>
                                <input type="date" id="article-published-at"
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-slate-500 mt-1">Se vazio, usa a data atual na criação. Se
                                    editando, mantém a data original.</p>
                            </div>

                            <!-- Tags -->
                            <div>
                                <label for="article-tags" class="block text-sm font-medium text-slate-700 mb-1">Tags
                                    (Separadas por vírgula)</label>
                                <input type="text" id="article-tags" placeholder="ex: provimento, prazo, novo sistema"
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Editor de Conteúdo -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Conteúdo Completo</label>
                                <div id="editor-container"></div> <!-- Container do Quill -->
                                <!-- Ajuda para Imagens -->
                                <p class="text-xs text-slate-500 mt-2">
                                    <b>Para adicionar imagens:</b> Publique a imagem em um site (como
                                    <a href="https://imgur.com/upload" target="_blank"
                                        class="text-blue-600 hover:underline">Imgur</a> ou
                                    <a href="https://postimages.org/" target="_blank"
                                        class="text-blue-600 hover:underline">Postimages</a>),
                                    copie o link direto da imagem (ex: .jpg, .png) e cole-o usando o ícone de imagem
                                    <svg class="w-4 h-4 inline -mt-1" xmlns="http://www.w3.org/2000/svg" fill="none"
                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                    </svg>
                                    na barra de ferramentas.
                                </p>
                            </div>

                            <!-- ID Oculto (para edição) -->
                            <input type="hidden" id="article-id">

                            <!-- Botões -->
                            <div class="flex gap-4">
                                <button type="submit"
                                    class="flex-1 py-3 px-6 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    Salvar Artigo
                                </button>
                                <button type="button" id="cancel-edit-btn"
                                    class="hidden flex-1 py-3 px-6 border border-slate-300 text-base font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition-colors">
                                    Cancelar Edição
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Artigos -->
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Artigos Publicados</h2>
                        <div id="articles-list-admin" class="space-y-4">
                            <p id="articles-loading-msg">Carregando artigos...</p>
                            <!-- Lista preenchida pelo JS -->
                        </div>
                    </div>
                </div>

                <!-- Coluna Lateral (Gerenciar Categorias) -->
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg sticky top-24">
                        <h2 id="category-form-title" class="text-2xl font-bold text-slate-800 mb-6">Gerenciar Categorias
                        </h2>

                        <!-- Formulário de Categoria -->
                        <form id="category-form" class="space-y-4 mb-8">
                            <div>
                                <label for="category-name" class="block text-sm font-medium text-slate-700 mb-1">Nome da
                                    Categoria</label>
                                <input type="text" id="category-name" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Cor -->
                                <div>
                                    <label for="category-color"
                                        class="block text-sm font-medium text-slate-700 mb-1">Cor</label>
                                    <select id="category-color"
                                        class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <option value="slate">Cinza (Slate)</option>
                                        <option value="red">Vermelho (Red)</option>
                                        <option value="orange">Laranja (Orange)</option>
                                        <option value="yellow">Amarelo (Yellow)</option>
                                        <option value="green">Verde (Green)</option>
                                        <option value="blue">Azul (Blue)</option>
                                        <option value="indigo">Índigo (Indigo)</option>
                                        <option value="purple">Roxo (Purple)</option>
                                        <option value="pink">Rosa (Pink)</option>
                                        <!-- NOVAS CORES -->
                                        <option value="cyan">Ciano (Cyan)</option>
                                        <option value="teal">Verde-azulado (Teal)</option>
                                        <option value="lime">Lima (Lime)</option>
                                        <option value="fuchsia">Fúcsia (Fuchsia)</option>
                                        <option value="sky">Céu (Sky)</option>
                                    </select>
                                </div>
                                <!-- Ícone -->
                                <div>
                                    <label for="category-icon"
                                        class="block text-sm font-medium text-slate-700 mb-1">Ícone</label>
                                    <select id="category-icon"
                                        class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <option value="book">Livro (book)</option>
                                        <option value="bolt">Raio (bolt)</option>
                                        <option value="gavel">Conformidade (gavel)</option>
                                        <option value="alert">Alerta (alert)</option>
                                        <option value="info">Info (info)</option>
                                        <option value="user">Pessoa (user)</option> <!-- ÍCONE ATUALIZADO -->
                                        <option value="list">Lista (list)</option>
                                        <option value="file">Arquivo (file)</option>
                                        <option value="chart-bar">Gráfico (chart-bar)</option>
                                        <option value="chat-alt">Chat (chat-alt)</option>
                                        <option value="cog">Engrenagem (cog)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- ID Oculto (para edição) -->
                            <input type="hidden" id="category-id">

                            <!-- Botões -->
                            <div class="flex gap-4">
                                <button type="submit"
                                    class="flex-1 py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    Salvar Categoria
                                </button>
                                <button type="button" id="cancel-category-edit-btn"
                                    class="hidden flex-1 py-2 px-4 border border-slate-300 text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </form>

                        <!-- Lista de Categorias -->
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Categorias Atuais</h3>
                        <div id="category-list-admin" class="space-y-3">
                            <p id="categories-loading-msg">Carregando categorias...</p>
                            <!-- Lista preenchida pelo JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            getIdToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // REMOVEMOS O 'getFirestore' - ele agora roda no servidor

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChhpPXpLTFGQfvJH55D_uQ2FG5PdKykcQ",
            authDomain: "minha-base-conhecimento.firebaseapp.com",
            projectId: "minha-base-conhecimento",
            storageBucket: "minha-base-conhecimento.firebasestorage.app",
            messagingSenderId: "586899421039",
            appId: "1:586899421039:web:99be661136602118175a9a"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        setLogLevel('Debug'); // Habilita logs detalhados no console

        // Lista de E-mails Admin
        const adminEmails = ['eduardocarnello@gmail.com', 'mariliajec@tjsp.jus.br'];

        // --- REFERÊNCIAS DO DOM ---
        const loginSection = document.getElementById('login-section');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginStatus = document.getElementById('login-status');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const adminStatus = document.getElementById('admin-status');

        // Formulário de Artigo
        const articleForm = document.getElementById('article-form');
        const articleFormTitle = document.getElementById('article-form-title');
        const articleTitle = document.getElementById('article-title');
        const articleCategory = document.getElementById('article-category');
        const articleSummary = document.getElementById('article-summary');
        // LINKS MÚLTIPLOS
        const linksContainer = document.getElementById('links-container');
        const addLinkBtn = document.getElementById('add-link-btn');
        // const articleLink = document.getElementById('article-link'); // Removido
        const articlePublishedAt = document.getElementById('article-published-at');
        const articleTags = document.getElementById('article-tags');
        const articleIdInput = document.getElementById('article-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const articlesListAdmin = document.getElementById('articles-list-admin');
        const articlesLoadingMsg = document.getElementById('articles-loading-msg');

        // Formulário de Categoria
        const categoryForm = document.getElementById('category-form');
        const categoryFormTitle = document.getElementById('category-form-title');
        const categoryName = document.getElementById('category-name');
        const categoryColor = document.getElementById('category-color');
        const categoryIcon = document.getElementById('category-icon');
        const categoryIdInput = document.getElementById('category-id');
        const cancelCategoryEditBtn = document.getElementById('cancel-category-edit-btn');
        const categoryListAdmin = document.getElementById('category-list-admin');
        const categoriesLoadingMsg = document.getElementById('categories-loading-msg');

        // Editor Quill
        let quill;
        function initializeQuill() {
            if (!quill) {
                const toolbarOptions = [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'blockquote', 'code-block'],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ];
                quill = new Quill('#editor-container', {
                    modules: {
                        toolbar: toolbarOptions
                    },
                    theme: 'snow'
                });
            }
        }

        // --- FUNÇÃO WRAPPER DE FETCH (COM TOKEN) ---
        // (Usa caminhos relativos e trata erros)
        async function fetchWithToken(apiUrl, options = {}) {
            if (!auth.currentUser) {
                showStatusMessage('Usuário não autenticado. Faça login novamente.', true);
                signOut(auth); // Força o logout
                throw new Error("Usuário não autenticado.");
            }

            try {
                const token = await getIdToken(auth.currentUser);

                // Configura headers
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
                options.method = options.method || 'GET';
                if (options.body) {
                    options.headers['Content-Type'] = 'application/json';
                }

                // Usa caminho relativo (remove / inicial)
                const relativeApiUrl = apiUrl.startsWith('/') ? apiUrl.substring(1) : apiUrl;

                const response = await fetch(relativeApiUrl, options);

                const responseText = await response.text();

                if (!response.ok) {
                    let errorMessage = `Erro ${response.status}`;
                    if (responseText) {
                        try {
                            const errorData = JSON.parse(responseText);
                            if (errorData.error) {
                                errorMessage = errorData.error;
                            }
                        } catch (e) {
                            console.error("Erro HTML/Texto (não-JSON) recebido:", responseText.substring(0, 100) + '...');
                            errorMessage = `Erro ${response.status}: A API não foi encontrada ou retornou um erro inesperado.`;
                        }
                    }
                    console.error(`Erro na API (${response.status}):`, errorMessage);
                    throw new Error(errorMessage);
                }

                if (!responseText) {
                    return null; // Resposta OK sem corpo (ex: Deletar)
                }
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    console.warn("Resposta da API não era JSON:", responseText);
                    return responseText;
                }

            } catch (error) {
                console.error("Erro fatal no fetchWithToken:", error);
                showStatusMessage(error.message || 'Erro de rede ou autenticação.', true);
                throw error;
            }
        }


        // --- AUTENTICAÇÃO (COM PROTEÇÃO DE ROTA E CORREÇÃO DE "PISCADA") ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Checagem de permissão
                if (adminEmails.includes(user.email)) {
                    // É Admin: Mostra o painel
                    adminDashboard.style.display = 'block'; // Mostra o painel
                    loginSection.style.display = 'none'; // Esconde o login
                    userEmailSpan.textContent = user.email;
                    initializeQuill(); // Inicializa o editor SÓ quando logado
                    resetLinksContainer(); // Adiciona o primeiro campo de link

                    // Carrega os dados (categorias e artigos)
                    loadCategories();
                    loadArticles();
                } else {
                    // Não é Admin: Redireciona para o index
                    alert('Acesso negado. Você não tem permissão para acessar esta página.');
                    window.location.href = 'index.html';
                }
            } else {
                // Usuário está deslogado
                loginSection.style.display = 'flex'; // Mostra o login
                adminDashboard.style.display = 'none'; // Esconde o painel
                userEmailSpan.textContent = '';
                if (quill) {
                    quill = null; // Destrói a instância se deslogar
                }
            }
        });

        // Login com E-mail/Senha
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loginStatus.textContent = 'Entrando...';
            signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value)
                .then((userCredential) => {
                    loginStatus.textContent = '';
                    loginForm.reset();
                })
                .catch((error) => {
                    console.error("Erro de login:", error.code, error.message);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        loginStatus.textContent = 'E-mail ou senha inválidos.';
                    } else {
                        loginStatus.textContent = 'Erro ao tentar fazer login.';
                    }
                });
        });

        // Login com Google
        googleLoginBtn.addEventListener('click', () => {
            loginStatus.textContent = 'Abrindo popup do Google...';
            signInWithPopup(auth, googleProvider)
                .then((result) => {
                    loginStatus.textContent = '';
                })
                .catch((error) => {
                    console.error("Erro ao logar com Google:", error);
                    // (O tratamento de erro já estava aqui)
                    if (error.code === 'auth/popup-closed-by-user') {
                        loginStatus.textContent = 'Popup de login fechado.';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        loginStatus.textContent = 'Erro: Domínio não autorizado. (Verifique o console do Firebase)';
                        alert("ERRO: O domínio do seu site não está autorizado. \n\nPor favor, vá ao Console do Firebase > Authentication > Settings > Authorized domains e adicione o domínio onde este site está hospedado.");
                    } else {
                        loginStatus.textContent = 'Erro ao logar com Google.';
                    }
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            if (window.confirm('Tem certeza que deseja sair?')) {
                signOut(auth).catch((error) => {
                    console.error("Erro ao sair:", error);
                    showStatusMessage('Erro ao tentar sair.', true);
                });
            }
        });


        // --- GERENCIAMENTO DE CATEGORIAS (CRUD) ---

        let allCategoriesMap = new Map();

        // Salvar/Atualizar Categoria
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const categoryData = {
                name: categoryName.value,
                color: categoryColor.value,
                icon: categoryIcon.value,
                slug: slugify(categoryName.value)
            };

            try {
                if (id) {
                    categoryData.id = id;
                }

                await fetchWithToken('api/admin/salvarCategoria', {
                    method: 'POST',
                    body: JSON.stringify(categoryData)
                });

                showStatusMessage(id ? 'Categoria atualizada!' : 'Categoria salva!');
                resetCategoryForm();
                loadCategories(); // REFRESH AUTOMÁTICO
            } catch (error) {
                console.error("Erro ao salvar categoria: ", error);
                showStatusMessage(error.message || 'Erro ao salvar categoria.', true);
            }
        });

        // Carregar Categorias
        async function loadCategories() {
            categoriesLoadingMsg.style.display = 'block'; // Mostra o loader
            try {
                const categories = await fetchWithToken('api/getCategorias');

                categoriesLoadingMsg.classList.add('hidden');
                categoryListAdmin.innerHTML = '';
                articleCategory.innerHTML = '<option value="">-- Selecione uma categoria --</option>';
                allCategoriesMap.clear();

                categories.sort((a, b) => a.name.localeCompare(b.name));

                categories.forEach(category => {
                    allCategoriesMap.set(category.id, category);

                    // Popula a lista do admin
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-3 bg-slate-50 rounded-lg';
                    el.innerHTML = `
                        <span class="font-medium text-slate-700">${category.name}</span>
                        <div class="flex gap-2">
                            <button data-id="${category.id}" class="edit-category-btn text-blue-600 hover:text-blue-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button data-id="${category.id}" data-name="${category.name}" class="delete-category-btn text-red-600 hover:text-red-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    categoryListAdmin.appendChild(el);

                    // Popula o dropdown do formulário de artigo
                    const opt = document.createElement('option');
                    opt.value = category.id;
                    opt.textContent = category.name;
                    articleCategory.appendChild(opt);
                });

                if (categories.length === 0) {
                    categoriesLoadingMsg.textContent = 'Nenhuma categoria encontrada.';
                    categoriesLoadingMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao carregar categorias: ", error);
                categoriesLoadingMsg.textContent = error.message || 'Erro ao carregar categorias.';
                categoriesLoadingMsg.classList.remove('hidden');
            }
        }

        // Delegação de Eventos para botões de Categoria
        categoryListAdmin.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-category-btn');
            const deleteBtn = e.target.closest('.delete-category-btn');

            if (editBtn) {
                const id = editBtn.dataset.id;
                populateCategoryForm(id);
            }
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                deleteCategory(id, name);
            }
        });

        // Preencher formulário de Categoria para edição
        function populateCategoryForm(id) {
            const category = allCategoriesMap.get(id);
            if (category) {
                categoryFormTitle.textContent = 'Editar Categoria';
                categoryIdInput.value = id;
                categoryName.value = category.name;
                categoryColor.value = category.color;
                categoryIcon.value = category.icon;
                cancelCategoryEditBtn.classList.remove('hidden');
                window.scrollTo({ top: categoryForm.offsetTop, behavior: 'smooth' });
            }
        }

        // Deletar Categoria
        async function deleteCategory(id, name) {
            if (confirm(`Tem certeza que quer deletar a categoria "${name}"?\nATENÇÃO: Artigos nesta categoria ficarão órfãos.`)) {
                try {
                    await fetchWithToken('api/admin/deletarCategoria', {
                        method: 'POST', // Usamos POST para enviar um corpo
                        body: JSON.stringify({ id: id })
                    });
                    showStatusMessage('Categoria deletada.');
                    resetCategoryForm();
                    loadCategories(); // REFRESH AUTOMÁTICO
                } catch (error) {
                    console.error("Erro ao deletar categoria: ", error);
                    showStatusMessage(error.message || 'Erro ao deletar categoria.', true);
                }
            }
        }

        // Limpar formulário de Categoria
        function resetCategoryForm() {
            categoryForm.reset();
            categoryIdInput.value = '';
            categoryFormTitle.textContent = 'Gerenciar Categorias';
            cancelCategoryEditBtn.classList.add('hidden');
        }
        cancelCategoryEditBtn.addEventListener('click', resetCategoryForm);


        // --- GERENCIAMENTO DE ARTIGOS (CRUD) ---

        // Salvar/Atualizar Artigo
        articleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = articleIdInput.value;
            const publishedDate = articlePublishedAt.value;

            // Processa as tags
            const tagsArray = articleTags.value
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);

            // Processa os links múltiplos
            const linksArray = Array.from(linksContainer.querySelectorAll('input'))
                .map(input => input.value.trim())
                .filter(link => link.length > 0);

            const articleData = {
                title: articleTitle.value,
                categoryId: articleCategory.value,
                summary: articleSummary.value,
                links: linksArray, // Array de links
                tags: tagsArray,
                content: quill.root.innerHTML,
                slug: slugify(articleTitle.value),
            };

            if (id) {
                articleData.id = id;
            }

            if (publishedDate) {
                articleData.publishedAt = publishedDate;
            }

            try {
                await fetchWithToken('api/admin/salvarArtigo', {
                    method: 'POST',
                    body: JSON.stringify(articleData)
                });

                showStatusMessage(id ? 'Artigo atualizado!' : 'Artigo salvo!');
                resetArticleForm();
                loadArticles(); // REFRESH AUTOMÁTICO
            } catch (error) {
                console.error("Erro ao salvar artigo: ", error);
                showStatusMessage(error.message || 'Erro ao salvar artigo.', true);
            }
        });

        // Carregar Artigos (para o Admin)
        async function loadArticles() {
            articlesLoadingMsg.style.display = 'block'; // Mostra o loader
            try {
                const articles = await fetchWithToken('api/getArtigos?limit=1000');

                articlesLoadingMsg.classList.add('hidden');
                articlesListAdmin.innerHTML = '';

                // A API já deve retornar os artigos ordenados
                articles.forEach(article => {
                    const category = allCategoriesMap.get(article.categoryId);
                    const categoryName = category ? category.name : 'Sem Categoria';

                    const date = article.publishedAt
                        ? new Date(article.publishedAt.seconds * 1000).toLocaleDateString()
                        : 'Salvando...';

                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-4 bg-slate-50 rounded-lg';
                    el.innerHTML = `
                        <div>
                            <strong class="text-slate-800">${article.title}</strong>
                            <span class="block text-sm text-slate-500">${categoryName} - ${date}</span>
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            <button data-id="${article.id}" class="edit-article-btn text-blue-600 hover:text-blue-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button data-id="${article.id}" data-title="${article.title}" class="delete-article-btn text-red-600 hover:text-red-800 focus-ring-visible rounded-md p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    articlesListAdmin.appendChild(el);
                });

                if (articles.length === 0) {
                    articlesLoadingMsg.textContent = 'Nenhum artigo encontrado.';
                    articlesLoadingMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao carregar artigos: ", error);
                articlesLoadingMsg.textContent = error.message || 'Erro ao carregar artigos.';
                articlesLoadingMsg.classList.remove('hidden');
            }
        }

        // Delegação de Eventos para botões de Artigo
        articlesListAdmin.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-article-btn');
            const deleteBtn = e.target.closest('.delete-article-btn');

            if (editBtn) {
                const id = editBtn.dataset.id;
                populateArticleForm(id);
            }
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const title = deleteBtn.dataset.title;
                deleteArticle(id, title);
            }
        });

        // Preencher formulário de Artigo para edição
        async function populateArticleForm(id) {
            try {
                const article = await fetchWithToken(`api/getArtigoDetalhe?id=${id}`);

                articleFormTitle.textContent = 'Editar Artigo';
                articleIdInput.value = id;
                articleTitle.value = article.title;
                articleCategory.value = article.categoryId;
                articleSummary.value = article.summary;
                articleTags.value = (article.tags || []).join(', ');

                if (article.publishedAt) {
                    const date = new Date(article.publishedAt.seconds * 1000);
                    articlePublishedAt.value = date.toISOString().split('T')[0];
                } else {
                    articlePublishedAt.value = '';
                }

                // Popula os links múltiplos
                resetLinksContainer(); // Limpa e adiciona o primeiro
                const linkInputs = linksContainer.querySelectorAll('input');
                const links = article.links || [];

                links.forEach((link, index) => {
                    if (index === 0) {
                        linkInputs[0].value = link; // Preenche o primeiro
                    } else {
                        addLinkInput(link); // Adiciona novos campos para os links restantes
                    }
                });

                quill.root.innerHTML = article.content;
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: articleForm.offsetTop, behavior: 'smooth' });

            } catch (error) {
                console.error("Erro ao buscar artigo:", error);
                showStatusMessage(error.message || 'Erro ao carregar artigo para edição.', true);
            }
        }

        // Deletar Artigo
        async function deleteArticle(id, title) {
            if (confirm(`Tem certeza que quer deletar o artigo "${title}"?`)) {
                try {
                    await fetchWithToken('api/admin/deletarArtigo', {
                        method: 'POST',
                        body: JSON.stringify({ id: id })
                    });
                    showStatusMessage('Artigo deletado.');
                    resetArticleForm();
                    loadArticles(); // REFRESH AUTOMÁTICO
                } catch (error) {
                    console.error("Erro ao deletar artigo: ", error);
                    showStatusMessage(error.message || 'Erro ao deletar artigo.', true);
                }
            }
        }

        // Limpar formulário de Artigo
        function resetArticleForm() {
            articleForm.reset();
            articleIdInput.value = '';
            quill.root.innerHTML = '';
            articleFormTitle.textContent = 'Adicionar Novo Artigo';
            cancelEditBtn.classList.add('hidden');
            resetLinksContainer(); // Limpa e adiciona o primeiro campo de link
        }
        cancelEditBtn.addEventListener('click', resetArticleForm);


        // --- GERENCIAMENTO DE LINKS MÚLTIPLOS ---

        function createLinkInput(value = '') {
            const inputCount = linksContainer.querySelectorAll('input').length;
            if (inputCount >= 5) return; // Limite de 5 links

            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';

            const input = document.createElement('input');
            input.type = 'url';
            input.placeholder = `https://exemplo.com/link-${inputCount + 1}`;
            input.className = 'w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 link-input';
            input.value = value;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-500 hover:text-red-700 p-1 rounded-full focus-ring-visible';
            removeBtn.ariaLabel = 'Remover link';
            removeBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';

            removeBtn.addEventListener('click', () => {
                div.remove();
                updateAddLinkButton();
            });

            div.appendChild(input);
            div.appendChild(removeBtn);
            linksContainer.appendChild(div);

            updateAddLinkButton();
        }

        function addLinkInput(value = '') {
            createLinkInput(value);
        }

        function updateAddLinkButton() {
            const inputCount = linksContainer.querySelectorAll('input').length;
            if (inputCount >= 5) {
                addLinkBtn.classList.add('hidden');
            } else {
                addLinkBtn.classList.remove('hidden');
            }
        }

        function resetLinksContainer() {
            linksContainer.innerHTML = '';
            addLinkInput(); // Adiciona o primeiro campo vazio
        }

        addLinkBtn.addEventListener('click', () => addLinkInput());


        // --- FUNÇÕES UTILITÁRIAS ---

        // Mostrar mensagem de status (toast)
        let statusTimeout; // Variável para guardar o timeout
        function showStatusMessage(message, isError = false) {
            clearTimeout(statusTimeout); // Limpa qualquer timeout anterior

            adminStatus.textContent = message;
            adminStatus.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            adminStatus.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            // Esconde a mensagem depois de 3 segundos
            statusTimeout = setTimeout(() => {
                adminStatus.classList.add('hidden');
            }, 3000);
        }

        // Criar slug
        function slugify(text) {
            return text.toString().toLowerCase().trim()
                .normalize('NFD') // remove acentos
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, '-') // substitui espaços por -
                .replace(/[^\w-]+/g, '') // remove caracteres não-alfanuméricos
                .replace(/--+/g, '-'); // remove hífens duplicados
        }

    </script>

</body>

</html>