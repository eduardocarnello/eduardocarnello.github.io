<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #editor-container {
            height: 350px;
        }

        .ql-toolbar {
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }

        .ql-container {
            border-radius: 0 0 0.5rem 0.5rem !important;
        }

        .focus-ring-visible:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* CORREÇÃO PISCADA (FOUC): Esconde o conteúdo até o JS decidir o que mostrar */
        .fouc-hidden {
            display: none;
        }

        /* Estilo para o Switch de Filtro */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #2563eb;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #2563eb;
        }

        #science-toggle-switch:checked+div {
            /* O fundo */
            background-color: #2563eb;
            /* blue-600 */
        }

        #science-toggle-switch:checked+div+div {
            /* O ponto */
            transform: translateX(100%);
        }
    </style>
</head>

<body class="bg-slate-100">

    <!-- Seção de Login (Começa oculta para evitar "piscada") -->
    <section id="login-section" style="display: none;"
        class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-xl">
            <div>
                <svg class="mx-auto h-12 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18c-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                </svg>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Acessar Painel Admin
                </h2>
            </div>

            <!-- Mensagem de Erro/Status -->
            <div id="login-status" class="text-center text-red-500 font-medium"></div>

            <div class="space-y-4 pt-6">
                <!-- Botão Login Google -->
                <button id="google-login-btn"
                    class="group relative w-full flex justify-center py-3 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    <img class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg"
                        alt="Google icon">
                    Entrar com Google
                </button>

                <!-- NOVO: Botão Login Microsoft 
                <button id="microsoft-login-btn"
                    class="group relative w-full flex justify-center py-3 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    <img class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/303108/microsoft-icon-logo.svg"
                        alt="Microsoft icon">
                    Entrar com Microsoft
                </button>-->
            </div>

            <!-- Link para o Site -->
            <div class="text-center mt-6">
                <a href="index.html"
                    class="text-sm font-medium text-blue-600 hover:text-blue-500 transition-colors focus-ring-visible rounded-md">
                    &larr; Voltar para o Site
                </a>
            </div>

        </div>
    </section>

    <!-- Seção de Administração (Começa oculta para evitar "piscada") -->
    <section id="admin-dashboard" style="display: none;">

        <!-- Header do Admin -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18c-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                        </svg>
                        <span class="ml-3 text-2xl font-bold text-slate-800">Painel Admin</span>
                    </div>
                    <!-- Info Usuário e Botões -->
                    <div class="flex items-center gap-4">
                        <!-- NOVO: Exibição de Cargo -->
                        <span id="user-info" class="text-sm text-slate-600 hidden sm:block">
                            <span id="user-email" class="font-medium"></span>
                            (<span id="user-role" class="font-light"></span>)
                        </span>
                        <a href="index.html" target="_blank"
                            class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors focus-ring-visible rounded-md p-1">
                            Ver Site
                        </a>
                        <button id="logout-btn"
                            class="text-sm font-medium text-red-600 hover:text-red-800 transition-colors focus-ring-visible rounded-md p-1">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal do Admin -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- Mensagem de Status (Salvo, Erro, etc) -->
            <div id="admin-status"
                class="hidden fixed top-20 right-8 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50">
                Mensagem de sucesso!
            </div>

            <!-- Grid Principal -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Coluna Principal (Formulário de Documento e Lista) -->
                <div class="lg:col-span-2 space-y-8">

                    <!-- Formulário de Documento (Permissão: Redator, Editor, Admin) -->
                    <div id="article-form-section" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg"
                        style="display: none;"> <!-- Oculto por padrão -->
                        <h2 id="article-form-title" class="text-2xl font-bold text-slate-800 mb-6">Adicionar Novo
                            Documento
                        </h2>
                        <form id="article-form" class="space-y-6">

                            <!-- Título -->
                            <div>
                                <label for="article-title"
                                    class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                                <input type="text" id="article-title" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Categoria (Permissão: Editor, Admin) -->
                            <div class="permission-editor permission-admin" style="display: none;">
                                <label for="article-category"
                                    class="block text-sm font-medium text-slate-700 mb-1">Categoria</label>
                                <select id="article-category" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="">Carregando categorias...</option>
                                </select>
                            </div>

                            <!-- Resumo -->
                            <div>
                                <label for="article-summary"
                                    class="block text-sm font-medium text-slate-700 mb-1">Resumo (Max 250
                                    caracteres)</label>
                                <textarea id="article-summary" rows="3" maxlength="250" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>

                            <!-- Links Múltiplos (Inalterado) -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Links de Referência (Max
                                    5)</label>
                                <div id="links-container" class="space-y-2">
                                    <!-- Inputs de link -->
                                </div>
                                <button type="button" id="add-link-btn"
                                    class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors focus-ring-visible rounded-md p-1">
                                    + Adicionar outro link
                                </button>
                            </div>

                            <!-- Data de Publicação -->
                            <div>
                                <label for="article-published-at"
                                    class="block text-sm font-medium text-slate-700 mb-1">Data de Publicação
                                    (Opcional)</label>
                                <input type="date" id="article-published-at"
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-slate-500 mt-1">Se vazio, usa a data atual na criação. Se
                                    editando, mantém a data original.</p>
                            </div>

                            <!-- Tags -->
                            <div>
                                <label for="article-tags" class="block text-sm font-medium text-slate-700 mb-1">Tags
                                    (Separadas por vírgula)</label>
                                <input type="text" id="article-tags" placeholder="ex: provimento, prazo, novo sistema"
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- ETAPA 3.A: Seção de Ciência (Permissão: Admin) -->
                            <div class="permission-admin" style="display: none;">
                                <fieldset class="border-t border-slate-200 pt-4">
                                    <legend class="text-sm font-medium text-slate-700">Opções de Ciência</legend>
                                    <div class="mt-4 space-y-4">
                                        <div class="relative flex items-start">
                                            <div class="flex h-5 items-center">
                                                <input id="requires-science" name="requires-science" type="checkbox"
                                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="requires-science" class="font-medium text-gray-700">Exigir
                                                    Ciência deste Documento</label>
                                                <p class="text-gray-500">Força os usuários a lerem e "Declarar
                                                    Ciência" deste item.</p>
                                            </div>
                                        </div>
                                        <div id="reset-science-container" class="hidden">
                                            <button type="button" id="reset-science-btn"
                                                class="text-sm font-medium text-orange-600 hover:text-orange-800 transition-colors focus-ring-visible rounded-md p-1">
                                                &#9888; Resetar e Exigir Ciência de Todos Novamente
                                            </button>
                                            <p class="text-xs text-slate-500 mt-1">Use isso se o documento foi
                                                atualizado e
                                                precisa ser lido por todos de novo.</p>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                            <!-- FIM: Seção de Ciência -->

                            <!-- Editor de Conteúdo -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Conteúdo Completo</label>
                                <div id="editor-container"></div>
                                <p class="text-xs text-slate-500 mt-2">
                                    <b>Para adicionar imagens:</b> Publique a imagem em um site (como
                                    <a href="https://imgur.com/upload" target="_blank"
                                        class="text-blue-600 hover:underline">Imgur</a> ou
                                    <a href="https://postimages.org/" target="_blank"
                                        class="text-blue-600 hover:underline">Postimages</a>),
                                    copie o link direto da imagem (ex: .jpg, .png) e cole-o usando o ícone de imagem
                                    <svg class="w-4 h-4 inline -mt-1" xmlns="http://www.w3.org/2000/svg" fill="none"
                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                    </svg>
                                    na barra de ferramentas.
                                </p>
                            </div>
                            <input type="hidden" id="article-id">
                            <input type="hidden" id="is-science-reset" value="false">
                            <div class="flex gap-4">
                                <button type="submit"
                                    class="flex-1 py-3 px-6 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    Salvar Documento
                                </button>
                                <button type="button" id="cancel-edit-btn"
                                    class="hidden flex-1 py-3 px-6 border border-slate-300 text-base font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition-colors">
                                    Cancelar Edição
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Documentos (COM BUSCA E PAGINAÇÃO) -->
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-slate-800">Documentos Publicados</h2>
                            <!-- NOVO: Switch de Filtro de Ciência (Permissão: Editor, Admin) -->
                            <div id="science-filter-container" class="permission-editor permission-admin"
                                style="display: none;">
                                <label for="science-toggle-switch" class="flex items-center cursor-pointer">
                                    <span class="mr-3 text-sm font-medium text-gray-900">Apenas "Ciência"</span>
                                    <div class="relative">
                                        <input type="checkbox" id="science-toggle-switch"
                                            class="sr-only toggle-checkbox">
                                        <div class="toggle-label block bg-gray-200 w-14 h-8 rounded-full transition">
                                        </div>
                                        <div
                                            class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform transform">
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Busca no Admin -->
                        <div class="relative mb-4">
                            <input type="search" id="admin-search-input" placeholder="Buscar documentos no painel..."
                                class="w-full p-3 pl-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                </svg>
                            </div>
                        </div>

                        <div id="articles-list-admin" class="space-y-4">
                            <p id="articles-loading-msg">Carregando documentos...</p>
                        </div>

                        <!-- Paginação no Admin -->
                        <div id="admin-load-more-container" class="text-center mt-8 hidden">
                            <button id="admin-load-more-btn"
                                class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-6 rounded-lg transition-colors focus-ring-visible">
                                Carregar Mais
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Coluna Lateral (Gerenciar Categorias E Usuários) -->
                <div class="lg:col-span-1 space-y-8">

                    <!-- Seção Gerenciar Categorias (Permissão: Admin) -->
                    <div id="category-admin-section" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg top-24"
                        style="display: none;">
                        <h2 id="category-form-title" class="text-2xl font-bold text-slate-800 mb-6">Gerenciar Categorias
                        </h2>

                        <!-- Formulário de Categoria (COM NOVAS CORES E ÍCONE) -->
                        <form id="category-form" class="space-y-4 mb-8">
                            <div>
                                <label for="category-name" class="block text-sm font-medium text-slate-700 mb-1">Nome da
                                    Categoria</label>
                                <input type="text" id="category-name" required
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Cor (NOVAS CORES) -->
                                <div>
                                    <label for="category-color"
                                        class="block text-sm font-medium text-slate-700 mb-1">Cor</label>
                                    <select id="category-color"
                                        class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <option value="slate">Cinza (Slate)</option>
                                        <option value="red">Vermelho (Red)</option>
                                        <option value="orange">Laranja (Orange)</option>
                                        <option value="yellow">Amarelo (Yellow)</option>
                                        <option value="green">Verde (Green)</option>
                                        <option value="blue">Azul (Blue)</option>
                                        <option value="indigo">Índigo (Indigo)</option>
                                        <option value="purple">Roxo (Purple)</option>
                                        <option value="pink">Rosa (Pink)</option>
                                        <option value="cyan">Ciano (Cyan)</option>
                                        <option value="teal">Verde-azulado (Teal)</option>
                                        <option value="lime">Lima (Lime)</option>
                                        <option value="fuchsia">Fúcsia (Fuchsia)</option>
                                        <option value="sky">Céu (Sky)</option>
                                    </select>
                                </div>
                                <!-- Ícone (ÍCONE 'USER' ATUALIZADO) -->
                                <div>
                                    <label for="category-icon"
                                        class="block text-sm font-medium text-slate-700 mb-1">Ícone</label>
                                    <select id="category-icon"
                                        class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <option value="book">Livro (book)</option>
                                        <option value="bolt">Raio (bolt)</option>
                                        <option value="gavel">Conformidade (gavel)</option>
                                        <option value="alert">Alerta (alert)</option>
                                        <option value="info">Info (info)</option>
                                        <option value="user">Pessoa (user)</option>
                                        <option value="list">Lista (list)</option>
                                        <option value="file">Arquivo (file)</option>
                                        <option value="chart-bar">Gráfico (chart-bar)</option>
                                        <option value="chat-alt">Chat (chat-alt)</option>
                                        <option value="cog">Engrenagem (cog)</option>
                                    </select>
                                </div>
                            </div>
                            <input type="hidden" id="category-id">
                            <div class="flex gap-4">
                                <button type="submit"
                                    class="flex-1 py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    Salvar Categoria
                                </button>
                                <button type="button" id="cancel-category-edit-btn"
                                    class="hidden flex-1 py-2 px-4 border border-slate-300 text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Categorias Atuais</h3>
                        <div id="category-list-admin" class="space-y-3">
                            <p id="categories-loading-msg">Carregando categorias...</p>
                        </div>
                    </div>

                    <!-- NOVO: Seção Gerenciar Usuários (Permissão: Admin) -->
                    <div id="user-admin-section" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg"
                        style="display: none;">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Gerenciar Usuários</h2>
                        <div class="mb-4">
                            <label for="user-search" class="block text-sm font-medium text-slate-700 mb-1">Buscar
                                Usuário</label>
                            <input type="text" id="user-search" placeholder="Filtrar por e-mail..."
                                class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="user-list-admin" class="space-y-3 max-h-96 overflow-y-auto">
                            <p id="users-loading-msg">Carregando usuários...</p>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </section>

    <!-- NOVO: Modal de Confirmação Customizado -->
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center p-4" style="display: none;">
        <div id="modal-backdrop-confirm" class="fixed inset-0 bg-black bg-opacity-50 transition-opacity opacity-0"
            aria-hidden="true"></div>
        <div id="modal-panel-confirm"
            class="relative bg-white rounded-2xl shadow-xl w-full max-w-md transform transition-all opacity-0 scale-95">
            <div class="p-6">
                <h3 id="confirm-modal-title" class="text-lg font-medium leading-6 text-gray-900">Confirmar Ação</h3>
                <div class="mt-2">
                    <p id="confirm-modal-message" class="text-sm text-gray-500">Tem certeza?</p>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3 rounded-b-2xl">
                <button type="button" id="confirm-modal-btn-confirm"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:w-auto sm:text-sm">
                    Confirmar
                </button>
                <button type="button" id="confirm-modal-btn-cancel"
                    class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- ETAPA 3.C: Modal de Auditoria de Ciência -->
    <div id="science-log-modal" class="fixed inset-0 z-50 items-center justify-center p-4" style="display: none;">
        <!-- Backdrop -->
        <div id="modal-backdrop-science-log" class="fixed inset-0 bg-black bg-opacity-50 transition-opacity opacity-0"
            aria-hidden="true"></div>
        <!-- Painel -->
        <div id="modal-panel-science-log"
            class="relative bg-white rounded-2xl shadow-xl w-full max-w-2xl transform transition-all opacity-0 scale-95">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200">
                <h3 id="science-log-title" class="text-xl font-medium leading-6 text-gray-900">Log de Ciência</h3>
                <button type="button" id="science-log-close-btn"
                    class="p-2 -m-2 rounded-full text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition-colors focus-ring-visible">
                    <span class="sr-only">Fechar</span>
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Carregador -->
                <div id="science-log-loading" class="text-center py-10">
                    <svg class="mx-auto h-8 w-8 text-slate-400 animate-spin" xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <p class="mt-3 text-slate-500">Buscando logs...</p>
                </div>

                <!-- Listas de Logs -->
                <div id="science-log-content" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold text-green-700 mb-3">Deram Ciência</h4>
                        <ul id="science-log-completed" class="space-y-2">
                            <!-- JS preenche aqui -->
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-red-700 mb-3">Pendentes</h4>
                        <ul id="science-log-pending" class="space-y-2">
                            <!-- JS preenche aqui -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithPopup,
            GoogleAuthProvider,
            OAuthProvider,
            signOut,
            getIdToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChhpPXpLTFGQfvJH55D_uQ2FG5PdKykcQ",
            authDomain: "minha-base-conhecimento.firebaseapp.com",
            projectId: "minha-base-conhecimento",
            storageBucket: "minha-base-conhecimento.firebasestorage.app",
            messagingSenderId: "586899421039",
            appId: "1:586899421039:web:99be661136602118175a9a"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        const microsoftProvider = new OAuthProvider('microsoft.com');
        setLogLevel('Debug');

        // --- ESTADO GLOBAL ---
        let currentUserRole = 'Leitor';
        let allCategoriesMap = new Map();
        let allUsersCache = [];
        let adminArticlesCache = [];
        let adminArticleCount = 0;
        const ADMIN_ARTICLES_PER_PAGE = 15;
        let adminIsLoadingMore = false;
        let adminIsSearchActive = false;
        // let adminScienceFilterActive = false; // Removido, estado lido direto do checkbox

        // --- REFERÊNCIAS DO DOM ---
        const loginSection = document.getElementById('login-section');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginStatus = document.getElementById('login-status');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const microsoftLoginBtn = document.getElementById('microsoft-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const userRoleSpan = document.getElementById('user-role');
        const adminStatus = document.getElementById('admin-status');

        // Seções de Permissão
        const articleFormSection = document.getElementById('article-form-section');
        const categoryAdminSection = document.getElementById('category-admin-section');
        const userAdminSection = document.getElementById('user-admin-section');

        // Formulário de Documento
        const articleForm = document.getElementById('article-form');
        const articleFormTitle = document.getElementById('article-form-title');
        const articleTitle = document.getElementById('article-title');
        const articleCategory = document.getElementById('article-category');
        const articleSummary = document.getElementById('article-summary');
        const linksContainer = document.getElementById('links-container');
        const addLinkBtn = document.getElementById('add-link-btn');
        const articlePublishedAt = document.getElementById('article-published-at');
        const articleTags = document.getElementById('article-tags');
        const articleIdInput = document.getElementById('article-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const requiresScienceCheckbox = document.getElementById('requires-science');
        const resetScienceContainer = document.getElementById('reset-science-container');
        const resetScienceBtn = document.getElementById('reset-science-btn');
        const isScienceResetInput = document.getElementById('is-science-reset');

        // Lista de Documentos Admin
        const articlesListAdmin = document.getElementById('articles-list-admin');
        const articlesLoadingMsg = document.getElementById('articles-loading-msg');
        const adminSearchInput = document.getElementById('admin-search-input');
        const adminLoadMoreContainer = document.getElementById('admin-load-more-container');
        const adminLoadMoreBtn = document.getElementById('admin-load-more-btn');
        const scienceToggleSwitch = document.getElementById('science-toggle-switch');

        // Formulário de Categoria
        const categoryForm = document.getElementById('category-form');
        const categoryFormTitle = document.getElementById('category-form-title');
        const categoryName = document.getElementById('category-name');
        const categoryColor = document.getElementById('category-color');
        const categoryIcon = document.getElementById('category-icon');
        const categoryIdInput = document.getElementById('category-id');
        const cancelCategoryEditBtn = document.getElementById('cancel-category-edit-btn');
        const categoryListAdmin = document.getElementById('category-list-admin');
        const categoriesLoadingMsg = document.getElementById('categories-loading-msg');

        // Gerenciamento de Usuários
        const userSearchInput = document.getElementById('user-search');
        const userListAdmin = document.getElementById('user-list-admin');
        const usersLoadingMsg = document.getElementById('users-loading-msg');

        // Modal de Confirmação
        const confirmModal = document.getElementById('confirm-modal');
        const modalBackdropConfirm = document.getElementById('modal-backdrop-confirm');
        const modalPanelConfirm = document.getElementById('modal-panel-confirm');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        // CORREÇÃO BUG: Removidas as declarações globais
        // const confirmModalBtnConfirm = document.getElementById('confirm-modal-btn-confirm');
        // const confirmModalBtnCancel = document.getElementById('confirm-modal-btn-cancel');

        // Modal de Log de Ciência
        const scienceLogModal = document.getElementById('science-log-modal');
        const modalBackdropScienceLog = document.getElementById('modal-backdrop-science-log');
        const modalPanelScienceLog = document.getElementById('modal-panel-science-log');
        const scienceLogTitle = document.getElementById('science-log-title');
        const scienceLogLoading = document.getElementById('science-log-loading');
        const scienceLogContent = document.getElementById('science-log-content');
        const scienceLogCompleted = document.getElementById('science-log-completed');
        const scienceLogPending = document.getElementById('science-log-pending');
        const scienceLogCloseBtn = document.getElementById('science-log-close-btn');

        // Editor Quill
        let quill;
        function initializeQuill() {
            if (!quill) {
                const toolbarOptions = [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'blockquote', 'code-block'],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ];
                quill = new Quill('#editor-container', {
                    modules: {
                        toolbar: toolbarOptions
                    },
                    theme: 'snow'
                });
            }
        }

        // --- FUNÇÃO WRAPPER DE FETCH (COM TOKEN MONOLITO) ---
        async function fetchWithToken(action, payload = {}) {
            if (!auth.currentUser) {
                showStatusMessage('Usuário não autenticado. Faça login novamente.', true);
                signOut(auth);
                throw new Error("Usuário não autenticado.");
            }
            try {
                const token = await getIdToken(auth.currentUser, /* forceRefresh */ true);

                const response = await fetch('api', { // Sempre chama a API raiz
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, payload }) // Envia a ação e o payload
                });

                const responseText = await response.text();
                if (!response.ok) {
                    let errorMessage = `Erro ${response.status}`;
                    if (responseText) {
                        try {
                            const errorData = JSON.parse(responseText);
                            if (errorData.error) errorMessage = errorData.error;
                        } catch (e) {
                            console.error("Erro HTML/Texto (não-JSON) recebido:", responseText.substring(0, 100) + '...');
                            errorMessage = `Erro ${response.status}: A API não foi encontrada ou retornou um erro inesperado.`;
                        }
                    }
                    console.error(`Erro na API (ação: ${action}, status: ${response.status}):`, errorMessage);
                    // MUDANÇA WHITELIST: Lança o erro específico
                    if (response.status === 403) {
                        throw new Error('ACESSO_NEGADO: Seu e-mail não está autorizado.');
                    }
                    throw new Error(errorMessage);
                }
                if (!responseText) return null;
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    console.warn("Resposta da API não era JSON:", responseText);
                    return responseText;
                }
            } catch (error) {
                console.error("Erro fatal no fetchWithToken:", error);
                showStatusMessage(error.message || 'Erro de rede ou autenticação.', true);
                throw error;
            }
        }


        // --- AUTENTICAÇÃO (COM SISTEMA DE CARGOS E WHITELIST) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const { role, email } = await fetchWithToken('user/upsert');
                    currentUserRole = role;

                    if (role === 'Leitor') {
                        window.location.href = 'index.html';
                        return;
                    }

                    adminDashboard.style.display = 'block';
                    loginSection.style.display = 'none';
                    userEmailSpan.textContent = email;
                    userRoleSpan.textContent = role;

                    initializeQuill();
                    resetLinksContainer();

                    // CORREÇÃO BUG 1 (FLICKERING): Espera as categorias carregarem
                    await loadCategories();
                    await executeAdminSearch(true); // Só então carrega os documentos

                    updateUIVisibility(role);

                    if (role === 'Admin') {
                        loadUsers();
                    }

                } catch (error) {
                    console.error("Erro ao verificar cargo do usuário:", error);
                    // MUDANÇA: Trata o erro de Whitelist
                    if (error.message.includes('ACESSO_NEGADO')) {
                        loginStatus.textContent = 'Acesso Negado. Seu e-mail não está autorizado.';
                    } else {
                        loginStatus.textContent = 'Erro ao verificar permissões. Tente novamente.';
                    }
                    await signOut(auth);
                }
            } else {
                // Usuário está deslogado
                loginSection.style.display = 'flex';
                adminDashboard.style.display = 'none';
                userEmailSpan.textContent = '';
                userRoleSpan.textContent = '';
                currentUserRole = 'Leitor';
                if (quill) {
                    quill = null;
                }
            }
        });

        // Logins (Removido e-mail/senha)
        const loginFormElement = document.getElementById('login-form');
        if (loginFormElement) {
            loginFormElement.style.display = 'none';
            const divisor = loginFormElement.nextElementSibling;
            if (divisor && divisor.classList.contains('relative')) {
                divisor.style.display = 'none';
            }
        }

        googleLoginBtn.addEventListener('click', () => {
            loginStatus.textContent = 'Abrindo popup do Google...';
            signInWithPopup(auth, googleProvider).catch(handleAuthError);
        });

        // Esconde o botão da Microsoft (você removeu do HTML, mas
        // este código evita erro caso ele volte)
        if (microsoftLoginBtn) {
            microsoftLoginBtn.style.display = 'none';
        }
        /*
        microsoftLoginBtn.addEventListener('click', () => {
            loginStatus.textContent = 'Abrindo popup da Microsoft...';
            signInWithPopup(auth, microsoftProvider).catch(handleAuthError);
        });
        */

        function handleAuthError(error) {
            console.error("Erro de login:", error.code, error.message);
            // MUDANÇA: Trata o erro de Whitelist
            if (error.message.includes('ACESSO_NEGADO')) {
                loginStatus.textContent = 'Acesso Negado. Seu e-mail não está autorizado.';
            } else if (error.code === 'auth/popup-closed-by-user') {
                loginStatus.textContent = 'Popup de login fechado.';
            } else if (error.code === 'auth/unauthorized-domain') {
                loginStatus.textContent = 'Erro: Domínio não autorizado.';
                alert("ERRO: O domínio do seu site não está autorizado. \n\nPor favor, vá ao Console do Firebase > Authentication > Settings > Authorized domains e adicione o domínio onde este site está hospedado.");
            } else {
                loginStatus.textContent = 'Erro ao tentar fazer login.';
            }
        }

        // Logout (COM MODAL CUSTOMIZADO)
        logoutBtn.addEventListener('click', () => {
            showConfirmModal(
                'Sair do Painel',
                'Tem certeza que deseja sair?',
                async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Erro ao sair:", error);
                        showStatusMessage('Erro ao tentar sair.', true);
                    }
                },
                'Sair'
            );
        });

        // Controla a visibilidade da UI com base no cargo
        function updateUIVisibility(role) {
            articleFormSection.style.display = (role === 'Redator' || role === 'Editor' || role === 'Admin') ? 'block' : 'none';
            categoryAdminSection.style.display = (role === 'Admin') ? 'block' : 'none';
            userAdminSection.style.display = (role === 'Admin') ? 'block' : 'none';
            document.getElementById('science-filter-container').style.display = (role === 'Editor' || role === 'Admin') ? 'flex' : 'none';

            const categorySelectDiv = articleCategory.closest('div');
            if (categorySelectDiv) {
                categorySelectDiv.style.display = (role === 'Editor' || role === 'Admin') ? 'block' : 'none';
            }

            document.querySelectorAll('.permission-admin').forEach(el => {
                el.style.display = (role === 'Admin') ? 'block' : 'none';
            });

            // CORREÇÃO BUG 3: A lógica de mostrar/esconder botões agora
            // é feita 100% dentro do 'renderAdminArticles'
        }


        // --- GERENCIAMENTO DE CATEGORIAS (CRUD) ---
        // (Inalterado)
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const categoryData = { name: categoryName.value, color: categoryColor.value, icon: categoryIcon.value, slug: slugify(categoryName.value) };
            try {
                if (id) categoryData.id = id;
                await fetchWithToken('admin/salvarCategoria', categoryData);
                showStatusMessage(id ? 'Categoria atualizada!' : 'Categoria salva!');
                resetCategoryForm();
                loadCategories(); // Auto-refresh
            } catch (error) {
                console.error("Erro ao salvar categoria: ", error);
                showStatusMessage(error.message || 'Erro ao salvar categoria.', true);
            }
        });

        async function loadCategories() {
            categoriesLoadingMsg.style.display = 'block';
            try {
                const categories = await fetchWithToken('getCategorias');
                categoriesLoadingMsg.classList.add('hidden');
                categoryListAdmin.innerHTML = '';
                articleCategory.innerHTML = '<option value="">-- Selecione uma categoria --</option>';
                allCategoriesMap.clear();
                categories.sort((a, b) => a.name.localeCompare(b.name));

                categories.forEach(category => {
                    allCategoriesMap.set(category.id, category);
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-3 bg-slate-50 rounded-lg';
                    el.innerHTML = `
                        <span class="font-medium text-slate-700">${category.name}</span>
                        <div class="flex gap-2">
                            <button data-id="${category.id}" class="edit-category-btn text-blue-600 hover:text-blue-800 focus-ring-visible rounded-md p-1" style="display: ${currentUserRole === 'Admin' ? 'inline-flex' : 'none'}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button data-id="${category.id}" data-name="${category.name}" class="delete-category-btn text-red-600 hover:text-red-800 focus-ring-visible rounded-md p-1" style="display: ${currentUserRole === 'Admin' ? 'inline-flex' : 'none'}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    categoryListAdmin.appendChild(el);
                    const opt = document.createElement('option');
                    opt.value = category.id;
                    opt.textContent = category.name;
                    articleCategory.appendChild(opt);
                });
                if (categories.length === 0) {
                    categoriesLoadingMsg.textContent = 'Nenhuma categoria encontrada.';
                    categoriesLoadingMsg.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao carregar categorias: ", error);
                categoriesLoadingMsg.textContent = error.message || 'Erro ao carregar categorias.';
                categoriesLoadingMsg.classList.remove('hidden');
            }
        }
        categoryListAdmin.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-category-btn');
            const deleteBtn = e.target.closest('.delete-category-btn');
            if (editBtn) populateCategoryForm(editBtn.dataset.id);
            if (deleteBtn) deleteCategory(deleteBtn.dataset.id, deleteBtn.dataset.name);
        });
        function populateCategoryForm(id) {
            const category = allCategoriesMap.get(id);
            if (category) {
                categoryFormTitle.textContent = 'Editar Categoria';
                categoryIdInput.value = id;
                categoryName.value = category.name;
                categoryColor.value = category.color;
                categoryIcon.value = category.icon;
                cancelCategoryEditBtn.classList.remove('hidden');
                window.scrollTo({ top: categoryForm.offsetTop, behavior: 'smooth' });
            }
        }
        async function deleteCategory(id, name) {
            showConfirmModal(
                'Deletar Categoria',
                `Tem certeza que quer deletar a categoria "${name}"? Documentos nesta categoria ficarão órfãos.`,
                async () => {
                    try {
                        await fetchWithToken('admin/deletarCategoria', { id: id });
                        showStatusMessage('Categoria deletada.');
                        resetCategoryForm();
                        loadCategories();
                    } catch (error) {
                        console.error("Erro ao deletar categoria: ", error);
                        showStatusMessage(error.message || 'Erro ao deletar categoria.', true);
                    }
                }
            );
        }
        function resetCategoryForm() {
            categoryForm.reset();
            categoryIdInput.value = '';
            categoryFormTitle.textContent = 'Gerenciar Categorias';
            cancelCategoryEditBtn.classList.add('hidden');
        }
        cancelCategoryEditBtn.addEventListener('click', resetCategoryForm);


        // --- GERENCIAMENTO DE ARTIGOS (CRUD) ---

        // Salvar/Atualizar Documento (COM LÓGICA DE CIÊNCIA)
        articleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = articleIdInput.value;
            const publishedDate = articlePublishedAt.value;
            const tagsArray = articleTags.value.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            const linksArray = Array.from(linksContainer.querySelectorAll('input')).map(input => input.value.trim()).filter(link => link.length > 0);

            const articleData = {
                title: articleTitle.value,
                categoryId: articleCategory.value,
                summary: articleSummary.value,
                links: linksArray,
                tags: tagsArray,
                content: quill.root.innerHTML,
                slug: slugify(articleTitle.value),
                requiresScience: requiresScienceCheckbox.checked,
                isScienceReset: isScienceResetInput.value === 'true'
            };

            if (id) articleData.id = id;
            if (publishedDate) articleData.publishedAt = publishedDate;

            try {
                await fetchWithToken('admin/salvarArtigo', articleData);
                showStatusMessage(id ? 'Documento atualizado!' : 'Documento salvo!');
                resetArticleForm();
                await executeAdminSearch(true); // REFRESH AUTOMÁTICO
            } catch (error) {
                console.error("Erro ao salvar documento: ", error);
                showStatusMessage(error.message || 'Erro ao salvar documento.', true);
            }
        });

        // Lógica do botão Resetar Ciência
        resetScienceBtn.addEventListener('click', () => {
            showConfirmModal(
                'Resetar Ciência do Documento',
                'Isso forçará TODOS os usuários a darem ciência deste documento novamente. Tem certeza?',
                () => {
                    isScienceResetInput.value = 'true';
                    articleForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                },
                'Sim, Resetar'
            );
        });

        // BUSCA E PAGINAÇÃO NO ADMIN
        adminSearchInput.addEventListener('input', () => {
            clearTimeout(adminSearchInput.timeoutId);
            adminSearchInput.timeoutId = setTimeout(() => {
                executeAdminSearch(true);
            }, 300);
        });
        adminLoadMoreBtn.addEventListener('click', () => {
            if (!adminIsLoadingMore) {
                executeAdminSearch(false);
            }
        });

        // Listener do Switch de Ciência
        scienceToggleSwitch.addEventListener('change', () => {
            filterAdminListByScience();
        });

        // Filtro local do Switch de Ciência
        function filterAdminListByScience() {
            const showOnlyScience = scienceToggleSwitch.checked;
            let count = 0;
            document.querySelectorAll('.article-row').forEach(row => {
                const requiresScience = row.dataset.requiresScience === 'true';
                if (showOnlyScience) {
                    if (requiresScience) {
                        row.style.display = 'flex';
                        count++;
                    } else {
                        row.style.display = 'none';
                    }
                } else {
                    row.style.display = 'flex';
                    count++;
                }
            });
            // Atualiza mensagem de "vazio"
            if (count === 0 && (showOnlyScience || adminSearchInput.value.trim() !== '')) {
                articlesLoadingMsg.textContent = 'Nenhum documento encontrado para este filtro.';
                articlesLoadingMsg.style.display = 'block';
            } else if (count > 0) {
                articlesLoadingMsg.style.display = 'none';
            } else if (count === 0 && adminArticlesCache.length > 0) {
                // Caso onde o filtro de ciência não encontra nada, mas o cache não está vazio
                articlesLoadingMsg.textContent = 'Nenhum documento encontrado para este filtro.';
                articlesLoadingMsg.style.display = 'block';
            }
        }


        // Carregar Documentos (COM BUSCA E PAGINAÇÃO)
        async function executeAdminSearch(reset = false) {
            if (adminIsLoadingMore) return;
            adminIsLoadingMore = true;

            if (reset) {
                adminArticlesCache = [];
                adminArticleCount = 0;
                articlesListAdmin.innerHTML = '';
            }

            const searchTerm = adminSearchInput.value.trim();
            const limit = adminArticleCount + ADMIN_ARTICLES_PER_PAGE;

            articlesLoadingMsg.style.display = 'block';
            articlesLoadingMsg.textContent = 'Carregando documentos...'; // Reseta a msg
            adminLoadMoreBtn.textContent = 'Carregando...';
            adminLoadMoreBtn.disabled = true;

            try {
                let articles = [];
                if (searchTerm === '') {
                    adminIsSearchActive = false;
                    articles = await fetchWithToken('getArtigos', { limit: limit, category: 'TODOS' });
                } else {
                    adminIsSearchActive = true;
                    adminLoadMoreContainer.classList.add('hidden');
                    articles = await fetchWithToken('searchArtigos', {
                        term: searchTerm,
                        scope: 'all',
                        category: 'TODOS'
                    });
                }

                const newArticles = articles.filter(a => !adminArticlesCache.some(existing => existing.id === a.id));
                adminArticlesCache = articles;
                adminArticleCount = articles.length;

                if (adminIsSearchActive || newArticles.length === 0 || articles.length < limit) {
                    adminLoadMoreContainer.classList.add('hidden');
                } else {
                    adminLoadMoreContainer.classList.remove('hidden');
                }

                renderAdminArticles(newArticles); // Renderiza apenas os novos

                // Aplica o filtro do switch de ciência
                filterAdminListByScience();

            } catch (error) {
                console.error("Erro ao carregar documentos (admin): ", error);
                articlesLoadingMsg.textContent = error.message || 'Erro ao carregar documentos.';
            } finally {
                adminIsLoadingMore = false;
                adminLoadMoreBtn.textContent = 'Carregar Mais';
                adminLoadMoreBtn.disabled = false;

                // Lógica de exibição da mensagem de 'loading'
                const anyArticlesVisible = articlesListAdmin.querySelector('.article-row:not([style*="display: none"])');

                if (anyArticlesVisible) {
                    articlesLoadingMsg.style.display = 'none';
                } else if (adminArticlesCache.length === 0 && searchTerm !== '') {
                    articlesLoadingMsg.textContent = 'Nenhum documento encontrado para esta busca.';
                    articlesLoadingMsg.style.display = 'block';
                } else if (adminArticlesCache.length === 0 && searchTerm === '') {
                    articlesLoadingMsg.textContent = 'Nenhum documento publicado.';
                    articlesLoadingMsg.style.display = 'block';
                } else if (!anyArticlesVisible && scienceToggleSwitch.checked) {
                    // Já tratado por filterAdminListByScience
                } else if (!anyArticlesVisible && searchTerm !== '') {
                    articlesLoadingMsg.textContent = 'Nenhum documento encontrado para esta busca.';
                    articlesLoadingMsg.style.display = 'block';
                }
            }
        }

        // Função separada para RENDERIZAR os documentos do Admin
        function renderAdminArticles(articlesToRender) {

            if (articlesToRender.length === 0 && adminArticlesCache.length === 0) {
                articlesLoadingMsg.textContent = 'Nenhum documento encontrado.';
                articlesLoadingMsg.style.display = 'block';
                return;
            }

            const fragment = document.createDocumentFragment();
            articlesToRender.forEach(article => {
                const category = allCategoriesMap.get(article.categoryId);
                const categoryName = category ? category.name : 'Sem Categoria';
                const date = article.publishedAt
                    ? new Date(article.publishedAt.seconds * 1000).toLocaleDateString()
                    : 'Salvando...';

                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-4 bg-slate-50 rounded-lg article-row';
                el.dataset.requiresScience = article.requiresScience || 'false';

                const requiresScienceIcon = article.requiresScience
                    ? `<svg class="w-4 h-4 text-red-500 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" title="Exige Ciência"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`
                    : '';

                // CORREÇÃO BUG 3: Botão de Log de Ciência agora é condicional
                const scienceLogBtnHTML = (article.requiresScience && (currentUserRole === 'Editor' || currentUserRole === 'Admin'))
                    ? `<button data-id="${article.id}" data-title="${article.title}" class="science-log-btn text-gray-500 hover:text-blue-600 focus-ring-visible rounded-md p-1" title="Ver Log de Ciência">
                           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                           </svg>
                       </button>`
                    : '';

                el.innerHTML = `
                     <div class="flex items-center min-w-0">
                         <div class="min-w-0">
                             <strong class="text-slate-800 truncate block" title="${article.title}">${article.title}</strong>
                             <span class="block text-sm text-slate-500">${categoryName} - ${date}</span>
                         </div>
                         ${requiresScienceIcon}
                     </div>
                     <div class="flex gap-2 flex-shrink-0">
                         ${scienceLogBtnHTML}
                         <button data-id="${article.id}" class="edit-article-btn text-blue-600 hover:text-blue-800 focus-ring-visible rounded-md p-1" style="display: ${currentUserRole === 'Editor' || currentUserRole === 'Admin' ? 'inline-flex' : 'none'}">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                         </button>
                         <button data-id="${article.id}" data-title="${article.title}" class="delete-article-btn text-red-600 hover:text-red-800 focus-ring-visible rounded-md p-1" style="display: ${currentUserRole === 'Admin' ? 'inline-flex' : 'none'}">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                         </button>
                     </div>
                 `;
                fragment.appendChild(el);
            });
            articlesListAdmin.appendChild(fragment);
            // Atualiza a visibilidade dos botões recém-criados
            updateUIVisibility(currentUserRole);
        }

        // Delegação de Eventos para botões de Documento
        articlesListAdmin.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-article-btn');
            const deleteBtn = e.target.closest('.delete-article-btn');
            const scienceBtn = e.target.closest('.science-log-btn'); // NOVO

            if (editBtn) populateArticleForm(editBtn.dataset.id);
            if (deleteBtn) deleteArticle(deleteBtn.dataset.id, deleteBtn.dataset.title);
            if (scienceBtn) openScienceLogModal(scienceBtn.dataset.id, scienceBtn.dataset.title); // NOVO
        });

        // Preencher formulário de Documento para edição
        async function populateArticleForm(id) {
            try {
                const article = await fetchWithToken('getArtigoDetalhe', { id: id });

                articleFormTitle.textContent = 'Editar Documento';
                articleIdInput.value = id;
                articleTitle.value = article.title;
                articleCategory.value = article.categoryId;
                articleSummary.value = article.summary;
                articleTags.value = (article.tags || []).join(', ');

                if (article.publishedAt) {
                    const date = new Date(article.publishedAt.seconds * 1000);
                    articlePublishedAt.value = date.toISOString().split('T')[0];
                } else {
                    articlePublishedAt.value = '';
                }

                resetLinksContainer();
                const linkInputs = linksContainer.querySelectorAll('input');
                const links = article.links || [];

                links.forEach((link, index) => {
                    if (index === 0) {
                        linkInputs[0].value = link;
                    } else {
                        addLinkInput(link);
                    }
                });

                // Popula dados de Ciência
                requiresScienceCheckbox.checked = article.requiresScience || false;
                if (article.requiresScience) {
                    resetScienceContainer.classList.remove('hidden');
                } else {
                    resetScienceContainer.classList.add('hidden');
                }
                isScienceResetInput.value = 'false';

                quill.root.innerHTML = article.content;
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: articleForm.offsetTop, behavior: 'smooth' });

            } catch (error) {
                console.error("Erro ao buscar documento:", error);
                showStatusMessage(error.message || 'Erro ao carregar documento para edição.', true);
            }
        }

        // Mostra/Esconde o botão de Resetar Ciência
        requiresScienceCheckbox.addEventListener('change', () => {
            if (requiresScienceCheckbox.checked && articleIdInput.value) {
                resetScienceContainer.classList.remove('hidden');
            } else {
                resetScienceContainer.classList.add('hidden');
            }
        });

        // Deletar Documento (COM MODAL CUSTOMIZADO)
        async function deleteArticle(id, title) {
            showConfirmModal(
                'Deletar Documento',
                `Tem certeza que quer deletar o documento "${title || 'este documento'}"?`,
                async () => {
                    try {
                        await fetchWithToken('admin/deletarArtigo', { id: id });
                        showStatusMessage('Documento deletado.');
                        resetArticleForm();
                        await executeAdminSearch(true); // REFRESH AUTOMÁTICO
                    } catch (error) {
                        console.error("Erro ao deletar documento: ", error);
                        showStatusMessage(error.message || 'Erro ao deletar documento.', true);
                    }
                }
            );
        }

        // Limpar formulário de Documento
        function resetArticleForm() {
            articleForm.reset();
            articleIdInput.value = '';
            if (quill) {
                quill.root.innerHTML = '';
            }
            articleFormTitle.textContent = 'Adicionar Novo Documento';
            cancelEditBtn.classList.add('hidden');
            resetLinksContainer();
            resetScienceContainer.classList.add('hidden');
            isScienceResetInput.value = 'false';
        }
        cancelEditBtn.addEventListener('click', resetArticleForm);


        // --- GERENCIAMENTO DE LINKS MÚLTIPLOS ---
        // (Inalterado)
        function createLinkInput(value = '') {
            const inputCount = linksContainer.querySelectorAll('input').length;
            if (inputCount >= 5) return;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            const input = document.createElement('input');
            input.type = 'url';
            input.placeholder = `https://exemplo.com/link-${inputCount + 1}`;
            input.className = 'w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 link-input';
            input.value = value;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-500 hover:text-red-700 p-1 rounded-full focus-ring-visible';
            removeBtn.ariaLabel = 'Remover link';
            removeBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
            removeBtn.addEventListener('click', () => {
                div.remove();
                updateAddLinkButton();
            });
            div.appendChild(input);
            div.appendChild(removeBtn);
            linksContainer.appendChild(div);
            updateAddLinkButton();
        }
        function addLinkInput(value = '') { createLinkInput(value); }
        function updateAddLinkButton() {
            const inputCount = linksContainer.querySelectorAll('input').length;
            if (inputCount >= 5) {
                addLinkBtn.classList.add('hidden');
            } else {
                addLinkBtn.classList.remove('hidden');
            }
        }
        function resetLinksContainer() {
            linksContainer.innerHTML = '';
            addLinkInput();
        }
        addLinkBtn.addEventListener('click', () => addLinkInput());


        // --- NOVO: GERENCIAMENTO DE USUÁRIOS (ROLES) ---

        userSearchInput.addEventListener('input', () => {
            const filter = userSearchInput.value.toLowerCase();
            document.querySelectorAll('#user-list-admin .user-row').forEach(row => {
                const email = row.dataset.email.toLowerCase();
                if (email.includes(filter)) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        async function loadUsers() {
            usersLoadingMsg.style.display = 'block';
            userListAdmin.innerHTML = '';
            allUsersCache = [];

            try {
                const users = await fetchWithToken('admin/getUsers');
                allUsersCache = users;
                renderUsers(users);
                usersLoadingMsg.style.display = 'none';
            } catch (error) {
                console.error("Erro ao carregar usuários: ", error);
                usersLoadingMsg.textContent = error.message || 'Erro ao carregar usuários.';
            }
        }

        function renderUsers(users) {
            userListAdmin.innerHTML = '';
            if (users.length === 0) {
                usersLoadingMsg.textContent = 'Nenhum usuário encontrado (além de você).';
                usersLoadingMsg.style.display = 'block';
                return;
            }

            users.sort((a, b) => a.email.localeCompare(b.email));

            users.forEach(user => {
                const el = document.createElement('div');
                el.className = 'user-row flex justify-between items-center p-3 bg-slate-50 rounded-lg';
                el.dataset.email = user.email;
                const roleSelectId = `role-select-${user.uid}`;
                el.innerHTML = `
                    <div class="flex-grow overflow-hidden">
                        <span class="font-medium text-slate-800 text-sm truncate block" title="${user.email}">${user.email}</span>
                    </div>
                    <div class="flex-shrink-0 ml-2">
                        <select id="${roleSelectId}" data-uid="${user.uid}" class="role-select w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm">
                            <option value="Leitor" ${user.role === 'Leitor' ? 'selected' : ''}>Leitor</option>
                            <option value="Redator" ${user.role === 'Redator' ? 'selected' : ''}>Redator</option>
                            <option value="Editor" ${user.role === 'Editor' ? 'selected' : ''}>Editor</option>
                            <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </div>
                `;
                userListAdmin.appendChild(el);
            });
        }

        userListAdmin.addEventListener('change', async (e) => {
            if (e.target.classList.contains('role-select')) {
                const selectEl = e.target;
                const uid = selectEl.dataset.uid;
                const newRole = selectEl.value;
                const userEmail = allUsersCache.find(u => u.uid === uid)?.email || 'este usuário';

                showConfirmModal(
                    'Mudar Permissão',
                    `Tem certeza que quer mudar o cargo de ${userEmail} para ${newRole}?`,
                    async () => {
                        try {
                            await fetchWithToken('admin/updateUserRole', { uid: uid, role: newRole });
                            showStatusMessage('Cargo do usuário atualizado!');
                            loadUsers();
                        } catch (error) {
                            console.error("Erro ao atualizar cargo:", error);
                            showStatusMessage(error.message || 'Erro ao atualizar cargo.', true);
                            const user = allUsersCache.find(u => u.uid === uid);
                            if (user) selectEl.value = user.role;
                        }
                    },
                    'Confirmar',
                    () => { // onCancel
                        const user = allUsersCache.find(u => u.uid === uid);
                        if (user) selectEl.value = user.role;
                    }
                );
            }
        });

        // --- QOL: MODAL DE CONFIRMAÇÃO CUSTOMIZADO ---
        let onConfirmCallback = null;
        let onCancelCallback = null;

        function showConfirmModal(title, message, onConfirm, confirmText = 'Confirmar', onCancel = null) {
            confirmModalTitle.textContent = title;
            confirmModalMessage.textContent = message;

            // CORREÇÃO BUG: As variáveis são re-selecionadas *dentro* da função
            let confirmBtn = document.getElementById('confirm-modal-btn-confirm');
            let cancelBtn = document.getElementById('confirm-modal-btn-cancel');

            confirmBtn.textContent = confirmText;

            // Limpa listeners antigos (essencial)
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            // Adiciona novos listeners
            newConfirmBtn.addEventListener('click', () => {
                if (onConfirmCallback) onConfirmCallback();
                closeConfirmModal();
            });
            newCancelBtn.addEventListener('click', () => {
                if (onCancelCallback) onCancelCallback();
                closeConfirmModal();
            });

            onConfirmCallback = onConfirm;
            onCancelCallback = onCancel;

            confirmModal.style.display = 'flex';
            setTimeout(() => {
                modalBackdropConfirm.style.opacity = '1';
                modalPanelConfirm.style.opacity = '1';
                modalPanelConfirm.style.transform = 'scale(1)';
            }, 10);
        }

        function closeConfirmModal() {
            modalPanelConfirm.style.opacity = '0';
            modalPanelConfirm.style.transform = 'scale(0.95)';
            modalBackdropConfirm.style.opacity = '0';
            setTimeout(() => {
                confirmModal.style.display = 'none';
                onConfirmCallback = null;
                onCancelCallback = null;
            }, 300);
        }
        modalBackdropConfirm.addEventListener('click', closeConfirmModal);


        // --- ETAPA 3.C: MODAL DE LOG DE CIÊNCIA ---

        async function openScienceLogModal(articleId, articleTitle) {
            scienceLogTitle.textContent = `Log de Ciência: ${articleTitle || 'Documento'}`;
            scienceLogContent.style.display = 'none';
            scienceLogLoading.style.display = 'block';
            scienceLogCompleted.innerHTML = '';
            scienceLogPending.innerHTML = '';

            scienceLogModal.style.display = 'flex';
            setTimeout(() => {
                // CORREÇÃO: Variável com typo
                modalBackdropScienceLog.style.opacity = '1';
                modalPanelScienceLog.style.opacity = '1';
                modalPanelScienceLog.style.transform = 'scale(1)';
            }, 10);

            try {
                // Chama a API de log
                const { completed, pending } = await fetchWithToken('admin/getScienceLog', { articleId: articleId });

                // Renderiza as listas
                renderLogList(scienceLogCompleted, completed, true);
                renderLogList(scienceLogPending, pending, false);

                scienceLogLoading.style.display = 'none';
                scienceLogContent.style.display = 'grid';

            } catch (error) {
                console.error("Erro ao buscar log de ciência:", error);
                scienceLogLoading.style.display = 'none';
                scienceLogCompleted.innerHTML = `<li class="text-red-500">${error.message || 'Erro ao carregar dados.'}</li>`;
            }
        }

        function renderLogList(listElement, users, showDate) {
            if (users.length === 0) {
                listElement.innerHTML = `<li class="text-sm text-gray-500">Nenhum usuário.</li>`;
                return;
            }
            // Ordena por e-mail
            users.sort((a, b) => a.email.localeCompare(b.email));

            listElement.innerHTML = users.map(user => {
                const date = showDate && user.declaredAt
                    ? new Date(user.declaredAt.seconds * 1000).toLocaleString('pt-BR')
                    : '';
                return `
                    <li class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                        <span class="text-gray-700 truncate" title="${user.email}">${user.email}</span>
                        ${showDate ? `<span class="text-gray-500 text-xs flex-shrink-0 ml-2">${date}</span>` : ''}
                    </li>
                `;
            }).join('');
        }

        function closeScienceLogModal() {
            modalPanelScienceLog.style.opacity = '0';
            modalPanelScienceLog.style.transform = 'scale(0.95)';
            modalBackdropScienceLog.style.opacity = '0';
            setTimeout(() => {
                scienceLogModal.style.display = 'none';
            }, 300);
        }

        scienceLogCloseBtn.addEventListener('click', closeScienceLogModal);
        modalBackdropScienceLog.addEventListener('click', closeScienceLogModal);


        // --- FUNÇÕES UTILITÁRIAS ---
        let statusTimeout;
        function showStatusMessage(message, isError = false) {
            clearTimeout(statusTimeout);
            adminStatus.textContent = message;
            adminStatus.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            adminStatus.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            statusTimeout = setTimeout(() => {
                adminStatus.classList.add('hidden');
            }, 3000);
        }

        function slugify(text) {
            return text.toString().toLowerCase().trim()
                .normalize('NFD') // remove acentos
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, '-')
                .replace(/[^\w-]+/g, '')
                .replace(/--+/g, '-');
        }

    </script>

</body>

</html>