<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Documentos Jurídicos</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Google Fonts para uma melhor tipografia -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para a área de impressão, para garantir boa aparência no PDF */
        #printable-area,
        #petition-area {
            font-family: 'Times New Roman', Times, serif;
            /* Fonte padrão para documentos legais */
            color: #111827;
        }

        p.border-t.border-gray-800.w-3\/4.mx-auto {
            padding-top: 0;
            margin-top: 0;
            line-height: normal;
        }

        #petition-area {
            line-height: 2;
            text-align: justify;
            font-size: 12pt;
        }

        /* Estilo para o spinner de carregamento */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            cursor: pointer;
            color: #3b82f6;
        }

        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <style>
        .card-surface {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(244, 247, 254, 0.96));
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 25px 70px rgba(0, 12, 84, 0.08), 0 8px 24px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-indigo-50 to-white min-h-screen p-6 text-slate-800">

    <div class="w-full max-w-6xl mx-auto card-surface rounded-3xl p-6 md:p-10">

        <header class="text-center mb-8">
            <p class="uppercase tracking-[0.25em] text-xs font-semibold text-indigo-500 mb-2">JEC • Marília/SP</p>
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-slate-900">Gerador de Documentos Jurídicos
            </h1>
            <p id="main-subtitle" class="text-slate-600 mt-2">Escolha a ferramenta, preencha os campos e gere PDFs
                prontos para protocolo.</p>
        </header>

        <main>
            <!-- SELETOR PRINCIPAL DE APLICAÇÃO -->
            <div class="mb-8">
                <label for="main-app-type" class="block text-sm font-medium text-gray-700 mb-2">Ferramenta</label>
                <select id="main-app-type"
                    class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                    <option value="manifestation">Gerador de Petições/Manifestações</option>
                    <option value="calculator">Calculadora Judicial</option>
                </select>
            </div>


            <!-- ############################################ -->
            <!-- ### CONTAINER DA CALCULADORA JUDICIAL ### -->
            <!-- ############################################ -->
            <div id="calculator-app-container" class="hidden">
                <!-- Seção de parâmetros gerais do cálculo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="process-number-calc" class="block text-sm font-medium text-gray-700 mb-2">Número do
                            Processo
                            (Padrão CNJ)</label>
                        <input type="text" id="process-number-calc" name="process-number-calc"
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Apenas números" maxlength="25">
                    </div>
                    <div>
                        <label for="calculation-type" class="block text-sm font-medium text-gray-700 mb-2">Tipo de
                            Cálculo</label>
                        <select id="calculation-type"
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="condemnation">Atualização da Condenação</option>
                            <option value="agreement">Atualização por Descumprimento de Acordo</option>
                        </select>
                    </div>
                    <div>
                        <label for="final-date" class="block text-sm font-medium text-gray-700 mb-2">Data Final
                            (Opcional)</label>
                        <input type="text" id="final-date"
                            class="date-input w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Padrão: Hoje">
                    </div>
                </div>


                <!-- Container para Atualização da Condenação -->
                <div id="condemnation-container">
                    <!-- Container para as linhas de cálculo -->
                    <div id="calculation-rows" class="space-y-4">
                        <!-- Linha de exemplo, será clonada -->
                        <div
                            class="calculation-row grid grid-cols-1 md:grid-cols-12 gap-4 items-end p-4 border border-gray-200 rounded-lg">
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Descrição</label>
                                <select
                                    class="description-select w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                                    <option value="Dano Material">Dano Material</option>
                                    <option value="Dano Moral">Dano Moral</option>
                                    <option value="Restituição">Restituição</option>
                                    <option value="Multa">Multa</option>
                                    <option value="Última Atualização">Última Atualização</option>
                                    <option value="Dedução/Pagamento Parcial">Dedução/Pagamento Parcial</option>
                                    <option value="Outro">Outro</option>
                                </select>
                                <input type="text"
                                    class="other-description-input w-full mt-2 p-2 border border-gray-300 rounded-lg shadow-sm hidden"
                                    placeholder="Digite a descrição">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <input type="text"
                                    class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="1.000,00">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Data Inicial (Correção)</label>
                                <input type="text"
                                    class="date-input correction-date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="DD/MM/AAAA">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Data Inicial (Juros)</label>
                                <input type="text"
                                    class="date-input interest-date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="DD/MM/AAAA">
                            </div>
                            <div class="md:col-span-1">
                                <button
                                    class="remove-row-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-colors duration-200"
                                    title="Remover Linha">&times;</button>
                            </div>
                        </div>
                    </div>

                    <!-- Botão para adicionar mais linhas -->
                    <div class="mt-6 flex justify-start">
                        <button id="add-row-btn"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">+
                            Adicionar Linha</button>
                    </div>

                </div>

                <!-- Container para Descumprimento de Acordo -->
                <div id="agreement-container" class="hidden">
                    <div class="p-4 border border-gray-200 rounded-lg space-y-4">
                        <div>
                            <label for="agreement-type-calc" class="block text-sm font-medium text-gray-700">Tipo de
                                Descumprimento</label>
                            <select id="agreement-type-calc" required
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                                <option value="conhecimento">Acordo Descumprido em Processo de Conhecimento</option>
                                <option value="execucao">Acordo Descumprido em Execução/Cumprimento de Sentença</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nº de Parcelas Totais</label>
                                <input id="agreement-total-installments" type="number"
                                    class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="Ex: 10">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nº de Parcelas Pagas</label>
                                <input id="agreement-paid-installments" type="number"
                                    class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="Ex: 3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Valor da Parcela (R$)</label>
                                <input id="agreement-installment-value" type="text"
                                    class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="500,00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Data Início do Acordo</label>
                                <input id="agreement-start-date" type="text"
                                    class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="DD/MM/AAAA">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Multa pelo Descumprimento</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                                <select id="agreement-penalty"
                                    class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                                    <option value="0">Sem multa</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                    <option value="30">30%</option>
                                    <option value="50">50%</option>
                                    <option value="100">100%</option>
                                </select>
                                <div class="mt-1 space-y-1">
                                    <label class="flex items-center text-sm">
                                        <input type="radio" name="penalty-base" value="remaining"
                                            class="h-4 w-4 text-indigo-600 border-gray-300" checked>
                                        <span class="ml-2 text-gray-700">Aplicar sobre saldo remanescente
                                            atualizado</span>
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="radio" name="penalty-base" value="total"
                                            class="h-4 w-4 text-indigo-600 border-gray-300">
                                        <span class="ml-2 text-gray-700">Aplicar sobre o valor original do acordo</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="border-t pt-4 mt-4">
                            <label class="block text-sm font-medium text-gray-700">Dedução/Pagamento Parcial (Opcional -
                                Use SOMENTE para outros pagamentos que NÃO sejam as parcelas adimplidas)</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end mt-1">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Valor a Deduzir (R$)</label>
                                    <input id="agreement-deduction-value" type="text"
                                        class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                        placeholder="Ex: 200,00">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Data do Pagamento</label>
                                    <input id="agreement-deduction-date" type="text"
                                        class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                        placeholder="DD/MM/AAAA">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-8 border-gray-200">

                <!-- Opções Finais e Petição -->
                <div id="final-options-container">
                    <!-- Opções para ATUALIZAÇÃO DA CONDENAÇÃO -->
                    <div id="condemnation-options" class="space-y-4">
                        <div class="flex items-center justify-end">
                            <label for="add-fine-checkbox"
                                class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-100">
                                <input type="checkbox" id="add-fine-checkbox"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="ml-3 text-base font-medium text-gray-800">Inserir multa do art. 523
                                    (10%)?</span>
                            </label>
                        </div>
                        <div class="flex items-center justify-end">
                            <label for="compliance-request-checkbox"
                                class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-100">
                                <input type="checkbox" id="compliance-request-checkbox"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="ml-3 text-base font-medium text-gray-800">Incluir Petição de Cumprimento de
                                    Sentença</span>
                            </label>
                        </div>
                    </div>

                    <!-- Opções para DESCUMPRIMENTO DE ACORDO (a petição é obrigatória) -->
                    <div id="agreement-petition-option" class="hidden flex items-center justify-end">
                        <label class="flex items-center p-2 rounded-lg bg-gray-100">
                            <input type="checkbox" id="agreement-petition-checkbox" checked disabled
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-3 text-base font-medium text-gray-800">Incluir Petição por Descumprimento de
                                Acordo</span>
                        </label>
                    </div>
                </div>

                <!-- Seção de Exequentes e Penhora (oculta por padrão) -->
                <div id="petition-options-container" class="hidden mt-6 p-4 border-t border-dashed space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados do(s) Exequente(s)</h3>
                        <div id="exequentes-list" class="space-y-3">
                            <div class="exequente-item flex items-center gap-3">
                                <input type="text"
                                    class="exequente-name-input flex-grow p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="Nome completo do Exequente" required>
                            </div>
                        </div>
                        <button id="add-exequente-btn"
                            class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg">+
                            Adicionar outro exequente</button>
                    </div>

                    <!-- Pedido de Intimação (Apenas para Acordo) -->
                    <div id="intimation-request-container" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Pedido de Intimação</h3>
                        <div class="flex items-center gap-4 p-2 bg-gray-50 rounded-lg">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="include-intimation-checkbox"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded">
                                <span class="ml-3 font-medium text-gray-800">Incluir pedido de intimação para
                                    pagamento?</span>
                            </label>
                            <div id="intimation-deadline-wrapper" class="hidden">
                                <label for="intimation-deadline" class="sr-only">Prazo:</label>
                                <select id="intimation-deadline"
                                    class="p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                                    <option value="5">5 dias</option>
                                    <option value="10">10 dias</option>
                                    <option value="15" selected>15 dias</option>
                                    <option value="20">20 dias</option>
                                    <option value="30">30 dias</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="penhora-container">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Pedidos de Penhora</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="penhora-contas"
                                        class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                                    <span class="ml-3 font-medium text-gray-800">Penhora de Valores em Contas</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="penhora-veiculos"
                                        class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                                    <span class="ml-3 font-medium text-gray-800">Pesquisa, Bloqueio e Penhora de
                                        Veículos</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="penhora-mandado"
                                        class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                                    <span class="ml-3 font-medium text-gray-800">Expedição de Mandado de Penhora e
                                        Avaliação</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="penhora-outros-check"
                                        class="h-5 w-5 text-indigo-600 border-gray-300 rounded">
                                    <span class="ml-3 font-medium text-gray-800">Outro(s) Pedido(s)</span>
                                </label>
                            </div>
                            <textarea id="penhora-outros-text"
                                class="hidden w-full mt-2 p-2 border border-gray-300 rounded-lg font-normal" rows="3"
                                placeholder="Especifique outros pedidos aqui..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex flex-col md:flex-row gap-4 justify-end mt-8">
                    <button id="calculate-btn" disabled
                        class="bg-indigo-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center">
                        <span class="loader"></span> Carregando dados...
                    </button>
                    <button id="preview-btn" disabled
                        class="bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg">Prévia
                        do
                        PDF</button>

                    <!-- Container para os botões de PDF -->
                    <div id="pdf-buttons-container" class="flex flex-col md:flex-row gap-4">
                        <button id="print-btn"
                            class="bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                            disabled>Gerar PDF</button>
                        <button id="print-combined-btn"
                            class="hidden bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                            disabled>Gerar PDF (Completo)</button>
                        <button id="print-petition-btn"
                            class="hidden bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                            disabled>Gerar PDF (Petição)</button>
                        <button id="print-calc-btn"
                            class="hidden bg-gray-400 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg shadow-lg"
                            disabled>Gerar PDF (Cálculo)</button>
                    </div>

                </div>

                <!-- Seção de Resultados -->
                <div id="results-container-calc" class="mt-10 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
                    <!-- Resultados do cálculo serão injetados aqui -->
                </div>
            </div>

            <!-- ############################################ -->
            <!-- ### CONTAINER DO GERADOR DE MANIFESTAÇÕES ### -->
            <!-- ############################################ -->
            <div id="manifestation-app-container">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="process-number-manifest" class="block text-sm font-medium text-gray-700 mb-2">Nº do
                            processo <span class="text-red-500 font-bold">*</span></label>
                        <input type="text" id="process-number-manifest"
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Apenas números" maxlength="25">
                    </div>
                    <div>
                        <label for="manifestation-type" class="block text-sm font-medium text-gray-700 mb-2">Tipo da
                            Manifestação</label>
                        <select id="manifestation-type"
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="opcao1">Manifestação (Genérica)</option>
                            <option value="opcao2">Emenda à Inicial</option>
                            <option value="opcao3">Atualização do Próprio Endereço</option>
                            <option value="opcao4">Indicação do Endereço da Parte Contrária</option>
                            <option value="desistencia">Desistência da Ação</option>
                            <option value="prazo">Pedido de Prazo/Sobrestamento</option>
                            <option value="nomeacaoDefensoria">Pedido de Nomeação de Advogado pela Defensoria</option>
                            <option value="indicacaoBens">Indicação de Bens para Penhora</option>
                            <option value="desbloqueioPenhora">Levantamento/Desbloqueio de Penhora (Simples)</option>
                            <option value="desbloqueioDetalhado">Levantamento/Desbloqueio de Penhora (Detalhado)
                            </option>
                            <option value="opcao8">Manifestação sobre a Contestação (Genérica - SEM Provas)</option>
                            <option value="opcao9">Manifestação sobre a Contestação (Genérica - COM Provas)</option>
                            <option value="opcao5">Manifestação sobre a Contestação (Reduzida a Termo)</option>
                            <option value="opcao6">Indicação de Provas</option>
                            <option value="remarcacaoAudiencia">Redesignação de Audiência</option>
                            <option value="conciliacao">Proposta de Acordo Simples</option>
                            <option value="expedicaoOficios">Pedido de Expedição de Ofícios</option>
                            <option value="atualizacaoCadastral">Atualização de Dados Cadastrais</option>
                            <option value="cumprimentoVoluntario">Cumprimento Voluntário / Pagamento Espontâneo</option>
                            <option value="certidao">Pedido de Certidão</option>
                            <option value="retiradaSerasa">Retirada de Anotação em Serasa/Boa Vista</option>
                            <option value="manifestacaoAcordo">Manifestação sobre Acordo</option>
                            <option value="retiradaRestricoesRenajud">Retirar Restrições (Renajud/Averbações)</option>
                            <option value="pesquisaEndereco">Pedido de Pesquisa de Endereço</option>
                            <option value="repeticaoDiligencia">Repetição de Diligência</option>
                        </select>
                    </div>
                </div>
                <div id="manifest-parties-list" class="space-y-4 mb-4">
                    <div class="manifest-party-item grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parte
                                <span class="text-red-500 font-bold">*</span></label>
                            <input type="text"
                                class="manifest-name w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CPF/CNPJ <span
                                    class="text-red-500 font-bold">*</span></label>
                            <input type="text"
                                class="manifest-cpf w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>
                <div class="flex justify-start mb-6">
                    <button id="add-manifest-party-btn"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">+
                        Adicionar Parte</button>
                </div>


                <!-- Seção de Endereço -->
                <div id="address-section" class="hidden space-y-4 mb-6">
                    <div id="name-address-field">
                        <label for="name-address" class="block text-sm font-medium text-gray-700">Nome da Parte (que
                            terá o endereço indicado)</label>
                        <input type="text" id="name-address"
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-1">
                            <label for="cep" class="block text-sm font-medium text-gray-700">CEP</label>
                            <input type="text" id="cep" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                                maxlength="9" placeholder="#####-###">
                        </div>
                        <div class="md:col-span-3">
                            <label for="rua" class="block text-sm font-medium text-gray-700">Rua</label>
                            <input type="text" id="rua"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100" readonly>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="numero" class="block text-sm font-medium text-gray-700">Nº</label>
                            <input type="text" id="numero"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="complemento" class="block text-sm font-medium text-gray-700">Complemento</label>
                            <input type="text" id="complemento"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-1">
                            <label for="bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                            <input type="text" id="bairro"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100" readonly>
                        </div>
                        <div>
                            <label for="cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                            <input type="text" id="cidade"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100" readonly>
                        </div>
                        <div>
                            <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                            <input type="text" id="estado"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100" readonly>
                        </div>
                    </div>
                </div>

                <!-- Seção de Emenda à Inicial -->
                <div id="emenda-section" class="hidden space-y-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Opções de Emenda</h3>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center"><input type="radio" name="emenda-type" value="incluir-parte"
                                class="h-4 w-4 text-indigo-600 border-gray-300"> <span class="ml-2">Incluir
                                Parte</span></label>
                        <label class="flex items-center"><input type="radio" name="emenda-type" value="generica"
                                class="h-4 w-4 text-indigo-600 border-gray-300" checked> <span class="ml-2">Emenda
                                Genérica</span></label>
                    </div>

                    <div id="emenda-incluir-parte-section" class="hidden space-y-4">
                        <div class="flex items-center gap-4">
                            <label class="block text-sm font-medium text-gray-700">Incluir no:</label>
                            <label class="flex items-center"><input type="radio" name="polo-type" value="Ativo"
                                    class="h-4 w-4 text-indigo-600 border-gray-300" checked> <span class="ml-2">Polo
                                    Ativo</span></label>
                            <label class="flex items-center"><input type="radio" name="polo-type" value="Passivo"
                                    class="h-4 w-4 text-indigo-600 border-gray-300"> <span class="ml-2">Polo
                                    Passivo</span></label>
                        </div>
                        <div id="emenda-parte-list" class="space-y-4"></div>
                        <button type="button" id="add-emenda-party-btn"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">+
                            Adicionar Parte</button>
                        <textarea id="emenda-texto-opcional"
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" rows="4"
                            placeholder="Acrescente aqui qualquer outra informação que julgar necessária (opcional)..."></textarea>
                    </div>
                </div>

                <!-- Seção de Pedido de Prazo -->
                <div id="prazo-section" class="hidden space-y-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="prazo-dias" class="block text-sm font-medium text-gray-700">Prazo em
                                dias</label>
                            <input type="number" id="prazo-dias" value="30"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="prazo-motivo" class="block text-sm font-medium text-gray-700">Motivo</label>
                            <select id="prazo-motivo"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                                <option value="em razão de tratativas de acordo">em razão de tratativas de acordo
                                </option>
                                <option
                                    value="para realização de diligências pelo solicitante para localizar o endereço">
                                    para realização de diligências para localizar endereço</option>
                                <option value="para realização de diligências pelo solicitante para indicar bens">para
                                    realização de diligências para indicar bens</option>
                                <option value="outro">Outro (especificar abaixo)</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="prazo-motivo-outro"
                        class="hidden w-full p-3 border border-gray-300 rounded-lg shadow-sm" rows="3"
                        placeholder="Especifique o motivo do pedido de prazo/sobrestamento..."></textarea>
                    <p class="hidden text-xs text-slate-500" id="prazo-motivo-outro-hint">Este texto aparecerá em: "A
                        parte solicitante requer a concessão do prazo de [dias] dias para <strong>seu texto
                            aqui</strong>."</p>
                </div>

                <!-- Seção de Indicação de Bens -->
                <div id="indicacao-bens-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Pedidos de Penhora</h3>

                    <!-- SISBAJUD -->
                    <div class="flex items-center gap-4">
                        <label class="flex items-center cursor-pointer flex-grow">
                            <input type="checkbox" id="bens-sisbajud"
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                            <span class="ml-3 font-medium text-gray-800">Pesquisa e bloqueio de valores via
                                SISBAJUD</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="flex items-center text-sm"><input type="radio" name="sisbajud-type"
                                    value="teimosinha" class="h-4 w-4" checked> <span class="ml-1">Teimosinha (30
                                    dias)</span></label>
                            <label class="flex items-center text-sm"><input type="radio" name="sisbajud-type"
                                    value="simples" class="h-4 w-4"> <span class="ml-1">Simples</span></label>
                        </div>
                    </div>

                    <!-- RENAJUD -->
                    <div class="space-y-2">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center cursor-pointer flex-grow">
                                <input type="checkbox" id="bens-renajud"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded" checked>
                                <span class="ml-3 font-medium text-gray-800">Pesquisa e bloqueio de veículos via
                                    RENAJUD</span>
                            </label>
                            <label class="flex items-center text-sm"><input type="checkbox"
                                    class="individualizar-check h-4 w-4"> <span
                                    class="ml-1">Individualizar</span></label>
                        </div>
                        <input type="text"
                            class="individualizar-input hidden w-full p-2 border border-gray-300 rounded-lg mt-1"
                            placeholder="Ex: Placa do veículo, modelo, etc.">
                    </div>

                    <!-- MANDADO -->
                    <div class="space-y-2">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center cursor-pointer flex-grow">
                                <input type="checkbox" id="bens-mandado"
                                    class="h-5 w-5 text-indigo-600 border-gray-300 rounded">
                                <span class="ml-3 font-medium text-gray-800">Expedição de Mandado de Penhora e
                                    Avaliação</span>
                            </label>
                            <label class="flex items-center text-sm"><input type="checkbox"
                                    class="individualizar-check h-4 w-4"> <span
                                    class="ml-1">Individualizar</span></label>
                        </div>
                        <input type="text"
                            class="individualizar-input hidden w-full p-2 border border-gray-300 rounded-lg mt-1"
                            placeholder="Ex: TV 50 polegadas, geladeira, etc.">
                    </div>

                    <!-- OUTROS -->
                    <div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="bens-outros-check"
                                class="h-5 w-5 text-indigo-600 border-gray-300 rounded">
                            <span class="ml-3 font-medium text-gray-800">Outro(s)</span>
                        </label>
                        <textarea id="bens-outros-text"
                            class="hidden w-full mt-2 p-2 border border-gray-300 rounded-lg font-normal" rows="3"
                            placeholder="Especifique outros bens ou pedidos..."></textarea>
                    </div>
                </div>


                <!-- Seção de Levantamento de Penhora -->
                <div id="desbloqueio-penhora-section" class="hidden space-y-4 mb-6">
                    <label for="desbloqueio-motivo" class="block text-sm font-medium text-gray-700">Motivo do Pedido de
                        Desbloqueio</label>
                    <select id="desbloqueio-motivo"
                        class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                        <option value="Salário">Salário</option>
                        <option value="Benefício Social">Benefício Social</option>
                        <option value="Aposentadoria">Aposentadoria</option>
                        <option value="outro">Outros (especificar abaixo)</option>
                    </select>
                    <textarea id="desbloqueio-motivo-outro"
                        class="hidden w-full p-3 border border-gray-300 rounded-lg shadow-sm" rows="3"
                        placeholder="Especifique o motivo do pedido de desbloqueio..."></textarea>
                    <p class="hidden text-xs text-slate-500" id="desbloqueio-motivo-outro-hint">Este texto será usado
                        em: "O pedido se fundamenta no fato de que os valores bloqueados são provenientes de <strong>seu
                            texto aqui</strong>."</p>
                </div>

                <!-- Seção de Levantamento/Desbloqueio detalhado -->
                <div id="desbloqueio-detalhado-section"
                    class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-indigo-50/60">
                    <h3 class="text-lg font-semibold text-gray-800">Detalhes do valor bloqueado</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Natureza do valor</label>
                            <select id="detalhe-natureza"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="salario">Salário/Conta salário</option>
                                <option value="beneficio">Benefício previdenciário (INSS)</option>
                                <option value="pensao">Pensão alimentícia/depósito de terceiro</option>
                                <option value="poupanca">Poupança até 40 salários-mínimos</option>
                                <option value="auxilio">Auxílio/bolsa social</option>
                                <option value="duplicidade">Bloqueio indevido/duplicado</option>
                                <option value="subsistencia">Valor essencial à subsistência</option>
                                <option value="outro">Outro (especificar)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor bloqueado (R$)</label>
                            <input type="text" id="detalhe-valor"
                                class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 2.500,00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data do bloqueio</label>
                            <input type="text" id="detalhe-data"
                                class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Banco/Agência/Conta</label>
                            <input type="text" id="detalhe-conta"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Banco, agência, conta, chave PIX...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Origem do depósito</label>
                            <input type="text" id="detalhe-origem"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: salário de empresa X, benefício Y">
                        </div>
                    </div>
                    <textarea id="detalhe-justificativa" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Explique por que o valor é impenhorável ou deve ser liberado..."></textarea>
                    <p class="text-xs text-slate-500">Este texto será acrescentado após a frase que descreve o bloqueio
                        e a natureza do valor.</p>
                </div>

                <!-- Seção de Redesignação de Audiência -->
                <div id="remarcacao-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Redesignação de audiência</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data/Hora da audiência
                                marcada</label>
                            <input type="text" id="remarcacao-data"
                                class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA ou data aproximada">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Formato preferido</label>
                            <select id="remarcacao-formato"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="remoto">Audiência remota (videoconferência)</option>
                                <option value="presencial">Audiência presencial</option>
                                <option value="indiferente">Indiferente</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="remarcacao-justificativa" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Explique o motivo do pedido (atestado, viagem, trabalho, dificuldade de conexão etc.)"></textarea>
                    <p class="text-xs text-slate-500">O texto será inserido logo após o pedido de remarcação.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Datas/turnos indisponíveis</label>
                            <input type="text" id="remarcacao-indisponiveis"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: manhãs de terça, período de férias, etc.">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Datas sugeridas</label>
                            <input type="text" id="remarcacao-sugestao"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: a partir de 20/02, qualquer sexta à tarde">
                        </div>
                    </div>
                </div>

                <!-- Seção de Conciliação -->
                <div id="conciliacao-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Conciliação / Proposta</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor ofertado (R$)</label>
                            <input type="text" id="conciliacao-valor"
                                class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 1.500,00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Forma</label>
                            <select id="conciliacao-forma"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="avista">Pagamento à vista</option>
                                <option value="parcelado">Pagamento parcelado</option>
                                <option value="compensacao">Compensação/troca</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Parcelas (se houver)</label>
                            <input type="text" id="conciliacao-parcelas"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 3x de 500,00">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Primeiro vencimento</label>
                            <input type="text" id="conciliacao-vencimento"
                                class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contato para tratativas</label>
                            <input type="text" id="conciliacao-contato"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Telefone/WhatsApp ou e-mail">
                        </div>
                    </div>
                    <textarea id="conciliacao-detalhes" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Detalhe condições, descontos, prazos ou documentos que pretende apresentar..."></textarea>
                    <p class="text-xs text-slate-500">O texto será incluído após a frase que apresenta a proposta.</p>
                </div>

                <!-- Seção de Expedição de Ofícios -->
                <div id="oficios-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-800">Ofícios a expedir</h3>
                        <button id="add-oficio-btn" type="button"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-md">+
                            Adicionar Ofício</button>
                    </div>
                    <div id="oficios-list" class="space-y-3"></div>
                    <p class="text-sm text-gray-600">Exemplos: ofício ao empregador, ao banco para extratos, a empresas
                        de telefonia, escolas, cartórios, hospitais.</p>
                </div>

                <!-- Seção de Atualização Cadastral -->
                <div id="cadastro-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Atualização de dados de contato</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Novo telefone</label>
                            <input type="text" id="cadastro-telefone"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="(XX) XXXXX-XXXX">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Novo e-mail</label>
                            <input type="email" id="cadastro-email"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="email@exemplo.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Preferência de intimação</label>
                            <select id="cadastro-intimacao"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="email">E-mail</option>
                                <option value="telefone">Telefone/WhatsApp</option>
                                <option value="postal">Correio/Oficial de justiça</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Novo endereço (se aplicável)</label>
                            <input type="text" id="cadastro-endereco"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Rua, nº, bairro, cidade/UF">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Referência/Observação</label>
                            <input type="text" id="cadastro-observacao"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Portaria, bloco, melhor horário, etc.">
                            <p class="text-xs text-slate-500">O texto será incluído após os dados de contato.</p>
                        </div>
                    </div>
                </div>

                <!-- Seção de Cumprimento Voluntário -->
                <div id="cumprimento-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Cumprimento voluntário / pagamento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor pago (R$)</label>
                            <input type="text" id="cumprimento-valor"
                                class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 800,00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data do pagamento</label>
                            <input type="text" id="cumprimento-data"
                                class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Forma</label>
                            <select id="cumprimento-forma"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="pix">PIX</option>
                                <option value="transferencia">Transferência/Depósito</option>
                                <option value="boleto">Boleto</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="cartao">Cartão</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="cumprimento-comprovante" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Identifique o comprovante anexado (ex: print do PIX, comprovante de depósito) e informe se deseja baixa do débito/arquivamento."></textarea>
                    <p class="text-xs text-slate-500">O texto será incluído logo após a frase sobre pagamento.</p>
                </div>

                <!-- Seção de Certidão -->
                <div id="certidao-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Pedido de certidão</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="certidao-tipo"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="objeto">Certidão de objeto e pé</option>
                                <option value="transito">Certidão de trânsito em julgado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Finalidade</label>
                            <input type="text" id="certidao-finalidade"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: apresentar a banco/empregador/órgão público">
                        </div>
                    </div>
                    <textarea id="certidao-detalhe" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Inclua qualquer informação específica que deseje constar na certidão."></textarea>
                    <p class="text-xs text-slate-500">O texto será incluído após a frase do tipo e finalidade da
                        certidão.</p>
                </div>

                <!-- Seção de Retirada Serasa/Boa Vista -->
                <div id="serasa-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Retirada de anotação (Serasa/Boa Vista)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Entidade</label>
                            <input type="text" id="serasa-entidade"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Serasa, Boa Vista, SPC...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data da anotação</label>
                            <input type="text" id="serasa-data"
                                class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor/Lançamento</label>
                            <input type="text" id="serasa-valor"
                                class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 350,00">
                        </div>
                    </div>
                    <textarea id="serasa-justificativa" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Informe se o débito foi pago, se há decisão judicial, erro de lançamento, fraude ou acordo anexado."></textarea>
                    <p class="text-xs text-slate-500">O texto será incluído após a frase que pede a retirada da
                        anotação.</p>
                </div>

                <!-- Seção de Manifestação sobre Acordo -->
                <div id="acordo-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Manifestação sobre acordo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Situação</label>
                            <select id="acordo-situacao"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="cumpriu">Cumpriu integralmente</option>
                                <option value="parcial">Cumpriu parcialmente</option>
                                <option value="descumpriu">Não cumpriu</option>
                                <option value="contraproposta">Apresenta Contraproposta</option>
                            </select>
                        </div>
                    </div>

                    <div id="acordo-pagamento-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Parcelas pagas</label>
                            <input type="text" id="acordo-pagas"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 2 de 5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor pago (R$)</label>
                            <input type="text" id="acordo-valor"
                                class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: 400,00">
                        </div>
                    </div>

                    <div id="acordo-diligencias" class="hidden space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Diligências para prosseguimento</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center"><input type="checkbox" id="acordo-sisbajud"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2"> SISBAJUD</label>
                            <label class="flex items-center"><input type="checkbox" id="acordo-renajud"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2"> RENAJUD</label>
                            <label class="flex items-center"><input type="checkbox" id="acordo-mandado"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2"> Mandado de
                                penhora/avaliação</label>
                            <label class="flex items-center"><input type="checkbox" id="acordo-outros-check"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2"> Outros</label>
                        </div>
                        <input type="text" id="acordo-outros-text"
                            class="hidden w-full p-2 border border-gray-300 rounded-lg"
                            placeholder="Descreva outras diligências desejadas">
                    </div>

                    <div id="acordo-contraproposta" class="hidden space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Valor a pagar (R$)</label>
                                <input type="text" id="acordo-contra-valor"
                                    class="value-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="Ex: 1.200,00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nº de parcelas</label>
                                <input type="text" id="acordo-contra-parcelas"
                                    class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="Ex: 3x">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Primeira parcela</label>
                                <input type="text" id="acordo-contra-primeira"
                                    class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                    placeholder="DD/MM/AAAA">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Forma de pagamento</label>
                                <select id="acordo-contra-forma"
                                    class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="pix">PIX</option>
                                    <option value="transferencia">Transferência/Depósito</option>
                                    <option value="boleto">Boleto</option>
                                    <option value="dinheiro">Dinheiro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <textarea id="acordo-detalhes" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Explique o cumprimento, pendências ou condições da contraproposta."></textarea>
                    <p class="text-xs text-slate-500">O texto será incluído após a frase sobre a situação do acordo.</p>
                </div>

                <!-- Seção de Retirar Restrições (Renajud/Averbações) -->
                <div id="renajud-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Retirada de restrições</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Veículo/Placa ou bem averbado</label>
                            <input type="text" id="renajud-bem"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Placa ABC1D23, matrícula do imóvel, etc.">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Motivo da retirada</label>
                            <select id="renajud-motivo"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="debito quitado">Débito quitado</option>
                                <option value="acordo">Acordo homologado</option>
                                <option value="excesso">Bloqueio excessivo/disproporcional</option>
                                <option value="bem indispensavel">Bem indispensável ao trabalho/locomoção</option>
                                <option value="outro">Outro (especificar abaixo)</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="renajud-detalhes" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Inclua comprovantes de pagamento, decisão ou justificativa específica."></textarea>
                    <p class="text-xs text-slate-500">O texto será incluído após a frase que descreve o bem e o motivo.
                    </p>
                </div>

                <!-- Seção de Pesquisa de Endereço -->
                <div id="pesquisa-endereco-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Pedido de pesquisa de endereço</h3>
                    <textarea id="pesquisa-justificativa" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Explique por que o endereço atual é desconhecido ou mudou."></textarea>
                    <p class="text-xs text-slate-500">O texto será inserido após a frase que pede a pesquisa de
                        endereço.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Último endereço conhecido</label>
                            <input type="text" id="pesquisa-ultimo"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Rua, nº, bairro, cidade/UF">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Sistemas a pesquisar</label>
                            <div class="grid grid-cols-2 gap-2 mt-1 text-sm">
                                <label class="flex items-center"><input type="checkbox" id="pesquisa-sisbajud"
                                        class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2" checked>
                                    SISBAJUD</label>
                                <label class="flex items-center"><input type="checkbox" id="pesquisa-renajud"
                                        class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2" checked>
                                    RENAJUD</label>
                                <label class="flex items-center"><input type="checkbox" id="pesquisa-infojud"
                                        class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                    INFOJUD/RFB</label>
                                <label class="flex items-center"><input type="checkbox" id="pesquisa-outros-check"
                                        class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                    Outros (especificar)</label>
                            </div>
                            <input type="text" id="pesquisa-outros-text"
                                class="hidden w-full mt-2 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: INFOSEG, bases municipais, concessionárias">
                        </div>
                    </div>
                </div>

                <!-- Seção de Repetição de Diligência -->
                <div id="repetir-diligencia-section" class="hidden space-y-4 mb-6 p-4 border rounded-lg bg-white">
                    <h3 class="text-lg font-semibold text-gray-800">Repetição de diligência</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo de diligência</label>
                            <select id="diligencia-tipo"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="citacao">Citação</option>
                                <option value="intimacao">Intimação</option>
                                <option value="penhora">Penhora/Busca</option>
                                <option value="oficial">Oficial de Justiça</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data da tentativa anterior</label>
                            <input type="text" id="diligencia-data"
                                class="date-input w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="DD/MM/AAAA">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Melhor horário/local</label>
                            <input type="text" id="diligencia-horario"
                                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                                placeholder="Ex: após 18h, fins de semana">
                        </div>
                    </div>
                    <textarea id="diligencia-justificativa" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Descreva por que a diligência falhou e o que mudou (novo endereço, pessoas no local, portaria, etc.)."></textarea>
                    <p class="text-xs text-slate-500">O texto será incluído após a frase que solicita a repetição da
                        diligência.</p>
                </div>


                <div class="mb-6">
                    <label for="manifest-content" class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        Digite a manifestação abaixo
                        <span id="manifest-tooltip" class="tooltip-container ml-2">
                            <span class="tooltip-icon">&#9432;</span>
                            <span id="manifest-tooltip-text" class="tooltip-text">Texto de ajuda</span>
                        </span>
                    </label>
                    <textarea id="manifest-content" rows="10"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea>
                </div>

                <div id="extra-content-container" class="hidden mb-6">
                    <label for="extra-content" class="block text-sm font-medium text-gray-700 mb-2">Descreva as provas
                        que deseja produzir:</label>
                    <textarea id="extra-content" rows="5"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea>
                </div>

                <!-- Seção de Testemunhas -->
                <div id="witness-section" class="hidden space-y-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Rol de Testemunhas (Máximo 3)</h3>
                    <div id="witness-list" class="space-y-6">
                        <!-- Template da testemunha será clonado aqui -->
                    </div>
                    <div class="flex justify-start">
                        <button id="add-witness-btn"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">+
                            Arrolar Testemunha</button>
                    </div>
                </div>

                <!-- Seção de Documentos -->
                <div id="document-section" class="space-y-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Documentos Anexos</h3>
                    <div id="document-list" class="space-y-4">
                        <!-- Documentos adicionados dinamicamente aqui -->
                    </div>
                    <div class="flex justify-start">
                        <button id="add-document-btn"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">+
                            Adicionar Documento</button>
                    </div>
                </div>


                <div class="flex gap-4 justify-end mt-8">
                    <button id="clear-manifest-btn" type="button"
                        class="bg-gray-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Limpar</button>
                    <button id="preview-manifest-btn" type="button"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Prévia
                        do PDF</button>
                    <button id="generate-manifest-btn" type="button"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Gerar
                        Manifestação</button>
                </div>
            </div>

            <div id="results-container" class="mt-10 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <!-- Resultados do cálculo serão injetados aqui -->
            </div>
        </main>
    </div>

    <!-- Modal de Pré-visualização -->
    <div id="preview-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-200 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 relative">
            <button id="close-preview-btn"
                class="absolute top-3 right-3 text-3xl font-bold text-gray-500 hover:text-gray-800 leading-none">&times;</button>
            <div id="preview-content" class="space-y-8">
                <!-- Conteúdo da prévia será injetado aqui -->
            </div>
        </div>
    </div>

    <!-- Div oculta para renderizar a petição para o PDF -->
    <div style="position: absolute; left: -9999px; width: 210mm;">
        <div id="petition-area" class="w-full p-8 bg-white"></div>
    </div>

    <!-- Template das Partes para Emenda -->
    <div class="party-item-template" style="display: none;">
        <div class="party-item p-4 border rounded-lg bg-white relative space-y-4">
            <button type="button"
                class="remove-party-btn absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white font-bold h-6 w-6 rounded-full text-xs flex items-center justify-center"
                title="Remover Parte">&times;</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Nome Completo <span
                            class="text-red-500">*</span></label><input type="text"
                        class="party-name w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Estado Civil</label>
                    <select
                        class="party-marital-status w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-white">
                        <option value="" selected>Selecione...</option>
                        <option value="solteiro(a)">Solteiro(a)</option>
                        <option value="casado(a)">Casado(a)</option>
                        <option value="em união estável">Em União Estável</option>
                        <option value="separado(a)">Separado(a)</option>
                        <option value="divorciado(a)">Divorciado(a)</option>
                        <option value="viúvo(a)">Viúvo(a)</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Profissão</label><input type="text"
                        class="party-profession w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div class="party-dob-field"><label class="block text-sm font-medium text-gray-700">Data
                        de Nascimento <span class="text-red-500">*</span></label><input type="text"
                        class="party-dob w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="DD/MM/AAAA"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">CPF/CNPJ <span
                            class="party-cpf-required text-red-500">*</span></label><input type="text"
                        class="party-cpf w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div><label class="block text-sm font-medium text-gray-700">RG</label><input type="text"
                        class="party-rg w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Órgão
                        Expedidor</label><input type="text"
                        class="party-emitter w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="Ex: SSP/SP"></div>
                <div><label class="block text-sm font-medium text-gray-700">Telefone</label><input type="text"
                        class="party-phone w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                        placeholder="(XX) XXXXX-XXXX"></div>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">E-mail</label><input type="email"
                        class="party-email w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
            </div>
            <div class="address-container">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mt-4">
                    <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700">CEP</label><input
                            type="text" class="party-cep w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                            maxlength="9"></div>
                    <div class="md:col-span-3"><label
                            class="block text-sm font-medium text-gray-700">Logradouro</label><input type="text"
                            class="party-street w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100"
                            readonly></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div><label class="block text-sm font-medium text-gray-700">Nº</label><input type="text"
                            class="party-number w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div class="md:col-span-2"><label
                            class="block text-sm font-medium text-gray-700">Complemento</label><input type="text"
                            class="party-complement w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div class="md:col-span-1"><label
                            class="block text-sm font-medium text-gray-700">Bairro</label><input type="text"
                            class="party-district w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100"
                            readonly></div>
                    <div><label class="block text-sm font-medium text-gray-700">Cidade</label><input type="text"
                            class="party-city w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100"
                            readonly></div>
                    <div><label class="block text-sm font-medium text-gray-700">UF</label><input type="text"
                            class="party-state w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100"
                            readonly></div>
                </div>
            </div>
            <div class="mt-4 space-y-2">
                <label class="flex items-center text-sm no-cep-option">
                    <input type="checkbox" class="no-cep-check h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <span class="ml-2 text-gray-700">Não sei o CEP (preencher endereço
                        manualmente)</span>
                </label>
                <label class="flex items-center text-sm no-address-option" style="display: none;">
                    <input type="checkbox" class="no-address-check h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <span class="ml-2 text-gray-700">Não possuo o endereço do requerido</span>
                </label>
            </div>
            <div class="no-address-justification-field hidden mt-4">
                <label class="block text-sm font-medium text-gray-700">Justifique a ausência do endereço
                    e informe se requer a realização de pesquisas nos sistemas para localização</label>
                <textarea class="no-address-justification w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm"
                    rows="3"></textarea>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- REFERÊNCIAS GERAIS ---
            const mainAppSelect = document.getElementById('main-app-type');
            const mainTitle = document.getElementById('main-title');
            const mainSubtitle = document.getElementById('main-subtitle');
            const calcAppContainer = document.getElementById('calculator-app-container');
            const manifestAppContainer = document.getElementById('manifestation-app-container');

            // --- REFERÊNCIAS DA CALCULADORA ---
            const addRowBtn = document.getElementById('add-row-btn');
            const calculateBtn = document.getElementById('calculate-btn');
            const printBtn = document.getElementById('print-btn');
            const printCombinedBtn = document.getElementById('print-combined-btn');
            const printPetitionBtn = document.getElementById('print-petition-btn');
            const printCalcBtn = document.getElementById('print-calc-btn');
            const previewBtn = document.getElementById('preview-btn');
            const rowsContainer = document.getElementById('calculation-rows');
            const resultsContainer = document.getElementById('results-container-calc');
            const processNumberInputCalc = document.getElementById('process-number-calc');
            const addFineCheckbox = document.getElementById('add-fine-checkbox');
            const complianceRequestCheckbox = document.getElementById('compliance-request-checkbox');
            const petitionOptionsContainer = document.getElementById('petition-options-container');
            const exequentesList = document.getElementById('exequentes-list');
            const addExequenteBtn = document.getElementById('add-exequente-btn');
            const penhoraOutrosCheck = document.getElementById('penhora-outros-check');
            const penhoraOutrosText = document.getElementById('penhora-outros-text');
            const previewModal = document.getElementById('preview-modal');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const previewContent = document.getElementById('preview-content');
            const calculationTypeSelect = document.getElementById('calculation-type');
            const condemnationContainer = document.getElementById('condemnation-container');
            const agreementContainer = document.getElementById('agreement-container');
            const condemnationOptions = document.getElementById('condemnation-options');
            const agreementPetitionOption = document.getElementById('agreement-petition-option');
            const intimationRequestContainer = document.getElementById('intimation-request-container');
            const includeIntimationCheckbox = document.getElementById('include-intimation-checkbox');
            const intimationDeadlineWrapper = document.getElementById('intimation-deadline-wrapper');

            // --- REFERÊNCIAS DO GERADOR DE MANIFESTAÇÕES ---
            const processNumberManifest = document.getElementById('process-number-manifest');
            const manifestPartiesList = document.getElementById('manifest-parties-list');
            const addManifestPartyBtn = document.getElementById('add-manifest-party-btn');
            const manifestationType = document.getElementById('manifestation-type');
            const addressSection = document.getElementById('address-section');
            const nameAddressField = document.getElementById('name-address-field');
            const manifestContent = document.getElementById('manifest-content');
            const extraContentContainer = document.getElementById('extra-content-container');
            const extraContent = document.getElementById('extra-content');
            const clearManifestBtn = document.getElementById('clear-manifest-btn');
            const generateManifestBtn = document.getElementById('generate-manifest-btn');
            const previewManifestBtn = document.getElementById('preview-manifest-btn');
            const manifestTooltip = document.getElementById('manifest-tooltip');
            const manifestTooltipText = document.getElementById('manifest-tooltip-text');
            const cepInput = document.getElementById('cep');
            const witnessSection = document.getElementById('witness-section');
            const witnessList = document.getElementById('witness-list');
            const addWitnessBtn = document.getElementById('add-witness-btn');
            const documentList = document.getElementById('document-list');
            const addDocumentBtn = document.getElementById('add-document-btn');
            const partyTemplate = document.querySelector('.party-item-template');

            // Novas seções
            const emendaSection = document.getElementById('emenda-section');
            const emendaIncluirParteSection = document.getElementById('emenda-incluir-parte-section');
            const emendaParteList = document.getElementById('emenda-parte-list');
            const addEmendaPartyBtn = document.getElementById('add-emenda-party-btn');
            const prazoSection = document.getElementById('prazo-section');
            const prazoMotivoSelect = document.getElementById('prazo-motivo');
            const prazoMotivoOutro = document.getElementById('prazo-motivo-outro');
            const indicacaoBensSection = document.getElementById('indicacao-bens-section');
            const bensOutrosCheck = document.getElementById('bens-outros-check');
            const bensOutrosText = document.getElementById('bens-outros-text');
            const desbloqueioPenhoraSection = document.getElementById('desbloqueio-penhora-section');
            const desbloqueioMotivoSelect = document.getElementById('desbloqueio-motivo');
            const desbloqueioMotivoOutro = document.getElementById('desbloqueio-motivo-outro');

            // Novas seções detalhadas
            const desbloqueioDetalhadoSection = document.getElementById('desbloqueio-detalhado-section');
            const naturezaSelect = document.getElementById('detalhe-natureza');
            const detalheValorInput = document.getElementById('detalhe-valor');
            const detalheDataInput = document.getElementById('detalhe-data');
            const detalheContaInput = document.getElementById('detalhe-conta');
            const detalheOrigemInput = document.getElementById('detalhe-origem');
            const detalheJustificativa = document.getElementById('detalhe-justificativa');

            const remarcacaoSection = document.getElementById('remarcacao-section');
            const remarcacaoData = document.getElementById('remarcacao-data');
            const remarcacaoFormato = document.getElementById('remarcacao-formato');
            const remarcacaoJustificativa = document.getElementById('remarcacao-justificativa');
            const remarcacaoIndisponiveis = document.getElementById('remarcacao-indisponiveis');
            const remarcacaoSugestao = document.getElementById('remarcacao-sugestao');

            const conciliacaoSection = document.getElementById('conciliacao-section');
            const conciliacaoValor = document.getElementById('conciliacao-valor');
            const conciliacaoForma = document.getElementById('conciliacao-forma');
            const conciliacaoParcelas = document.getElementById('conciliacao-parcelas');
            const conciliacaoVencimento = document.getElementById('conciliacao-vencimento');
            const conciliacaoContato = document.getElementById('conciliacao-contato');
            const conciliacaoDetalhes = document.getElementById('conciliacao-detalhes');

            const oficiosSection = document.getElementById('oficios-section');
            const addOficioBtn = document.getElementById('add-oficio-btn');
            const oficiosList = document.getElementById('oficios-list');

            const cadastroSection = document.getElementById('cadastro-section');
            const cadastroTelefone = document.getElementById('cadastro-telefone');
            const cadastroEmail = document.getElementById('cadastro-email');
            const cadastroIntimacao = document.getElementById('cadastro-intimacao');
            const cadastroEndereco = document.getElementById('cadastro-endereco');
            const cadastroObservacao = document.getElementById('cadastro-observacao');

            const cumprimentoSection = document.getElementById('cumprimento-section');
            const cumprimentoValor = document.getElementById('cumprimento-valor');
            const cumprimentoData = document.getElementById('cumprimento-data');
            const cumprimentoForma = document.getElementById('cumprimento-forma');
            const cumprimentoComprovante = document.getElementById('cumprimento-comprovante');

            const certidaoSection = document.getElementById('certidao-section');
            const certidaoTipo = document.getElementById('certidao-tipo');
            const certidaoFinalidade = document.getElementById('certidao-finalidade');
            const certidaoDetalhe = document.getElementById('certidao-detalhe');

            const serasaSection = document.getElementById('serasa-section');
            const serasaEntidade = document.getElementById('serasa-entidade');
            const serasaData = document.getElementById('serasa-data');
            const serasaValor = document.getElementById('serasa-valor');
            const serasaJustificativa = document.getElementById('serasa-justificativa');

            const acordoSection = document.getElementById('acordo-section');
            const acordoSituacao = document.getElementById('acordo-situacao');
            const acordoPagas = document.getElementById('acordo-pagas');
            const acordoValor = document.getElementById('acordo-valor');
            const acordoPagamentoFields = document.getElementById('acordo-pagamento-fields');
            const acordoDiligencias = document.getElementById('acordo-diligencias');
            const acordoSisbajud = document.getElementById('acordo-sisbajud');
            const acordoRenajud = document.getElementById('acordo-renajud');
            const acordoMandado = document.getElementById('acordo-mandado');
            const acordoOutrosCheck = document.getElementById('acordo-outros-check');
            const acordoOutrosText = document.getElementById('acordo-outros-text');
            const acordoContraproposta = document.getElementById('acordo-contraproposta');
            const acordoContraValor = document.getElementById('acordo-contra-valor');
            const acordoContraParcelas = document.getElementById('acordo-contra-parcelas');
            const acordoContraPrimeira = document.getElementById('acordo-contra-primeira');
            const acordoContraForma = document.getElementById('acordo-contra-forma');
            const acordoDetalhes = document.getElementById('acordo-detalhes');

            const renajudSection = document.getElementById('renajud-section');
            const renajudBem = document.getElementById('renajud-bem');
            const renajudMotivo = document.getElementById('renajud-motivo');
            const renajudDetalhes = document.getElementById('renajud-detalhes');

            const pesquisaEnderecoSection = document.getElementById('pesquisa-endereco-section');
            const pesquisaJustificativa = document.getElementById('pesquisa-justificativa');
            const pesquisaUltimo = document.getElementById('pesquisa-ultimo');
            const pesquisaSisbajud = document.getElementById('pesquisa-sisbajud');
            const pesquisaRenajud = document.getElementById('pesquisa-renajud');
            const pesquisaInfojud = document.getElementById('pesquisa-infojud');
            const pesquisaOutrosCheck = document.getElementById('pesquisa-outros-check');
            const pesquisaOutrosText = document.getElementById('pesquisa-outros-text');

            const repetirDiligenciaSection = document.getElementById('repetir-diligencia-section');
            const diligenciaTipo = document.getElementById('diligencia-tipo');
            const diligenciaData = document.getElementById('diligencia-data');
            const diligenciaHorario = document.getElementById('diligencia-horario');
            const diligenciaJustificativa = document.getElementById('diligencia-justificativa');

            // --- DADOS ECONÔMICOS ---
            // Fatores TJSP (INPC/IPCA-15), conforme tabela prática, com projeção via IPCA-15 e truncamento em 6 casas
            let tabelaTJSP = {

                // 2003
                '2003-01': 28.131595, '2003-02': 28.826445, '2003-03': 29.247311, '2003-04': 29.647999,
                '2003-05': 30.057141, '2003-06': 30.354706, '2003-07': 30.336493, '2003-08': 30.348627,
                '2003-09': 30.403254, '2003-10': 30.652560, '2003-11': 30.772104, '2003-12': 30.885960,

                // 2004
                '2004-01': 31.052744, '2004-02': 31.310481, '2004-03': 31.432591, '2004-04': 31.611756,
                '2004-05': 31.741364, '2004-06': 31.868329, '2004-07': 32.027670, '2004-08': 32.261471,
                '2004-09': 32.422778, '2004-10': 32.477896, '2004-11': 32.533108, '2004-12': 32.676253,

                // 2005
                '2005-01': 32.957268, '2005-02': 33.145124, '2005-03': 33.290962, '2005-04': 33.533986,
                '2005-05': 33.839145, '2005-06': 34.076019, '2005-07': 34.038535, '2005-08': 34.048746,
                '2005-09': 34.048746, '2005-10': 34.099819, '2005-11': 34.297597, '2005-12': 34.482804,

                // 2006
                '2006-01': 34.620735, '2006-02': 34.752293, '2006-03': 34.832223, '2006-04': 34.926270,
                '2006-05': 34.968181, '2006-06': 35.013639, '2006-07': 34.989129, '2006-08': 35.027617,
                '2006-09': 35.020611, '2006-10': 35.076643, '2006-11': 35.227472, '2006-12': 35.375427,

                // 2007
                '2007-01': 35.594754, '2007-02': 35.769168, '2007-03': 35.919398, '2007-04': 36.077443,
                '2007-05': 36.171244, '2007-06': 36.265289, '2007-07': 36.377711, '2007-08': 36.494119,
                '2007-09': 36.709434, '2007-10': 36.801207, '2007-11': 36.911610, '2007-12': 37.070329,

                // 2008
                '2008-01': 37.429911, '2008-02': 37.688177, '2008-03': 37.869080, '2008-04': 38.062212,
                '2008-05': 38.305810, '2008-06': 38.673545, '2008-07': 39.025474, '2008-08': 39.251821,
                '2008-09': 39.334249, '2008-10': 39.393250, '2008-11': 39.590216, '2008-12': 39.740658,

                // 2009
                '2009-01': 39.855905, '2009-02': 40.110982, '2009-03': 40.235326, '2009-04': 40.315796,
                '2009-05': 40.537532, '2009-06': 40.780757, '2009-07': 40.952036, '2009-08': 41.046225,
                '2009-09': 41.079061, '2009-10': 41.144787, '2009-11': 41.243534, '2009-12': 41.396135,

                // 2010
                '2010-01': 41.495485, '2010-02': 41.860645, '2010-03': 42.153669, '2010-04': 42.452960,
                '2010-05': 42.762866, '2010-06': 42.946746, '2010-07': 42.899504, '2010-08': 42.869474,
                '2010-09': 42.839465, '2010-10': 43.070798, '2010-11': 43.467049, '2010-12': 43.914759,

                // 2011
                '2011-01': 44.178247, '2011-02': 44.593522, '2011-03': 44.834327, '2011-04': 45.130233,
                '2011-05': 45.455170, '2011-06': 45.714264, '2011-07': 45.814835, '2011-08': 45.814835,
                '2011-09': 46.007257, '2011-10': 46.214289, '2011-11': 46.362174, '2011-12': 46.626438,

                // 2012
                '2012-01': 46.864232, '2012-02': 47.103239, '2012-03': 47.286941, '2012-04': 47.372057,
                '2012-05': 47.675238, '2012-06': 47.937451, '2012-07': 48.062088, '2012-08': 48.268754,
                '2012-09': 48.485963, '2012-10': 48.791424, '2012-11': 49.137843, '2012-12': 49.403187,

                // 2013
                '2013-01': 49.768770, '2013-02': 50.226642, '2013-03': 50.487820, '2013-04': 50.790746,
                '2013-05': 51.090411, '2013-06': 51.269227, '2013-07': 51.412780, '2013-08': 51.345943,
                '2013-09': 51.428096, '2013-10': 51.566951, '2013-11': 51.881509, '2013-12': 52.161669,

                // 2014
                '2014-01': 52.537233, '2014-02': 52.868217, '2014-03': 53.206573, '2014-04': 53.642866,
                '2014-05': 54.061280, '2014-06': 54.385647, '2014-07': 54.527049, '2014-08': 54.597934,
                '2014-09': 54.696210, '2014-10': 54.964221, '2014-11': 55.173085, '2014-12': 55.465502,

                // 2015
                '2015-01': 55.809388, '2015-02': 56.635366, '2015-03': 57.292336, '2015-04': 58.157450,
                '2015-05': 58.570367, '2015-06': 59.150213, '2015-07': 59.605669, '2015-08': 59.951381,
                '2015-09': 60.101259, '2015-10': 60.407775, '2015-11': 60.872914, '2015-12': 61.548603,

                // 2016
                '2016-01': 62.102540, '2016-02': 63.040288, '2016-03': 63.639170, '2016-04': 63.919182,
                '2016-05': 64.328264, '2016-06': 64.958680, '2016-07': 65.263985, '2016-08': 65.681674,
                '2016-09': 65.885287, '2016-10': 65.937995, '2016-11': 66.050089, '2016-12': 66.096324,

                // 2017
                '2017-01': 66.188858, '2017-02': 66.466851, '2017-03': 66.626371, '2017-04': 66.839575,
                '2017-05': 66.893046, '2017-06': 67.133860, '2017-07': 66.932458, '2017-08': 67.046243,
                '2017-09': 67.026129, '2017-10': 67.012723, '2017-11': 67.260670, '2017-12': 67.381739,

                // 2018
                '2018-01': 67.556931, '2018-02': 67.712311, '2018-03': 67.834193, '2018-04': 67.881676,
                '2018-05': 68.024227, '2018-06': 68.316731, '2018-07': 69.293660, '2018-08': 69.466894,
                '2018-09': 69.466894, '2018-10': 69.675294, '2018-11': 69.953995, '2018-12': 69.779110,

                // 2019
                '2019-01': 69.876800, '2019-02': 70.128356, '2019-03': 70.507049, '2019-04': 71.049953,
                '2019-05': 71.476252, '2019-06': 71.583466, '2019-07': 71.590624, '2019-08': 71.662214,
                '2019-09': 71.748208, '2019-10': 71.712333, '2019-11': 71.741017, '2019-12': 72.128418,

                // 2020
                '2020-01': 73.008384, '2020-02': 73.147099, '2020-03': 73.271449, '2020-04': 73.403337,
                '2020-05': 73.234509, '2020-06': 73.051422, '2020-07': 73.270576, '2020-08': 73.592966,
                '2020-09': 73.857900, '2020-10': 74.500463, '2020-11': 75.163517, '2020-12': 75.877570,

                // 2021
                '2021-01': 76.985382, '2021-02': 77.193242, '2021-03': 77.826226, '2021-04': 78.495531,
                '2021-05': 78.793814, '2021-06': 79.550234, '2021-07': 80.027535, '2021-08': 80.843815,
                '2021-09': 81.555240, '2021-10': 82.533902, '2021-11': 83.491295, '2021-12': 84.192621,

                // 2022
                '2022-01': 84.807227, '2022-02': 85.375435, '2022-03': 86.229189, '2022-04': 87.703708,
                '2022-05': 88.615826, '2022-06': 89.014597, '2022-07': 89.566487, '2022-08': 89.029088,
                '2022-09': 88.753097, '2022-10': 88.469087, '2022-11': 88.884891, '2022-12': 89.222653,

                // 2023
                '2023-01': 89.838289, '2023-02': 90.251545, '2023-03': 90.946481, '2023-04': 91.528538,
                '2023-05': 92.013639, '2023-06': 92.344888, '2023-07': 92.252543, '2023-08': 92.169515,
                '2023-09': 92.353854, '2023-10': 92.455443, '2023-11': 92.566389, '2023-12': 92.658955,

                // 2024
                '2024-01': 93.168579, '2024-02': 93.699639, '2024-03': 94.458606, '2024-04': 94.638077,
                '2024-05': 94.988237, '2024-06': 95.425182, '2024-07': 95.663744, '2024-08': 95.912469,
                '2024-09': 96.094702, '2024-10': 96.219625, '2024-11': 96.739210, '2024-12': 97.338993,

                // 2025
                '2025-01': 97.669945, '2025-02': 97.777381, '2025-03': 98.980042, '2025-04': 99.613514,
                '2025-05': 100.041852, '2025-06': 100.402002, '2025-07': 100.663047, '2025-08': 100.995235,
                '2025-09': 100.853841, '2025-10': 101.337939, '2025-11': 101.520347
            };

            const truncarSeisCasas = (valor) => Math.floor(valor * 1_000_000) / 1_000_000;

            const processarIPCA15 = (dados) => {
                dados.forEach(item => {
                    const [d, m, y] = item.data.split('/');
                    let mesTabela = parseInt(m, 10) + 1;
                    let anoTabela = parseInt(y, 10);
                    if (mesTabela > 12) { mesTabela = 1; anoTabela++; }
                    const chave = `${anoTabela}-${String(mesTabela).padStart(2, '0')}`;
                    if (!tabelaTJSP[chave]) {
                        let mA = mesTabela - 1; let aA = anoTabela;
                        if (mA === 0) { mA = 12; aA--; }
                        const chaveAnt = `${aA}-${String(mA).padStart(2, '0')}`;
                        if (tabelaTJSP[chaveAnt]) {
                            const fatorCalculado = tabelaTJSP[chaveAnt] * (1 + (parseFloat(item.valor) / 100));
                            tabelaTJSP[chave] = truncarSeisCasas(fatorCalculado);
                        }
                    }
                });
            };

            const getUltimaChave = () => Object.keys(tabelaTJSP).sort().slice(-1)[0];
            const getFator = (chave) => tabelaTJSP[chave] || tabelaTJSP[getUltimaChave()];

            const chavePorData = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const fatorPorData = (date) => getFator(chavePorData(date));

            let ipcaData = {};
            let ipca15Data = {};
            let monthlySelicData = {};
            let lastCalculationData = null;

            // --- FUNÇÃO GERAL DE RENDERIZAÇÃO DE PDF ---
            const renderParagraph = (pdf, html, options) => {
                let { currentY, margin, maxWidth, lineSpacing, paraSpacing, indent } = options;

                const checkPageBreak = (neededHeight) => {
                    if (currentY + neededHeight > pdf.internal.pageSize.getHeight() - margin) {
                        pdf.addPage();
                        currentY = margin;
                    }
                };

                checkPageBreak(lineSpacing * 2);

                const words = [];
                html.split(/<strong>(.*?)<\/strong>|<i>(.*?)<\/i>/g).forEach((part, i) => {
                    if (part) {
                        const isBold = (i % 3 === 1);
                        const isItalic = (i % 3 === 2);
                        part.trim().split(/\s+/).filter(Boolean).forEach(word => words.push({ text: word, isBold, isItalic }));
                    }
                });


                const processedWords = [];
                for (let i = 0; i < words.length; i++) {
                    const currentWord = words[i];
                    if (i + 1 < words.length && /^[.,;:]/.test(words[i + 1].text)) {
                        currentWord.text += words[i + 1].text;
                        i++;
                    }
                    processedWords.push(currentWord);
                }

                const lines = [];
                let currentLine = [];
                let currentLineWidth = 0;
                const spaceWidth = pdf.getStringUnitWidth(' ') * 12 / pdf.internal.scaleFactor;
                const indentWidth = pdf.getStringUnitWidth(' '.repeat(15)) * 12 / pdf.internal.scaleFactor;

                for (const word of processedWords) {
                    let fontStyle = 'normal';
                    if (word.isBold && word.isItalic) fontStyle = 'bolditalic';
                    else if (word.isBold) fontStyle = 'bold';
                    else if (word.isItalic) fontStyle = 'italic';
                    pdf.setFont('times', fontStyle);

                    const wordWidth = pdf.getStringUnitWidth(word.text) * 12 / pdf.internal.scaleFactor;

                    let effectiveMaxWidth = maxWidth;
                    if (lines.length === 0 && indent) {
                        effectiveMaxWidth -= indentWidth;
                    }

                    if (currentLineWidth + (currentLine.length > 0 ? spaceWidth : 0) + wordWidth > effectiveMaxWidth) {
                        lines.push(currentLine);
                        currentLine = [word];
                        currentLineWidth = wordWidth;
                    } else {
                        currentLine.push(word);
                        currentLineWidth += (currentLine.length > 0 ? spaceWidth : 0) + wordWidth;
                    }
                }
                if (currentLine.length > 0) lines.push(currentLine);

                lines.forEach((line, lineIndex) => {
                    checkPageBreak(lineSpacing);
                    const isLastLineOfPara = lineIndex === lines.length - 1;

                    let wordsWidth = 0;
                    line.forEach(word => {
                        let fontStyle = 'normal';
                        if (word.isBold && word.isItalic) fontStyle = 'bolditalic';
                        else if (word.isBold) fontStyle = 'bold';
                        else if (word.isItalic) fontStyle = 'italic';
                        pdf.setFont('times', fontStyle);
                        wordsWidth += pdf.getStringUnitWidth(word.text) * 12 / pdf.internal.scaleFactor;
                    });

                    let currentX = margin;
                    let spacing = spaceWidth;

                    if (!isLastLineOfPara && line.length > 1) {
                        let availableWidth = maxWidth;
                        if (lineIndex === 0 && indent) {
                            availableWidth -= indentWidth;
                        }
                        spacing = (availableWidth - wordsWidth) / (line.length - 1);
                    }

                    if (lineIndex === 0 && indent) {
                        currentX += indentWidth;
                    }

                    line.forEach(word => {
                        let fontStyle = 'normal';
                        if (word.isBold && word.isItalic) fontStyle = 'bolditalic';
                        else if (word.isBold) fontStyle = 'bold';
                        else if (word.isItalic) fontStyle = 'italic';
                        pdf.setFont('times', fontStyle);
                        pdf.text(word.text, currentX, currentY);
                        currentX += pdf.getStringUnitWidth(word.text) * 12 / pdf.internal.scaleFactor + spacing;
                    });

                    currentY += lineSpacing;
                });

                return currentY + paraSpacing;
            };

            // --- FUNÇÕES DE SETUP E UI ---

            const toggleMainView = () => {
                const selectedApp = mainAppSelect.value;
                if (selectedApp === 'calculator') {
                    calcAppContainer.classList.remove('hidden');
                    manifestAppContainer.classList.add('hidden');
                    mainTitle.textContent = 'Calculadora de Atualização de Débito Judicial';
                    mainSubtitle.textContent = 'Selecione o tipo de cálculo e insira os dados para a atualização monetária.';
                } else { // manifestation
                    calcAppContainer.classList.add('hidden');
                    manifestAppContainer.classList.remove('hidden');
                    mainTitle.textContent = 'Gerador de Petições/Manifestações';
                    mainSubtitle.textContent = 'Preencha os campos para gerar seu documento em PDF.';
                }
            };

            const recomputarIpcaDeTabela = () => {
                const chaves = Object.keys(tabelaTJSP).sort();
                const calculado = {};
                for (let i = 1; i < chaves.length; i++) {
                    const atual = tabelaTJSP[chaves[i]];
                    const anterior = tabelaTJSP[chaves[i - 1]];
                    calculado[chaves[i]] = ((atual / anterior) - 1) * 100;
                }
                ipcaData = { ...calculado };
                ipca15Data = { ...calculado }; // usamos a mesma série derivada da tabela TJSP
            };

            const fetchEconomicData = async () => {
                const today = new Date();
                const anoAtual = today.getFullYear();

                const ipca15Url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.7478/dados?formato=json&dataInicial=01/01/${anoAtual}`;
                const selicUrl = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados?formato=json&dataInicial=01/01/2024`;

                try {
                    const [ipca15Response, selicResponse] = await Promise.all([fetch(ipca15Url), fetch(selicUrl)]);
                    if (!ipca15Response.ok || !selicResponse.ok) throw new Error('Falha ao buscar dados do Banco Central.');

                    const [ipca15Json, selicJson] = await Promise.all([ipca15Response.json(), selicResponse.json()]);

                    processarIPCA15(ipca15Json);
                    recomputarIpcaDeTabela();

                    monthlySelicData = selicJson.reduce((acc, d) => {
                        const [dia, mes, ano] = d.data.split('/');
                        acc[`${ano}-${mes}`] = parseFloat(d.valor);
                        return acc;
                    }, {});

                    calculateBtn.disabled = false;
                    calculateBtn.innerHTML = 'Calcular Valor Atualizado';
                    calculateBtn.className = calculateBtn.className.replace('bg-indigo-400 cursor-not-allowed', 'bg-indigo-600 hover:bg-indigo-700');
                } catch (error) {
                    console.error('Erro ao buscar dados econômicos:', error);
                    calculateBtn.innerHTML = 'Erro ao carregar dados';
                    calculateBtn.className = calculateBtn.className.replace('bg-indigo-400', 'bg-red-600');
                    alert('Não foi possível carregar os índices econômicos. Por favor, tente recarregar a página.');
                }
            };

            const toggleCalculationView = () => {
                const type = calculationTypeSelect.value;
                if (type === 'condemnation') {
                    condemnationContainer.classList.remove('hidden');
                    agreementContainer.classList.add('hidden');
                    condemnationOptions.classList.remove('hidden');
                    agreementPetitionOption.classList.add('hidden');
                    intimationRequestContainer.classList.add('hidden');
                    petitionOptionsContainer.classList.toggle('hidden', !complianceRequestCheckbox.checked);
                } else { // agreement
                    condemnationContainer.classList.add('hidden');
                    agreementContainer.classList.remove('hidden');
                    condemnationOptions.classList.add('hidden');
                    agreementPetitionOption.classList.remove('hidden');
                    intimationRequestContainer.classList.remove('hidden');
                    petitionOptionsContainer.classList.remove('hidden'); // Petição é obrigatória aqui
                }
                resultsContainer.classList.add('hidden');
            };

            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const addRow = () => {
                const newRow = rowsContainer.querySelector('.calculation-row').cloneNode(true);
                newRow.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
                const select = newRow.querySelector('.description-select');
                select.selectedIndex = 0;
                newRow.querySelector('.other-description-input').classList.add('hidden');
                rowsContainer.appendChild(newRow);
                addInputBehaviors(newRow);
            };

            const removeRow = (e) => {
                if (e.target.classList.contains('remove-row-btn')) {
                    if (rowsContainer.children.length > 1) {
                        e.target.closest('.calculation-row').remove();
                    } else {
                        alert('Pelo menos uma linha de cálculo é necessária.');
                    }
                }
            };

            const formatCNJOnInput = (e) => {
                let v = e.target.value.replace(/\D/g, "");
                v = v.replace(/(\d{7})(\d)/, "$1-$2").replace(/(\d{7}-\d{2})(\d)/, "$1.$2")
                    .replace(/(\d{7}-\d{2}\.\d{4})(\d)/, "$1.$2").replace(/(\d{7}-\d{2}\.\d{4}\.\d{1})(\d)/, "$1.$2")
                    .replace(/(\d{7}-\d{2}\.\d{4}\.\d{1}\.\d{2})(\d)/, "$1.$2");
                e.target.value = v;
            };

            const formatDateOnInput = (e) => {
                let v = e.target.value.replace(/\D/g, "").slice(0, 8);
                v = v.replace(/(\d{2})(\d)/, "$1/$2").replace(/(\d{2})\/(\d{2})(\d)/, "$1/$2/$3");
                e.target.value = v;
            };

            const autocompleteDateOnBlur = (e) => {
                let value = e.target.value;
                if (!value) return;
                const parts = value.split('/');
                if (parts.length === 3 && parts[2].length === 4) return;
                const today = new Date();
                const day = parts[0] || '';
                let month = parts[1] || '';
                let year = parts[2] || '';
                if (day && !month) {
                    month = String(today.getMonth() + 1).padStart(2, '0');
                    year = today.getFullYear();
                } else if (day && month && !year) {
                    year = today.getFullYear();
                }
                if (year.length > 0 && year.length < 4) {
                    year = parseInt(year, 10) < 50 ? '20' + year.padStart(2, '0') : '19' + year.padStart(2, '0');
                }
                e.target.value = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
            };

            const formatValueOnBlur = (e) => {
                const input = e.target;
                let value = input.value;
                if (!value) return;

                value = value.replace(/[^\d,]/g, '').replace(',', '.');

                const number = parseFloat(value);

                if (!isNaN(number)) {
                    input.value = number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                } else {
                    input.value = '';
                }
            };

            const formatCpfCnpjOnInput = (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 14) {
                    value = value.substring(0, 14);
                }

                if (value.length <= 11) {
                    // CPF
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                } else {
                    // CNPJ
                    value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                    value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                    value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                }
                e.target.value = value;
            };

            const formatCpfCnpj = (value) => {
                value = value.replace(/\D/g, '').slice(0, 14);
                if (value.length <= 11) value = value.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                else value = value.replace(/^(\d{2})(\d)/, '$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3').replace(/\.(\d{3})(\d)/, '.$1/$2').replace(/(\d{4})(\d)/, '$1-$2');
                return value;
            };

            const formatPhone = (value) => {
                value = value.replace(/\D/g, '').slice(0, 11);
                if (value.length > 10) value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, "($1) $2-$3");
                else if (value.length > 5) value = value.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, "($1) $2-$3");
                else if (value.length > 2) value = value.replace(/^(\d\d)(\d{0,5}).*/, "($1) $2");
                else value = value.replace(/^(\d*)/, "($1");
                return value;
            };

            const formatDate = (value) => value.replace(/\D/g, '').slice(0, 8).replace(/(\d{2})(\d)/, '$1/$2').replace(/(\d{2})\/(\d{2})(\d)/, '$1/$2/$3');


            const addInputBehaviors = (container) => {
                container.querySelectorAll('.date-input').forEach(input => {
                    input.removeEventListener('input', formatDateOnInput);
                    input.removeEventListener('blur', autocompleteDateOnBlur);
                    input.addEventListener('input', formatDateOnInput);
                    input.addEventListener('blur', autocompleteDateOnBlur);
                });
                container.querySelectorAll('.value-input').forEach(input => {
                    input.removeEventListener('blur', formatValueOnBlur);
                    input.addEventListener('blur', formatValueOnBlur);
                });
            };

            // --- LÓGICA DE CÁLCULO ---

            const parseDate = (dateStr) => {
                if (!dateStr || dateStr.length < 10) return null;
                const [day, month, year] = dateStr.split('/');
                return new Date(`${year}-${month}-${day}T12:00:00Z`);
            };

            const getFinalCalcDate = () => {
                const finalDateStr = document.getElementById('final-date').value;
                const parsedFinalDate = parseDate(finalDateStr);
                return parsedFinalDate instanceof Date && !isNaN(parsedFinalDate) ? parsedFinalDate : new Date();
            };

            const performCondemnationCalculation = () => {
                const finalCalcDate = getFinalCalcDate();
                const calculationResult = {
                    type: 'condemnation',
                    processNumber: processNumberInputCalc.value || 'Não informado',
                    rows: [],
                    summary: {},
                    finalCalcDate: finalCalcDate
                };

                let positiveRows = [];
                let deductionRows = [];

                document.querySelectorAll('.calculation-row').forEach(row => {
                    const descriptionSelect = row.querySelector('.description-select');
                    let description = descriptionSelect.value;
                    if (description === 'Outro') {
                        description = row.querySelector('.other-description-input').value.trim() || 'Outro (não especificado)';
                    }

                    const rawValue = row.querySelector('.value-input').value;
                    const originalValue = parseFloat(rawValue.replace(/\./g, '').replace(',', '.')) || 0;
                    const correctionDate = parseDate(row.querySelector('.correction-date-input').value);
                    const interestDate = parseDate(row.querySelector('.interest-date-input').value);

                    if (originalValue === 0 || !correctionDate) return;

                    const fatorInicio = fatorPorData(correctionDate);
                    const fatorFim = fatorPorData(finalCalcDate);
                    const correctedValue = originalValue * (fatorFim / fatorInicio);
                    const totalCorrection = correctedValue - originalValue;

                    let totalInterest = 0;
                    if (descriptionSelect.value !== 'Dedução/Pagamento Parcial' && interestDate) {
                        let baseForInterest = originalValue * (fatorPorData(interestDate) / fatorInicio);

                        for (let d = new Date(interestDate); d < finalCalcDate; d.setMonth(d.getMonth() + 1)) {
                            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            let monthlyRate = (monthlySelicData[key] || 0) - (ipca15Data[key] || 0);
                            monthlyRate = Math.max(0, monthlyRate) / 100;
                            if (d.getFullYear() === finalCalcDate.getFullYear() && d.getMonth() === finalCalcDate.getMonth()) {
                                monthlyRate *= finalCalcDate.getDate() / new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                            }
                            totalInterest += baseForInterest * monthlyRate;
                        }
                    }

                    const finalValueForRow = originalValue + totalCorrection + totalInterest;
                    const rowData = {
                        description,
                        originalValue,
                        totalCorrection,
                        totalInterest,
                        finalValueForRow,
                        indiceInicial: fatorInicio,
                        indiceFinal: fatorFim
                    };

                    if (descriptionSelect.value === 'Dedução/Pagamento Parcial') {
                        deductionRows.push(rowData);
                    } else {
                        positiveRows.push(rowData);
                    }
                });

                calculationResult.rows = [...positiveRows, ...deductionRows];

                const positiveSubtotal = positiveRows.reduce((acc, row) => acc + row.finalValueForRow, 0);
                const totalDeductions = deductionRows.reduce((acc, row) => acc + row.finalValueForRow, 0);

                const subtotal = positiveSubtotal - totalDeductions;
                const addFine = addFineCheckbox.checked;
                const fineValue = addFine ? subtotal * 0.10 : 0;
                const grandTotal = subtotal + fineValue;

                calculationResult.summary = { subtotal, addFine, fineValue, grandTotal, totalDeductions, positiveSubtotal };

                return (calculationResult.rows.length === 0) ? null : calculationResult;
            };

            const performAgreementCalculation = () => {
                const totalInstallments = parseInt(document.getElementById('agreement-total-installments').value) || 0;
                const paidInstallments = parseInt(document.getElementById('agreement-paid-installments').value) || 0;
                const rawInstallmentValue = document.getElementById('agreement-installment-value').value;
                const installmentValue = parseFloat(rawInstallmentValue.replace(/\./g, '').replace(',', '.')) || 0;
                const startDate = parseDate(document.getElementById('agreement-start-date').value);
                const penaltyPercent = parseFloat(document.getElementById('agreement-penalty').value) || 0;
                const penaltyBaseType = document.querySelector('input[name="penalty-base"]:checked').value;


                if (totalInstallments <= 0 || installmentValue <= 0 || !startDate) {
                    alert('Preencha todos os campos do acordo: parcelas totais, valor da parcela e data de início.');
                    return null;
                }

                const finalCalcDate = getFinalCalcDate();
                const installmentsDetails = [];

                const updateValue = (value, dateFrom, dateTo) => {
                    const fatorInicio = fatorPorData(dateFrom);
                    const fatorFim = fatorPorData(dateTo);
                    return { valor: value * (fatorFim / fatorInicio), fatorInicio, fatorFim };
                };

                for (let i = 0; i < totalInstallments; i++) {
                    const installmentDate = new Date(startDate);
                    installmentDate.setMonth(startDate.getMonth() + i);
                    const atualizado = updateValue(installmentValue, installmentDate, finalCalcDate);

                    installmentsDetails.push({
                        number: i + 1,
                        originalDate: installmentDate,
                        originalValue: installmentValue,
                        updatedValue: atualizado.valor,
                        indiceInicial: atualizado.fatorInicio,
                        indiceFinal: atualizado.fatorFim,
                        status: i < paidInstallments ? 'Paga' : 'Não Paga'
                    });
                }

                const totalUpdatedValue = installmentsDetails.reduce((sum, inst) => sum + inst.updatedValue, 0);
                const paidUpdatedValue = installmentsDetails.filter(inst => inst.status === 'Paga').reduce((sum, inst) => sum + inst.updatedValue, 0);
                const updatedDebt = totalUpdatedValue - paidUpdatedValue;
                const totalOriginalDebt = totalInstallments * installmentValue;

                let penaltyBaseValue = 0;
                if (penaltyBaseType === 'remaining') {
                    penaltyBaseValue = updatedDebt;
                } else { // 'total'
                    penaltyBaseValue = totalOriginalDebt;
                }
                const penaltyValue = penaltyBaseValue * (penaltyPercent / 100);

                const rawDeductionValue = document.getElementById('agreement-deduction-value').value;
                const deductionValue = parseFloat(rawDeductionValue.replace(/\./g, '').replace(',', '.')) || 0;
                const deductionDate = parseDate(document.getElementById('agreement-deduction-date').value);
                let updatedDeductionValue = 0;
                if (deductionValue > 0 && deductionDate) {
                    const dedAtualizado = updateValue(deductionValue, deductionDate, finalCalcDate);
                    updatedDeductionValue = dedAtualizado.valor;
                }

                const grandTotal = updatedDebt + penaltyValue - updatedDeductionValue;

                return {
                    type: 'agreement',
                    processNumber: processNumberInputCalc.value || 'Não informado',
                    finalCalcDate: finalCalcDate,
                    installments: installmentsDetails,
                    summary: {
                        totalOriginal: totalOriginalDebt,
                        paidOriginal: paidInstallments * installmentValue,
                        remainingOriginal: totalOriginalDebt - (paidInstallments * installmentValue),
                        totalUpdated: totalUpdatedValue,
                        paidUpdated: paidUpdatedValue,
                        updatedDebt: updatedDebt,
                        penaltyValue: penaltyValue,
                        grandTotal: grandTotal,
                        penaltyPercent: penaltyPercent,
                        paidInstallments: paidInstallments,
                        penaltyBaseType: penaltyBaseType,
                        penaltyBaseValue: penaltyBaseValue,
                        updatedDeductionValue: updatedDeductionValue,
                        deductionValue: deductionValue
                    }
                };
            };
            const handleCalculateClick = () => {
                const type = calculationTypeSelect.value;
                let data = null;
                if (type === 'condemnation') {
                    data = performCondemnationCalculation();
                } else { // agreement
                    data = performAgreementCalculation();
                }

                if (data) {
                    lastCalculationData = data;
                    displayResults(data);
                }
            };

            // --- FUNÇÕES DE EXIBIÇÃO ---

            const displayResults = (data) => {
                let resultsHTML = '';
                if (data.type === 'condemnation') {
                    resultsHTML = getCondemnationResultsHTML(data);
                } else {
                    resultsHTML = getAgreementResultsHTML(data);
                }

                resultsContainer.innerHTML = resultsHTML;
                resultsContainer.classList.remove('hidden');

                const hasResults = data.summary.grandTotal > 0;

                const styleButton = (btn, enabled, colorClass = 'bg-green-600 hover:bg-green-700') => {
                    btn.disabled = !enabled;
                    if (enabled) {
                        btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        btn.classList.add(...colorClass.split(' '));
                    } else {
                        btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        btn.classList.remove(...colorClass.split(' '));
                    }
                };

                styleButton(previewBtn, hasResults, 'bg-blue-600 hover:bg-blue-700');

                const isPetitionIncluded = (data.type === 'condemnation' && complianceRequestCheckbox.checked) || data.type === 'agreement';

                printBtn.classList.add('hidden');
                printCombinedBtn.classList.add('hidden');
                printPetitionBtn.classList.add('hidden');
                printCalcBtn.classList.add('hidden');

                if (isPetitionIncluded) {
                    printCombinedBtn.classList.remove('hidden');
                    printPetitionBtn.classList.remove('hidden');
                    printCalcBtn.classList.remove('hidden');
                    styleButton(printCombinedBtn, hasResults);
                    styleButton(printPetitionBtn, hasResults);
                    styleButton(printCalcBtn, hasResults);
                } else {
                    printBtn.classList.remove('hidden');
                    styleButton(printBtn, hasResults);
                }
            };


            const getCondemnationResultsHTML = (data) => {
                let html = '<h3 class="text-xl font-bold text-gray-800 mb-4">Resumo do Cálculo de Condenação</h3><div class="space-y-6">';
                data.rows.forEach((row, index) => {
                    const isDeduction = data.summary.totalDeductions > 0 && row.description.includes('Dedução');
                    const indicesHtml = (row.indiceInicial && row.indiceFinal)
                        ? `<div class="text-xs text-gray-500 mt-2">Índice inicial: ${row.indiceInicial.toFixed(6)} | Índice final: ${row.indiceFinal.toFixed(6)}</div>`
                        : '';
                    html += `<div class="p-4 border rounded-lg bg-white"><p class="font-semibold text-lg ${isDeduction ? 'text-red-600' : 'text-indigo-700'}">${index + 1}. ${row.description}</p><div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 mt-2 text-sm"><div><span class="font-medium text-gray-600">Valor Original:</span><br>${formatCurrency(row.originalValue)}</div><div><span class="font-medium text-gray-600">Correção (Tabela TJSP):</span><br>${formatCurrency(row.totalCorrection)}</div><div><span class="font-medium text-gray-600">Juros de Mora:</span><br>${formatCurrency(row.totalInterest)}</div><div class="font-bold"><span class="font-medium text-gray-600">Subtotal:</span><br>${formatCurrency(row.finalValueForRow)}</div></div>${indicesHtml}</div>`;
                });
                html += `</div>`;

                const fineRowHtml = data.summary.addFine ? `<div class="flex justify-between items-center mt-2"><p class="text-lg font-semibold text-gray-700">Multa do art. 523 (10%):</p><p class="text-xl font-semibold text-red-600">${formatCurrency(data.summary.fineValue)}</p></div>` : '';
                const deductionRowHtml = data.summary.totalDeductions > 0 ? `<div class="flex justify-between items-center"><p class="text-lg text-gray-600">(-) Total Deduzido:</p><p class="text-xl font-bold text-green-600">${formatCurrency(data.summary.totalDeductions)}</p></div>` : '';

                html += `<div class="mt-8 pt-4 border-t-2 border-indigo-500 text-right space-y-2">
                        <div class="flex justify-between items-center"><p class="text-lg text-gray-600">Subtotal da Condenação:</p><p class="text-2xl font-bold text-indigo-700">${formatCurrency(data.summary.positiveSubtotal)}</p></div>
                        ${deductionRowHtml}
                        ${fineRowHtml}
                        <div class="flex justify-between items-center pt-4 border-t mt-2"><p class="text-lg font-bold text-gray-800">Valor Total do Débito:</p><p class="text-3xl font-bold text-indigo-700">${formatCurrency(data.summary.grandTotal)}</p></div>
                    </div>`;
                return html;
            }

            const getAgreementResultsHTML = (data) => {
                const s = data.summary;
                const installments = data.installments;
                let penaltyHelperText = '';
                if (s.penaltyBaseType === 'remaining') {
                    penaltyHelperText = `(Multa sobre o saldo devedor atualizado de ${formatCurrency(s.penaltyBaseValue)})`;
                } else { // 'total'
                    penaltyHelperText = `(Multa sobre o valor original do acordo de ${formatCurrency(s.penaltyBaseValue)})`;
                }

                const createTableHTML = (title, items, colorClass, headColorClass) => {
                    if (items.length === 0) return '';
                    let tableHTML = `<h4 class="text-lg font-semibold text-gray-700 mt-4">${title}</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="${headColorClass} text-white">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left font-semibold">Parcela</th>
                                    <th class="py-2 px-4 border-b text-left font-semibold">Vencimento</th>
                                    <th class="py-2 px-4 border-b text-right font-semibold">Valor Original</th>
                                    <th class="py-2 px-4 border-b text-right font-semibold">Valor Atualizado</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    items.forEach(item => {
                        tableHTML += `<tr>
                            <td class="py-2 px-4 border-b">${item.number}</td>
                            <td class="py-2 px-4 border-b">${item.originalDate.toLocaleDateString('pt-BR')}</td>
                            <td class="py-2 px-4 border-b text-right">${formatCurrency(item.originalValue)}</td>
                            <td class="py-2 px-4 border-b text-right ${colorClass}">${formatCurrency(item.updatedValue)}
                                <div class="text-xs text-gray-500 mt-1">Índice inicial: ${item.indiceInicial ? item.indiceInicial.toFixed(6) : '-'} | Índice final: ${item.indiceFinal ? item.indiceFinal.toFixed(6) : '-'}</div>
                            </td>
                        </tr>`;
                    });
                    tableHTML += `</tbody></table></div>`;
                    return tableHTML;
                };

                const deductionRowHtml = s.updatedDeductionValue > 0 ? `<div class="flex justify-between p-2 rounded-lg"><span class="font-medium text-gray-600">(-) Dedução Adicional (Atualizada):</span><span class="text-green-600">${formatCurrency(s.updatedDeductionValue)}</span></div>` : '';


                const paidInstallments = installments.filter(i => i.status === 'Paga');
                const unpaidInstallments = installments.filter(i => i.status !== 'Paga');

                return `
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Resumo do Descumprimento de Acordo</h3>
                        
                        ${createTableHTML('Detalhamento das Parcelas Pagas', paidInstallments, 'text-green-600', 'bg-green-700')}
                        ${createTableHTML('Detalhamento das Parcelas Vencidas e Não Pagas', unpaidInstallments, 'text-red-600', 'bg-red-700')}

                        <div class="mt-8 pt-4 border-t-2 border-gray-300 space-y-4 text-base">
                            <div class="p-2 rounded-lg bg-gray-50">
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-600">Valor Total do Acordo (Atualizado):</span>
                                    <span>${formatCurrency(s.totalUpdated)}</span>
                                </div>
                            </div>

                            <div class="p-2 rounded-lg">
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-600">(-) Valor Pago (${s.paidInstallments} parcelas) (Atualizado):</span>
                                    <span class="text-green-600">${formatCurrency(s.paidUpdated)}</span>
                                </div>
                            </div>

                            <hr class="my-2"/>

                            <div class="flex justify-between p-2 rounded-lg">
                                <span class="font-medium text-gray-800">(=) Saldo Devedor (Atualizado):</span>
                                <span class="font-bold">${formatCurrency(s.updatedDebt)}</span>
                            </div>
                            
                            ${deductionRowHtml}

                            <div class="flex justify-between p-2 rounded-lg">
                                <span class="font-medium text-gray-600">(+) Multa por Descumprimento (${s.penaltyPercent}%):</span>
                                <span class="text-red-600">${formatCurrency(s.penaltyValue)}</span>
                            </div>
                            <div class="text-right text-sm text-gray-500 -mt-3">
                                <span>${penaltyHelperText}</span>
                            </div>


                            <div class="flex justify-between p-3 rounded-lg bg-indigo-100 mt-4 border-t-2 border-indigo-500">
                                <span class="text-lg font-bold text-gray-800">Valor Total do Débito:</span>
                                <span class="text-2xl font-bold text-indigo-700">${formatCurrency(s.grandTotal)}</span>
                            </div>
                        </div>
                    `;
            }

            // --- GERAÇÃO DE PDF E PETIÇÃO ---

            const generatePetitionHTML = (data) => {
                const isPetitionIncluded = (data.type === 'condemnation' && complianceRequestCheckbox.checked) || data.type === 'agreement';
                if (!isPetitionIncluded) {
                    return null;
                }

                const exequenteInputs = exequentesList.querySelectorAll('.exequente-name-input');
                const allExequentes = Array.from(exequenteInputs).map(input => input.value.trim().toUpperCase()).filter(Boolean);

                if (allExequentes.length === 0) {
                    alert('Por favor, informe o nome de pelo menos um exequente para gerar a petição.');
                    exequenteInputs[0].focus();
                    return null;
                }

                let exequentesText = allExequentes.length === 1 ? `<strong>${allExequentes[0]}</strong>, já qualificado(a) nos autos`
                    : allExequentes.join(', ').replace(/,([^,]*)$/, ' e$1') + ', já qualificados nos autos';

                let mainParagraphs = '';
                if (data.type === 'condemnation') {
                    mainParagraphs = `
                            <p style="text-indent: 4em;">${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong> em face do(a)(s) executado(a)(s), também já qualificado(a)(s), tendo em vista o trânsito em julgado da r. sentença.</p>
                            <p style="text-indent: 4em;">Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo legal, efetue o pagamento devido, no importe de <strong>${formatCurrency(data.summary.subtotal)}</strong>, conforme cálculo anexo. Não ocorrendo o pagamento, requer que o débito seja acrescido da multa de 10%, prevista no art. 523, §1º do CPC, totalizando a quantia de <strong>${formatCurrency(data.summary.subtotal * 1.10)}</strong>.</p>
                        `;
                } else { // agreement
                    const agreementType = document.getElementById('agreement-type-calc').value;
                    const actionText = agreementType === 'conhecimento' ? 'requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong>' : 'informar o descumprimento do acordo e requerer o <strong>PROSSEGUIMENTO DA EXECUÇÃO</strong>';
                    const multaText = data.summary.penaltyPercent > 0 ? 'já com o acréscimo da multa' : '';
                    let intimationText = '';
                    if (includeIntimationCheckbox.checked) {
                        const deadline = document.getElementById('intimation-deadline').value;
                        intimationText = `Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo de <strong>${deadline}</strong> dias, efetue o pagamento do valor remanescente, sob pena de reinício da execução e penhora de bens.`;
                    }

                    mainParagraphs = `
                            <p style="text-indent: 4em;">${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, informar o descumprimento do acordo homologado nos autos e, ato contínuo, ${actionText}.</p>
                            <p style="text-indent: 4em;">Conforme se demonstra pelo cálculo anexo, o débito atualizado remanescente, ${multaText}, perfaz o montante de <strong>${formatCurrency(data.summary.grandTotal)}</strong>. ${intimationText}</p>
                        `;
                }

                const requests = [];
                if (document.getElementById('penhora-contas').checked) requests.push('a pesquisa e bloqueio de valores em contas bancárias via SISBAJUD;');
                if (document.getElementById('penhora-veiculos').checked) requests.push('a pesquisa, bloqueio e penhora de veículos via RENAJUD;');
                if (document.getElementById('penhora-mandado').checked) requests.push('a expedição de mandado de penhora e avaliação de bens;');
                const outrosTextValue = penhoraOutrosText.value.trim();
                if (penhoraOutrosCheck.checked && outrosTextValue) requests.push(outrosTextValue);

                let penhoraRequestsHTML = '';
                if (requests.length > 0) {
                    let penhoraHeader = 'Caso não haja o pagamento voluntário, requer o prosseguimento da execução com as seguintes medidas:';
                    if (data.type === 'agreement' && !includeIntimationCheckbox.checked) {
                        penhoraHeader = 'Requer a realização das seguintes medidas para constrição e penhora:';
                    }
                    penhoraRequestsHTML = `
                            <p style="text-indent: 4em;">${penhoraHeader}</p>
                            <div style="padding-left: 40px;">
                                ${requests.map((req, index) => `<p>${toRoman(index + 1)}. ${req}</p>`).join('')}
                            </div>
                        `;
                }

                const printDate = data.finalCalcDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                const signaturesHTML = allExequentes.map(name => `<div style="text-align: center; margin-top: 40px;"><p style="border-top: 1px solid black; width: 75%; margin: 0 auto; padding-top: 5px;">${name}</p></div>`).join('');

                return `
                        <div style="font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 2; text-align: justify;">
                            <p style="text-align: center; font-weight: bold;">EXCELENTÍSSIMO(A) SENHOR(A) DOUTOR(A) JUIZ(A) DE DIREITO DO JUIZADO ESPECIAL CÍVEL DA COMARCA DE MARÍLIA - SP</p>
                            <p style="margin-top: 2cm;"><strong>Processo nº: ${data.processNumber}</strong></p>
                            <div style="margin-top: 1cm;">
                                ${mainParagraphs}
                            </div>
                            ${penhoraRequestsHTML}
                            <p style="margin-top: 2cm;">Nestes termos, pede deferimento.</p>
                            <p style="margin-top: 2cm; text-align: right;">Marília, ${printDate}.</p>
                            <div style="margin-top: 4cm;">${signaturesHTML}</div>
                        </div>
                    `;
            };

            const showPreview = () => {
                if (!lastCalculationData) {
                    alert('Calcule os valores primeiro.');
                    return;
                }
                let finalHTML = '';
                const petitionHTML = generatePetitionHTML(lastCalculationData);
                if (petitionHTML) {
                    finalHTML += `<h2 class="text-xl font-bold text-center mb-4">Página 1: Petição</h2><div class="p-8 border shadow-lg bg-white mx-auto" style="width: 210mm;">${petitionHTML}</div>`;
                }

                const calculationHTML = resultsContainer.innerHTML;
                finalHTML += `<h2 class="text-xl font-bold text-center mt-8 mb-4">Página 2: Demonstrativo de Cálculo</h2><div class="p-8 border shadow-lg bg-white mx-auto" style="width: 210mm;"><h2 class="text-2xl font-bold text-gray-800 text-center">Demonstrativo de Cálculo de Débito Judicial</h2><p class="text-center text-gray-600 mt-1">Cálculo realizado em: ${lastCalculationData.finalCalcDate.toLocaleDateString('pt-BR')}</p><p class="my-4"><strong>Processo nº:</strong> ${lastCalculationData.processNumber}</p><hr class="my-4"/>${calculationHTML}</div>`;

                previewContent.innerHTML = finalHTML;
                previewModal.classList.remove('hidden');
            };

            const prePrintValidation = (isForManifestation = false) => {
                if (isForManifestation) {
                    if (!processNumberManifest.value || !document.querySelector('.manifest-name').value || !document.querySelector('.manifest-cpf').value) {
                        alert("Por favor, preencha todos os campos obrigatórios: Nº do Processo, Nome da Parte e CPF.");
                        return false;
                    }

                    const selectedOption = manifestationType.value;
                    if (selectedOption === 'desbloqueioDetalhado') {
                        if (!detalheValorInput.value.trim() || !detalheDataInput.value.trim()) {
                            alert('Informe o valor bloqueado e a data do bloqueio para prosseguir.');
                            return false;
                        }
                    }
                    // Validação das testemunhas
                    const witnesses = document.querySelectorAll('.witness-item');
                    for (const witness of witnesses) {
                        const requiresIntimation = witness.querySelector('.witness-intimation').checked;
                        const address = witness.querySelector('.witness-address').value.trim();
                        const name = witness.querySelector('.witness-name').value.trim() || 'sem nome';

                        if (requiresIntimation && !address) {
                            alert(`O endereço da testemunha "${name}" é obrigatório, pois a intimação pessoal foi solicitada.`);
                            witness.querySelector('.witness-address').focus();
                            return false;
                        }
                    }
                } else {
                    if (!lastCalculationData) {
                        alert('Por favor, calcule os valores antes de gerar o PDF.');
                        return false;
                    }
                    const isPetitionIncluded = (lastCalculationData.type === 'condemnation' && complianceRequestCheckbox.checked) || lastCalculationData.type === 'agreement';
                    if (isPetitionIncluded) {
                        const exequenteInputs = exequentesList.querySelectorAll('.exequente-name-input');
                        const allExequentes = Array.from(exequenteInputs).map(input => input.value.trim()).filter(Boolean);
                        if (allExequentes.length === 0) {
                            alert('Por favor, informe o nome de pelo menos um exequente para gerar a petição.');
                            exequentesList.querySelector('.exequente-name-input').focus();
                            return false;
                        }
                        const penhoraChecks = [
                            document.getElementById('penhora-contas').checked,
                            document.getElementById('penhora-veiculos').checked,
                            document.getElementById('penhora-mandado').checked,
                            document.getElementById('penhora-outros-check').checked,
                        ];
                        if (!penhoraChecks.some(c => c)) {
                            alert('Selecione pelo menos um pedido de penhora ao incluir uma petição.');
                            return false;
                        }
                    }
                }
                return true;
            };

            const generateCalculationOnlyPDF = async () => {
                if (!prePrintValidation()) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                if (lastCalculationData.type === 'condemnation') {
                    generateCondemnationCalcPage(pdf, lastCalculationData);
                } else {
                    generateAgreementCalcPage(pdf, lastCalculationData);
                }
                pdf.save(`Calculo_${lastCalculationData.processNumber.replace(/\D/g, '')}.pdf`);
            };

            const generatePetitionOnlyPDF = async () => {
                if (!prePrintValidation()) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                addPetitionToPdf(pdf, lastCalculationData);
                pdf.save(`Peticao_${lastCalculationData.processNumber.replace(/\D/g, '')}.pdf`);
            };

            const generateCombinedPDF = async () => {
                if (!prePrintValidation()) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                addPetitionToPdf(pdf, lastCalculationData);
                pdf.addPage();
                if (lastCalculationData.type === 'condemnation') {
                    generateCondemnationCalcPage(pdf, lastCalculationData);
                } else {
                    generateAgreementCalcPage(pdf, lastCalculationData);
                }
                pdf.save(`Completo_${lastCalculationData.processNumber.replace(/\D/g, '')}.pdf`);
            };

            const generateCondemnationCalcPage = (pdf, data) => {
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Demonstrativo de Cálculo de Débito Judicial', pdf.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Cálculo realizado em: ${data.finalCalcDate.toLocaleDateString('pt-BR')}`, pdf.internal.pageSize.getWidth() / 2, 27, { align: 'center' });
                pdf.text(`Processo nº: ${data.processNumber}`, 15, 40);

                const head = [['Descrição', 'Valor Original', 'Correção (Tabela TJSP)', 'Juros de Mora', 'Subtotal']];
                const body = data.rows.map(row => {
                    const idxLine = (row.indiceInicial && row.indiceFinal)
                        ? `\nÍndices: ${row.indiceInicial.toFixed(6)} -> ${row.indiceFinal.toFixed(6)}`
                        : '';
                    return [
                        row.description,
                        { content: formatCurrency(row.originalValue), styles: { halign: 'right' } },
                        { content: `${formatCurrency(row.totalCorrection)}${idxLine}`, styles: { halign: 'right', fontSize: 9, textColor: [75, 85, 99] } },
                        { content: formatCurrency(row.totalInterest), styles: { halign: 'right' } },
                        { content: formatCurrency(row.finalValueForRow), styles: { halign: 'right' } }
                    ];
                });

                pdf.autoTable({
                    startY: 50,
                    head: head,
                    body: body,
                    headStyles: { fillColor: [75, 85, 99] },
                    columnStyles: { 0: { cellWidth: 50 } },
                    bodyStyles: { minCellHeight: 14 },
                });

                const finalY = pdf.lastAutoTable.finalY;
                let summaryY = finalY + 15;
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Subtotal da Condenação:', 15, summaryY);
                pdf.text(formatCurrency(data.summary.positiveSubtotal), 195, summaryY, { align: 'right' });

                if (data.summary.totalDeductions > 0) {
                    summaryY += 7;
                    pdf.text('(-) Total Deduzido:', 15, summaryY);
                    pdf.text(formatCurrency(data.summary.totalDeductions), 195, summaryY, { align: 'right' });
                }

                if (data.summary.addFine) {
                    summaryY += 7;
                    pdf.text('Multa do art. 523 (10%):', 15, summaryY);
                    pdf.text(formatCurrency(data.summary.fineValue), 195, summaryY, { align: 'right' });
                }

                summaryY += 7;
                pdf.setDrawColor(0);
                pdf.line(15, summaryY, 195, summaryY);
                summaryY += 5;

                pdf.setFont('helvetica', 'bold');
                pdf.text('Valor Total do Débito:', 15, summaryY);
                pdf.text(formatCurrency(data.summary.grandTotal), 195, summaryY, { align: 'right' });
            };

            const generateAgreementCalcPage = (pdf, data) => {
                const s = data.summary;
                const installments = data.installments;
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Demonstrativo de Descumprimento de Acordo', pdf.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Cálculo realizado em: ${data.finalCalcDate.toLocaleDateString('pt-BR')}`, pdf.internal.pageSize.getWidth() / 2, 27, { align: 'center' });
                pdf.text(`Processo nº: ${data.processNumber}`, 15, 40);

                let startY = 50;

                const paidInstallments = installments.filter(i => i.status === 'Paga');
                if (paidInstallments.length > 0) {
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Detalhamento das Parcelas Pagas', 15, startY);
                    startY += 7;
                    pdf.autoTable({
                        startY: startY,
                        head: [['Parcela', 'Vencimento', 'Valor Original', 'Valor Atualizado']],
                        body: paidInstallments.map(i => {
                            const idxText = (i.indiceInicial && i.indiceFinal)
                                ? `Índices: ${i.indiceInicial.toFixed(6)} -> ${i.indiceFinal.toFixed(6)}`
                                : '';
                            return [
                                i.number,
                                i.originalDate.toLocaleDateString('pt-BR'),
                                { content: formatCurrency(i.originalValue), styles: { halign: 'right' } },
                                { content: `${formatCurrency(i.updatedValue)}${idxText ? `\n${idxText}` : ''}`, styles: { halign: 'right', fontSize: 9, textColor: [75, 85, 99] } }
                            ];
                        }),
                        theme: 'grid',
                        headStyles: { fillColor: [22, 163, 74], textColor: [255, 255, 255] },
                        bodyStyles: { minCellHeight: 14 },
                    });
                    startY = pdf.lastAutoTable.finalY + 10;
                }

                const unpaidInstallments = installments.filter(i => i.status !== 'Paga');
                if (unpaidInstallments.length > 0) {
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Detalhamento das Parcelas Vencidas e Não Pagas', 15, startY);
                    startY += 7;
                    pdf.autoTable({
                        startY: startY,
                        head: [['Parcela', 'Vencimento', 'Valor Original', 'Valor Atualizado']],
                        body: unpaidInstallments.map(i => {
                            const idxText = (i.indiceInicial && i.indiceFinal)
                                ? `Índices: ${i.indiceInicial.toFixed(6)} -> ${i.indiceFinal.toFixed(6)}`
                                : '';
                            return [
                                i.number,
                                i.originalDate.toLocaleDateString('pt-BR'),
                                { content: formatCurrency(i.originalValue), styles: { halign: 'right' } },
                                { content: `${formatCurrency(i.updatedValue)}${idxText ? `\n${idxText}` : ''}`, styles: { halign: 'right', fontSize: 9, textColor: [75, 85, 99] } }
                            ];
                        }),
                        theme: 'grid',
                        headStyles: { fillColor: [220, 38, 38], textColor: [255, 255, 255] },
                        bodyStyles: { minCellHeight: 14 },
                    });
                    startY = pdf.lastAutoTable.finalY + 10;
                }

                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Resumo Final', 15, startY);
                startY += 7;

                const summaryBody = [
                    ['Valor Total do Acordo (Atualizado)', { content: formatCurrency(s.totalUpdated), styles: { halign: 'right' } }],
                    [`(-) Valor Pago (${s.paidInstallments} parcelas) (Atualizado)`, { content: formatCurrency(s.paidUpdated), styles: { halign: 'right' } }],
                    ['(=) Saldo Devedor (Atualizado)', { content: formatCurrency(s.updatedDebt), styles: { halign: 'right', fontStyle: 'bold' } }]
                ];

                if (s.updatedDeductionValue > 0) {
                    summaryBody.push([`(-) Dedução Adicional (Atualizada)`, { content: formatCurrency(s.updatedDeductionValue), styles: { halign: 'right' } }]);
                }

                summaryBody.push([`(+) Multa por Descumprimento (${s.penaltyPercent}%)`, { content: formatCurrency(s.penaltyValue), styles: { halign: 'right', textColor: [220, 53, 69] } }]);

                pdf.autoTable({
                    startY: startY,
                    head: [['Descrição', 'Valor']],
                    body: summaryBody,
                    theme: 'striped'
                });

                let finalY = pdf.lastAutoTable.finalY;

                let penaltyHelperText = '';
                if (s.penaltyBaseType === 'remaining') {
                    penaltyHelperText = `* Multa calculada sobre o saldo devedor atualizado de ${formatCurrency(s.penaltyBaseValue)}`;
                } else { // 'total'
                    penaltyHelperText = `* Multa calculada sobre o valor original do acordo de ${formatCurrency(s.penaltyBaseValue)}`;
                }
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'italic');
                pdf.text(penaltyHelperText, 15, finalY + 5);

                finalY += 12;
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Valor Total do Débito:', 15, finalY);
                pdf.text(formatCurrency(s.grandTotal), 195, finalY, { align: 'right' });
            };

            const toRoman = (num) => {
                const map = { 1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI', 7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X' };
                return map[num] || num;
            };

            const addPetitionToPdf = (pdf, data) => {
                const margin = 20;
                const maxWidth = pdf.internal.pageSize.getWidth() - margin * 2;
                let currentY = margin;
                const lineSpacing = 8;
                const paraSpacing = 5;
                const baseFontSize = 12;

                pdf.setFont('times', 'normal');
                pdf.setFontSize(baseFontSize);

                const exequenteInputs = exequentesList.querySelectorAll('.exequente-name-input');
                const allExequentes = Array.from(exequenteInputs).map(input => input.value.trim().toUpperCase()).filter(Boolean);
                let exequentesText = allExequentes.length === 1 ? `<strong>${allExequentes[0]}</strong>, já qualificado(a) nos autos`
                    : allExequentes.join(', ').replace(/,([^,]*)$/, ' e$1') + ', já qualificados nos autos';

                const renderIndiceResumo = (titulo, linhas) => {
                    if (!linhas.length) return;
                    const prevSize = pdf.getFontSize();
                    pdf.setFontSize(10);
                    currentY = renderParagraph(pdf, `<strong>${titulo}</strong>`, { currentY, margin, maxWidth, lineSpacing, paraSpacing, indent: false });
                    pdf.setFontSize(9);
                    linhas.forEach(texto => {
                        currentY = renderParagraph(pdf, texto, { currentY, margin, maxWidth, lineSpacing, paraSpacing, indent: false });
                    });
                    pdf.setFontSize(prevSize);
                };

                // --- Início da Renderização ---

                pdf.setFont('times', 'bold');
                const header = "EXCELENTÍSSIMO(A) SENHOR(A) DOUTOR(A) JUIZ(A) DE DIREITO DO JUIZADO ESPECIAL CÍVEL DA COMARCA DE MARÍLIA - SP";
                const headerLines = pdf.splitTextToSize(header, maxWidth);
                pdf.text(headerLines, pdf.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
                currentY += headerLines.length * lineSpacing + paraSpacing * 4;

                pdf.setFont('times', 'normal');
                currentY = renderParagraph(pdf, `<strong>Processo nº: ${data.processNumber}</strong>`, { currentY, margin, maxWidth, lineSpacing: 8, paraSpacing: 5, indent: false });
                currentY += paraSpacing;

                // --- Conteúdo Dinâmico da Petição ---
                if (data.type === 'condemnation') {
                    const para1HTML = `${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong> em face do(a)(s) executado(a)(s), também já qualificado(a)(s), tendo em vista o trânsito em julgado da r. sentença.`;
                    currentY = renderParagraph(pdf, para1HTML, { currentY, margin, maxWidth, lineSpacing: 8, paraSpacing: 5, indent: true });

                    const para2HTML = `Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo legal, efetue o pagamento devido, no importe de <strong>${formatCurrency(data.summary.subtotal)}</strong>, conforme cálculo anexo. Não ocorrendo o pagamento, requer que o débito seja acrescido da multa de 10%, prevista no art. 523, §1º do CPC, totalizando a quantia de <strong>${formatCurrency(data.summary.subtotal * 1.10)}</strong>.`;
                    currentY = renderParagraph(pdf, para2HTML, { currentY, margin, maxWidth, lineSpacing: 8, paraSpacing: 5, indent: true });

                    const linhasIndice = data.rows
                        .filter(r => r.indiceInicial && r.indiceFinal)
                        .map((r, idx) => `${idx + 1}. ${r.description}: ${r.indiceInicial.toFixed(6)} → ${r.indiceFinal.toFixed(6)} (Tabela TJSP)`);
                    renderIndiceResumo('Índices aplicados (Tabela TJSP):', linhasIndice);
                } else { // agreement
                    const agreementType = document.getElementById('agreement-type-calc').value;
                    const actionText = agreementType === 'conhecimento' ? 'requerer o <strong>CUMPRIMENTO DE SENTENÇA</strong>' : 'informar o descumprimento do acordo e requerer o <strong>PROSSEGUIMENTO DA EXECUÇÃO</strong>';
                    const multaText = data.summary.penaltyPercent > 0 ? 'já com o acréscimo da multa' : '';
                    let intimationText = '';
                    if (includeIntimationCheckbox.checked) {
                        const deadline = document.getElementById('intimation-deadline').value;
                        intimationText = `Diante do exposto, requer a intimação do(a)(s) executado(a)(s) para que, no prazo de <strong>${deadline}</strong> dias, efetue o pagamento do valor remanescente, sob pena de reinício da execução e penhora de bens.`;
                    }

                    currentY = renderParagraph(pdf, `${exequentesText}, vem, respeitosamente, à presença de Vossa Excelência, informar o descumprimento do acordo homologado nos autos e, ato contínuo, ${actionText}.`, { currentY, margin, maxWidth, lineSpacing: 8, paraSpacing: 5, indent: true });
                    currentY = renderParagraph(pdf, `Conforme se demonstra pelo cálculo anexo, o débito atualizado remanescente, ${multaText}, perfaz o montante de <strong>${formatCurrency(data.summary.grandTotal)}</strong>. ${intimationText}`, { currentY, margin, maxWidth, lineSpacing: 8, paraSpacing: 5, indent: true });

                    const linhasIndice = data.installments
                        .filter(i => i.indiceInicial && i.indiceFinal)
                        .map(i => `Parcela ${i.number}: ${i.indiceInicial.toFixed(6)} → ${i.indiceFinal.toFixed(6)} (Tabela TJSP)`);
                    renderIndiceResumo('Índices aplicados por parcela (Tabela TJSP):', linhasIndice);
                }

                // --- Pedidos de Penhora (Comum a todas as petições) ---
                const requests = [];
                if (document.getElementById('penhora-contas').checked) requests.push('a pesquisa e bloqueio de valores em contas bancárias via SISBAJUD;');
                if (document.getElementById('penhora-veiculos').checked) requests.push('a pesquisa, bloqueio e penhora de veículos via RENAJUD;');
                if (document.getElementById('penhora-mandado').checked) requests.push('a expedição de mandado de penhora e avaliação de bens;');
                const outrosTextValue = penhoraOutrosText.value.trim();
                if (penhoraOutrosCheck.checked && outrosTextValue) requests.push(outrosTextValue);

                if (requests.length > 0) {
                    let penhoraHeader = 'Caso não haja o pagamento voluntário, requer o prosseguimento da execução com as seguintes medidas:';
                    if (data.type === 'agreement' && !includeIntimationCheckbox.checked) {
                        penhoraHeader = 'Requer a realização das seguintes medidas para constrição e penhora:';
                    }
                    currentY = renderParagraph(pdf, penhoraHeader, { currentY, margin, maxWidth, lineSpacing: 8, paraSpacing: 5, indent: true });

                    requests.forEach((req, index) => {
                        const itemText = `${toRoman(index + 1)}. ${req}`;
                        const lines = pdf.splitTextToSize(itemText, maxWidth - 10); // Wraps text with indent
                        pdf.text(lines, margin + 10, currentY);
                        currentY += lines.length * lineSpacing;
                    });
                    currentY += paraSpacing;
                }

                // --- Final da Petição (Comum a todas) ---
                currentY += paraSpacing;
                currentY = renderParagraph(pdf, "Nestes termos, pede deferimento.", { currentY, margin, maxWidth, lineSpacing: 8, paraSpacing: 10, indent: false });

                currentY += paraSpacing * 2;
                const printDate = data.finalCalcDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                pdf.text(`Marília, ${printDate}.`, pdf.internal.pageSize.getWidth() - margin, currentY, { align: 'right' });
                currentY += paraSpacing * 4;

                allExequentes.forEach(name => {
                    const signatureX = pdf.internal.pageSize.getWidth() / 2;
                    pdf.line(signatureX - 40, currentY, signatureX + 40, currentY);
                    currentY += 5;
                    pdf.text(name, signatureX, currentY, { align: 'center' });
                    currentY += paraSpacing * 2;
                });
            };

            // --- LISTENERS E LÓGICAS DA MANIFESTAÇÃO ---

            const updateAcordoFieldsVisibility = () => {
                const situacao = acordoSituacao.value;
                const isParcialOuDescumpriu = ['parcial', 'descumpriu'].includes(situacao);
                const isContraproposta = situacao === 'contraproposta';
                const showPagamento = isParcialOuDescumpriu;

                acordoPagamentoFields.classList.toggle('hidden', !showPagamento);
                acordoDiligencias.classList.toggle('hidden', !isParcialOuDescumpriu);
                acordoContraproposta.classList.toggle('hidden', !isContraproposta);

                if (!isParcialOuDescumpriu) {
                    acordoPagas.value = '';
                    acordoValor.value = '';
                    acordoSisbajud.checked = false;
                    acordoRenajud.checked = false;
                    acordoMandado.checked = false;
                    acordoOutrosCheck.checked = false;
                    acordoOutrosText.value = '';
                    acordoOutrosText.classList.add('hidden');
                }

                if (!isContraproposta) {
                    acordoContraValor.value = '';
                    acordoContraParcelas.value = '';
                    acordoContraPrimeira.value = '';
                    acordoContraForma.value = 'pix';
                }
            };

            const updateManifestationView = () => {
                const selectedOption = manifestationType.value;

                // Resets
                const allSections = [addressSection, extraContentContainer, witnessSection, emendaSection, prazoSection, indicacaoBensSection, desbloqueioPenhoraSection, desbloqueioDetalhadoSection, remarcacaoSection, conciliacaoSection, oficiosSection, cadastroSection, cumprimentoSection, certidaoSection, serasaSection, acordoSection, renajudSection, pesquisaEnderecoSection, repetirDiligenciaSection];
                allSections.forEach(sec => sec.classList.add('hidden'));

                manifestContent.value = '';
                extraContent.value = '';
                manifestTooltip.style.display = 'none';
                manifestContent.closest('.mb-6').classList.remove('hidden');

                const tooltips = {
                    'opcao1': 'Essa é uma manifestação genérica. Digite o que a parte pede.',
                    'opcao2': 'Explique qual a razão da emenda e informe se estão sendo juntados documentos.',
                    'opcao5': 'Digite no campo abaixo a réplica falada pela parte. Caso a réplica seja genérica, escolha o outro tipo.',
                    'opcao8': 'Essa é a manifestação genérica sobre a contestação. Não é necessário acrescentar mais nada.',
                    'opcao9': 'Essa é a manifestação genérica sobre a contestação. Não é necessário acrescentar mais nada no campo da manifestação. Digite apenas as provas que a parte deseja produzir no campo próprio.'
                };

                if (tooltips[selectedOption]) {
                    manifestTooltip.style.display = 'inline-block';
                    manifestTooltipText.textContent = tooltips[selectedOption];
                }

                switch (selectedOption) {
                    case 'opcao2': // Emenda à Inicial
                        emendaSection.classList.remove('hidden');
                        document.querySelector('input[name="emenda-type"][value="generica"]').checked = true;
                        emendaIncluirParteSection.classList.add('hidden');
                        manifestContent.closest('.mb-6').classList.remove('hidden');
                        break;
                    case 'opcao3': // Atualização de Endereço
                    case 'opcao4': // Indicação de Endereço
                        addressSection.classList.remove('hidden');
                        nameAddressField.style.display = selectedOption === 'opcao3' ? 'none' : 'block';
                        break;
                    case 'opcao6': // Indicação de Provas
                    case 'opcao9': // Manifestação sobre Contestação com Provas
                        extraContentContainer.classList.remove('hidden');
                        witnessSection.classList.remove('hidden');
                        if (selectedOption === 'opcao9') {
                            manifestContent.value = `Declara ter sido cientificado da possibilidade de constituição de advogado particular ou da nomeação de advogado pela Defensoria Pública, após triagem e caso atendidos os critérios daquela instituição, sentindo-se  seguro para apresentar sua réplica nos seguintes termos: \n\nDeclara ter lido a(s) contestação(ões) juntadas aos autos, impugna os argumentos da(s) parte(s) requerida(s), reiterando tudo o que foi exposto em sede de inicial, requerendo que o MM. Juiz afaste qualquer preliminar suscitada, bem como a narrativa dos fatos feita pela(s) parte(s) adversa(s).\n\nDeclara que os fatos ocorreram da forma narrada na inicial e que a(s) parte(s) requerida(s) não logrou(ram) êxito em provar suas alegações. Por fim, pugna pela total procedência da ação, nos mesmos termos da inicial.\n\nInforma que <strong> requer a produção das seguintes provas</strong>:`;
                        }
                        break;
                    case 'opcao8': // Manifestação sobre Contestação sem Provas
                        manifestContent.value = `Declara ter sido cientificado da possibilidade de constituição de advogado particular ou da nomeação de advogado pela Defensoria Pública, após triagem e caso atendidos os critérios daquela instituição, sentindo-se  seguro para apresentar sua réplica nos seguintes termos: \n\nDeclara ter lido a(s) contestação(ões) juntadas aos autos, impugna os argumentos da(s) parte(s) requerida(s), reiterando tudo o que foi exposto em sede de inicial, requerendo que o MM. Juiz afaste qualquer preliminar suscitada, bem como a narrativa dos fatos feita pela(s) parte(s) adversa(s).\n\nDeclara que os fatos ocorreram da forma narrada na inicial e que a(s) parte(s) requerida(s) não logrou(ram) êxito em provar suas alegações. Por fim, pugna pela total procedência da ação, nos mesmos termos da inicial.\n\nInforma que <strong>NÃO</strong> possui mais provas a produzir, requerendo o julgamento antecipado do feito, com a consequente procedência da ação, nos termos da inicial.`;
                        break;
                    case 'desistencia':
                        manifestContent.value = 'A parte autora vem, respeitosamente, à presença de Vossa Excelência, informar que não possui mais interesse no prosseguimento da presente ação, razão pela qual requer a desistência do feito, com a consequente extinção do processo, sem resolução do mérito, nos termos do art. 485, VIII, do Código de Processo Civil.';
                        break;
                    case 'prazo':
                        prazoSection.classList.remove('hidden');
                        break;
                    case 'nomeacaoDefensoria':
                        manifestContent.value = 'A parte solicitante, declaradamente hipossuficiente, requer a Vossa Excelência que se digne a oficiar à Defensoria Pública do Estado para que seja nomeado um(a) advogado(a) pelo convênio OAB/Defensoria para patrocinar seus interesses no presente feito, tendo em vista não possuir condições financeiras de arcar com os custos de um advogado particular sem prejuízo do seu próprio sustento e de sua família.';
                        break;
                    case 'indicacaoBens':
                        indicacaoBensSection.classList.remove('hidden');
                        break;
                    case 'desbloqueioPenhora':
                        desbloqueioPenhoraSection.classList.remove('hidden');
                        manifestContent.value = 'A parte vem, respeitosamente, à presença de Vossa Excelência, requerer o imediato desbloqueio dos valores penhorados em sua conta, uma vez que se tratam de verba de natureza impenhorável, nos termos do art. 833, IV, do Código de Processo Civil.';
                        break;
                    case 'desbloqueioDetalhado':
                        desbloqueioDetalhadoSection.classList.remove('hidden');
                        break;
                    case 'remarcacaoAudiencia':
                        remarcacaoSection.classList.remove('hidden');
                        manifestContent.value = 'Solicito a redesignação da audiência já designada, pelas razões abaixo.';
                        break;
                    case 'conciliacao':
                        conciliacaoSection.classList.remove('hidden');
                        manifestContent.value = 'A parte apresenta uma proposta de acordo simples, conforme detalhes abaixo.';
                        break;
                    case 'expedicaoOficios':
                        oficiosSection.classList.remove('hidden');
                        manifestContent.closest('.mb-6').classList.add('hidden');
                        if (oficiosList.children.length === 0) addOficio();
                        break;
                    case 'atualizacaoCadastral':
                        cadastroSection.classList.remove('hidden');
                        manifestContent.value = 'Atualização de dados para futuras intimações e contatos.';
                        break;
                    case 'cumprimentoVoluntario':
                        cumprimentoSection.classList.remove('hidden');
                        manifestContent.value = 'Comunico o pagamento espontâneo realizado e peço a baixa adequada.';
                        break;
                    case 'certidao':
                        certidaoSection.classList.remove('hidden');
                        manifestContent.value = 'Peço a expedição de certidão conforme abaixo.';
                        break;
                    case 'retiradaSerasa':
                        serasaSection.classList.remove('hidden');
                        manifestContent.value = 'Peço a retirada da anotação em cadastro de inadimplentes, conforme detalhes e comprovantes anexos.';
                        break;
                    case 'manifestacaoAcordo':
                        acordoSection.classList.remove('hidden');
                        manifestContent.value = 'A parte se manifesta sobre o cumprimento do acordo.';
                        updateAcordoFieldsVisibility();
                        break;
                    case 'retiradaRestricoesRenajud':
                        renajudSection.classList.remove('hidden');
                        manifestContent.value = 'Requer a retirada das restrições apontadas, conforme justificativa e comprovantes.';
                        break;
                    case 'pesquisaEndereco':
                        pesquisaEnderecoSection.classList.remove('hidden');
                        manifestContent.value = 'Requer pesquisa de endereço nos sistemas indicados para viabilizar citação/intimação.';
                        break;
                    case 'repeticaoDiligencia':
                        repetirDiligenciaSection.classList.remove('hidden');
                        manifestContent.value = 'Solicito a repetição da diligência, agora com as informações atualizadas.';
                        break;
                }
            };


            const addManifestParty = () => {
                const newItem = document.createElement('div');
                newItem.className = 'manifest-party-item grid grid-cols-1 md:grid-cols-2 gap-6 relative mt-4 pt-4 border-t';
                newItem.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parte</label>
                            <input type="text" class="manifest-name w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CPF/CNPJ</label>
                            <input type="text" class="manifest-cpf w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <button type="button" class="remove-manifest-party-btn absolute top-0 right-0 bg-red-500 hover:bg-red-600 text-white font-bold px-2 py-0 rounded-full text-xs" title="Remover Parte">&times;</button>
                    `;
                manifestPartiesList.appendChild(newItem);
                newItem.querySelector('.manifest-cpf').addEventListener('input', formatCpfCnpjOnInput);
            };

            const addWitness = () => {
                if (witnessList.children.length >= 3) {
                    alert('É permitido arrolar no máximo 3 testemunhas.');
                    return;
                }
                const newItem = document.createElement('div');
                newItem.className = 'witness-item space-y-2 p-4 border rounded-lg relative';
                newItem.innerHTML = `
                    <button type="button" class="remove-witness-btn absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white font-bold px-2 py-0 rounded-full text-xs" title="Remover Testemunha">&times;</button>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-medium text-gray-600">Nome Completo da Testemunha</label>
                            <input type="text" class="witness-name w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="md:col-span-2 flex items-end">
                            <div class="flex-grow">
                                <label class="block text-xs font-medium text-gray-600">Documento da Testemunha</label>
                                <input type="text" class="witness-doc w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                             <label class="flex items-center ml-3 pb-1 cursor-pointer" title="Marque esta opção se a testemunha precisar ser intimada pessoalmente pelo juízo. O endereço será obrigatório.">
                                <input type="checkbox" class="witness-intimation h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="ml-2 text-sm font-medium text-gray-700">Intimar?</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="witness-address-label block text-xs font-medium text-gray-600">Endereço Completo da Testemunha</label>
                        <input type="text" class="witness-address w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                `;
                witnessList.appendChild(newItem);

                const intimationCheckbox = newItem.querySelector('.witness-intimation');
                const addressInput = newItem.querySelector('.witness-address');
                const addressLabel = newItem.querySelector('.witness-address-label');

                intimationCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        addressInput.required = true;
                        addressLabel.innerHTML = 'Endereço Completo da Testemunha <span class="text-red-500 font-bold">*</span>';
                    } else {
                        addressInput.required = false;
                        addressLabel.innerHTML = 'Endereço Completo da Testemunha';
                    }
                });
            };

            const clearManifestationForm = () => {
                if (confirm("Tem certeza que deseja limpar todos os campos?")) {
                    processNumberManifest.value = '';
                    manifestPartiesList.innerHTML = `
                        <div class="manifest-party-item grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parte <span class="text-red-500 font-bold">*</span></label>
                                <input type="text" class="manifest-name w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CPF/CNPJ <span class="text-red-500 font-bold">*</span></label>
                                <input type="text" class="manifest-cpf w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>`;
                    manifestPartiesList.querySelector('.manifest-cpf').addEventListener('input', formatCpfCnpjOnInput);
                    manifestationType.selectedIndex = 0;
                    manifestContent.value = '';
                    extraContent.value = '';
                    document.getElementById('name-address').value = '';
                    cepInput.value = '';
                    document.getElementById('rua').value = '';
                    document.getElementById('numero').value = '';
                    document.getElementById('complemento').value = '';
                    document.getElementById('bairro').value = '';
                    document.getElementById('cidade').value = '';
                    document.getElementById('estado').value = '';
                    witnessList.innerHTML = '';
                    documentList.innerHTML = '';
                    emendaParteList.innerHTML = '';
                    oficiosList.innerHTML = '';
                    naturezaSelect.value = 'salario';
                    detalheValorInput.value = '';
                    detalheDataInput.value = '';
                    detalheContaInput.value = '';
                    detalheOrigemInput.value = '';
                    detalheJustificativa.value = '';
                    remarcacaoData.value = '';
                    remarcacaoFormato.value = 'remoto';
                    remarcacaoJustificativa.value = '';
                    remarcacaoIndisponiveis.value = '';
                    remarcacaoSugestao.value = '';
                    conciliacaoValor.value = '';
                    conciliacaoForma.value = 'avista';
                    conciliacaoParcelas.value = '';
                    conciliacaoVencimento.value = '';
                    conciliacaoContato.value = '';
                    conciliacaoDetalhes.value = '';
                    cadastroTelefone.value = '';
                    cadastroEmail.value = '';
                    cadastroIntimacao.value = 'email';
                    cadastroEndereco.value = '';
                    cadastroObservacao.value = '';
                    cumprimentoValor.value = '';
                    cumprimentoData.value = '';
                    cumprimentoForma.value = 'pix';
                    cumprimentoComprovante.value = '';
                    certidaoTipo.value = 'objeto';
                    certidaoFinalidade.value = '';
                    certidaoDetalhe.value = '';
                    serasaEntidade.value = '';
                    serasaData.value = '';
                    serasaValor.value = '';
                    serasaJustificativa.value = '';
                    acordoSituacao.value = 'cumpriu';
                    acordoPagas.value = '';
                    acordoValor.value = '';
                    acordoDetalhes.value = '';
                    acordoSisbajud.checked = false;
                    acordoRenajud.checked = false;
                    acordoMandado.checked = false;
                    acordoOutrosCheck.checked = false;
                    acordoOutrosText.value = '';
                    acordoContraValor.value = '';
                    acordoContraParcelas.value = '';
                    acordoContraPrimeira.value = '';
                    acordoContraForma.value = 'pix';
                    renajudBem.value = '';
                    renajudMotivo.value = 'debito quitado';
                    renajudDetalhes.value = '';
                    pesquisaJustificativa.value = '';
                    pesquisaUltimo.value = '';
                    pesquisaSisbajud.checked = true;
                    pesquisaRenajud.checked = true;
                    pesquisaInfojud.checked = false;
                    pesquisaOutrosCheck.checked = false;
                    pesquisaOutrosText.value = '';
                    diligenciaTipo.value = 'citacao';
                    diligenciaData.value = '';
                    diligenciaHorario.value = '';
                    diligenciaJustificativa.value = '';
                    updateManifestationView();
                }
            };

            const addDocument = () => {
                const newItem = document.createElement('div');
                newItem.className = 'document-item p-3 border rounded-lg relative';
                newItem.innerHTML = `
                    <button type="button" class="remove-document-btn absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white font-bold px-2 py-0 rounded-full text-xs" title="Remover Documento">&times;</button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Tipo de Documento</label>
                            <select class="document-type w-full p-2 border border-gray-300 rounded-lg mt-1">
                                <option value="RG/CPF">RG/CPF</option>
                                <option value="Comprovante de Residência">Comprovante de Residência</option>
                                <option value="Nota Fiscal">Nota Fiscal</option>
                                <option value="Extrato Bancário">Extrato Bancário</option>
                                <option value="Comprovante de Transferência/PIX">Comprovante de Transferência/PIX</option>
                                <option value="Comprovante de Pagamento">Comprovante de Pagamento</option>
                                <option value="Conversas em WhatsApp">Conversas em WhatsApp</option>
                                <option value="Foto/Print">Foto/Print</option>
                                <option value="Contrato/Termo de Adesão">Contrato/Termo de Adesão</option>
                                <option value="Laudo/Atestado Médico">Laudo/Atestado Médico</option>
                                <option value="Boletim de Ocorrência">Boletim de Ocorrência</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <input type="text" class="document-other-type w-full p-2 border border-gray-300 rounded-lg mt-2 hidden" placeholder="Especifique o tipo de documento">
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-600">Justificativa/Fundamentação (Opcional)</label>
                             <input type="text" class="document-explanation w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="Ex: para comprovar o dano sofrido">
                        </div>
                    </div>
                `;
                documentList.appendChild(newItem);

                const typeSelect = newItem.querySelector('.document-type');
                const otherTypeInput = newItem.querySelector('.document-other-type');

                typeSelect.addEventListener('change', (e) => {
                    otherTypeInput.classList.toggle('hidden', e.target.value !== 'Outro');
                });
            };

            const addOficio = () => {
                const newItem = document.createElement('div');
                newItem.className = 'oficio-item p-3 border rounded-lg relative bg-indigo-50/40';
                newItem.innerHTML = `
                    <button type="button" class="remove-oficio-btn absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white font-bold px-2 py-0 rounded-full text-xs" title="Remover Ofício">&times;</button>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Órgão/Empresa</label>
                            <input type="text" class="oficio-orgao w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="Ex: Banco X, Empregador, Cartório">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Finalidade do ofício</label>
                            <input type="text" class="oficio-finalidade w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="Ex: extratos, endereço, vínculo">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Dados a incluir</label>
                            <input type="text" class="oficio-dados w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="Ex: CPF do requerido, período, protocolo">
                        </div>
                    </div>
                `;
                oficiosList.appendChild(newItem);
            };


            // Objeto para personalizar as frases de cada tipo de manifestação
            const manifestationPhrases = {
                'opcao6': 'INDICAR AS PROVAS que pretende produzir',
                'opcao9': 'INDICAR AS PROVAS que pretende produzir',
                'indicacaoBens': 'INDICAR BENS PASSÍVEIS DE PENHORA',
                'desbloqueioDetalhado': 'PEDIR O LEVANTAMENTO DO VALOR BLOQUEADO DE FORMA DETALHADA',
                'remarcacaoAudiencia': 'PEDIR A REMARCAÇÃO DA AUDIÊNCIA',
                'conciliacao': 'REGISTRAR PROPOSTA DE CONCILIAÇÃO',
                'expedicaoOficios': 'REQUERER A EXPEDIÇÃO DE OFÍCIOS',
                'atualizacaoCadastral': 'ATUALIZAR OS DADOS DE CONTATO',
                'cumprimentoVoluntario': 'COMUNICAR PAGAMENTO ESPONTÂNEO',
                'certidao': 'REQUERER CERTIDÃO',
                'retiradaSerasa': 'PEDIR A RETIRADA DE ANOTAÇÃO EM CADASTRO DE INADIMPLENTES',
                'manifestacaoAcordo': 'SE MANIFESTAR SOBRE O ACORDO',
                'retiradaRestricoesRenajud': 'PEDIR A RETIRADA DE RESTRIÇÕES EM RENAJUD/AVERBAÇÕES',
                'pesquisaEndereco': 'SOLICITAR PESQUISA DE ENDEREÇO',
                'repeticaoDiligencia': 'PEDIR A REPETIÇÃO DE DILIGÊNCIA'
                // Para personalizar outras opções, adicione uma nova linha como o exemplo abaixo:
                // 'sua_opcao_aqui': 'seu texto personalizado aqui'
            };

            const generateManifestationPDF = async () => {
                if (!prePrintValidation(true)) return;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                await addManifestationToPdf(pdf);
                pdf.save(`Manifestacao_${processNumberManifest.value.replace(/\D/g, '')}.pdf`);
            };

            const showManifestationPreview = () => {
                if (!prePrintValidation(true)) return;
                const previewHTML = generateManifestationPreviewHTML();
                previewContent.innerHTML = `<h2 class="text-xl font-bold text-center mb-4">Prévia da Manifestação</h2><div class="p-8 border shadow-lg bg-white mx-auto" style="width: 210mm;">${previewHTML}</div>`;
                previewModal.classList.remove('hidden');
            };

            const generateManifestationPreviewHTML = () => {
                const selectedOptionValue = manifestationType.value;
                const selectedOptionText = manifestationType.options[manifestationType.selectedIndex].text.replace(/\s*\(.*?\)\s*/g, '').toUpperCase();

                const partyNames = Array.from(document.querySelectorAll('#manifest-parties-list .manifest-name')).map(input => input.value.trim().toUpperCase()).filter(Boolean);

                const paragraphify = (text, indent = true) => text.split('\n').filter(p => p.trim() !== '').map(p => `<p style="${indent ? 'text-indent: 4em;' : ''} margin-top: 1em;">${p}</p>`).join('');

                let introHTML = '';
                const customPhrase = manifestationPhrases[selectedOptionValue];

                if (customPhrase) {
                    introHTML = `<p style="text-indent: 4em; margin-top: 1cm;">A(s) parte(s) acima qualificada(s), vem <strong>${customPhrase}</strong>, nos seguintes termos:</p>`;
                } else {
                    let concordancia = 'apresenta sua';
                    if (['opcao3', 'opcao4', 'opcao8', 'desistencia', 'prazo', 'nomeacaoDefensoria', 'indicacaoBens', 'desbloqueioPenhora'].includes(selectedOptionValue)) { concordancia = 'vem'; }
                    if (selectedOptionValue === 'opcao5') { concordancia = 'vem apresentar'; }
                    introHTML = `<p style="text-indent: 4em; margin-top: 1cm;">A(s) parte(s) acima qualificada(s), ${concordancia} <strong>${selectedOptionText}</strong>, nos seguintes termos:</p>`;
                }

                let specificContentHTML = '';

                // Lógica para cada tipo de manifestação
                switch (selectedOptionValue) {
                    case 'opcao2': // Emenda
                        if (document.querySelector('input[name="emenda-type"]:checked').value === 'incluir-parte') {
                            const polo = document.querySelector('input[name="polo-type"]:checked').value;
                            const emendaParties = Array.from(emendaParteList.querySelectorAll('.party-item')).map(item => {
                                const partyData = {
                                    name: item.querySelector('.party-name').value.trim(),
                                    maritalStatus: item.querySelector('.party-marital-status').value,
                                    profession: item.querySelector('.party-profession').value.trim(),
                                    cpf: item.querySelector('.party-cpf').value.trim(),
                                    dob: item.querySelector('.party-dob') ? item.querySelector('.party-dob').value.trim() : null,
                                    rg: item.querySelector('.party-rg').value.trim(),
                                    emitter: item.querySelector('.party-emitter').value.trim(),
                                    phone: item.querySelector('.party-phone').value.trim(),
                                    email: item.querySelector('.party-email').value.trim(),
                                    address: (() => {
                                        if (item.querySelector('.no-address-check') && item.querySelector('.no-address-check').checked) return null;
                                        const cep = item.querySelector('.party-cep').value.trim();
                                        return `${item.querySelector('.party-street').value}, nº ${item.querySelector('.party-number').value}, ${item.querySelector('.party-complement').value || ''}`.trim() +
                                            ` - ${item.querySelector('.party-district').value}${cep ? `, CEP: ${cep}` : ''}, ${item.querySelector('.party-city').value}/${item.querySelector('.party-state').value}`;
                                    })(),
                                };
                                return partyData;
                            }).filter(p => p.name);

                            if (emendaParties.length > 0) {
                                specificContentHTML += `<p style="text-indent: 4em;">Requer-se a inclusão da(s) parte(s) abaixo no polo ${polo.toLowerCase()} da ação:</p>`;
                                specificContentHTML += '<div style="margin-left: 4em; border-left: 2px solid #ccc; padding-left: 1em; line-height: 1.5;">';
                                emendaParties.forEach(party => {
                                    let details = '';
                                    if (party.maritalStatus) details += `, ${party.maritalStatus}`;
                                    if (party.profession) details += `, ${party.profession}`;
                                    if (party.rg) details += `, portador(a) do RG nº ${party.rg}` + (party.emitter ? ` - ${party.emitter}` : '');
                                    if (party.cpf) details += `, inscrito(a) no CPF/CNPJ sob o nº ${party.cpf}`;
                                    if (party.address) details += `, residente e domiciliado(a) no endereço: ${party.address}`;
                                    else details += `, em lugar incerto e não sabido`;

                                    specificContentHTML += `<p><strong>${party.name.toUpperCase()}</strong>${details}.</p>`;
                                });
                                specificContentHTML += '</div>';
                            }
                            const textoOpcional = document.getElementById('emenda-texto-opcional').value.trim();
                            if (textoOpcional) {
                                specificContentHTML += textoOpcional.split('\n').filter(p => p.trim() !== '').map(p => `<p style="text-indent: 4em; margin-top: 1em;">${p}</p>`).join('');
                            }
                        } else {
                            specificContentHTML = manifestContent.value.split('\n').filter(p => p.trim() !== '').map(p => `<p style="text-indent: 4em;">${p}</p>`).join('');
                        }
                        break;

                    case 'prazo':
                        const dias = document.getElementById('prazo-dias').value;
                        let motivo = prazoMotivoSelect.value;
                        if (motivo === 'outro') motivo = prazoMotivoOutro.value.trim();
                        specificContentHTML = `<p style="text-indent: 4em;">A parte solicitante requer a concessão do prazo de <strong>${dias} dias</strong> para ${motivo}.</p>`;
                        if (manifestContent.value.trim()) {
                            specificContentHTML += manifestContent.value.split('\n').filter(p => p.trim() !== '').map(p => `<p style="text-indent: 4em; margin-top: 1em;">${p}</p>`).join('');
                        }
                        break;

                    case 'indicacaoBens':
                        let bensList = [];
                        if (document.getElementById('bens-sisbajud').checked) {
                            const tipoSisbajud = document.querySelector('input[name="sisbajud-type"]:checked').value === 'teimosinha' ? 'na modalidade "teimosinha" (30 dias)' : 'na modalidade simples';
                            bensList.push(`a reiteração da pesquisa e bloqueio de valores via SISBAJUD ${tipoSisbajud};`);
                        }
                        if (document.getElementById('bens-renajud').checked) {
                            const check = document.getElementById('bens-renajud').closest('.space-y-2').querySelector('.individualizar-check');
                            const input = document.getElementById('bens-renajud').closest('.space-y-2').querySelector('.individualizar-input');
                            if (check.checked && input.value.trim()) {
                                bensList.push(`a pesquisa e bloqueio do veículo via RENAJUD, especificamente sobre o bem: ${input.value.trim()};`);
                            } else {
                                bensList.push('a pesquisa e bloqueio de veículos em nome da parte executada via RENAJUD;');
                            }
                        }
                        if (document.getElementById('bens-mandado').checked) {
                            const check = document.getElementById('bens-mandado').closest('.space-y-2').querySelector('.individualizar-check');
                            const input = document.getElementById('bens-mandado').closest('.space-y-2').querySelector('.individualizar-input');
                            if (check.checked && input.value.trim()) {
                                bensList.push(`a expedição de Mandado de Penhora e Avaliação para penhora sobre o(s) seguinte(s) bem(ns): ${input.value.trim()};`);
                            } else {
                                bensList.push('a expedição de Mandado de Penhora e Avaliação de bens na residência/sede da parte executada;');
                            }
                        }
                        if (bensOutrosCheck.checked && bensOutrosText.value.trim()) {
                            bensList.push(bensOutrosText.value.trim());
                        }

                        if (bensList.length > 0) {
                            specificContentHTML += `<p style="text-indent: 4em;">Diante da inércia da parte executada em quitar o débito, requer-se o prosseguimento da execução com as seguintes medidas:</p>`;
                            specificContentHTML += '<ul style="margin-left: 6em; list-style-type: disc;">';
                            bensList.forEach(item => {
                                specificContentHTML += `<li>${item}</li>`;
                            });
                            specificContentHTML += '</ul>';
                        }
                        if (manifestContent.value.trim()) {
                            specificContentHTML += manifestContent.value.split('\n').filter(p => p.trim() !== '').map(p => `<p style="text-indent: 4em; margin-top: 1em;">${p}</p>`).join('');
                        }
                        break;

                    case 'desbloqueioPenhora':
                        let motivoDesbloqueio = desbloqueioMotivoSelect.value;
                        if (motivoDesbloqueio === 'outro') motivoDesbloqueio = desbloqueioMotivoOutro.value.trim();
                        specificContentHTML = manifestContent.value.split('\n').filter(p => p.trim() !== '').map(p => `<p style="text-indent: 4em;">${p}</p>`).join('');
                        specificContentHTML += `<p style="text-indent: 4em; margin-top: 1em;">O pedido se fundamenta no fato de que os valores bloqueados são provenientes de <strong>${motivoDesbloqueio}</strong>, sendo, portanto, impenhoráveis.</p>`;
                        break;
                    case 'desbloqueioDetalhado': {
                        const naturezaText = naturezaSelect.options[naturezaSelect.selectedIndex].text;
                        const valorText = detalheValorInput.value ? `${detalheValorInput.value}` : 'não informado';
                        const dataText = detalheDataInput.value || 'data não informada';
                        specificContentHTML = `<p style="text-indent: 4em;">Requer o levantamento imediato do bloqueio realizado em <strong>${dataText}</strong>, no valor de <strong>${valorText}</strong>, por possuir natureza <strong>${naturezaText}</strong>, caracterizando-se como verba impenhorável.</p>`;
                        if (detalheOrigemInput.value || detalheContaInput.value) {
                            specificContentHTML += `<p style="text-indent: 4em;">Origem declarada: ${detalheOrigemInput.value || 'não especificada'}. Dados bancários: ${detalheContaInput.value || 'não informado'}.</p>`;
                        }
                        if (detalheJustificativa.value.trim()) {
                            specificContentHTML += paragraphify(detalheJustificativa.value);
                        }
                        break;
                    }
                    case 'remarcacaoAudiencia': {
                        const data = remarcacaoData.value || 'data a ser oportunamente designada';
                        const formato = remarcacaoFormato.options[remarcacaoFormato.selectedIndex].text;
                        specificContentHTML = `<p style="text-indent: 4em;">Requer a remarcação da audiência designada para <strong>${data}</strong>, indicando preferência por formato <strong>${formato}</strong>.</p>`;
                        if (remarcacaoJustificativa.value.trim()) specificContentHTML += paragraphify(remarcacaoJustificativa.value);
                        if (remarcacaoIndisponiveis.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Indisponibilidades: ${remarcacaoIndisponiveis.value}.</p>`;
                        if (remarcacaoSugestao.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Sugestão de datas/turnos: ${remarcacaoSugestao.value}.</p>`;
                        break;
                    }
                    case 'conciliacao': {
                        const valor = conciliacaoValor.value || 'valor a combinar';
                        const forma = conciliacaoForma.options[conciliacaoForma.selectedIndex].text;
                        const parcelas = conciliacaoParcelas.value ? ` (${conciliacaoParcelas.value})` : '';
                        specificContentHTML = `<p style="text-indent: 4em;">Manifesta interesse em conciliar e apresenta proposta de <strong>${valor}</strong>, na forma <strong>${forma}${parcelas}</strong>.</p>`;
                        if (conciliacaoVencimento.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Primeiro pagamento em: ${conciliacaoVencimento.value}.</p>`;
                        if (conciliacaoContato.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Contato para tratativas: ${conciliacaoContato.value}.</p>`;
                        if (conciliacaoDetalhes.value.trim()) specificContentHTML += paragraphify(conciliacaoDetalhes.value);
                        break;
                    }
                    case 'expedicaoOficios': {
                        const oficios = Array.from(oficiosList.querySelectorAll('.oficio-item')).map(item => ({
                            orgao: item.querySelector('.oficio-orgao').value.trim(),
                            finalidade: item.querySelector('.oficio-finalidade').value.trim(),
                            dados: item.querySelector('.oficio-dados').value.trim(),
                        })).filter(o => o.orgao || o.finalidade || o.dados);
                        if (oficios.length > 0) {
                            specificContentHTML += '<p style="text-indent: 4em;">Requer a expedição dos seguintes ofícios:</p><ul style="margin-left: 4em; list-style: disc;">';
                            oficios.forEach(o => {
                                specificContentHTML += `<li><strong>${o.orgao || 'Órgão/Empresa'}</strong> - finalidade: ${o.finalidade || 'informar/detalhar'}, dados a constar: ${o.dados || 'dados do processo e CPF/CNPJ'}.</li>`;
                            });
                            specificContentHTML += '</ul>';
                        } else {
                            specificContentHTML += '<p style="text-indent: 4em;">Requer a expedição de ofício(s), conforme indicado nos campos acima.</p>';
                        }
                        break;
                    }
                    case 'atualizacaoCadastral':
                        specificContentHTML = `<p style="text-indent: 4em;">Atualiza os dados de contato para futuras intimações.</p>`;
                        if (cadastroTelefone.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Telefone/WhatsApp: ${cadastroTelefone.value}.</p>`;
                        if (cadastroEmail.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">E-mail: ${cadastroEmail.value}.</p>`;
                        if (cadastroEndereco.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Endereço: ${cadastroEndereco.value}.</p>`;
                        if (cadastroObservacao.value.trim()) specificContentHTML += paragraphify(cadastroObservacao.value);
                        specificContentHTML += `<p style="text-indent: 4em;">Preferência de intimação: ${cadastroIntimacao.options[cadastroIntimacao.selectedIndex].text}.</p>`;
                        break;
                    case 'cumprimentoVoluntario': {
                        const valor = cumprimentoValor.value || 'valor informado em comprovante';
                        const data = cumprimentoData.value || 'data informada no comprovante';
                        specificContentHTML = `<p style="text-indent: 4em;">Informa pagamento espontâneo de <strong>${valor}</strong>, realizado em <strong>${data}</strong>, por meio de ${cumprimentoForma.options[cumprimentoForma.selectedIndex].text.toLowerCase()}.</p>`;
                        if (cumprimentoComprovante.value.trim()) specificContentHTML += paragraphify(cumprimentoComprovante.value);
                        break;
                    }
                    case 'certidao': {
                        const tipo = certidaoTipo.options[certidaoTipo.selectedIndex].text;
                        specificContentHTML = `<p style="text-indent: 4em;">Requer a expedição de <strong>${tipo}</strong>.</p>`;
                        if (certidaoFinalidade.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Finalidade: ${certidaoFinalidade.value}.</p>`;
                        if (certidaoDetalhe.value.trim()) specificContentHTML += paragraphify(certidaoDetalhe.value);
                        break;
                    }
                    case 'retiradaSerasa': {
                        specificContentHTML = `<p style="text-indent: 4em;">Requer a imediata retirada/baixa da anotação em cadastro de inadimplentes.</p>`;
                        if (serasaEntidade.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Entidade: ${serasaEntidade.value}.</p>`;
                        if (serasaData.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Data da inclusão: ${serasaData.value}.</p>`;
                        if (serasaValor.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Valor/Lançamento: ${serasaValor.value}.</p>`;
                        if (serasaJustificativa.value.trim()) specificContentHTML += paragraphify(serasaJustificativa.value);
                        break;
                    }
                    case 'manifestacaoAcordo': {
                        const situacaoValue = acordoSituacao.value;
                        const situacaoText = acordoSituacao.options[acordoSituacao.selectedIndex].text;
                        specificContentHTML = `<p style="text-indent: 4em;">Manifesta-se sobre o acordo: <strong>${situacaoText}</strong>.</p>`;

                        if (['parcial', 'descumpriu'].includes(situacaoValue)) {
                            if (acordoPagas.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Parcelas pagas: ${acordoPagas.value}.</p>`;
                            if (acordoValor.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Valor pago: ${acordoValor.value}.</p>`;

                            const diligencias = [];
                            if (acordoSisbajud.checked) diligencias.push('Nova pesquisa/bloqueio via SISBAJUD');
                            if (acordoRenajud.checked) diligencias.push('Pesquisa/penhora via RENAJUD');
                            if (acordoMandado.checked) diligencias.push('Mandado de penhora/avaliação');
                            if (acordoOutrosCheck.checked && acordoOutrosText.value.trim()) diligencias.push(acordoOutrosText.value.trim());

                            if (diligencias.length) {
                                specificContentHTML += '<p style="text-indent: 4em;">Para prosseguimento, requer:</p><ul style="margin-left: 4em; list-style: disc;">';
                                diligencias.forEach(item => { specificContentHTML += `<li>${item}</li>`; });
                                specificContentHTML += '</ul>';
                            }
                        } else if (situacaoValue === 'contraproposta') {
                            const contraValor = acordoContraValor.value || 'valor a combinar';
                            const contraParcelas = acordoContraParcelas.value ? ` em ${acordoContraParcelas.value}` : '';
                            const contraPrimeira = acordoContraPrimeira.value ? `, primeira parcela em ${acordoContraPrimeira.value}` : '';
                            const contraForma = acordoContraForma.options[acordoContraForma.selectedIndex].text;
                            specificContentHTML += `<p style="text-indent: 4em;">Apresenta contraproposta de pagamento de <strong>${contraValor}${contraParcelas}</strong>${contraPrimeira}, com pagamento via <strong>${contraForma}</strong>.</p>`;
                        }

                        if (acordoDetalhes.value.trim()) specificContentHTML += paragraphify(acordoDetalhes.value);
                        break;
                    }
                    case 'retiradaRestricoesRenajud': {
                        const motivo = renajudMotivo.options[renajudMotivo.selectedIndex].text;
                        specificContentHTML = `<p style="text-indent: 4em;">Requer a retirada das restrições/averbações sobre <strong>${renajudBem.value || 'o bem indicado nos autos'}</strong>, pois <strong>${motivo}</strong>.</p>`;
                        if (renajudDetalhes.value.trim()) specificContentHTML += paragraphify(renajudDetalhes.value);
                        break;
                    }
                    case 'pesquisaEndereco': {
                        specificContentHTML = `<p style="text-indent: 4em;">Requer pesquisa de endereço para viabilizar citação/intimação.</p>`;
                        if (pesquisaJustificativa.value.trim()) specificContentHTML += paragraphify(pesquisaJustificativa.value);
                        if (pesquisaUltimo.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Último endereço conhecido: ${pesquisaUltimo.value}.</p>`;
                        const sistemas = [];
                        if (pesquisaSisbajud.checked) sistemas.push('SISBAJUD');
                        if (pesquisaRenajud.checked) sistemas.push('RENAJUD');
                        if (pesquisaInfojud.checked) sistemas.push('INFOJUD/RFB');
                        if (pesquisaOutrosCheck.checked && pesquisaOutrosText.value.trim()) sistemas.push(pesquisaOutrosText.value.trim());
                        if (sistemas.length) specificContentHTML += `<p style="text-indent: 4em;">Sistemas solicitados: ${sistemas.join(', ')}.</p>`;
                        break;
                    }
                    case 'repeticaoDiligencia': {
                        specificContentHTML = `<p style="text-indent: 4em;">Solicita a repetição da diligência de <strong>${diligenciaTipo.options[diligenciaTipo.selectedIndex].text}</strong>.</p>`;
                        if (diligenciaData.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Tentativa anterior em: ${diligenciaData.value}.</p>`;
                        if (diligenciaHorario.value.trim()) specificContentHTML += `<p style="text-indent: 4em;">Melhor horário/local: ${diligenciaHorario.value}.</p>`;
                        if (diligenciaJustificativa.value.trim()) specificContentHTML += paragraphify(diligenciaJustificativa.value);
                        break;
                    }

                    default:
                        specificContentHTML = manifestContent.value.split('\n').filter(p => p.trim() !== '').map(p => `<p style="text-indent: 4em;">${p}</p>`).join('');
                        break;
                }

                const manualAppendTypes = ['desbloqueioDetalhado', 'remarcacaoAudiencia', 'conciliacao', 'expedicaoOficios', 'atualizacaoCadastral', 'cumprimentoVoluntario', 'certidao', 'retiradaSerasa', 'manifestacaoAcordo', 'retiradaRestricoesRenajud', 'pesquisaEndereco', 'repeticaoDiligencia'];
                if (manualAppendTypes.includes(selectedOptionValue) && manifestContent.value.trim()) {
                    specificContentHTML += paragraphify(manifestContent.value);
                }

                let addressHTML = '';
                if (!addressSection.classList.contains('hidden')) {
                    addressHTML = `<p style="text-indent: 4em;"><strong>${(document.getElementById('name-address').value || partyNames[0]).toUpperCase()}</strong><br>${document.getElementById('rua').value}, nº ${document.getElementById('numero').value}, ${document.getElementById('complemento').value}<br>${document.getElementById('bairro').value}, ${cepInput.value}, ${document.getElementById('cidade').value}/${document.getElementById('estado').value}</p>`;
                }


                let extraContentHTML = '';
                if (!extraContentContainer.classList.contains('hidden') && extraContent.value) {
                    extraContentHTML = extraContent.value.split('\n').filter(p => p.trim() !== '').map(p => `<p style="text-indent: 4em;">${p}</p>`).join('');
                }

                let witnessHTML = '';
                const witnessItems = document.querySelectorAll('#witness-list .witness-item');
                const witnessesData = Array.from(witnessItems)
                    .map(item => ({
                        name: item.querySelector('.witness-name').value.trim(),
                        doc: item.querySelector('.witness-doc').value.trim(),
                        address: item.querySelector('.witness-address').value.trim(),
                        needsIntimation: item.querySelector('.witness-intimation').checked,
                    }))
                    .filter(w => w.name);

                if (witnessesData.length > 0) {
                    witnessHTML += '<p style="text-align: center; font-weight: bold; margin-top: 1cm; margin-bottom: 1cm;">ROL DE TESTEMUNHAS</p>';

                    witnessesData.forEach((witness, index) => {
                        let witnessLine = `<p style="text-indent: 4em; margin-bottom: 0.5em;"><strong>${index + 1}. ${witness.name.toUpperCase()}</strong>`;
                        if (witness.doc) {
                            witnessLine += `, portador(a) do documento nº ${witness.doc}`;
                        }
                        if (witness.address) {
                            witnessLine += `, residente e domiciliado(a) no endereço: ${witness.address}`;
                        }
                        witnessLine += `.</p>`;
                        witnessHTML += witnessLine;
                    });

                    const witnessesToInform = witnessesData
                        .filter(w => w.needsIntimation)
                        .map(w => w.name.toUpperCase());

                    if (witnessesToInform.length > 0) {
                        witnessHTML += `<p style="text-indent: 4em; font-weight: bold; font-style: italic; margin-top: 0.5cm;">REQUER-SE A INTIMAÇÃO PESSOAL DA(S) SEGUINTE(S) TESTEMUNHA(S): ${witnessesToInform.join(', ')}.</p>`;
                    }
                }

                let documentsHTML = '';
                const documentItems = Array.from(document.querySelectorAll('#document-list .document-item'));
                const documentsData = documentItems.map(item => {
                    const typeSelect = item.querySelector('.document-type');
                    let type = typeSelect.value;
                    if (type === 'Outro') {
                        type = item.querySelector('.document-other-type').value.trim();
                    }
                    return {
                        name: type,
                        explanation: item.querySelector('.document-explanation').value.trim(),
                    };
                }).filter(doc => doc.name);

                if (documentsData.length > 0) {
                    documentsHTML += '<p style="text-align: center; font-weight: bold; margin-top: 1cm; margin-bottom: 1cm;">DOCUMENTOS QUE ACOMPANHAM A MANIFESTAÇÃO</p>';
                    documentsData.forEach(doc => {
                        documentsHTML += `<p style="text-indent: 4em; margin-bottom: 0.5em;">- <strong>${doc.name.toUpperCase()}</strong>${doc.explanation ? `: ${doc.explanation}` : ''}</p>`;
                    });
                }

                let allSignatories = [...partyNames];
                if (selectedOptionValue === 'opcao2' && document.querySelector('input[name="emenda-type"]:checked').value === 'incluir-parte') {
                    const polo = document.querySelector('input[name="polo-type"]:checked').value;
                    if (polo === 'Ativo') {
                        const newParties = Array.from(emendaParteList.querySelectorAll('.party-item .party-name')).map(input => input.value.trim().toUpperCase()).filter(Boolean);
                        allSignatories = [...new Set([...allSignatories, ...newParties])]; // Evita duplicatas
                    }
                }

                const today = new Date();
                const dateStr = today.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                const signaturesHTML = [...new Set(allSignatories)].map(name => `<div style="text-align: center; margin-top: 40px;"><p style="border-top: 1px solid black; width: 75%; margin: 0 auto; padding-top: 5px;">${name}</p></div>`).join('');

                return `
                        <div style="font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 2; text-align: justify;">
                            <p style="text-align: center; font-weight: bold;">AO JUÍZO DO JUIZADO ESPECIAL CÍVEL DA COMARCA DE MARÍLIA/SP</p>
                            <p style="margin-top: 2cm;"><strong>Processo nº: ${processNumberManifest.value}</strong></p>
                            <p><strong>Solicitante(s): ${partyNames.join(', ')}</strong></p>
                            <p style="text-align: center; font-weight: bold; margin-top: 1cm;">TERMO - ${selectedOptionText}</p>
                            ${introHTML}
                            ${addressHTML}
                            ${specificContentHTML}
                            ${extraContentHTML}
                            ${witnessHTML}
                            ${documentsHTML}
                            <p style="margin-top: 2cm;">Nestes termos, pede deferimento.</p>
                            <p style="margin-top: 2cm; text-align: right;">Marília, ${dateStr}.</p>
                            <div style="margin-top: 4cm;">${signaturesHTML}</div>
                        </div>
                    `;
            };

            const addManifestationToPdf = (pdf) => new Promise((resolve) => {
                const container = document.createElement('div');
                container.style.width = '210mm';
                container.style.padding = '20px';
                container.style.background = '#ffffff';
                container.innerHTML = generateManifestationPreviewHTML();
                document.body.appendChild(container);

                pdf.html(container, {
                    html2canvas: { scale: 0.75, useCORS: true, logging: false },
                    callback: () => {
                        document.body.removeChild(container);
                        resolve();
                    },
                    margin: [10, 10, 10, 10],
                    autoPaging: 'text'
                });
            });


            // --- EVENT LISTENERS ---
            mainAppSelect.addEventListener('change', toggleMainView);

            // -- Listeners da Calculadora
            calculationTypeSelect.addEventListener('change', toggleCalculationView);
            complianceRequestCheckbox.addEventListener('change', () => petitionOptionsContainer.classList.toggle('hidden', !complianceRequestCheckbox.checked));

            includeIntimationCheckbox.addEventListener('change', () => {
                intimationDeadlineWrapper.classList.toggle('hidden', !includeIntimationCheckbox.checked);
            });

            condemnationContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('description-select')) {
                    const row = e.target.closest('.calculation-row');
                    const otherInput = row.querySelector('.other-description-input');
                    const interestDateInput = row.querySelector('.interest-date-input');
                    const isDeduction = e.target.value === 'Dedução/Pagamento Parcial';

                    otherInput.classList.toggle('hidden', e.target.value !== 'Outro');

                    interestDateInput.disabled = isDeduction;
                    if (isDeduction) {
                        interestDateInput.value = '';
                        interestDateInput.placeholder = 'N/A';
                    } else {
                        interestDateInput.placeholder = 'DD/MM/AAAA';
                    }
                }
            });

            addExequenteBtn.addEventListener('click', () => {
                const newItem = document.createElement('div');
                newItem.className = 'exequente-item flex items-center gap-3';
                newItem.innerHTML = `<input type="text" class="exequente-name-input flex-grow p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Nome completo do Exequente"><button class="remove-exequente-btn bg-red-500 hover:bg-red-600 text-white font-bold px-3 py-1 rounded-lg">&times;</button>`;
                exequentesList.appendChild(newItem);
            });
            exequentesList.addEventListener('click', (e) => { if (e.target.classList.contains('remove-exequente-btn')) e.target.parentElement.remove() });
            penhoraOutrosCheck.addEventListener('change', () => penhoraOutrosText.classList.toggle('hidden'));
            addRowBtn.addEventListener('click', addRow);
            rowsContainer.addEventListener('click', removeRow);
            calculateBtn.addEventListener('click', handleCalculateClick);
            addFineCheckbox.addEventListener('change', () => { if (lastCalculationData && lastCalculationData.type === 'condemnation') handleCalculateClick(); });

            agreementContainer.addEventListener('change', (e) => {
                if (e.target.name === 'penalty-base' && lastCalculationData && lastCalculationData.type === 'agreement') {
                    handleCalculateClick();
                }
            });

            printBtn.addEventListener('click', generateCalculationOnlyPDF);
            printCombinedBtn.addEventListener('click', generateCombinedPDF);
            printPetitionBtn.addEventListener('click', generatePetitionOnlyPDF);
            printCalcBtn.addEventListener('click', generateCalculationOnlyPDF);
            previewBtn.addEventListener('click', showPreview);
            closePreviewBtn.addEventListener('click', () => previewModal.classList.add('hidden'));
            previewModal.addEventListener('click', (e) => { if (e.target === previewModal) previewModal.classList.add('hidden'); });
            processNumberInputCalc.addEventListener('input', formatCNJOnInput);

            // -- Listeners do Gerador de Manifestação
            addManifestPartyBtn.addEventListener('click', addManifestParty);
            manifestPartiesList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-manifest-party-btn')) {
                    e.target.closest('.manifest-party-item').remove();
                }
            });

            addWitnessBtn.addEventListener('click', addWitness);
            witnessList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-witness-btn')) {
                    e.target.closest('.witness-item').remove();
                }
            });

            addDocumentBtn.addEventListener('click', addDocument);
            documentList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-document-btn')) {
                    e.target.closest('.document-item').remove();
                }
            });

            addOficioBtn.addEventListener('click', addOficio);
            oficiosList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-oficio-btn')) {
                    e.target.closest('.oficio-item').remove();
                }
            });


            processNumberManifest.addEventListener('input', formatCNJOnInput);

            manifestPartiesList.addEventListener('input', (e) => {
                if (e.target.classList.contains('manifest-cpf')) {
                    formatCpfCnpjOnInput(e);
                }
            });

            acordoSituacao.addEventListener('change', updateAcordoFieldsVisibility);
            acordoOutrosCheck.addEventListener('change', () => {
                const show = acordoOutrosCheck.checked;
                acordoOutrosText.classList.toggle('hidden', !show);
                if (!show) acordoOutrosText.value = '';
            });

            pesquisaOutrosCheck.addEventListener('change', () => {
                const show = pesquisaOutrosCheck.checked;
                pesquisaOutrosText.classList.toggle('hidden', !show);
                if (!show) pesquisaOutrosText.value = '';
            });

            manifestationType.addEventListener('change', updateManifestationView);
            generateManifestBtn.addEventListener('click', generateManifestationPDF);
            clearManifestBtn.addEventListener('click', clearManifestationForm);
            previewManifestBtn.addEventListener('click', showManifestationPreview);
            cepInput.addEventListener('input', function () {
                this.value = this.value.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2');
                const cep = this.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data.erro) {
                                document.getElementById('rua').value = data.logradouro;
                                document.getElementById('bairro').value = data.bairro;
                                document.getElementById('cidade').value = data.localidade;
                                document.getElementById('estado').value = data.uf;
                            } else {
                                alert('CEP não encontrado.');
                            }
                        })
                        .catch(error => console.error('Erro ao buscar o CEP:', error));
                }
            });

            // Novos Listeners
            document.querySelectorAll('input[name="emenda-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isIncluir = e.target.value === 'incluir-parte';
                    emendaIncluirParteSection.classList.toggle('hidden', !isIncluir);
                    manifestContent.closest('.mb-6').classList.toggle('hidden', isIncluir);
                });
            });

            const createPartyElement = (isAuthor) => {
                const newParty = partyTemplate.firstElementChild.cloneNode(true);
                const isPoloPassivo = document.querySelector('input[name="polo-type"]:checked')?.value === 'Passivo';

                if (isAuthor || !isPoloPassivo) {
                    // Mantém data de nascimento para polo ativo
                } else {
                    // Esconde para polo passivo
                    newParty.querySelector('.party-dob-field').style.display = 'none';
                }

                newParty.querySelector('.no-address-option').style.display = 'flex';
                return newParty;
            };

            const addEmendaParty = () => {
                const isPoloPassivo = document.querySelector('input[name="polo-type"]:checked').value === 'Passivo';
                const newParty = createPartyElement(!isPoloPassivo);
                emendaParteList.appendChild(newParty);
                addInputBehaviorsToEmenda(newParty);
            }

            const addInputBehaviorsToEmenda = (container) => {
                container.querySelectorAll('.party-cpf').forEach(input => input.addEventListener('input', (e) => e.target.value = formatCpfCnpj(e.target.value)));
                container.querySelectorAll('.party-phone').forEach(input => input.addEventListener('input', (e) => e.target.value = formatPhone(e.target.value)));
                container.querySelectorAll('.party-dob').forEach(input => input.addEventListener('input', (e) => e.target.value = formatDate(e.target.value)));

                container.querySelector('.no-cep-check').addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const addressContainer = container.querySelector('.address-container');
                    addressContainer.querySelectorAll('input:not(.party-cep)').forEach(input => {
                        input.readOnly = !isChecked;
                        input.classList.toggle('bg-gray-100', !isChecked);
                        if (isChecked) input.value = '';
                    });
                    addressContainer.querySelector('.party-cep').disabled = isChecked;
                });

                container.querySelector('.no-address-check').addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    container.querySelector('.address-container').style.display = isChecked ? 'none' : 'block';
                    container.querySelector('.no-cep-option').style.display = isChecked ? 'none' : 'flex';
                    container.querySelector('.no-address-justification-field').classList.toggle('hidden', !isChecked);
                });

                container.querySelector('.party-cep').addEventListener('input', function () {
                    if (container.querySelector('.no-cep-check').checked) return;
                    this.value = this.value.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2');
                    const cep = this.value.replace(/\D/g, '');
                    if (cep.length === 8) {
                        const parent = this.closest('.party-item');
                        fetch(`https://viacep.com.br/ws/${cep}/json/`)
                            .then(response => response.json())
                            .then(data => {
                                if (!data.erro) {
                                    parent.querySelector('.party-street').value = data.logradouro;
                                    parent.querySelector('.party-district').value = data.bairro;
                                    parent.querySelector('.party-city').value = data.localidade;
                                    parent.querySelector('.party-state').value = data.uf;
                                    parent.querySelector('.party-number').focus();
                                } else { alert('CEP não encontrado.'); }
                            }).catch(error => console.error('Erro ao buscar o CEP:', error));
                    }
                });
            };

            addEmendaPartyBtn.addEventListener('click', addEmendaParty);

            emendaParteList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-party-btn')) {
                    e.target.closest('.party-item').remove();
                }
            });

            prazoMotivoSelect.addEventListener('change', () => prazoMotivoOutro.classList.toggle('hidden', prazoMotivoSelect.value !== 'outro'));
            prazoMotivoSelect.addEventListener('change', () => document.getElementById('prazo-motivo-outro-hint').classList.toggle('hidden', prazoMotivoSelect.value !== 'outro'));
            bensOutrosCheck.addEventListener('change', () => bensOutrosText.classList.toggle('hidden', !bensOutrosCheck.checked));
            desbloqueioMotivoSelect.addEventListener('change', () => {
                const isOutro = desbloqueioMotivoSelect.value !== 'outro';
                desbloqueioMotivoOutro.classList.toggle('hidden', isOutro);
                document.getElementById('desbloqueio-motivo-outro-hint').classList.toggle('hidden', isOutro);
            });

            indicacaoBensSection.addEventListener('change', e => {
                if (e.target.classList.contains('individualizar-check')) {
                    const container = e.target.closest('.space-y-2');
                    const input = container.querySelector('.individualizar-input');
                    input.classList.toggle('hidden', !e.target.checked);
                }
            });


            // --- INICIALIZAÇÃO ---
            addInputBehaviors(document.body);
            fetchEconomicData();
            toggleMainView(); // Define a view inicial
            updateManifestationView(); // Define a view inicial da manifestação
            document.getElementById('agreement-penalty').value = '20';

            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('final-date').value = `${day}/${month}/${year}`;
        });
    </script>
</body>

</html>