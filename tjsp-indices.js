(function (global) {
    // Base da Tabela Prática TJSP (fatores acumulados). Atualizada até 2025-11.
    const baseTabela = {
        // 2003
        '2003-01': 28.131595, '2003-02': 28.826445, '2003-03': 29.247311, '2003-04': 29.647999,
        '2003-05': 30.057141, '2003-06': 30.354706, '2003-07': 30.336493, '2003-08': 30.348627,
        '2003-09': 30.403254, '2003-10': 30.652560, '2003-11': 30.772104, '2003-12': 30.885960,

        // 2004
        '2004-01': 31.052744, '2004-02': 31.310481, '2004-03': 31.432591, '2004-04': 31.611756,
        '2004-05': 31.741364, '2004-06': 31.868329, '2004-07': 32.027670, '2004-08': 32.261471,
        '2004-09': 32.422778, '2004-10': 32.477896, '2004-11': 32.533108, '2004-12': 32.676253,

        // 2005
        '2005-01': 32.957268, '2005-02': 33.145124, '2005-03': 33.290962, '2005-04': 33.533986,
        '2005-05': 33.839145, '2005-06': 34.076019, '2005-07': 34.038535, '2005-08': 34.048746,
        '2005-09': 34.048746, '2005-10': 34.099819, '2005-11': 34.297597, '2005-12': 34.482804,

        // 2006
        '2006-01': 34.620735, '2006-02': 34.752293, '2006-03': 34.832223, '2006-04': 34.926270,
        '2006-05': 34.968181, '2006-06': 35.013639, '2006-07': 34.989129, '2006-08': 35.027617,
        '2006-09': 35.020611, '2006-10': 35.076643, '2006-11': 35.227472, '2006-12': 35.375427,

        // 2007
        '2007-01': 35.594754, '2007-02': 35.769168, '2007-03': 35.919398, '2007-04': 36.077443,
        '2007-05': 36.171244, '2007-06': 36.265289, '2007-07': 36.377711, '2007-08': 36.494119,
        '2007-09': 36.709434, '2007-10': 36.801207, '2007-11': 36.911610, '2007-12': 37.070329,

        // 2008
        '2008-01': 37.429911, '2008-02': 37.688177, '2008-03': 37.869080, '2008-04': 38.062212,
        '2008-05': 38.305810, '2008-06': 38.673545, '2008-07': 39.025474, '2008-08': 39.251821,
        '2008-09': 39.334249, '2008-10': 39.393250, '2008-11': 39.590216, '2008-12': 39.740658,

        // 2009
        '2009-01': 39.855905, '2009-02': 40.110982, '2009-03': 40.235326, '2009-04': 40.315796,
        '2009-05': 40.537532, '2009-06': 40.780757, '2009-07': 40.952036, '2009-08': 41.046225,
        '2009-09': 41.079061, '2009-10': 41.144787, '2009-11': 41.243534, '2009-12': 41.396135,

        // 2010
        '2010-01': 41.495485, '2010-02': 41.860645, '2010-03': 42.153669, '2010-04': 42.452960,
        '2010-05': 42.762866, '2010-06': 42.946746, '2010-07': 42.899504, '2010-08': 42.869474,
        '2010-09': 42.839465, '2010-10': 43.070798, '2010-11': 43.467049, '2010-12': 43.914759,

        // 2011
        '2011-01': 44.178247, '2011-02': 44.593522, '2011-03': 44.834327, '2011-04': 45.130233,
        '2011-05': 45.455170, '2011-06': 45.714264, '2011-07': 45.814835, '2011-08': 45.814835,
        '2011-09': 46.007257, '2011-10': 46.214289, '2011-11': 46.362174, '2011-12': 46.626438,

        // 2012
        '2012-01': 46.864232, '2012-02': 47.103239, '2012-03': 47.286941, '2012-04': 47.372057,
        '2012-05': 47.675238, '2012-06': 47.937451, '2012-07': 48.062088, '2012-08': 48.268754,
        '2012-09': 48.485963, '2012-10': 48.791424, '2012-11': 49.137843, '2012-12': 49.403187,

        // 2013
        '2013-01': 49.768770, '2013-02': 50.226642, '2013-03': 50.487820, '2013-04': 50.790746,
        '2013-05': 51.090411, '2013-06': 51.269227, '2013-07': 51.412780, '2013-08': 51.345943,
        '2013-09': 51.428096, '2013-10': 51.566951, '2013-11': 51.881509, '2013-12': 52.161669,

        // 2014
        '2014-01': 52.537233, '2014-02': 52.868217, '2014-03': 53.206573, '2014-04': 53.642866,
        '2014-05': 54.061280, '2014-06': 54.385647, '2014-07': 54.527049, '2014-08': 54.597934,
        '2014-09': 54.696210, '2014-10': 54.964221, '2014-11': 55.173085, '2014-12': 55.465502,

        // 2015
        '2015-01': 55.809388, '2015-02': 56.635366, '2015-03': 57.292336, '2015-04': 58.157450,
        '2015-05': 58.570367, '2015-06': 59.150213, '2015-07': 59.605669, '2015-08': 59.951381,
        '2015-09': 60.101259, '2015-10': 60.407775, '2015-11': 60.872914, '2015-12': 61.548603,

        // 2016
        '2016-01': 62.102540, '2016-02': 63.040288, '2016-03': 63.639170, '2016-04': 63.919182,
        '2016-05': 64.328264, '2016-06': 64.958680, '2016-07': 65.263985, '2016-08': 65.681674,
        '2016-09': 65.885287, '2016-10': 65.937995, '2016-11': 66.050089, '2016-12': 66.096324,

        // 2017
        '2017-01': 66.188858, '2017-02': 66.466851, '2017-03': 66.626371, '2017-04': 66.839575,
        '2017-05': 66.893046, '2017-06': 67.133860, '2017-07': 66.932458, '2017-08': 67.046243,
        '2017-09': 67.026129, '2017-10': 67.012723, '2017-11': 67.260670, '2017-12': 67.381739,

        // 2018
        '2018-01': 67.556931, '2018-02': 67.712311, '2018-03': 67.834193, '2018-04': 67.881676,
        '2018-05': 68.024227, '2018-06': 68.316731, '2018-07': 69.293660, '2018-08': 69.466894,
        '2018-09': 69.466894, '2018-10': 69.675294, '2018-11': 69.953995, '2018-12': 69.779110,

        // 2019
        '2019-01': 69.876800, '2019-02': 70.128356, '2019-03': 70.507049, '2019-04': 71.049953,
        '2019-05': 71.476252, '2019-06': 71.583466, '2019-07': 71.590624, '2019-08': 71.662214,
        '2019-09': 71.748208, '2019-10': 71.712333, '2019-11': 71.741017, '2019-12': 72.128418,

        // 2020
        '2020-01': 73.008384, '2020-02': 73.147099, '2020-03': 73.271449, '2020-04': 73.403337,
        '2020-05': 73.234509, '2020-06': 73.051422, '2020-07': 73.270576, '2020-08': 73.592966,
        '2020-09': 73.857900, '2020-10': 74.500463, '2020-11': 75.163517, '2020-12': 75.877570,

        // 2021
        '2021-01': 76.985382, '2021-02': 77.193242, '2021-03': 77.826226, '2021-04': 78.495531,
        '2021-05': 78.793814, '2021-06': 79.550234, '2021-07': 80.027535, '2021-08': 80.843815,
        '2021-09': 81.555240, '2021-10': 82.533902, '2021-11': 83.491295, '2021-12': 84.192621,

        // 2022
        '2022-01': 84.807227, '2022-02': 85.375435, '2022-03': 86.229189, '2022-04': 87.703708,
        '2022-05': 88.615826, '2022-06': 89.014597, '2022-07': 89.566487, '2022-08': 89.029088,
        '2022-09': 88.753097, '2022-10': 88.469087, '2022-11': 88.884891, '2022-12': 89.222653,

        // 2023
        '2023-01': 89.838289, '2023-02': 90.251545, '2023-03': 90.946481, '2023-04': 91.528538,
        '2023-05': 92.013639, '2023-06': 92.344888, '2023-07': 92.252543, '2023-08': 92.169515,
        '2023-09': 92.353854, '2023-10': 92.455443, '2023-11': 92.566389, '2023-12': 92.658955,

        // 2024
        '2024-01': 93.168579, '2024-02': 93.699639, '2024-03': 94.458606, '2024-04': 94.638077,
        '2024-05': 94.988237, '2024-06': 95.425182, '2024-07': 95.663744, '2024-08': 95.912469,
        '2024-09': 96.094702, '2024-10': 96.219625, '2024-11': 96.739210, '2024-12': 97.338993,

        // 2025
        '2025-01': 97.669945, '2025-02': 97.777381, '2025-03': 98.980042, '2025-04': 99.613514,
        '2025-05': 100.041852, '2025-06': 100.402002, '2025-07': 100.663047, '2025-08': 100.995235,
        '2025-09': 100.853841, '2025-10': 101.337939, '2025-11': 101.520347
    };

    const DATA_CORTE_LEI = new Date('2024-08-28');

    const clone = (obj) => JSON.parse(JSON.stringify(obj));
    const trunc6 = (value) => Math.floor((value + 1e-12) * 1e6) / 1e6;
    const chaveAnterior = (chave) => {
        const [ano, mes] = chave.split('-').map(Number);
        const mesAnt = mes === 1 ? 12 : mes - 1;
        const anoAnt = mes === 1 ? ano - 1 : ano;
        return `${anoAnt}-${String(mesAnt).padStart(2, '0')}`;
    };

    const keyToDate = (chave) => {
        const [ano, mes] = chave.split('-').map(Number);
        return new Date(`${ano}-${String(mes).padStart(2, '0')}-01T00:00:00Z`);
    };

    function getTaxaLegalMensal(chave, selicMensalMap) {
        const dataMes = keyToDate(chave);
        const corte = new Date(DATA_CORTE_LEI.getTime());
        corte.setUTCDate(1); // compara por mês
        const chaveCorte = `${corte.getUTCFullYear()}-${String(corte.getUTCMonth() + 1).padStart(2, '0')}`;

        if (chave < chaveCorte) {
            return 1.0; // 1% a.m. antes do corte
        }
        return selicMensalMap[chave] || 0; // Taxa Legal = SELIC mensal pós-corte
    }

    function buildTabela(ipcaArray, seed = baseTabela) {
        const tabela = { ...seed };
        ipcaArray.forEach((item) => {
            const [d, m, y] = item.data.split('/');
            let mesTabela = parseInt(m, 10) + 1;
            let anoTabela = parseInt(y, 10);
            if (mesTabela > 12) { mesTabela = 1; anoTabela++; }
            const chave = `${anoTabela}-${String(mesTabela).padStart(2, '0')}`;
            if (!tabela[chave]) {
                const chaveAnt = chaveAnterior(chave);
                if (tabela[chaveAnt] !== undefined) {
                    const fator = tabela[chaveAnt] * (1 + parseFloat(item.valor) / 100);
                    tabela[chave] = trunc6(fator);
                }
            }
        });
        return tabela;
    }

    function deriveMonthlyRatesFromTabela(tabela) {
        const keys = Object.keys(tabela).sort();
        const mensal = {};
        for (let i = 1; i < keys.length; i++) {
            const atual = tabela[keys[i]];
            const ant = tabela[keys[i - 1]];
            mensal[keys[i]] = ((atual / ant) - 1) * 100;
        }
        return mensal;
    }

    function computeSelicMensal(dailyData) {
        const monthlyFactors = dailyData.reduce((acc, item) => {
            const [day, month, year] = item.data.split('/');
            const key = `${year}-${month.padStart(2, '0')}`;
            acc[key] = (acc[key] || 1) * (1 + parseFloat(item.valor) / 100);
            return acc;
        }, {});
        return Object.entries(monthlyFactors).reduce((acc, [key, factor]) => {
            acc[key] = (factor - 1) * 100;
            return acc;
        }, {});
    }

    global.TJSPIndices = {
        baseTabela: clone(baseTabela),
        buildTabela,
        deriveMonthlyRatesFromTabela,
        computeSelicMensal,
        getTaxaLegalMensal,
        trunc6,
        DATA_CORTE_LEI
    };
})(window);
